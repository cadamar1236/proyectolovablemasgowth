var Jd=Object.defineProperty;var In=e=>{throw TypeError(e)};var Yd=(e,t,r)=>t in e?Jd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var $=(e,t,r)=>Yd(e,typeof t!="symbol"?t+"":t,r),xs=(e,t,r)=>t.has(e)||In("Cannot "+r);var R=(e,t,r)=>(xs(e,t,"read from private field"),r?r.call(e):t.get(e)),V=(e,t,r)=>t.has(e)?In("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),U=(e,t,r,a)=>(xs(e,t,"write to private field"),a?a.call(e,r):t.set(e,r),r),X=(e,t,r)=>(xs(e,t,"access private method"),r);var Rn=(e,t,r,a)=>({set _(s){U(e,t,s,r)},get _(){return R(e,t,a)}});var An=(e,t,r)=>(a,s)=>{let o=-1;return n(0);async function n(i){if(i<=o)throw new Error("next() called multiple times");o=i;let l,d=!1,c;if(e[i]?(c=e[i][0][0],a.req.routeIndex=i):c=i===e.length&&s||void 0,c)try{l=await c(a,()=>n(i+1))}catch(u){if(u instanceof Error&&t)a.error=u,l=await t(u,a),d=!0;else throw u}else a.finalized===!1&&r&&(l=await r(a));return l&&(a.finalized===!1||d)&&(a.res=l),a}},Kd=Symbol(),Qd=async(e,t=Object.create(null))=>{const{all:r=!1,dot:a=!1}=t,o=(e instanceof Nl?e.raw.headers:e.headers).get("Content-Type");return o!=null&&o.startsWith("multipart/form-data")||o!=null&&o.startsWith("application/x-www-form-urlencoded")?Xd(e,{all:r,dot:a}):{}};async function Xd(e,t){const r=await e.formData();return r?Zd(r,t):{}}function Zd(e,t){const r=Object.create(null);return e.forEach((a,s)=>{t.all||s.endsWith("[]")?ec(r,s,a):r[s]=a}),t.dot&&Object.entries(r).forEach(([a,s])=>{a.includes(".")&&(tc(r,a,s),delete r[a])}),r}var ec=(e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},tc=(e,t,r)=>{let a=e;const s=t.split(".");s.forEach((o,n)=>{n===s.length-1?a[o]=r:((!a[o]||typeof a[o]!="object"||Array.isArray(a[o])||a[o]instanceof File)&&(a[o]=Object.create(null)),a=a[o])})},Al=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},rc=e=>{const{groups:t,path:r}=ac(e),a=Al(r);return sc(a,t)},ac=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(r,a)=>{const s=`@${a}`;return t.push([s,r]),s}),{groups:t,path:e}},sc=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[a]=t[r];for(let s=e.length-1;s>=0;s--)if(e[s].includes(a)){e[s]=e[s].replace(a,t[r][1]);break}}return e},ha={},oc=(e,t)=>{if(e==="*")return"*";const r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){const a=`${e}#${t}`;return ha[a]||(r[2]?ha[a]=t&&t[0]!==":"&&t[0]!=="*"?[a,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:ha[a]=[e,r[1],!0]),ha[a]}return null},Jo=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},nc=e=>Jo(e,decodeURI),Ol=e=>{const t=e.url,r=t.indexOf("/",t.indexOf(":")+4);let a=r;for(;a<t.length;a++){const s=t.charCodeAt(a);if(s===37){const o=t.indexOf("?",a),n=t.slice(r,o===-1?void 0:o);return nc(n.includes("%25")?n.replace(/%25/g,"%2525"):n)}else if(s===63)break}return t.slice(r,a)},ic=e=>{const t=Ol(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},ir=(e,t,...r)=>(r.length&&(t=ir(t,...r)),`${(e==null?void 0:e[0])==="/"?"":"/"}${e}${t==="/"?"":`${(e==null?void 0:e.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),kl=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),r=[];let a="";return t.forEach(s=>{if(s!==""&&!/\:/.test(s))a+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){r.length===0&&a===""?r.push("/"):r.push(a);const o=s.replace("?","");a+="/"+o,r.push(a)}else a+="/"+s}),r.filter((s,o,n)=>n.indexOf(s)===o)},_s=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?Jo(e,Ml):e):e,Dl=(e,t,r)=>{let a;if(!r&&t&&!/[%+]/.test(t)){let n=e.indexOf(`?${t}`,8);for(n===-1&&(n=e.indexOf(`&${t}`,8));n!==-1;){const i=e.charCodeAt(n+t.length+1);if(i===61){const l=n+t.length+2,d=e.indexOf("&",l);return _s(e.slice(l,d===-1?void 0:d))}else if(i==38||isNaN(i))return"";n=e.indexOf(`&${t}`,n+1)}if(a=/[%+]/.test(e),!a)return}const s={};a??(a=/[%+]/.test(e));let o=e.indexOf("?",8);for(;o!==-1;){const n=e.indexOf("&",o+1);let i=e.indexOf("=",o);i>n&&n!==-1&&(i=-1);let l=e.slice(o+1,i===-1?n===-1?void 0:n:i);if(a&&(l=_s(l)),o=n,l==="")continue;let d;i===-1?d="":(d=e.slice(i+1,n===-1?void 0:n),a&&(d=_s(d))),r?(s[l]&&Array.isArray(s[l])||(s[l]=[]),s[l].push(d)):s[l]??(s[l]=d)}return t?s[t]:s},lc=Dl,dc=(e,t)=>Dl(e,t,!0),Ml=decodeURIComponent,On=e=>Jo(e,Ml),pr,Le,dt,Pl,Ll,Bo,bt,xl,Nl=(xl=class{constructor(e,t="/",r=[[]]){V(this,dt);$(this,"raw");V(this,pr);V(this,Le);$(this,"routeIndex",0);$(this,"path");$(this,"bodyCache",{});V(this,bt,e=>{const{bodyCache:t,raw:r}=this,a=t[e];if(a)return a;const s=Object.keys(t)[0];return s?t[s].then(o=>(s==="json"&&(o=JSON.stringify(o)),new Response(o)[e]())):t[e]=r[e]()});this.raw=e,this.path=t,U(this,Le,r),U(this,pr,{})}param(e){return e?X(this,dt,Pl).call(this,e):X(this,dt,Ll).call(this)}query(e){return lc(this.url,e)}queries(e){return dc(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((r,a)=>{t[a]=r}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await Qd(this,e))}json(){return R(this,bt).call(this,"text").then(e=>JSON.parse(e))}text(){return R(this,bt).call(this,"text")}arrayBuffer(){return R(this,bt).call(this,"arrayBuffer")}blob(){return R(this,bt).call(this,"blob")}formData(){return R(this,bt).call(this,"formData")}addValidatedData(e,t){R(this,pr)[e]=t}valid(e){return R(this,pr)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[Kd](){return R(this,Le)}get matchedRoutes(){return R(this,Le)[0].map(([[,e]])=>e)}get routePath(){return R(this,Le)[0].map(([[,e]])=>e)[this.routeIndex].path}},pr=new WeakMap,Le=new WeakMap,dt=new WeakSet,Pl=function(e){const t=R(this,Le)[0][this.routeIndex][1][e],r=X(this,dt,Bo).call(this,t);return r&&/\%/.test(r)?On(r):r},Ll=function(){const e={},t=Object.keys(R(this,Le)[0][this.routeIndex][1]);for(const r of t){const a=X(this,dt,Bo).call(this,R(this,Le)[0][this.routeIndex][1][r]);a!==void 0&&(e[r]=/\%/.test(a)?On(a):a)}return e},Bo=function(e){return R(this,Le)[1]?R(this,Le)[1][e]:e},bt=new WeakMap,xl),jl={Stringify:1},St=(e,t)=>{const r=new String(e);return r.isEscaped=!0,r.callbacks=t,r},cc=/[&<>'"]/,uc=async(e,t)=>{let r="";t||(t=[]);const a=await Promise.all(e);for(let s=a.length-1;r+=a[s],s--,!(s<0);s--){let o=a[s];typeof o=="object"&&t.push(...o.callbacks||[]);const n=o.isEscaped;if(o=await(typeof o=="object"?o.toString():o),typeof o=="object"&&t.push(...o.callbacks||[]),o.isEscaped??n)r+=o;else{const i=[r];ur(o,i),r=i[0]}}return St(r,t)},ur=(e,t)=>{const r=e.search(cc);if(r===-1){t[0]+=e;return}let a,s,o=0;for(s=r;s<e.length;s++){switch(e.charCodeAt(s)){case 34:a="&quot;";break;case 39:a="&#39;";break;case 38:a="&amp;";break;case 60:a="&lt;";break;case 62:a="&gt;";break;default:continue}t[0]+=e.substring(o,s)+a,o=s+1}t[0]+=e.substring(o,s)},pc=e=>{const t=e.callbacks;if(!(t!=null&&t.length))return e;const r=[e],a={};return t.forEach(s=>s({phase:jl.Stringify,buffer:r,context:a})),r[0]},Bl=async(e,t,r,a,s)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const o=e.callbacks;return o!=null&&o.length?(s?s[0]+=e:s=[e],Promise.all(o.map(i=>i({phase:t,buffer:s,context:a}))).then(i=>Promise.all(i.filter(Boolean).map(l=>Bl(l,t,!1,a,s))).then(()=>s[0]))):Promise.resolve(e)},mc="text/plain; charset=UTF-8",Es=(e,t)=>({"Content-Type":e,...t}),Xr,Zr,ot,mr,nt,Ie,ea,gr,hr,Bt,ta,ra,xt,lr,_l,gc=(_l=class{constructor(e,t){V(this,xt);V(this,Xr);V(this,Zr);$(this,"env",{});V(this,ot);$(this,"finalized",!1);$(this,"error");V(this,mr);V(this,nt);V(this,Ie);V(this,ea);V(this,gr);V(this,hr);V(this,Bt);V(this,ta);V(this,ra);$(this,"render",(...e)=>(R(this,gr)??U(this,gr,t=>this.html(t)),R(this,gr).call(this,...e)));$(this,"setLayout",e=>U(this,ea,e));$(this,"getLayout",()=>R(this,ea));$(this,"setRenderer",e=>{U(this,gr,e)});$(this,"header",(e,t,r)=>{this.finalized&&U(this,Ie,new Response(R(this,Ie).body,R(this,Ie)));const a=R(this,Ie)?R(this,Ie).headers:R(this,Bt)??U(this,Bt,new Headers);t===void 0?a.delete(e):r!=null&&r.append?a.append(e,t):a.set(e,t)});$(this,"status",e=>{U(this,mr,e)});$(this,"set",(e,t)=>{R(this,ot)??U(this,ot,new Map),R(this,ot).set(e,t)});$(this,"get",e=>R(this,ot)?R(this,ot).get(e):void 0);$(this,"newResponse",(...e)=>X(this,xt,lr).call(this,...e));$(this,"body",(e,t,r)=>X(this,xt,lr).call(this,e,t,r));$(this,"text",(e,t,r)=>!R(this,Bt)&&!R(this,mr)&&!t&&!r&&!this.finalized?new Response(e):X(this,xt,lr).call(this,e,t,Es(mc,r)));$(this,"json",(e,t,r)=>X(this,xt,lr).call(this,JSON.stringify(e),t,Es("application/json",r)));$(this,"html",(e,t,r)=>{const a=s=>X(this,xt,lr).call(this,s,t,Es("text/html; charset=UTF-8",r));return typeof e=="object"?Bl(e,jl.Stringify,!1,{}).then(a):a(e)});$(this,"redirect",(e,t)=>{const r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)});$(this,"notFound",()=>(R(this,hr)??U(this,hr,()=>new Response),R(this,hr).call(this,this)));U(this,Xr,e),t&&(U(this,nt,t.executionCtx),this.env=t.env,U(this,hr,t.notFoundHandler),U(this,ra,t.path),U(this,ta,t.matchResult))}get req(){return R(this,Zr)??U(this,Zr,new Nl(R(this,Xr),R(this,ra),R(this,ta))),R(this,Zr)}get event(){if(R(this,nt)&&"respondWith"in R(this,nt))return R(this,nt);throw Error("This context has no FetchEvent")}get executionCtx(){if(R(this,nt))return R(this,nt);throw Error("This context has no ExecutionContext")}get res(){return R(this,Ie)||U(this,Ie,new Response(null,{headers:R(this,Bt)??U(this,Bt,new Headers)}))}set res(e){if(R(this,Ie)&&e){e=new Response(e.body,e);for(const[t,r]of R(this,Ie).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const a=R(this,Ie).headers.getSetCookie();e.headers.delete("set-cookie");for(const s of a)e.headers.append("set-cookie",s)}else e.headers.set(t,r)}U(this,Ie,e),this.finalized=!0}get var(){return R(this,ot)?Object.fromEntries(R(this,ot)):{}}},Xr=new WeakMap,Zr=new WeakMap,ot=new WeakMap,mr=new WeakMap,nt=new WeakMap,Ie=new WeakMap,ea=new WeakMap,gr=new WeakMap,hr=new WeakMap,Bt=new WeakMap,ta=new WeakMap,ra=new WeakMap,xt=new WeakSet,lr=function(e,t,r){const a=R(this,Ie)?new Headers(R(this,Ie).headers):R(this,Bt)??new Headers;if(typeof t=="object"&&"headers"in t){const o=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[n,i]of o)n.toLowerCase()==="set-cookie"?a.append(n,i):a.set(n,i)}if(r)for(const[o,n]of Object.entries(r))if(typeof n=="string")a.set(o,n);else{a.delete(o);for(const i of n)a.append(o,i)}const s=typeof t=="number"?t:(t==null?void 0:t.status)??R(this,mr);return new Response(e,{status:s,headers:a})},_l),he="ALL",hc="all",fc=["get","post","put","delete","options","patch"],Fl="Can not add a route since the matcher is already built.",$l=class extends Error{},vc="__COMPOSED_HANDLER",yc=e=>e.text("404 Not Found",404),kn=(e,t)=>{if("getResponse"in e){const r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},Je,fe,Ul,Ye,Pt,$a,Ha,El,Hl=(El=class{constructor(t={}){V(this,fe);$(this,"get");$(this,"post");$(this,"put");$(this,"delete");$(this,"options");$(this,"patch");$(this,"all");$(this,"on");$(this,"use");$(this,"router");$(this,"getPath");$(this,"_basePath","/");V(this,Je,"/");$(this,"routes",[]);V(this,Ye,yc);$(this,"errorHandler",kn);$(this,"onError",t=>(this.errorHandler=t,this));$(this,"notFound",t=>(U(this,Ye,t),this));$(this,"fetch",(t,...r)=>X(this,fe,Ha).call(this,t,r[1],r[0],t.method));$(this,"request",(t,r,a,s)=>t instanceof Request?this.fetch(r?new Request(t,r):t,a,s):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${ir("/",t)}`,r),a,s)));$(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(X(this,fe,Ha).call(this,t.request,t,void 0,t.request.method))})});[...fc,hc].forEach(o=>{this[o]=(n,...i)=>(typeof n=="string"?U(this,Je,n):X(this,fe,Pt).call(this,o,R(this,Je),n),i.forEach(l=>{X(this,fe,Pt).call(this,o,R(this,Je),l)}),this)}),this.on=(o,n,...i)=>{for(const l of[n].flat()){U(this,Je,l);for(const d of[o].flat())i.map(c=>{X(this,fe,Pt).call(this,d.toUpperCase(),R(this,Je),c)})}return this},this.use=(o,...n)=>(typeof o=="string"?U(this,Je,o):(U(this,Je,"*"),n.unshift(o)),n.forEach(i=>{X(this,fe,Pt).call(this,he,R(this,Je),i)}),this);const{strict:a,...s}=t;Object.assign(this,s),this.getPath=a??!0?t.getPath??Ol:ic}route(t,r){const a=this.basePath(t);return r.routes.map(s=>{var n;let o;r.errorHandler===kn?o=s.handler:(o=async(i,l)=>(await An([],r.errorHandler)(i,()=>s.handler(i,l))).res,o[vc]=s.handler),X(n=a,fe,Pt).call(n,s.method,s.path,o)}),this}basePath(t){const r=X(this,fe,Ul).call(this);return r._basePath=ir(this._basePath,t),r}mount(t,r,a){let s,o;a&&(typeof a=="function"?o=a:(o=a.optionHandler,a.replaceRequest===!1?s=l=>l:s=a.replaceRequest));const n=o?l=>{const d=o(l);return Array.isArray(d)?d:[d]}:l=>{let d;try{d=l.executionCtx}catch{}return[l.env,d]};s||(s=(()=>{const l=ir(this._basePath,t),d=l==="/"?0:l.length;return c=>{const u=new URL(c.url);return u.pathname=u.pathname.slice(d)||"/",new Request(u,c)}})());const i=async(l,d)=>{const c=await r(s(l.req.raw),...n(l));if(c)return c;await d()};return X(this,fe,Pt).call(this,he,ir(t,"*"),i),this}},Je=new WeakMap,fe=new WeakSet,Ul=function(){const t=new Hl({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,U(t,Ye,R(this,Ye)),t.routes=this.routes,t},Ye=new WeakMap,Pt=function(t,r,a){t=t.toUpperCase(),r=ir(this._basePath,r);const s={basePath:this._basePath,path:r,method:t,handler:a};this.router.add(t,r,[a,s]),this.routes.push(s)},$a=function(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t},Ha=function(t,r,a,s){if(s==="HEAD")return(async()=>new Response(null,await X(this,fe,Ha).call(this,t,r,a,"GET")))();const o=this.getPath(t,{env:a}),n=this.router.match(s,o),i=new gc(t,{path:o,matchResult:n,env:a,executionCtx:r,notFoundHandler:R(this,Ye)});if(n[0].length===1){let d;try{d=n[0][0][0][0](i,async()=>{i.res=await R(this,Ye).call(this,i)})}catch(c){return X(this,fe,$a).call(this,c,i)}return d instanceof Promise?d.then(c=>c||(i.finalized?i.res:R(this,Ye).call(this,i))).catch(c=>X(this,fe,$a).call(this,c,i)):d??R(this,Ye).call(this,i)}const l=An(n[0],this.errorHandler,R(this,Ye));return(async()=>{try{const d=await l(i);if(!d.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return d.res}catch(d){return X(this,fe,$a).call(this,d,i)}})()},El),Gl=[];function bc(e,t){const r=this.buildAllMatchers(),a=(s,o)=>{const n=r[s]||r[he],i=n[2][o];if(i)return i;const l=o.match(n[0]);if(!l)return[[],Gl];const d=l.indexOf("",1);return[n[1][d],l]};return this.match=a,a(e,t)}var Ga="[^/]+",zr=".*",Jr="(?:|/.*)",dr=Symbol(),xc=new Set(".\\+*[^]$()");function _c(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===zr||e===Jr?1:t===zr||t===Jr?-1:e===Ga?1:t===Ga?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var Ft,$t,Ke,wl,Fo=(wl=class{constructor(){V(this,Ft);V(this,$t);V(this,Ke,Object.create(null))}insert(t,r,a,s,o){if(t.length===0){if(R(this,Ft)!==void 0)throw dr;if(o)return;U(this,Ft,r);return}const[n,...i]=t,l=n==="*"?i.length===0?["","",zr]:["","",Ga]:n==="/*"?["","",Jr]:n.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let d;if(l){const c=l[1];let u=l[2]||Ga;if(c&&l[2]&&(u===".*"||(u=u.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(u))))throw dr;if(d=R(this,Ke)[u],!d){if(Object.keys(R(this,Ke)).some(p=>p!==zr&&p!==Jr))throw dr;if(o)return;d=R(this,Ke)[u]=new Fo,c!==""&&U(d,$t,s.varIndex++)}!o&&c!==""&&a.push([c,R(d,$t)])}else if(d=R(this,Ke)[n],!d){if(Object.keys(R(this,Ke)).some(c=>c.length>1&&c!==zr&&c!==Jr))throw dr;if(o)return;d=R(this,Ke)[n]=new Fo}d.insert(i,r,a,s,o)}buildRegExpStr(){const r=Object.keys(R(this,Ke)).sort(_c).map(a=>{const s=R(this,Ke)[a];return(typeof R(s,$t)=="number"?`(${a})@${R(s,$t)}`:xc.has(a)?`\\${a}`:a)+s.buildRegExpStr()});return typeof R(this,Ft)=="number"&&r.unshift(`#${R(this,Ft)}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}},Ft=new WeakMap,$t=new WeakMap,Ke=new WeakMap,wl),za,aa,Tl,Ec=(Tl=class{constructor(){V(this,za,{varIndex:0});V(this,aa,new Fo)}insert(e,t,r){const a=[],s=[];for(let n=0;;){let i=!1;if(e=e.replace(/\{[^}]+\}/g,l=>{const d=`@\\${n}`;return s[n]=[d,l],n++,i=!0,d}),!i)break}const o=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let n=s.length-1;n>=0;n--){const[i]=s[n];for(let l=o.length-1;l>=0;l--)if(o[l].indexOf(i)!==-1){o[l]=o[l].replace(i,s[n][1]);break}}return R(this,aa).insert(o,t,a,R(this,za),r),a}buildRegExp(){let e=R(this,aa).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const r=[],a=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,o,n)=>o!==void 0?(r[++t]=Number(o),"$()"):(n!==void 0&&(a[Number(n)]=++t),"")),[new RegExp(`^${e}`),r,a]}},za=new WeakMap,aa=new WeakMap,Tl),wc=[/^$/,[],Object.create(null)],Ua=Object.create(null);function Wl(e){return Ua[e]??(Ua[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`))}function Tc(){Ua=Object.create(null)}function Sc(e){var d;const t=new Ec,r=[];if(e.length===0)return wc;const a=e.map(c=>[!/\*|\/:/.test(c[0]),...c]).sort(([c,u],[p,m])=>c?1:p?-1:u.length-m.length),s=Object.create(null);for(let c=0,u=-1,p=a.length;c<p;c++){const[m,g,b]=a[c];m?s[g]=[b.map(([y])=>[y,Object.create(null)]),Gl]:u++;let v;try{v=t.insert(g,u,m)}catch(y){throw y===dr?new $l(g):y}m||(r[u]=b.map(([y,f])=>{const x=Object.create(null);for(f-=1;f>=0;f--){const[_,C]=v[f];x[_]=C}return[y,x]}))}const[o,n,i]=t.buildRegExp();for(let c=0,u=r.length;c<u;c++)for(let p=0,m=r[c].length;p<m;p++){const g=(d=r[c][p])==null?void 0:d[1];if(!g)continue;const b=Object.keys(g);for(let v=0,y=b.length;v<y;v++)g[b[v]]=i[g[b[v]]]}const l=[];for(const c in n)l[c]=r[n[c]];return[o,l,s]}function Qt(e,t){if(e){for(const r of Object.keys(e).sort((a,s)=>s.length-a.length))if(Wl(r).test(t))return[...e[r]]}}var _t,Et,Ja,ql,Sl,Cc=(Sl=class{constructor(){V(this,Ja);$(this,"name","RegExpRouter");V(this,_t);V(this,Et);$(this,"match",bc);U(this,_t,{[he]:Object.create(null)}),U(this,Et,{[he]:Object.create(null)})}add(e,t,r){var i;const a=R(this,_t),s=R(this,Et);if(!a||!s)throw new Error(Fl);a[e]||[a,s].forEach(l=>{l[e]=Object.create(null),Object.keys(l[he]).forEach(d=>{l[e][d]=[...l[he][d]]})}),t==="/*"&&(t="*");const o=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const l=Wl(t);e===he?Object.keys(a).forEach(d=>{var c;(c=a[d])[t]||(c[t]=Qt(a[d],t)||Qt(a[he],t)||[])}):(i=a[e])[t]||(i[t]=Qt(a[e],t)||Qt(a[he],t)||[]),Object.keys(a).forEach(d=>{(e===he||e===d)&&Object.keys(a[d]).forEach(c=>{l.test(c)&&a[d][c].push([r,o])})}),Object.keys(s).forEach(d=>{(e===he||e===d)&&Object.keys(s[d]).forEach(c=>l.test(c)&&s[d][c].push([r,o]))});return}const n=kl(t)||[t];for(let l=0,d=n.length;l<d;l++){const c=n[l];Object.keys(s).forEach(u=>{var p;(e===he||e===u)&&((p=s[u])[c]||(p[c]=[...Qt(a[u],c)||Qt(a[he],c)||[]]),s[u][c].push([r,o-d+l+1]))})}}buildAllMatchers(){const e=Object.create(null);return Object.keys(R(this,Et)).concat(Object.keys(R(this,_t))).forEach(t=>{e[t]||(e[t]=X(this,Ja,ql).call(this,t))}),U(this,_t,U(this,Et,void 0)),Tc(),e}},_t=new WeakMap,Et=new WeakMap,Ja=new WeakSet,ql=function(e){const t=[];let r=e===he;return[R(this,_t),R(this,Et)].forEach(a=>{const s=a[e]?Object.keys(a[e]).map(o=>[o,a[e][o]]):[];s.length!==0?(r||(r=!0),t.push(...s)):e!==he&&t.push(...Object.keys(a[he]).map(o=>[o,a[he][o]]))}),r?Sc(t):null},Sl),wt,it,Cl,Ic=(Cl=class{constructor(e){$(this,"name","SmartRouter");V(this,wt,[]);V(this,it,[]);U(this,wt,e.routers)}add(e,t,r){if(!R(this,it))throw new Error(Fl);R(this,it).push([e,t,r])}match(e,t){if(!R(this,it))throw new Error("Fatal error");const r=R(this,wt),a=R(this,it),s=r.length;let o=0,n;for(;o<s;o++){const i=r[o];try{for(let l=0,d=a.length;l<d;l++)i.add(...a[l]);n=i.match(e,t)}catch(l){if(l instanceof $l)continue;throw l}this.match=i.match.bind(i),U(this,wt,[i]),U(this,it,void 0);break}if(o===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,n}get activeRouter(){if(R(this,it)||R(this,wt).length!==1)throw new Error("No active router has been determined yet.");return R(this,wt)[0]}},wt=new WeakMap,it=new WeakMap,Cl),Cr=Object.create(null),Tt,Ee,Ht,fr,be,lt,Lt,Il,Vl=(Il=class{constructor(e,t,r){V(this,lt);V(this,Tt);V(this,Ee);V(this,Ht);V(this,fr,0);V(this,be,Cr);if(U(this,Ee,r||Object.create(null)),U(this,Tt,[]),e&&t){const a=Object.create(null);a[e]={handler:t,possibleKeys:[],score:0},U(this,Tt,[a])}U(this,Ht,[])}insert(e,t,r){U(this,fr,++Rn(this,fr)._);let a=this;const s=rc(t),o=[];for(let n=0,i=s.length;n<i;n++){const l=s[n],d=s[n+1],c=oc(l,d),u=Array.isArray(c)?c[0]:l;if(u in R(a,Ee)){a=R(a,Ee)[u],c&&o.push(c[1]);continue}R(a,Ee)[u]=new Vl,c&&(R(a,Ht).push(c),o.push(c[1])),a=R(a,Ee)[u]}return R(a,Tt).push({[e]:{handler:r,possibleKeys:o.filter((n,i,l)=>l.indexOf(n)===i),score:R(this,fr)}}),a}search(e,t){var i;const r=[];U(this,be,Cr);let s=[this];const o=Al(t),n=[];for(let l=0,d=o.length;l<d;l++){const c=o[l],u=l===d-1,p=[];for(let m=0,g=s.length;m<g;m++){const b=s[m],v=R(b,Ee)[c];v&&(U(v,be,R(b,be)),u?(R(v,Ee)["*"]&&r.push(...X(this,lt,Lt).call(this,R(v,Ee)["*"],e,R(b,be))),r.push(...X(this,lt,Lt).call(this,v,e,R(b,be)))):p.push(v));for(let y=0,f=R(b,Ht).length;y<f;y++){const x=R(b,Ht)[y],_=R(b,be)===Cr?{}:{...R(b,be)};if(x==="*"){const N=R(b,Ee)["*"];N&&(r.push(...X(this,lt,Lt).call(this,N,e,R(b,be))),U(N,be,_),p.push(N));continue}const[C,A,I]=x;if(!c&&!(I instanceof RegExp))continue;const M=R(b,Ee)[C],F=o.slice(l).join("/");if(I instanceof RegExp){const N=I.exec(F);if(N){if(_[A]=N[0],r.push(...X(this,lt,Lt).call(this,M,e,R(b,be),_)),Object.keys(R(M,Ee)).length){U(M,be,_);const E=((i=N[0].match(/\//))==null?void 0:i.length)??0;(n[E]||(n[E]=[])).push(M)}continue}}(I===!0||I.test(c))&&(_[A]=c,u?(r.push(...X(this,lt,Lt).call(this,M,e,_,R(b,be))),R(M,Ee)["*"]&&r.push(...X(this,lt,Lt).call(this,R(M,Ee)["*"],e,_,R(b,be)))):(U(M,be,_),p.push(M)))}}s=p.concat(n.shift()??[])}return r.length>1&&r.sort((l,d)=>l.score-d.score),[r.map(({handler:l,params:d})=>[l,d])]}},Tt=new WeakMap,Ee=new WeakMap,Ht=new WeakMap,fr=new WeakMap,be=new WeakMap,lt=new WeakSet,Lt=function(e,t,r,a){const s=[];for(let o=0,n=R(e,Tt).length;o<n;o++){const i=R(e,Tt)[o],l=i[t]||i[he],d={};if(l!==void 0&&(l.params=Object.create(null),s.push(l),r!==Cr||a&&a!==Cr))for(let c=0,u=l.possibleKeys.length;c<u;c++){const p=l.possibleKeys[c],m=d[l.score];l.params[p]=a!=null&&a[p]&&!m?a[p]:r[p]??(a==null?void 0:a[p]),d[l.score]=!0}}return s},Il),Ut,Rl,Rc=(Rl=class{constructor(){$(this,"name","TrieRouter");V(this,Ut);U(this,Ut,new Vl)}add(e,t,r){const a=kl(t);if(a){for(let s=0,o=a.length;s<o;s++)R(this,Ut).insert(e,a[s],r);return}R(this,Ut).insert(e,t,r)}match(e,t){return R(this,Ut).search(e,t)}},Ut=new WeakMap,Rl),ee=class extends Hl{constructor(e={}){super(e),this.router=e.router??new Ic({routers:[new Cc,new Rc]})}},vr=e=>{const r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},a=(o=>typeof o=="string"?o==="*"?()=>o:n=>o===n?n:null:typeof o=="function"?o:n=>o.includes(n)?n:null)(r.origin),s=(o=>typeof o=="function"?o:Array.isArray(o)?()=>o:()=>[])(r.allowMethods);return async function(n,i){var c;function l(u,p){n.res.headers.set(u,p)}const d=await a(n.req.header("origin")||"",n);if(d&&l("Access-Control-Allow-Origin",d),r.origin!=="*"){const u=n.req.header("Vary");u?l("Vary",u):l("Vary","Origin")}if(r.credentials&&l("Access-Control-Allow-Credentials","true"),(c=r.exposeHeaders)!=null&&c.length&&l("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),n.req.method==="OPTIONS"){r.maxAge!=null&&l("Access-Control-Max-Age",r.maxAge.toString());const u=await s(n.req.header("origin")||"",n);u.length&&l("Access-Control-Allow-Methods",u.join(","));let p=r.allowHeaders;if(!(p!=null&&p.length)){const m=n.req.header("Access-Control-Request-Headers");m&&(p=m.split(/\s*,\s*/))}return p!=null&&p.length&&(l("Access-Control-Allow-Headers",p.join(",")),n.res.headers.append("Vary","Access-Control-Request-Headers")),n.res.headers.delete("Content-Length"),n.res.headers.delete("Content-Type"),new Response(null,{headers:n.res.headers,status:204,statusText:"No Content"})}await i()}},Ac=/^\s*(?:text\/(?!event-stream(?:[;\s]|$))[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,Dn=(e,t=kc)=>{const r=/\.([a-zA-Z0-9]+?)$/,a=e.match(r);if(!a)return;let s=t[a[1]];return s&&s.startsWith("text")&&(s+="; charset=utf-8"),s},Oc={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},kc=Oc,Dc=(...e)=>{let t=e.filter(s=>s!=="").join("/");t=t.replace(new RegExp("(?<=\\/)\\/+","g"),"");const r=t.split("/"),a=[];for(const s of r)s===".."&&a.length>0&&a.at(-1)!==".."?a.pop():s!=="."&&a.push(s);return a.join("/")||"."},zl={br:".br",zstd:".zst",gzip:".gz"},Mc=Object.keys(zl),Nc="index.html",Pc=e=>{const t=e.root??"./",r=e.path,a=e.join??Dc;return async(s,o)=>{var c,u,p,m;if(s.finalized)return o();let n;if(e.path)n=e.path;else try{if(n=decodeURIComponent(s.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(n))throw new Error}catch{return await((c=e.onNotFound)==null?void 0:c.call(e,s.req.path,s)),o()}let i=a(t,!r&&e.rewriteRequestPath?e.rewriteRequestPath(n):n);e.isDir&&await e.isDir(i)&&(i=a(i,Nc));const l=e.getContent;let d=await l(i,s);if(d instanceof Response)return s.newResponse(d.body,d);if(d){const g=e.mimes&&Dn(i,e.mimes)||Dn(i);if(s.header("Content-Type",g||"application/octet-stream"),e.precompressed&&(!g||Ac.test(g))){const b=new Set((u=s.req.header("Accept-Encoding"))==null?void 0:u.split(",").map(v=>v.trim()));for(const v of Mc){if(!b.has(v))continue;const y=await l(i+zl[v],s);if(y){d=y,s.header("Content-Encoding",v),s.header("Vary","Accept-Encoding",{append:!0});break}}}return await((p=e.onFound)==null?void 0:p.call(e,i,s)),s.body(d)}await((m=e.onNotFound)==null?void 0:m.call(e,i,s)),await o()}},Lc=async(e,t)=>{let r;t&&t.manifest?typeof t.manifest=="string"?r=JSON.parse(t.manifest):r=t.manifest:typeof __STATIC_CONTENT_MANIFEST=="string"?r=JSON.parse(__STATIC_CONTENT_MANIFEST):r=__STATIC_CONTENT_MANIFEST;let a;t&&t.namespace?a=t.namespace:a=__STATIC_CONTENT;const s=r[e]||e;if(!s)return null;const o=await a.get(s,{type:"stream"});return o||null},jc=e=>async function(r,a){return Pc({...e,getContent:async o=>Lc(o,{manifest:e.manifest,namespace:e.namespace?e.namespace:r.env?r.env.__STATIC_CONTENT:void 0})})(r,a)},Bc=e=>jc(e),Jl=e=>Kl(e.replace(/_|-/g,t=>({_:"/","-":"+"})[t]??t)),Yl=e=>Fc(e).replace(/\/|\+/g,t=>({"/":"_","+":"-"})[t]??t),Fc=e=>{let t="";const r=new Uint8Array(e);for(let a=0,s=r.length;a<s;a++)t+=String.fromCharCode(r[a]);return btoa(t)},Kl=e=>{const t=atob(e),r=new Uint8Array(new ArrayBuffer(t.length)),a=t.length/2;for(let s=0,o=t.length-1;s<=a;s++,o--)r[s]=t.charCodeAt(s),r[o]=t.charCodeAt(o);return r},Ql=(e=>(e.HS256="HS256",e.HS384="HS384",e.HS512="HS512",e.RS256="RS256",e.RS384="RS384",e.RS512="RS512",e.PS256="PS256",e.PS384="PS384",e.PS512="PS512",e.ES256="ES256",e.ES384="ES384",e.ES512="ES512",e.EdDSA="EdDSA",e))(Ql||{}),$c={deno:"Deno",bun:"Bun",workerd:"Cloudflare-Workers",node:"Node.js"},Hc=()=>{var r,a;const e=globalThis;if(typeof navigator<"u"&&typeof navigator.userAgent=="string"){for(const[s,o]of Object.entries($c))if(Uc(o))return s}return typeof(e==null?void 0:e.EdgeRuntime)=="string"?"edge-light":(e==null?void 0:e.fastly)!==void 0?"fastly":((a=(r=e==null?void 0:e.process)==null?void 0:r.release)==null?void 0:a.name)==="node"?"node":"other"},Uc=e=>navigator.userAgent.startsWith(e),Gc=class extends Error{constructor(e){super(`${e} is not an implemented algorithm`),this.name="JwtAlgorithmNotImplemented"}},Xl=class extends Error{constructor(e){super(`invalid JWT token: ${e}`),this.name="JwtTokenInvalid"}},Wc=class extends Error{constructor(e){super(`token (${e}) is being used before it's valid`),this.name="JwtTokenNotBefore"}},qc=class extends Error{constructor(e){super(`token (${e}) expired`),this.name="JwtTokenExpired"}},Vc=class extends Error{constructor(e,t){super(`Invalid "iat" claim, must be a valid number lower than "${e}" (iat: "${t}")`),this.name="JwtTokenIssuedAt"}},ws=class extends Error{constructor(e,t){super(`expected issuer "${e}", got ${t?`"${t}"`:"none"} `),this.name="JwtTokenIssuer"}},zc=class extends Error{constructor(e){super(`jwt header is invalid: ${JSON.stringify(e)}`),this.name="JwtHeaderInvalid"}},Jc=class extends Error{constructor(e){super(`token(${e}) signature mismatched`),this.name="JwtTokenSignatureMismatched"}},Kr=(e=>(e.Encrypt="encrypt",e.Decrypt="decrypt",e.Sign="sign",e.Verify="verify",e.DeriveKey="deriveKey",e.DeriveBits="deriveBits",e.WrapKey="wrapKey",e.UnwrapKey="unwrapKey",e))(Kr||{}),sa=new TextEncoder,Yc=new TextDecoder;async function Kc(e,t,r){const a=Zl(t),s=await Xc(e,a);return await crypto.subtle.sign(a,s,r)}async function Qc(e,t,r,a){const s=Zl(t),o=await Zc(e,s);return await crypto.subtle.verify(s,o,r,a)}function $o(e){return Kl(e.replace(/-+(BEGIN|END).*/g,"").replace(/\s/g,""))}async function Xc(e,t){if(!crypto.subtle||!crypto.subtle.importKey)throw new Error("`crypto.subtle.importKey` is undefined. JWT auth middleware requires it.");if(ed(e)){if(e.type!=="private"&&e.type!=="secret")throw new Error(`unexpected key type: CryptoKey.type is ${e.type}, expected private or secret`);return e}const r=[Kr.Sign];return typeof e=="object"?await crypto.subtle.importKey("jwk",e,t,!1,r):e.includes("PRIVATE")?await crypto.subtle.importKey("pkcs8",$o(e),t,!1,r):await crypto.subtle.importKey("raw",sa.encode(e),t,!1,r)}async function Zc(e,t){if(!crypto.subtle||!crypto.subtle.importKey)throw new Error("`crypto.subtle.importKey` is undefined. JWT auth middleware requires it.");if(ed(e)){if(e.type==="public"||e.type==="secret")return e;e=await Mn(e)}if(typeof e=="string"&&e.includes("PRIVATE")){const a=await crypto.subtle.importKey("pkcs8",$o(e),t,!0,[Kr.Sign]);e=await Mn(a)}const r=[Kr.Verify];return typeof e=="object"?await crypto.subtle.importKey("jwk",e,t,!1,r):e.includes("PUBLIC")?await crypto.subtle.importKey("spki",$o(e),t,!1,r):await crypto.subtle.importKey("raw",sa.encode(e),t,!1,r)}async function Mn(e){if(e.type!=="private")throw new Error(`unexpected key type: ${e.type}`);if(!e.extractable)throw new Error("unexpected private key is unextractable");const t=await crypto.subtle.exportKey("jwk",e),{kty:r}=t,{alg:a,e:s,n:o}=t,{crv:n,x:i,y:l}=t;return{kty:r,alg:a,e:s,n:o,crv:n,x:i,y:l,key_ops:[Kr.Verify]}}function Zl(e){switch(e){case"HS256":return{name:"HMAC",hash:{name:"SHA-256"}};case"HS384":return{name:"HMAC",hash:{name:"SHA-384"}};case"HS512":return{name:"HMAC",hash:{name:"SHA-512"}};case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"RS384":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}};case"RS512":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}};case"PS256":return{name:"RSA-PSS",hash:{name:"SHA-256"},saltLength:32};case"PS384":return{name:"RSA-PSS",hash:{name:"SHA-384"},saltLength:48};case"PS512":return{name:"RSA-PSS",hash:{name:"SHA-512"},saltLength:64};case"ES256":return{name:"ECDSA",hash:{name:"SHA-256"},namedCurve:"P-256"};case"ES384":return{name:"ECDSA",hash:{name:"SHA-384"},namedCurve:"P-384"};case"ES512":return{name:"ECDSA",hash:{name:"SHA-512"},namedCurve:"P-521"};case"EdDSA":return{name:"Ed25519",namedCurve:"Ed25519"};default:throw new Gc(e)}}function ed(e){return Hc()==="node"&&crypto.webcrypto?e instanceof crypto.webcrypto.CryptoKey:e instanceof CryptoKey}var Ts=e=>Yl(sa.encode(JSON.stringify(e)).buffer).replace(/=/g,""),eu=e=>Yl(e).replace(/=/g,""),Nn=e=>JSON.parse(Yc.decode(Jl(e)));function tu(e){if(typeof e=="object"&&e!==null){const t=e;return"alg"in t&&Object.values(Ql).includes(t.alg)&&(!("typ"in t)||t.typ==="JWT")}return!1}var ru=async(e,t,r="HS256")=>{const a=Ts(e);let s;typeof t=="object"&&"alg"in t?(r=t.alg,s=Ts({alg:r,typ:"JWT",kid:t.kid})):s=Ts({alg:r,typ:"JWT"});const o=`${s}.${a}`,n=await Kc(t,r,sa.encode(o)),i=eu(n);return`${o}.${i}`},au=async(e,t,r)=>{const a=typeof r=="string"?{alg:r}:r||{},s={alg:a.alg??"HS256",iss:a.iss,nbf:a.nbf??!0,exp:a.exp??!0,iat:a.iat??!0},o=e.split(".");if(o.length!==3)throw new Xl(e);const{header:n,payload:i}=su(e);if(!tu(n))throw new zc(n);const l=Date.now()/1e3|0;if(s.nbf&&i.nbf&&i.nbf>l)throw new Wc(e);if(s.exp&&i.exp&&i.exp<=l)throw new qc(e);if(s.iat&&i.iat&&l<i.iat)throw new Vc(l,i.iat);if(s.iss){if(!i.iss)throw new ws(s.iss,null);if(typeof s.iss=="string"&&i.iss!==s.iss)throw new ws(s.iss,i.iss);if(s.iss instanceof RegExp&&!s.iss.test(i.iss))throw new ws(s.iss,i.iss)}const d=e.substring(0,e.lastIndexOf("."));if(!await Qc(t,s.alg,Jl(o[2]),sa.encode(d)))throw new Jc(e);return i},su=e=>{try{const[t,r]=e.split("."),a=Nn(t),s=Nn(r);return{header:a,payload:s}}catch{throw new Xl(e)}},td={sign:ru,verify:au},te=td.verify,yr=td.sign;const Ya=Object.freeze(Object.defineProperty({__proto__:null,sign:yr,verify:te},Symbol.toStringTag,{value:"Module"}));var rd=Symbol("RENDERER"),ou=Symbol("ERROR_HANDLER"),nu=Symbol("INTERNAL"),Wa=Symbol("PERMALINK"),Pn=e=>(e[nu]=!0,e),iu=e=>({value:t,children:r})=>{if(!r)return;const a={children:[{tag:Pn(()=>{e.push(t)}),props:{}}]};Array.isArray(r)?a.children.push(...r.flat()):a.children.push(r),a.children.push({tag:Pn(()=>{e.pop()}),props:{}});const s={tag:"",props:a,type:""};return s[ou]=o=>{throw e.pop(),o},s},Ho=[],lu=e=>{const t=[e],r=a=>{t.push(a.value);let s;try{s=a.children?(Array.isArray(a.children)?new Tu("",{},a.children):a.children).toString():""}finally{t.pop()}return s instanceof Promise?s.then(o=>St(o,o.callbacks)):St(s)};return r.values=t,r.Provider=r,r[rd]=iu(t),Ho.push(r),r},Ka=e=>e.values.at(-1),du={title:[],script:["src"],style:["data-href"],link:["href"],meta:["name","httpEquiv","charset","itemProp"]},Ln={},cu="data-precedence",Qa=e=>Array.isArray(e)?e:[e],jn=new WeakMap,Bn=(e,t,r,a)=>({buffer:s,context:o})=>{if(!s)return;const n=jn.get(o)||{};jn.set(o,n);const i=n[e]||(n[e]=[]);let l=!1;const d=du[e];if(d.length>0){e:for(const[,c]of i)for(const u of d)if(((c==null?void 0:c[u])??null)===(r==null?void 0:r[u])){l=!0;break e}}if(l?s[0]=s[0].replaceAll(t,""):d.length>0?i.push([t,r,a]):i.unshift([t,r,a]),s[0].indexOf("</head>")!==-1){let c;if(a===void 0)c=i.map(([u])=>u);else{const u=[];c=i.map(([p,,m])=>{let g=u.indexOf(m);return g===-1&&(u.push(m),g=u.length-1),[p,g]}).sort((p,m)=>p[1]-m[1]).map(([p])=>p)}c.forEach(u=>{s[0]=s[0].replaceAll(u,"")}),s[0]=s[0].replace(/(?=<\/head>)/,c.join(""))}},oa=(e,t,r)=>St(new Qe(e,r,Qa(t??[])).toString()),na=(e,t,r,a)=>{if("itemProp"in r)return oa(e,t,r);let{precedence:s,blocking:o,...n}=r;s=a?s??"":void 0,a&&(n[cu]=s);const i=new Qe(e,n,Qa(t||[])).toString();return i instanceof Promise?i.then(l=>St(i,[...l.callbacks||[],Bn(e,l,n,s)])):St(i,[Bn(e,i,n,s)])},uu=({children:e,...t})=>{const r=Yo();if(r){const a=Ka(r);if(a==="svg"||a==="head")return new Qe("title",t,Qa(e??[]))}return na("title",e,t,!1)},pu=({children:e,...t})=>{const r=Yo();return["src","async"].some(a=>!t[a])||r&&Ka(r)==="head"?oa("script",e,t):na("script",e,t,!1)},mu=({children:e,...t})=>["href","precedence"].every(r=>r in t)?(t["data-href"]=t.href,delete t.href,na("style",e,t,!0)):oa("style",e,t),gu=({children:e,...t})=>["onLoad","onError"].some(r=>r in t)||t.rel==="stylesheet"&&(!("precedence"in t)||"disabled"in t)?oa("link",e,t):na("link",e,t,"precedence"in t),hu=({children:e,...t})=>{const r=Yo();return r&&Ka(r)==="head"?oa("meta",e,t):na("meta",e,t,!1)},ad=(e,{children:t,...r})=>new Qe(e,r,Qa(t??[])),fu=e=>(typeof e.action=="function"&&(e.action=Wa in e.action?e.action[Wa]:void 0),ad("form",e)),sd=(e,t)=>(typeof t.formAction=="function"&&(t.formAction=Wa in t.formAction?t.formAction[Wa]:void 0),ad(e,t)),vu=e=>sd("input",e),yu=e=>sd("button",e);const Ss=Object.freeze(Object.defineProperty({__proto__:null,button:yu,form:fu,input:vu,link:gu,meta:hu,script:pu,style:mu,title:uu},Symbol.toStringTag,{value:"Module"}));var bu=new Map([["className","class"],["htmlFor","for"],["crossOrigin","crossorigin"],["httpEquiv","http-equiv"],["itemProp","itemprop"],["fetchPriority","fetchpriority"],["noModule","nomodule"],["formAction","formaction"]]),Fn=e=>bu.get(e)||e,xu=(e,t)=>{for(const[r,a]of Object.entries(e)){const s=r[0]==="-"||!/[A-Z]/.test(r)?r:r.replace(/[A-Z]/g,o=>`-${o.toLowerCase()}`);t(s,a==null?null:typeof a=="number"?s.match(/^(?:a|border-im|column(?:-c|s)|flex(?:$|-[^b])|grid-(?:ar|[^a])|font-w|li|or|sca|st|ta|wido|z)|ty$/)?`${a}`:`${a}px`:a)}},Qr=void 0,Yo=()=>Qr,_u=e=>/[A-Z]/.test(e)&&e.match(/^(?:al|basel|clip(?:Path|Rule)$|co|do|fill|fl|fo|gl|let|lig|i|marker[EMS]|o|pai|pointe|sh|st[or]|text[^L]|tr|u|ve|w)/)?e.replace(/([A-Z])/g,"-$1").toLowerCase():e,Eu=["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],wu=["allowfullscreen","async","autofocus","autoplay","checked","controls","default","defer","disabled","download","formnovalidate","hidden","inert","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],Ko=(e,t)=>{for(let r=0,a=e.length;r<a;r++){const s=e[r];if(typeof s=="string")ur(s,t);else{if(typeof s=="boolean"||s===null||s===void 0)continue;s instanceof Qe?s.toStringToBuffer(t):typeof s=="number"||s.isEscaped?t[0]+=s:s instanceof Promise?t.unshift("",s):Ko(s,t)}}},Qe=class{constructor(e,t,r){$(this,"tag");$(this,"props");$(this,"key");$(this,"children");$(this,"isEscaped",!0);$(this,"localContexts");this.tag=e,this.props=t,this.children=r}get type(){return this.tag}get ref(){return this.props.ref||null}toString(){var t,r;const e=[""];(t=this.localContexts)==null||t.forEach(([a,s])=>{a.values.push(s)});try{this.toStringToBuffer(e)}finally{(r=this.localContexts)==null||r.forEach(([a])=>{a.values.pop()})}return e.length===1?"callbacks"in e?pc(St(e[0],e.callbacks)).toString():e[0]:uc(e,e.callbacks)}toStringToBuffer(e){const t=this.tag,r=this.props;let{children:a}=this;e[0]+=`<${t}`;const s=Qr&&Ka(Qr)==="svg"?o=>_u(Fn(o)):o=>Fn(o);for(let[o,n]of Object.entries(r))if(o=s(o),o!=="children"){if(o==="style"&&typeof n=="object"){let i="";xu(n,(l,d)=>{d!=null&&(i+=`${i?";":""}${l}:${d}`)}),e[0]+=' style="',ur(i,e),e[0]+='"'}else if(typeof n=="string")e[0]+=` ${o}="`,ur(n,e),e[0]+='"';else if(n!=null)if(typeof n=="number"||n.isEscaped)e[0]+=` ${o}="${n}"`;else if(typeof n=="boolean"&&wu.includes(o))n&&(e[0]+=` ${o}=""`);else if(o==="dangerouslySetInnerHTML"){if(a.length>0)throw new Error("Can only set one of `children` or `props.dangerouslySetInnerHTML`.");a=[St(n.__html)]}else if(n instanceof Promise)e[0]+=` ${o}="`,e.unshift('"',n);else if(typeof n=="function"){if(!o.startsWith("on")&&o!=="ref")throw new Error(`Invalid prop '${o}' of type 'function' supplied to '${t}'.`)}else e[0]+=` ${o}="`,ur(n.toString(),e),e[0]+='"'}if(Eu.includes(t)&&a.length===0){e[0]+="/>";return}e[0]+=">",Ko(a,e),e[0]+=`</${t}>`}},Cs=class extends Qe{toStringToBuffer(e){const{children:t}=this,r=this.tag.call(null,{...this.props,children:t.length<=1?t[0]:t});if(!(typeof r=="boolean"||r==null))if(r instanceof Promise)if(Ho.length===0)e.unshift("",r);else{const a=Ho.map(s=>[s,s.values.at(-1)]);e.unshift("",r.then(s=>(s instanceof Qe&&(s.localContexts=a),s)))}else r instanceof Qe?r.toStringToBuffer(e):typeof r=="number"||r.isEscaped?(e[0]+=r,r.callbacks&&(e.callbacks||(e.callbacks=[]),e.callbacks.push(...r.callbacks))):ur(r,e)}},Tu=class extends Qe{toStringToBuffer(e){Ko(this.children,e)}},$n=!1,Is=(e,t,r)=>{if(!$n){for(const a in Ln)Ss[a][rd]=Ln[a];$n=!0}return typeof e=="function"?new Cs(e,t,r):Ss[e]?new Cs(Ss[e],t,r):e==="svg"||e==="head"?(Qr||(Qr=lu("")),new Qe(e,t,[new Cs(Qr,{value:e},r)])):new Qe(e,t,r)};function K(e,t,r){let a;if(!t||!("children"in t))a=Is(e,t,[]);else{const s=t.children;a=Array.isArray(s)?Is(e,t,s):Is(e,t,[s])}return a.key=r,a}function Su(){return K("html",{children:[K("head",{children:K("title",{children:"Proyecto no encontrado"})}),K("body",{children:[K("h1",{children:"Proyecto no encontrado"}),K("a",{href:"/",children:"Volver al inicio"})]})]})}const Cu=(e,t)=>`
  let selectedRating = 0;
  const projectId = '${e}';
  const authToken = '${t}';

  function generateVoteButtons() {
    const container = document.getElementById('vote-buttons');
    container.innerHTML = '';
    for (let i = 1; i <= 5; i++) {
      const button = document.createElement('button');
      button.onclick = () => selectRating(i);
      button.className = 'text-3xl transition-colors ' + (
        selectedRating >= i ? 'text-yellow-400' : 'text-gray-300'
      );
      button.innerHTML = '<i class="fas fa-star"></i>';
      container.appendChild(button);
    }
  }

  function selectRating(rating) {
    selectedRating = rating;
    generateVoteButtons();
    document.getElementById('submit-btn').disabled = false;
  }

  async function submitVote() {
    if (selectedRating === 0) {
      alert('Por favor selecciona una calificación');
      return;
    }
    try {
      const response = await fetch(\`/api/projects/\${projectId}/vote\`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': \`Bearer \${authToken}\`
        },
        body: JSON.stringify({ rating: selectedRating })
      });
      if (response.ok) {
        alert('¡Gracias por tu voto! Has contribuido a validar este proyecto.');
        window.location.href = '/leaderboard';
      } else {
        const error = await response.json();
        alert('Error: ' + (error.error || 'No se pudo registrar el voto'));
      }
    } catch (error) {
      console.error('Error voting:', error);
      alert('Error al votar. Inténtalo de nuevo.');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    generateVoteButtons();
  });
`;function Iu(e,t,r){return K("html",{lang:"es",children:[K("head",{children:[K("meta",{charSet:"UTF-8"}),K("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),K("title",{children:["Votar Proyecto - ",e.title]}),K("script",{src:"https://cdn.tailwindcss.com"}),K("link",{href:"https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css",rel:"stylesheet"}),K("script",{dangerouslySetInnerHTML:{__html:`
            tailwind.config = {
              theme: {
                extend: {
                  colors: {
                    primary: '#6366f1',
                    secondary: '#8b5cf6',
                  }
                }
              }
            }
          `}})]}),K("body",{className:"bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen",children:[K("div",{className:"max-w-2xl mx-auto px-4 py-12",children:K("div",{className:"bg-white rounded-xl shadow-lg p-8",children:[K("div",{className:"text-center mb-8",children:[K("i",{className:"fas fa-vote-yea text-4xl text-primary mb-4"}),K("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Votar Proyecto"}),K("p",{className:"text-gray-600",children:"Como validador, tu opinión es importante"})]}),K("div",{className:"bg-gray-50 rounded-lg p-6 mb-8",children:[K("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:e.title}),K("p",{className:"text-gray-600 mb-4",children:e.description}),K("div",{className:"flex items-center text-sm text-gray-500",children:[K("i",{className:"fas fa-user mr-2"}),K("span",{children:["Creado por ",e.creator_name]})]})]}),K("div",{className:"text-center",children:[K("p",{className:"text-lg font-medium text-gray-900 mb-6",children:"¿Cuántas estrellas le das a este proyecto?"}),K("div",{className:"flex justify-center space-x-2 mb-8",id:"vote-buttons"}),K("button",{onclick:"submitVote()",id:"submit-btn",className:"bg-primary text-white px-8 py-3 rounded-lg font-semibold hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[K("i",{className:"fas fa-paper-plane mr-2"}),"Enviar Voto"]})]})]})}),K("script",{dangerouslySetInnerHTML:{__html:Cu(t,r)}})]})]})}function br(e){const{content:t,currentPage:r,userName:a,userAvatar:s,pageTitle:o,userRole:n}=e;return`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${o} - ValidAI Studio</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"><\/script>
    <script>
      // Chat bootstrap: ensure handlers exist even if later scripts fail.
      (function() {
        console.log('[Chat Bootstrap] Initializing...');
        
        function safeGet(id) {
          return document.getElementById(id);
        }
        
        // Define toggleChatSidebar IMMEDIATELY in bootstrap
        window.toggleChatSidebar = function() {
            console.log('[CHAT-TOGGLE-BOOTSTRAP] Function called from bootstrap');
            var sidebar = safeGet('chat-sidebar');
            var floatingBtn = safeGet('chat-floating-btn');
            var chatOverlay = safeGet('chat-overlay');
            var isMobile = window.innerWidth <= 768;
            
            console.log('[CHAT-TOGGLE-BOOTSTRAP] Elements found:', {
                sidebar: !!sidebar,
                floatingBtn: !!floatingBtn,
                chatOverlay: !!chatOverlay,
                isMobile: isMobile
            });
            
            if (!sidebar) {
                console.error('[CHAT-TOGGLE-BOOTSTRAP] Sidebar not found!');
                return;
            }
            
            // Toggle state
            var isCurrentlyOpen = sidebar.style.display !== 'none' && sidebar.style.width !== '0px';
            console.log('[CHAT-TOGGLE-BOOTSTRAP] Current state:', isCurrentlyOpen ? 'OPEN' : 'CLOSED');
            
            if (isCurrentlyOpen) {
                // Close sidebar
                sidebar.style.width = '0px';
                sidebar.style.display = 'none';
                if (floatingBtn) floatingBtn.style.display = 'flex';
                if (chatOverlay) chatOverlay.classList.add('hidden');
                console.log('[CHAT-TOGGLE-BOOTSTRAP] Closed sidebar');
            } else {
                // Open sidebar
                sidebar.style.width = isMobile ? '100%' : '400px';
                sidebar.style.maxWidth = '400px';
                sidebar.style.display = 'flex';
                if (floatingBtn) floatingBtn.style.display = 'none';
                if (isMobile && chatOverlay) chatOverlay.classList.remove('hidden');
                console.log('[CHAT-TOGGLE-BOOTSTRAP] Opened sidebar');
            }
        };
        
        console.log('[Chat Bootstrap] toggleChatSidebar defined');

        // Simple markdown parser for chat messages - make global
        window.parseMarkdown = function(text) {
          if (!text) return '';
          var html = String(text);
          // Bold: **text** - use split/join approach
          while (html.indexOf('**') !== -1) {
            var start = html.indexOf('**');
            var end = html.indexOf('**', start + 2);
            if (end === -1) break;
            var boldText = html.substring(start + 2, end);
            html = html.substring(0, start) + '<strong class="font-semibold">' + boldText + '</strong>' + html.substring(end + 2);
          }
          // Horizontal rule: ---
          html = html.split('\\n---\\n').join('<hr class="my-3 border-gray-300">');
          // Line breaks
          html = html.split('\\n').join('<br>');
          html = html.split(String.fromCharCode(10)).join('<br>');
          return html;
        };
        var parseMarkdown = window.parseMarkdown;

        function bootstrapAddMessageToChat(role, content) {
          var messagesContainer = safeGet('chat-messages');
          if (!messagesContainer) return;

          var messageDiv = document.createElement('div');
          messageDiv.className = 'chat-message flex ' + (role === 'user' ? 'justify-end' : 'justify-start') + ' mb-3';

          var bubbleClass = role === 'user'
            ? 'bg-gradient-to-r from-primary to-secondary text-white'
            : 'bg-gray-100 text-gray-800';

          // Parse markdown for assistant messages
          var formattedContent = role === 'user' ? String(content || '') : parseMarkdown(content);

          messageDiv.innerHTML =
            '<div class="' + bubbleClass + ' rounded-xl px-4 py-3 max-w-[85%] shadow-md">' +
              '<div class="text-sm leading-relaxed">' + (role === 'user' ? '' : formattedContent) + '</div>' +
            '</div>';

          // For user messages, use textContent to prevent XSS
          if (role === 'user') {
            var textDiv = messageDiv.querySelector('div > div');
            if (textDiv) textDiv.textContent = String(content || '');
          }

          messagesContainer.appendChild(messageDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Goal questions for bootstrap flow handling
        var bootstrapGoalQuestions = [
            { field: 'category', question: 'What category does this goal belong to?', options: ['Build', 'Test', 'Traction'] },
            { field: 'description', question: 'Describe the goal briefly (What do you want to achieve?)', type: 'text' },
            { field: 'task', question: 'What is the specific task to achieve this goal? (Optional - press Enter to skip)', type: 'text', optional: true },
            { field: 'priority', question: 'What priority does this goal have?', options: ['P0', 'P1', 'P2', 'P3'] },
            { field: 'cadence', question: 'Is this a one-time or recurring goal?', options: ['One time', 'Recurrent'] },
            { field: 'assigned_to', question: 'Who should be assigned to this task?', type: 'team_member', optional: true },
            { field: 'goal_status', question: 'What is the current status of this goal?', options: ['To start', 'WIP', 'On Hold', 'Delayed', 'Blocked', 'Done'] },
            { field: 'week_of', question: 'For which week is this goal? (Optional - Example: "January 6")', type: 'text', optional: true }
        ];

        // Initialize goalCreationFlow immediately in bootstrap
        (function initGoalFlow() {
          try {
            var savedFlow = localStorage.getItem('goalCreationFlow');
            if (savedFlow) {
              window.goalCreationFlow = JSON.parse(savedFlow);
              console.log('[BOOTSTRAP] Restored flow from localStorage:', window.goalCreationFlow);
            } else {
              window.goalCreationFlow = { active: false, step: 0, data: {}, editingGoalId: null };
              console.log('[BOOTSTRAP] Initialized new goalCreationFlow');
            }
          } catch(e) {
            window.goalCreationFlow = { active: false, step: 0, data: {}, editingGoalId: null };
            console.log('[BOOTSTRAP] Error parsing localStorage, initialized fresh flow');
          }
        })();

        // Helper to get auth token from cookie or localStorage
        function bootstrapGetAuthToken() {
          var cookieMatch = document.cookie.match(/authToken=([^;]+)/);
          return cookieMatch ? cookieMatch[1] : localStorage.getItem('authToken');
        }

        function bootstrapShowQuickOptions(options) {
          var messagesContainer = safeGet('chat-messages');
          if (!messagesContainer) return;
          
          // Remove existing options first
          var existing = document.getElementById('quick-reply-buttons');
          if (existing) existing.remove();
          
          var optionsDiv = document.createElement('div');
          optionsDiv.className = 'quick-reply-options flex flex-wrap gap-2 mb-4';
          optionsDiv.id = 'quick-reply-buttons';
          
          options.forEach(function(option) {
            var btn = document.createElement('button');
            btn.className = 'px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-sm font-medium transition';
            btn.textContent = option;
            btn.onclick = function() { bootstrapHandleFlowAnswer(option); };
            optionsDiv.appendChild(btn);
          });
          
          messagesContainer.appendChild(optionsDiv);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function bootstrapSaveFlowState() {
          if (window.goalCreationFlow) {
            try {
              localStorage.setItem('goalCreationFlow', JSON.stringify(window.goalCreationFlow));
              console.log('[BOOTSTRAP] Flow state saved:', JSON.stringify(window.goalCreationFlow));
            } catch(e) {
              console.error('[BOOTSTRAP] Error saving flow state:', e);
            }
          }
        }

        function bootstrapHandleFlowAnswer(answer) {
          // Ensure goalCreationFlow exists
          if (!window.goalCreationFlow) {
            window.goalCreationFlow = { active: true, step: 0, data: {}, editingGoalId: null };
          }
          
          console.log('[BOOTSTRAP] handleFlowAnswer:', answer, 'step:', window.goalCreationFlow.step);
          
          // Remove quick reply buttons
          var buttons = document.getElementById('quick-reply-buttons');
          if (buttons) buttons.remove();
          
          // Show user's answer
          bootstrapAddMessageToChat('user', answer);
          
          // Get current question and save answer
          var currentStep = window.goalCreationFlow.step;
          var currentQuestion = bootstrapGoalQuestions[currentStep];
          
          if (currentQuestion) {
            // Handle team_member type - save user_id instead of name
            if (currentQuestion.type === 'team_member') {
              var teamMembers = window.currentTeamMembers || [];
              var selectedMember = teamMembers.find(function(m) {
                return (m.name || m.email) === answer;
              });
              
              if (selectedMember) {
                window.goalCreationFlow.data[currentQuestion.field] = selectedMember.user_id;
                console.log('[BOOTSTRAP] Saved team member user_id:', selectedMember.user_id);
              } else if (answer === 'Skip (No assignment)') {
                window.goalCreationFlow.data[currentQuestion.field] = null;
                console.log('[BOOTSTRAP] No team member assigned');
              } else {
                window.goalCreationFlow.data[currentQuestion.field] = answer;
              }
            } else {
              window.goalCreationFlow.data[currentQuestion.field] = answer;
            }
          }
          
          // Move to next step
          window.goalCreationFlow.step++;
          bootstrapSaveFlowState();
          
          // Check if more questions
          if (window.goalCreationFlow.step < bootstrapGoalQuestions.length) {
            var nextQuestion = bootstrapGoalQuestions[window.goalCreationFlow.step];
            bootstrapAddMessageToChat('assistant', nextQuestion.question);
            
            // Check if this question needs team members options
            if (nextQuestion.type === 'team_member') {
              console.log('[BOOTSTRAP] Loading team members for assignment...');
              bootstrapLoadTeamMembers();
            } else if (nextQuestion.options) {
              bootstrapShowQuickOptions(nextQuestion.options);
            }
          } else {
            // All questions answered - submit goal
            bootstrapCompleteGoalCreation();
          }
        }

        function bootstrapLoadTeamMembers() {
          var authToken = bootstrapGetAuthToken();
          var headers = { 'Content-Type': 'application/json' };
          if (authToken) {
            headers['Authorization'] = 'Bearer ' + authToken;
          }
          
          fetch('/api/dashboard/team-members', {
            credentials: 'include',
            headers: headers
          })
          .then(function(response) {
            if (!response.ok) {
              console.error('[BOOTSTRAP] Failed to load team members, status:', response.status);
              bootstrapShowQuickOptions(['Skip (No assignment)']);
              return null;
            }
            return response.json();
          })
          .then(function(data) {
            if (!data) return;
            
            var teamMembers = data.teamMembers || [];
            if (teamMembers.length === 0) {
              console.log('[BOOTSTRAP] No team members found');
              bootstrapShowQuickOptions(['Skip (No assignment)']);
              return;
            }
            
            // Create options with member names and IDs
            var options = teamMembers.map(function(member) {
              return member.name || member.email;
            });
            options.push('Skip (No assignment)');
            
            // Store team members for later use
            window.currentTeamMembers = teamMembers;
            
            console.log('[BOOTSTRAP] Showing', teamMembers.length, 'team members');
            bootstrapShowQuickOptions(options);
          })
          .catch(function(error) {
            console.error('[BOOTSTRAP] Error loading team members:', error);
            bootstrapShowQuickOptions(['Skip (No assignment)']);
          });
        }

        function bootstrapCompleteGoalCreation() {
          console.log('[BOOTSTRAP] Completing goal creation with data:', JSON.stringify(window.goalCreationFlow.data));
          
          bootstrapAddMessageToChat('assistant', 'Creating your goal...');
          
          var goalData = window.goalCreationFlow.data;
          var authToken = bootstrapGetAuthToken();
          
          var headers = { 'Content-Type': 'application/json' };
          if (authToken) {
            headers['Authorization'] = 'Bearer ' + authToken;
          }
          
          fetch('/api/dashboard/goals', {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: JSON.stringify({
              category: goalData.category || 'Build',
              description: goalData.description || '',
              task: goalData.task || '',
              priority: goalData.priority || 'P2',
              cadence: goalData.cadence || 'One time',
              assigned_to_user_id: goalData.assigned_to || null,
              goal_status: goalData.goal_status || 'To start',
              week_of: goalData.week_of || new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric' })
            })
          })
          .then(function(res) { return res.json(); })
          .then(function(data) {
            // Clear flow state
            window.goalCreationFlow.active = false;
            window.goalCreationFlow.step = 0;
            window.goalCreationFlow.data = {};
            localStorage.removeItem('goalCreationFlow');
            
            if (data.goal || data.success) {
              bootstrapAddMessageToChat('assistant', 'SUCCESS! Goal created successfully! -- ' + goalData.description + ' -- Category: ' + goalData.category + ' -- Priority: ' + goalData.priority);
            } else {
              bootstrapAddMessageToChat('assistant', 'ERROR: Error creating goal: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(function(e) {
            window.goalCreationFlow.active = false;
            window.goalCreationFlow.step = 0;
            window.goalCreationFlow.data = {};
            localStorage.removeItem('goalCreationFlow');
            bootstrapAddMessageToChat('assistant', 'ERROR: Error creating goal. Please try again.');
          });
        }

        function bootstrapSendChatMessage() {
          var input = safeGet('chat-input');
          if (!input) return;
          var message = input.value ? String(input.value).trim() : '';
          if (!message) return;

          // ========== CHECK IF EMAIL FLOW IS ACTIVE - HANDLE DIRECTLY ==========
          if (window.emailFlowState && window.emailFlowState.emailContext) {
            console.log('[BOOTSTRAP] Email flow is active - sending to API with flow state');
            
            // Clear input
            input.value = '';
            
            // Add user message to chat
            bootstrapAddMessageToChat('user', message);
            
            // Show loading
            var loadingEl = safeGet('chat-loading');
            if (loadingEl) loadingEl.classList.remove('hidden');
            
            // Send to API with email context
            fetch('/api/chat-agent/message', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({
                message: message,
                emailContext: window.emailFlowState.emailContext,
                flowState: window.emailFlowState.flowState
              })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
              if (loadingEl) loadingEl.classList.add('hidden');
              
              console.log('[BOOTSTRAP] Email flow API response:', data);
              
              // Update flow state
              if (data.flowState && data.emailContext) {
                window.emailFlowState = {
                  flowState: data.flowState,
                  emailContext: data.emailContext
                };
                console.log('[BOOTSTRAP] Updated email flow state:', window.emailFlowState);
              } else if (data.flowState === 'complete') {
                window.emailFlowState = null;
                console.log('[BOOTSTRAP] Email flow completed, cleared state');
              }
              
              // Show response
              if (data.message) {
                bootstrapAddMessageToChat('assistant', data.message);
              }
            })
            .catch(function(err) {
              if (loadingEl) loadingEl.classList.add('hidden');
              console.error('[BOOTSTRAP] Email flow API error:', err);
              bootstrapAddMessageToChat('assistant', 'Error processing your response. Please try again.');
            });
            
            return; // IMPORTANT: Exit here, don't continue to goal flow
          }
          // ========== END EMAIL FLOW CHECK ==========

          // ========== CHECK IF GOAL FLOW IS ACTIVE - PROCESS LOCALLY ==========
          if (window.goalCreationFlow && window.goalCreationFlow.active) {
            console.log('[BOOTSTRAP] Flow is active, processing answer locally');
            input.value = '';
            bootstrapHandleFlowAnswer(message);
            return;
          }
          // ========== END FLOW CHECK ==========

          // ========== GOAL KEYWORD DETECTION IN BOOTSTRAP ==========
          var goalKeywords = [
            'crear goal', 'create goal', 'nuevo goal', 'new goal', 'anadir goal',
            'crear objetivo', 'nuevo objetivo', 'anadir objetivo', 'agregar objetivo',
            'quiero crear', 'necesito crear', 'me gustaria crear',
            'agregar goal', 'hacer un goal', 'hacer un objetivo', 'crea un goal',
            'registrar goal', 'definir objetivo', 'establecer goal', 'poner un objetivo'
          ];
          var msgLower = message.toLowerCase();
          var hasGoalKeyword = goalKeywords.some(function(kw) { return msgLower.indexOf(kw) !== -1; });
          
          // Check if goalCreationFlow exists and start flow directly
          if (hasGoalKeyword && window.goalCreationFlow && !window.goalCreationFlow.active) {
            console.log('[BOOTSTRAP] Goal keyword detected! Starting flow...');
            bootstrapAddMessageToChat('user', message);
            input.value = '';
            // Use real function if available, otherwise bootstrap version
            if (typeof window.startGoalCreation === 'function' && window.startGoalCreation !== bootstrapStartGoalCreation) {
              window.startGoalCreation();
            } else {
              bootstrapStartGoalCreation();
            }
            return;
          }
          // ========== END GOAL KEYWORD DETECTION ==========

          bootstrapAddMessageToChat('user', message);
          input.value = '';

          var loading = safeGet('chat-loading');
          if (loading) loading.classList.remove('hidden');

          fetch('/api/chat-agent/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ message: message })
          })
          .then(function(res) {
            return res.json().then(function(data) {
              if (loading) loading.classList.add('hidden');
              if (res.ok && data) {
                // Check for goal flow trigger from backend - but only if flow not already active
                if (data.triggerGoalFlow === true && window.goalCreationFlow && !window.goalCreationFlow.active) {
                  console.log('[BOOTSTRAP] Backend triggered goal flow!');
                  if (typeof window.startGoalCreation === 'function' && window.startGoalCreation !== bootstrapStartGoalCreation) {
                    window.startGoalCreation();
                  } else {
                    bootstrapStartGoalCreation();
                  }
                  return; // Don't show the message
                }
                if (data.message) {
                  bootstrapAddMessageToChat('assistant', data.message);
                }
              } else {
                bootstrapAddMessageToChat('assistant', 'Sorry, there was an error. Please try again.');
              }
            });
          })
          .catch(function(e) {
            if (loading) loading.classList.add('hidden');
            bootstrapAddMessageToChat('assistant', 'Sorry, there was an error. Please try again.');
          });
        }

        function bootstrapHandleChatKeydown(event) {
          if (event && event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            bootstrapSendChatMessage();
          }
        }

        function bootstrapLogout() {
          document.cookie = 'authToken=; Max-Age=0; path=/;';
          window.location.href = '/';
        }

        function bootstrapToggleLeftSidebar() {
          var sidebar = document.querySelector('.left-sidebar');
          var overlay = safeGet('mobile-overlay');
          if (sidebar) sidebar.classList.toggle('open');
          if (overlay) overlay.classList.toggle('hidden');
        }

        function bootstrapToggleChatSidebar() {
          var sidebar = safeGet('chat-sidebar');
          if (sidebar) sidebar.classList.toggle('translate-x-full');
        }

        function bootstrapStartGoalCreation() {
          console.log('[Bootstrap] startGoalCreation called');
          
          // Check if goalCreationFlow exists and use the real implementation
          if (window.goalCreationFlow) {
            // Mark flow as active to prevent loops
            if (window.goalCreationFlow.active) {
              console.log('[Bootstrap] Flow already active, skipping');
              return;
            }
            window.goalCreationFlow.active = true;
            window.goalCreationFlow.step = 0;
            window.goalCreationFlow.data = {};
            bootstrapSaveFlowState();
          }
          
          // Show the first question directly with quick reply buttons
          bootstrapAddMessageToChat('assistant', 'Perfect! I will help you create a new goal. I will ask you 8 quick questions. --- What category does this goal belong to?');
          bootstrapShowQuickOptions(['ASTAR', 'MAGCIENT', 'OTHER']);
        }

        function bootstrapAnalyzeGoals() {
          console.log('[Bootstrap] analyzeGoals called');
          var input = safeGet('chat-input');
          if (input) {
            input.value = 'Analyze my current goals';
            bootstrapSendChatMessage();
          }
        }

        function bootstrapGenerateMarketingPlan() {
          console.log('[Bootstrap] generateMarketingPlan called');
          var input = safeGet('chat-input');
          if (input) {
            input.value = 'Generate a marketing plan for my product';
            bootstrapSendChatMessage();
          }
        }

        function bootstrapGenerateContentIdeas() {
          console.log('[Bootstrap] generateContentIdeas called');
          var input = safeGet('chat-input');
          if (input) {
            input.value = 'Give me content ideas for my social media';
            bootstrapSendChatMessage();
          }
        }

        function bootstrapUpdateUsers() {
          console.log('[Bootstrap] updateUsers called');
          var input = safeGet('chat-input');
          if (input) {
            var newValue = prompt('How many users do you currently have?');
            if (newValue) {
              input.value = 'Update users to ' + newValue;
              bootstrapSendChatMessage();
            }
          }
        }

        function bootstrapUpdateRevenue() {
          console.log('[Bootstrap] updateRevenue called');
          var input = safeGet('chat-input');
          if (input) {
            var newValue = prompt('What is your current revenue? (in dollars)');
            if (newValue) {
              input.value = 'Update revenue to $' + newValue;
              bootstrapSendChatMessage();
            }
          }
        }

        function bootstrapClearChatHistory() {
          var messagesContainer = safeGet('chat-messages');
          if (messagesContainer) {
            messagesContainer.innerHTML = '<div class="text-center text-gray-500 text-sm"><span class="text-3xl mb-2 block">🌟</span><p class="font-semibold">Start chatting with your ASTAR Agent</p><p class="text-xs mt-1">Ask about your goals, metrics, or growth strategies</p></div>';
          }
        }

        function bootstrapSwitchTab(tab) {
          console.log('[Bootstrap] switchTab:', tab);
        }

        // Set global functions
        window.addMessageToChat = bootstrapAddMessageToChat;
        window.sendChatMessage = bootstrapSendChatMessage;
        window.handleChatKeydown = bootstrapHandleChatKeydown;
        window.logout = bootstrapLogout;
        window.toggleLeftSidebar = bootstrapToggleLeftSidebar;
        window.toggleChatSidebar = bootstrapToggleChatSidebar;
        window.startGoalCreation = bootstrapStartGoalCreation;
        window.analyzeGoals = bootstrapAnalyzeGoals;
        window.generateMarketingPlan = bootstrapGenerateMarketingPlan;
        window.generateContentIdeas = bootstrapGenerateContentIdeas;
        window.updateUsers = bootstrapUpdateUsers;
        window.updateRevenue = bootstrapUpdateRevenue;
        window.clearChatHistory = bootstrapClearChatHistory;
        window.switchTab = bootstrapSwitchTab;
        
        console.log('[Chat Bootstrap] All functions assigned:', {
          sendChatMessage: typeof window.sendChatMessage,
          handleChatKeydown: typeof window.handleChatKeydown,
          logout: typeof window.logout,
          startGoalCreation: typeof window.startGoalCreation,
          analyzeGoals: typeof window.analyzeGoals,
          generateMarketingPlan: typeof window.generateMarketingPlan,
          generateContentIdeas: typeof window.generateContentIdeas
        });
      })();
    <\/script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#8B5CF6',
              secondary: '#A78BFA',
            }
          }
        }
      }
    <\/script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }

      .text-gradient {
        background: linear-gradient(135deg, #FF6154 0%, #FB651E 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Chat Animation */
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .chat-message {
        animation: slideIn 0.3s ease-out;
      }

      /* Left Sidebar Styles */
      .nav-item {
        transition: all 0.2s ease;
      }

      .nav-item:hover {
        background-color: rgba(139, 92, 246, 0.1);
        transform: translateX(4px);
      }

      .nav-item.active {
        background-color: rgba(139, 92, 246, 0.15);
        border-left: 4px solid #8B5CF6;
        font-weight: 700;
      }

      /* Navigation link styles */
      .nav-link {
        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
      }
      
      .nav-link:hover {
        background: rgba(255,255,255,0.15);
        transform: translateY(-1px);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .left-sidebar {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
          display: flex !important; /* Always render, just hide with transform */
        }

        .left-sidebar.open {
          transform: translateX(0);
        }
        
        /* Ensure content doesn't overflow on mobile */
        .main-content {
          width: 100%;
          margin-left: 0;
        }
        
        /* Chat sidebar as overlay on mobile */
        #chat-sidebar {
          position: fixed !important;
          right: 0;
          top: 48px;
          bottom: 0;
          z-index: 60;
          width: 100% !important;
          max-width: 400px;
          box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Floating button positioning for mobile */
        #chat-floating-btn {
          bottom: 80px !important;
          right: 16px !important;
          z-index: 45 !important;
        }
        
        #mobile-menu-btn {
          bottom: 16px !important;
          right: 16px !important;
          z-index: 45 !important;
        }
        
        #chat-overlay {
          z-index: 55 !important;
        }
      }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Top Navigation Bar -->
    <nav class="fixed top-0 w-full z-50 bg-gradient-to-b from-black to-gray-900 backdrop-blur-md border-b border-gray-700 shadow-xl">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-2xl font-bold text-white tracking-tight">ASTAR<span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">*</span></span>
                    <span class="text-gray-300 text-xs mt-0.5">Connecting the brightest minds in the world</span>
                </div>
                
                <div class="flex items-center space-x-4 md:space-x-6">
                    <a href="/" class="nav-link text-gray-300 hover:text-white flex items-center space-x-2 transition-all">
                        <span class="text-lg">🏠</span>
                        <span class="hidden md:inline font-medium">Home</span>
                    </a>
                    <a href="/dashboard" class="nav-link bg-gradient-to-r from-purple-600/20 to-pink-600/20 text-white flex items-center space-x-2 border border-purple-500/30">
                        <span class="text-lg">🎯</span>
                        <span class="hidden md:inline font-medium">Hub</span>
                    </a>
                    <a href="/competitions" class="nav-link text-gray-300 hover:text-white flex items-center space-x-2 transition-all">
                        <span class="text-lg">🏅</span>
                        <span class="hidden md:inline font-medium">Competitions</span>
                    </a>
                    <a href="/events" class="nav-link text-gray-300 hover:text-white flex items-center space-x-2 transition-all">
                        <span class="text-lg">📅</span>
                        <span class="hidden md:inline font-medium">Events</span>
                    </a>
                    <a href="/leaderboard" class="nav-link text-gray-300 hover:text-white flex items-center space-x-2 transition-all">
                        <span class="text-lg">🏆</span>
                        <span class="hidden md:inline font-medium">Leaderboard</span>
                    </a>
                    ${n==="founder"?`
                    <a href="/team" class="nav-link text-gray-300 hover:text-white flex items-center space-x-2 transition-all">
                        <span class="text-lg">👥</span>
                        <span class="hidden md:inline font-medium">Team</span>
                    </a>
                    `:""}
                    <a href="/dashboard?tab=directory" class="nav-link text-gray-300 hover:text-white flex items-center space-x-2 transition-all">
                        <span class="text-lg">🔥</span>
                        <span class="hidden md:inline font-medium">Trending</span>
                    </a>
                    <button onclick="logout()" class="bg-white hover:bg-gray-100 text-gray-900 px-5 py-2 rounded-full font-semibold transition-all shadow-lg hover:shadow-xl text-sm">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Layout Container -->
    <div class="flex h-screen overflow-hidden pt-24">
        
        <!-- Left Sidebar - Navigation Menu (Hidden) -->
        <aside id="left-sidebar" class="left-sidebar w-64 bg-gray-900 border-r border-gray-800 flex-shrink-0 hidden flex-col fixed md:static inset-y-0 left-0 z-40" style="display: none;">
            <!-- Logo/Brand -->
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-purple-400 rounded-xl flex items-center justify-center">
                        <i class="fas fa-rocket text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-black text-white">ASTAR<span class="text-purple-400">*</span> Hub</h2>
                    </div>
                </div>
            </div>

            <!-- User Profile Section -->
            <div class="p-4 border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden bg-gradient-to-br from-purple-600 to-purple-400 flex items-center justify-center text-white font-bold">
                        ${s?`<img src="${s}" alt="${a}" class="w-full h-full object-cover" />`:a.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-white truncate">${a}</p>
                        <button class="text-xs text-gray-400 hover:text-purple-400 flex items-center mt-0.5">
                            <span>Profile</span>
                            <i class="fas fa-chevron-down ml-1 text-[10px]"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Links -->
            <nav class="flex-1 p-4 overflow-y-auto">
                ${n==="founder"?`
                <a href="#" onclick="switchTab('home'); return false;" class="nav-item sidebar-nav-home flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-home mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Home (HQ)</span>
                </a>

                <a href="#" onclick="switchTab('home'); return false;" class="nav-item flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-bell mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Notifications</span>
                    <span class="ml-auto bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">3</span>
                </a>

                <a href="#" onclick="switchTab('traction'); return false;" class="nav-item sidebar-nav-traction flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-chart-line mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Traction</span>
                </a>
                `:""}

                <a href="#" onclick="switchTab('inbox'); return false;" class="nav-item sidebar-nav-inbox flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-inbox mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Inbox</span>
                </a>

                <a href="#" onclick="switchTab('aicmo'); return false;" class="nav-item sidebar-nav-aicmo flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-magic mr-3 text-lg w-5"></i>
                    <span class="font-semibold">AI CMO</span>
                </a>

                <a href="/leaderboard" class="nav-item ${r==="leaderboard"?"active":""} flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-trophy mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Leaderboard</span>
                </a>

                <a href="/competitions" class="nav-item ${r==="competitions"?"active":""} flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-medal mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Competitions</span>
                </a>

                <a href="/events" class="nav-item ${r==="events"?"active":""} flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-calendar-alt mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Events</span>
                </a>

                ${n==="founder"?`
                <a href="/team" class="nav-item ${r==="team"?"active":""} flex items-center px-4 py-3 text-gray-300 hover:text-white rounded-lg mb-2">
                    <i class="fas fa-users mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Team</span>
                </a>
                `:""}

                ${n==="admin"?`
                <a href="/admin" class="nav-item flex items-center px-4 py-3 text-yellow-400 hover:text-yellow-300 rounded-lg mb-2 border border-yellow-400">
                    <i class="fas fa-shield-alt mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Admin</span>
                </a>
                `:""}

                <a href="#" onclick="switchTab('directory'); return false;" class="nav-item sidebar-nav-directory flex items-center px-4 py-3 text-gray-600 hover:text-primary rounded-lg mb-2">
                    <i class="fas fa-store mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Directory</span>
                </a>

                <a href="#" onclick="switchTab('directory'); return false;" class="nav-item flex items-center px-4 py-3 text-gray-600 hover:text-primary rounded-lg mb-2">
                    <i class="fas fa-fire mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Trending Products</span>
                </a>

                ${n==="founder"?`
                <a href="#" onclick="switchTab('home'); return false;" class="nav-item flex items-center px-4 py-3 text-gray-600 hover:text-primary rounded-lg mb-2">
                    <i class="fas fa-calendar-alt mr-3 text-lg w-5"></i>
                    <span class="font-semibold">Planner</span>
                </a>
                `:""}
            </nav>

            <!-- Bottom Actions -->
            <div class="p-4 border-t border-gray-200">
                <button onclick="logout()" class="w-full flex items-center justify-center px-4 py-3 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span class="font-semibold">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Mobile Menu Button -->
        <button id="mobile-menu-btn" class="md:hidden fixed bottom-4 right-4 z-50 bg-gradient-to-r from-purple-600 to-indigo-600 p-4 rounded-full shadow-2xl hover:shadow-purple-500/50 transition-all">
            <i class="fas fa-bars text-white text-xl"></i>
        </button>

        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-30 hidden" onclick="window.toggleLeftSidebar()"></div>
        
        <!-- Chat Overlay for mobile -->
        <div id="chat-overlay" class="md:hidden fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="
            var sidebar = document.getElementById('chat-sidebar');
            var btn = document.getElementById('chat-floating-btn');
            var overlay = document.getElementById('chat-overlay');
            if (sidebar) {
                sidebar.style.width = '0px';
                sidebar.style.display = 'none';
                btn.style.display = 'flex';
                overlay.classList.add('hidden');
            }
        "></div>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto">
            ${t}
        </main>

        <!-- Floating Chat Button (visible when chat is hidden) -->
        ${n!=="guest"?`
        <button 
            id="chat-floating-btn" 
            onclick="
                console.log('[BTN] Click event fired'); 
                var sidebar = document.getElementById('chat-sidebar');
                var btn = document.getElementById('chat-floating-btn');
                var overlay = document.getElementById('chat-overlay');
                var isMobile = window.innerWidth <= 768;
                console.log('[BTN] Found elements:', {sidebar: !!sidebar, btn: !!btn, overlay: !!overlay});
                if (sidebar) {
                    sidebar.style.width = isMobile ? '100%' : '400px';
                    sidebar.style.maxWidth = '400px';
                    sidebar.style.display = 'flex';
                    btn.style.display = 'none';
                    if (isMobile && overlay) overlay.classList.remove('hidden');
                    console.log('[BTN] Chat opened');
                }
            " 
            class="fixed right-4 bottom-20 md:bottom-4 z-[999] w-14 h-14 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full shadow-xl hover:shadow-2xl hover:scale-110 transition-all duration-300 flex items-center justify-center border-2 border-white/30" 
            style="pointer-events: auto; touch-action: manipulation; cursor: pointer;">
            <div class="flex flex-col items-center justify-center">
                <span class="text-xl">*</span>
            </div>
        </button>
        `:""}

        <!-- Right Sidebar - ASTAR Agent Chat -->
        ${n!=="guest"?`
        <aside id="chat-sidebar" class="bg-white border-l border-gray-200 transition-all duration-300 ease-in-out flex flex-col overflow-hidden" style="width: 0px; display: none;">
            <!-- Chat Header -->
            <div id="chat-header" class="p-4 border-b border-gray-200 bg-gradient-to-r from-primary to-secondary">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-2xl">*</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-white">ASTAR Agent</h3>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="
                            var sidebar = document.getElementById('chat-sidebar');
                            var btn = document.getElementById('chat-floating-btn');
                            var overlay = document.getElementById('chat-overlay');
                            if (sidebar && btn) {
                                sidebar.style.width = '0px';
                                sidebar.style.display = 'none';
                                btn.style.display = 'flex';
                                if (overlay) overlay.classList.add('hidden');
                                console.log('[CHAT] Closed from header button');
                            }
                        " id="chat-toggle-btn" title="Close chat" class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div id="quick-actions" class="p-4 border-b border-gray-100 bg-gray-50">
                <p class="text-xs font-bold text-gray-600 mb-3 uppercase">Quick Actions</p>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="window.startGoalCreation()" id="btn-create-goal" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white hover:shadow-lg px-3 py-2 rounded-lg text-xs font-semibold transition flex items-center justify-center">
                        <i class="fas fa-plus-circle mr-1.5"></i>
                        Create Goal
                    </button>
                    <button onclick="window.updateUsers()" id="btn-update-users" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:shadow-lg px-3 py-2 rounded-lg text-xs font-semibold transition flex items-center justify-center">
                        <i class="fas fa-users mr-1.5"></i>
                        Update Users
                    </button>
                    <button onclick="window.updateRevenue()" id="btn-update-revenue" class="bg-gradient-to-r from-green-500 to-green-600 text-white hover:shadow-lg px-3 py-2 rounded-lg text-xs font-semibold transition flex items-center justify-center">
                        <i class="fas fa-dollar-sign mr-1.5"></i>
                        Update Revenue
                    </button>
                    <button onclick="window.analyzeGoals()" id="btn-analyze-goals" class="bg-white border border-gray-200 hover:border-primary hover:shadow-md px-3 py-2 rounded-lg text-xs font-semibold text-gray-700 hover:text-primary transition flex items-center justify-center">
                        <i class="fas fa-chart-bar mr-1.5"></i>
                        Analyze Goals
                    </button>
                    <button onclick="window.generateMarketingPlan()" id="btn-marketing-plan" class="bg-white border border-gray-200 hover:border-primary hover:shadow-md px-3 py-2 rounded-lg text-xs font-semibold text-gray-700 hover:text-primary transition flex items-center justify-center">
                        <i class="fas fa-lightbulb mr-1.5"></i>
                        Marketing Plan
                    </button>
                    <button onclick="window.generateContentIdeas()" id="btn-content-ideas" class="bg-white border border-gray-200 hover:border-primary hover:shadow-md px-3 py-2 rounded-lg text-xs font-semibold text-gray-700 hover:text-primary transition flex items-center justify-center">
                        <i class="fas fa-pencil-alt mr-1.5"></i>
                        Content Ideas
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="text-center text-gray-500 text-sm">
                    <span class="text-3xl mb-2 block">🌟</span>
                    <p class="font-semibold">Start chatting with your ASTAR Agent</p>
                    <p class="text-xs mt-1">Ask about your goals, metrics, or growth strategies</p>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="chat-loading" class="hidden px-4 py-2">
                <div class="flex items-center space-x-2 text-gray-500">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0s"></div>
                        <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                    </div>
                    <span class="text-sm font-medium">Agent thinking...</span>
                </div>
            </div>

            <!-- Chat Input -->
            <div id="chat-input-container" class="p-4 border-t border-gray-200 bg-white">
                <div class="flex items-end space-x-2">
                    <textarea 
                        id="chat-input" 
                        placeholder="Ask about marketing strategies..." 
                        rows="2"
                        class="flex-1 resize-none border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm"
                        onkeydown="window.handleChatKeydown(event)"
                    ></textarea>
                    <button 
                        onclick="window.sendChatMessage()" 
                        class="bg-gradient-to-r from-primary to-secondary text-white p-3 rounded-lg hover:shadow-lg transition flex-shrink-0"
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                    <span>Press Enter to send, Shift+Enter for new line</span>
                    <button onclick="window.clearChatHistory()" class="text-red-500 hover:text-red-700 font-semibold">
                        <i class="fas fa-trash-alt mr-1"></i>Clear
                    </button>
                </div>
            </div>
        </aside>
        `:""}
    </div>

    <script>
        console.log('[SCRIPT START] Loading layout script');
        
        // ============================================
        // DEFINE ALL PLACEHOLDER FUNCTIONS FIRST
        // These prevent "not defined" errors and will be replaced with actual implementations below
        // ============================================
        window.sendChatMessage = window.sendChatMessage || function() { console.log('[PLACEHOLDER] sendChatMessage'); };
        window.handleChatKeydown = window.handleChatKeydown || function() { console.log('[PLACEHOLDER] handleChatKeydown'); };
        window.addMessageToChat = window.addMessageToChat || function() { console.log('[PLACEHOLDER] addMessageToChat'); };
        window.logout = window.logout || function() { console.log('[PLACEHOLDER] logout'); document.cookie = 'authToken=; Max-Age=0; path=/;'; window.location.href = '/'; };
        window.toggleLeftSidebar = window.toggleLeftSidebar || function() { console.log('[PLACEHOLDER] toggleLeftSidebar'); };
        // toggleChatSidebar is already defined in the bootstrap in <head>, don't redefine it here
        console.log('[SCRIPT] toggleChatSidebar already defined:', typeof window.toggleChatSidebar);
        window.startGoalCreation = window.startGoalCreation || function() { console.log('[PLACEHOLDER] startGoalCreation'); };
        window.analyzeGoals = window.analyzeGoals || function() { console.log('[PLACEHOLDER] analyzeGoals'); };
        window.generateMarketingPlan = window.generateMarketingPlan || function() { console.log('[PLACEHOLDER] generateMarketingPlan'); };
        window.generateContentIdeas = window.generateContentIdeas || function() { console.log('[PLACEHOLDER] generateContentIdeas'); };
        window.updateUsers = window.updateUsers || function() { console.log('[PLACEHOLDER] updateUsers'); };
        window.updateRevenue = window.updateRevenue || function() { console.log('[PLACEHOLDER] updateRevenue'); };
        window.clearChatHistory = window.clearChatHistory || function() { console.log('[PLACEHOLDER] clearChatHistory'); };
        window.switchTab = window.switchTab || function(tab) { console.log('[PLACEHOLDER] switchTab:', tab); };
        
        console.log('[INIT] All placeholder functions defined');
        
        // Configure axios to send cookies
        axios.defaults.withCredentials = true;
        
        // Helper to get auth token from cookie or localStorage
        function getAuthToken() {
            const cookieMatch = document.cookie.match(/authToken=([^;]+)/);
            return cookieMatch ? cookieMatch[1] : localStorage.getItem('authToken');
        }
        
        // Add auth token to all axios requests
        axios.interceptors.request.use(config => {
            const token = getAuthToken();
            if (token) {
                config.headers.Authorization = 'Bearer ' + token;
            }
            return config;
        }, error => Promise.reject(error));

        // Update sidebar active state when tab changes
        function updateSidebarActiveState(tab) {
            // Remove active from all sidebar nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // Add active to the corresponding sidebar item
            const sidebarItem = document.querySelector('.sidebar-nav-' + tab);
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }
        }
        
        // Override switchTab to also update sidebar
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tab) {
            if (typeof originalSwitchTab === 'function') {
                originalSwitchTab(tab);
            }
            updateSidebarActiveState(tab);
        };

        // Chat Sidebar Toggle
        let chatSidebarOpen = false; // Start with chat CLOSED by default
        let chatContentVisible = true;
        
        // Initialize chat state on page load
        function initializeChatState() {
            const sidebar = document.getElementById('chat-sidebar');
            const floatingBtn = document.getElementById('chat-floating-btn');
            
            if (sidebar && floatingBtn) {
                // Start with chat closed
                sidebar.style.width = '0px';
                sidebar.style.display = 'none';
                floatingBtn.style.display = 'flex';
                console.log('[INIT] Chat initialized as closed, floating button visible');
            }
        }
        
        // Run initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeChatState);
        } else {
            initializeChatState();
        }

        function toggleChatVisibility() {
            const quickActions = document.getElementById('quick-actions');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input-container');
            const chatLoading = document.getElementById('chat-loading');
            const visibilityBtn = document.getElementById('chat-visibility-btn');
            const icon = visibilityBtn?.querySelector('i');
            
            chatContentVisible = !chatContentVisible;
            
            if (chatContentVisible) {
                quickActions?.classList.remove('hidden');
                chatMessages?.classList.remove('hidden');
                chatInput?.classList.remove('hidden');
                chatLoading?.classList.remove('hidden');
                icon?.classList.replace('fa-eye-slash', 'fa-eye');
                visibilityBtn?.setAttribute('title', 'Hide chat');
            } else {
                quickActions?.classList.add('hidden');
                chatMessages?.classList.add('hidden');
                chatInput?.classList.add('hidden');
                chatLoading?.classList.add('hidden');
                icon?.classList.replace('fa-eye', 'fa-eye-slash');
                visibilityBtn?.setAttribute('title', 'Show chat');
            }
        }

        // toggleChatSidebar is already defined in bootstrap (in <head>), no need to redefine
        // Just keep toggleChatVisibility available
        window.toggleChatVisibility = toggleChatVisibility;

        // Left Sidebar Toggle (Mobile)
        function toggleLeftSidebar() {
            const sidebar = document.getElementById('left-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        }

        // Mobile menu button
        document.getElementById('mobile-menu-btn')?.addEventListener('click', toggleLeftSidebar);

        // ========== GOAL CREATION FLOW - DEFINED EARLY ==========
        // Must be defined before sendChatMessage so it's available
        // Try to restore from localStorage in case of page reload
        let savedFlow = null;
        try {
            savedFlow = JSON.parse(localStorage.getItem('goalCreationFlow') || 'null');
        } catch(e) { savedFlow = null; }
        
        let goalCreationFlow = savedFlow || {
            active: false,
            step: 0,
            data: {},
            editingGoalId: null
        };
        
        // Function to save flow state
        function saveFlowState() {
            try {
                localStorage.setItem('goalCreationFlow', JSON.stringify(goalCreationFlow));
            } catch(e) { console.error('[FLOW] Error saving state:', e); }
        }
        
        // Function to clear flow state
        function clearFlowState() {
            goalCreationFlow.active = false;
            goalCreationFlow.step = 0;
            goalCreationFlow.data = {};
            goalCreationFlow.editingGoalId = null;
            try {
                localStorage.removeItem('goalCreationFlow');
            } catch(e) {}
        }
        
        // Make it global so all functions can access it
        window.goalCreationFlow = goalCreationFlow;
        window.saveFlowState = saveFlowState;
        window.clearFlowState = clearFlowState;
        
        // If flow was active on reload, resume it after DOM is ready
        if (goalCreationFlow.active) {
            console.log('[FLOW] Restored active flow from localStorage, step:', goalCreationFlow.step);
            // Wait for goalQuestions to be defined and DOM to be ready
            setTimeout(() => {
                if (typeof goalQuestions !== 'undefined' && goalCreationFlow.active) {
                    const currentQuestion = goalQuestions[goalCreationFlow.step];
                    if (currentQuestion) {
                        addMessageToChat('assistant', 'Continuing with goal creation... --- ' + currentQuestion.question);
                        if (currentQuestion.options && typeof showQuickReplyOptions === 'function') {
                            showQuickReplyOptions(currentQuestion.options);
                        }
                    }
                }
            }, 1000);
        }
        // ========== END GOAL CREATION FLOW DEFINITION ==========

        // Chat Functions
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            if (!input) return; // No chat for guests
            
            // Check if this is an ASTAR trigger message
            var messageToSend = input.value.trim();
            if (window.astarTriggerMessage) {
                messageToSend = window.astarTriggerMessage;
                window.astarTriggerMessage = null; // Clear it
            }
            
            const message = messageToSend;
            
            if (!message) return;
            
            // ========== GOAL KEYWORD DETECTION - FIRST PRIORITY ==========
            const goalKeywords = [
                'crear goal', 'create goal', 'nuevo goal', 'new goal', 'anadir goal', 'add goal',
                'crear objetivo', 'nuevo objetivo', 'anadir objetivo', 'agregar objetivo',
                'quiero crear', 'necesito crear', 'me gustaria crear',
                'registrar goal', 'definir objetivo', 'establecer goal', 'poner un objetivo',
                'agregar goal', 'hacer un goal', 'hacer un objetivo', 'crea un goal', 'crea un objetivo'
            ];
            
            const messageClean = message.toLowerCase().trim();
            const hasGoalKeyword = goalKeywords.some(keyword => messageClean.includes(keyword));
            
            console.log('[CHAT] Message:', message);
            console.log('[CHAT] Has goal keyword:', hasGoalKeyword);
            console.log('[CHAT] Goal flow active:', typeof goalCreationFlow !== 'undefined' ? goalCreationFlow.active : 'undefined');
            
            // If goal keywords detected AND flow not active, start flow directly (no backend call!)
            if (hasGoalKeyword && typeof goalCreationFlow !== 'undefined' && !goalCreationFlow.active) {
                console.log('[CHAT] [OK] Goal keyword detected! Starting flow directly...');
                addMessageToChat('user', message);
                input.value = '';
                startGoalCreation();
                return;
            }
            // ========== END GOAL KEYWORD DETECTION ==========

            // Add user message to chat
            addMessageToChat('user', message);
            input.value = '';
            
            // Show loading
            const loading = document.getElementById('chat-loading');
            if (loading) loading.classList.remove('hidden');

            try {
                // Include emailContext and flowState if in a flow
                const requestBody: any = { message: message };
                
                if (window.emailFlowState) {
                  requestBody.emailContext = window.emailFlowState.emailContext;
                  requestBody.flowState = window.emailFlowState.flowState;
                  console.log('[CHAT] Continuing email flow:', window.emailFlowState);
                }
                
                const response = await axios.post('/api/chat-agent/message', requestBody, {
                    withCredentials: true
                });

                // Hide loading
                if (loading) loading.classList.add('hidden');
                
                // Update flow state if present in response
                if (response.data.flowState && response.data.emailContext) {
                  window.emailFlowState = {
                    flowState: response.data.flowState,
                    emailContext: response.data.emailContext
                  };
                  console.log('[CHAT] Updated flow state:', window.emailFlowState);
                } else if (response.data.flowState === 'complete') {
                  window.emailFlowState = null;
                  console.log('[CHAT] Flow completed, cleared state');
                }

                // Add assistant response
                if (response.data) {
                    console.log('[CHAT] ========== AI RESPONSE RECEIVED ==========');
                    console.log('[CHAT] Response data:', JSON.stringify(response.data));
                    
                    // Check for goal flow trigger FIRST (flag-based detection)
                    if (response.data.triggerGoalFlow === true) {
                        console.log('[CHAT] [OK] GOAL FLOW TRIGGER detected! Starting goal creation...');
                        // NO mostrar nada adicional, el mensaje del usuario ya se mostró antes
                        // Iniciar el flujo directamente
                        startGoalCreation();
                        return;
                    }
                    
                    const aiMessage = response.data.message;
                    console.log('[CHAT] AI Message:', aiMessage);
                    
                    // Fallback: Also check for text-based TRIGGER (legacy)
                    if (aiMessage && aiMessage.includes('TRIGGER:START_GOAL_FLOW')) {
                        console.log('[CHAT] [OK] Legacy TRIGGER detected! Starting goal creation flow...');
                        startGoalCreation();
                        return;
                    } 
                    // Check if AI wants to trigger goal edit flow
                    else if (aiMessage.includes('TRIGGER:EDIT_GOAL_FLOW|')) {
                        const goalId = aiMessage.split('TRIGGER:EDIT_GOAL_FLOW|')[1].split('
')[0].trim();
                        console.log('[CHAT] [OK] EDIT TRIGGER detected! Starting edit flow for goal:', goalId);
                        startGoalCreation(parseInt(goalId));
                        // NO mostrar el mensaje TRIGGER en el chat
                        return;
                    } 
                    else {
                        console.log('[CHAT] Normal message, adding to chat');
                        addMessageToChat('assistant', aiMessage);
                    }
                } else {
                    addMessageToChat('assistant', 'I received your message but could not generate a response.');
                }
            } catch (error) {
                if (loading) loading.classList.add('hidden');
                console.error('Chat error:', error);
                
                // More detailed error message
                let errorMessage = 'Sorry, there was an error. Please try again.';
                if (error.response) {
                    if (error.response.status === 401) {
                        errorMessage = 'Your session has expired. Please reload the page.';
                    } else if (error.response.data && error.response.data.error) {
                        errorMessage = 'Error: ' + error.response.data.error;
                    }
                }
                addMessageToChat('assistant', errorMessage);
            }
        }

        function addMessageToChat(role, content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
            
            const bubbleClass = role === 'user' 
                ? 'bg-gradient-to-r from-primary to-secondary text-white' 
                : 'bg-gray-100 text-gray-800';
            
            messageDiv.innerHTML = 
                '<div class="' + bubbleClass + ' rounded-lg px-4 py-2 max-w-[85%] shadow-sm">' +
                    '<p class="text-sm whitespace-pre-wrap">' + content + '</p>' +
                '</div>';
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        // Expose chat functions globally (initial assignment - will be enhanced later)
        // NOTE: This is intentionally set here so functions work immediately,
        // but the enhanced version with goal detection is set later
        window.sendChatMessage = sendChatMessage;
        window.handleChatKeydown = handleChatKeydown;
        window.addMessageToChat = addMessageToChat;

        async function analyzeGoals() {
            addMessageToChat('user', 'Analyze my goals and give me marketing recommendations');
            document.getElementById('chat-loading').classList.remove('hidden');
            
            try {
                const response = await axios.post('/api/chat-agent/analyze-goals', {}, {
                    withCredentials: true
                });
                
                document.getElementById('chat-loading').classList.add('hidden');
                addMessageToChat('assistant', response.data.analysis || 'Analisis completado.');
            } catch (error) {
                document.getElementById('chat-loading').classList.add('hidden');
                console.error('Error analyzing goals:', error);
                addMessageToChat('assistant', 'Error analyzing goals. Please try again.');
            }
        }

        async function generateMarketingPlan() {
            const websiteUrl = prompt('What is your website? (to analyze your brand)', '');
            if (!websiteUrl) return;
            
            const userId = localStorage.getItem('userId') || '1';
            
            addMessageToChat('user', 'Generate brand analysis, marketing plan and images for ' + websiteUrl);
            document.getElementById('chat-loading').classList.remove('hidden');
            
            try {
                // Llamar al endpoint que genera imágenes automáticamente
                const response = await axios.post('/api/agents/brand/generate-images', {
                    website_url: websiteUrl,
                    user_id: parseInt(userId),
                    cloudflare_api_url: window.location.origin,
                    image_types: ['banner', 'post', 'story']
                });
                
                document.getElementById('chat-loading').classList.add('hidden');
                
                if (response.data.success) {
                    const formatted = formatMarkdownToHTML(response.data.response || 'Analysis completed');
                    addMessageToChat('assistant', formatted);
                    
                    if (response.data.images_saved > 0) {
                        const successMsg = '<div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">' +
                            '<i class="fas fa-check-circle text-green-600 mr-2"></i>' +
                            '<strong>' + response.data.images_saved + ' images generated!</strong><br>' +
                            '<a href="#" onclick="switchTab('aicmo'); return false;" class="text-primary hover:underline mt-2 inline-block">' +
                            'View images in AI CMO →</a></div>';
                        addMessageToChat('assistant', successMsg);
                    }
                } else {
                    addMessageToChat('assistant', '<div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-800">' +
                        '<i class="fas fa-exclamation-triangle mr-2"></i>' + 
                        (response.data.error || 'Unknown error') + '</div>');
                }
            } catch (error) {
                document.getElementById('chat-loading').classList.add('hidden');
                console.error('Error generating plan:', error);
                const errorMsg = error.response?.data?.detail || error.message || 'Unknown error';
                addMessageToChat('assistant', '<div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-800">' +
                    '<i class="fas fa-times-circle mr-2"></i>Error generating: ' + errorMsg + '</div>');
            }
        }
        
        function formatMarkdownToHTML(text) {
            if (!text) return '';
            var backtick = String.fromCharCode(96);
            var backtickRegex = new RegExp(backtick + '([^' + backtick + ']+)' + backtick, 'g');
            
            let formatted = text
                .replace(/^### (.+)$/gm, '<h3 class="text-xl font-bold mt-6 mb-3 text-gray-800">$1</h3>')
                .replace(/^#### (.+)$/gm, '<h4 class="text-lg font-semibold mt-4 mb-2 text-gray-700">$1</h4>')
                .replace(/^## (.+)$/gm, '<h2 class="text-2xl font-bold mt-8 mb-4 text-gray-900">$1</h2>')
                .replace(/^# (.+)$/gm, '<h1 class="text-3xl font-bold mt-8 mb-6 text-gray-900">$1</h1>')
                .replace(/[*][*](.+?)[*][*]/g, '<strong class="font-semibold text-gray-900">$1</strong>')
                .replace(/[*](.+?)[*]/g, '<em>$1</em>')
                .replace(/^- (.+)$/gm, '<li class="ml-6 mb-2 list-disc">$1</li>')
                .replace(backtickRegex, '<code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono text-purple-600">$1</code>');
            
            return '<div class="prose max-w-none">' + formatted + '</div>';
        }

        async function generateContentIdeas() {
            const websiteUrl = prompt('What is your website? (to understand your brand)', '');
            if (!websiteUrl) return;
            
            const platform = prompt('For which platform? (Instagram, LinkedIn, Twitter, TikTok, Blog)', 'Instagram');
            if (!platform) return;
            
            addMessageToChat('user', 'Generate content ideas for ' + platform);
            document.getElementById('chat-loading').classList.remove('hidden');
            
            try {
                const response = await axios.post('/api/chat-agent/message', {
                    message: 'Based on the brand from ' + websiteUrl + ', generate 10 creative content ideas for ' + platform + '. Include catchy titles, suggested formats and why each idea would work.',
                    useBrandAgent: true,
                    websiteUrl: websiteUrl
                }, {
                    withCredentials: true
                });
                
                document.getElementById('chat-loading').classList.add('hidden');
                addMessageToChat('assistant', response.data.message || 'Ideas generated.');
            } catch (error) {
                document.getElementById('chat-loading').classList.add('hidden');
                console.error('Error generating content ideas:', error);
                addMessageToChat('assistant', 'Error generating ideas. Please try again.');
            }
        }

        async function updateUsers() {
            console.log('[METRICS] updateUsers called');
            const newValue = prompt('How many users do you currently have?');
            if (!newValue || isNaN(newValue)) {
                console.log('[METRICS] Invalid or cancelled input');
                return;
            }
            
            addMessageToChat('user', 'Update users to ' + newValue);
            document.getElementById('chat-loading').classList.remove('hidden');
            
            try {
                console.log('[METRICS] Sending ADD_METRIC action for users:', newValue);
                const response = await axios.post('/api/chat-agent/message', {
                    message: 'ACTION:ADD_METRIC|users|' + newValue
                }, {
                    withCredentials: true
                });
                
                document.getElementById('chat-loading').classList.add('hidden');
                console.log('[METRICS] Response:', response.data);
                addMessageToChat('assistant', '[OK] Users metric updated: ' + newValue + ' users. This information will help improve recommendations.');
            } catch (error) {
                document.getElementById('chat-loading').classList.add('hidden');
                console.error('[METRICS] Error updating users:', error);
                addMessageToChat('assistant', 'Error updating users. Please try again.');
            }
        }

        async function updateRevenue() {
            console.log('[METRICS] updateRevenue called');
            const newValue = prompt('What is your current revenue? (just the number, no symbols)');
            if (!newValue || isNaN(newValue)) {
                console.log('[METRICS] Invalid or cancelled input');
                return;
            }
            
            addMessageToChat('user', 'Update revenue to $' + newValue);
            document.getElementById('chat-loading').classList.remove('hidden');
            
            try {
                console.log('[METRICS] Sending ADD_METRIC action for revenue:', newValue);
                const response = await axios.post('/api/chat-agent/message', {
                    message: 'ACTION:ADD_METRIC|revenue|' + newValue
                }, {
                    withCredentials: true
                });
                
                document.getElementById('chat-loading').classList.add('hidden');
                console.log('[METRICS] Response:', response.data);
                addMessageToChat('assistant', '[OK] Revenue metric updated: $' + newValue + '. This information will help track your growth.');
            } catch (error) {
                document.getElementById('chat-loading').classList.add('hidden');
                console.error('[METRICS] Error updating revenue:', error);
                addMessageToChat('assistant', 'Error updating revenue. Please try again.');
            }
        }

        // Goal Creation/Edit Flow - use the global one defined earlier
        // (goalCreationFlow is already defined at the top of the script)

        const goalQuestions = [
            {
                field: 'category', 
                question: 'What category does this goal belong to? (Build: Building features | Test: Testing hypotheses | Traction: Growth & metrics)', 
                options: ['Build', 'Test', 'Traction']
            },
            { 
                field: 'description', 
                question: 'What is the goal description? (Describe what you want to achieve)', 
                type: 'text' 
            },
            { 
                field: 'task', 
                question: 'What is the specific task to achieve this goal? (Concrete action to take)', 
                type: 'text',
                optional: true 
            },
            { 
                field: 'priority', 
                question: 'What priority does this goal have? (P0: Urgent and important | P1: Urgent or important | P2: Urgent but not important | P3: Neither urgent nor important)', 
                options: ['P0', 'P1', 'P2', 'P3'] 
            },
            { 
                field: 'cadence', 
                question: 'Is this a one-time or recurring goal? (One time: Completed once | Recurrent: Repeats periodically)', 
                options: ['One time', 'Recurrent'] 
            },
            { 
                field: 'assigned_to', 
                question: 'Who should be assigned to this task? Select a team member.', 
                type: 'team_member',
                optional: true 
            },
            { 
                field: 'goal_status', 
                question: 'What is the current status of this goal? (To start | WIP | On Hold | Delayed | Blocked | Done)', 
                options: ['To start', 'WIP', 'On Hold', 'Delayed', 'Blocked', 'Done'] 
            },
            { 
                field: 'week_of', 
                question: 'For which week is this goal? (Example: December 30, January 6, or leave blank)', 
                type: 'text', 
                optional: true 
            }
        ];

        function startGoalCreation(goalId = null) {
            console.log('[GOAL-FLOW] ========== START GOAL CREATION ==========');
            console.log('[GOAL-FLOW] Starting goal creation flow, goalId:', goalId);
            goalCreationFlow.active = true;
            goalCreationFlow.step = 0;
            goalCreationFlow.data = {};
            goalCreationFlow.editingGoalId = goalId;
            saveFlowState(); // Persist to localStorage
            console.log('[GOAL-FLOW] Flow initialized and saved:', JSON.stringify(goalCreationFlow));
            
            const actionText = goalId ? 'edit this goal' : 'create a new goal';
            const firstQuestion = goalQuestions[0];
            console.log('[GOAL-FLOW] First question:', firstQuestion.question);
            
            addMessageToChat('assistant', 'Perfect! I will help you ' + actionText + '. I will ask you ' + goalQuestions.length + ' questions. --- ' + firstQuestion.question);
            
            if (firstQuestion.options) {
                console.log('[GOAL-FLOW] Showing quick reply options:', firstQuestion.options);
                showQuickReplyOptions(firstQuestion.options);
            }
        }

        function showQuickReplyOptions(options) {
            const messagesContainer = document.getElementById('chat-messages');
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'quick-reply-options flex flex-wrap gap-2 mb-4';
            optionsDiv.id = 'quick-reply-buttons';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-sm font-medium transition';
                btn.textContent = option;
                btn.onclick = () => handleQuickReply(option);
                optionsDiv.appendChild(btn);
            });
            
            messagesContainer.appendChild(optionsDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeQuickReplyOptions() {
            const buttons = document.getElementById('quick-reply-buttons');
            if (buttons) buttons.remove();
        }

        async function handleQuickReply(value) {
            console.log('[GOAL-FLOW] ========== HANDLE QUICK REPLY ==========');
            console.log('[GOAL-FLOW] Quick reply value:', value);
            console.log('[GOAL-FLOW] Flow active:', goalCreationFlow.active);
            console.log('[GOAL-FLOW] Current step:', goalCreationFlow.step);
            
            if (!goalCreationFlow.active) {
                console.log('[GOAL-FLOW] Flow not active, returning');
                return;
            }
            
            removeQuickReplyOptions();
            addMessageToChat('user', value);
            
            const currentQuestion = goalQuestions[goalCreationFlow.step];
            console.log('[GOAL-FLOW] Current question field:', currentQuestion.field);
            
            // Handle team_member type - save user_id instead of name
            if (currentQuestion.type === 'team_member') {
                const teamMembers = window.currentTeamMembers || [];
                const selectedMember = teamMembers.find(m => 
                    (m.name || m.email) === value
                );
                
                if (selectedMember) {
                    goalCreationFlow.data[currentQuestion.field] = selectedMember.user_id;
                    console.log('[GOAL-FLOW] Saved team member user_id:', selectedMember.user_id);
                } else if (value === 'Skip (No assignment)') {
                    goalCreationFlow.data[currentQuestion.field] = null;
                    console.log('[GOAL-FLOW] No team member assigned');
                } else {
                    goalCreationFlow.data[currentQuestion.field] = value;
                }
            } else {
                goalCreationFlow.data[currentQuestion.field] = value;
            }
            
            console.log('[GOAL-FLOW] Updated data:', JSON.stringify(goalCreationFlow.data));
            
            goalCreationFlow.step++;
            saveFlowState(); // Persist after each step
            console.log('[GOAL-FLOW] Moving to step:', goalCreationFlow.step);
            
            if (goalCreationFlow.step < goalQuestions.length) {
                const nextQuestion = goalQuestions[goalCreationFlow.step];
                console.log('[GOAL-FLOW] Next question:', nextQuestion.question);
                addMessageToChat('assistant', nextQuestion.question);
                
                // Check if this question needs team members options
                if (nextQuestion.type === 'team_member') {
                    console.log('[GOAL-FLOW] Loading team members for assignment...');
                    await loadTeamMembersForGoalFlow();
                } else if (nextQuestion.options) {
                    console.log('[GOAL-FLOW] Showing options:', nextQuestion.options);
                    showQuickReplyOptions(nextQuestion.options);
                }
            } else {
                console.log('[GOAL-FLOW] All questions answered, completing goal creation');
                await completeGoalCreation();
            }
        }

        // Function to load and show team members as options
        async function loadTeamMembersForGoalFlow() {
            try {
                const response = await fetch('/api/dashboard/team-members', {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error('[TEAM-MEMBERS] Failed to load team members');
                    showQuickReplyOptions(['Skip (No assignment)']);
                    return;
                }
                
                const data = await response.json();
                const teamMembers = data.teamMembers || [];
                
                if (teamMembers.length === 0) {
                    console.log('[TEAM-MEMBERS] No team members found');
                    showQuickReplyOptions(['Skip (No assignment)']);
                    return;
                }
                
                // Create options with member names and IDs
                const options = teamMembers.map(member => member.name || member.email);
                options.push('Skip (No assignment)');
                
                // Store team members for later use
                window.currentTeamMembers = teamMembers;
                
                console.log('[TEAM-MEMBERS] Showing', teamMembers.length, 'team members');
                showQuickReplyOptions(options);
            } catch (error) {
                console.error('[TEAM-MEMBERS] Error loading team members:', error);
                showQuickReplyOptions(['Skip (No assignment)']);
            }
        }

        // Create a function to override SendChatMessage
        // We define it separately to keep the logic clear
        function setupEnhancedSendChatMessage() {
            // Store the original function if it's the first time
            if (!window.originalSendChatMessage) {
                window.originalSendChatMessage = window.sendChatMessage;
            }
            
            // Override with enhanced version
            window.sendChatMessage = async function() {
                const input = document.getElementById('chat-input');
                if (!input) return;
                const message = input.value.trim();
                
                if (!message) return;

                console.log('[CHAT] ========== SEND CHAT MESSAGE ==========');
                console.log('[CHAT] Message:', message);
                console.log('[CHAT] Goal flow active:', goalCreationFlow.active);

                // Expanded keywords to detect goal creation intent - ALWAYS trigger flow
                const goalKeywords = [
                    'crear goal', 'create goal', 'nuevo goal', 'new goal', 'anadir goal', 'add goal',
                    'crear objetivo', 'create objective', 'nuevo objetivo', 'new objective', 'anadir objetivo', 'add objective',
                    'quiero crear', 'want to create', 'necesito crear', 'need to create',
                    'agregar goal', 'agregar objetivo', 'hacer un goal', 'hacer un objetivo',
                    'registrar goal', 'registrar objetivo', 'definir objetivo', 'definir goal',
                    'establecer objetivo', 'establecer goal', 'poner un objetivo', 'poner un goal'
                ];
                
                const messageClean = message.toLowerCase().trim();
                const hasGoalKeyword = goalKeywords.some(keyword => messageClean.includes(keyword));
                
                console.log('[CHAT] Has goal keyword:', hasGoalKeyword);
                
                // ALWAYS start goal creation flow if keywords detected and flow is not active
                if (!goalCreationFlow.active && hasGoalKeyword) {
                    console.log('[CHAT] [OK] Goal creation keyword detected! Starting flow...');
                    input.value = '';
                    addMessageToChat('user', message);
                    startGoalCreation();
                    return;
                }

                // If flow is active, continue with it
                if (goalCreationFlow.active) {
                    console.log('[CHAT] Flow active, processing answer for step:', goalCreationFlow.step);
                    removeQuickReplyOptions();
                    addMessageToChat('user', message);
                    input.value = '';
                    
                    const currentQuestion = goalQuestions[goalCreationFlow.step];
                    
                    // Handle team_member type - check if message matches a team member
                    if (currentQuestion.type === 'team_member') {
                        const teamMembers = window.currentTeamMembers || [];
                        const selectedMember = teamMembers.find(m => 
                            (m.name || m.email) === message
                        );
                        
                        if (selectedMember) {
                            goalCreationFlow.data[currentQuestion.field] = selectedMember.user_id;
                            console.log('[CHAT] Saved team member user_id:', selectedMember.user_id);
                        } else if (message === 'Skip (No assignment)') {
                            goalCreationFlow.data[currentQuestion.field] = null;
                            console.log('[CHAT] No team member assigned');
                        } else {
                            goalCreationFlow.data[currentQuestion.field] = message;
                        }
                    } else {
                        goalCreationFlow.data[currentQuestion.field] = message;
                    }
                    
                    console.log('[CHAT] Saved answer for field:', currentQuestion.field);
                    
                    goalCreationFlow.step++;
                    saveFlowState(); // Persist after each step
                    
                    if (goalCreationFlow.step < goalQuestions.length) {
                        const nextQuestion = goalQuestions[goalCreationFlow.step];
                        console.log('[CHAT] Asking next question for field:', nextQuestion.field);
                        addMessageToChat('assistant', nextQuestion.question);
                        
                        // Check if this question needs team members options
                        if (nextQuestion.type === 'team_member') {
                            console.log('[CHAT] Loading team members for assignment...');
                            await loadTeamMembersForGoalFlow();
                        } else if (nextQuestion.options) {
                            showQuickReplyOptions(nextQuestion.options);
                        }
                    } else {
                        console.log('[CHAT] All questions answered, completing...');
                        await completeGoalCreation();
                    }
                    return;
                }

                console.log('[CHAT] Normal chat message, sending to AI...');
                
                // Handle the chat directly - don't rely on original function
                addMessageToChat('user', message);
                input.value = '';
                
                const loading = document.getElementById('chat-loading');
                if (loading) loading.classList.remove('hidden');
                
                try {
                    // Check if there's an email context active
                    const emailContext = window.currentEmailContext || null;
                    
                    const response = await axios.post('/api/chat-agent/message', { 
                      message,
                      emailContext: emailContext
                    }, { withCredentials: true });
                    
                    // Clear the email context after first user response
                    if (emailContext) {
                      console.log('[CHAT] Clearing email context after user response');
                      window.currentEmailContext = null;
                    }
                    
                    if (loading) loading.classList.add('hidden');
                    
                    if (response.data) {
                        console.log('[CHAT] [RESPONSE] Response received:', JSON.stringify(response.data));
                        
                        // Check for goal flow trigger FIRST (highest priority)
                        // BUT ignore if it's from an ASTAR response
                        if ((response.data.triggerGoalFlow === true || response.data.message === '__START_GOAL_FLOW__') && !window.isAstarResponse) {
                            console.log('[CHAT] [OK] GOAL FLOW TRIGGER detected! Starting flow...');
                            startGoalCreation();
                            return; // Don't show anything in chat
                        } else if (window.isAstarResponse) {
                            console.log('[CHAT] Ignoring goal flow trigger - this is an ASTAR response');
                        }
                        
                        const aiMessage = response.data.message;
                        
                        // Fallback: text-based TRIGGER detection (legacy)
                        if (aiMessage && aiMessage.includes('TRIGGER:START_GOAL_FLOW') && !window.isAstarResponse) {
                            console.log('[CHAT] [OK] Legacy TRIGGER detected!');
                            startGoalCreation();
                            return;
                        }
                        
                        // Normal message - display it
                        if (aiMessage) {
                            addMessageToChat('assistant', aiMessage);
                        }
                    }
                } catch (e) {
                    if (loading) loading.classList.add('hidden');
                    console.error('[CHAT] Error:', e);
                    addMessageToChat('assistant', 'Sorry, there was an error. Please try again.');
                }
            };
        }
        
        // Call the setup function immediately
        setupEnhancedSendChatMessage();

        async function completeGoalCreation() {
            console.log('[GOAL-FLOW] ========== COMPLETE GOAL CREATION ==========');
            console.log('[GOAL-FLOW] Final data collected:', JSON.stringify(goalCreationFlow.data));
            
            goalCreationFlow.active = false;
            clearFlowState(); // Clear localStorage
            document.getElementById('chat-loading').classList.remove('hidden');
            
            try {
                const priorityLabels = {
                    'P0': 'Urgent & important',
                    'P1': 'Urgent or important',
                    'P2': 'Urgent but not important',
                    'P3': 'Neither but cool'
                };
                
                console.log('[GOAL-FLOW] Using category from user selection:', goalCreationFlow.data.category);
                
                const goalData = {
                    category: goalCreationFlow.data.category || 'Build',
                    description: goalCreationFlow.data.description,
                    task: goalCreationFlow.data.task || null,
                    priority: goalCreationFlow.data.priority,
                    priority_label: priorityLabels[goalCreationFlow.data.priority],
                    cadence: goalCreationFlow.data.cadence,
                    assigned_to_user_id: goalCreationFlow.data.assigned_to || null,
                    goal_status: goalCreationFlow.data.goal_status,
                    week_of: goalCreationFlow.data.week_of || null
                };
                
                console.log('[GOAL-FLOW] Prepared goalData for backend:', JSON.stringify(goalData));
                
                const isEditing = goalCreationFlow.editingGoalId !== null;
                console.log('[GOAL-FLOW] Is editing:', isEditing, 'Goal ID:', goalCreationFlow.editingGoalId);
                
                if (isEditing) {
                    console.log('[GOAL-FLOW] Updating existing goal via PUT');
                    // Update existing goal
                    const response = await axios.put('/api/dashboard/goals/' + goalCreationFlow.editingGoalId, goalData, {
                        withCredentials: true
                    });
                    console.log('[GOAL-FLOW] PUT response:', response.data);
                    
                    document.getElementById('chat-loading').classList.add('hidden');
                    
                    if (response.data.success || response.status === 200) {
                        addMessageToChat('assistant', '[OK] Goal updated successfully! | [GOAL] **' + goalData.description + '** | [TASK] ' + (goalData.task || 'N/A') + ' | [CATEGORY] ' + goalData.category + ' | [PRIORITY] ' + goalData.priority + ' - ' + goalData.priority_label + ' | [CADENCE] ' + goalData.cadence + ' | [DRI] ' + (goalData.dri || 'Not assigned') + ' | [STATUS] ' + goalData.goal_status + ' | [WEEK] ' + (goalData.week_of || 'Not specified') + ' | The goal is now available in your Founder Hub!');
                        
                        console.log('[GOAL-FLOW] Reloading dashboard data in 2 seconds...');
                        setTimeout(() => {
                            if (typeof loadDashboardData === 'function') {
                                console.log('[GOAL-FLOW] Calling loadDashboardData()');
                                loadDashboardData();
                            } else {
                                console.log('[GOAL-FLOW] loadDashboardData not found, reloading page');
                                window.location.reload();
                            }
                        }, 2000);
                    } else {
                        console.error('[GOAL-FLOW] Unexpected response:', response);
                        addMessageToChat('assistant', '[ERROR] There was an error updating the goal. Please try again.');
                    }
                } else {
                    console.log('[GOAL-FLOW] Creating new goal - sending to chat-agent');
                    // Enviar al chat-agent para que maneje la creación localmente
                    // Construir mensaje con todos los datos en el formato que espera el backend
                    const createMessage = 'Create goal with the following data: Category: ' + goalData.category + ' | Description: ' + goalData.description + ' | Task: ' + (goalData.task || 'N/A') + ' | Priority: ' + goalData.priority + ' | Cadence: ' + goalData.cadence + ' | DRI: ' + (goalData.dri || 'Not assigned') + ' | Status: ' + goalData.goal_status + ' | Week: ' + (goalData.week_of || 'Not specified');
                    
                    console.log('[GOAL-FLOW] Sending creation request to chat-agent:', createMessage);
                    
                    const response = await axios.post('/api/chat-agent/message', { 
                        message: createMessage,
                        goalData: goalData  // Enviar los datos estructurados también
                    }, {
                        withCredentials: true
                    });
                    
                    console.log('[GOAL-FLOW] Chat-agent response:', response.data);
                    
                    document.getElementById('chat-loading').classList.add('hidden');
                    
                    if (response.data && response.data.message) {
                        addMessageToChat('assistant', response.data.message);
                        
                        console.log('[GOAL-FLOW] Reloading dashboard data in 2 seconds...');
                        setTimeout(() => {
                            if (typeof loadDashboardData === 'function') {
                                console.log('[GOAL-FLOW] Calling loadDashboardData()');
                                loadDashboardData();
                            } else {
                                console.log('[GOAL-FLOW] loadDashboardData not found, reloading page');
                                window.location.reload();
                            }
                        }, 2000);
                    } else {
                        addMessageToChat('assistant', '[ERROR] There was an error creating the goal. Please try again.');
                    }
                }
            } catch (error) {
                document.getElementById('chat-loading').classList.add('hidden');
                console.error('Error creating goal:', error);
                addMessageToChat('assistant', '[ERROR] Error creating the goal. Please try again or use the "New Goal" button in the Hub.');
            }
        }

        async function analyzeCompetition() {
            addMessageToChat('user', 'Analiza la competencia en mi industria');
            document.getElementById('chat-loading').classList.remove('hidden');
            
            try {
                const response = await axios.post('/api/chat-agent/competition-analysis', {
                    competitors: [],
                    industry: ''
                }, {
                    withCredentials: true
                });
                
                document.getElementById('chat-loading').classList.add('hidden');
                addMessageToChat('assistant', response.data.analysis || 'Analisis completado.');
            } catch (error) {
                document.getElementById('chat-loading').classList.add('hidden');
                console.error('Error analyzing competition:', error);
                addMessageToChat('assistant', 'Error analyzing competition. Please try again.');
            }
        }

        async function clearChatHistory() {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) return; // No chat for guests
            
            if (!confirm('Estas seguro de que quieres limpiar el historial del chat?')) return;
            
            try {
                await axios.delete('/api/chat-agent/history', {
                    withCredentials: true
                });
                
                document.getElementById('chat-messages').innerHTML = 
                    '<div class="text-center text-gray-500 text-sm py-8">' +
                        '<span class="text-3xl mb-2 block">🌟</span>' +
                        '<p class="font-semibold">Start chatting with your ASTAR Agent</p>' +
                        '<p class="text-xs mt-1">Ask about your goals, metrics, or growth strategies</p>' +
                    '</div>';
            } catch (error) {
                console.error('Error clearing chat:', error);
                alert('Error clearing chat history.');
            }
        }

        function getCookie(name) {
            const value = '; ' + document.cookie;
            const parts = value.split('; ' + name + '=');
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function logout() {
            document.cookie = 'authToken=; Max-Age=0; path=/;';
            window.location.href = '/';
        }
        
        // ============================================
        // EXPOSE ALL FUNCTIONS TO WINDOW IMMEDIATELY
        // ============================================
        window.logout = logout;
        window.getCookie = getCookie;
        window.clearChatHistory = clearChatHistory;
        window.toggleLeftSidebar = toggleLeftSidebar;
        window.toggleChatSidebar = toggleChatSidebar;
        window.toggleChatVisibility = toggleChatVisibility;
        window.startGoalCreation = startGoalCreation;
        window.analyzeGoals = analyzeGoals;
        window.generateMarketingPlan = generateMarketingPlan;
        window.generateContentIdeas = generateContentIdeas;
        window.updateUsers = updateUsers;
        window.updateRevenue = updateRevenue;
        // NOTE: window.sendChatMessage is set in the enhanced version above (line ~1116)
        // Do NOT overwrite it here or the goal detection will break!
        window.handleChatKeydown = handleChatKeydown;
        window.addMessageToChat = addMessageToChat;
        
        console.log('[INIT] All functions exposed to window');

        // Attach event listeners when DOM is ready
        function attachButtonListeners() {
            console.log('[INIT] attachButtonListeners called');
            
            // Attach event listeners to buttons
            const btnCreateGoal = document.getElementById('btn-create-goal');
            const btnAnalyzeGoals = document.getElementById('btn-analyze-goals');
            const btnMarketingPlan = document.getElementById('btn-marketing-plan');
            const btnContentIdeas = document.getElementById('btn-content-ideas');
            
            console.log('[INIT] Buttons found:', {
                createGoal: !!btnCreateGoal,
                analyzeGoals: !!btnAnalyzeGoals,
                marketingPlan: !!btnMarketingPlan,
                contentIdeas: !!btnContentIdeas
            });
            
            if (btnCreateGoal) {
                console.log('[INIT] Attaching Create Goal listener');
                btnCreateGoal.onclick = function(e) {
                    console.log('[BTN] Create Goal clicked');
                    e.preventDefault();
                    startGoalCreation();
                };
            } else {
                console.error('[INIT] btn-create-goal NOT FOUND');
            }
            
            if (btnAnalyzeGoals) {
                console.log('[INIT] Attaching Analyze Goals listener');
                btnAnalyzeGoals.onclick = function(e) {
                    console.log('[BTN] Analyze Goals clicked');
                    e.preventDefault();
                    analyzeGoals();
                };
            } else {
                console.error('[INIT] btn-analyze-goals NOT FOUND');
            }
            
            if (btnMarketingPlan) {
                console.log('[INIT] Attaching Marketing Plan listener');
                btnMarketingPlan.onclick = function(e) {
                    console.log('[BTN] Marketing Plan clicked');
                    e.preventDefault();
                    generateMarketingPlan();
                };
            } else {
                console.error('[INIT] btn-marketing-plan NOT FOUND');
            }
            
            if (btnContentIdeas) {
                console.log('[INIT] Attaching Content Ideas listener');
                btnContentIdeas.onclick = function(e) {
                    console.log('[BTN] Content Ideas clicked');
                    e.preventDefault();
                    generateContentIdeas();
                };
            } else {
                console.error('[INIT] btn-content-ideas NOT FOUND');
            }
        }
        
        // Try multiple times to attach listeners
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachButtonListeners);
        } else {
            // DOM already loaded, try immediately
            attachButtonListeners();
        }
        
        // Also try after a short delay as fallback
        setTimeout(attachButtonListeners, 100);
        setTimeout(attachButtonListeners, 500);
        
        // Load chat history after page fully loads
        async function loadChatHistory() {
            console.log('[CHAT-HISTORY] Loading chat history...');
            
            try {
                const response = await axios.get('/api/chat-agent/history', {
                    withCredentials: true
                });
                
                console.log('[CHAT-HISTORY] Response:', response.data);
                
                if (response.data.messages && response.data.messages.length > 0) {
                    console.log('[CHAT-HISTORY] Found', response.data.messages.length, 'messages');
                    const messagesContainer = document.getElementById('chat-messages');
                    if (!messagesContainer) {
                        console.error('[CHAT-HISTORY] Messages container not found!');
                        return;
                    }
                    
                    messagesContainer.innerHTML = '';
                    
                    // Messages are already in correct order from API
                    response.data.messages.forEach(msg => {
                        addMessageToChat(msg.role, msg.content);
                    });
                    console.log('[CHAT-HISTORY] Chat history loaded successfully');
                } else {
                    console.log('[CHAT-HISTORY] No previous messages found');
                }
            } catch (error) {
                console.error('[CHAT-HISTORY] Error loading chat history:', error);
                // Show default message on error
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer && messagesContainer.children.length === 0) {
                    messagesContainer.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">' +
                        '<span class="text-3xl mb-2 block">🌟</span>' +
                        '<p class="font-semibold">Start chatting with your ASTAR Agent</p>' +
                        '<p class="text-xs mt-1">Ask about your goals, metrics, or growth strategies</p>' +
                        '</div>';
                }
            }
        }
        
        // Load history when page loads
        window.addEventListener('load', loadChatHistory);
        
        // Also expose function so we can reload history when needed
        window.loadChatHistory = loadChatHistory;
    <\/script>
    
    <!-- ASTAR Weekly Messages Notifications -->
    <script>
    // Función de utilidad global
    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    window.escapeHtml = escapeHtml;
    
    (function() {
      console.log('[ASTAR] Initializing notifications system...');
      
      function getAuthToken() {
        var cookieMatch = document.cookie.match(/authToken=([^;]+)/);
        return cookieMatch ? cookieMatch[1] : localStorage.getItem('authToken');
      }
      
      async function loadAstarNotifications() {
        var token = getAuthToken();
        if (!token) {
          console.log('[ASTAR] No auth token found');
          return;
        }
        
        try {
          console.log('[ASTAR] Fetching pending messages...');
          var response = await fetch('/api/astar-messages/pending', {
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            credentials: 'include'
          });
          
          console.log('[ASTAR] Response status:', response.status);
          
          if (!response.ok) {
            console.error('[ASTAR] Failed to fetch:', response.statusText);
            return;
          }
          
          var data = await response.json();
          console.log('[ASTAR] Data received:', data);
          
          if (data.pending && data.pending.length > 0) {
            console.log('[ASTAR] Showing', data.pending.length, 'notifications');
            showAstarBanner(data.pending);
          } else {
            console.log('[ASTAR] No pending messages');
          }
        } catch (error) {
          console.error('[ASTAR] Error:', error);
        }
      }
      
      function showAstarBanner(messages) {
        var existing = document.getElementById('astar-notification-banner');
        if (existing) existing.remove();
        
        var banner = document.createElement('div');
        banner.id = 'astar-notification-banner';
        banner.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:9999;width:90%;max-width:800px;';
        
        var messagesHtml = messages.map(function(msg) {
          var escapedSubject = escapeHtml(msg.subject);
          var escapedPrompt = escapeHtml(msg.response_prompt);
          
          return '<div style="background:rgba(15,23,42,0.9);padding:16px;border-radius:8px;margin-bottom:12px;border-left:4px solid #8b5cf6;">' +
            '<div style="color:white;margin-bottom:12px;">' +
              '<div style="font-size:18px;font-weight:bold;margin-bottom:8px;">' + escapedSubject + '</div>' +
              '<div style="font-size:14px;color:#cbd5e1;margin-bottom:12px;">' + escapedPrompt + '</div>' +
            '</div>' +
            '<textarea id="astar-response-' + msg.sent_message_id + '" placeholder="Write your response" ' +
              'style="width:100%;min-height:80px;padding:12px;border-radius:8px;border:1px solid #475569;background:#1e293b;color:white;font-size:14px;resize:vertical;margin-bottom:12px;"></textarea>' +
            '<button onclick="window.submitAstarResponse(' + msg.sent_message_id + ')" ' +
              'style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:10px 20px;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">' +
              'Send Response</button>' +
          '</div>';
        }).join('');
        
        var messageCount = messages.length;
        var messageText = messageCount === 1 ? 'message' : 'messages';
        
        banner.innerHTML = '<div style="background:linear-gradient(135deg,#581c87,#312e81);border-radius:12px;padding:20px;border:2px solid #8b5cf6;box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">' +
          '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">' +
            '<div style="display:flex;align-items:center;gap:12px;">' +
              '<span style="font-size:28px;">*</span>' +
              '<h2 style="color:white;font-size:20px;font-weight:bold;margin:0;">ASTAR has a question</h2>' +
              '<span style="background:#8b5cf6;color:white;padding:4px 12px;border-radius:20px;font-size:14px;font-weight:bold;">' + messageCount + ' ' + messageText + '</span>' +
            '</div>' +
            '<button onclick="document.getElementById(' + String.fromCharCode(39) + 'astar-notification-banner' + String.fromCharCode(39) + ').remove()" style="background:transparent;border:none;color:#9ca3af;font-size:24px;cursor:pointer;">X</button>' +
          '</div>' +
          messagesHtml +
        '</div>';
        
        document.body.appendChild(banner);
        console.log('[ASTAR] Banner displayed');
      }
      
      window.submitAstarResponse = async function(messageId) {
        console.log('[ASTAR-SUBMIT] Function called with messageId:', messageId);
        
        var textarea = document.getElementById('astar-response-' + messageId);
        console.log('[ASTAR-SUBMIT] Textarea found:', !!textarea);
        
        var response = textarea ? textarea.value.trim() : '';
        console.log('[ASTAR-SUBMIT] Response text:', response);
        
        if (!response) {
          alert('Please write a response');
          return;
        }
        
        var token = getAuthToken();
        if (!token) {
          alert('Session expired');
          return;
        }
        
        // Mostrar indicador de carga
        var btn = event.target;
        var originalText = btn.innerHTML;
        btn.innerHTML = 'Saving...';
        btn.disabled = true;
        
        try {
          console.log('[ASTAR-SUBMIT] Sending to API...');
          var res = await fetch('/api/astar-messages/respond', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              sent_message_id: messageId,
              response_text: response
            })
          });
          
          console.log('[ASTAR-SUBMIT] API response status:', res.status);
          
          if (res.ok) {
            var data = await res.json();
            console.log('[ASTAR-SUBMIT] Response saved, data:', data);
            
            // Cerrar el banner
            var banner = document.getElementById('astar-notification-banner');
            if (banner) {
              banner.remove();
              console.log('[ASTAR-SUBMIT] Banner removed');
            }
            
            // Guardar datos para el chat
            window.astarResponseData = data;
            console.log('[ASTAR-SUBMIT] Data saved to window.astarResponseData');
            
            // Redirigir directamente al chat
            console.log('[ASTAR-SUBMIT] Calling openAstarChat...');
            if (typeof window.openAstarChat === 'function') {
              window.openAstarChat();
            } else {
              console.error('[ASTAR-SUBMIT] openAstarChat function not found!');
            }
            
          } else {
            var err = await res.json();
            console.error('[ASTAR-SUBMIT] API error:', err);
            alert('Error: ' + (err.error || 'No se pudo enviar'));
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        } catch (error) {
          console.error('[ASTAR-SUBMIT] Error submitting:', error);
          alert('Error al enviar respuesta');
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      };
      
      window.openAstarChat = function() {
        // Close modal if exists
        var modal = document.getElementById('astar-success-modal');
        if (modal) modal.remove();
        
        // Cerrar el banner de notificación
        var banner = document.getElementById('astar-notification-banner');
        if (banner) banner.remove();
        
        // Get response data
        var data = window.astarResponseData || {};
        
        console.log('[ASTAR-OPEN-CHAT] Opening chat sidebar with response:', data);
        console.log('[ASTAR-OPEN-CHAT] Has response_text:', !!data.response_text);
        console.log('[ASTAR-OPEN-CHAT] Response text:', data.response_text);
        
        // Abrir el chat sidebar directamente
        var sidebar = document.getElementById('chat-sidebar');
        var floatingBtn = document.getElementById('chat-floating-btn');
        var overlay = document.getElementById('chat-overlay');
        var isMobile = window.innerWidth <= 768;
        
        if (sidebar) {
          sidebar.style.width = isMobile ? '100%' : '400px';
          sidebar.style.maxWidth = '400px';
          sidebar.style.display = 'flex';
          if (floatingBtn) floatingBtn.style.display = 'none';
          if (isMobile && overlay) overlay.classList.remove('hidden');
          console.log('[ASTAR-OPEN-CHAT] Chat sidebar opened');
        } else {
          console.error('[ASTAR-OPEN-CHAT] Sidebar element not found!');
        }
        
        // Añadir mensaje del usuario al chat
        var chatMessages = document.getElementById('chat-messages');
        console.log('[ASTAR-OPEN-CHAT] Chat messages element:', !!chatMessages);
        
        if (!chatMessages) {
          console.error('[ASTAR-OPEN-CHAT] Chat messages container not found!');
          return;
        }
        
        if (!data.response_text) {
          console.error('[ASTAR-OPEN-CHAT] No response text in data!');
          return;
        }
        
        // Enviar al backend con contexto ASTAR
        console.log('[ASTAR-OPEN-CHAT] Sending to API...');
        console.log('[ASTAR-OPEN-CHAT] Full data object:', data);
        
        // Crear mensaje contextual basado en la categoria
        var contextualMessage = data.response_text;
        var category = data.category || 'general';
        var originalQuestion = data.response_prompt || '';
        
        console.log('[ASTAR-OPEN-CHAT] Category:', category);
        console.log('[ASTAR-OPEN-CHAT] Original question from data.response_prompt:', originalQuestion);
        
        // Mostrar la pregunta original de ASTAR en el chat si existe
        console.log('[ASTAR-OPEN-CHAT] Original question:', originalQuestion);
        if (originalQuestion && originalQuestion.trim()) {
          var questionDiv = document.createElement('div');
          questionDiv.className = 'flex justify-start mb-3';
          questionDiv.innerHTML = '<div class="bg-blue-50 text-blue-900 rounded-lg px-4 py-2 max-w-[85%] shadow-sm border border-blue-200"><p class="text-sm font-medium mb-1">📊 ASTAR Question:</p><p class="text-sm">' + escapeHtml(originalQuestion) + '</p></div>';
          chatMessages.appendChild(questionDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          console.log('[ASTAR-OPEN-CHAT] Original ASTAR question displayed in chat');
        }
        
        // Mostrar la respuesta del usuario
        console.log('[ASTAR-OPEN-CHAT] Adding user message to chat...');
        var userDiv = document.createElement('div');
        userDiv.className = 'flex justify-end mb-3';
        userDiv.innerHTML = '<div class="bg-indigo-600 text-white rounded-lg px-4 py-2 max-w-[85%] shadow-sm"><p class="text-sm whitespace-pre-wrap">' + escapeHtml(data.response_text) + '</p></div>';
        chatMessages.appendChild(userDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        console.log('[ASTAR-OPEN-CHAT] User message added');
        
        // Mostrar loading
        var loading = document.getElementById('chat-loading');
        if (loading) {
          loading.classList.remove('hidden');
          console.log('[ASTAR-OPEN-CHAT] Loading indicator shown');
        }
        
        // Incluir la pregunta original y la respuesta para dar contexto completo
        var fullContextMessage = '';
        
        if (originalQuestion) {
          fullContextMessage = '[ASTAR] Question: "' + originalQuestion + '" --- ';
          fullContextMessage += '[MY RESPONSE] ' + data.response_text + ' --- ';
        } else {
          fullContextMessage = '[MY RESPONSE] ' + data.response_text + ' --- ';
        }
        
        // Add MANDATORY ACTION instructions based on category - must result in concrete action
        if (category.includes('measure') || category.includes('metricas') || category.includes('resultados')) {
          fullContextMessage += 'MANDATORY ACTION: Based on my response, you MUST either: 1) Update my metrics (users, revenue, etc.) if I provided numbers, OR 2) Create a goal to track these metrics. Start the appropriate flow immediately without asking - analyze my response and execute the action.';
        } else if (category.includes('ideas') || category.includes('hipotesis')) {
          fullContextMessage += 'MANDATORY ACTION: Based on my hypothesis/idea, you MUST create a goal to test it. Use TRIGGER:START_GOAL_FLOW to start the goal creation flow immediately. Do not just give recommendations - create the goal now.';
        } else if (category.includes('build') || category.includes('construccion')) {
          fullContextMessage += 'MANDATORY ACTION: Based on what I am building, you MUST create a goal with the next concrete steps. Use TRIGGER:START_GOAL_FLOW to start the goal creation flow immediately.';
        } else if (category.includes('reflect') || category.includes('reflexion')) {
          fullContextMessage += 'MANDATORY ACTION: Based on my reflection, you MUST create a goal with my key learnings and next steps. Use TRIGGER:START_GOAL_FLOW to start the goal creation flow immediately.';
        } else {
          fullContextMessage += 'MANDATORY ACTION: Based on my response, you MUST take one concrete action: either create a goal (use TRIGGER:START_GOAL_FLOW) or update metrics. Do not just give recommendations - execute an action now.';
        }
        
        console.log('[ASTAR-OPEN-CHAT] Full context message:', fullContextMessage);
        
        // Map category to emailContext
        let emailContext = '';
        if (category.includes('hipotesis') || category.includes('hypothesis') || category.includes('ideas')) {
          emailContext = 'hipotesis';
        } else if (category.includes('construccion') || category.includes('build')) {
          emailContext = 'construccion';
        } else if (category.includes('usuarios') || category.includes('users') || category.includes('user_learning')) {
          emailContext = 'usuarios';
        } else if (category.includes('metricas') || category.includes('measure') || category.includes('insight')) {
          emailContext = 'metricas';
        } else if (category.includes('traction') || category.includes('resultados')) {
          emailContext = 'traction';
        } else if (category.includes('reflexion') || category.includes('reflect')) {
          emailContext = 'reflexion';
        }
        
        console.log('[ASTAR-OPEN-CHAT] Email context:', emailContext);
        
        // Marcar que es una respuesta ASTAR para evitar triggers automáticos
        window.isAstarResponse = true;
        
        fetch('/api/chat-agent/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ 
            message: data.response_text, // Send user response directly, not with context wrapper
            emailContext: emailContext || undefined // Send structured emailContext parameter
          })
        })
        .then(function(res) { 
          console.log('[ASTAR-OPEN-CHAT] API response status:', res.status);
          return res.json(); 
        })
        .then(function(responseData) {
          console.log('[ASTAR-OPEN-CHAT] API response data:', responseData);
          if (loading) loading.classList.add('hidden');
          
          // Limpiar la marca de respuesta ASTAR
          window.isAstarResponse = false;
          
          // Si hay flowState, guardarlo para la siguiente pregunta
          if (responseData.flowState && responseData.emailContext) {
            window.emailFlowState = {
              flowState: responseData.flowState,
              emailContext: responseData.emailContext
            };
            console.log('[ASTAR-OPEN-CHAT] Saved flow state:', window.emailFlowState);
          } else if (responseData.flowState === 'complete') {
            // Limpiar el estado cuando el flujo se completa
            window.emailFlowState = null;
            console.log('[ASTAR-OPEN-CHAT] Flow completed, cleared state');
          }
          
          if (responseData && responseData.message && responseData.message.trim()) {
            var aiMessage = responseData.message.trim();
            
            // Detectar triggers en la respuesta
            if (aiMessage.includes('TRIGGER:START_GOAL_FLOW')) {
              console.log('[ASTAR-OPEN-CHAT] Goal creation trigger detected, starting goal flow');
              // Reset goal flow state to avoid "already active" blocking
              if (window.goalCreationFlow) {
                window.goalCreationFlow.active = false;
                window.goalCreationFlow.step = 0;
                window.goalCreationFlow.data = {};
                console.log('[ASTAR-OPEN-CHAT] Reset goal flow state');
              }
              startGoalCreation();
              return; // No mostrar el mensaje del trigger
            } else if (aiMessage.includes('TRIGGER:EDIT_GOAL_FLOW|')) {
              try {
                var parts = aiMessage.split('TRIGGER:EDIT_GOAL_FLOW|');
                if (parts.length > 1) {
                  var goalId = parts[1].split(' ')[0].split('|')[0].trim();
                  console.log('[ASTAR-OPEN-CHAT] Goal edit trigger detected for goal:', goalId);
                  startGoalCreation(goalId);
                  return; // No mostrar el mensaje del trigger
                }
              } catch (e) {
                console.error('[ASTAR-OPEN-CHAT] Error parsing goal ID:', e);
              }
            }
            
            // Mostrar mensaje normal del asistente con markdown parsing
            var assistantDiv = document.createElement('div');
            assistantDiv.className = 'flex justify-start mb-3';
            
            // Parse markdown
            var msgText = String(aiMessage);
            // Bold: **text**
            // Parse markdown using parseMarkdown function
            var msgText = parseMarkdown(aiMessage);
            
            assistantDiv.innerHTML = '<div class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 rounded-xl px-4 py-3 max-w-[85%] shadow-md border border-gray-200"><div class="text-sm leading-relaxed">' + msgText + '</div></div>';
            chatMessages.appendChild(assistantDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            console.log('[ASTAR-OPEN-CHAT] Assistant message added');
          } else {
            console.warn('[ASTAR-OPEN-CHAT] Empty response, message was not generated by AI');
            
            // Show friendly error message
            var errorDiv = document.createElement('div');
            errorDiv.className = 'flex justify-start mb-3';
            errorDiv.innerHTML = '<div class="bg-yellow-100 text-yellow-800 rounded-lg px-4 py-2 max-w-[85%] shadow-sm"><p class="text-sm">[!] Could not process your response. Please write your question directly in the chat.</p></div>';
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        })
        .catch(function(error) {
          console.error('[ASTAR-OPEN-CHAT] Error:', error);
          if (loading) loading.classList.add('hidden');
        });
      };
      
      // Load notifications after page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAstarNotifications);
      } else {
        setTimeout(loadAstarNotifications, 500);
      }
    })();
    <\/script>
</body>
</html>
  `}function od(e){return typeof window<"u"&&(window.renderAICMOPage=od),`
    <div class="ai-cmo-page p-6">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">AI CMO</h1>
        <p class="text-gray-600">Gestiona el contenido de marketing generado por IA</p>
      </div>

      <!-- Tabs -->
      <div class="flex gap-4 mb-6 border-b border-gray-200">
        <button onclick="showAICMOSection('pending')" id="ai-cmo-pending-btn" class="px-4 py-3 text-sm font-semibold text-primary border-b-2 border-primary bg-primary/5">
          <i class="fas fa-clock mr-2"></i>
          Pendientes
        </button>
        <button onclick="showAICMOSection('approved')" id="ai-cmo-approved-btn" class="px-4 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent hover:bg-gray-50">
          <i class="fas fa-check-circle mr-2"></i>
          Aprobadas
        </button>
        <button onclick="showAICMOSection('rejected')" id="ai-cmo-rejected-btn" class="px-4 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent hover:bg-gray-50">
          <i class="fas fa-times-circle mr-2"></i>
          Rechazadas
        </button>
        <button onclick="showAICMOSection('history')" id="ai-cmo-history-btn" class="px-4 py-3 text-sm font-semibold text-gray-500 border-b-2 border-transparent hover:bg-gray-50">
          <i class="fas fa-history mr-2"></i>
          Historial
        </button>
      </div>

      <!-- Content Sections -->
      <div id="ai-cmo-pending-content" class="ai-cmo-section">
        <div id="pending-images-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Images will be loaded here -->
        </div>
        <div id="pending-empty" class="hidden text-center py-12 text-gray-400">
          <i class="fas fa-image text-6xl mb-4"></i>
          <p class="text-lg">No hay imágenes pendientes</p>
          <p class="text-sm mt-2">Las imágenes generadas por el AI Brand Marketing Agent aparecerán aquí</p>
        </div>
      </div>

      <div id="ai-cmo-approved-content" class="ai-cmo-section hidden">
        <div id="approved-images-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Approved images will be loaded here -->
        </div>
        <div id="approved-empty" class="hidden text-center py-12 text-gray-400">
          <i class="fas fa-check-circle text-6xl mb-4"></i>
          <p class="text-lg">No hay imágenes aprobadas</p>
        </div>
      </div>

      <div id="ai-cmo-rejected-content" class="ai-cmo-section hidden">
        <div id="rejected-images-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Rejected images will be loaded here -->
        </div>
        <div id="rejected-empty" class="hidden text-center py-12 text-gray-400">
          <i class="fas fa-times-circle text-6xl mb-4"></i>
          <p class="text-lg">No hay imágenes rechazadas</p>
        </div>
      </div>

      <div id="ai-cmo-history-content" class="ai-cmo-section hidden">
        <div id="history-list" class="space-y-4">
          <!-- History will be loaded here -->
        </div>
        <div id="history-empty" class="hidden text-center py-12 text-gray-400">
          <i class="fas fa-history text-6xl mb-4"></i>
          <p class="text-lg">No hay historial</p>
        </div>
      </div>
    </div>

    <style>
      .ai-cmo-page {
        max-width: 1400px;
        margin: 0 auto;
      }

      .image-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .image-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      }

      .image-card img {
        width: 100%;
        height: 250px;
        object-fit: cover;
      }

      .image-card-actions {
        padding: 16px;
        display: flex;
        gap: 8px;
      }

      .image-card-actions button {
        flex: 1;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .btn-approve {
        background: #10b981;
        color: white;
      }

      .btn-approve:hover {
        background: #059669;
      }

      .btn-reject {
        background: #ef4444;
        color: white;
      }

      .btn-reject:hover {
        background: #dc2626;
      }

      .btn-download {
        background: #3b82f6;
        color: white;
      }

      .btn-download:hover {
        background: #2563eb;
      }

      .btn-regenerate {
        background: #f59e0b;
        color: white;
      }

      .btn-regenerate:hover {
        background: #d97706;
      }
    </style>

    <script>
      // AI CMO Page Logic - Make functions global immediately
      window.showAICMOSection = function(section) {
        const currentSection = section;
        
        // Update tabs
        ['pending', 'approved', 'rejected', 'history'].forEach(function(s) {
          const btn = document.getElementById('ai-cmo-' + s + '-btn');
          const content = document.getElementById('ai-cmo-' + s + '-content');
          
          if (s === section) {
            if (btn) {
              btn.classList.remove('text-gray-500', 'border-transparent');
              btn.classList.add('text-primary', 'border-primary', 'bg-primary/5');
            }
            if (content) content.classList.remove('hidden');
          } else {
            if (btn) {
              btn.classList.remove('text-primary', 'border-primary', 'bg-primary/5');
              btn.classList.add('text-gray-500', 'border-transparent');
            }
            if (content) content.classList.add('hidden');
          }
        });

        window.loadAICMOImages(section);
      };

      window.loadAICMOImages = async function(section) {
        section = section || 'pending';
        try {
          const token = document.cookie.match(/authToken=([^;]+)/);
          const authToken = token ? token[1] : localStorage.getItem('authToken');
          
          const response = await fetch('/api/ai-cmo/images', {
            headers: {
              'Authorization': 'Bearer ' + authToken
            }
          });

          if (!response.ok) throw new Error('Failed to load images');

          const data = await response.json();
          const images = data.images || [];

          // Filter by section
          const filtered = images.filter(function(img) {
            if (section === 'pending') return img.status === 'pending';
            if (section === 'approved') return img.status === 'approved';
            if (section === 'rejected') return img.status === 'rejected';
            return true; // history shows all
          });

          const gridId = section === 'history' ? 'history-list' : section + '-images-grid';
          const emptyId = section + '-empty';
          const grid = document.getElementById(gridId);
          const empty = document.getElementById(emptyId);

          if (!grid) return;

          if (filtered.length === 0) {
            grid.innerHTML = '';
            grid.classList.add('hidden');
            if (empty) empty.classList.remove('hidden');
            return;
          }

          grid.classList.remove('hidden');
          if (empty) empty.classList.add('hidden');

          if (section === 'history') {
            grid.innerHTML = filtered.map(function(img) {
              var statusColors = {
                pending: 'text-yellow-600 bg-yellow-50',
                approved: 'text-green-600 bg-green-50',
                rejected: 'text-red-600 bg-red-50'
              };
              var statusText = img.status === 'pending' ? 'Pendiente' : img.status === 'approved' ? 'Aprobada' : 'Rechazada';
              return '<div class="bg-white rounded-lg p-4 flex gap-4 shadow-sm">' +
                '<img src="' + img.image_url + '" alt="Generated" class="w-24 h-24 rounded object-cover" onerror="this.src=\\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>No img</text></svg>\\'" />' +
                '<div class="flex-1">' +
                '<p class="text-sm text-gray-800 mb-1">' + (img.prompt || 'Sin prompt') + '</p>' +
                '<span class="inline-block px-2 py-1 text-xs font-semibold rounded ' + (statusColors[img.status] || 'text-gray-600 bg-gray-50') + '">' + statusText + '</span>' +
                '<p class="text-xs text-gray-400 mt-2">' + new Date(img.created_at).toLocaleDateString() + '</p>' +
                '</div></div>';
            }).join('');
          } else {
            grid.innerHTML = filtered.map(function(img) {
              var actions = '';
              if (img.status === 'pending') {
                actions = '<button onclick="approveImage(\\'' + img.id + '\\')" class="btn-approve"><i class="fas fa-check mr-1"></i> Aprobar</button>' +
                          '<button onclick="rejectImage(\\'' + img.id + '\\')" class="btn-reject"><i class="fas fa-times mr-1"></i> Rechazar</button>';
              } else if (img.status === 'approved') {
                actions = '<button onclick="downloadImage(\\'' + img.image_url + '\\', \\'' + img.id + '\\')" class="btn-download"><i class="fas fa-download mr-1"></i> Descargar</button>';
              } else if (img.status === 'rejected') {
                actions = '<button onclick="regenerateImage(\\'' + img.id + '\\')" class="btn-regenerate"><i class="fas fa-redo mr-1"></i> Regenerar</button>';
              }
              return '<div class="image-card">' +
                '<img src="' + img.image_url + '" alt="' + (img.prompt || 'Generated image') + '" onerror="this.src=\\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22>No img</text></svg>\\'" />' +
                '<div class="image-card-actions">' + actions + '</div>' +
                '<div class="px-4 pb-4">' +
                '<p class="text-sm text-gray-600 line-clamp-2">' + (img.prompt || 'Sin prompt') + '</p>' +
                '<p class="text-xs text-gray-400 mt-2">' + new Date(img.created_at).toLocaleDateString() + '</p>' +
                '</div></div>';
            }).join('');
          }
        } catch (error) {
          console.error('Error loading AI CMO images:', error);
        }
      };

      window.approveImage = async function(imageId) {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/);
          const authToken = token ? token[1] : localStorage.getItem('authToken');
          
          const response = await fetch('/api/ai-cmo/images/' + imageId + '/approve', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!response.ok) throw new Error('Failed');
          window.loadAICMOImages('pending');
        } catch (error) {
          console.error('Error:', error);
          alert('Error al aprobar la imagen');
        }
      };

      window.rejectImage = async function(imageId) {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/);
          const authToken = token ? token[1] : localStorage.getItem('authToken');
          
          const response = await fetch('/api/ai-cmo/images/' + imageId + '/reject', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!response.ok) throw new Error('Failed');
          window.loadAICMOImages('pending');
        } catch (error) {
          console.error('Error:', error);
          alert('Error al rechazar la imagen');
        }
      };

      window.downloadImage = async function(imageUrl, imageId) {
        try {
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'marketing-image-' + imageId + '.png';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          console.error('Error:', error);
          alert('Error al descargar la imagen');
        }
      };

      window.regenerateImage = async function(imageId) {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/);
          const authToken = token ? token[1] : localStorage.getItem('authToken');
          
          const response = await fetch('/api/ai-cmo/images/' + imageId + '/regenerate', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          if (!response.ok) throw new Error('Failed');
          window.loadAICMOImages('pending');
        } catch (error) {
          console.error('Error:', error);
          alert('Error al regenerar la imagen');
        }
      };

      // Auto-load images when page loads
      if (document.getElementById('pending-images-grid')) {
        window.loadAICMOImages('pending');
      }
    <\/script>
  `}function Ru(){return od.toString()}function nd(e){const{userName:t,userAvatar:r,userRole:a}=e,s=`
    <style>
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
    <div class="p-4 md:p-6 max-w-7xl mx-auto">
      <!-- Header -->
      <div class="mb-4 md:mb-6">
        <h1 class="text-xl md:text-2xl font-bold text-gray-900">Welcome back, ${t}! 👋</h1>
        <p class="text-sm md:text-base text-gray-500">Manage your startup growth and connect with validators</p>
      </div>

      <!-- Tab Navigation -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
        <div class="flex overflow-x-auto border-b border-gray-200 scrollbar-hide">
          ${a==="founder"?`
          <button onclick="switchTab('home')" id="tab-home" class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 text-sm font-semibold text-primary border-b-2 border-primary">
            <i class="fas fa-home mr-1 md:mr-2"></i><span class="hidden sm:inline">Hub</span>
          </button>
          <button onclick="switchTab('traction')" id="tab-traction" class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
            <i class="fas fa-chart-line mr-1 md:mr-2"></i><span class="hidden sm:inline">Traction</span>
          </button>
          `:""}
          <button onclick="switchTab('inbox')" id="tab-inbox" class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 text-sm font-semibold ${a==="founder"?"text-gray-500 hover:text-gray-700 border-b-2 border-transparent":"text-primary border-b-2 border-primary"}">
            <i class="fas fa-inbox mr-1 md:mr-2"></i><span class="hidden sm:inline">Inbox</span>
            <span id="unread-badge" class="hidden ml-2 bg-red-500 text-white text-xs rounded-full px-2 py-0.5">0</span>
          </button>
          <button onclick="switchTab('directory')" id="tab-directory" class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent">
            <i class="fas fa-store mr-1 md:mr-2"></i><span class="hidden sm:inline">Directory</span>
          </button>
          <button onclick="switchTab('connector')" id="tab-connector" class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent bg-gradient-to-r from-purple-50 to-indigo-50">
            <i class="fas fa-network-wired mr-1 md:mr-2"></i><span class="hidden sm:inline">AI Connector</span>
          </button>
          <button onclick="switchTab('crm')" id="tab-crm" class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent bg-gradient-to-r from-emerald-50 to-teal-50">
            <i class="fas fa-users-cog mr-1 md:mr-2"></i><span class="hidden sm:inline">AI CRM</span>
          </button>
          ${a==="admin"?`
          <button onclick="window.location.href='/admin'" class="tab-btn flex-shrink-0 px-4 md:px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 border-b-2 border-transparent bg-gradient-to-r from-purple-50 to-blue-50">
            <i class="fas fa-shield-alt mr-1 md:mr-2"></i><span class="hidden sm:inline">Admin</span>
          </button>
          `:""}
        </div>
      </div>

      <!-- Tab Contents -->
      
      ${a==="founder"?`
      <!-- HOME TAB -->
      <div id="content-home" class="tab-content">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
          <div class="bg-white rounded-xl p-4 md:p-5 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-gray-500 uppercase">Goals</p>
                <p class="text-xl md:text-2xl font-bold text-gray-900" id="stat-goals">-</p>
              </div>
              <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-bullseye text-blue-600 text-lg md:text-xl"></i>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2"><span id="stat-active">-</span> active</p>
          </div>
          <div class="bg-white rounded-xl p-4 md:p-5 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-gray-500 uppercase">Completion</p>
                <p class="text-xl md:text-2xl font-bold text-gray-900" id="stat-completion">-</p>
              </div>
              <div class="w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-check-circle text-green-600 text-lg md:text-xl"></i>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2"><span id="stat-completed">-</span> completed</p>
          </div>
          <div class="bg-white rounded-xl p-4 md:p-5 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-gray-500 uppercase">Users</p>
                <p class="text-xl md:text-2xl font-bold text-gray-900" id="stat-users">-</p>
              </div>
              <div class="w-10 h-10 md:w-12 md:h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-users text-purple-600 text-lg md:text-xl"></i>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2" id="stat-users-growth">-</p>
          </div>
          <div class="bg-white rounded-xl p-4 md:p-5 shadow-sm border border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-medium text-gray-500 uppercase">Revenue</p>
                <p class="text-xl md:text-2xl font-bold text-gray-900" id="stat-revenue">-</p>
              </div>
              <div class="w-10 h-10 md:w-12 md:h-12 bg-yellow-100 rounded-xl flex items-center justify-center">
                <i class="fas fa-dollar-sign text-yellow-600 text-lg md:text-xl"></i>
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-2" id="stat-revenue-growth">-</p>
          </div>
        </div>
        
        <!-- Goals Table Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
          <div class="p-4 md:p-6 border-b border-gray-200 flex flex-col md:flex-row md:justify-between md:items-center gap-3">
            <div>
              <h3 class="font-bold text-gray-900 text-lg md:text-xl">GOAL OF THE WEEK:</h3>
              <div class="flex flex-wrap gap-2 mt-2 text-xs md:text-sm">
                <span class="px-2 md:px-3 py-1 bg-blue-100 text-blue-800 rounded-full font-medium">🔨 Build</span>
                <span class="px-2 md:px-3 py-1 bg-purple-100 text-purple-800 rounded-full font-medium hidden md:inline">🧪 Test</span>
                <span class="px-2 md:px-3 py-1 bg-green-100 text-green-800 rounded-full font-medium hidden md:inline">📈 Traction</span>
              </div>
            </div>
            <button onclick="openGoalModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap">
              <i class="fas fa-plus mr-2"></i>New Goal
            </button>
          </div>
          
          <!-- Monthly Timeline Overview (Weeks) -->
          <!-- Monthly Calendar Overview -->
          <div id="monthly-calendar-overview" class="mb-6 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 border border-purple-100">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-semibold text-gray-700 flex items-center gap-2">
                <i class="fas fa-calendar-alt text-purple-600"></i>
                <span id="calendar-month-title">January 2026</span>
              </h4>
              <div class="flex items-center gap-2">
                <button onclick="changeCalendarMonth(-1)" class="p-1 hover:bg-purple-100 rounded">
                  <i class="fas fa-chevron-left text-purple-600"></i>
                </button>
                <button onclick="changeCalendarMonth(1)" class="p-1 hover:bg-purple-100 rounded">
                  <i class="fas fa-chevron-right text-purple-600"></i>
                </button>
                <span id="timeline-total-tasks" class="text-sm text-gray-500 ml-2">Loading...</span>
              </div>
            </div>
            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-1 mb-2">
              <div class="text-center text-xs font-semibold text-gray-500 py-1">Mon</div>
              <div class="text-center text-xs font-semibold text-gray-500 py-1">Tue</div>
              <div class="text-center text-xs font-semibold text-gray-500 py-1">Wed</div>
              <div class="text-center text-xs font-semibold text-gray-500 py-1">Thu</div>
              <div class="text-center text-xs font-semibold text-gray-500 py-1">Fri</div>
              <div class="text-center text-xs font-semibold text-gray-400 py-1">Sat</div>
              <div class="text-center text-xs font-semibold text-gray-400 py-1">Sun</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1">
              <!-- Calendar days will be generated dynamically -->
            </div>
            <!-- Legend -->
            <div class="mt-3 flex items-center justify-between text-xs text-gray-500">
              <div class="flex items-center gap-4">
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-400 rounded"></span> Light (1-2)</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-400 rounded"></span> Medium (3-4)</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-400 rounded"></span> Heavy (5+)</span>
              </div>
              <span id="busiest-day" class="font-medium"></span>
            </div>
          </div>
          
          <!-- Goals Filters -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-4">
            <div class="flex flex-wrap gap-3 items-center">
              <div class="flex-1 min-w-[200px]">
                <input type="text" id="goals-search" placeholder="Search goals..." class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" onkeyup="filterGoalsTable()">
              </div>
              <select id="goals-filter-category" onchange="filterGoalsTable()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
                <option value="">All Categories</option>
                <option value="ASTAR">ASTAR</option>
                <option value="MAGCIENT">MAGCIENT</option>
                <option value="Personal">Personal</option>
              </select>
              <select id="goals-filter-priority" onchange="filterGoalsTable()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
                <option value="">All Priorities</option>
                <option value="P0">P0 - Critical</option>
                <option value="P1">P1 - High</option>
                <option value="P2">P2 - Medium</option>
                <option value="P3">P3 - Low</option>
              </select>
              <select id="goals-filter-status" onchange="filterGoalsTable()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
                <option value="">All Status</option>
                <option value="WIP">WIP</option>
                <option value="To start">To start</option>
                <option value="On Hold">On Hold</option>
                <option value="Delayed">Delayed</option>
                <option value="Blocked">Blocked</option>
                <option value="Done">Done</option>
              </select>
              <select id="goals-filter-dri" onchange="filterGoalsTable()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
                <option value="">All DRIs</option>
              </select>
              <button onclick="clearGoalsFilters()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50">
                <i class="fas fa-times mr-1"></i>Clear
              </button>
            </div>
          </div>
          
          <!-- Goals Table -->
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gradient-to-r from-purple-600 to-purple-700 text-white">
                <tr>
                  <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider">Category</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider">Description</th>
                  <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider">Task</th>
                  <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider">Priority</th>
                  <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider">Cadence</th>
                  <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider">DRI</th>
                  <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider">Status</th>
                  <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider">
                    <i class="fas fa-calendar-day mr-1"></i>Schedule
                  </th>
                  <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="goals-table-body" class="divide-y divide-gray-200 bg-white">
                <tr>
                  <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading goals...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-gray-900">Quick Stats</h3>
            </div>
            <div class="space-y-3">
              <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                <span class="text-sm text-gray-700">Total Goals</span>
                <span id="quick-total-goals" class="font-bold text-purple-600">0</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                <span class="text-sm text-gray-700">Completed This Week</span>
                <span id="quick-completed-goals" class="font-bold text-green-600">0</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                <span class="text-sm text-gray-700">In Progress</span>
                <span id="quick-wip-goals" class="font-bold text-yellow-600">0</span>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold text-gray-900">Recent Messages</h3>
              <button onclick="switchTab('inbox')" class="text-purple-600 text-sm font-medium hover:underline">View all →</button>
            </div>
            <div id="home-messages" class="space-y-3">
              <div class="animate-pulse"><div class="h-12 bg-gray-200 rounded"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TRACTION TAB -->
      <div id="content-traction" class="tab-content hidden">
        <!-- Team To-Do List Overview -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-bold text-gray-900 flex items-center gap-2">
                  <i class="fas fa-tasks text-purple-600"></i>
                  Team To-Do List
                </h3>
                <p class="text-sm text-gray-500 mt-1">Based on goals - see who does what</p>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-right">
                  <div class="text-2xl font-bold text-purple-600" id="overall-completion">0%</div>
                  <div class="text-xs text-gray-500">Overall completion</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Overall Progress Bar -->
          <div class="px-6 py-4 bg-gray-50 border-b">
            <div class="flex items-center gap-4">
              <div class="flex-1">
                <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                  <div id="overall-progress-bar" class="h-full bg-gradient-to-r from-purple-500 to-indigo-600 transition-all duration-500" style="width: 0%"></div>
                </div>
              </div>
              <div class="text-sm text-gray-600">
                <span id="completed-count" class="font-semibold text-green-600">0</span> / <span id="total-count">0</span> completed
              </div>
            </div>
          </div>
          
          <!-- Team Members Progress -->
          <div id="team-todo-list" class="divide-y divide-gray-100">
            <div class="p-8 text-center text-gray-500">
              <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
              <p>Loading team to-do list...</p>
            </div>
          </div>
        </div>
        
        <!-- Weekly Traction Metrics Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
          <div class="p-6 border-b border-gray-200">
            <h3 class="font-bold text-gray-900 flex items-center gap-2">
              <i class="fas fa-rocket text-pink-600"></i>
              Weekly Traction Metrics
            </h3>
            <p class="text-sm text-gray-500 mt-1">Track your user types and revenue over time</p>
          </div>
          
          <!-- Traction Summary Cards -->
          <div class="p-6 grid grid-cols-2 md:grid-cols-5 gap-4 bg-gradient-to-br from-pink-50 to-purple-50">
            <div class="bg-white p-4 rounded-lg border border-pink-100 text-center">
              <p class="text-xs text-gray-500 uppercase mb-1">Revenue (4w)</p>
              <p id="traction-summary-revenue" class="text-2xl font-bold text-pink-600">€0</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-green-100 text-center">
              <p class="text-xs text-gray-500 uppercase mb-1">New Users (4w)</p>
              <p id="traction-summary-new" class="text-2xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-blue-100 text-center">
              <p class="text-xs text-gray-500 uppercase mb-1">Active Users</p>
              <p id="traction-summary-active" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-red-100 text-center">
              <p class="text-xs text-gray-500 uppercase mb-1">Churned (4w)</p>
              <p id="traction-summary-churned" class="text-2xl font-bold text-red-500">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg border border-purple-100 text-center">
              <p class="text-xs text-gray-500 uppercase mb-1">Net Growth</p>
              <p id="traction-summary-net" class="text-2xl font-bold text-purple-600">0</p>
            </div>
          </div>
          
          <!-- Traction Charts -->
          <div class="p-6 space-y-6">
            <!-- User Types Chart -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <i class="fas fa-users"></i> User Types Breakdown (Last 12 Weeks)
                <span class="ml-auto flex items-center gap-3 text-xs">
                  <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> New</span>
                  <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-500 rounded-full"></span> Active</span>
                  <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Churned</span>
                </span>
              </h4>
              <div style="height: 280px; position: relative;">
                <canvas id="dashboard-user-types-chart"></canvas>
              </div>
            </div>
            
            <!-- Net Growth & Revenue -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                  <i class="fas fa-chart-bar"></i> Net User Growth (New - Churned)
                </h4>
                <div style="height: 220px; position: relative;">
                  <canvas id="dashboard-net-growth-chart"></canvas>
                </div>
              </div>
              <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                  <i class="fas fa-euro-sign"></i> Revenue Trend
                </h4>
                <div style="height: 220px; position: relative;">
                  <canvas id="dashboard-revenue-trend-chart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-gray-900 mb-4">User Growth (Global)</h3>
            <div class="h-64"><canvas id="chart-users"></canvas></div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="font-bold text-gray-900 mb-4">Revenue Growth (Global)</h3>
            <div class="h-64"><canvas id="chart-revenue"></canvas></div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
          <div class="p-6 border-b border-gray-200 flex justify-between items-center">
            <h3 class="font-bold text-gray-900">Goals</h3>
            <button onclick="openGoalModal()" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg text-sm font-semibold"><i class="fas fa-plus mr-2"></i>New Goal</button>
          </div>
          <div class="flex border-b border-gray-200 px-6">
            <button onclick="filterGoals('all')" id="filter-all" class="filter-btn px-4 py-3 text-sm font-medium text-primary border-b-2 border-primary">All</button>
            <button onclick="filterGoals('active')" id="filter-active" class="filter-btn px-4 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent">Active</button>
            <button onclick="filterGoals('completed')" id="filter-completed" class="filter-btn px-4 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent">Completed</button>
          </div>
          <div id="goals-list" class="p-6"></div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h3 class="font-bold text-gray-900 mb-4">Record Metric</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <select id="metric-type" class="border border-gray-300 rounded-lg px-4 py-2">
              <option value="users">Users</option>
              <option value="revenue">Revenue ($)</option>
            </select>
            <input type="number" id="metric-value" placeholder="Value" min="0" class="border border-gray-300 rounded-lg px-4 py-2">
            <input type="date" id="metric-date" class="border border-gray-300 rounded-lg px-4 py-2">
            <button onclick="addMetric()" class="bg-primary text-white px-4 py-2 rounded-lg font-semibold"><i class="fas fa-plus mr-2"></i>Add</button>
          </div>
        </div>
      </div>
      `:""}

      <!-- INBOX TAB -->
      <div id="content-inbox" class="tab-content ${a==="founder"?"hidden":""}">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Conversations List -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-4 border-b border-gray-200">
              <h3 class="font-bold text-gray-900">Messages</h3>
              <div class="flex gap-2 mt-2">
                <button onclick="showInboxSection('active')" id="inbox-active-btn" class="flex-1 px-3 py-2 text-sm font-semibold text-primary border-b-2 border-primary bg-primary/5 rounded-t-lg">
                  Active Users
                </button>
                <button onclick="showInboxSection('conversations')" id="inbox-conversations-btn" class="flex-1 px-3 py-2 text-sm font-semibold text-gray-500 border-b-2 border-transparent rounded-t-lg hover:bg-gray-50">
                  Conversations
                </button>
              </div>
            </div>
            
            <!-- Active Users Section -->
            <div id="active-users-list" class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto">
              <div class="p-8 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading active users...</p>
              </div>
            </div>
            
            <!-- Conversations Section -->
            <div id="conversations-list" class="divide-y divide-gray-200 max-h-[600px] overflow-y-auto hidden">
              <div class="p-8 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading...</p>
              </div>
            </div>
          </div>
          
          <!-- Chat Area -->
          <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col" style="height: 600px;">
            <div id="chat-header" class="p-4 border-b border-gray-200">
              <p class="text-gray-500">Select a conversation</p>
            </div>
            <div id="chat-messages-area" class="flex-1 overflow-y-auto p-4 space-y-3">
              <div class="text-center text-gray-400 py-12">
                <i class="fas fa-comments text-5xl mb-4"></i>
                <p>Select a conversation to start chatting</p>
              </div>
            </div>
            <div id="chat-input-area" class="p-4 border-t border-gray-200 hidden">
              <div class="flex space-x-2">
                <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 border border-gray-300 rounded-lg px-4 py-2" onkeypress="if(event.key==='Enter')sendMessage()">
                <button onclick="sendMessage()" class="bg-primary text-white px-4 py-2 rounded-lg"><i class="fas fa-paper-plane"></i></button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DIRECTORY TAB -->
      <div id="content-directory" class="tab-content hidden">
        <div class="flex border-b border-gray-200 mb-6 overflow-x-auto scrollbar-hide">
          <button onclick="showDirectorySection('products')" id="mp-products-btn" class="mp-btn px-4 md:px-6 py-3 text-xs md:text-sm font-semibold text-primary border-b-2 border-primary whitespace-nowrap">Products</button>
          <button onclick="showDirectorySection('founders')" id="mp-founders-btn" class="mp-btn px-4 md:px-6 py-3 text-xs md:text-sm font-semibold text-gray-500 border-b-2 border-transparent whitespace-nowrap">Founders</button>
          <button onclick="showDirectorySection('investors')" id="mp-investors-btn" class="mp-btn px-4 md:px-6 py-3 text-xs md:text-sm font-semibold text-gray-500 border-b-2 border-transparent whitespace-nowrap">Investors</button>
          <button onclick="showDirectorySection('validators')" id="mp-validators-btn" class="mp-btn px-4 md:px-6 py-3 text-xs md:text-sm font-semibold text-gray-500 border-b-2 border-transparent whitespace-nowrap">Validators</button>
          <button onclick="showDirectorySection('scouts')" id="mp-scouts-btn" class="mp-btn px-4 md:px-6 py-3 text-xs md:text-sm font-semibold text-gray-500 border-b-2 border-transparent whitespace-nowrap">Scouts</button>
          <button onclick="showDirectorySection('partners')" id="mp-partners-btn" class="mp-btn px-4 md:px-6 py-3 text-xs md:text-sm font-semibold text-gray-500 border-b-2 border-transparent whitespace-nowrap">Partners</button>
          <button onclick="showDirectorySection('talent')" id="mp-talent-btn" class="mp-btn px-4 md:px-6 py-3 text-xs md:text-sm font-semibold text-gray-500 border-b-2 border-transparent whitespace-nowrap">Talent</button>
        </div>

        <!-- Products Section -->
        <div id="mp-products" class="mp-section">
          <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-6">
            <div class="flex flex-col sm:flex-row gap-3 flex-1">
              <select id="product-category" onchange="loadProducts()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm flex-1">
                <option value="">All Categories</option>
                <option value="SaaS">SaaS</option>
                <option value="Mobile">Mobile</option>
                <option value="E-commerce">E-commerce</option>
                <option value="Fintech">Fintech</option>
                <option value="Healthcare">Healthcare</option>
              </select>
              <select id="product-stage" onchange="loadProducts()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm flex-1">
                <option value="">All Stages</option>
                <option value="idea">Idea</option>
                <option value="mvp">MVP</option>
                <option value="beta">Beta</option>
                <option value="launched">Launched</option>
              </select>
            </div>
            <button onclick="openProductModal()" class="bg-primary text-white px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap w-full md:w-auto"><i class="fas fa-plus mr-2"></i>Add Product</button>
          </div>
          <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            <div class="animate-pulse"><div class="h-48 bg-gray-200 rounded-xl"></div></div>
          </div>
        </div>

        <!-- Validators Section -->
        <div id="mp-validators" class="mp-section hidden">
          <div class="mb-6">
            <input type="text" id="validator-search" placeholder="Search validators..." onkeyup="searchUsers('validators')" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm">
          </div>
          <div id="validators-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            <div class="animate-pulse"><div class="h-48 bg-gray-200 rounded-xl"></div></div>
          </div>
        </div>

        <!-- Founders Section -->
        <div id="mp-founders" class="mp-section hidden">
          <div class="mb-6">
            <input type="text" placeholder="Search founders..." onkeyup="searchUsers('founders')" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm">
          </div>
          <div id="founders-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            <div class="animate-pulse"><div class="h-48 bg-gray-200 rounded-xl"></div></div>
          </div>
        </div>

        <!-- Investors Section -->
        <div id="mp-investors" class="mp-section hidden">
          <div class="mb-6">
            <input type="text" placeholder="Search investors..." onkeyup="searchUsers('investors')" class="w-full border border-gray-300 rounded-lg px-4 py-2">
          </div>
          <div id="investors-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="animate-pulse"><div class="h-48 bg-gray-200 rounded-xl"></div></div>
          </div>
        </div>

        <!-- Scouts Section -->
        <div id="mp-scouts" class="mp-section hidden">
          <div class="mb-6">
            <input type="text" placeholder="Search scouts..." onkeyup="searchUsers('scouts')" class="w-full border border-gray-300 rounded-lg px-4 py-2">
          </div>
          <div id="scouts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="animate-pulse"><div class="h-48 bg-gray-200 rounded-xl"></div></div>
          </div>
        </div>

        <!-- Partners Section -->
        <div id="mp-partners" class="mp-section hidden">
          <div class="mb-6">
            <input type="text" placeholder="Search partners..." onkeyup="searchUsers('partners')" class="w-full border border-gray-300 rounded-lg px-4 py-2">
          </div>
          <div id="partners-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="animate-pulse"><div class="h-48 bg-gray-200 rounded-xl"></div></div>
          </div>
        </div>

        <!-- Talent Section -->
        <div id="mp-talent" class="mp-section hidden">
          <div class="mb-6">
            <input type="text" placeholder="Search talent..." onkeyup="searchUsers('talent')" class="w-full border border-gray-300 rounded-lg px-4 py-2">
          </div>
          <div id="talent-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="animate-pulse"><div class="h-48 bg-gray-200 rounded-xl"></div></div>
          </div>
        </div>
      </div>

      <!-- AI CMO TAB -->
      <div id="content-aicmo" class="tab-content hidden">
        <!-- Content will be loaded dynamically -->
      </div>

      <!-- AI CONNECTOR TAB -->
      <div id="content-connector" class="tab-content hidden">
        <div class="bg-gradient-to-br from-purple-50 via-indigo-50 to-blue-50 rounded-2xl p-6 mb-6 border border-indigo-100">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
              <i class="fas fa-network-wired text-white text-xl"></i>
            </div>
            <div>
              <h2 class="text-xl font-bold text-gray-900">AI SuperConnector</h2>
              <p class="text-sm text-gray-600">Tell me what connections you're looking for and I'll find the best matches</p>
            </div>
          </div>
          
          <!-- Chat Interface -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Chat Messages -->
            <div id="connector-chat-messages" class="h-80 overflow-y-auto p-4 space-y-4">
              <div class="flex gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                  <span class="text-lg">🌟</span>
                </div>
                <div class="bg-gray-100 rounded-2xl rounded-tl-none px-4 py-3 max-w-[80%]">
                  <p class="text-sm text-gray-800">👋 Hi! I'm your AI SuperConnector. I can help you find:</p>
                  <ul class="text-sm text-gray-700 mt-2 space-y-1">
                    <li>🚀 <strong>Founders</strong> with similar challenges or complementary skills</li>
                    <li>💰 <strong>Investors</strong> interested in your industry</li>
                    <li>✅ <strong>Validators</strong> expert in your field</li>
                    <li>🤝 <strong>Partners</strong> for collaboration opportunities</li>
                    <li>👥 <strong>Talent</strong> to join your team</li>
                  </ul>
                  <p class="text-sm text-gray-700 mt-2">Just tell me what you need! For example: <em>"Find me investors interested in SaaS"</em> or <em>"Connect me with founders in fintech"</em></p>
                </div>
              </div>
            </div>
            
            <!-- Chat Input -->
            <div class="border-t border-gray-200 p-4 bg-gray-50">
              <form id="connector-chat-form" onsubmit="sendConnectorMessage(event)" class="flex gap-3">
                <input 
                  type="text" 
                  id="connector-chat-input" 
                  placeholder="Tell me what connections you're looking for..." 
                  class="flex-1 border border-gray-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  autocomplete="off"
                >
                <button type="submit" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-xl font-semibold text-sm hover:from-purple-600 hover:to-indigo-700 transition-all shadow-md">
                  <i class="fas fa-paper-plane mr-2"></i>Send
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <!-- All Saved Suggestions -->
        <div class="mt-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-900">
              <i class="fas fa-bookmark text-purple-500 mr-2"></i>All Saved Suggestions
            </h3>
            <span id="all-suggestions-count" class="text-sm text-gray-500"></span>
          </div>
          <div id="all-suggestions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="bg-white rounded-xl p-6 border border-gray-200 text-center text-gray-500 col-span-full">
              <i class="fas fa-bookmark text-4xl text-gray-300 mb-3"></i>
              <p class="text-sm">Your saved connection suggestions will appear here</p>
              <p class="text-xs text-gray-400 mt-2">Use the chat above to find relevant connections</p>
            </div>
          </div>
        </div>
        
        <!-- Suggested Connections (from chat) -->
        <div id="connector-results" class="hidden mt-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-900">
              <i class="fas fa-users text-purple-500 mr-2"></i>New Suggested Connections
            </h3>
            <span id="connector-results-count" class="text-sm text-gray-500"></span>
          </div>
          <div id="connector-results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Results will be loaded here -->
          </div>
        </div>
      </div>

      <!-- AI CRM TAB -->
      <div id="content-crm" class="tab-content hidden">
        <div class="bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 rounded-2xl p-6 mb-6 border border-emerald-100">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                <i class="fas fa-users-cog text-white text-xl"></i>
              </div>
              <div>
                <h2 class="text-xl font-bold text-gray-900">AI CRM</h2>
                <p class="text-sm text-gray-600">Manage your contacts and relationships with AI assistance</p>
              </div>
            </div>
            <button onclick="openAddCRMContactModal()" class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-4 py-2 rounded-xl font-semibold text-sm hover:from-emerald-600 hover:to-teal-700 transition-all shadow-md">
              <i class="fas fa-plus mr-2"></i>Add Contact
            </button>
          </div>
          
          <!-- CRM Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
              <p class="text-xs text-gray-500 uppercase">Total</p>
              <p class="text-xl font-bold text-gray-900" id="crm-stat-total">0</p>
            </div>
            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
              <p class="text-xs text-gray-500 uppercase">New</p>
              <p class="text-xl font-bold text-emerald-600" id="crm-stat-new">0</p>
            </div>
            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
              <p class="text-xs text-gray-500 uppercase">Contacted</p>
              <p class="text-xl font-bold text-blue-600" id="crm-stat-contacted">0</p>
            </div>
            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
              <p class="text-xs text-gray-500 uppercase">Qualified</p>
              <p class="text-xl font-bold text-purple-600" id="crm-stat-qualified">0</p>
            </div>
            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
              <p class="text-xs text-gray-500 uppercase">Won</p>
              <p class="text-xl font-bold text-green-600" id="crm-stat-won">0</p>
            </div>
            <div class="bg-white rounded-xl p-3 shadow-sm border border-gray-100">
              <p class="text-xs text-gray-500 uppercase">From AI</p>
              <p class="text-xl font-bold text-indigo-600" id="crm-stat-ai">0</p>
            </div>
          </div>

          <!-- Filters -->
          <div class="flex flex-wrap gap-3 mb-4">
            <select id="crm-filter-status" onchange="filterCRMContacts('status', this.value)" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
              <option value="">All Statuses</option>
              <option value="new">New</option>
              <option value="contacted">Contacted</option>
              <option value="qualified">Qualified</option>
              <option value="negotiation">Negotiation</option>
              <option value="won">Won</option>
              <option value="lost">Lost</option>
            </select>
            <select id="crm-filter-type" onchange="filterCRMContacts('type', this.value)" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
              <option value="">All Types</option>
              <option value="lead">Lead</option>
              <option value="prospect">Prospect</option>
              <option value="customer">Customer</option>
              <option value="partner">Partner</option>
              <option value="investor">Investor</option>
              <option value="founder">Founder</option>
            </select>
            <select id="crm-filter-source" onchange="filterCRMContacts('source', this.value)" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white">
              <option value="">All Sources</option>
              <option value="ai_connector">AI Connector</option>
              <option value="manual">Manual</option>
              <option value="import">Import</option>
              <option value="linkedin">LinkedIn</option>
            </select>
            <div class="flex-1 min-w-[200px]">
              <input type="text" id="crm-search" placeholder="Search contacts..." onkeyup="debounceCRMSearch()" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
            </div>
          </div>
        </div>

        <!-- Contacts List -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div id="crm-contacts-list" class="divide-y divide-gray-100">
            <div class="p-8 text-center text-gray-500">
              <i class="fas fa-users text-4xl text-gray-300 mb-3"></i>
              <p>No contacts yet. Add your first contact or use AI Connector to find suggestions!</p>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="mt-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4">
            <i class="fas fa-history text-emerald-500 mr-2"></i>Recent Activity
          </h3>
          <div id="crm-recent-activities" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <p class="text-gray-500 text-sm text-center">No recent activities</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Connector Suggestion Detail Modal -->
    <div id="suggestion-detail-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-2xl w-full max-w-2xl shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-900">Connection Details</h3>
          <button onclick="closeSuggestionDetail()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">
            &times;
          </button>
        </div>
        <div id="suggestion-detail-content" class="p-6">
          <!-- Content will be loaded here -->
        </div>
      </div>
    </div>

    <!-- CRM Add/Edit Contact Modal -->
    <div id="crm-contact-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-2xl w-full max-w-2xl shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-900" id="crm-modal-title">Add Contact</h3>
          <button onclick="closeCRMContactModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        <form id="crm-contact-form" onsubmit="saveCRMContact(event)" class="p-6">
          <input type="hidden" id="crm-contact-id">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                <input type="text" id="crm-contact-name" required class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Contact name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="crm-contact-email" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="email@example.com">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                <input type="text" id="crm-contact-company" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Company name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                <input type="text" id="crm-contact-position" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Job title">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                <input type="tel" id="crm-contact-phone" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="+1 234 567 890">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn URL</label>
                <input type="url" id="crm-contact-linkedin" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="https://linkedin.com/in/...">
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                <select id="crm-contact-type" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="lead">Lead</option>
                  <option value="prospect">Prospect</option>
                  <option value="customer">Customer</option>
                  <option value="partner">Partner</option>
                  <option value="investor">Investor</option>
                  <option value="validator">Validator</option>
                  <option value="founder">Founder</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="crm-contact-status" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="new">New</option>
                  <option value="contacted">Contacted</option>
                  <option value="qualified">Qualified</option>
                  <option value="negotiation">Negotiation</option>
                  <option value="won">Won</option>
                  <option value="lost">Lost</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                <select id="crm-contact-priority" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
              <textarea id="crm-contact-notes" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Add notes about this contact..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Next Follow-up</label>
                <input type="date" id="crm-contact-followup" class="w-full border border-gray-300 rounded-lg px-4 py-2">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Deal Value ($)</label>
                <input type="number" id="crm-contact-value" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="0">
              </div>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
            <button type="button" onclick="closeCRMContactModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
            <button type="submit" class="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:from-emerald-600 hover:to-teal-700">
              <i class="fas fa-save mr-2"></i>Save Contact
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- CRM Contact Detail Modal -->
    <div id="crm-detail-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-2xl w-full max-w-3xl shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-900">Contact Details</h3>
          <button onclick="closeCRMDetailModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        <div id="crm-detail-content" class="p-6">
          <!-- Content loaded dynamically -->
        </div>
      </div>
    </div>

    <!-- CRM Add Activity Modal -->
    <div id="crm-activity-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-2xl w-full max-w-md shadow-xl">
        <div class="border-b border-gray-200 p-6 flex justify-between items-center">
          <h3 class="text-lg font-bold text-gray-900">Log Activity</h3>
          <button onclick="closeCRMActivityModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
        </div>
        <form id="crm-activity-form" onsubmit="saveCRMActivity(event)" class="p-6">
          <input type="hidden" id="crm-activity-contact-id">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Activity Type *</label>
              <select id="crm-activity-type" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                <option value="call">Phone Call</option>
                <option value="email">Email</option>
                <option value="meeting">Meeting</option>
                <option value="message">Message</option>
                <option value="linkedin">LinkedIn</option>
                <option value="note">Note</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
              <input type="text" id="crm-activity-subject" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Brief summary">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <textarea id="crm-activity-description" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Details..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Outcome</label>
              <select id="crm-activity-outcome" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                <option value="">Select outcome</option>
                <option value="positive">Positive</option>
                <option value="neutral">Neutral</option>
                <option value="negative">Negative</option>
                <option value="pending">Pending</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-6">
            <button type="button" onclick="closeCRMActivityModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
            <button type="submit" class="bg-emerald-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-emerald-600">
              <i class="fas fa-plus mr-2"></i>Log Activity
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Goal Modal -->
    <div id="goal-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
      <div class="bg-white rounded-2xl p-6 w-full max-w-2xl mx-4 shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-gray-900">New Goal</h3>
          <button onclick="closeGoalModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form id="goal-form" onsubmit="createGoal(event)">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                <select id="goal-category" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="Build">🔨 Build</option>
                  <option value="Test">🧪 Test</option>
                  <option value="Traction">📈 Traction</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Priority *</label>
                <select id="goal-priority" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="P0">P0 - Urgent & important</option>
                  <option value="P1">P1 - Urgent or important</option>
                  <option value="P2">P2 - Urgent but not important</option>
                  <option value="P3">P3 - Neither but cool</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
              <input type="text" id="goal-description" required placeholder="e.g., Product Design Roadmap for Cerios" class="w-full border border-gray-300 rounded-lg px-4 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Task *</label>
              <input type="text" id="goal-task" required placeholder="e.g., Create Marketing Plan Structure" class="w-full border border-gray-300 rounded-lg px-4 py-2">
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cadence</label>
                <select id="goal-cadence" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="One time">One time</option>
                  <option value="Recurrent">Recurrent</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assign To</label>
                <select id="goal-assigned-to" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="">Unassigned</option>
                  <!-- Team members will be loaded dynamically -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="goal-status" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="To start">To start</option>
                  <option value="WIP">WIP</option>
                  <option value="On Hold">On Hold</option>
                  <option value="Delayed">Delayed</option>
                  <option value="Blocked">Blocked</option>
                  <option value="Done">Done</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Week Of</label>
              <input type="text" id="goal-week" placeholder="e.g., December 30" class="w-full border border-gray-300 rounded-lg px-4 py-2">
            </div>
          </div>
          <div class="flex space-x-3 mt-6">
            <button type="button" onclick="closeGoalModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold">Create Goal</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Goal Calendar Modal -->
    <div id="goal-calendar-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
      <div class="bg-white rounded-2xl w-full max-w-lg mx-4 shadow-xl">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 rounded-t-2xl">
          <div class="flex justify-between items-center">
            <h3 id="goal-calendar-title" class="text-lg font-bold text-white truncate pr-4">Schedule Goal</h3>
            <button onclick="closeGoalCalendarModal()" class="text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
          </div>
        </div>
        <div class="p-4">
          <!-- Month Navigation -->
          <div class="flex items-center justify-between mb-4">
            <button onclick="changeGoalCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg">
              <i class="fas fa-chevron-left text-gray-600"></i>
            </button>
            <span id="goal-calendar-month" class="font-semibold text-gray-700">January 2026</span>
            <button onclick="changeGoalCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg">
              <i class="fas fa-chevron-right text-gray-600"></i>
            </button>
          </div>
          <!-- Day Headers -->
          <div class="grid grid-cols-7 gap-1 mb-2">
            <div class="text-center text-xs font-semibold text-gray-500 py-1">Mon</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-1">Tue</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-1">Wed</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-1">Thu</div>
            <div class="text-center text-xs font-semibold text-gray-500 py-1">Fri</div>
            <div class="text-center text-xs font-semibold text-gray-400 py-1">Sat</div>
            <div class="text-center text-xs font-semibold text-gray-400 py-1">Sun</div>
          </div>
          <!-- Calendar Grid -->
          <div id="goal-calendar-grid" class="grid grid-cols-7 gap-1">
            <!-- Days will be generated dynamically -->
          </div>
          <p class="text-xs text-gray-500 mt-4 text-center">Click on days to schedule/unschedule this task</p>
        </div>
      </div>
    </div>

    <!-- Goal Detail Modal -->
    <div id="goal-detail-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
      <div class="bg-white rounded-2xl w-full max-w-2xl mx-4 shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 rounded-t-2xl">
          <div class="flex justify-between items-start">
            <div>
              <span id="detail-category" class="px-2 py-1 bg-white/20 text-white text-xs rounded-full font-medium"></span>
              <h3 id="detail-task" class="text-xl font-bold text-white mt-2"></h3>
            </div>
            <button onclick="closeGoalDetailModal()" class="text-white/70 hover:text-white"><i class="fas fa-times text-xl"></i></button>
          </div>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="text-xs font-medium text-gray-500 uppercase">Description</label>
            <p id="detail-description" class="text-gray-800 mt-1"></p>
          </div>
          
          <!-- Hypothesis-specific fields - only shown for hypothesis category -->
          <div id="hypothesis-details" class="hidden space-y-4 bg-gradient-to-br from-purple-50 to-indigo-50 p-4 rounded-xl border border-purple-200">
            <h4 class="font-semibold text-purple-800 flex items-center gap-2">
              <i class="fas fa-flask"></i> Hypothesis Details
            </h4>
            <div class="grid grid-cols-1 gap-4">
              <div class="bg-white p-3 rounded-lg border border-purple-100">
                <label class="text-xs font-medium text-purple-600 uppercase flex items-center gap-1">
                  <i class="fas fa-chart-line text-xs"></i> Expected Behavior
                </label>
                <p id="detail-expected-behavior" class="text-gray-800 mt-1 text-sm"></p>
              </div>
              <div class="bg-white p-3 rounded-lg border border-purple-100">
                <label class="text-xs font-medium text-purple-600 uppercase flex items-center gap-1">
                  <i class="fas fa-check-circle text-xs"></i> Validation Signal
                </label>
                <p id="detail-validation-signal" class="text-gray-800 mt-1 text-sm"></p>
              </div>
              <div class="flex items-center gap-4">
                <div class="bg-white px-4 py-2 rounded-lg border border-purple-100 flex items-center gap-2">
                  <label class="text-xs font-medium text-purple-600 uppercase">Status</label>
                  <span id="detail-hypothesis-status" class="px-2 py-1 text-xs font-medium rounded-full"></span>
                </div>
                <div class="bg-white px-4 py-2 rounded-lg border border-purple-100 flex items-center gap-2">
                  <label class="text-xs font-medium text-purple-600 uppercase">Week</label>
                  <span id="detail-week-number" class="font-semibold text-sm"></span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Build-specific fields - only shown for build category -->
          <div id="build-details" class="hidden space-y-4 bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-xl border border-blue-200">
            <h4 class="font-semibold text-blue-800 flex items-center gap-2">
              <i class="fas fa-hammer"></i> Build Details
            </h4>
            <div class="grid grid-cols-1 gap-4">
              <div class="bg-white p-3 rounded-lg border border-blue-100">
                <label class="text-xs font-medium text-blue-600 uppercase flex items-center gap-1">
                  <i class="fas fa-code text-xs"></i> Tech Stack
                </label>
                <p id="detail-tech-stack" class="text-gray-800 mt-1 text-sm"></p>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-3 rounded-lg border border-blue-100">
                  <label class="text-xs font-medium text-blue-600 uppercase flex items-center gap-1">
                    <i class="fas fa-clock text-xs"></i> Hours Spent
                  </label>
                  <p id="detail-hours-spent" class="text-gray-800 mt-1 text-sm font-semibold"></p>
                </div>
                <div class="bg-white p-3 rounded-lg border border-blue-100">
                  <label class="text-xs font-medium text-blue-600 uppercase flex items-center gap-1">
                    <i class="fas fa-flask text-xs"></i> Related Hypothesis
                  </label>
                  <p id="detail-hypothesis-link" class="text-gray-800 mt-1 text-sm"></p>
                </div>
              </div>
              <div class="bg-white px-4 py-2 rounded-lg border border-blue-100 flex items-center gap-2">
                <label class="text-xs font-medium text-blue-600 uppercase">Week</label>
                <span id="detail-build-week-number" class="font-semibold text-sm"></span>
              </div>
            </div>
          </div>
          
          <!-- User Learning-specific fields - Wednesday -->
          <div id="user-learning-details" class="hidden space-y-4 bg-gradient-to-br from-green-50 to-emerald-50 p-4 rounded-xl border border-green-200">
            <h4 class="font-semibold text-green-800 flex items-center gap-2">
              <i class="fas fa-users"></i> User Conversations Details
            </h4>
            <div class="grid grid-cols-1 gap-4">
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-3 rounded-lg border border-green-100">
                  <label class="text-xs font-medium text-green-600 uppercase flex items-center gap-1">
                    <i class="fas fa-comments text-xs"></i> Users Spoken To
                  </label>
                  <p id="detail-users-spoken" class="text-gray-800 mt-1 text-2xl font-bold"></p>
                </div>
                <div class="bg-white p-3 rounded-lg border border-green-100">
                  <label class="text-xs font-medium text-green-600 uppercase flex items-center gap-1">
                    <i class="fas fa-user-check text-xs"></i> Users Who Used Product
                  </label>
                  <p id="detail-users-used" class="text-gray-800 mt-1 text-2xl font-bold"></p>
                </div>
              </div>
              <div class="bg-white p-3 rounded-lg border border-green-100">
                <label class="text-xs font-medium text-green-600 uppercase flex items-center gap-1">
                  <i class="fas fa-info-circle text-xs"></i> Details
                </label>
                <p id="detail-users-details" class="text-gray-800 mt-1 text-sm"></p>
              </div>
              <div class="bg-white p-3 rounded-lg border border-green-100">
                <label class="text-xs font-medium text-green-600 uppercase flex items-center gap-1">
                  <i class="fas fa-lightbulb text-xs"></i> Key Learning
                </label>
                <p id="detail-key-learning" class="text-gray-800 mt-1 text-sm"></p>
              </div>
              <div class="bg-white px-4 py-2 rounded-lg border border-green-100 flex items-center gap-2">
                <label class="text-xs font-medium text-green-600 uppercase">Week</label>
                <span id="detail-user-week-number" class="font-semibold text-sm"></span>
              </div>
            </div>
          </div>
          
          <!-- Insight-specific fields - Thursday -->
          <div id="insight-details" class="hidden space-y-4 bg-gradient-to-br from-orange-50 to-amber-50 p-4 rounded-xl border border-orange-200">
            <h4 class="font-semibold text-orange-800 flex items-center gap-2">
              <i class="fas fa-chart-pie"></i> User Behavior Insights
            </h4>
            <div class="grid grid-cols-1 gap-4">
              <div class="bg-white p-3 rounded-lg border border-orange-100">
                <label class="text-xs font-medium text-orange-600 uppercase flex items-center gap-1">
                  <i class="fas fa-users text-xs"></i> Users Interacted
                </label>
                <p id="detail-users-interacted" class="text-gray-800 mt-1 text-2xl font-bold"></p>
              </div>
              <div class="bg-white p-3 rounded-lg border border-orange-100">
                <label class="text-xs font-medium text-orange-600 uppercase flex items-center gap-1">
                  <i class="fas fa-redo text-xs"></i> Repeated Actions
                </label>
                <p id="detail-repeated-actions" class="text-gray-800 mt-1 text-sm"></p>
              </div>
              <div class="bg-white p-3 rounded-lg border border-orange-100">
                <label class="text-xs font-medium text-orange-600 uppercase flex items-center gap-1">
                  <i class="fas fa-sign-out-alt text-xs"></i> Drop-off Points
                </label>
                <p id="detail-drop-off-points" class="text-gray-800 mt-1 text-sm"></p>
              </div>
              <div class="bg-white p-3 rounded-lg border border-orange-100">
                <label class="text-xs font-medium text-orange-600 uppercase flex items-center gap-1">
                  <i class="fas fa-brain text-xs"></i> Key Insight
                </label>
                <p id="detail-key-insight" class="text-gray-800 mt-1 text-sm font-medium"></p>
              </div>
              <div class="bg-white px-4 py-2 rounded-lg border border-orange-100 flex items-center gap-2">
                <label class="text-xs font-medium text-orange-600 uppercase">Week</label>
                <span id="detail-insight-week-number" class="font-semibold text-sm"></span>
              </div>
            </div>
          </div>
          
          <!-- Traction-specific fields - Friday -->
          <div id="traction-details" class="hidden space-y-4 bg-gradient-to-br from-pink-50 to-rose-50 p-4 rounded-xl border border-pink-200">
            <h4 class="font-semibold text-pink-800 flex items-center gap-2">
              <i class="fas fa-rocket"></i> Weekly Traction Metrics
            </h4>
            <div class="grid grid-cols-1 gap-4">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-3 rounded-lg border border-pink-100">
                  <label class="text-xs font-medium text-pink-600 uppercase flex items-center gap-1">
                    <i class="fas fa-dollar-sign text-xs"></i> Revenue
                  </label>
                  <p id="detail-revenue" class="text-gray-800 mt-1 text-2xl font-bold"></p>
                </div>
                <div class="bg-white p-3 rounded-lg border border-pink-100">
                  <label class="text-xs font-medium text-pink-600 uppercase flex items-center gap-1">
                    <i class="fas fa-user-plus text-xs"></i> New Users
                  </label>
                  <p id="detail-new-users" class="text-gray-800 mt-1 text-2xl font-bold"></p>
                </div>
                <div class="bg-white p-3 rounded-lg border border-pink-100">
                  <label class="text-xs font-medium text-pink-600 uppercase flex items-center gap-1">
                    <i class="fas fa-users text-xs"></i> Active
                  </label>
                  <p id="detail-active-users" class="text-gray-800 mt-1 text-2xl font-bold"></p>
                </div>
                <div class="bg-white p-3 rounded-lg border border-pink-100">
                  <label class="text-xs font-medium text-pink-600 uppercase flex items-center gap-1">
                    <i class="fas fa-user-minus text-xs"></i> Churned
                  </label>
                  <p id="detail-churned" class="text-gray-800 mt-1 text-2xl font-bold"></p>
                </div>
              </div>
              
              <!-- Traction Trend Charts -->
              <div id="traction-charts-container" class="space-y-4">
                <!-- User Types Overview Chart -->
                <div class="bg-white p-4 rounded-lg border border-pink-100">
                  <h5 class="text-sm font-semibold text-pink-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-users"></i> User Types Breakdown (Last 12 Weeks)
                  </h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <p class="text-xs text-gray-500 mb-2 flex items-center gap-1">
                        <span class="w-3 h-3 bg-green-500 rounded-full inline-block"></span> New Users
                        <span class="w-3 h-3 bg-blue-500 rounded-full inline-block ml-2"></span> Active
                        <span class="w-3 h-3 bg-red-500 rounded-full inline-block ml-2"></span> Churned
                      </p>
                      <div style="height: 220px; position: relative;">
                        <canvas id="traction-user-types-chart"></canvas>
                      </div>
                    </div>
                    <div>
                      <p class="text-xs text-gray-500 mb-2">Net User Growth</p>
                      <div style="height: 220px; position: relative;">
                        <canvas id="traction-net-growth-chart"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Revenue Trend -->
                <div class="bg-white p-4 rounded-lg border border-pink-100">
                  <h5 class="text-sm font-semibold text-pink-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-line"></i> Revenue Trend (Last 12 Weeks)
                  </h5>
                  <div style="height: 200px; position: relative;">
                    <canvas id="traction-revenue-chart"></canvas>
                  </div>
                </div>
                
                <!-- Detailed User Metrics -->
                <div class="bg-white p-4 rounded-lg border border-pink-100">
                  <h5 class="text-sm font-semibold text-pink-800 mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-bar"></i> Weekly User Metrics Comparison
                  </h5>
                  <div style="height: 220px; position: relative;">
                    <canvas id="traction-acquisition-chart"></canvas>
                  </div>
                </div>
              </div>
              
              <div class="bg-white p-3 rounded-lg border border-pink-100">
                <label class="text-xs font-medium text-pink-600 uppercase flex items-center gap-1">
                  <i class="fas fa-bolt text-xs"></i> Strongest Traction Signal
                </label>
                <p id="detail-traction-signal" class="text-gray-800 mt-1 text-sm font-medium"></p>
              </div>
              <div class="bg-white px-4 py-2 rounded-lg border border-pink-100 flex items-center gap-2">
                <label class="text-xs font-medium text-pink-600 uppercase">Week</label>
                <span id="detail-traction-week-number" class="font-semibold text-sm"></span>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-50 p-3 rounded-lg">
              <label class="text-xs font-medium text-gray-500 uppercase">Priority</label>
              <p id="detail-priority" class="font-semibold mt-1"></p>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <label class="text-xs font-medium text-gray-500 uppercase">Status</label>
              <p id="detail-status" class="font-semibold mt-1"></p>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <label class="text-xs font-medium text-gray-500 uppercase">Cadence</label>
              <p id="detail-cadence" class="font-semibold mt-1"></p>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <label class="text-xs font-medium text-gray-500 uppercase">DRI</label>
              <p id="detail-dri" class="font-semibold mt-1"></p>
            </div>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 uppercase mb-2 block">Scheduled Dates</label>
            <div id="detail-schedule" class="flex flex-wrap gap-2">
            </div>
          </div>
          <div class="flex gap-3 pt-4 border-t">
            <button onclick="editGoalFromDetail()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold">
              <i class="fas fa-edit mr-2"></i>Edit Goal
            </button>
            <button onclick="closeGoalDetailModal()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
      <div class="bg-white rounded-2xl p-6 w-full max-w-lg mx-4 shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">Add Product</h3>
          <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <form onsubmit="createProduct(event)">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
              <input type="text" id="product-title" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
              <textarea id="product-description" required rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                <select id="product-cat" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="SaaS">SaaS</option>
                  <option value="Mobile">Mobile</option>
                  <option value="E-commerce">E-commerce</option>
                  <option value="Fintech">Fintech</option>
                  <option value="Healthcare">Healthcare</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stage *</label>
                <select id="product-stage-input" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                  <option value="idea">Idea</option>
                  <option value="mvp">MVP</option>
                  <option value="beta">Beta</option>
                  <option value="launched">Launched</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">URL</label>
              <input type="url" id="product-url" placeholder="https://" class="w-full border border-gray-300 rounded-lg px-4 py-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Looking for</label>
              <input type="text" id="product-looking" placeholder="e.g., Beta testers, feedback" class="w-full border border-gray-300 rounded-lg px-4 py-2">
            </div>
          </div>
          <div class="flex space-x-3 mt-6">
            <button type="button" onclick="closeProductModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-semibold">Cancel</button>
            <button type="submit" class="flex-1 px-4 py-2 bg-primary text-white rounded-lg font-semibold">Create</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Handle token from URL (OAuth redirect)
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
          // Save to cookie
          document.cookie = 'authToken=' + urlToken + '; path=/; max-age=' + (60 * 60 * 24 * 7) + '; SameSite=Lax';
          // Save to localStorage as backup
          localStorage.setItem('authToken', urlToken);
          // Clean URL
          const cleanUrl = window.location.pathname + window.location.hash;
          window.history.replaceState({}, document.title, cleanUrl);
        }
      })();
      
      // Helper to get auth token
      function getAuthToken() {
        const cookieMatch = document.cookie.match(/authToken=([^;]+)/);
        return cookieMatch ? cookieMatch[1] : localStorage.getItem('authToken');
      }
      
      axios.defaults.withCredentials = true;
      
      // Add auth token interceptor
      axios.interceptors.request.use(config => {
        const token = getAuthToken();
        if (token) {
          config.headers.Authorization = 'Bearer ' + token;
        }
        return config;
      }, error => Promise.reject(error));
      
      let allGoals = [], metricsHistory = [], conversations = [], currentConversation = null;
      let currentFilter = 'all';
      let usersChart = null, revenueChart = null;
      let activeUsers = [];
      let currentInboxSection = 'active';

      // Tab switching
      function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('text-primary', 'border-primary');
          b.classList.add('text-gray-500', 'border-transparent');
        });
        document.getElementById('tab-' + tab)?.classList.remove('text-gray-500', 'border-transparent');
        document.getElementById('tab-' + tab)?.classList.add('text-primary', 'border-primary');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        const contentEl = document.getElementById('content-' + tab);
        if (contentEl) contentEl.classList.remove('hidden');
        
        if (tab === 'traction') {
          setTimeout(initCharts, 100);
          renderTeamTodoList();
          loadDashboardTractionCharts();
        }
        if (tab === 'inbox') loadConversations();
        if (tab === 'directory') { loadProducts(); loadValidators(); }
        if (tab === 'connector') initConnector();
        if (tab === 'crm') initCRM();
      }
      
      // ============== AI CONNECTOR FUNCTIONS ==============
      let connectorSessionId = null;
      let connectorMessages = [];
      let allConnectorSuggestions = [];
      
      function initConnector() {
        // Generate session ID if not exists
        if (!connectorSessionId) {
          connectorSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Load recent suggestions from database
        loadRecentSuggestions();
      }
      
      async function sendConnectorMessage(event) {
        event.preventDefault();
        const input = document.getElementById('connector-chat-input');
        const message = input.value.trim();
        if (!message) return;
        
        // Clear input
        input.value = '';
        
        // Add user message to chat
        addConnectorMessage(message, 'user');
        
        // Show loading indicator
        const loadingId = 'loading_' + Date.now();
        addConnectorLoadingMessage(loadingId);
        
        try {
          // Call the connector API
          const response = await axios.post('/api/connector/chat', {
            message: message,
            session_id: connectorSessionId
          });
          
          // Remove loading indicator
          removeConnectorLoadingMessage(loadingId);
          
          const data = response.data;
          
          // Add AI response
          addConnectorMessage(data.response || data.message, 'ai');
          
          // Show matches if any
          if (data.matches && data.matches.length > 0) {
            showConnectorMatches(data.matches);
          }
        } catch (error) {
          removeConnectorLoadingMessage(loadingId);
          console.error('Connector error:', error);
          addConnectorMessage('Sorry, there was an error processing your request. Please try again.', 'ai');
        }
      }
      
      function addConnectorMessage(text, sender) {
        const container = document.getElementById('connector-chat-messages');
        const isUser = sender === 'user';
        
        const messageHtml = \`
          <div class="flex gap-3 \${isUser ? 'justify-end' : ''}">
            \${!isUser ? \`
              <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-lg">🌟</span>
              </div>
            \` : ''}
            <div class="\${isUser ? 'bg-purple-500 text-white rounded-2xl rounded-tr-none' : 'bg-gray-100 rounded-2xl rounded-tl-none'} px-4 py-3 max-w-[80%]">
              <p class="text-sm \${isUser ? 'text-white' : 'text-gray-800'}">\${text}</p>
            </div>
            \${isUser ? \`
              <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-user text-gray-500 text-sm"></i>
              </div>
            \` : ''}
          </div>
        \`;
        
        container.insertAdjacentHTML('beforeend', messageHtml);
        container.scrollTop = container.scrollHeight;
      }
      
      function addConnectorLoadingMessage(id) {
        const container = document.getElementById('connector-chat-messages');
        const loadingHtml = \`
          <div id="\${id}" class="flex gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-lg">🌟</span>
            </div>
            <div class="bg-gray-100 rounded-2xl rounded-tl-none px-4 py-3">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
              </div>
            </div>
          </div>
        \`;
        container.insertAdjacentHTML('beforeend', loadingHtml);
        container.scrollTop = container.scrollHeight;
      }
      
      function removeConnectorLoadingMessage(id) {
        const loadingEl = document.getElementById(id);
        if (loadingEl) loadingEl.remove();
      }
      
      function showConnectorMatches(matches) {
        const container = document.getElementById('connector-results');
        const grid = document.getElementById('connector-results-grid');
        const countEl = document.getElementById('connector-results-count');
        
        // Store matches for later use (e.g., adding to CRM)
        allConnectorSuggestions = matches;
        
        container.classList.remove('hidden');
        countEl.textContent = \`\${matches.length} match\${matches.length !== 1 ? 'es' : ''} found\`;
        
        grid.innerHTML = matches.map(match => {
          const initials = (match.name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
          const avatarColors = ['bg-purple-500', 'bg-blue-500', 'bg-green-500', 'bg-orange-500', 'bg-pink-500', 'bg-indigo-500'];
          const colorIndex = (match.name || 'U').charCodeAt(0) % avatarColors.length;
          const userTypeLabels = {
            founder: { label: 'Founder', color: 'bg-blue-100 text-blue-700' },
            investor: { label: 'Investor', color: 'bg-green-100 text-green-700' },
            validator: { label: 'Validator', color: 'bg-purple-100 text-purple-700' },
            partner: { label: 'Partner', color: 'bg-orange-100 text-orange-700' },
            talent: { label: 'Talent', color: 'bg-pink-100 text-pink-700' },
            scout: { label: 'Scout', color: 'bg-yellow-100 text-yellow-700' }
          };
          const typeInfo = userTypeLabels[match.user_type] || { label: match.user_type || 'User', color: 'bg-gray-100 text-gray-700' };
          const score = match.score ? Math.round(match.score * 100) : null;
          
          return \`
            <div class="bg-white rounded-xl p-5 border border-gray-200 hover:shadow-lg transition-all hover:border-purple-200">
              <div class="flex items-start gap-4 mb-4">
                <div class="w-14 h-14 \${avatarColors[colorIndex]} rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                  \${match.avatar ? \`<img src="\${match.avatar}" class="w-14 h-14 rounded-full object-cover">\` : initials}
                </div>
                <div class="flex-1 min-w-0">
                  <h4 class="font-semibold text-gray-900 truncate">\${match.name || 'Anonymous'}</h4>
                  <span class="\${typeInfo.color} text-xs font-medium px-2 py-0.5 rounded-full">\${typeInfo.label}</span>
                  \${score ? \`<span class="ml-2 text-xs text-purple-600 font-medium">\${score}% match</span>\` : ''}
                </div>
              </div>
              <div class="space-y-2 mb-4">
                \${match.industry ? \`
                  <div class="flex items-center gap-2 text-sm text-gray-600">
                    <i class="fas fa-briefcase text-gray-400 w-4"></i>
                    <span>\${match.industry}</span>
                  </div>
                \` : ''}
                \${match.country ? \`
                  <div class="flex items-center gap-2 text-sm text-gray-600">
                    <i class="fas fa-map-marker-alt text-gray-400 w-4"></i>
                    <span>\${match.country}</span>
                  </div>
                \` : ''}
                \${match.stage ? \`
                  <div class="flex items-center gap-2 text-sm text-gray-600">
                    <i class="fas fa-rocket text-gray-400 w-4"></i>
                    <span>\${match.stage}</span>
                  </div>
                \` : ''}
              </div>
              \${match.reason ? \`
                <div class="bg-purple-50 rounded-lg p-3 mb-4">
                  <p class="text-xs text-purple-700"><i class="fas fa-lightbulb mr-1"></i> <strong>Why connect:</strong> \${match.reason}</p>
                </div>
              \` : ''}
              <div class="flex gap-2">
                <button onclick="startConversation(\${match.id})" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:from-purple-600 hover:to-indigo-700 transition-all shadow-sm">
                  <i class="fas fa-comment-dots mr-2"></i>Chat
                </button>
                <button onclick="addSuggestionToCRM(\${match.id})" class="px-4 py-2 bg-emerald-50 text-emerald-700 rounded-lg text-sm font-semibold hover:bg-emerald-100 transition-all" title="Add to CRM">
                  <i class="fas fa-user-plus"></i>
                </button>
                <button onclick="viewProfile(\${match.id})" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-all" title="View Profile">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          \`;
        }).join('');
        
        // Also add to recent suggestions
        updateRecentSuggestions(matches);
      }
      
      function updateRecentSuggestions(matches) {
        const container = document.getElementById('recent-connections');
        if (matches.length === 0) return;
        
        // Get existing recent or start fresh
        let recent = JSON.parse(localStorage.getItem('recentConnectorSuggestions') || '[]');
        
        // Add new matches at the beginning
        matches.forEach(m => {
          // Remove duplicate if exists
          recent = recent.filter(r => r.id !== m.id);
          recent.unshift({ ...m, timestamp: Date.now() });
        });
        
        // Keep only last 9 suggestions
        recent = recent.slice(0, 9);
        localStorage.setItem('recentConnectorSuggestions', JSON.stringify(recent));
        
        renderRecentSuggestions(recent);
      }
      
      function renderRecentSuggestions(suggestions) {
        const container = document.getElementById('recent-connections');
        if (!container) {
          console.warn('recent-connections element not found');
          return;
        }
        
        if (!suggestions || suggestions.length === 0) {
          container.innerHTML = \`
            <div class="bg-white rounded-xl p-4 border border-gray-200 text-center text-gray-500">
              <i class="fas fa-search text-3xl text-gray-300 mb-2"></i>
              <p class="text-sm">Your suggested connections will appear here</p>
            </div>
          \`;
          return;
        }
        
        const userTypeLabels = {
          founder: { label: 'Founder', color: 'bg-blue-100 text-blue-700' },
          investor: { label: 'Investor', color: 'bg-green-100 text-green-700' },
          validator: { label: 'Validator', color: 'bg-purple-100 text-purple-700' },
          partner: { label: 'Partner', color: 'bg-orange-100 text-orange-700' },
          talent: { label: 'Talent', color: 'bg-pink-100 text-pink-700' }
        };
        
        container.innerHTML = \`
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            \${suggestions.slice(0, 6).map(s => {
              const initials = (s.name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
              const typeInfo = userTypeLabels[s.user_type] || { label: s.user_type || 'User', color: 'bg-gray-100 text-gray-700' };
              return \`
                <div class="bg-white rounded-lg p-3 border border-gray-200 hover:border-purple-200 transition-all cursor-pointer" onclick="viewProfile(\${s.id})">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-indigo-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                      \${initials}
                    </div>
                    <div class="flex-1 min-w-0">
                      <p class="font-medium text-gray-900 text-sm truncate">\${s.name || 'Anonymous'}</p>
                      <span class="\${typeInfo.color} text-xs px-2 py-0.5 rounded-full">\${typeInfo.label}</span>
                    </div>
                  </div>
                </div>
              \`;
            }).join('')}
          </div>
        \`;
      }
      
      // Load recent suggestions on page load
      async function loadRecentSuggestions() {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          if (!token) return;
          
          const res = await axios.get('/api/connector/suggestions', {
            headers: { Authorization: 'Bearer ' + token }
          });
          
          if (res.data.success && res.data.suggestions.length > 0) {
            renderAllSuggestions(res.data.suggestions);
          } else {
            renderAllSuggestions([]);
          }
        } catch (error) {
          console.error('Error loading suggestions:', error);
          renderAllSuggestions([]);
        }
      }

      // Render all saved suggestions
      function renderAllSuggestions(suggestions) {
        const container = document.getElementById('all-suggestions-list');
        const countEl = document.getElementById('all-suggestions-count');
        
        if (!container) {
          console.warn('all-suggestions-list element not found');
          return;
        }
        if (!countEl) {
          console.warn('all-suggestions-count element not found');
          return;
        }
        
        if (!suggestions || suggestions.length === 0) {
          container.innerHTML = '<div class="bg-white rounded-xl p-6 border border-gray-200 text-center text-gray-500 col-span-full">' +
            '<i class="fas fa-bookmark text-4xl text-gray-300 mb-3"></i>' +
            '<p class="text-sm">Your saved connection suggestions will appear here</p>' +
            '<p class="text-xs text-gray-400 mt-2">Use the chat above to find relevant connections</p>' +
            '</div>';
          countEl.textContent = '';
          return;
        }

        countEl.textContent = suggestions.length + ' suggestion' + (suggestions.length !== 1 ? 's' : '');
        
        container.innerHTML = suggestions.map(s => {
          const avatar = s.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(s.name || 'User');
          const name = s.name || 'Unknown';
          const userType = s.user_type || 'founder';
          const score = s.score ? Math.round(s.score) : 0;
          
          let html = '<div class="bg-white rounded-xl p-4 border border-gray-200 hover:border-purple-300 hover:shadow-md transition-all cursor-pointer" onclick="showSuggestionDetail(' + s.id + ')">';
          html += '<div class="flex items-start gap-3">';
          html += '<img src="' + avatar + '" alt="' + name + '" class="w-12 h-12 rounded-full object-cover flex-shrink-0">';
          html += '<div class="flex-1 min-w-0">';
          html += '<h4 class="font-semibold text-gray-900 truncate">' + name + '</h4>';
          html += '<p class="text-xs text-gray-500 capitalize">' + userType + '</p>';
          if (s.industry) html += '<p class="text-xs text-purple-600 mt-1"><i class="fas fa-briefcase mr-1"></i>' + s.industry + '</p>';
          if (s.country) html += '<p class="text-xs text-gray-500 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>' + s.country + '</p>';
          html += '</div></div>';
          
          if (s.reason) {
            html += '<div class="mt-3 bg-purple-50 rounded-lg p-2">';
            html += '<p class="text-xs text-purple-700 line-clamp-2"><i class="fas fa-lightbulb mr-1"></i>' + s.reason + '</p>';
            html += '</div>';
          }
          
          if (s.score) {
            html += '<div class="mt-2 flex items-center gap-2">';
            html += '<div class="flex-1 bg-gray-200 rounded-full h-1.5">';
            html += '<div class="bg-gradient-to-r from-purple-500 to-indigo-600 h-1.5 rounded-full" style="width: ' + score + '%"></div>';
            html += '</div><span class="text-xs font-semibold text-gray-600">' + score + '%</span></div>';
          }
          
          html += '<div class="mt-3 flex gap-2">';
          html += '<button onclick="event.stopPropagation(); startConversation(' + s.id + ')" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-2 px-3 rounded-lg text-xs font-semibold hover:from-purple-600 hover:to-indigo-700 transition-all shadow-sm">';
          html += '<i class="fas fa-comment-dots mr-1"></i>Chat</button>';
          html += '<button onclick="event.stopPropagation(); addSuggestionToCRM(' + s.id + ')" class="px-3 py-2 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-semibold hover:bg-emerald-100 transition-all" title="Add to CRM">';
          html += '<i class="fas fa-user-plus"></i></button>';
          html += '<button onclick="event.stopPropagation(); showSuggestionDetail(' + s.id + ')" class="px-3 py-2 border border-gray-300 rounded-lg text-xs font-semibold text-gray-700 hover:bg-gray-50 transition-all" title="View Details">';
          html += '<i class="fas fa-info-circle"></i></button>';
          html += '</div></div>';
          
          return html;
        }).join('');
      }

      // Show suggestion detail modal
      async function showSuggestionDetail(userId) {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          const res = await axios.get('/api/connector/suggestions', {
            headers: { Authorization: 'Bearer ' + token }
          });
          
          const suggestion = res.data.suggestions.find(s => s.id === userId);
          if (!suggestion) {
            alert('Suggestion not found');
            return;
          }

          const modal = document.getElementById('suggestion-detail-modal');
          const content = document.getElementById('suggestion-detail-content');
          
          const avatar = suggestion.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(suggestion.name || 'User');
          const name = suggestion.name || 'Unknown';
          const userType = suggestion.user_type || 'founder';
          const score = suggestion.score ? Math.round(suggestion.score) : 0;
          
          let html = '<div class="flex items-start gap-4 mb-6">';
          html += '<img src="' + avatar + '" alt="' + name + '" class="w-20 h-20 rounded-full object-cover">';
          html += '<div class="flex-1">';
          html += '<h4 class="text-2xl font-bold text-gray-900">' + name + '</h4>';
          html += '<p class="text-sm text-gray-500 capitalize mt-1">' + userType + '</p>';
          if (suggestion.industry) html += '<p class="text-sm text-purple-600 mt-2"><i class="fas fa-briefcase mr-2"></i>' + suggestion.industry + '</p>';
          if (suggestion.country) html += '<p class="text-sm text-gray-600 mt-1"><i class="fas fa-map-marker-alt mr-2"></i>' + suggestion.country + '</p>';
          html += '</div></div>';

          if (suggestion.score) {
            html += '<div class="mb-6">';
            html += '<div class="flex items-center justify-between mb-2">';
            html += '<span class="text-sm font-semibold text-gray-700">Match Score</span>';
            html += '<span class="text-lg font-bold text-purple-600">' + score + '%</span>';
            html += '</div>';
            html += '<div class="w-full bg-gray-200 rounded-full h-2.5">';
            html += '<div class="bg-gradient-to-r from-purple-500 to-indigo-600 h-2.5 rounded-full transition-all" style="width: ' + score + '%"></div>';
            html += '</div></div>';
          }

          if (suggestion.reason) {
            html += '<div class="mb-6">';
            html += '<h5 class="text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Why Connect</h5>';
            html += '<div class="bg-purple-50 rounded-lg p-4">';
            html += '<p class="text-sm text-purple-700">' + suggestion.reason + '</p>';
            html += '</div></div>';
          }

          if (suggestion.bio) {
            html += '<div class="mb-6">';
            html += '<h5 class="text-sm font-semibold text-gray-700 mb-2"><i class="fas fa-user text-blue-500 mr-2"></i>About</h5>';
            html += '<p class="text-sm text-gray-600">' + suggestion.bio + '</p>';
            html += '</div>';
          }

          if (suggestion.created_at) {
            html += '<div class="mb-6">';
            html += '<p class="text-xs text-gray-500"><i class="fas fa-clock mr-2"></i>Suggested ' + new Date(suggestion.created_at).toLocaleDateString() + '</p>';
            html += '</div>';
          }

          html += '<div class="flex gap-3">';
          html += '<button onclick="startConversation(' + suggestion.id + '); closeSuggestionDetail();" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:from-purple-600 hover:to-indigo-700 transition-all shadow-md">';
          html += '<i class="fas fa-comment-dots mr-2"></i>Start Chat</button>';
          html += '<button onclick="addSuggestionToCRM(' + suggestion.id + '); closeSuggestionDetail();" class="px-4 py-3 bg-emerald-50 text-emerald-700 rounded-lg font-semibold hover:bg-emerald-100 transition-all">';
          html += '<i class="fas fa-user-plus mr-2"></i>Add to CRM</button>';
          html += '<button onclick="viewProfile(' + suggestion.id + '); closeSuggestionDetail();" class="px-4 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition-all">';
          html += '<i class="fas fa-eye mr-2"></i>Profile</button>';
          html += '</div>';
          
          content.innerHTML = html;
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        } catch (error) {
          console.error('Error loading suggestion detail:', error);
          alert('Error loading suggestion details');
        }
      }

      // Close suggestion detail modal
      function closeSuggestionDetail() {
        const modal = document.getElementById('suggestion-detail-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      // ============== END AI CONNECTOR FUNCTIONS ==============

      // ============== AI CRM FUNCTIONS ==============
      let crmContacts = [];
      let crmStats = {};
      let currentCRMFilters = { status: '', type: '', source: '' };
      let crmSearchTimeout = null;

      async function initCRM() {
        await Promise.all([loadCRMContacts(), loadCRMStats()]);
      }

      async function loadCRMContacts() {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          if (!token) return;
          
          let url = '/api/crm/contacts?';
          if (currentCRMFilters.status) url += 'status=' + currentCRMFilters.status + '&';
          if (currentCRMFilters.type) url += 'contact_type=' + currentCRMFilters.type + '&';
          if (currentCRMFilters.source) url += 'source=' + currentCRMFilters.source + '&';
          
          const searchInput = document.getElementById('crm-search');
          if (searchInput && searchInput.value) url += 'search=' + encodeURIComponent(searchInput.value) + '&';
          
          const res = await axios.get(url, {
            headers: { Authorization: 'Bearer ' + token }
          });
          
          crmContacts = res.data.contacts || [];
          renderCRMContacts();
        } catch (error) {
          console.error('Error loading CRM contacts:', error);
        }
      }

      async function loadCRMStats() {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          if (!token) return;
          
          const res = await axios.get('/api/crm/stats', {
            headers: { Authorization: 'Bearer ' + token }
          });
          
          crmStats = res.data;
          updateCRMStatsUI();
        } catch (error) {
          console.error('Error loading CRM stats:', error);
        }
      }

      function updateCRMStatsUI() {
        const elements = {
          'crm-stat-total': crmStats.total || 0,
          'crm-stat-new': crmStats.by_status?.new || 0,
          'crm-stat-contacted': crmStats.by_status?.contacted || 0,
          'crm-stat-qualified': crmStats.by_status?.qualified || 0,
          'crm-stat-won': crmStats.by_status?.won || 0,
          'crm-stat-ai': crmStats.from_ai_connector || 0
        };
        
        Object.entries(elements).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = value;
        });
      }

      function renderCRMContacts() {
        const container = document.getElementById('crm-contacts-list');
        if (!container) return;
        
        if (!crmContacts || crmContacts.length === 0) {
          container.innerHTML = '<div class="bg-white rounded-xl p-8 text-center text-gray-500 col-span-full">' +
            '<i class="fas fa-address-book text-5xl text-gray-300 mb-4"></i>' +
            '<p class="font-medium">No contacts found</p>' +
            '<p class="text-sm mt-2">Add your first contact or use AI Connector to find suggestions!</p>' +
            '</div>';
          return;
        }
        
        container.innerHTML = crmContacts.map(contact => {
          const initials = (contact.name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
          const avatarColors = ['bg-emerald-500', 'bg-blue-500', 'bg-purple-500', 'bg-orange-500', 'bg-pink-500', 'bg-teal-500'];
          const colorIndex = (contact.name || 'U').charCodeAt(0) % avatarColors.length;
          
          const statusColors = {
            'new': 'bg-blue-100 text-blue-700',
            'contacted': 'bg-yellow-100 text-yellow-700',
            'qualified': 'bg-purple-100 text-purple-700',
            'negotiation': 'bg-orange-100 text-orange-700',
            'won': 'bg-green-100 text-green-700',
            'lost': 'bg-red-100 text-red-700'
          };
          
          const typeColors = {
            'lead': 'bg-gray-100 text-gray-700',
            'prospect': 'bg-blue-100 text-blue-700',
            'customer': 'bg-green-100 text-green-700',
            'partner': 'bg-orange-100 text-orange-700',
            'investor': 'bg-purple-100 text-purple-700',
            'validator': 'bg-pink-100 text-pink-700',
            'founder': 'bg-indigo-100 text-indigo-700'
          };
          
          const statusClass = statusColors[contact.status] || 'bg-gray-100 text-gray-700';
          const typeClass = typeColors[contact.contact_type] || 'bg-gray-100 text-gray-700';
          
          let html = '<div class="bg-white rounded-xl p-4 border border-gray-200 hover:border-emerald-300 hover:shadow-md transition-all cursor-pointer" onclick="openCRMContactDetail(' + contact.id + ')">';
          html += '<div class="flex items-start gap-3 mb-3">';
          html += '<div class="w-12 h-12 ' + avatarColors[colorIndex] + ' rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">' + initials + '</div>';
          html += '<div class="flex-1 min-w-0">';
          html += '<h4 class="font-semibold text-gray-900 truncate">' + (contact.name || 'Unknown') + '</h4>';
          if (contact.company) html += '<p class="text-sm text-gray-600 truncate">' + contact.company + '</p>';
          if (contact.position) html += '<p class="text-xs text-gray-500 truncate">' + contact.position + '</p>';
          html += '</div></div>';
          
          html += '<div class="flex flex-wrap gap-1 mb-3">';
          html += '<span class="px-2 py-0.5 text-xs font-medium rounded-full ' + statusClass + '">' + (contact.status || 'new') + '</span>';
          html += '<span class="px-2 py-0.5 text-xs font-medium rounded-full ' + typeClass + '">' + (contact.contact_type || 'lead') + '</span>';
          if (contact.source === 'ai_connector') html += '<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-emerald-100 text-emerald-700"><i class="fas fa-robot mr-1"></i>AI</span>';
          html += '</div>';
          
          if (contact.email || contact.phone) {
            html += '<div class="space-y-1 mb-3 text-xs text-gray-600">';
            if (contact.email) html += '<p class="truncate"><i class="fas fa-envelope mr-2 text-gray-400"></i>' + contact.email + '</p>';
            if (contact.phone) html += '<p><i class="fas fa-phone mr-2 text-gray-400"></i>' + contact.phone + '</p>';
            html += '</div>';
          }
          
          if (contact.next_follow_up) {
            const followupDate = new Date(contact.next_follow_up);
            const isOverdue = followupDate < new Date();
            html += '<div class="bg-' + (isOverdue ? 'red' : 'emerald') + '-50 rounded-lg p-2 mb-3">';
            html += '<p class="text-xs text-' + (isOverdue ? 'red' : 'emerald') + '-700"><i class="fas fa-calendar mr-1"></i> Follow-up: ' + followupDate.toLocaleDateString() + '</p>';
            html += '</div>';
          }
          
          html += '<div class="flex gap-2">';
          html += '<button onclick="event.stopPropagation(); openCRMActivityModal(' + contact.id + ')" class="flex-1 bg-emerald-50 text-emerald-700 py-2 px-3 rounded-lg text-xs font-semibold hover:bg-emerald-100 transition-all"><i class="fas fa-plus mr-1"></i>Log Activity</button>';
          html += '<button onclick="event.stopPropagation(); editCRMContact(' + contact.id + ')" class="px-3 py-2 border border-gray-300 rounded-lg text-xs text-gray-700 hover:bg-gray-50"><i class="fas fa-edit"></i></button>';
          html += '</div></div>';
          
          return html;
        }).join('');
      }

      function openAddCRMContactModal() {
        document.getElementById('crm-modal-title').textContent = 'Add Contact';
        document.getElementById('crm-contact-form').reset();
        document.getElementById('crm-contact-id').value = '';
        const modal = document.getElementById('crm-contact-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function closeCRMContactModal() {
        const modal = document.getElementById('crm-contact-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      async function editCRMContact(contactId) {
        const contact = crmContacts.find(c => c.id === contactId);
        if (!contact) return;
        
        document.getElementById('crm-modal-title').textContent = 'Edit Contact';
        document.getElementById('crm-contact-id').value = contact.id;
        document.getElementById('crm-contact-name').value = contact.name || '';
        document.getElementById('crm-contact-email').value = contact.email || '';
        document.getElementById('crm-contact-company').value = contact.company || '';
        document.getElementById('crm-contact-position').value = contact.position || '';
        document.getElementById('crm-contact-phone').value = contact.phone || '';
        document.getElementById('crm-contact-linkedin').value = contact.linkedin_url || '';
        document.getElementById('crm-contact-type').value = contact.contact_type || 'lead';
        document.getElementById('crm-contact-status').value = contact.status || 'new';
        document.getElementById('crm-contact-priority').value = contact.priority || 'medium';
        document.getElementById('crm-contact-notes').value = contact.notes || '';
        document.getElementById('crm-contact-followup').value = contact.next_follow_up ? contact.next_follow_up.split('T')[0] : '';
        document.getElementById('crm-contact-value').value = contact.deal_value || '';
        
        const modal = document.getElementById('crm-contact-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      async function saveCRMContact(event) {
        event.preventDefault();
        
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          if (!token) {
            console.error('[CRM] No auth token found');
            return;
          }
          
          const contactId = document.getElementById('crm-contact-id').value;
          console.log('[CRM] Saving contact:', contactId ? 'Update ID=' + contactId : 'New');
          
          const contactData = {
            name: document.getElementById('crm-contact-name').value,
            email: document.getElementById('crm-contact-email').value || null,
            company: document.getElementById('crm-contact-company').value || null,
            position: document.getElementById('crm-contact-position').value || null,
            phone: document.getElementById('crm-contact-phone').value || null,
            linkedin_url: document.getElementById('crm-contact-linkedin').value || null,
            contact_type: document.getElementById('crm-contact-type').value,
            status: document.getElementById('crm-contact-status').value,
            priority: document.getElementById('crm-contact-priority').value,
            notes: document.getElementById('crm-contact-notes').value || null,
            next_follow_up: document.getElementById('crm-contact-followup').value || null,
            deal_value: document.getElementById('crm-contact-value').value ? parseFloat(document.getElementById('crm-contact-value').value) : null
          };
          
          const url = contactId ? '/api/crm/contacts/' + contactId : '/api/crm/contacts';
          const method = contactId ? 'PUT' : 'POST';
          
          console.log('[CRM] Sending request:', method, url, contactData);
          const response = await axios({ method, url, data: contactData, headers: { Authorization: 'Bearer ' + token } });
          console.log('[CRM] Contact saved successfully:', response.data);
          
          closeCRMContactModal();
          await Promise.all([loadCRMContacts(), loadCRMStats()]);
        } catch (error) {
          console.error('[CRM] Error saving contact:', error);
          console.error('[CRM] Error details:', error.response?.data);
          alert('Error saving contact: ' + (error.response?.data?.error || error.message));
        }
      }

      async function openCRMContactDetail(contactId) {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          if (!token) return;
          
          const contact = crmContacts.find(c => c.id === contactId);
          if (!contact) return;
          
          // Fetch activities for this contact
          const activitiesRes = await axios.get('/api/crm/contacts/' + contactId + '/activities', {
            headers: { Authorization: 'Bearer ' + token }
          });
          const activities = activitiesRes.data.activities || [];
          
          const modal = document.getElementById('crm-detail-modal');
          const content = document.getElementById('crm-detail-content');
          
          const initials = (contact.name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
          
          let html = '<div class="flex items-start gap-4 mb-6">';
          html += '<div class="w-20 h-20 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">' + initials + '</div>';
          html += '<div class="flex-1">';
          html += '<h3 class="text-2xl font-bold text-gray-900">' + (contact.name || 'Unknown') + '</h3>';
          if (contact.position && contact.company) html += '<p class="text-gray-600">' + contact.position + ' at ' + contact.company + '</p>';
          else if (contact.company) html += '<p class="text-gray-600">' + contact.company + '</p>';
          html += '<div class="flex gap-2 mt-2">';
          html += '<span class="px-2 py-1 text-xs font-medium rounded-full bg-emerald-100 text-emerald-700">' + (contact.status || 'new') + '</span>';
          html += '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700">' + (contact.contact_type || 'lead') + '</span>';
          html += '</div></div>';
          html += '<button onclick="editCRMContact(' + contact.id + '); closeCRMDetailModal();" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-edit mr-2"></i>Edit</button>';
          html += '</div>';
          
          // Contact info grid
          html += '<div class="grid grid-cols-2 gap-4 mb-6">';
          if (contact.email) html += '<div class="bg-gray-50 rounded-lg p-3"><p class="text-xs text-gray-500 mb-1">Email</p><a href="mailto:' + contact.email + '" class="text-sm text-emerald-600 hover:underline">' + contact.email + '</a></div>';
          if (contact.phone) html += '<div class="bg-gray-50 rounded-lg p-3"><p class="text-xs text-gray-500 mb-1">Phone</p><a href="tel:' + contact.phone + '" class="text-sm text-emerald-600 hover:underline">' + contact.phone + '</a></div>';
          if (contact.linkedin_url) html += '<div class="bg-gray-50 rounded-lg p-3"><p class="text-xs text-gray-500 mb-1">LinkedIn</p><a href="' + contact.linkedin_url + '" target="_blank" class="text-sm text-blue-600 hover:underline">View Profile</a></div>';
          if (contact.deal_value) html += '<div class="bg-gray-50 rounded-lg p-3"><p class="text-xs text-gray-500 mb-1">Deal Value</p><p class="text-sm font-semibold text-green-600">$' + contact.deal_value.toLocaleString() + '</p></div>';
          if (contact.next_follow_up) html += '<div class="bg-gray-50 rounded-lg p-3"><p class="text-xs text-gray-500 mb-1">Next Follow-up</p><p class="text-sm text-gray-900">' + new Date(contact.next_follow_up).toLocaleDateString() + '</p></div>';
          html += '</div>';
          
          if (contact.notes) {
            html += '<div class="mb-6"><h4 class="text-sm font-semibold text-gray-700 mb-2">Notes</h4>';
            html += '<div class="bg-gray-50 rounded-lg p-3"><p class="text-sm text-gray-600 whitespace-pre-wrap">' + contact.notes + '</p></div></div>';
          }
          
          // Activities
          html += '<div class="mb-4"><div class="flex items-center justify-between mb-3">';
          html += '<h4 class="text-sm font-semibold text-gray-700">Activity Log</h4>';
          html += '<button onclick="openCRMActivityModal(' + contact.id + ')" class="text-sm text-emerald-600 hover:text-emerald-700"><i class="fas fa-plus mr-1"></i>Add Activity</button>';
          html += '</div>';
          
          if (activities.length === 0) {
            html += '<div class="bg-gray-50 rounded-lg p-4 text-center text-gray-500"><i class="fas fa-history text-2xl mb-2"></i><p class="text-sm">No activities logged yet</p></div>';
          } else {
            html += '<div class="space-y-3 max-h-60 overflow-y-auto">';
            activities.forEach(act => {
              const actIcons = { call: 'fa-phone', email: 'fa-envelope', meeting: 'fa-users', message: 'fa-comment', linkedin: 'fa-linkedin', note: 'fa-sticky-note' };
              const actIcon = actIcons[act.activity_type] || 'fa-circle';
              html += '<div class="flex gap-3 p-3 bg-gray-50 rounded-lg">';
              html += '<div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0"><i class="fas ' + actIcon + ' text-emerald-600 text-sm"></i></div>';
              html += '<div class="flex-1 min-w-0">';
              html += '<p class="text-sm font-medium text-gray-900">' + (act.subject || act.activity_type) + '</p>';
              if (act.description) html += '<p class="text-xs text-gray-600 mt-1">' + act.description + '</p>';
              html += '<p class="text-xs text-gray-400 mt-1">' + new Date(act.created_at).toLocaleString() + '</p>';
              html += '</div></div>';
            });
            html += '</div>';
          }
          html += '</div>';
          
          // Actions
          html += '<div class="flex gap-3 pt-4 border-t border-gray-200">';
          html += '<button onclick="openCRMActivityModal(' + contact.id + ')" class="flex-1 bg-gradient-to-r from-emerald-500 to-teal-600 text-white py-3 rounded-lg font-semibold hover:from-emerald-600 hover:to-teal-700"><i class="fas fa-plus mr-2"></i>Log Activity</button>';
          if (contact.email) html += '<a href="mailto:' + contact.email + '" class="px-4 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50"><i class="fas fa-envelope"></i></a>';
          if (contact.phone) html += '<a href="tel:' + contact.phone + '" class="px-4 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50"><i class="fas fa-phone"></i></a>';
          html += '</div>';
          
          content.innerHTML = html;
          modal.classList.remove('hidden');
          modal.classList.add('flex');
        } catch (error) {
          console.error('Error loading contact detail:', error);
        }
      }

      function closeCRMDetailModal() {
        const modal = document.getElementById('crm-detail-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      function openCRMActivityModal(contactId) {
        document.getElementById('crm-activity-form').reset();
        document.getElementById('crm-activity-contact-id').value = contactId;
        const modal = document.getElementById('crm-activity-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function closeCRMActivityModal() {
        const modal = document.getElementById('crm-activity-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      async function saveCRMActivity(event) {
        event.preventDefault();
        
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          if (!token) {
            console.error('[CRM] No auth token found');
            return;
          }
          
          const contactId = document.getElementById('crm-activity-contact-id').value;
          console.log('[CRM] Saving activity for contact:', contactId);
          
          const activityData = {
            activity_type: document.getElementById('crm-activity-type').value,
            subject: document.getElementById('crm-activity-subject').value || null,
            description: document.getElementById('crm-activity-description').value || null,
            outcome: document.getElementById('crm-activity-outcome').value || null
          };
          
          console.log('[CRM] Activity data:', activityData);
          const response = await axios.post('/api/crm/contacts/' + contactId + '/activities', activityData, {
            headers: { Authorization: 'Bearer ' + token }
          });
          console.log('[CRM] Activity saved successfully:', response.data);
          
          closeCRMActivityModal();
          // Refresh detail modal if open
          const detailModal = document.getElementById('crm-detail-modal');
          if (!detailModal.classList.contains('hidden')) {
            await openCRMContactDetail(parseInt(contactId));
          }
        } catch (error) {
          console.error('[CRM] Error saving activity:', error);
          console.error('[CRM] Error details:', error.response?.data);
          alert('Error saving activity: ' + (error.response?.data?.error || error.message));
        }
      }

      function filterCRMContacts(filterType, value) {
        console.log('[CRM] Applying filter:', filterType, '=', value);
        if (value === '' || value === 'all') {
          delete currentCRMFilters[filterType];
        } else {
          currentCRMFilters[filterType] = value;
        }
        console.log('[CRM] Current filters:', currentCRMFilters);
        loadCRMContacts();
      }

      function debounceCRMSearch() {
        clearTimeout(crmSearchTimeout);
        crmSearchTimeout = setTimeout(loadCRMContacts, 300);
      }

      // Add contact from AI Connector suggestion
      // userId = The suggested user's ID (from matches or saved suggestions)
      async function addSuggestionToCRM(userId, suggestionData) {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          if (!token) return;
          
          // If no suggestionData provided, fetch it first
          let data = suggestionData;
          if (!data) {
            // Find in allConnectorSuggestions (fresh matches from AI)
            data = allConnectorSuggestions.find(s => s.id === userId);
            if (!data) {
              // Try to get from saved suggestions
              const savedRes = await axios.get('/api/connector/suggestions', {
                headers: { Authorization: 'Bearer ' + token }
              });
              const saved = savedRes.data.suggestions || [];
              data = saved.find(s => s.id === userId || s.suggested_user_id === userId);
            }
          }
          
          // Build request with all available data
          // Note: userId is the suggested user's ID, suggestion_id is the DB record ID (if saved)
          const requestBody = {
            suggestion_id: data?.suggestion_id || null,
            suggested_user_id: userId,
            name: data?.name || 'Unknown Contact',
            email: data?.email || null,
            company: data?.industry || data?.company || null,
            reason: data?.reason || null,
            avatar_url: data?.avatar || data?.avatar_url || null
          };
          
          console.log('[CRM] Adding contact from connector:', requestBody);
          
          const res = await axios.post('/api/crm/from-connector', requestBody, {
            headers: { Authorization: 'Bearer ' + token }
          });
          
          if (res.data.success) {
            const msg = res.data.already_exists ? 'Contact already in CRM!' : 'Contact added to CRM!';
            alert(msg);
            // If CRM tab is active, refresh
            if (!document.getElementById('content-crm').classList.contains('hidden')) {
              await Promise.all([loadCRMContacts(), loadCRMStats()]);
            }
          }
        } catch (error) {
          console.error('Error adding to CRM:', error);
          alert('Error adding to CRM: ' + (error.response?.data?.error || error.message));
        }
      }

      // Expose CRM functions globally
      window.openAddCRMContactModal = openAddCRMContactModal;
      window.closeCRMContactModal = closeCRMContactModal;
      window.saveCRMContact = saveCRMContact;
      window.editCRMContact = editCRMContact;
      window.openCRMContactDetail = openCRMContactDetail;
      window.closeCRMDetailModal = closeCRMDetailModal;
      window.openCRMActivityModal = openCRMActivityModal;
      window.closeCRMActivityModal = closeCRMActivityModal;
      window.saveCRMActivity = saveCRMActivity;
      window.filterCRMContacts = filterCRMContacts;
      window.debounceCRMSearch = debounceCRMSearch;
      window.addSuggestionToCRM = addSuggestionToCRM;
      // ============== END AI CRM FUNCTIONS ==============
      
      // Expose Goals filter functions globally
      window.filterGoalsTable = filterGoalsTable;
      window.clearGoalsFilters = clearGoalsFilters;
      
      // Function to render Team To-Do List based on goals
      function renderTeamTodoList() {
        const container = document.getElementById('team-todo-list');
        if (!container || !allGoals.length) {
          if (container) {
            container.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="fas fa-clipboard-list text-4xl mb-3 text-gray-300"></i><p>No goals yet. Create goals to see your team to-do list.</p></div>';
          }
          return;
        }
        
        // Group goals by assigned user
        const byDRI = {};
        allGoals.forEach(goal => {
          const dri = goal.assigned_user_name || goal.dri || 'Unassigned';
          if (!byDRI[dri]) byDRI[dri] = [];
          byDRI[dri].push(goal);
        });
        
        // Calculate overall stats
        const totalGoals = allGoals.length;
        const completedGoals = allGoals.filter(g => g.goal_status === 'Done').length;
        const overallPercentage = totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0;
        
        // Update overall stats
        document.getElementById('overall-completion').textContent = overallPercentage + '%';
        document.getElementById('overall-progress-bar').style.width = overallPercentage + '%';
        document.getElementById('completed-count').textContent = completedGoals;
        document.getElementById('total-count').textContent = totalGoals;
        
        // Render each DRI section
        container.innerHTML = Object.entries(byDRI).map(([dri, goals]) => {
          const completed = goals.filter(g => g.goal_status === 'Done').length;
          const total = goals.length;
          const percentage = Math.round((completed / total) * 100);
          const wip = goals.filter(g => g.goal_status === 'WIP').length;
          const toStart = goals.filter(g => g.goal_status === 'To start').length;
          
          // Get initials for avatar
          const initials = dri.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
          const avatarColors = ['bg-purple-500', 'bg-blue-500', 'bg-green-500', 'bg-orange-500', 'bg-pink-500', 'bg-indigo-500'];
          const colorIndex = dri.charCodeAt(0) % avatarColors.length;
          
          return \`
            <div class="p-4 hover:bg-gray-50 transition-colors">
              <div class="flex items-center gap-4">
                <!-- Avatar -->
                <div class="w-12 h-12 \${avatarColors[colorIndex]} rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                  \${initials}
                </div>
                
                <!-- Info -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center justify-between mb-1">
                    <h4 class="font-semibold text-gray-900 truncate">\${dri}</h4>
                    <span class="text-sm font-bold \${percentage === 100 ? 'text-green-600' : percentage >= 50 ? 'text-blue-600' : 'text-orange-600'}">
                      \${percentage}%
                    </span>
                  </div>
                  
                  <!-- Progress bar -->
                  <div class="h-2 bg-gray-200 rounded-full overflow-hidden mb-2">
                    <div class="h-full transition-all duration-500 \${percentage === 100 ? 'bg-green-500' : 'bg-gradient-to-r from-purple-500 to-indigo-500'}" style="width: \${percentage}%"></div>
                  </div>
                  
                  <!-- Stats -->
                  <div class="flex items-center gap-3 text-xs">
                    <span class="text-gray-500">\${total} tasks</span>
                    <span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>\${completed} done</span>
                    \${wip > 0 ? \`<span class="text-blue-600"><i class="fas fa-spinner mr-1"></i>\${wip} WIP</span>\` : ''}
                    \${toStart > 0 ? \`<span class="text-orange-600"><i class="fas fa-clock mr-1"></i>\${toStart} to start</span>\` : ''}
                  </div>
                </div>
                
                <!-- Expand button -->
                <button onclick="toggleDRITasks('\${dri}')" class="text-gray-400 hover:text-purple-600 p-2">
                  <i class="fas fa-chevron-down" id="dri-chevron-\${dri.replace(/\\s/g, '-')}"></i>
                </button>
              </div>
              
              <!-- Task list (collapsible) -->
              <div id="dri-tasks-\${dri.replace(/\\s/g, '-')}" class="hidden mt-3 ml-16 space-y-2">
                \${goals.map(goal => {
                  const statusIcon = goal.goal_status === 'Done' ? 'fa-check-circle text-green-500' 
                    : goal.goal_status === 'WIP' ? 'fa-spinner text-blue-500' 
                    : 'fa-circle text-gray-300';
                  const taskClass = goal.goal_status === 'Done' ? 'line-through text-gray-400' : 'text-gray-700';
                  
                  return \`
                    <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 cursor-pointer" onclick="showGoalDetail(\${goal.id})">
                      <i class="fas \${statusIcon}"></i>
                      <span class="flex-1 text-sm \${taskClass}">\${goal.task || goal.description}</span>
                      <span class="px-2 py-0.5 text-xs rounded-full \${
                        goal.priority === 'P0' ? 'bg-yellow-100 text-yellow-700' 
                        : goal.priority === 'P1' ? 'bg-blue-100 text-blue-700'
                        : 'bg-gray-100 text-gray-600'
                      }">\${goal.priority || 'P0'}</span>
                    </div>
                  \`;
                }).join('')}
              </div>
            </div>
          \`;
        }).join('');
      }
      
      // Toggle DRI tasks visibility
      window.toggleDRITasks = function(dri) {
        const safeDri = dri.replace(/\\s/g, '-');
        const tasksEl = document.getElementById('dri-tasks-' + safeDri);
        const chevron = document.getElementById('dri-chevron-' + safeDri);
        
        if (tasksEl) {
          tasksEl.classList.toggle('hidden');
          if (chevron) {
            chevron.classList.toggle('fa-chevron-down');
            chevron.classList.toggle('fa-chevron-up');
          }
        }
      };
      
      function loadAICMOPage() {
        const contentEl = document.getElementById('content-aicmo');
        if (contentEl) {
          contentEl.innerHTML = window.renderAICMOPage ? window.renderAICMOPage({}) : '<div class="p-8"><h2>AI CMO</h2><p>Loading...</p></div>';
          // Load images after a small delay to ensure DOM is ready
          setTimeout(function() {
            loadAICMOImages('pending');
          }, 100);
        }
      }

      // AI CMO Functions - defined globally
      window.showAICMOSection = function(section) {
        ['pending', 'approved', 'rejected', 'history'].forEach(function(s) {
          var btn = document.getElementById('ai-cmo-' + s + '-btn');
          var content = document.getElementById('ai-cmo-' + s + '-content');
          
          if (s === section) {
            if (btn) {
              btn.classList.remove('text-gray-500', 'border-transparent');
              btn.classList.add('text-primary', 'border-primary', 'bg-primary/5');
            }
            if (content) content.classList.remove('hidden');
          } else {
            if (btn) {
              btn.classList.remove('text-primary', 'border-primary', 'bg-primary/5');
              btn.classList.add('text-gray-500', 'border-transparent');
            }
            if (content) content.classList.add('hidden');
          }
        });
        loadAICMOImages(section);
      };

      window.loadAICMOImages = loadAICMOImages;
      
      async function loadAICMOImages(section) {
        section = section || 'pending';
        try {
          var token = document.cookie.match(/authToken=([^;]+)/);
          var authToken = token ? token[1] : localStorage.getItem('authToken');
          console.log('[AI-CMO] Loading images, authToken exists:', !!authToken);
          
          var response = await fetch('/api/ai-cmo/images', {
            credentials: 'include',
            headers: { 
              'Authorization': 'Bearer ' + (authToken || ''),
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) throw new Error('Failed to load images');

          var data = await response.json();
          var images = data.images || [];

          var filtered = images.filter(function(img) {
            if (section === 'pending') return img.status === 'pending';
            if (section === 'approved') return img.status === 'approved';
            if (section === 'rejected') return img.status === 'rejected';
            return true;
          });

          var gridId = section === 'history' ? 'history-list' : section + '-images-grid';
          var emptyId = section + '-empty';
          var grid = document.getElementById(gridId);
          var empty = document.getElementById(emptyId);

          if (!grid) return;

          if (filtered.length === 0) {
            grid.innerHTML = '';
            grid.classList.add('hidden');
            if (empty) empty.classList.remove('hidden');
            return;
          }

          grid.classList.remove('hidden');
          if (empty) empty.classList.add('hidden');

          grid.innerHTML = filtered.map(function(img) {
            var actions = '';
            if (img.status === 'pending') {
              actions = '<button onclick="approveAICMOImage(\\'' + img.id + '\\')" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600"><i class="fas fa-check mr-1"></i> Aprobar</button>' +
                        '<button onclick="rejectAICMOImage(\\'' + img.id + '\\')" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600"><i class="fas fa-times mr-1"></i> Rechazar</button>';
            } else if (img.status === 'approved') {
              actions = '<button onclick="downloadAICMOImage(\\'' + img.image_url + '\\', \\'' + img.id + '\\')" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600"><i class="fas fa-download mr-1"></i> Descargar</button>';
            } else {
              actions = '<button onclick="regenerateAICMOImage(\\'' + img.id + '\\')" class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600"><i class="fas fa-redo mr-1"></i> Regenerar</button>';
            }
            return '<div class="bg-white rounded-xl shadow-sm overflow-hidden">' +
              '<img src="' + (img.image_url || '') + '" alt="Generated" class="w-full h-48 object-cover" onerror="this.style.display=\\'none\\'" />' +
              '<div class="p-4"><div class="flex gap-2">' + actions + '</div>' +
              '<p class="text-sm text-gray-600 mt-3 line-clamp-2">' + (img.prompt || 'Sin prompt') + '</p>' +
              '<p class="text-xs text-gray-400 mt-1">' + new Date(img.created_at).toLocaleDateString() + '</p>' +
              '</div></div>';
          }).join('');
        } catch (error) {
          console.error('Error loading AI CMO images:', error);
        }
      }

      window.approveAICMOImage = async function(imageId) {
        try {
          var token = document.cookie.match(/authToken=([^;]+)/);
          var authToken = token ? token[1] : localStorage.getItem('authToken');
          await fetch('/api/ai-cmo/images/' + imageId + '/approve', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          loadAICMOImages('pending');
        } catch (e) { alert('Error al aprobar'); }
      };

      window.rejectAICMOImage = async function(imageId) {
        try {
          var token = document.cookie.match(/authToken=([^;]+)/);
          var authToken = token ? token[1] : localStorage.getItem('authToken');
          await fetch('/api/ai-cmo/images/' + imageId + '/reject', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          loadAICMOImages('pending');
        } catch (e) { alert('Error al rechazar'); }
      };

      window.downloadAICMOImage = async function(imageUrl, imageId) {
        try {
          var response = await fetch(imageUrl);
          var blob = await response.blob();
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'marketing-' + imageId + '.png';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (e) { alert('Error al descargar'); }
      };

      window.regenerateAICMOImage = async function(imageId) {
        try {
          var token = document.cookie.match(/authToken=([^;]+)/);
          var authToken = token ? token[1] : localStorage.getItem('authToken');
          await fetch('/api/ai-cmo/images/' + imageId + '/regenerate', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + authToken }
          });
          loadAICMOImages('pending');
        } catch (e) { alert('Error al regenerar'); }
      };

      async function generateMarketingPlan() {
        const websiteUrl = prompt('Enter website URL to analyze:');
        if (!websiteUrl) return;
        
        const chatBox = document.getElementById('chat-messages');
        if (!chatBox) return;
        
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'flex gap-3 mb-4';
        loadingMsg.innerHTML = \`
          <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-semibold">AI</div>
          <div class="flex-1 bg-white rounded-lg p-4 shadow-sm"><div class="animate-pulse">Analyzing brand and generating images...</div></div>
        \`;
        chatBox.appendChild(loadingMsg);
        chatBox.scrollTop = chatBox.scrollHeight;
        
        try {
          // Use Cloudflare proxy endpoint instead of calling Railway directly
          const response = await axios.post('/api/chat-agent/brand/generate-images', {
            website_url: websiteUrl
          });
          
          loadingMsg.remove();
          
          const aiMsg = document.createElement('div');
          aiMsg.className = 'flex gap-3 mb-4';
          const formattedResponse = formatMarkdownToHTML(response.data.analysis || 'Analysis complete!');
          const imagesInfo = response.data.images_generated ? '<div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg"><p class="text-sm text-green-800"><i class="fas fa-check-circle mr-2"></i>' + response.data.images_generated + ' images generated! <a href="#" onclick="switchTab(String.fromCharCode(97,105,99,109,111)); return false;" class="font-semibold underline">View in AI CMO</a></p></div>' : '';
          aiMsg.innerHTML = \`
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-semibold">AI</div>
            <div class="flex-1 bg-white rounded-lg p-4 shadow-sm">\${formattedResponse}\${imagesInfo}</div>
          \`;
          chatBox.appendChild(aiMsg);
          chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
          loadingMsg.remove();
          const errorMsg = document.createElement('div');
          errorMsg.className = 'flex gap-3 mb-4';
          errorMsg.innerHTML = \`
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-500 flex items-center justify-center text-white font-semibold">!</div>
            <div class="flex-1 bg-red-50 rounded-lg p-4 border border-red-200"><p class="text-red-800">\${error.response?.data?.detail || error.message || 'Error generating marketing plan'}</p></div>
          \`;
          chatBox.appendChild(errorMsg);
          chatBox.scrollTop = chatBox.scrollHeight;
        }
      }

      function formatMarkdownToHTML(text) {
        if (!text) return '';
        var backtick = String.fromCharCode(96);
        var backtickRegex = new RegExp(backtick + '([^' + backtick + ']+)' + backtick, 'g');
        
        let formatted = text
          .replace(/^### (.+)$/gm, '<h3 class="text-xl font-bold mt-6 mb-3 text-gray-800">$1</h3>')
          .replace(/^#### (.+)$/gm, '<h4 class="text-lg font-semibold mt-4 mb-2 text-gray-700">$1</h4>')
          .replace(/^## (.+)$/gm, '<h2 class="text-2xl font-bold mt-8 mb-4 text-gray-900">$1</h2>')
          .replace(/^# (.+)$/gm, '<h1 class="text-3xl font-bold mt-8 mb-6 text-gray-900">$1</h1>')
          .replace(/[*][*](.+?)[*][*]/g, '<strong class="font-semibold text-gray-900">$1</strong>')
          .replace(/[*](.+?)[*]/g, '<em>$1</em>')
          .replace(/^- (.+)$/gm, '<li class="ml-6 mb-2 list-disc">$1</li>')
          .replace(backtickRegex, '<code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono text-purple-600">$1</code>');
        
        return '<div class="prose max-w-none">' + formatted + '</div>';
      }

      // Load dashboard data
      async function loadDashboardData() {
        try {
          const [goalsRes, metricsRes] = await Promise.all([
            axios.get('/api/dashboard/goals'),
            axios.get('/api/dashboard/metrics-history')
          ]);
          allGoals = goalsRes.data.goals || [];
          metricsHistory = metricsRes.data.metricsHistory || [];
          updateStats();
          renderGoals();
          renderHomeGoals();
          document.getElementById('metric-date').value = new Date().toISOString().split('T')[0];
        } catch (e) { console.error('Error loading data:', e); }
      }

      function updateStats() {
        const active = allGoals.filter(g => g.status === 'active' || g.status === 'in_progress');
        const completed = allGoals.filter(g => g.status === 'completed');
        document.getElementById('stat-goals').textContent = allGoals.length;
        document.getElementById('stat-active').textContent = active.length;
        document.getElementById('stat-completed').textContent = completed.length;
        document.getElementById('stat-completion').textContent = allGoals.length > 0 ? Math.round((completed.length / allGoals.length) * 100) + '%' : '0%';
        
        const userM = metricsHistory.filter(m => m.metric_name === 'users').sort((a,b) => new Date(b.recorded_date) - new Date(a.recorded_date));
        const revM = metricsHistory.filter(m => m.metric_name === 'revenue').sort((a,b) => new Date(b.recorded_date) - new Date(a.recorded_date));
        document.getElementById('stat-users').textContent = (userM[0]?.metric_value || 0).toLocaleString();
        document.getElementById('stat-revenue').textContent = '$' + (revM[0]?.metric_value || 0).toLocaleString();
        
        if (userM.length >= 2) {
          const g = ((userM[0].metric_value - userM[1].metric_value) / (userM[1].metric_value || 1) * 100).toFixed(1);
          document.getElementById('stat-users-growth').textContent = (g >= 0 ? '+' : '') + g + '%';
          document.getElementById('stat-users-growth').className = g >= 0 ? 'text-xs text-green-600 mt-2' : 'text-xs text-red-600 mt-2';
        }
        if (revM.length >= 2) {
          const g = ((revM[0].metric_value - revM[1].metric_value) / (revM[1].metric_value || 1) * 100).toFixed(1);
          document.getElementById('stat-revenue-growth').textContent = (g >= 0 ? '+' : '') + g + '%';
          document.getElementById('stat-revenue-growth').className = g >= 0 ? 'text-xs text-green-600 mt-2' : 'text-xs text-red-600 mt-2';
        }
      }

      function filterGoals(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => {
          b.classList.remove('text-primary', 'border-primary');
          b.classList.add('text-gray-500', 'border-transparent');
        });
        document.getElementById('filter-' + filter).classList.remove('text-gray-500', 'border-transparent');
        document.getElementById('filter-' + filter).classList.add('text-primary', 'border-primary');
        renderGoals();
      }

      function renderGoals() {
        let filtered = allGoals;
        if (currentFilter === 'active') filtered = allGoals.filter(g => g.status === 'active' || g.status === 'in_progress');
        if (currentFilter === 'completed') filtered = allGoals.filter(g => g.status === 'completed');
        
        const container = document.getElementById('goals-list');
        if (!filtered.length) {
          container.innerHTML = '<div class="text-center py-12 text-gray-500"><i class="fas fa-bullseye text-4xl mb-4 text-gray-300"></i><p>No goals found</p></div>';
          return;
        }
        
        container.innerHTML = filtered.map(g => {
          const progress = g.target_value > 0 ? Math.min(100, Math.round((g.current_value / g.target_value) * 100)) : 0;
          const done = g.status === 'completed';
          return \`
            <div class="border border-gray-200 rounded-lg p-4 mb-3 \${done ? 'bg-gray-50' : ''}">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">\${g.category || 'general'}</span>
                  \${done ? '<span class="text-xs font-medium px-2 py-0.5 rounded-full bg-green-100 text-green-700 ml-1"><i class="fas fa-check mr-1"></i>Done</span>' : ''}
                </div>
                <div class="flex gap-2">
                  \${!done ? \`<button onclick="updateGoal(\${g.id}, \${g.current_value})" class="text-gray-400 hover:text-primary"><i class="fas fa-edit"></i></button>
                  <button onclick="completeGoal(\${g.id})" class="text-gray-400 hover:text-green-600"><i class="fas fa-check-circle"></i></button>\` : ''}
                  <button onclick="deleteGoal(\${g.id})" class="text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                </div>
              </div>
              <h4 class="font-semibold \${done ? 'text-gray-500 line-through' : 'text-gray-900'}">\${g.description}</h4>
              <div class="flex items-center gap-4 mt-2">
                <div class="flex-1">
                  <div class="flex justify-between text-xs text-gray-500 mb-1"><span>\${g.current_value}/\${g.target_value}</span><span>\${progress}%</span></div>
                  <div class="h-2 bg-gray-200 rounded-full"><div class="h-full rounded-full \${done ? 'bg-green-500' : 'bg-primary'}" style="width:\${progress}%"></div></div>
                </div>
              </div>
            </div>\`;
        }).join('');
      }

      function renderHomeGoals() {
        const active = allGoals.filter(g => g.status === 'active' || g.status === 'in_progress').slice(0, 3);
        
        // Render goals table
        renderGoalsTable();
        
        // Update quick stats
        const completed = allGoals.filter(g => g.goal_status === 'Done' || g.status === 'completed');
        const wip = allGoals.filter(g => g.goal_status === 'WIP');
        document.getElementById('quick-total-goals').textContent = allGoals.length;
        document.getElementById('quick-completed-goals').textContent = completed.length;
        document.getElementById('quick-wip-goals').textContent = wip.length;
        
        const container = document.getElementById('home-messages');
        if (!active.length) {
          container.innerHTML = '<div class="text-center py-6 text-gray-500"><p class="text-sm">No active goals</p><button onclick="switchTab(\\'traction\\'); setTimeout(openGoalModal, 100);" class="text-purple-600 text-sm mt-2">Create your first goal</button></div>';
          return;
        }
        container.innerHTML = '<div class="text-center py-6 text-gray-400"><i class="fas fa-inbox text-3xl mb-2"></i><p class="text-sm">No messages yet</p></div>';
      }
      
      // Helper function to parse scheduled_dates (handles both string and array)
      function parseScheduledDates(value) {
        if (!value) return [];
        if (Array.isArray(value)) return value;
        try {
          const parsed = JSON.parse(value);
          return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
          return [];
        }
      }

      function renderGoalsTable() {
        const tbody = document.getElementById('goals-table-body');
        
        // Apply filters
        let filteredGoals = filterGoalsList();
        
        if (!filteredGoals.length) {
          tbody.innerHTML = \`
            <tr>
              <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                <i class="fas fa-bullseye text-4xl mb-2 text-gray-300"></i>
                <p>No goals found matching filters</p>
                <button onclick="clearGoalsFilters()" class="text-purple-600 text-sm mt-2 hover:underline">Clear filters</button>
              </td>
            </tr>
          \`;
          return;
        }

        // Populate DRI filter with unique DRIs
        const driSet = new Set();
        allGoals.forEach(g => {
          if (g.dri && g.dri !== '-') driSet.add(g.dri);
        });
        const driFilter = document.getElementById('goals-filter-dri');
        if (driFilter) {
          const currentValue = driFilter.value;
          driFilter.innerHTML = '<option value="">All DRIs</option>' + 
            Array.from(driSet).sort().map(dri => 
              '<option value="' + dri + '" ' + (dri === currentValue ? 'selected' : '') + '>' + dri + '</option>'
            ).join('');
        }

        // Group goals by category and sort by priority
        const categories = {};
        filteredGoals.forEach(goal => {
          const cat = goal.category || 'Build';
          if (!categories[cat]) categories[cat] = [];
          categories[cat].push(goal);
        });

        tbody.innerHTML = Object.entries(categories).map(([category, goals]) => {
          const categoryColor = category === 'Build' ? 'bg-blue-50' : category === 'Test' ? 'bg-purple-50' : 'bg-green-50';
          
          // Sort by priority (P0 > P1 > P2 > P3) then by order_index
          const categoryRows = goals.sort((a, b) => {
            const priorityOrder = { 'P0': 0, 'P1': 1, 'P2': 2, 'P3': 3 };
            return (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99) || (a.order_index || 0) - (b.order_index || 0);
          });

          return categoryRows.map((goal, idx) => {
            const categoryEmojis = {
              'Build': '🔨',
              'Test': '🧪',
              'Traction': '📈'
            };
            const priorityColors = {
              'P0': 'bg-yellow-100 text-yellow-800',
              'P1': 'bg-blue-100 text-blue-800',
              'P2': 'bg-green-100 text-green-800',
              'P3': 'bg-gray-100 text-gray-800'
            };
            const statusColors = {
              'WIP': 'bg-blue-100 text-blue-800',
              'To start': 'bg-yellow-100 text-yellow-800',
              'On Hold': 'bg-orange-100 text-orange-800',
              'Delayed': 'bg-red-100 text-red-800',
              'Blocked': 'bg-red-200 text-red-900',
              'Done': 'bg-green-100 text-green-800'
            };
            
            // Parse scheduled dates for this goal
            let scheduledDates = parseScheduledDates(goal.scheduled_dates);
            const scheduledCount = scheduledDates.length;

            return \`
              <tr class="\${idx === 0 ? categoryColor : 'hover:bg-gray-50'} group cursor-pointer" onclick="showGoalDetail(\${goal.id})">
                <td class="px-3 py-3 text-sm font-medium text-gray-900">\${idx === 0 ? (categoryEmojis[category] || '') + ' ' + category : ''}</td>
                <td class="px-3 py-3 text-sm text-gray-700 max-w-[150px]">
                  <div class="truncate hover:whitespace-normal hover:overflow-visible" title="\${goal.description || ''}">\${goal.description || ''}</div>
                </td>
                <td class="px-3 py-3 text-sm text-gray-900 font-medium max-w-[200px]">
                  <div class="truncate hover:whitespace-normal hover:overflow-visible" title="\${goal.task || goal.description || ''}">\${goal.task || goal.description || ''}</div>
                </td>
                <td class="px-2 py-3 text-center">
                  <span class="px-2 py-1 text-xs font-medium rounded-full \${priorityColors[goal.priority] || 'bg-gray-100 text-gray-800'}">
                    \${goal.priority || 'P0'}
                  </span>
                </td>
                <td class="px-2 py-3 text-sm text-gray-600 text-center">\${goal.cadence || 'One time'}</td>
                <td class="px-2 py-3 text-sm text-gray-600 text-center">\${goal.assigned_user_name || goal.dri || '-'}</td>
                <td class="px-2 py-3 text-center">
                  <span class="px-2 py-1 text-xs font-medium rounded-full \${statusColors[goal.goal_status] || 'bg-gray-100 text-gray-800'}">
                    \${goal.goal_status || 'To start'}
                  </span>
                </td>
                <td class="px-2 py-3 text-center" onclick="event.stopPropagation()">
                  <button 
                    onclick="openGoalCalendar(\${goal.id})" 
                    class="px-3 py-2 rounded-lg transition-all duration-200 \${
                      scheduledCount > 0 
                        ? 'bg-gradient-to-br from-purple-500 to-indigo-600 text-white shadow-md' 
                        : 'bg-gray-100 text-gray-500 hover:bg-purple-100 border border-gray-200'
                    }"
                    title="Schedule on calendar"
                  >
                    <i class="fas fa-calendar-day"></i>
                    \${scheduledCount > 0 ? '<span class="ml-1 text-xs">' + scheduledCount + '</span>' : ''}
                  </button>
                </td>
                <td class="px-2 py-3 text-center" onclick="event.stopPropagation()">
                  <div class="flex gap-1 justify-center opacity-50 group-hover:opacity-100 transition-opacity">
                    <button onclick="editGoal(\${goal.id})" class="text-gray-400 hover:text-purple-600 p-1">
                      <i class="fas fa-edit text-sm"></i>
                    </button>
                    <button onclick="deleteGoal(\${goal.id})" class="text-gray-400 hover:text-red-600 p-1">
                      <i class="fas fa-trash text-sm"></i>
                    </button>
                  </div>
                </td>
              </tr>
            \`;
          }).join('');
        }).join('');
        
        // Update timeline overview after rendering table
        updateCalendarOverview();
      }
      
      // Goals filtering functions
      function filterGoalsList() {
        const searchTerm = document.getElementById('goals-search')?.value.toLowerCase() || '';
        const categoryFilter = document.getElementById('goals-filter-category')?.value || '';
        const priorityFilter = document.getElementById('goals-filter-priority')?.value || '';
        const statusFilter = document.getElementById('goals-filter-status')?.value || '';
        const driFilter = document.getElementById('goals-filter-dri')?.value || '';
        
        return allGoals.filter(goal => {
          // Search filter
          if (searchTerm) {
            const searchable = (goal.description || '') + ' ' + (goal.task || '') + ' ' + (goal.assigned_user_name || goal.dri || '');
            if (!searchable.toLowerCase().includes(searchTerm)) return false;
          }
          
          // Category filter
          if (categoryFilter && goal.category !== categoryFilter) return false;
          
          // Priority filter
          if (priorityFilter && goal.priority !== priorityFilter) return false;
          
          // Status filter
          if (statusFilter && goal.goal_status !== statusFilter) return false;
          
          // DRI filter
          if (driFilter && (goal.assigned_user_name || goal.dri) !== driFilter) return false;
          
          return true;
        });
      }
      
      function filterGoalsTable() {
        renderGoalsTable();
      }
      
      function clearGoalsFilters() {
        document.getElementById('goals-search').value = '';
        document.getElementById('goals-filter-category').value = '';
        document.getElementById('goals-filter-priority').value = '';
        document.getElementById('goals-filter-status').value = '';
        document.getElementById('goals-filter-dri').value = '';
        renderGoalsTable();
      }
      
      // Calendar state
      let currentCalendarYear = new Date().getFullYear();
      let currentCalendarMonth = new Date().getMonth();
      let currentGoalIdForCalendar = null;
      
      // Function to update the monthly calendar overview visualization
      function updateCalendarOverview() {
        const calendarGrid = document.getElementById('calendar-grid');
        const monthTitle = document.getElementById('calendar-month-title');
        if (!calendarGrid) return;
        
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        if (monthTitle) {
          monthTitle.textContent = monthNames[currentCalendarMonth] + ' ' + currentCalendarYear;
        }
        
        // Get first day and days in month
        const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
        const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        let startDayOfWeek = firstDay.getDay(); // 0 = Sunday
        startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1; // Convert to Monday = 0
        
        // Count tasks per day
        const taskCounts = {};
        allGoals.forEach(goal => {
          let dates = parseScheduledDates(goal.scheduled_dates);
          dates.forEach(dateStr => {
            if (taskCounts[dateStr]) {
              taskCounts[dateStr]++;
            } else {
              taskCounts[dateStr] = 1;
            }
          });
        });
        
        // Build calendar HTML
        let html = '';
        const today = new Date();
        const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        
        // Empty cells before first day
        for (let i = 0; i < startDayOfWeek; i++) {
          html += '<div class="h-10"></div>';
        }
        
        // Day cells
        let totalScheduled = 0;
        let busiestDay = null;
        let busiestCount = 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = currentCalendarYear + '-' + String(currentCalendarMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
          const count = taskCounts[dateStr] || 0;
          totalScheduled += count;
          
          if (count > busiestCount) {
            busiestCount = count;
            busiestDay = day;
          }
          
          const isToday = dateStr === todayStr;
          const isWeekend = ((startDayOfWeek + day - 1) % 7) >= 5;
          
          let bgColor = 'bg-white';
          let textColor = 'text-gray-700';
          if (count >= 5) {
            bgColor = 'bg-red-400';
            textColor = 'text-white';
          } else if (count >= 3) {
            bgColor = 'bg-yellow-400';
            textColor = 'text-white';
          } else if (count > 0) {
            bgColor = 'bg-green-400';
            textColor = 'text-white';
          } else if (isWeekend) {
            bgColor = 'bg-gray-50';
            textColor = 'text-gray-400';
          }
          
          html += \`
            <div class="h-10 \${bgColor} \${textColor} rounded-lg flex flex-col items-center justify-center text-xs font-medium relative cursor-pointer hover:ring-2 hover:ring-purple-400 transition-all \${isToday ? 'ring-2 ring-purple-600' : ''}" 
                 onclick="showDayTasks('\${dateStr}')" title="\${count} tasks">
              <span>\${day}</span>
              \${count > 0 ? '<span class="text-[10px] opacity-80">' + count + '</span>' : ''}
            </div>
          \`;
        }
        
        calendarGrid.innerHTML = html;
        
        // Update total
        const totalEl = document.getElementById('timeline-total-tasks');
        if (totalEl) {
          totalEl.textContent = totalScheduled + ' tasks scheduled';
        }
        
        // Update busiest day
        const busiestEl = document.getElementById('busiest-day');
        if (busiestEl) {
          if (busiestDay && busiestCount > 0) {
            busiestEl.innerHTML = '<i class="fas fa-fire text-orange-500"></i> Busiest: Day ' + busiestDay + ' (' + busiestCount + ' tasks)';
          } else {
            busiestEl.textContent = 'No tasks scheduled yet';
          }
        }
      }
      
      window.changeCalendarMonth = function(delta) {
        currentCalendarMonth += delta;
        if (currentCalendarMonth < 0) {
          currentCalendarMonth = 11;
          currentCalendarYear--;
        } else if (currentCalendarMonth > 11) {
          currentCalendarMonth = 0;
          currentCalendarYear++;
        }
        updateCalendarOverview();
      };
      
      window.showDayTasks = function(dateStr) {
        // Find tasks scheduled for this day
        const tasksForDay = allGoals.filter(goal => {
          let dates = parseScheduledDates(goal.scheduled_dates);
          return dates.includes(dateStr);
        });
        
        if (tasksForDay.length === 0) {
          alert('No tasks scheduled for ' + dateStr);
          return;
        }
        
        // Create modal content with checkboxes
        const formatDate = new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const taskListHTML = tasksForDay.map(g => {
          const isDone = g.goal_status === 'Done';
          const isWIP = g.goal_status === 'WIP';
          return \`
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all">
              <input type="checkbox" 
                     id="task-check-\${g.id}" 
                     \${isDone ? 'checked' : ''} 
                     onchange="toggleTaskStatus(\${g.id}, this.checked)" 
                     class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
              <label for="task-check-\${g.id}" class="flex-1 cursor-pointer">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium \${isDone ? 'text-gray-400 line-through' : 'text-gray-900'}">\${g.task || g.description}</span>
                  \${isDone ? '<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700">Done</span>' : ''}
                  \${isWIP ? '<span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">WIP</span>' : ''}
                </div>
                \${g.dri ? '<p class="text-xs text-gray-500 mt-1">DRI: ' + g.dri + '</p>' : ''}
              </label>
            </div>
          \`;
        }).join('');
        
        // Show modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center';
        modal.innerHTML = \`
          <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-4 flex justify-between items-center">
              <div>
                <h3 class="font-bold text-lg">Tasks for \${formatDate}</h3>
                <p class="text-sm text-purple-100">\${tasksForDay.length} task\${tasksForDay.length !== 1 ? 's' : ''} scheduled</p>
              </div>
              <button onclick="this.closest('.fixed').remove()" class="text-white/70 hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
              </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(80vh-120px)]">
              <div class="space-y-2">
                \${taskListHTML}
              </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
              <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-all">
                Close
              </button>
            </div>
          </div>
        \`;
        document.body.appendChild(modal);
        
        // Close on background click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
      };
      
      window.toggleTaskStatus = async function(goalId, isChecked) {
        try {
          const newStatus = isChecked ? 'Done' : 'WIP';
          await axios.put('/api/dashboard/goals/' + goalId, { goal_status: newStatus });
          
          // Update in local array
          const goal = allGoals.find(g => g.id === goalId);
          if (goal) {
            goal.goal_status = newStatus;
          }
          
          // Update UI
          renderGoalsTable();
          updateCalendarOverview();
          
          console.log('[GOAL] Status updated:', { goalId, newStatus });
        } catch (e) {
          console.error('Error updating task status:', e);
          alert('Failed to update task status');
        }
      };
      
      window.openGoalCalendar = function(goalId) {
        const goal = allGoals.find(g => g.id === goalId);
        if (!goal) return;
        
        currentGoalIdForCalendar = goalId;
        
        // Show the goal calendar modal
        const modal = document.getElementById('goal-calendar-modal');
        if (modal) {
          document.getElementById('goal-calendar-title').textContent = goal.task || goal.description || 'Schedule Goal';
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          renderGoalCalendar();
        }
      };
      
      window.closeGoalCalendarModal = function() {
        const modal = document.getElementById('goal-calendar-modal');
        if (modal) {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }
        currentGoalIdForCalendar = null;
      };
      
      function renderGoalCalendar() {
        const goal = allGoals.find(g => g.id === currentGoalIdForCalendar);
        if (!goal) return;
        
        let scheduledDates = parseScheduledDates(goal.scheduled_dates);
        
        const calendarGrid = document.getElementById('goal-calendar-grid');
        const monthTitle = document.getElementById('goal-calendar-month');
        if (!calendarGrid) return;
        
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
        if (monthTitle) {
          monthTitle.textContent = monthNames[currentCalendarMonth] + ' ' + currentCalendarYear;
        }
        
        // Get first day and days in month
        const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
        const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        let startDayOfWeek = firstDay.getDay();
        startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;
        
        let html = '';
        const today = new Date();
        const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        
        // Empty cells
        for (let i = 0; i < startDayOfWeek; i++) {
          html += '<div class="h-12"></div>';
        }
        
        // Day cells
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = currentCalendarYear + '-' + String(currentCalendarMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
          const isScheduled = scheduledDates.includes(dateStr);
          const isToday = dateStr === todayStr;
          const isWeekend = ((startDayOfWeek + day - 1) % 7) >= 5;
          
          html += \`
            <button 
              onclick="toggleGoalDate('\${dateStr}')"
              class="h-12 rounded-lg flex items-center justify-center text-sm font-medium transition-all duration-200 \${
                isScheduled 
                  ? 'bg-gradient-to-br from-purple-500 to-indigo-600 text-white shadow-lg scale-105' 
                  : isWeekend 
                    ? 'bg-gray-100 text-gray-400 hover:bg-purple-100' 
                    : 'bg-white text-gray-700 hover:bg-purple-100 border border-gray-200'
              } \${isToday ? 'ring-2 ring-purple-600' : ''}"
            >
              \${day}
              \${isScheduled ? '<i class="fas fa-check ml-1 text-xs"></i>' : ''}
            </button>
          \`;
        }
        
        calendarGrid.innerHTML = html;
      }
      
      window.toggleGoalDate = async function(dateStr) {
        const goal = allGoals.find(g => g.id === currentGoalIdForCalendar);
        if (!goal) return;
        
        let scheduledDates = parseScheduledDates(goal.scheduled_dates);
        
        const idx = scheduledDates.indexOf(dateStr);
        if (idx >= 0) {
          scheduledDates.splice(idx, 1);
        } else {
          scheduledDates.push(dateStr);
          scheduledDates.sort();
        }
        
        try {
          await axios.put('/api/dashboard/goals/' + goal.id, { scheduled_dates: scheduledDates });
          goal.scheduled_dates = JSON.stringify(scheduledDates);
          renderGoalCalendar();
          renderGoalsTable();
        } catch (e) {
          console.error('Error updating schedule:', e);
          alert('Failed to update schedule');
        }
      };
      
      window.changeGoalCalendarMonth = function(delta) {
        currentCalendarMonth += delta;
        if (currentCalendarMonth < 0) {
          currentCalendarMonth = 11;
          currentCalendarYear--;
        } else if (currentCalendarMonth > 11) {
          currentCalendarMonth = 0;
          currentCalendarYear++;
        }
        renderGoalCalendar();
      };
      
      // Goal detail modal functions
      let currentDetailGoalId = null;
      
      window.showGoalDetail = function(goalId) {
        const goal = allGoals.find(g => g.id === goalId);
        if (!goal) return;
        
        currentDetailGoalId = goalId;
        
        // Populate modal
        document.getElementById('detail-category').textContent = goal.category || 'ASTAR';
        document.getElementById('detail-task').textContent = goal.task || goal.description || 'No task defined';
        document.getElementById('detail-description').textContent = goal.description || 'No description';
        document.getElementById('detail-priority').textContent = goal.priority || 'P0';
        document.getElementById('detail-status').textContent = goal.goal_status || 'To start';
        document.getElementById('detail-cadence').textContent = goal.cadence || 'One time';
        document.getElementById('detail-dri').textContent = goal.assigned_user_name || goal.dri || 'Not assigned';
        
        // Populate scheduled dates
        let scheduledDates = parseScheduledDates(goal.scheduled_dates);
        
        let scheduleHtml = '';
        if (scheduledDates.length === 0) {
          scheduleHtml = '<span class="text-gray-400 text-sm">No dates scheduled</span>';
        } else {
          scheduleHtml = scheduledDates.map(dateStr => {
            const date = new Date(dateStr);
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            return \`<span class="px-3 py-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-sm rounded-full">\${date.toLocaleDateString('en-US', options)}</span>\`;
          }).join('');
        }
        document.getElementById('detail-schedule').innerHTML = scheduleHtml;
        
        // Handle category-specific fields
        const hypothesisDetails = document.getElementById('hypothesis-details');
        const buildDetails = document.getElementById('build-details');
        const userLearningDetails = document.getElementById('user-learning-details');
        const insightDetails = document.getElementById('insight-details');
        const tractionDetails = document.getElementById('traction-details');
        
        // Hide all detail sections first
        hypothesisDetails.classList.add('hidden');
        buildDetails.classList.add('hidden');
        userLearningDetails.classList.add('hidden');
        insightDetails.classList.add('hidden');
        tractionDetails.classList.add('hidden');
        
        if (goal.category === 'hypothesis') {
          hypothesisDetails.classList.remove('hidden');
          
          document.getElementById('detail-expected-behavior').textContent = goal.hypothesis_expected_behavior || 'Not specified';
          document.getElementById('detail-validation-signal').textContent = goal.hypothesis_validation_signal || 'Not specified';
          
          // Hypothesis status badge
          const statusColors = {
            'testing': 'bg-yellow-100 text-yellow-800',
            'validated': 'bg-green-100 text-green-800',
            'invalidated': 'bg-red-100 text-red-800',
            'paused': 'bg-gray-100 text-gray-600'
          };
          const statusEl = document.getElementById('detail-hypothesis-status');
          statusEl.textContent = goal.hypothesis_status || 'testing';
          statusEl.className = 'px-2 py-1 text-xs font-medium rounded-full ' + (statusColors[goal.hypothesis_status] || statusColors['testing']);
          
          document.getElementById('detail-week-number').textContent = goal.week_number ? 'Week ' + goal.week_number + ' / ' + goal.year_number : 'N/A';
        } else if (goal.category === 'build') {
          buildDetails.classList.remove('hidden');
          
          document.getElementById('detail-tech-stack').textContent = goal.build_tech_stack || 'Not specified';
          document.getElementById('detail-hours-spent').textContent = goal.build_hours_spent ? goal.build_hours_spent + ' hours' : 'Not specified';
          
          // Link to hypothesis if exists
          if (goal.build_hypothesis_id) {
            const linkedHypothesis = allGoals.find(g => g.id === goal.build_hypothesis_id);
            if (linkedHypothesis) {
              document.getElementById('detail-hypothesis-link').innerHTML = \`<a href="#" onclick="event.preventDefault(); showGoalDetail(\${linkedHypothesis.id})" class="text-blue-600 hover:underline">#\${linkedHypothesis.id} - \${linkedHypothesis.description?.substring(0, 40) || 'View hypothesis'}...</a>\`;
            } else {
              document.getElementById('detail-hypothesis-link').textContent = 'Hypothesis #' + goal.build_hypothesis_id;
            }
          } else {
            document.getElementById('detail-hypothesis-link').textContent = 'Not linked';
          }
          
          document.getElementById('detail-build-week-number').textContent = goal.week_number ? 'Week ' + goal.week_number + ' / ' + goal.year_number : 'N/A';
        } else if (goal.category === 'user_learning') {
          userLearningDetails.classList.remove('hidden');
          
          document.getElementById('detail-users-spoken').textContent = goal.users_spoken || '0';
          document.getElementById('detail-users-used').textContent = goal.users_used_product || '0';
          document.getElementById('detail-users-details').textContent = goal.task || 'No details provided';
          document.getElementById('detail-key-learning').textContent = goal.key_learning || 'Not specified';
          document.getElementById('detail-user-week-number').textContent = goal.week_number ? 'Week ' + goal.week_number + ' / ' + goal.year_number : 'N/A';
        } else if (goal.category === 'insight') {
          insightDetails.classList.remove('hidden');
          
          document.getElementById('detail-users-interacted').textContent = goal.users_interacted || '0';
          document.getElementById('detail-repeated-actions').textContent = goal.repeated_actions || 'Not specified';
          document.getElementById('detail-drop-off-points').textContent = goal.drop_off_points || 'Not specified';
          document.getElementById('detail-key-insight').textContent = goal.key_insight || 'Not specified';
          document.getElementById('detail-insight-week-number').textContent = goal.week_number ? 'Week ' + goal.week_number + ' / ' + goal.year_number : 'N/A';
        } else if (goal.category === 'traction') {
          tractionDetails.classList.remove('hidden');
          
          // Display traction data - these come from goal_weekly_traction table via API join
          document.getElementById('detail-revenue').textContent = goal.traction_revenue ? '€' + goal.traction_revenue : '€0';
          document.getElementById('detail-new-users').textContent = goal.traction_new_users || '0';
          document.getElementById('detail-active-users').textContent = goal.traction_active_users || '0';
          document.getElementById('detail-churned').textContent = goal.traction_churned || '0';
          document.getElementById('detail-traction-signal').textContent = goal.traction_signal || goal.description || 'No signal specified';
          document.getElementById('detail-traction-week-number').textContent = goal.week_number ? 'Week ' + goal.week_number + ' / ' + goal.year_number : 'N/A';
          
          // Load historical traction data and render charts
          loadTractionCharts(goal.user_id);
        }
        
        // Show modal
        document.getElementById('goal-detail-modal').classList.remove('hidden');
        document.getElementById('goal-detail-modal').classList.add('flex');
      };
      
      // Traction charts instances
      let tractionRevenueChart = null;
      let tractionUserTypesChart = null;
      let tractionNetGrowthChart = null;
      let tractionAcquisitionChart = null;
      
      async function loadTractionCharts(userId) {
        try {
          const response = await fetch('/api/traction/metrics/' + userId + '?limit=12');
          const data = await response.json();
          
          if (!data.metrics || data.metrics.length === 0) {
            console.log('No traction data available for charts');
            document.getElementById('traction-charts-container').innerHTML = '<div class="bg-gray-50 p-6 rounded-lg text-center text-gray-500"><i class="fas fa-chart-line text-3xl mb-2"></i><p>No historical data yet. Track your weekly traction to see trends!</p></div>';
            return;
          }
          
          // Sort by week (oldest first for charts)
          const metrics = data.metrics.reverse();
          
          // Prepare data
          const labels = metrics.map(m => \`W\${m.week_number}\`);
          const revenueData = metrics.map(m => m.revenue_amount || 0);
          const activeUsersData = metrics.map(m => m.active_users || 0);
          const newUsersData = metrics.map(m => m.new_users || 0);
          const churnedData = metrics.map(m => m.churned_users || 0);
          const netGrowthData = metrics.map(m => (m.new_users || 0) - (m.churned_users || 0));
          
          // Destroy existing charts if they exist
          if (tractionRevenueChart) tractionRevenueChart.destroy();
          if (tractionUserTypesChart) tractionUserTypesChart.destroy();
          if (tractionNetGrowthChart) tractionNetGrowthChart.destroy();
          if (tractionAcquisitionChart) tractionAcquisitionChart.destroy();
          
          // 1. User Types Chart - Line chart with all 3 user types
          const userTypesCtx = document.getElementById('traction-user-types-chart');
          if (userTypesCtx) {
            tractionUserTypesChart = new Chart(userTypesCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'New Users',
                    data: newUsersData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: false,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#10b981'
                  },
                  {
                    label: 'Active Users',
                    data: activeUsersData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: false,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#3b82f6'
                  },
                  {
                    label: 'Churned',
                    data: churnedData,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: false,
                    tension: 0.4,
                    borderWidth: 3,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#ef4444'
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'index',
                  intersect: false
                },
                plugins: {
                  legend: { 
                    display: true,
                    position: 'bottom',
                    labels: { usePointStyle: true, padding: 15 }
                  }
                },
                scales: {
                  y: { beginAtZero: true }
                }
              }
            });
          }
          
          // 2. Net Growth Chart - Bar chart showing net user change
          const netGrowthCtx = document.getElementById('traction-net-growth-chart');
          if (netGrowthCtx) {
            tractionNetGrowthChart = new Chart(netGrowthCtx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Net Growth (New - Churned)',
                  data: netGrowthData,
                  backgroundColor: netGrowthData.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                  borderColor: netGrowthData.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                  borderWidth: 2,
                  borderRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        const v = context.parsed.y;
                        return v >= 0 ? '+' + v + ' users' : v + ' users';
                      }
                    }
                  }
                },
                scales: {
                  y: { 
                    beginAtZero: false,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                  }
                }
              }
            });
          }
          
          // 3. Revenue Chart
          const revenueCtx = document.getElementById('traction-revenue-chart');
          if (revenueCtx) {
            tractionRevenueChart = new Chart(revenueCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Revenue (€)',
                  data: revenueData,
                  borderColor: '#ec4899',
                  backgroundColor: 'rgba(236, 72, 153, 0.15)',
                  fill: true,
                  tension: 0.4,
                  borderWidth: 3,
                  pointRadius: 5,
                  pointHoverRadius: 8,
                  pointBackgroundColor: '#ec4899'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        return '€' + context.parsed.y.toLocaleString();
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function(value) {
                        return '€' + value;
                      }
                    }
                  }
                }
              }
            });
          }
          
          // 4. Weekly User Metrics Comparison (Grouped Bar)
          const acquisitionCtx = document.getElementById('traction-acquisition-chart');
          if (acquisitionCtx) {
            tractionAcquisitionChart = new Chart(acquisitionCtx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: '👥 New Users',
                    data: newUsersData,
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: '#10b981',
                    borderWidth: 1,
                    borderRadius: 4
                  },
                  {
                    label: '📱 Active Users',
                    data: activeUsersData,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    borderRadius: 4
                  },
                  {
                    label: '📉 Churned',
                    data: churnedData,
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: '#ef4444',
                    borderWidth: 1,
                    borderRadius: 4
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { 
                    display: true,
                    position: 'top',
                    labels: { padding: 15 }
                  }
                },
                scales: {
                  y: { 
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                  },
                  x: {
                    grid: { display: false }
                  }
                }
              }
            });
          }
          
        } catch (error) {
          console.error('Error loading traction charts:', error);
        }
      }
      
      window.closeGoalDetailModal = function() {
        document.getElementById('goal-detail-modal').classList.add('hidden');
        document.getElementById('goal-detail-modal').classList.remove('flex');
        currentDetailGoalId = null;
        
        // Destroy charts when closing modal to prevent memory leaks
        if (tractionRevenueChart) {
          tractionRevenueChart.destroy();
          tractionRevenueChart = null;
        }
        if (tractionUserTypesChart) {
          tractionUserTypesChart.destroy();
          tractionUserTypesChart = null;
        }
        if (tractionNetGrowthChart) {
          tractionNetGrowthChart.destroy();
          tractionNetGrowthChart = null;
        }
        if (tractionAcquisitionChart) {
          tractionAcquisitionChart.destroy();
          tractionAcquisitionChart = null;
        }
      };
      
      window.editGoalFromDetail = function() {
        if (currentDetailGoalId) {
          closeGoalDetailModal();
          editGoal(currentDetailGoalId);
        }
      };

      window.editGoal = function(goalId) {
        const goal = allGoals.find(g => g.id === goalId);
        if (!goal) return;
        
        // Store goal ID FIRST before opening modal
        const form = document.getElementById('goal-form');
        if (form) form.dataset.editingGoalId = goalId;
        
        // Show modal first
        document.getElementById('goal-modal').classList.remove('hidden'); 
        document.getElementById('goal-modal').classList.add('flex');
        
        // Load team members and then populate form
        loadTeamMembers().then(() => {
          // Then populate with existing goal data
          document.getElementById('goal-description').value = goal.description || '';
          document.getElementById('goal-task').value = goal.task || '';
          document.getElementById('goal-category').value = goal.category || 'OTHER';
          document.getElementById('goal-priority').value = goal.priority || 'P2';
          document.getElementById('goal-cadence').value = goal.cadence || 'One time';
          document.getElementById('goal-status').value = goal.goal_status || 'To start';
          document.getElementById('goal-week').value = goal.week_of || '';
          
          // Set assigned user
          const assignedToSelect = document.getElementById('goal-assigned-to');
          if (assignedToSelect && goal.assigned_to_user_id) {
            assignedToSelect.value = goal.assigned_to_user_id;
          }
        });
        
        // Change modal title and button text
        const modalTitle = document.querySelector('#goal-modal h3');
        if (modalTitle) modalTitle.textContent = 'Edit Goal';
        
        const submitBtn = document.querySelector('#goal-modal button[type="submit"]');
        if (submitBtn) submitBtn.textContent = 'Update Goal';
      };

      function initCharts() {
        const userM = metricsHistory.filter(m => m.metric_name === 'users').sort((a,b) => new Date(a.recorded_date) - new Date(b.recorded_date)).slice(-10);
        const revM = metricsHistory.filter(m => m.metric_name === 'revenue').sort((a,b) => new Date(a.recorded_date) - new Date(b.recorded_date)).slice(-10);
        
        const ctx1 = document.getElementById('chart-users');
        if (ctx1) {
          if (usersChart) usersChart.destroy();
          usersChart = new Chart(ctx1, {
            type: 'line',
            data: { labels: userM.map(m => new Date(m.recorded_date).toLocaleDateString()), datasets: [{ label: 'Users', data: userM.map(m => m.metric_value), borderColor: '#FF6154', backgroundColor: 'rgba(255,97,84,0.1)', fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
          });
        }
        const ctx2 = document.getElementById('chart-revenue');
        if (ctx2) {
          if (revenueChart) revenueChart.destroy();
          revenueChart = new Chart(ctx2, {
            type: 'bar',
            data: { labels: revM.map(m => new Date(m.recorded_date).toLocaleDateString()), datasets: [{ label: 'Revenue', data: revM.map(m => m.metric_value), backgroundColor: '#FB651E', borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
          });
        }
      }

      // Dashboard Traction Charts
      let dashboardUserTypesChart = null;
      let dashboardNetGrowthChart = null;
      let dashboardRevenueTrendChart = null;
      
      async function loadDashboardTractionCharts() {
        try {
          const currentUserId = getCurrentUserId();
          if (!currentUserId) {
            console.log('No user logged in for traction charts');
            return;
          }
          const response = await fetch('/api/traction/metrics/' + currentUserId + '?limit=12');
          const data = await response.json();
          
          // Update summary cards with totals
          if (data.metrics && data.metrics.length > 0) {
            const metrics = data.metrics;
            const totalRevenue = metrics.reduce((sum, m) => sum + (m.revenue_amount || 0), 0);
            const totalNew = metrics.reduce((sum, m) => sum + (m.new_users || 0), 0);
            const totalChurned = metrics.reduce((sum, m) => sum + (m.churned_users || 0), 0);
            const latestActive = metrics[0]?.active_users || 0;
            const netGrowth = totalNew - totalChurned;
            
            document.getElementById('traction-summary-revenue').textContent = '€' + totalRevenue.toLocaleString();
            document.getElementById('traction-summary-new').textContent = totalNew.toLocaleString();
            document.getElementById('traction-summary-active').textContent = latestActive.toLocaleString();
            document.getElementById('traction-summary-churned').textContent = totalChurned.toLocaleString();
            document.getElementById('traction-summary-net').textContent = (netGrowth >= 0 ? '+' : '') + netGrowth.toLocaleString();
            document.getElementById('traction-summary-net').className = 'text-2xl font-bold ' + (netGrowth >= 0 ? 'text-green-600' : 'text-red-600');
          }
          
          if (!data.metrics || data.metrics.length === 0) {
            // Show empty state
            const chartContainers = ['dashboard-user-types-chart', 'dashboard-net-growth-chart', 'dashboard-revenue-trend-chart'];
            chartContainers.forEach(id => {
              const container = document.getElementById(id)?.parentElement;
              if (container) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400"><div class="text-center"><i class="fas fa-chart-line text-4xl mb-2"></i><p class="text-sm">No traction data yet</p><p class="text-xs">Track your weekly metrics to see trends</p></div></div>';
              }
            });
            return;
          }
          
          // Sort oldest first for charts
          const metrics = data.metrics.reverse();
          const labels = metrics.map(m => 'W' + m.week_number);
          const newUsersData = metrics.map(m => m.new_users || 0);
          const activeUsersData = metrics.map(m => m.active_users || 0);
          const churnedData = metrics.map(m => m.churned_users || 0);
          const revenueData = metrics.map(m => m.revenue_amount || 0);
          const netGrowthData = metrics.map(m => (m.new_users || 0) - (m.churned_users || 0));
          
          // Destroy existing charts
          if (dashboardUserTypesChart) dashboardUserTypesChart.destroy();
          if (dashboardNetGrowthChart) dashboardNetGrowthChart.destroy();
          if (dashboardRevenueTrendChart) dashboardRevenueTrendChart.destroy();
          
          // 1. User Types Chart
          const userTypesCtx = document.getElementById('dashboard-user-types-chart');
          if (userTypesCtx) {
            dashboardUserTypesChart = new Chart(userTypesCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  { label: 'New Users', data: newUsersData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: false, tension: 0.4, borderWidth: 3, pointRadius: 5 },
                  { label: 'Active Users', data: activeUsersData, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: false, tension: 0.4, borderWidth: 3, pointRadius: 5 },
                  { label: 'Churned', data: churnedData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: false, tension: 0.4, borderWidth: 3, pointRadius: 5 }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: true, position: 'bottom', labels: { usePointStyle: true, padding: 15 } } },
                scales: { y: { beginAtZero: true } }
              }
            });
          }
          
          // 2. Net Growth Chart
          const netGrowthCtx = document.getElementById('dashboard-net-growth-chart');
          if (netGrowthCtx) {
            dashboardNetGrowthChart = new Chart(netGrowthCtx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Net Growth',
                  data: netGrowthData,
                  backgroundColor: netGrowthData.map(v => v >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                  borderColor: netGrowthData.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                  borderWidth: 2,
                  borderRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: false } }
              }
            });
          }
          
          // 3. Revenue Trend Chart
          const revenueCtx = document.getElementById('dashboard-revenue-trend-chart');
          if (revenueCtx) {
            dashboardRevenueTrendChart = new Chart(revenueCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Revenue (€)',
                  data: revenueData,
                  borderColor: '#ec4899',
                  backgroundColor: 'rgba(236, 72, 153, 0.15)',
                  fill: true,
                  tension: 0.4,
                  borderWidth: 3,
                  pointRadius: 5
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => '€' + ctx.parsed.y.toLocaleString() } } },
                scales: { y: { beginAtZero: true, ticks: { callback: v => '€' + v } } }
              }
            });
          }
          
        } catch (error) {
          console.error('Error loading dashboard traction charts:', error);
        }
      }

      // Global variable to store team members
      let teamMembers = [];

      // Load team members for goal assignment
      async function loadTeamMembers() {
        try {
          const response = await axios.get('/api/dashboard/team-members');
          teamMembers = response.data.teamMembers || [];
          
          // Populate the dropdown
          const select = document.getElementById('goal-assigned-to');
          if (select) {
            select.innerHTML = '<option value="">Unassigned</option>';
            teamMembers.forEach(member => {
              const option = document.createElement('option');
              option.value = member.id;
              option.textContent = member.name || member.email;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Error loading team members:', error);
          teamMembers = [];
        }
      }

      // Goal CRUD
      function openGoalModal() { 
        // Reset modal to create mode
        const modalTitle = document.querySelector('#goal-modal h3');
        if (modalTitle) modalTitle.textContent = 'Create New Goal';
        
        const submitBtn = document.querySelector('#goal-modal button[type="submit"]');
        if (submitBtn) submitBtn.textContent = 'Create Goal';
        
        const form = document.getElementById('goal-form');
        delete form.dataset.editingGoalId;
        form.reset();
        
        // Load team members
        loadTeamMembers();
        
        document.getElementById('goal-modal').classList.remove('hidden'); 
        document.getElementById('goal-modal').classList.add('flex'); 
      }
      
      function closeGoalModal() { 
        const form = document.getElementById('goal-form');
        delete form.dataset.editingGoalId;
        form.reset();
        
        document.getElementById('goal-modal').classList.add('hidden'); 
        document.getElementById('goal-modal').classList.remove('flex'); 
      }
      
      async function createGoal(e) {
        e.preventDefault();
        try {
          const priority = document.getElementById('goal-priority').value;
          const priorityLabels = {
            'P0': 'Urgent & important',
            'P1': 'Urgent or important',
            'P2': 'Urgent but not important',
            'P3': 'Neither but cool'
          };
          
          const assignedToUserId = document.getElementById('goal-assigned-to').value;
          
          const goalData = {
            description: document.getElementById('goal-description').value,
            task: document.getElementById('goal-task').value,
            category: document.getElementById('goal-category').value,
            priority: priority,
            priority_label: priorityLabels[priority],
            cadence: document.getElementById('goal-cadence').value,
            assigned_to_user_id: assignedToUserId ? parseInt(assignedToUserId) : null,
            goal_status: document.getElementById('goal-status').value,
            week_of: document.getElementById('goal-week').value || null,
            target_value: 100,
            current_value: 0
          };
          
          // Check if editing existing goal
          const form = document.getElementById('goal-form');
          const editingGoalId = form ? form.dataset.editingGoalId : null;
          
          console.log('[GOAL] Saving goal:', { editingGoalId, goalData });
          
          if (editingGoalId) {
            // Update existing goal
            console.log('[GOAL] Updating goal:', editingGoalId);
            const response = await axios.put('/api/dashboard/goals/' + editingGoalId, goalData);
            console.log('[GOAL] Update response:', response.data);
          } else {
            // Create new goal
            console.log('[GOAL] Creating new goal');
            const response = await axios.post('/api/dashboard/goals', goalData);
            console.log('[GOAL] Create response:', response.data);
          }
          
          closeGoalModal();
          console.log('[GOAL] Reloading dashboard data...');
          await loadDashboardData();
          console.log('[GOAL] Dashboard data reloaded successfully');
          alert('Goal saved successfully! ✅');
        } catch (e) { 
          console.error('[GOAL] Error saving goal:', e);
          console.error('[GOAL] Error details:', e.response?.data);
          alert('Error saving goal: ' + (e.response?.data?.error || e.message)); 
        }
      }

      async function updateGoal(id, current) {
        const val = prompt('Enter current progress:', current);
        if (val === null) return;
        try { await axios.put('/api/dashboard/goals/' + id, { current_value: parseInt(val) }); await loadDashboardData(); } catch (e) { alert('Error'); }
      }
      async function completeGoal(id) { if (!confirm('Mark as completed?')) return; try { await axios.post('/api/dashboard/goals/complete', { goalId: id }); await loadDashboardData(); } catch (e) { alert('Error'); } }
      async function deleteGoal(id) { if (!confirm('Delete this goal?')) return; try { await axios.delete('/api/dashboard/goals/' + id); await loadDashboardData(); } catch (e) { alert('Error'); } }

      async function addMetric() {
        const type = document.getElementById('metric-type').value;
        const val = parseFloat(document.getElementById('metric-value').value);
        const date = document.getElementById('metric-date').value;
        if (isNaN(val) || val < 0) { alert('Invalid value'); return; }
        try {
          await axios.post('/api/dashboard/metrics', { metric_name: type, metric_value: val, recorded_date: date });
          document.getElementById('metric-value').value = '';
          await loadDashboardData();
          initCharts();
        } catch (e) { alert('Error'); }
      }

      // Inbox - Conversations
      async function loadConversations() {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          const res = await axios.get('/api/chat/conversations', { headers: { Authorization: 'Bearer ' + token } });
          conversations = res.data.conversations || [];
          renderConversations();
          renderHomeMessages();
          
          // Update unread badge
          const unread = conversations.reduce((sum, c) => sum + (c.unread_count || 0), 0);
          const badge = document.getElementById('unread-badge');
          if (unread > 0) { badge.textContent = unread; badge.classList.remove('hidden'); }
          else { badge.classList.add('hidden'); }
        } catch (e) { 
          console.error('Error loading conversations:', e);
          document.getElementById('conversations-list').innerHTML = '<div class="p-8 text-center text-gray-500"><p>No conversations yet</p></div>';
        }
      }

      // Load active users
      async function loadActiveUsers() {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          // Get all users from validators and founders
          const [validatorsRes, foundersRes] = await Promise.all([
            axios.get('/api/validation/validators', { headers: { Authorization: 'Bearer ' + token } }),
            axios.get('/api/marketplace/products?limit=100', { headers: { Authorization: 'Bearer ' + token } })
          ]);
          
          const validators = validatorsRes.data || [];
          const founders = (foundersRes.data?.products || []).map(p => ({
            id: p.company_user_id || p.id,
            name: p.company_name || p.company || p.title,
            role: 'founder',
            avatar: p.company_avatar,
            title: p.title
          }));
          
          activeUsers = [
            ...validators.map(v => ({ ...v, role: 'validator' })),
            ...founders
          ];
          
          renderActiveUsers();
        } catch (e) {
          console.error('Error loading active users:', e);
          document.getElementById('active-users-list').innerHTML = '<div class="p-8 text-center text-gray-500"><p>No active users</p></div>';
        }
      }

      function renderActiveUsers() {
        const container = document.getElementById('active-users-list');
        if (!activeUsers.length) {
          container.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="fas fa-users text-4xl mb-4 text-gray-300"></i><p>No active users</p></div>';
          return;
        }
        
        container.innerHTML = activeUsers.map(user => \`
          <div onclick="startConversationWith(\${user.id}, '\${(user.name || '').replace(/'/g, "\\\\'")}', '\${user.role}')" class="p-4 hover:bg-gray-50 cursor-pointer transition">
            <div class="flex items-center gap-3">
              <div class="relative">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                  \${user.avatar ? \`<img src="\${user.avatar}" class="w-full h-full rounded-full object-cover" />\` : (user.name || 'U')[0].toUpperCase()}
                </div>
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></div>
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-gray-900 truncate">\${user.name || 'User'}</p>
                <p class="text-xs text-gray-500 truncate">
                  \${user.role === 'validator' ? '✅ Validator' : '🚀 Founder'}
                  \${user.title ? ' • ' + user.title : ''}
                </p>
              </div>
              <i class="fas fa-comment-dots text-gray-400"></i>
            </div>
          </div>
        \`).join('');
      }

      function showInboxSection(section) {
        currentInboxSection = section;
        
        // Update buttons
        const activeBtn = document.getElementById('inbox-active-btn');
        const conversationsBtn = document.getElementById('inbox-conversations-btn');
        
        if (section === 'active') {
          activeBtn.classList.add('text-primary', 'border-primary', 'bg-primary/5');
          activeBtn.classList.remove('text-gray-500', 'border-transparent');
          conversationsBtn.classList.remove('text-primary', 'border-primary', 'bg-primary/5');
          conversationsBtn.classList.add('text-gray-500', 'border-transparent');
          
          document.getElementById('active-users-list').classList.remove('hidden');
          document.getElementById('conversations-list').classList.add('hidden');
        } else {
          conversationsBtn.classList.add('text-primary', 'border-primary', 'bg-primary/5');
          conversationsBtn.classList.remove('text-gray-500', 'border-transparent');
          activeBtn.classList.remove('text-primary', 'border-primary', 'bg-primary/5');
          activeBtn.classList.add('text-gray-500', 'border-transparent');
          
          document.getElementById('conversations-list').classList.remove('hidden');
          document.getElementById('active-users-list').classList.add('hidden');
        }
      }

      async function startConversationWith(userId, userName, userRole) {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          // Create or get conversation with this user
          const res = await axios.post('/api/chat/conversations', {
            other_user_id: userId
          }, { headers: { Authorization: 'Bearer ' + token } });
          
          if (res.data.conversation_id) {
            selectConversation(res.data.conversation_id);
            // Switch to conversations tab to show the chat
            showInboxSection('conversations');
            // Reload conversations to update the list
            loadConversations();
          }
        } catch (e) {
          console.error('Error starting conversation:', e);
          alert('Error al iniciar conversación. Por favor intenta de nuevo.');
        }
      }

      // For Connector suggestions - just needs user ID
      async function startConversation(userId) {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          // Create or get conversation with this user
          const res = await axios.post('/api/chat/conversations', {
            other_user_id: userId
          }, { headers: { Authorization: 'Bearer ' + token } });
          
          if (res.data.conversation_id) {
            selectConversation(res.data.conversation_id);
            // Switch to inbox tab and conversations section
            switchTab('inbox');
            showInboxSection('conversations');
            // Reload conversations to update the list
            loadConversations();
          }
        } catch (e) {
          console.error('Error starting conversation:', e);
          alert('Error al iniciar conversación. Por favor intenta de nuevo.');
        }
      }

      // View user profile in directory
      function viewProfile(userId) {
        // Switch to directory tab
        switchTab('directory');
        // Scroll to the user if needed
        setTimeout(() => {
          const userCard = document.querySelector(\`[data-user-id="\${userId}"]\`);
          if (userCard) {
            userCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            userCard.classList.add('ring-2', 'ring-purple-500');
            setTimeout(() => {
              userCard.classList.remove('ring-2', 'ring-purple-500');
            }, 2000);
          }
        }, 100);
      }

      function renderConversations() {
        const container = document.getElementById('conversations-list');
        if (!conversations.length) {
          container.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i><p>No conversations yet</p></div>';
          return;
        }
        container.innerHTML = conversations.map(c => \`
          <div onclick="selectConversation(\${c.id})" class="p-4 hover:bg-gray-50 cursor-pointer \${currentConversation === c.id ? 'bg-primary/10' : ''}">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 font-bold">\${(c.other_user_name || 'U')[0].toUpperCase()}</div>
              <div class="flex-1 min-w-0">
                <div class="flex justify-between items-center">
                  <p class="font-semibold text-gray-900 truncate">\${c.other_user_name || 'User'}</p>
                  \${c.unread_count > 0 ? '<span class="bg-primary text-white text-xs rounded-full px-2 py-0.5">' + c.unread_count + '</span>' : ''}
                </div>
                <p class="text-sm text-gray-500 truncate">\${c.last_message || 'No messages yet'}</p>
              </div>
            </div>
          </div>
        \`).join('');
      }

      function renderHomeMessages() {
        const container = document.getElementById('home-messages');
        if (!container) return; // Element doesn't exist, skip rendering
        
        if (!conversations.length) {
          container.innerHTML = '<div class="text-center py-6 text-gray-500"><p class="text-sm">No messages yet</p></div>';
          return;
        }
        container.innerHTML = conversations.slice(0, 3).map(c => \`
          <div onclick="switchTab(\\'inbox\\'); setTimeout(() => selectConversation(\${c.id}), 100);" class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm font-bold">\${(c.other_user_name || 'U')[0].toUpperCase()}</div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate">\${c.other_user_name || 'User'}</p>
              <p class="text-xs text-gray-500 truncate">\${c.last_message || 'No messages'}</p>
            </div>
            \${c.unread_count > 0 ? '<span class="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">' + c.unread_count + '</span>' : ''}
          </div>
        \`).join('');
      }

      async function selectConversation(id) {
        currentConversation = id;
        const conv = conversations.find(c => c.id === id);
        
        // If conversation not found in list (new conversation), fetch it directly
        if (!conv) {
          console.log('Conversation not in list, fetching directly:', id);
          try {
            const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
            const res = await axios.get('/api/chat/conversations/' + id, { headers: { Authorization: 'Bearer ' + token } });
            if (res.data) {
              document.getElementById('chat-header').innerHTML = \`<p class="font-bold text-gray-900">\${res.data.other_user_name || 'User'}</p><p class="text-sm text-gray-500">New conversation</p>\`;
            }
          } catch (e) {
            console.error('Error fetching conversation:', e);
            document.getElementById('chat-header').innerHTML = \`<p class="font-bold text-gray-900">Chat</p>\`;
          }
        } else {
          document.getElementById('chat-header').innerHTML = \`<p class="font-bold text-gray-900">\${conv?.other_user_name || 'User'}</p><p class="text-sm text-gray-500">\${conv?.project_title || conv?.product_title || ''}</p>\`;
        }
        
        document.getElementById('chat-input-area').classList.remove('hidden');
        renderConversations();
        
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          const res = await axios.get('/api/chat/conversations/' + id + '/messages', { headers: { Authorization: 'Bearer ' + token } });
          const messages = res.data.messages || [];
          const container = document.getElementById('chat-messages-area');
          if (!messages.length) {
            container.innerHTML = '<div class="text-center text-gray-400 py-12"><p>No messages yet. Start the conversation!</p></div>';
          } else {
            container.innerHTML = messages.map(m => \`
              <div class="flex \${m.sender_id === getCurrentUserId() ? 'justify-end' : 'justify-start'}">
                <div class="\${m.sender_id === getCurrentUserId() ? 'bg-primary text-white' : 'bg-gray-100 text-gray-800'} rounded-lg px-4 py-2 max-w-[70%]">
                  <p class="text-sm">\${m.message}</p>
                  <p class="text-xs opacity-70 mt-1">\${new Date(m.created_at).toLocaleTimeString()}</p>
                </div>
              </div>
            \`).join('');
            container.scrollTop = container.scrollHeight;
          }
          // Mark as read
          await axios.put('/api/chat/conversations/' + id + '/read', {}, { headers: { Authorization: 'Bearer ' + token } });
          loadConversations();
        } catch (e) { console.error('Error loading messages:', e); }
      }

      // Alias for compatibility
      function loadConversation(id) {
        return selectConversation(id);
      }

      async function sendMessage() {
        const input = document.getElementById('message-input');
        const msg = input.value.trim();
        if (!msg || !currentConversation) return;
        
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          await axios.post('/api/chat/conversations/' + currentConversation + '/messages', { message: msg }, { headers: { Authorization: 'Bearer ' + token } });
          input.value = '';
          selectConversation(currentConversation);
        } catch (e) { alert('Error sending message'); }
      }

      function getCurrentUserId() {
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          if (!token) return null;
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.userId;
        } catch (e) { return null; }
      }

      // Directory
      function showDirectorySection(section) {
        document.querySelectorAll('.mp-btn').forEach(b => {
          b.classList.remove('text-primary', 'border-primary');
          b.classList.add('text-gray-500', 'border-transparent');
        });
        document.getElementById('mp-' + section + '-btn').classList.remove('text-gray-500', 'border-transparent');
        document.getElementById('mp-' + section + '-btn').classList.add('text-primary', 'border-primary');
        document.querySelectorAll('.mp-section').forEach(s => s.classList.add('hidden'));
        document.getElementById('mp-' + section).classList.remove('hidden');
        
        // Load data for the section
        if (section === 'validators') loadValidators();
        else if (section === 'founders') loadUsersByRole('founder', 'founders-grid');
        else if (section === 'investors') loadUsersByRole('investor', 'investors-grid');
        else if (section === 'scouts') loadUsersByRole('scout', 'scouts-grid');
        else if (section === 'partners') loadUsersByRole('partner', 'partners-grid');
        else if (section === 'talent') loadUsersByRole('job_seeker', 'talent-grid');
      }

      async function loadProducts() {
        const category = document.getElementById('product-category').value;
        const stage = document.getElementById('product-stage').value;
        try {
          const res = await axios.get('/api/marketplace/products', { params: { category, stage, limit: 20 } });
          const products = res.data.products || [];
          const container = document.getElementById('products-grid');
          if (!products.length) {
            container.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500"><i class="fas fa-box-open text-4xl mb-4 text-gray-300"></i><p>No products found</p></div>';
            return;
          }
          container.innerHTML = products.map(p => \`
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-blue-100 text-blue-700">\${p.category}</span>
                <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-gray-100 text-gray-600">\${p.stage}</span>
              </div>
              <h3 class="font-bold text-gray-900 mb-2">\${p.title}</h3>
              <p class="text-sm text-gray-600 mb-4 line-clamp-2">\${p.description}</p>
              <div class="flex items-center justify-between mb-3">
                <span class="text-gray-500 text-sm"><i class="fas fa-user mr-1"></i>\${p.company_name || 'Unknown'}</span>
                <div class="flex items-center gap-1">
                  <span class="text-yellow-500 font-bold">\${p.rating_average ? p.rating_average.toFixed(1) : '0.0'}</span>
                  <i class="fas fa-star text-yellow-500"></i>
                  <span class="text-gray-400 text-sm">(\${p.votes_count || 0})</span>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="viewProductDetail(\${p.id})" class="flex-1 bg-primary text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-primary/90 transition">
                  <i class="fas fa-eye mr-1"></i>Ver detalle
                </button>
                <button onclick="voteProduct(\${p.id})" class="px-3 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition" title="Votar">
                  <i class="fas fa-star"></i>
                </button>
              </div>
            </div>
          \`).join('');
        } catch (e) { console.error('Error loading products:', e); }
      }

      async function loadValidators() {
        try {
          const res = await axios.get('/api/validation/validators');
          const validators = res.data || [];
          const container = document.getElementById('validators-grid');
          if (!validators.length) {
            container.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500"><i class="fas fa-users text-4xl mb-4 text-gray-300"></i><p>No validators available</p></div>';
            return;
          }
          container.innerHTML = validators.map(v => {
            const avatarUrl = v.avatar_url || \`https://ui-avatars.com/api/?name=\${encodeURIComponent(v.name || 'V')}&background=6366f1&color=fff\`;
            const expertise = Array.isArray(v.expertise) ? v.expertise : JSON.parse(v.expertise || '[]');
            const expertiseTags = expertise.slice(0, 3).map(exp => 
              \`<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1">\${exp}</span>\`
            ).join('');
            
            return \`
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition">
              <div class="flex items-start gap-3 mb-3">
                <img src="\${avatarUrl}" class="w-14 h-14 rounded-full" alt="\${v.name}"/>
                <div class="flex-1">
                  <h3 class="font-bold text-gray-900">\${v.name || 'Validator'}</h3>
                  <p class="text-sm text-gray-500">\${v.title || 'Expert Validator'}</p>
                  <div class="flex items-center mt-1 text-sm">
                    <div class="flex text-yellow-400 mr-2">
                      \${Array(5).fill(0).map((_, i) => \`<i class="fas fa-star\${i < Math.round(v.rating || 0) ? '' : '-o'} text-xs"></i>\`).join('')}
                    </div>
                    <span class="text-gray-500 text-xs">(\${v.total_validations || 0})</span>
                  </div>
                </div>
              </div>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">\${v.bio || 'Expert validator ready to help your startup'}</p>
              <div class="mb-3">
                \${expertiseTags}
              </div>
              <div class="flex gap-2">
                <button onclick="startChatWithValidator(\${v.user_id})" class="flex-1 bg-primary text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-primary/90 transition">
                  <i class="fas fa-comment mr-1"></i>Chat
                </button>
                <button onclick="viewValidatorProfile(\${v.user_id})" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                  <i class="fas fa-user"></i>
                </button>
              </div>
            </div>
          \`;
          }).join('');
        } catch (e) { 
          console.error('Error loading validators:', e);
          document.getElementById('validators-grid').innerHTML = '<div class="col-span-3 text-center py-12 text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p>Error loading validators</p></div>';
        }
      }

      async function startChatWithValidator(validatorUserId) {
        try {
          console.log('Starting chat with validator:', validatorUserId);
          const token = getAuthToken();
          const response = await axios.post('/api/chat/conversations', {
            other_user_id: validatorUserId
          }, {
            headers: { Authorization: 'Bearer ' + token }
          });
          const conversationId = response.data.conversation_id;
          
          // Switch to inbox tab
          switchTab('inbox');
          
          // Wait a moment for tab to switch, then reload conversations and select the new one
          setTimeout(async () => {
            await loadConversations(); // Reload conversations list to include the new one
            setTimeout(() => {
              selectConversation(conversationId); // Now select it
            }, 200);
          }, 300);
        } catch (error) {
          console.error('Error starting chat:', error);
          alert('Error starting conversation. Please try again.');
        }
      }

      function viewValidatorProfile(validatorUserId) {
        showUserProfile(validatorUserId);
      }

      // Load users by role
      async function loadUsersByRole(role, gridId) {
        try {
          const res = await axios.get('/api/auth/users-by-role', { params: { role } });
          const users = res.data || [];
          const container = document.getElementById(gridId);
          
          if (!users.length) {
            container.innerHTML = '<div class="col-span-3 text-center py-12 text-gray-500"><i class="fas fa-users text-4xl mb-4 text-gray-300"></i><p>No users found</p></div>';
            return;
          }
          
          container.innerHTML = users.map(u => {
            const avatarUrl = u.avatar_url || \`https://ui-avatars.com/api/?name=\${encodeURIComponent(u.name || 'U')}&background=random\`;
            const roleLabels = {
              founder: '🚀 Founder',
              investor: '💰 Investor',
              scout: '🔍 Scout',
              partner: '🤝 Partner',
              job_seeker: '👨‍💻 Talent'
            };
            const roleLabel = roleLabels[role] || role;
            
            return \`
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition">
              <div class="flex items-start gap-3 mb-3">
                <img src="\${avatarUrl}" class="w-14 h-14 rounded-full" alt="\${u.name}"/>
                <div class="flex-1">
                  <h3 class="font-bold text-gray-900">\${u.name || 'User'}</h3>
                  <p class="text-sm text-gray-500">\${roleLabel}</p>
                  \${u.company ? \`<p class="text-xs text-gray-400 mt-1">\${u.company}</p>\` : ''}
                </div>
              </div>
              \${u.bio ? \`<p class="text-sm text-gray-600 mb-3 line-clamp-2">\${u.bio}</p>\` : ''}
              <div class="flex gap-2">
                <button onclick="viewValidatorProfile(\${u.id})" class="flex-1 bg-primary text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-primary/90 transition">
                  <i class="fas fa-user mr-1"></i>View Profile
                </button>
                <button onclick="startChatWithValidator(\${u.id})" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition" title="Chat">
                  <i class="fas fa-comment"></i>
                </button>
              </div>
            </div>
          \`;
          }).join('');
        } catch (e) { 
          console.error('Error loading users:', e);
          document.getElementById(gridId).innerHTML = '<div class="col-span-3 text-center py-12 text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p>Error loading users</p></div>';
        }
      }

      async function startChatWithUser(userId) {
        try {
          console.log('Starting chat with user:', userId);
          const token = getAuthToken();
          const response = await axios.post('/api/chat/conversations', {
            other_user_id: userId
          }, {
            headers: { Authorization: 'Bearer ' + token }
          });
          const conversationId = response.data.conversation_id;
          
          // Switch to inbox tab
          switchTab('inbox');
          
          // Wait a moment for tab to switch, then reload conversations and select the new one
          setTimeout(async () => {
            await loadConversations(); // Reload conversations list to include the new one
            setTimeout(() => {
              selectConversation(conversationId); // Now select it
            }, 200);
          }, 300);
        } catch (error) {
          console.error('Error starting chat:', error);
          alert('Error starting conversation. Please try again.');
        }
      }

      function viewUserProfile(userId) {
        showUserProfile(userId);
      }

      function searchUsers(type) {
        // TODO: Implement search
        console.log('Searching users:', type);
      }

      function searchValidators() {
        const q = document.getElementById('validator-search').value;
        // Implement search
      }

      function openProductModal() { document.getElementById('product-modal').classList.remove('hidden'); document.getElementById('product-modal').classList.add('flex'); }
      function closeProductModal() { document.getElementById('product-modal').classList.add('hidden'); document.getElementById('product-modal').classList.remove('flex'); }

      // View product detail
      async function viewProductDetail(productId) {
        try {
          const res = await axios.get(\`/api/marketplace/products/\${productId}\`);
          const product = res.data;
          
          // Create modal with product details
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
          modal.innerHTML = \`
            <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-700">\${product.category}</span>
                    <span class="text-xs font-medium px-2 py-1 rounded-full bg-gray-100 text-gray-600">\${product.stage}</span>
                  </div>
                  <h2 class="text-2xl font-bold text-gray-900">\${product.title}</h2>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
              
              <div class="mb-4">
                <div class="flex items-center gap-3 mb-3">
                  <img src="\${product.company_avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(product.company_name || 'C')}" 
                       class="w-12 h-12 rounded-full" alt="Company">
                  <div>
                    <p class="font-semibold text-gray-900">\${product.company_name || 'Unknown Company'}</p>
                    <p class="text-sm text-gray-500">\${product.company || ''}</p>
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-2">
                  <div class="flex items-center">
                    <span class="text-3xl font-bold text-yellow-500">\${product.rating_average ? product.rating_average.toFixed(1) : '0.0'}</span>
                    <i class="fas fa-star text-yellow-500 ml-1 text-xl"></i>
                  </div>
                  <span class="text-gray-500">(\${product.votes_count || 0} votos)</span>
                </div>
                <button onclick="voteProduct(\${productId}); this.closest('.fixed').remove();" 
                        class="ml-auto bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition">
                  <i class="fas fa-star mr-2"></i>Votar ahora
                </button>
              </div>

              <div class="space-y-4">
                <div>
                  <h3 class="font-bold text-gray-900 mb-2">Descripción</h3>
                  <p class="text-gray-600">\${product.description}</p>
                </div>

                <div>
                  <h3 class="font-bold text-gray-900 mb-2">Información</h3>
                  <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="bg-gray-50 p-3 rounded-lg">
                      <p class="text-gray-500 mb-1">Categoría</p>
                      <p class="font-semibold">\${product.category}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                      <p class="text-gray-500 mb-1">Etapa</p>
                      <p class="font-semibold">\${product.stage}</p>
                    </div>
                    \${product.url ? \`
                    <div class="bg-gray-50 p-3 rounded-lg col-span-2">
                      <p class="text-gray-500 mb-1">URL</p>
                      <a href="\${product.url}" target="_blank" class="text-primary hover:underline">\${product.url}</a>
                    </div>
                    \` : ''}
                  </div>
                </div>

                \${product.looking_for ? \`
                <div>
                  <h3 class="font-bold text-gray-900 mb-2">Buscando</h3>
                  <p class="text-gray-600">\${product.looking_for}</p>
                </div>
                \` : ''}

                \${product.reviews && product.reviews.length > 0 ? \`
                <div>
                  <h3 class="font-bold text-gray-900 mb-2">Reseñas</h3>
                  <div class="space-y-2">
                    \${product.reviews.map(r => \`
                      <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="flex items-center justify-between mb-1">
                          <p class="font-semibold text-sm">\${r.reviewer_name}</p>
                          <div class="flex text-yellow-400">
                            \${Array(5).fill(0).map((_, i) => \`<i class="fas fa-star\${i < r.rating ? '' : '-o'} text-xs"></i>\`).join('')}
                          </div>
                        </div>
                        <p class="text-sm text-gray-600">\${r.comment || ''}</p>
                      </div>
                    \`).join('')}
                  </div>
                </div>
                \` : ''}
              </div>
            </div>
          \`;
          
          document.body.appendChild(modal);
        } catch (error) {
          console.error('Error loading product details:', error);
          alert('Error al cargar los detalles del producto');
        }
      }

      // Vote for product
      async function voteProduct(productId) {
        const rating = prompt('Califica este producto (1-5 estrellas):', '5');
        if (!rating || rating < 1 || rating > 5) {
          alert('Por favor ingresa un valor entre 1 y 5');
          return;
        }

        try {
          const token = getAuthToken();
          
          // Vote directly on the product
          await axios.post(\`/api/marketplace/products/\${productId}/vote\`, 
            { rating: parseInt(rating) },
            { headers: { Authorization: 'Bearer ' + token } }
          );
          
          alert('✅ Voto registrado exitosamente');
          loadProducts(); // Reload to show updated rating
        } catch (error) {
          console.error('Error voting:', error);
          if (error.response?.status === 429) {
            alert(error.response.data.error || 'Espera unos segundos antes de votar nuevamente');
          } else {
            alert('Error al votar. Por favor intenta nuevamente.');
          }
        }
      }

      async function createProduct(e) {
        e.preventDefault();
        try {
          const token = document.cookie.match(/authToken=([^;]+)/)?.[1];
          await axios.post('/api/marketplace/products', {
            title: document.getElementById('product-title').value,
            description: document.getElementById('product-description').value,
            category: document.getElementById('product-cat').value,
            stage: document.getElementById('product-stage-input').value,
            url: document.getElementById('product-url').value,
            looking_for: document.getElementById('product-looking').value
          }, { headers: { Authorization: 'Bearer ' + token } });
          closeProductModal();
          loadProducts();
        } catch (e) { alert('Error creating product'); }
      }

      // Show user profile with onboarding data
      async function showUserProfile(userId) {
        try {
          const token = getAuthToken();
          const response = await axios.get(\`/api/auth/user-profile/\${userId}\`);
          const profile = response.data;

          if (!profile) {
            alert('Profile not found');
            return;
          }

          // Create modal
          const modal = document.createElement('div');
          modal.id = 'user-profile-modal';
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
          modal.style.display = 'flex';

          const onboardingHTML = renderOnboardingData(profile.onboarding, profile.role);

          modal.innerHTML = \`
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white sticky top-0 z-10">
                <div class="flex items-start justify-between">
                  <div class="flex items-start space-x-4">
                    <div class="w-20 h-20 rounded-full bg-white flex items-center justify-center text-primary text-3xl font-bold shadow-lg">
                      \${profile.name?.charAt(0) || 'U'}
                    </div>
                    <div>
                      <h2 class="text-2xl font-bold">\${profile.name}</h2>
                      <p class="text-purple-100 text-sm mt-1">\${profile.email}</p>
                      <div class="mt-2 inline-block bg-white/20 px-3 py-1 rounded-full text-sm font-medium">
                        \${getRoleLabel(profile.role)}
                      </div>
                    </div>
                  </div>
                  <button onclick="closeUserProfileModal()" class="text-white hover:text-purple-200 transition text-2xl">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>

              <div class="p-6 space-y-6">
                \${profile.bio ? \`
                  <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="font-semibold text-gray-900 mb-2 flex items-center">
                      <i class="fas fa-user text-primary mr-2"></i>
                      About
                    </h3>
                    <p class="text-gray-700">\${profile.bio}</p>
                  </div>
                \` : ''}

                \${profile.company ? \`
                  <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="font-semibold text-gray-900 mb-2 flex items-center">
                      <i class="fas fa-building text-primary mr-2"></i>
                      Company
                    </h3>
                    <p class="text-gray-700">\${profile.company}</p>
                  </div>
                \` : ''}

                \${onboardingHTML}

                \${(profile.linkedin_url || profile.twitter_url || profile.website_url) ? \`
                  <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                      <i class="fas fa-link text-primary mr-2"></i>
                      Links
                    </h3>
                    <div class="flex flex-wrap gap-3">
                      \${profile.linkedin_url ? \`
                        <a href="\${profile.linkedin_url}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center space-x-2">
                          <i class="fab fa-linkedin"></i>
                          <span>LinkedIn</span>
                        </a>
                      \` : ''}
                      \${profile.twitter_url ? \`
                        <a href="\${profile.twitter_url}" target="_blank" class="bg-sky-400 text-white px-4 py-2 rounded-lg hover:bg-sky-500 transition flex items-center space-x-2">
                          <i class="fab fa-twitter"></i>
                          <span>Twitter</span>
                        </a>
                      \` : ''}
                      \${profile.website_url ? \`
                        <a href="\${profile.website_url}" target="_blank" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition flex items-center space-x-2">
                          <i class="fas fa-globe"></i>
                          <span>Website</span>
                        </a>
                      \` : ''}
                    </div>
                  </div>
                \` : ''}

                <div class="text-center text-sm text-gray-500 pt-4 border-t border-gray-200">
                  <i class="fas fa-calendar text-primary mr-1"></i>
                  Member since \${new Date(profile.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                </div>
              </div>
            </div>
          \`;

          document.body.appendChild(modal);

          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeUserProfileModal();
            }
          });

        } catch (error) {
          console.error('Error loading user profile:', error);
          alert('Failed to load profile');
        }
      }

      function getRoleLabel(role) {
        const labels = {
          founder: '🚀 Founder',
          investor: '💰 Investor',
          validator: '✅ Validator',
          scout: '🔍 Scout',
          partner: '🤝 Partner',
          job_seeker: '👨‍💻 Job Seeker',
          other: '✨ Other'
        };
        return labels[role] || '👤 User';
      }

      function renderOnboardingData(onboarding, role) {
        if (!onboarding) return '';

        const fieldLabels = {
          founder: {
            startup_name: { icon: 'fas fa-rocket', label: 'Startup Name' },
            startup_stage: { icon: 'fas fa-chart-line', label: 'Stage' },
            industry: { icon: 'fas fa-industry', label: 'Industry' },
            funding_status: { icon: 'fas fa-money-bill-wave', label: 'Funding Status' },
            funding_goal: { icon: 'fas fa-bullseye', label: 'Funding Goal' },
            team_size: { icon: 'fas fa-users', label: 'Team Size' },
            pitch_deck_url: { icon: 'fas fa-file-powerpoint', label: 'Pitch Deck' }
          },
          investor: {
            investor_type: { icon: 'fas fa-briefcase', label: 'Investor Type' },
            investment_stage: { icon: 'fas fa-seedling', label: 'Investment Stage' },
            check_size: { icon: 'fas fa-dollar-sign', label: 'Check Size' },
            investment_focus: { icon: 'fas fa-bullseye', label: 'Investment Focus' },
            geographic_focus: { icon: 'fas fa-globe-americas', label: 'Geographic Focus' },
            notable_investments: { icon: 'fas fa-star', label: 'Notable Investments' }
          },
          validator: {
            expertise: { icon: 'fas fa-certificate', label: 'Expertise' },
            years_experience: { icon: 'fas fa-calendar-alt', label: 'Years of Experience' },
            hourly_rate: { icon: 'fas fa-dollar-sign', label: 'Hourly Rate' },
            availability: { icon: 'fas fa-clock', label: 'Availability' },
            portfolio_url: { icon: 'fas fa-briefcase', label: 'Portfolio' }
          },
          scout: {
            scout_for: { icon: 'fas fa-search', label: 'Scouting For' },
            scout_focus: { icon: 'fas fa-target', label: 'Focus Areas' },
            scout_commission: { icon: 'fas fa-percentage', label: 'Commission Structure' },
            deals_closed: { icon: 'fas fa-handshake', label: 'Deals Closed' }
          },
          partner: {
            partner_type: { icon: 'fas fa-handshake', label: 'Partner Type' },
            services_offered: { icon: 'fas fa-cogs', label: 'Services Offered' },
            target_clients: { icon: 'fas fa-users', label: 'Target Clients' },
            case_studies: { icon: 'fas fa-trophy', label: 'Case Studies' }
          },
          job_seeker: {
            job_title: { icon: 'fas fa-id-badge', label: 'Job Title' },
            experience_years: { icon: 'fas fa-calendar-check', label: 'Experience Level' },
            skills: { icon: 'fas fa-code', label: 'Skills' },
            looking_for: { icon: 'fas fa-search', label: 'Looking For' },
            portfolio_url: { icon: 'fas fa-folder-open', label: 'Portfolio' }
          }
        };

        const fields = fieldLabels[role] || {};
        const entries = Object.entries(onboarding).filter(([key]) => 
          fields[key] && onboarding[key] && onboarding[key] !== '' && key !== 'role' && key !== 'email' && key !== 'name'
        );

        if (entries.length === 0) return '';

        return \`
          <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl p-6">
            <h3 class="font-bold text-gray-900 mb-4 flex items-center text-lg">
              <i class="fas fa-info-circle text-primary mr-2"></i>
              Profile Details
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              \${entries.map(([key, value]) => {
                const field = fields[key];
                if (!field) return '';
                
                return \`
                  <div class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="flex items-start space-x-3">
                      <div class="text-primary mt-1">
                        <i class="\${field.icon}"></i>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 font-medium uppercase tracking-wide mb-1">\${field.label}</p>
                        <p class="text-gray-900 font-medium break-words">\${String(value)}</p>
                      </div>
                    </div>
                  </div>
                \`;
              }).join('')}
            </div>
          </div>
        \`;
      }

      function closeUserProfileModal() {
        const modal = document.getElementById('user-profile-modal');
        if (modal) {
          modal.remove();
        }
      }

      // Make functions available globally
      window.showUserProfile = showUserProfile;
      window.closeUserProfileModal = closeUserProfileModal;

      // Initialize
      const currentUserRole = '${a||"founder"}';
      
      window.addEventListener('load', () => {
        console.log('[MARKETPLACE-LOAD] Page loaded, checking URL params...');
        
        // Load data only for founders
        if (currentUserRole === 'founder') {
          loadDashboardData();
        }
        loadConversations();
        loadActiveUsers(); // Load active users for inbox
        
        // Check if URL has tab parameter
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        const chatContext = urlParams.get('chat');
        const astarResponse = urlParams.get('astarResponse');
        
        console.log('[MARKETPLACE-LOAD] URL params:', { tabParam, chatContext, astarResponse: astarResponse ? astarResponse.substring(0, 50) + '...' : null });
        
        if (tabParam && ['home', 'traction', 'inbox', 'directory', 'aicmo'].includes(tabParam)) {
          console.log('[MARKETPLACE-LOAD] Valid tab, switching to:', tabParam);
          // Switch to the requested tab
          switchTab(tabParam);
          
          // Si viene con contexto de email Y respuesta ASTAR, procesarla
          if (chatContext && astarResponse) {
            console.log('[MARKETPLACE-LOAD] ASTAR response detected, will open chat in 500ms');
            setTimeout(function() {
              console.log('[MARKETPLACE-LOAD] Opening chat sidebar...');
              // Abrir el chat sidebar del layout
              var sidebar = document.getElementById('chat-sidebar');
              var floatingBtn = document.getElementById('chat-floating-btn');
              var isMobile = window.innerWidth <= 768;
              
              console.log('[MARKETPLACE-LOAD] Sidebar element:', sidebar);
              
              if (sidebar) {
                sidebar.style.width = isMobile ? '100%' : '400px';
                sidebar.style.maxWidth = '400px';
                sidebar.style.display = 'flex';
                if (floatingBtn) floatingBtn.style.display = 'none';
                console.log('[MARKETPLACE-LOAD] Chat sidebar opened successfully');
              } else {
                console.error('[MARKETPLACE-LOAD] ERROR: chat-sidebar element not found!');
              }
              
              // Enviar la respuesta del usuario directamente al chat
              console.log('[MARKETPLACE-LOAD] Calling processAstarResponse...');
              if (typeof window.processAstarResponse === 'function') {
                processAstarResponse(chatContext, decodeURIComponent(astarResponse));
              } else {
                console.error('[MARKETPLACE-LOAD] ERROR: processAstarResponse function not defined!');
              }
            }, 500);
          }
          // Si solo viene con contexto (sin respuesta), mostrar pregunta inicial
          else if (chatContext) {
            console.log('[INIT] Email context detected:', chatContext);
            setTimeout(function() {
              // Abrir el chat sidebar del layout
              var sidebar = document.getElementById('chat-sidebar');
              var floatingBtn = document.getElementById('chat-floating-btn');
              var isMobile = window.innerWidth <= 768;
              
              if (sidebar) {
                sidebar.style.width = isMobile ? '100%' : '400px';
                sidebar.style.maxWidth = '400px';
                sidebar.style.display = 'flex';
                if (floatingBtn) floatingBtn.style.display = 'none';
              }
              
              // Enviar mensaje inicial con el contexto de email
              sendEmailContextMessage(chatContext);
            }, 500);
          }
        } else if (currentUserRole !== 'founder') {
          // Switch to inbox tab for non-founders if no tab specified
          switchTab('inbox');
        }
        
        // Initialize AI CMO page renderer
        window.renderAICMOPage = ${Ru()};
        
        // Function to send email context to chat
        window.sendEmailContextMessage = async function(emailContext) {
          console.log('[EMAIL-CHAT] Sending email context:', emailContext);
          
          try {
            var chatMessages = document.getElementById('chat-messages');
            
            // Mostrar loading
            var loading = document.getElementById('chat-loading');
            if (loading) loading.classList.remove('hidden');
            
            var response = await axios.post('/api/chat-agent/message', { 
              message: '', // Empty message to trigger initial question
              emailContext: emailContext 
            }, { withCredentials: true });
            
            // Ocultar loading
            if (loading) loading.classList.add('hidden');
            
            console.log('[EMAIL-CHAT] Response:', response.data);
            
            if (response.data && response.data.message && chatMessages) {
              // Show the initial question in the chat
              var messageDiv = document.createElement('div');
              messageDiv.className = 'chat-message flex justify-start';
              messageDiv.innerHTML = '<div class="bg-gray-100 text-gray-800 rounded-lg px-4 py-2 max-w-[85%] shadow-sm"><p class="text-sm whitespace-pre-wrap">' + response.data.message.replace(/\\n/g, '<br>') + '</p></div>';
              chatMessages.appendChild(messageDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;
              
              // Store the email context in a global variable so we can send it with the next message
              window.currentEmailContext = emailContext;
            }
          } catch (error) {
            console.error('[EMAIL-CHAT] Error:', error);
            var loading = document.getElementById('chat-loading');
            if (loading) loading.classList.add('hidden');
          }
        };
        
        // Function to process ASTAR response directly
        window.processAstarResponse = async function(emailContext, userResponse) {
          console.log('[ASTAR-PROCESS] Processing:', { emailContext, userResponse });
          
          try {
            // Primero mostrar el mensaje del usuario en el chat
            var chatMessages = document.getElementById('chat-messages');
            console.log('[ASTAR-PROCESS] Chat messages container:', chatMessages);
            
            if (chatMessages) {
              // Mensaje del usuario
              var userDiv = document.createElement('div');
              userDiv.className = 'chat-message flex justify-end';
              userDiv.innerHTML = '<div class="bg-gradient-to-r from-primary to-secondary text-white rounded-lg px-4 py-2 max-w-[85%] shadow-sm"><p class="text-sm whitespace-pre-wrap">' + userResponse.replace(/\\n/g, '<br>') + '</p></div>';
              chatMessages.appendChild(userDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Mostrar loading
            var loading = document.getElementById('chat-loading');
            if (loading) loading.classList.remove('hidden');
            
            // Enviar la respuesta del usuario directamente al chat con contexto
            var response = await axios.post('/api/chat-agent/message', { 
              message: userResponse,
              emailContext: emailContext 
            }, { withCredentials: true });
            
            // Ocultar loading
            if (loading) loading.classList.add('hidden');
            
            console.log('[ASTAR-PROCESS] Response:', response.data);
            
            // Mostrar respuesta del asistente
            if (chatMessages && response.data && response.data.message) {
              var assistantDiv = document.createElement('div');
              assistantDiv.className = 'chat-message flex justify-start';
              assistantDiv.innerHTML = '<div class="bg-gray-100 text-gray-800 rounded-lg px-4 py-2 max-w-[85%] shadow-sm"><p class="text-sm whitespace-pre-wrap">' + response.data.message.replace(/\\n/g, '<br>') + '</p></div>';
              chatMessages.appendChild(assistantDiv);
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Limpiar URL parameters
            var newUrl = window.location.pathname + '?tab=home';
            window.history.replaceState({}, '', newUrl);
            
            // Recargar goals después de un momento
            setTimeout(function() {
              if (typeof loadDashboardData === 'function') {
                loadDashboardData();
              }
            }, 2000);
            
          } catch (error) {
            console.error('[ASTAR-PROCESS] Error:', error);
            var loading = document.getElementById('chat-loading');
            if (loading) loading.classList.add('hidden');
          }
        };
      });
    <\/script>
  `;return br({content:s,currentPage:"directory",userName:t,userAvatar:r,pageTitle:"Dashboard",userRole:a})}function Au(e){const{userName:t,userEmail:r,userRole:a,userId:s,token:o}=e;return`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Welcome - ASTAR* Onboarding</title>
      <script src="https://cdn.tailwindcss.com"><\/script>
    </head>
    <body>
      ${`
    <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 p-6">
      <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
          <h1 class="text-4xl font-bold text-gray-900 mb-2">👋 Welcome, ${t}!</h1>
          <p class="text-lg text-gray-600">Let's get to know you better</p>
        </div>

        <!-- Chat Container -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-200">
          <!-- Chat Header -->
          <div class="bg-gradient-to-r from-purple-600 via-blue-600 to-pink-600 px-6 py-5">
            <div class="flex items-center space-x-4">
              <div class="w-14 h-14 rounded-full bg-white flex items-center justify-center shadow-lg">
                <span class="text-3xl">⭐</span>
              </div>
              <div>
                <h3 class="text-white font-bold text-lg">ASTAR* Assistant</h3>
                <p class="text-purple-100 text-sm">Your personal onboarding guide</p>
              </div>
              <div class="ml-auto">
                <div id="onboardingProgress" class="text-white text-sm font-semibold bg-white/20 px-4 py-2 rounded-full">
                  Step 1/5
                </div>
              </div>
            </div>
          </div>
          
          <!-- Chat Messages -->
          <div id="onboardingChatMessages" class="h-[500px] overflow-y-auto p-6 space-y-4 bg-gradient-to-b from-gray-50 to-white">
            <!-- Initial message will be added by JavaScript -->
          </div>
          
          <!-- Chat Input -->
          <div class="border-t border-gray-200 p-6 bg-white">
            <div class="space-y-3">
              <!-- Quick Reply Buttons (shown for multiple choice) -->
              <div id="quickReplyButtons" class="hidden flex flex-wrap gap-2 mb-3"></div>
              
              <!-- Text Input -->
              <div class="flex items-center space-x-3">
                <input 
                  type="text" 
                  id="onboardingChatInput" 
                  placeholder="Type your answer..."
                  class="flex-1 px-5 py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg"
                  onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendOnboardingMessage(); }"
                />
                <button 
                  onclick="sendOnboardingMessage()" 
                  id="sendButton"
                  class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-8 py-4 rounded-xl font-semibold transition-all shadow-lg hover:shadow-xl"
                >
                  <span class="flex items-center space-x-2">
                    <span>Send</span>
                    <span>📤</span>
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Onboarding state
      let currentStep = 0;
      let onboardingData = {
        role: '${a}',
        email: '${r}',
        name: '${t}'
      };
      let isTyping = false;
      let sessionId = 'onboarding_${s}_' + Date.now();

      // Question flows based on role
      const onboardingFlows = {
        founder: [
          {
            question: "Great to have you here! 🚀 Let's start with your startup. What's the name of your company?",
            field: 'startup_name',
            type: 'text'
          },
          {
            question: "Awesome! What stage is {startup_name} currently at?",
            field: 'startup_stage',
            type: 'choice',
            options: [
              { label: '💡 Just an idea', value: 'idea' },
              { label: '🛠️ Building MVP', value: 'mvp' },
              { label: '💰 Early revenue', value: 'early_revenue' },
              { label: '📈 Scaling', value: 'scaling' },
              { label: '🏢 Established', value: 'established' }
            ]
          },
          {
            question: "What industry or sector does {startup_name} operate in?",
            field: 'industry',
            type: 'text',
            placeholder: 'e.g., FinTech, HealthTech, E-commerce, SaaS...'
          },
          {
            question: "What's your current funding status?",
            field: 'funding_status',
            type: 'choice',
            options: [
              { label: '🏠 Bootstrapped', value: 'bootstrapped' },
              { label: '🌱 Pre-seed', value: 'pre_seed' },
              { label: '🌿 Seed', value: 'seed' },
              { label: '🚀 Series A', value: 'series_a' },
              { label: '💫 Series B+', value: 'series_b_plus' }
            ]
          },
          {
            question: "How much funding are you looking to raise?",
            field: 'funding_goal',
            type: 'choice',
            options: [
              { label: 'Under $100K', value: 'under_100k' },
              { label: '$100K - $500K', value: '100k_500k' },
              { label: '$500K - $2M', value: '500k_2m' },
              { label: '$2M - $5M', value: '2m_5m' },
              { label: '$5M+', value: '5m_plus' },
              { label: 'Not fundraising', value: 'not_fundraising' }
            ]
          },
          {
            question: "Tell me about your team! How many people are working on {startup_name}?",
            field: 'team_size',
            type: 'choice',
            options: [
              { label: 'Just me (solo founder)', value: 'solo' },
              { label: '2-5 people', value: '2_5' },
              { label: '6-10 people', value: '6_10' },
              { label: '11-25 people', value: '11_25' },
              { label: '25+ people', value: '25_plus' }
            ]
          },
          {
            question: "Finally, where can I find your pitch deck? (Share a link or type 'none' if you don't have one yet)",
            field: 'pitch_deck_url',
            type: 'text',
            placeholder: 'https://...',
            optional: true
          }
        ],
        investor: [
          {
            question: "Excited to have an investor onboard! 💰 What type of investor are you?",
            field: 'investor_type',
            type: 'choice',
            options: [
              { label: '👼 Angel Investor', value: 'angel' },
              { label: '🏢 VC Fund', value: 'vc' },
              { label: '🏭 Corporate VC', value: 'corporate' },
              { label: '👨‍👩‍👧‍👦 Family Office', value: 'family_office' }
            ]
          },
          {
            question: "What stage of startups do you typically invest in?",
            field: 'investment_stage',
            type: 'choice',
            multiple: true,
            options: [
              { label: '🌱 Pre-seed', value: 'pre_seed' },
              { label: '🌿 Seed', value: 'seed' },
              { label: '🚀 Series A', value: 'series_a' },
              { label: '💫 Series B+', value: 'series_b_plus' }
            ]
          },
          {
            question: "What's your typical check size?",
            field: 'check_size',
            type: 'choice',
            options: [
              { label: '$10K - $50K', value: '10k_50k' },
              { label: '$50K - $250K', value: '50k_250k' },
              { label: '$250K - $1M', value: '250k_1m' },
              { label: '$1M - $5M', value: '1m_5m' },
              { label: '$5M+', value: '5m_plus' }
            ]
          },
          {
            question: "What industries or sectors are you most interested in? (comma-separated)",
            field: 'investment_focus',
            type: 'text',
            placeholder: 'e.g., FinTech, AI/ML, HealthTech, SaaS, Climate...'
          },
          {
            question: "What geographic regions do you focus on? (comma-separated)",
            field: 'geographic_focus',
            type: 'text',
            placeholder: 'e.g., North America, Europe, Latin America, Asia...'
          },
          {
            question: "Share some of your notable investments or portfolio companies (comma-separated, or 'none' if just starting)",
            field: 'notable_investments',
            type: 'text',
            placeholder: 'e.g., Company A, Company B, Company C...',
            optional: true
          }
        ],
        scout: [
          {
            question: "Welcome, talent scout! 🔍 Which VC firm or angel group are you scouting for?",
            field: 'scout_for',
            type: 'text'
          },
          {
            question: "What types of startups or founders are you looking for? (comma-separated)",
            field: 'scout_focus',
            type: 'text',
            placeholder: 'e.g., AI startups, technical founders, B2B SaaS...'
          },
          {
            question: "What's your commission structure?",
            field: 'scout_commission',
            type: 'choice',
            options: [
              { label: 'Equity in deals', value: 'equity' },
              { label: 'Cash commission', value: 'cash' },
              { label: 'Hybrid (equity + cash)', value: 'hybrid' },
              { label: 'Prefer not to say', value: 'not_specified' }
            ]
          },
          {
            question: "How many deals have you closed so far?",
            field: 'deals_closed',
            type: 'choice',
            options: [
              { label: 'Just starting out', value: '0' },
              { label: '1-5 deals', value: '1_5' },
              { label: '6-15 deals', value: '6_15' },
              { label: '15+ deals', value: '15_plus' }
            ]
          }
        ],
        partner: [
          {
            question: "Great to have a partner here! 🤝 What type of partner are you?",
            field: 'partner_type',
            type: 'choice',
            options: [
              { label: '💼 Service Provider', value: 'service_provider' },
              { label: '📦 Distributor', value: 'distributor' },
              { label: '⚡ Technology Partner', value: 'technology' },
              { label: '🎯 Strategic Partner', value: 'strategic' }
            ]
          },
          {
            question: "What services or capabilities do you offer? (comma-separated)",
            field: 'services_offered',
            type: 'text',
            placeholder: 'e.g., Legal, Marketing, Development, Cloud Infrastructure...'
          },
          {
            question: "Who are your ideal clients?",
            field: 'target_clients',
            type: 'choice',
            options: [
              { label: '🚀 Startups', value: 'startups' },
              { label: '🏢 Enterprises', value: 'enterprises' },
              { label: '🌐 Both', value: 'both' }
            ]
          },
          {
            question: "Share any case studies or success stories (or type 'building portfolio')",
            field: 'case_studies',
            type: 'text',
            placeholder: 'Describe 1-2 successful projects...',
            optional: true
          }
        ],
        job_seeker: [
          {
            question: "Awesome to have you! 👨‍💻 What's your current or desired job title?",
            field: 'job_title',
            type: 'text',
            placeholder: 'e.g., Full Stack Developer, Product Manager, Growth Marketer...'
          },
          {
            question: "How many years of experience do you have?",
            field: 'experience_years',
            type: 'choice',
            options: [
              { label: '< 1 year', value: 'entry' },
              { label: '1-3 years', value: 'junior' },
              { label: '3-5 years', value: 'mid' },
              { label: '5-10 years', value: 'senior' },
              { label: '10+ years', value: 'expert' }
            ]
          },
          {
            question: "What are your key skills? (comma-separated)",
            field: 'skills',
            type: 'text',
            placeholder: 'e.g., React, Python, Product Strategy, SEO, Sales...'
          },
          {
            question: "What type of role are you looking for?",
            field: 'looking_for',
            type: 'choice',
            multiple: true,
            options: [
              { label: '💼 Full-time', value: 'full_time' },
              { label: '⏰ Part-time', value: 'part_time' },
              { label: '📄 Contract', value: 'contract' },
              { label: '🎯 Advisory', value: 'advisory' }
            ]
          },
          {
            question: "Share your portfolio, GitHub, or resume link (optional)",
            field: 'portfolio_url',
            type: 'text',
            placeholder: 'https://...',
            optional: true
          }
        ],
        other: [
          {
            question: "Welcome! Tell me a bit about what brings you to ASTAR*?",
            field: 'bio',
            type: 'text',
            placeholder: 'Share your interests, goals, or what you hope to find here...'
          },
          {
            question: "What industry or field are you interested in?",
            field: 'industry',
            type: 'text',
            placeholder: 'e.g., Technology, Healthcare, Finance, Education...'
          },
          {
            question: "What's your current role or profession?",
            field: 'company',
            type: 'text',
            placeholder: 'e.g., Student, Consultant, Entrepreneur...'
          }
        ]
      };

      // Get current question flow
      const questions = onboardingFlows[onboardingData.role] || onboardingFlows.other;
      const totalSteps = questions.length;

      // Initialize onboarding
      window.addEventListener('load', () => {
        showNextQuestion();
      });

      function showNextQuestion() {
        if (currentStep >= questions.length) {
          completeOnboarding();
          return;
        }

        const question = questions[currentStep];
        let questionText = question.question;

        // Replace placeholders with actual data
        Object.keys(onboardingData).forEach(key => {
          questionText = questionText.replace(\`{\${key}}\`, onboardingData[key]);
        });

        // Update progress
        document.getElementById('onboardingProgress').textContent = \`Step \${currentStep + 1}/\${totalSteps}\`;

        // Add bot message
        setTimeout(() => {
          addOnboardingMessage('assistant', questionText);

          // Show quick reply buttons for choice questions
          if (question.type === 'choice') {
            showQuickReplyButtons(question.options, question.multiple);
          } else {
            hideQuickReplyButtons();
            document.getElementById('onboardingChatInput').placeholder = question.placeholder || 'Type your answer...';
          }
        }, 500);
      }

      function showQuickReplyButtons(options, multiple = false) {
        const container = document.getElementById('quickReplyButtons');
        container.classList.remove('hidden');
        container.innerHTML = options.map((opt, idx) => \`
          <button 
            data-quick-reply-index="\${idx}"
            class="quick-reply-btn px-4 py-2 bg-gradient-to-r from-purple-100 to-pink-100 hover:from-purple-200 hover:to-pink-200 text-purple-700 rounded-lg font-medium transition-all border border-purple-200 hover:border-purple-300"
          >
            \${opt.label}
          </button>
        \`).join('');
        
        // Add click event listeners to buttons
        container.querySelectorAll('.quick-reply-btn').forEach((btn, idx) => {
          btn.addEventListener('click', () => {
            handleQuickReply(options[idx].value, options[idx].label, multiple);
          });
        });
        
        // Hide text input for single choice
        if (!multiple) {
          document.getElementById('onboardingChatInput').style.display = 'none';
          document.getElementById('sendButton').style.display = 'none';
        }
      }

      function hideQuickReplyButtons() {
        const container = document.getElementById('quickReplyButtons');
        container.classList.add('hidden');
        container.innerHTML = '';
        document.getElementById('onboardingChatInput').style.display = 'block';
        document.getElementById('sendButton').style.display = 'block';
      }

      function handleQuickReply(value, label, multiple) {
        if (multiple) {
          // For multiple choice, allow selecting multiple then pressing send
          // TODO: implement multi-select logic
          return;
        }

        // For single choice, immediately proceed
        const question = questions[currentStep];
        onboardingData[question.field] = value;
        
        addOnboardingMessage('user', label);
        hideQuickReplyButtons();
        
        currentStep++;
        setTimeout(() => showNextQuestion(), 800);
      };

      window.sendOnboardingMessage = async function() {
        const input = document.getElementById('onboardingChatInput');
        const message = input.value.trim();
        
        if (!message || isTyping) return;
        
        const question = questions[currentStep];
        
        // Validate required fields
        if (!question.optional && message.toLowerCase() === 'skip') {
          addOnboardingMessage('error', 'This field is required. Please provide an answer.');
          return;
        }

        // Store answer
        if (question.field) {
          // Parse comma-separated values for array fields
          if (['investment_focus', 'geographic_focus', 'notable_investments', 'scout_focus', 'services_offered', 'case_studies', 'skills'].includes(question.field)) {
            onboardingData[question.field] = message.split(',').map(s => s.trim()).filter(Boolean);
          } else {
            onboardingData[question.field] = message;
          }
        }

        // Add user message
        addOnboardingMessage('user', message);
        input.value = '';
        
        currentStep++;
        setTimeout(() => showNextQuestion(), 800);
      };

      function addOnboardingMessage(type, content) {
        const messagesDiv = document.getElementById('onboardingChatMessages');
        const timestamp = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        
        if (type === 'user') {
          const messageHtml = \`
            <div class="flex items-start space-x-3 justify-end animate-fade-in">
              <div class="flex-1 max-w-lg">
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl shadow-lg p-4">
                  <p class="whitespace-pre-wrap">\${content}</p>
                </div>
                <div class="text-xs text-gray-400 mt-1 text-right">\${timestamp}</div>
              </div>
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-300 to-gray-400 flex items-center justify-center flex-shrink-0 shadow-md">
                <span class="text-white text-lg">👤</span>
              </div>
            </div>
          \`;
          messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
        } else if (type === 'assistant') {
          const messageHtml = \`
            <div class="flex items-start space-x-3 animate-fade-in">
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center flex-shrink-0 shadow-md">
                <span class="text-white text-lg">⭐</span>
              </div>
              <div class="flex-1">
                <div class="bg-white rounded-2xl shadow-lg p-4 border border-gray-100">
                  <p class="text-gray-800 whitespace-pre-wrap">\${content}</p>
                </div>
                <div class="text-xs text-gray-400 mt-1">\${timestamp}</div>
              </div>
            </div>
          \`;
          messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
        } else if (type === 'error') {
          const messageHtml = \`
            <div class="flex items-center justify-center">
              <div class="bg-red-50 text-red-700 px-4 py-2 rounded-lg text-sm border border-red-200">
                ⚠️ \${content}
              </div>
            </div>
          \`;
          messagesDiv.insertAdjacentHTML('beforeend', messageHtml);
        }
        
        // Auto-scroll
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      async function completeOnboarding() {
        addOnboardingMessage('assistant', \`🎉 Perfect! Thanks for sharing all that information. I'm setting up your personalized experience now...\`);
        
        try {
          const response = await fetch('/api/auth/complete-onboarding', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ${o}'
            },
            body: JSON.stringify(onboardingData)
          });

          const result = await response.json();
          
          if (result.success) {
            setTimeout(() => {
              addOnboardingMessage('assistant', \`✅ All set! Redirecting you to your dashboard...\`);
              setTimeout(() => {
                window.location.href = '/dashboard';
              }, 2000);
            }, 1000);
          } else {
            addOnboardingMessage('error', 'There was an error saving your profile. Redirecting to dashboard...');
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 2000);
          }
        } catch (error) {
          console.error('Error completing onboarding:', error);
          addOnboardingMessage('error', 'There was an error. Redirecting to dashboard...');
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
        }
      }
    <\/script>

    <style>
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .animate-fade-in {
        animation: fade-in 0.3s ease-out;
      }
    </style>
  `}
    </body>
    </html>
  `}function Ou(e){const{userName:t,userAvatar:r,userRole:a}=e,s=`
    <div class="p-6">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
          <i class="fas fa-trophy text-yellow-500 mr-3"></i>
          🏅 Weekly Competitions
        </h1>
        <p class="text-gray-600">Join startup competitions and showcase your progress!</p>
      </div>

      <!-- Competition Guidelines Button -->
      <div class="mb-6">
        <button onclick="showGuidelines()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">
          <i class="fas fa-info-circle mr-2"></i>
          Competition Guidelines
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex border-b border-gray-200 mb-6">
        <button onclick="showCompetitionsTab('monthly')" id="monthly-tab" class="comp-tab px-6 py-3 text-sm font-semibold border-b-2 border-primary text-primary">
          Monthly Prize Competitions
        </button>
        <button onclick="showCompetitionsTab('weekly')" id="weekly-tab" class="comp-tab px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500">
          Weekly Competitions
        </button>
      </div>

      <!-- Monthly Competitions (default visible) -->
      <div id="monthly-competitions" class="competitions-content">
        <div id="monthly-grid" class="grid grid-cols-1 gap-6">
          <!-- Loading spinner -->
          <div class="flex justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
          </div>
        </div>
      </div>

      <!-- Weekly Competitions -->
      <div id="weekly-competitions" class="competitions-content hidden">
        <div id="weekly-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Loading spinner -->
          <div class="col-span-2 flex justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
          </div>
        </div>
      </div>

      <!-- Monthly Competitions -->
      <div id="monthly-competitions" class="competitions-content hidden">
        <div id="monthly-grid" class="grid grid-cols-1 gap-6">
          <!-- Loading spinner -->
          <div class="flex justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Competition Detail Modal -->
    <div id="competition-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeCompetitionModal(event)">
      <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div id="competition-modal-content"></div>
      </div>
    </div>

    <!-- Guidelines Modal -->
    <div id="guidelines-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeGuidelines(event)">
      <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 p-6 text-white">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <i class="fas fa-trophy text-5xl mr-4"></i>
              <div>
                <h2 class="text-3xl font-bold">Competition Guidelines</h2>
                <p class="text-yellow-100">How our competitions work</p>
              </div>
            </div>
            <button onclick="closeGuidelines()" class="text-white hover:text-yellow-200 text-2xl">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        
        <div class="p-8 space-y-6 text-gray-800">
          <p class="text-lg leading-relaxed">
            Welcome to ASTAR*'s weekly and monthly startup competitions! Here's how it works:
          </p>

          <div class="space-y-4">
            <div class="flex items-start">
              <div class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">1</div>
              <div>
                <h3 class="font-bold text-xl mb-2">Always Competing</h3>
                <p class="text-gray-700">As soon as you join the ASTAR* community, you're automatically part of our weekly progress competitions. You don't have to sign up each time—just focus on growing your startup and we highlight best performing teams through the Leaderboard and weekly update emails.</p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">2</div>
              <div>
                <h3 class="font-bold text-xl mb-2">Weekly Progress Highlights</h3>
                <p class="text-gray-700">Every Friday at 5 PM, we highlight the top three startups that have shown the most growth based on the metrics we track. We'll feature you on our platform, share your progress, and even offer interviews and promotions.</p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">3</div>
              <div>
                <h3 class="font-bold text-xl mb-2">Monthly Pitch Event</h3>
                <p class="text-gray-700">On the last Thursday of each month, we host a special live competition where you can pitch your startup. This event does require a ticket, and the winner takes home the prize pool from those ticket sales. It's a great chance to compete for bigger stakes and gain even more visibility.</p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">4</div>
              <div>
                <h3 class="font-bold text-xl mb-2">Why We Do It</h3>
                <p class="text-gray-700">We want to celebrate real progress. Instead of focusing only on pitches, we reward the hard work you put in week after week. And as you grow, you'll have the chance to shine in front of potential investors, sponsors, and the whole ASTAR* community.</p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="bg-primary text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">5</div>
              <div>
                <h3 class="font-bold text-xl mb-2">Optional Tools and Insights</h3>
                <p class="text-gray-700">While participation is free, we also offer premium analytics tools if you want deeper insights into your performance and how you stack up.</p>
              </div>
            </div>
          </div>

          <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl mt-8">
            <p class="text-lg font-semibold text-primary mb-2">In short:</p>
            <p class="text-gray-700">just join the community, keep building, and let the competition highlight your growth. We believe in you, good luck! 🚀</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentTab = 'monthly';
      let weeklyCompetitions = [];
      let monthlyCompetitions = [];

      // Load competitions on page load
      document.addEventListener('DOMContentLoaded', () => {
        loadCompetitions();
      });

      async function loadCompetitions() {
        try {
          // Load weekly competitions
          const weeklyRes = await axios.get('/api/competitions?type=weekly');
          weeklyCompetitions = weeklyRes.data.competitions;
          renderWeeklyCompetitions();

          // Load monthly competitions
          const monthlyRes = await axios.get('/api/competitions?type=monthly');
          monthlyCompetitions = monthlyRes.data.competitions;
          renderMonthlyCompetitions();
        } catch (error) {
          console.error('Error loading competitions:', error);
        }
      }

      function renderWeeklyCompetitions() {
        const grid = document.getElementById('weekly-grid');
        
        if (weeklyCompetitions.length === 0) {
          grid.innerHTML = '<div class="col-span-2 text-center py-12 text-gray-500">No active competitions</div>';
          return;
        }

        grid.innerHTML = weeklyCompetitions.map(comp => \`
          <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition">
            <div class="bg-gradient-to-r from-green-500 to-teal-500 px-4 py-3 flex items-center justify-between">
              <span class="bg-white text-green-700 text-xs font-bold px-3 py-1 rounded-full">LIVE</span>
              <span class="text-white text-sm font-medium">Prize: \${comp.prize_amount}</span>
            </div>
            
            <div class="p-6">
              <h3 class="text-xl font-bold text-gray-900 mb-3">\${comp.title}</h3>
              <p class="text-gray-700 mb-4 line-clamp-2">\${comp.description}</p>
              
              <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
                <span><i class="far fa-calendar mr-1"></i> Closes: \${comp.deadline || 'Sunday 11:59 PM'}</span>
                <span><i class="fas fa-users mr-1"></i> Auto-tracking progress</span>
              </div>
              
              <a href="/leaderboard" class="block w-full bg-primary text-white px-4 py-3 rounded-lg font-semibold hover:bg-primary/90 transition text-center">
                <i class="fas fa-trophy mr-2"></i>View Top 3 Winners
              </a>
            </div>
          </div>
        \`).join('');
      }

      function renderMonthlyCompetitions() {
        const grid = document.getElementById('monthly-grid');
        
        if (monthlyCompetitions.length === 0) {
          grid.innerHTML = '<div class="text-center py-12 text-gray-500">No upcoming events</div>';
          return;
        }

        grid.innerHTML = monthlyCompetitions.map(comp => \`
          <div class="bg-gradient-to-r from-purple-900 to-indigo-900 rounded-xl shadow-2xl overflow-hidden text-white">
            <div class="flex flex-col md:flex-row">
              <!-- Event Image -->
              <div class="md:w-1/3 relative">
                <img src="https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=400" alt="Event" class="w-full h-full object-cover">
                <div class="absolute top-4 left-4">
                  <div class="bg-blue-500 text-white px-3 py-1 rounded-lg font-bold text-sm">
                    \${comp.event_date ? new Date(comp.event_date).toLocaleDateString('en-US', { weekday: 'short', day: '2-digit', month: 'short' }).toUpperCase() : 'TBA'}
                  </div>
                </div>
              </div>

              <!-- Event Details -->
              <div class="md:w-2/3 p-8">
                <div class="flex items-center mb-4">
                  <div class="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full mr-3">\${comp.event_time || ''}</div>
                </div>
                
                <h2 class="text-3xl font-bold mb-4">\${comp.title}</h2>
                
                <p class="text-purple-200 mb-4">\${comp.description}</p>
                
                <div class="flex items-center space-x-4 text-sm mb-6">
                  <span><i class="fas fa-map-marker-alt mr-2"></i>\${comp.location || 'TBA'}</span>
                  <span><i class="fas fa-ticket-alt mr-2"></i>\${comp.ticket_price ? '$' + comp.ticket_price : 'Free'}</span>
                </div>

                <div class="flex items-center space-x-4">
                  <a href="\${comp.payment_link || '#'}" target="_blank" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-8 py-3 rounded-lg font-bold hover:opacity-90 transition">
                    <i class="fas fa-ticket-alt mr-2"></i>Get Ticket & Register
                  </a>
                  <span class="text-purple-200 text-sm">\${comp.paid_count || 0} attending</span>
                </div>
              </div>
            </div>
          </div>
        \`).join('');
      }

      async function showCompetitionDetail(competitionId) {
        try {
          const response = await axios.get(\`/api/competitions/\${competitionId}\`);
          const { competition, participants, winners } = response.data;

          // Check if user is already registered
          const token = getAuthToken();
          let isRegistered = false;
          let userRegistration = null;
          
          if (token) {
            try {
              const regCheck = await axios.get(\`/api/competitions/\${competitionId}/check-registration\`, {
                headers: { Authorization: \`Bearer \${token}\` }
              });
              isRegistered = regCheck.data.registered;
              userRegistration = regCheck.data.registration;
            } catch (e) {}
          }

          // Load user's projects and products for the dropdown
          let userProjects = [];
          let userProducts = [];
          if (token && !isRegistered) {
            try {
              // Get current user ID from token
              const tokenPayload = JSON.parse(atob(token.split('.')[1]));
              const currentUserId = tokenPayload.userId;
              
              console.log('[COMPETITIONS] Current user ID:', currentUserId);
              
              // Load projects
              const projectsRes = await axios.get('/api/projects', {
                headers: { Authorization: \`Bearer \${token}\` }
              });
              const allProjects = projectsRes.data.projects || [];
              console.log('[COMPETITIONS] All projects:', allProjects.length);
              
              // Filter projects by current user
              userProjects = allProjects.filter(p => {
                const match = p.user_id === currentUserId;
                if (!match) console.log('[COMPETITIONS] Project', p.title, 'user_id:', p.user_id, 'does not match');
                return match;
              });
              console.log('[COMPETITIONS] User projects:', userProjects.length);

              // Load beta products
              try {
                const productsRes = await axios.get('/api/marketplace/products?limit=100', {
                  headers: { Authorization: \`Bearer \${token}\` }
                });
                const allProducts = productsRes.data.products || [];
                console.log('[COMPETITIONS] All products:', allProducts.length);
                
                // Filter products by current user
                userProducts = allProducts.filter(p => {
                  const match = p.company_user_id === currentUserId;
                  if (!match) console.log('[COMPETITIONS] Product', p.title, 'company_user_id:', p.company_user_id, 'does not match');
                  return match;
                });
                console.log('[COMPETITIONS] User products:', userProducts.length);
              } catch (e) {
                console.error('Failed to load products:', e);
              }
            } catch (e) {
              console.error('Failed to load projects:', e);
            }
          }

          const modal = document.getElementById('competition-modal');
          const content = document.getElementById('competition-modal-content');

          content.innerHTML = \`
            <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-2xl font-bold mb-2">\${competition.title}</h2>
                  <div class="flex items-center space-x-4 text-sm">
                    <span><i class="fas fa-trophy mr-1"></i> \${competition.prize_amount}</span>
                    \${competition.event_date ? \`<span><i class="far fa-calendar mr-1"></i> \${new Date(competition.event_date).toLocaleDateString()}</span>\` : ''}
                    <span><i class="fas fa-users mr-1"></i> \${participants.length} registered</span>
                  </div>
                </div>
                <button onclick="closeCompetitionModal()" class="text-white hover:text-purple-200 text-2xl">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <div class="p-6 space-y-6">
              <!-- Tabs: Details | Leaderboard -->
              <div class="flex border-b border-gray-200 mb-4">
                <button onclick="showCompDetailTab('details', \${competition.id})" id="details-tab-\${competition.id}" class="comp-detail-tab px-4 py-2 text-sm font-semibold border-b-2 border-primary text-primary">
                  <i class="fas fa-info-circle mr-1"></i> Details
                </button>
                <button onclick="showCompDetailTab('leaderboard', \${competition.id})" id="leaderboard-tab-\${competition.id}" class="comp-detail-tab px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-500">
                  <i class="fas fa-trophy mr-1"></i> Live Leaderboard
                </button>
              </div>

              <!-- Details Tab -->
              <div id="details-content-\${competition.id}" class="comp-detail-content">
                <!-- Description -->
                <div>
                  <h3 class="font-bold text-gray-900 mb-2">About</h3>
                  <p class="text-gray-700">\${competition.description}</p>
                </div>

                <!-- Guidelines -->
                \${competition.guidelines ? \`
                  <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="font-bold text-gray-900 mb-2 flex items-center">
                      <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                      Guidelines
                    </h3>
                    <p class="text-gray-700">\${competition.guidelines}</p>
                  </div>
                \` : ''}

                <!-- Registration Form -->
                \${isRegistered ? \`
                  <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                      <i class="fas fa-check-circle text-green-600 text-2xl mr-3"></i>
                      <div>
                        <p class="font-bold text-green-900">You're registered!</p>
                        \${userRegistration?.payment_status === 'pending' && competition.ticket_required ? \`
                          <p class="text-sm text-green-700 mt-1">Payment pending. Please complete your payment.</p>
                          <a href="\${competition.payment_link}" target="_blank" class="inline-block mt-2 bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700">
                            Complete Payment
                          </a>
                        \` : ''}
                      </div>
                    </div>
                  </div>
                \` : \`
                  <form id="registration-form" class="space-y-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Select Your Project or Product *</label>
                      <select name="project_id" id="project-select" class="w-full border border-gray-300 rounded-lg px-4 py-2" required>
                        <option value="">-- Select a project/product or enter manually --</option>
                      </select>
                      <p class="text-xs text-gray-500 mt-1">Choose from your existing projects/products or leave blank to enter details manually</p>
                    </div>

                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Startup Name *</label>
                      <input type="text" name="startup_name" id="startup-name" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                      <p class="text-xs text-gray-500 mt-1">Will auto-fill if you select a project above</p>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Pitch Deck URL</label>
                      <input type="url" name="pitch_deck_url" placeholder="https://" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                    </div>
                    
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Submission Notes</label>
                      <textarea name="submission_notes" id="submission-notes" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Tell us about your submission..."></textarea>
                      <p class="text-xs text-gray-500 mt-1">Will auto-fill with project description if you select a project</p>
                    </div>

                    \${competition.ticket_required ? \`
                      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-sm text-yellow-900">
                          <i class="fas fa-ticket-alt mr-2"></i>
                          This competition requires a ticket ($\${competition.ticket_price}). You'll be redirected to payment after registration.
                        </p>
                      </div>
                    \` : ''}

                    <button type="submit" class="w-full bg-primary text-white px-6 py-3 rounded-lg font-bold hover:bg-primary/90 transition">
                      <i class="fas fa-rocket mr-2"></i>Register Now
                    </button>
                  </form>
                \`}

                <!-- Winners -->
                \${winners.length > 0 ? \`
                  <div>
                    <h3 class="font-bold text-gray-900 mb-3 flex items-center">
                      <i class="fas fa-crown text-yellow-500 mr-2"></i>
                      Winners
                    </h3>
                    <div class="space-y-2">
                      \${winners.map(w => \`
                        <div class="flex items-center justify-between bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg">
                          <div class="flex items-center">
                            <span class="text-2xl mr-3">\${w.position === 1 ? '🥇' : w.position === 2 ? '🥈' : '🥉'}</span>
                            <div>
                              <p class="font-bold text-gray-900">\${w.name}</p>
                              <p class="text-sm text-gray-600">\${w.startup_name || ''}</p>
                            </div>
                          </div>
                          <span class="font-bold text-yellow-600">\${w.prize_amount}</span>
                        </div>
                    \`).join('')}
                  </div>
                </div>
              \` : ''}
              </div>

              <!-- Leaderboard Tab -->
              <div id="leaderboard-content-\${competition.id}" class="comp-detail-content hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                  <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-600 text-xl mr-3 mt-1"></i>
                    <div class="text-sm text-blue-900">
                      <p class="font-semibold mb-1">How Ranking Works:</p>
                      <ul class="list-disc list-inside space-y-1">
                        <li><strong>Votes:</strong> Investors' votes count 2x, Validators' votes count 1x</li>
                        <li><strong>Growth:</strong> 10 points per completed goal + completion rate bonus</li>
                        <li><strong>Total Score:</strong> Combined vote score + growth score</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div id="leaderboard-list-\${competition.id}" class="space-y-3">
                  <!-- Leaderboard will load here -->
                  <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
                  </div>
                </div>
              </div>
            </div>
          \`;

          // Add form submit handler
          if (!isRegistered) {
            // Populate project/product dropdown
            const projectSelect = document.getElementById('project-select');
            console.log('[COMPETITIONS] Populating dropdown - Projects:', userProjects.length, 'Products:', userProducts.length);
            
            if (projectSelect) {
              // Add optgroup for projects
              if (userProjects.length > 0) {
                console.log('[COMPETITIONS] Adding projects to dropdown:', userProjects.map(p => p.title));
                const projectsGroup = document.createElement('optgroup');
                projectsGroup.label = '📁 My Projects';
                userProjects.forEach(project => {
                  const option = document.createElement('option');
                  option.value = 'project-' + project.id;
                  option.textContent = project.title;
                  option.dataset.type = 'project';
                  option.dataset.description = project.description || '';
                  projectsGroup.appendChild(option);
                });
                projectSelect.appendChild(projectsGroup);
              }

              // Add optgroup for products
              if (userProducts.length > 0) {
                console.log('[COMPETITIONS] Adding products to dropdown:', userProducts.map(p => p.title));
                const productsGroup = document.createElement('optgroup');
                productsGroup.label = '🚀 My Beta Products';
                userProducts.forEach(product => {
                  const option = document.createElement('option');
                  option.value = 'product-' + product.id;
                  option.textContent = product.title;
                  option.dataset.type = 'product';
                  option.dataset.description = product.description || '';
                  productsGroup.appendChild(option);
                });
                projectSelect.appendChild(productsGroup);
              }

              console.log('[COMPETITIONS] Dropdown populated. Total options:', projectSelect.options.length);

              // Auto-fill form when project/product selected
              projectSelect.addEventListener('change', (e) => {
                const selectedOption = e.target.selectedOptions[0];
                if (selectedOption && selectedOption.value) {
                  document.getElementById('startup-name').value = selectedOption.textContent;
                  document.getElementById('submission-notes').value = selectedOption.dataset.description || '';
                } else {
                  document.getElementById('startup-name').value = '';
                  document.getElementById('submission-notes').value = '';
                }
              });
            }

            document.getElementById('registration-form').addEventListener('submit', async (e) => {
              e.preventDefault();
              await handleRegistration(competitionId);
            });
          }

          modal.classList.remove('hidden');
          modal.classList.add('flex');

          // Load leaderboard data
          loadCompetitionLeaderboard(competitionId);
        } catch (error) {
          console.error('Error loading competition details:', error);
          alert('Failed to load competition details');
        }
      }

      async function loadCompetitionLeaderboard(competitionId) {
        try {
          const response = await axios.get(\`/api/competitions/\${competitionId}/leaderboard-data\`);
          const participants = response.data.participants || [];

          const leaderboardList = document.getElementById(\`leaderboard-list-\${competitionId}\`);
          if (!leaderboardList) return;

          if (participants.length === 0) {
            leaderboardList.innerHTML = \`
              <div class="text-center py-8 text-gray-500">
                <i class="fas fa-users text-4xl mb-2 opacity-50"></i>
                <p>No participants yet. Be the first to join!</p>
              </div>
            \`;
            return;
          }

          leaderboardList.innerHTML = participants.map((p, index) => {
            const rank = index + 1;
            const medal = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : '';
            const bgGradient = rank === 1 ? 'from-yellow-50 to-yellow-100 border-yellow-300' :
                              rank === 2 ? 'from-gray-50 to-gray-100 border-gray-300' :
                              rank === 3 ? 'from-orange-50 to-orange-100 border-orange-300' :
                              'from-white to-gray-50 border-gray-200';

            const userRole = '${a}';
            const canVote = userRole === 'validator' || userRole === 'investor';

            return \`
              <div class="bg-gradient-to-r \${bgGradient} border-2 rounded-xl p-4 hover:shadow-md transition">
                <div class="flex items-start justify-between">
                  <div class="flex items-start space-x-4 flex-1">
                    <!-- Rank -->
                    <div class="flex flex-col items-center">
                      <div class="text-3xl font-bold text-gray-800">
                        \${medal || '#' + rank}
                      </div>
                      <div class="text-xs text-gray-500 mt-1">Rank</div>
                    </div>

                    <!-- Avatar and Info -->
                    <div class="flex-1">
                      <div class="flex items-center mb-2">
                        <img src="\${p.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + p.name}" 
                             alt="\${p.name}" 
                             class="w-10 h-10 rounded-full border-2 border-white shadow mr-3">
                        <div>
                          <h4 class="font-bold text-gray-900">\${p.name}</h4>
                          <p class="text-sm text-gray-600">\${p.project_title || p.startup_name || 'No project'}</p>
                        </div>
                      </div>

                      \${p.project_description ? \`
                        <p class="text-sm text-gray-700 mb-2">\${p.project_description.substring(0, 120)}...</p>
                      \` : ''}

                      <div class="flex items-center space-x-4 text-xs text-gray-600">
                        <span><i class="fas fa-calendar-check mr-1"></i>\${new Date(p.registration_date).toLocaleDateString()}</span>
                        <span><i class="fas fa-thumbs-up mr-1"></i>\${p.vote_count || 0} votes</span>
                        \${p.pitch_deck_url ? \`<a href="\${p.pitch_deck_url}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-file-pdf mr-1"></i>Pitch Deck</a>\` : ''}
                      </div>
                    </div>

                    <!-- Scores -->
                    <div class="text-right">
                      <div class="bg-white rounded-lg p-3 shadow-sm mb-2">
                        <div class="text-2xl font-bold text-primary">\${p.total_score?.toFixed(1) || '0.0'}</div>
                        <div class="text-xs text-gray-500">Total Score</div>
                      </div>
                      <div class="text-xs space-y-1">
                        <div class="flex justify-between">
                          <span class="text-gray-600">Votes:</span>
                          <span class="font-semibold text-blue-600">\${p.vote_score?.toFixed(1) || '0.0'}</span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-gray-600">Growth:</span>
                          <span class="font-semibold text-green-600">\${p.growth_score?.toFixed(1) || '0.0'}</span>
                        </div>
                        \${p.avg_vote_score ? \`
                          <div class="flex justify-between">
                            <span class="text-gray-600">Avg Rating:</span>
                            <span class="font-semibold text-purple-600">\${p.avg_vote_score.toFixed(1)}/10</span>
                          </div>
                        \` : ''}
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Vote Button (for validators and investors) -->
                \${canVote ? \`
                  <div class="mt-3 pt-3 border-t border-gray-200">
                    <button 
                      onclick="showVoteModal(\${competitionId}, \${p.id}, '\${p.name}', '\${p.project_title || p.startup_name}')"
                      class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:opacity-90 transition">
                      <i class="fas fa-star mr-2"></i>Vote for this startup
                    </button>
                  </div>
                \` : ''}
              </div>
            \`;
          }).join('');
        } catch (error) {
          console.error('Error loading leaderboard:', error);
          const leaderboardList = document.getElementById(\`leaderboard-list-\${competitionId}\`);
          if (leaderboardList) {
            leaderboardList.innerHTML = \`
              <div class="text-center py-8 text-red-500">
                <i class="fas fa-exclamation-circle text-4xl mb-2"></i>
                <p>Failed to load leaderboard</p>
              </div>
            \`;
          }
        }
      }

      function showCompDetailTab(tab, competitionId) {
        // Update tab styles
        document.querySelectorAll('.comp-detail-tab').forEach(t => {
          t.classList.remove('text-primary', 'border-primary');
          t.classList.add('text-gray-500', 'border-transparent');
        });
        const activeTab = document.getElementById(\`\${tab}-tab-\${competitionId}\`);
        if (activeTab) {
          activeTab.classList.remove('text-gray-500', 'border-transparent');
          activeTab.classList.add('text-primary', 'border-primary');
        }
        
        // Show/hide content
        document.querySelectorAll(\`.comp-detail-content\`).forEach(c => c.classList.add('hidden'));
        const activeContent = document.getElementById(\`\${tab}-content-\${competitionId}\`);
        if (activeContent) {
          activeContent.classList.remove('hidden');
        }

        // Load leaderboard data when tab is shown
        if (tab === 'leaderboard') {
          loadCompetitionLeaderboard(competitionId);
        }
      }

      async function showVoteModal(competitionId, participantId, participantName, projectTitle) {
        const score = prompt(\`Vote for \${participantName} (\${projectTitle})\\n\\nEnter your score (1-10):\`);
        if (!score) return;

        const voteScore = parseInt(score);
        if (isNaN(voteScore) || voteScore < 1 || voteScore > 10) {
          alert('Please enter a valid score between 1 and 10');
          return;
        }

        const comment = prompt(\`Optional: Add a comment about your vote:\`) || '';

        try {
          const token = getAuthToken();
          if (!token) {
            alert('Please log in to vote');
            return;
          }

          await axios.post(
            \`/api/competitions/\${competitionId}/participants/\${participantId}/vote\`,
            { vote_score: voteScore, comment },
            { headers: { Authorization: \`Bearer \${token}\` } }
          );

          alert('Vote submitted successfully!');
          
          // Reload leaderboard
          loadCompetitionLeaderboard(competitionId);
        } catch (error) {
          console.error('Error submitting vote:', error);
          alert(error.response?.data?.error || 'Failed to submit vote');
        }
      }

      async function handleRegistration(competitionId) {
        try {
          const form = document.getElementById('registration-form');
          const formData = new FormData(form);
          
          // Parse project_id which could be "project-123" or "product-456" or null
          let projectId = null;
          const selectedValue = formData.get('project_id');
          if (selectedValue && selectedValue.startsWith('project-')) {
            projectId = parseInt(selectedValue.replace('project-', ''));
          } else if (selectedValue && selectedValue.startsWith('product-')) {
            // For products, we might need to handle differently or just use the ID
            projectId = parseInt(selectedValue.replace('product-', ''));
          }
          
          const data = {
            project_id: projectId,
            startup_name: formData.get('startup_name'),
            pitch_deck_url: formData.get('pitch_deck_url'),
            submission_notes: formData.get('submission_notes')
          };

          const token = getAuthToken();
          if (!token) {
            alert('Please log in to register');
            window.location.href = '/';
            return;
          }

          const response = await axios.post(\`/api/competitions/\${competitionId}/register\`, data, {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          if (response.data.success) {
            // Always redirect to Four Revenues payment link if available
            if (response.data.payment_link) {
              alert('Registration successful! Redirecting to payment...');
              window.location.href = response.data.payment_link;
            } else {
              alert('Successfully registered for the competition!');
              closeCompetitionModal();
              loadCompetitions();
            }
          }
        } catch (error) {
          console.error('Error registering:', error);
          alert(error.response?.data?.error || 'Failed to register for competition');
        }
      }

      function closeCompetitionModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('competition-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }

      function showCompetitionsTab(tab) {
        currentTab = tab;
        
        // Update tab styles
        document.querySelectorAll('.comp-tab').forEach(t => {
          t.classList.remove('text-primary', 'border-primary');
          t.classList.add('text-gray-500', 'border-transparent');
        });
        document.getElementById(tab + '-tab').classList.remove('text-gray-500', 'border-transparent');
        document.getElementById(tab + '-tab').classList.add('text-primary', 'border-primary');
        
        // Show/hide content
        document.querySelectorAll('.competitions-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(tab + '-competitions').classList.remove('hidden');
      }

      function showGuidelines() {
        document.getElementById('guidelines-modal').classList.remove('hidden');
        document.getElementById('guidelines-modal').classList.add('flex');
      }

      function closeGuidelines(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('guidelines-modal').classList.add('hidden');
        document.getElementById('guidelines-modal').classList.remove('flex');
      }

      function getAuthToken() {
        return localStorage.getItem('authToken');
      }
    <\/script>
  `;return br({content:s,currentPage:"competitions",userName:t,userAvatar:r,pageTitle:"Competitions",userRole:a})}function ku(e){const{userName:t,userAvatar:r,userRole:a}=e;return br({content:`
    <div class="p-4 md:p-8 max-w-7xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">📅 Events</h1>
        <p class="text-gray-600">Join live pitch events, workshops, and networking sessions</p>
      </div>

      ${a==="admin"?`
      <!-- Admin Actions -->
      <div class="mb-6 flex justify-end">
        <button onclick="openCreateEventModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 shadow-lg">
          <i class="fas fa-plus"></i>
          Create Event
        </button>
      </div>
      `:""}

      <!-- Featured Events -->
      <div id="featured-events" class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">⭐ Featured Events</h2>
        <div id="featured-events-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Loading -->
          <div class="col-span-full text-center py-8 text-gray-500">
            <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
            <p>Loading events...</p>
          </div>
        </div>
      </div>

      <!-- All Events -->
      <div id="all-events">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">🗓️ Upcoming Events</h2>
        <div id="all-events-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Events will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Event Details Modal -->
    <div id="event-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div id="event-details-content">
          <!-- Event details will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Create/Edit Event Modal (Admin only) -->
    ${a==="admin"?`
    <div id="create-event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Create New Event</h2>
            <button onclick="closeCreateEventModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>

          <form id="create-event-form" class="space-y-4">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Event Title*</label>
              <input type="text" name="title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Description*</label>
              <textarea name="description" required rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Event Type*</label>
                <select name="event_type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                  <option value="pitch">Pitch Event</option>
                  <option value="workshop">Workshop</option>
                  <option value="networking">Networking</option>
                  <option value="webinar">Webinar</option>
                  <option value="competition">Competition</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Event Date*</label>
                <input type="date" name="event_date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Time</label>
                <input type="time" name="event_time" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Duration (minutes)</label>
                <input type="number" name="duration_minutes" value="60" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
              <input type="text" name="location" placeholder="Online, Madrid, etc." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Meeting Link</label>
              <input type="url" name="meeting_link" placeholder="https://zoom.us/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Registration Link</label>
              <input type="url" name="registration_link" placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Max Participants</label>
              <input type="number" name="max_participants" placeholder="Leave empty for unlimited" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Banner Image URL</label>
              <input type="url" name="banner_image_url" placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Host Name</label>
                <input type="text" name="host_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Host Avatar URL</label>
                <input type="url" name="host_avatar" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
              </div>
            </div>

            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Tags (comma separated)</label>
              <input type="text" name="tags" placeholder="early-stage, fundraising, AI" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            </div>

            <div class="flex items-center gap-2">
              <input type="checkbox" name="is_featured" id="is_featured" class="w-4 h-4 text-purple-600">
              <label for="is_featured" class="text-sm font-semibold text-gray-700">Featured Event</label>
            </div>

            <div class="flex gap-4 pt-4">
              <button type="button" onclick="closeCreateEventModal()" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50">
                Cancel
              </button>
              <button type="submit" class="flex-1 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold">
                Create Event
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    `:""}

    <script>
      // Load events on page load
      document.addEventListener('DOMContentLoaded', () => {
        loadEvents();
      });

      async function loadEvents() {
        try {
          const response = await axios.get('/api/events', {
            headers: {
              'Authorization': 'Bearer ' + document.cookie.match(/authToken=([^;]+)/)?.[1]
            }
          });

          if (response.data.success) {
            const events = response.data.events;
            const featured = events.filter(e => e.is_featured && e.status === 'upcoming');
            const upcoming = events.filter(e => !e.is_featured && e.status === 'upcoming');

            renderEvents(featured, 'featured-events-grid');
            renderEvents(upcoming, 'all-events-grid');
          }
        } catch (error) {
          console.error('Error loading events:', error);
          document.getElementById('featured-events-grid').innerHTML = '<p class="col-span-full text-center text-red-500">Failed to load events</p>';
        }
      }

      function renderEvents(events, containerId) {
        const container = document.getElementById(containerId);
        
        if (events.length === 0) {
          container.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No events available</p>';
          return;
        }

        const isAdmin = ${a==="admin"?"true":"false"};

        container.innerHTML = events.map(event => \`
          <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
            <div onclick="showEventDetails(\${event.id})" class="cursor-pointer">
            \${event.banner_image_url ? \`
              <img src="\${event.banner_image_url}" alt="\${event.title}" class="w-full h-48 object-cover">
            \` : \`
              <div class="w-full h-48 bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-6xl">
                📅
              </div>
            \`}
            <div class="p-6">
              <div class="flex items-start justify-between mb-2">
                <h3 class="text-xl font-bold text-gray-900">\${event.title}</h3>
                \${event.is_featured ? '<span class="text-yellow-500 text-xl">⭐</span>' : ''}
              </div>
              <p class="text-gray-600 text-sm mb-4 line-clamp-2">\${event.description}</p>
              
              <div class="space-y-2 text-sm text-gray-600">
                <div class="flex items-center gap-2">
                  <i class="fas fa-calendar text-purple-500"></i>
                  <span>\${new Date(event.event_date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span>
                </div>
                \${event.event_time ? \`
                  <div class="flex items-center gap-2">
                    <i class="fas fa-clock text-purple-500"></i>
                    <span>\${event.event_time}</span>
                  </div>
                \` : ''}
                <div class="flex items-center gap-2">
                  <i class="fas fa-map-marker-alt text-purple-500"></i>
                  <span>\${event.location || 'Online'}</span>
                </div>
                <div class="flex items-center gap-2">
                  <i class="fas fa-users text-purple-500"></i>
                  <span>\${event.registered_count || 0}\${event.max_participants ? ' / ' + event.max_participants : ''} registered</span>
                </div>
              </div>

              <div class="mt-4 pt-4 border-t border-gray-200">
                <span class="inline-block px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-semibold">
                  \${event.event_type}
                </span>
              </div>
            </div>
            </div>
            \${isAdmin ? \`
              <div class="px-6 pb-4 flex gap-2">
                <button onclick="event.stopPropagation(); deleteEvent(\${event.id})" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                  <i class="fas fa-trash mr-2"></i>Delete
                </button>
              </div>
            \` : ''}
          </div>
        \`).join('');
      }

      async function showEventDetails(eventId) {
        try {
          const response = await axios.get(\`/api/events/\${eventId}\`, {
            headers: {
              'Authorization': 'Bearer ' + document.cookie.match(/authToken=([^;]+)/)?.[1]
            }
          });

          if (response.data.success) {
            const event = response.data.event;
            const modal = document.getElementById('event-details-modal');
            const content = document.getElementById('event-details-content');

            const isRegistered = event.registrations.some(r => r.user_id === parseInt(localStorage.getItem('userId')));
            const isAdmin = ${a==="admin"?"true":"false"};

            content.innerHTML = \`
              <div>
                \${event.banner_image_url ? \`
                  <img src="\${event.banner_image_url}" alt="\${event.title}" class="w-full h-64 object-cover">
                \` : \`
                  <div class="w-full h-64 bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white text-8xl">
                    📅
                  </div>
                \`}
                <div class="p-8">
                  <h2 class="text-3xl font-bold text-gray-900 mb-4">\${event.title}</h2>
                  <p class="text-gray-700 mb-6">\${event.description}</p>

                  <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="flex items-center gap-3 text-gray-700">
                      <i class="fas fa-calendar text-purple-500 text-xl"></i>
                      <div>
                        <p class="text-sm text-gray-500">Date</p>
                        <p class="font-semibold">\${new Date(event.event_date).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                      </div>
                    </div>
                    \${event.event_time ? \`
                      <div class="flex items-center gap-3 text-gray-700">
                        <i class="fas fa-clock text-purple-500 text-xl"></i>
                        <div>
                          <p class="text-sm text-gray-500">Time</p>
                          <p class="font-semibold">\${event.event_time}</p>
                        </div>
                      </div>
                    \` : ''}
                    <div class="flex items-center gap-3 text-gray-700">
                      <i class="fas fa-map-marker-alt text-purple-500 text-xl"></i>
                      <div>
                        <p class="text-sm text-gray-500">Location</p>
                        <p class="font-semibold">\${event.location || 'Online'}</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-3 text-gray-700">
                      <i class="fas fa-users text-purple-500 text-xl"></i>
                      <div>
                        <p class="text-sm text-gray-500">Participants</p>
                        <p class="font-semibold">\${event.registered_count || 0}\${event.max_participants ? ' / ' + event.max_participants : ''}</p>
                      </div>
                    </div>
                  </div>

                  <div class="flex gap-4 mb-6">
                    \${!isRegistered ? \`
                      <button onclick="registerForEvent(\${event.id})" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold">
                        Register Now
                      </button>
                    \` : \`
                      <button onclick="unregisterFromEvent(\${event.id})" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold">
                        Unregister
                      </button>
                    \`}
                    \${event.meeting_link ? \`
                      <a href="\${event.meeting_link}" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold text-center">
                        Join Meeting
                      </a>
                    \` : ''}
                    \${event.registration_link ? \`
                      <a href="\${event.registration_link}" target="_blank" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold text-center">
                        External Registration
                      </a>
                    \` : ''}
                  </div>

                  \${isAdmin ? \`
                    <button onclick="deleteEventFromModal(\${event.id})" class="w-full mb-4 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold">
                      <i class="fas fa-trash mr-2"></i>Delete Event
                    </button>
                  \` : ''}

                  <button onclick="closeEventDetails()" class="w-full px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50">
                    Close
                  </button>
                </div>
              </div>
            \`;

            modal.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error loading event details:', error);
          alert('Failed to load event details');
        }
      }

      function closeEventDetails() {
        document.getElementById('event-details-modal').classList.add('hidden');
      }

      async function registerForEvent(eventId) {
        try {
          const response = await axios.post(\`/api/events/\${eventId}/register\`, {}, {
            headers: {
              'Authorization': 'Bearer ' + document.cookie.match(/authToken=([^;]+)/)?.[1]
            }
          });

          if (response.data.success) {
            alert('Successfully registered for event!');
            closeEventDetails();
            loadEvents();
          }
        } catch (error) {
          console.error('Error registering for event:', error);
          alert(error.response?.data?.error || 'Failed to register for event');
        }
      }

      async function unregisterFromEvent(eventId) {
        if (!confirm('Are you sure you want to unregister from this event?')) {
          return;
        }

        try {
          const response = await axios.delete(\`/api/events/\${eventId}/register\`, {
            headers: {
              'Authorization': 'Bearer ' + document.cookie.match(/authToken=([^;]+)/)?.[1]
            }
          });

          if (response.data.success) {
            alert('Successfully unregistered from event');
            closeEventDetails();
            loadEvents();
          }
        } catch (error) {
          console.error('Error unregistering from event:', error);
          alert('Failed to unregister from event');
        }
      }

      ${a==="admin"?`
      async function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }

        try {
          const response = await axios.delete(\`/api/events/\${eventId}\`, {
            headers: {
              'Authorization': 'Bearer ' + document.cookie.match(/authToken=([^;]+)/)?.[1]
            }
          });

          if (response.data.success) {
            alert('Event deleted successfully');
            loadEvents();
          }
        } catch (error) {
          console.error('Error deleting event:', error);
          alert('Failed to delete event');
        }
      }

      async function deleteEventFromModal(eventId) {
        if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
          return;
        }

        try {
          const response = await axios.delete(\`/api/events/\${eventId}\`, {
            headers: {
              'Authorization': 'Bearer ' + document.cookie.match(/authToken=([^;]+)/)?.[1]
            }
          });

          if (response.data.success) {
            alert('Event deleted successfully');
            closeEventDetails();
            loadEvents();
          }
        } catch (error) {
          console.error('Error deleting event:', error);
          alert('Failed to delete event');
        }
      }

      function openCreateEventModal() {
        document.getElementById('create-event-modal').classList.remove('hidden');
      }

      function closeCreateEventModal() {
        document.getElementById('create-event-modal').classList.add('hidden');
        document.getElementById('create-event-form').reset();
      }

      document.getElementById('create-event-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        // Convert tags to array
        if (data.tags) {
          data.tags = data.tags.split(',').map(t => t.trim());
        }

        // Convert checkbox to boolean
        data.is_featured = formData.get('is_featured') === 'on';

        try {
          const response = await axios.post('/api/events', data, {
            headers: {
              'Authorization': 'Bearer ' + document.cookie.match(/authToken=([^;]+)/)?.[1]
            }
          });

          if (response.data.success) {
            alert('Event created successfully!');
            closeCreateEventModal();
            loadEvents();
          }
        } catch (error) {
          console.error('Error creating event:', error);
          alert('Failed to create event');
        }
      });
      `:""}
    <\/script>
  `,currentPage:"competitions",userName:t,userAvatar:r,pageTitle:"Events - ASTAR*",userRole:a})}function Du(e){const{userName:t,userAvatar:r,userRole:a}=e;return br({content:`
    <div class="p-6">
      <!-- Header -->
      <div class="mb-8">
        <div class="inline-block bg-purple-100 text-purple-800 px-4 py-2 rounded-full text-sm font-semibold mb-4">
          ASTAR LABS BETA
        </div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
          <i class="fas fa-trophy text-yellow-500 mr-3"></i>
          🏆 Discover Innovative Startups
        </h1>
        <p class="text-gray-600">Vote for your favorite startups, validate ideas, and watch them rise to the leaderboard</p>
      </div>

      <!-- Category Filter -->
      <div class="mb-8">
        <div class="flex flex-wrap gap-2">
          <button onclick="filterByCategory('all')" class="category-btn active px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition text-sm">
            All Startups
          </button>
          <button onclick="filterByCategory('SaaS')" class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">
            💻 SaaS
          </button>
          <button onclick="filterByCategory('Mobile')" class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">
            📱 Mobile
          </button>
          <button onclick="filterByCategory('Web3')" class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">
            🔗 Web3
          </button>
          <button onclick="filterByCategory('Healthcare')" class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">
            🏥 Healthcare
          </button>
          <button onclick="filterByCategory('Fintech')" class="category-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-sm">
            💰 Fintech
          </button>
        </div>
      </div>

      <!-- Leaderboard Table -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold">🏆 Startup Rankings</h2>
            <p class="text-purple-200 text-sm">Scored like a VC would evaluate</p>
          </div>
          <div class="text-sm font-medium bg-white/20 px-3 py-1 rounded-full">
            Live
          </div>
        </div>

        <!-- Scoring Legend -->
        <div class="px-6 py-3 bg-gray-50 border-b border-gray-200 text-xs text-gray-500">
          <div class="flex flex-wrap gap-4">
            <span><strong>Score =</strong></span>
            <span>🚀 Growth (35%)</span>
            <span>📈 Traction (25%)</span>
            <span>⭐ Stars (20%)</span>
            <span>✅ Execution (15%)</span>
            <span>💬 Engagement (5%)</span>
          </div>
        </div>

        <div id="leaderboard-loading" class="p-12 text-center">
          <div class="w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-gray-600 font-medium">Loading leaderboard...</p>
        </div>

        <div id="leaderboard-content" class="hidden overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Rank</th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Startup</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">VC Score</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Growth</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Stars</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Active Users</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">New/Churned</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Revenue</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Execution</th>
              </tr>
            </thead>
            <tbody id="leaderboard-tbody" class="divide-y divide-gray-200">
              <!-- Startups will be loaded here -->
            </tbody>
          </table>
        </div>

        <div id="leaderboard-empty" class="hidden p-12 text-center">
          <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">No startups in this category</h3>
          <p class="text-gray-500">Be the first to publish a startup in this category.</p>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"><\/script>
    <script>
      let currentCategory = 'all';
      let leaderboardData = [];

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        loadLeaderboard();
      });

      // Load leaderboard data
      async function loadLeaderboard() {
        try {
          showLoading();
          const response = await fetch('/api/projects/leaderboard/top?limit=50');
          const data = await response.json();
          
          if (data.leaderboard) {
            leaderboardData = data.leaderboard;
            renderLeaderboard();
          } else {
            showEmpty();
          }
        } catch (error) {
          console.error('Error loading leaderboard:', error);
          showEmpty();
        }
      }

      // Filter by category
      function filterByCategory(category) {
        currentCategory = category;
        
        // Update button styles
        document.querySelectorAll('.category-btn').forEach(btn => {
          btn.classList.remove('active', 'bg-purple-600', 'text-white');
          btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        
        event.target.classList.add('active', 'bg-purple-600', 'text-white');
        event.target.classList.remove('bg-gray-200', 'text-gray-700');
        
        renderLeaderboard();
      }

      // Render leaderboard
      function renderLeaderboard() {
        const tbody = document.getElementById('leaderboard-tbody');
        const filteredData = currentCategory === 'all' 
          ? leaderboardData 
          : leaderboardData.filter(project => project.category === currentCategory);
        
        if (filteredData.length === 0) {
          showEmpty();
          return;
        }
        
        tbody.innerHTML = filteredData.map((project, index) => {
          const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '#' + (index + 1);
          const score = project.leaderboard_score || 0;
          const vcScore = project.vc_score || 'C';
          const completedGoals = project.completed_goals || 0;
          const totalGoals = project.total_goals || 0;
          const goalsPercent = totalGoals > 0 ? (completedGoals / totalGoals * 100) : 0;
          const category = formatCategory(project.category || 'Other');
          
          // Growth indicators - prefer traction data if available
          const tractionData = project.tractionData || {};
          let userGrowthWoW = 0;
          let revenueGrowthWoW = 0;
          
          // Use traction data growth if available (more accurate)
          if (tractionData.userWoWGrowth !== undefined && tractionData.userWoWGrowth !== 0) {
            userGrowthWoW = tractionData.userWoWGrowth;
          } else if (project.growth_wow?.users) {
            userGrowthWoW = project.growth_wow.users;
          }
          
          if (tractionData.revenueWoWGrowth !== undefined && tractionData.revenueWoWGrowth !== 0) {
            revenueGrowthWoW = tractionData.revenueWoWGrowth;
          } else if (project.growth_wow?.revenue) {
            revenueGrowthWoW = project.growth_wow.revenue;
          }
          
          const avgGrowth = (userGrowthWoW + revenueGrowthWoW) / 2;
          const growthColor = avgGrowth > 10 ? 'text-green-600' : avgGrowth > 0 ? 'text-blue-600' : avgGrowth < 0 ? 'text-red-600' : 'text-gray-500';
          const growthIcon = avgGrowth > 0 ? '↑' : avgGrowth < 0 ? '↓' : '→';
          
          // For display
          const growthWoW = { users: userGrowthWoW, revenue: revenueGrowthWoW };
          
          // VC Score color
          const vcColors = {
            'A+': 'bg-green-500 text-white',
            'A': 'bg-green-400 text-white',
            'B+': 'bg-blue-500 text-white',
            'B': 'bg-blue-400 text-white',
            'C+': 'bg-yellow-500 text-white',
            'C': 'bg-yellow-400 text-gray-800',
            'D': 'bg-red-400 text-white'
          };
          const vcColor = vcColors[vcScore] || 'bg-gray-400 text-white';
          
          // Traction tracking indicator
          const isTrackingTraction = tractionData.reportingWeeks >= 2;
          const tractionBadge = isTrackingTraction 
            ? \`<span class="ml-2 px-2 py-0.5 bg-pink-100 text-pink-700 text-xs rounded-full font-semibold" title="Actively tracking weekly traction">📊 Tracking</span>\`
            : '';
          
          return \`
            <tr class="hover:bg-gray-50 transition cursor-pointer" onclick="viewStartupDetail(\${project.id})">
              <td class="px-4 py-4">
                <span class="text-2xl font-bold">\${medal}</span>
              </td>
              <td class="px-4 py-4">
                <div>
                  <div class="font-bold text-gray-900 flex items-center">
                    \${project.title}
                    \${tractionBadge}
                  </div>
                  <div class="text-sm text-gray-500">\${category}</div>
                  <div class="text-xs text-gray-400">by \${project.creator_name || 'Anonymous'}</div>
                </div>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="flex flex-col items-center">
                  <span class="px-2 py-1 rounded text-xs font-bold \${vcColor}">\${vcScore}</span>
                  <span class="text-lg font-black text-purple-600 mt-1">\${score.toFixed(1)}</span>
                </div>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="flex flex-col items-center">
                  <span class="\${growthColor} font-bold">\${growthIcon} \${Math.abs(avgGrowth).toFixed(1)}%</span>
                  <span class="text-xs text-gray-400">WoW</span>
                </div>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="flex items-center justify-center">
                  <span class="text-yellow-500 mr-1">★</span>
                  <span class="font-semibold">\${(project.rating_average || 0).toFixed(1)}</span>
                  <span class="text-gray-400 text-sm ml-1">(\${project.votes_count || 0})</span>
                </div>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="flex flex-col items-center">
                  <span class="font-semibold text-purple-600">\${formatNumber(tractionData.avgActive4w || project.current_users || 0)}</span>
                  \${growthWoW.users !== 0 ? \`<span class="text-xs \${growthWoW.users > 0 ? 'text-green-500' : 'text-red-500'}">\${growthWoW.users > 0 ? '+' : ''}\${growthWoW.users.toFixed(1)}%</span>\` : '<span class="text-xs text-gray-400">-</span>'}
                </div>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="flex flex-col items-center gap-1">
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-green-600 font-semibold" title="New users (4w)">
                      <i class="fas fa-user-plus text-xs"></i> +\${tractionData.newUsers4w || 0}
                    </span>
                    <span class="text-xs text-red-500 font-semibold" title="Churned users">
                      <i class="fas fa-user-minus text-xs"></i> -\${project.traction_churned_4w || 0}
                    </span>
                  </div>
                  <span class="text-xs text-gray-400">Last 4 weeks</span>
                </div>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="flex flex-col items-center">
                  <span class="font-semibold text-green-600">€\${formatNumber(tractionData.revenue4w || project.current_revenue || 0)}</span>
                  \${growthWoW.revenue !== 0 ? \`<span class="text-xs \${growthWoW.revenue > 0 ? 'text-green-500' : 'text-red-500'}">\${growthWoW.revenue > 0 ? '+' : ''}\${growthWoW.revenue.toFixed(1)}%</span>\` : '<span class="text-xs text-gray-400">-</span>'}
                </div>
              </td>
              <td class="px-4 py-4 text-center">
                <div class="flex flex-col items-center">
                  <div class="w-16 bg-gray-200 rounded-full h-2 mb-1">
                    <div class="bg-purple-600 h-2 rounded-full" style="width: \${goalsPercent}%"></div>
                  </div>
                  <span class="text-xs text-gray-500">\${completedGoals}/\${totalGoals}</span>
                </div>
              </td>
            </tr>
          \`;
        }).join('');
        
        showContent();
      }

      function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
      }

      function formatCategory(category) {
        if (!category) return 'Other';
        return category.replace(/-/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      }

      function viewStartupDetail(id) {
        window.location.href = '/marketplace?product=' + id;
      }

      function showLoading() {
        document.getElementById('leaderboard-loading').classList.remove('hidden');
        document.getElementById('leaderboard-content').classList.add('hidden');
        document.getElementById('leaderboard-empty').classList.add('hidden');
      }

      function showContent() {
        document.getElementById('leaderboard-loading').classList.add('hidden');
        document.getElementById('leaderboard-content').classList.remove('hidden');
        document.getElementById('leaderboard-empty').classList.add('hidden');
      }

      function showEmpty() {
        document.getElementById('leaderboard-loading').classList.add('hidden');
        document.getElementById('leaderboard-content').classList.add('hidden');
        document.getElementById('leaderboard-empty').classList.remove('hidden');
      }
    <\/script>
  `,userName:t,userAvatar:r,userRole:a,currentPage:"leaderboard"})}function Mu(e){const{userName:t,userAvatar:r,userRole:a}=e;return br({content:`
    <div class="max-w-7xl mx-auto p-6">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          <i class="fas fa-shield-alt text-primary mr-3"></i>Admin Dashboard
        </h1>
        <p class="text-gray-600">Manage competitions, view statistics, and monitor platform activity</p>
      </div>

      <!-- Stats Overview -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">
          <div class="flex items-center justify-between mb-2">
            <i class="fas fa-users text-3xl opacity-80"></i>
            <span id="total-users" class="text-3xl font-bold">0</span>
          </div>
          <p class="text-blue-100">Total Users</p>
        </div>

        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white">
          <div class="flex items-center justify-between mb-2">
            <i class="fas fa-rocket text-3xl opacity-80"></i>
            <span id="total-projects" class="text-3xl font-bold">0</span>
          </div>
          <p class="text-green-100">Total Projects</p>
        </div>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white">
          <div class="flex items-center justify-between mb-2">
            <i class="fas fa-trophy text-3xl opacity-80"></i>
            <span id="active-competitions" class="text-3xl font-bold">0</span>
          </div>
          <p class="text-purple-100">Active Competitions</p>
        </div>

        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-6 text-white">
          <div class="flex items-center justify-between mb-2">
            <i class="fas fa-dollar-sign text-3xl opacity-80"></i>
            <span id="total-revenue" class="text-3xl font-bold">$0</span>
          </div>
          <p class="text-orange-100">Total Revenue</p>
        </div>
      </div>

      <!-- Main Content Tabs -->
      <div class="bg-white rounded-lg shadow-lg mb-6">
        <div class="border-b border-gray-200 overflow-x-auto">
          <nav class="flex space-x-2 md:space-x-8 px-3 md:px-6 min-w-max" aria-label="Tabs">
            <button onclick="showAdminTab('statistics')" id="statistics-tab" class="admin-tab py-3 md:py-4 px-2 md:px-1 border-b-2 font-medium text-xs md:text-sm border-primary text-primary whitespace-nowrap">
              <i class="fas fa-chart-bar mr-1 md:mr-2"></i><span class="hidden sm:inline">Statistics</span><span class="sm:hidden">Stats</span>
            </button>
            <button onclick="showAdminTab('startups')" id="startups-tab" class="admin-tab py-3 md:py-4 px-2 md:px-1 border-b-2 font-medium text-xs md:text-sm border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">
              <i class="fas fa-rocket mr-1 md:mr-2"></i>Startups
            </button>
            <button onclick="showAdminTab('competitions')" id="competitions-tab" class="admin-tab py-3 md:py-4 px-2 md:px-1 border-b-2 font-medium text-xs md:text-sm border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">
              <i class="fas fa-trophy mr-1 md:mr-2"></i><span class="hidden sm:inline">Competitions</span><span class="sm:hidden">Comp</span>
            </button>
            <button onclick="showAdminTab('users')" id="users-tab" class="admin-tab py-3 md:py-4 px-2 md:px-1 border-b-2 font-medium text-xs md:text-sm border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">
              <i class="fas fa-users mr-1 md:mr-2"></i>Users
            </button>
            <button onclick="showAdminTab('activity')" id="activity-tab" class="admin-tab py-3 md:py-4 px-2 md:px-1 border-b-2 font-medium text-xs md:text-sm border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">
              <i class="fas fa-comments mr-1 md:mr-2"></i><span class="hidden sm:inline">Activity</span><span class="sm:hidden">Chat</span>
            </button>
            <button onclick="showAdminTab('reports')" id="reports-tab" class="admin-tab py-3 md:py-4 px-2 md:px-1 border-b-2 font-medium text-xs md:text-sm border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">
              <i class="fas fa-file-alt mr-1 md:mr-2"></i>Reports
            </button>
          </nav>
        </div>

        <!-- Statistics Tab -->
        <div id="statistics-content" class="admin-tab-content p-6">
          <h2 class="text-xl font-bold mb-4">Platform Statistics</h2>
          
          <!-- Charts -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="border rounded-lg p-4">
              <h3 class="font-semibold mb-3">User Growth</h3>
              <canvas id="user-growth-chart" height="200"></canvas>
            </div>
            <div class="border rounded-lg p-4">
              <h3 class="font-semibold mb-3">Project Categories</h3>
              <canvas id="project-categories-chart" height="200"></canvas>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="border rounded-lg p-4">
            <h3 class="font-semibold mb-3">Recent Activity</h3>
            <div id="recent-activity" class="space-y-2">
              <p class="text-gray-500 text-center py-4">Loading activity...</p>
            </div>
          </div>
        </div>

        <!-- Startups Tab (NEW) -->
        <div id="startups-content" class="admin-tab-content p-3 md:p-6 hidden">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 md:gap-6 mb-4 md:mb-6">
            <h2 class="text-lg md:text-xl font-bold">Startups Dashboard</h2>
            <div class="flex flex-col sm:flex-row gap-2 md:gap-4">
              <input type="text" id="startup-search" placeholder="Search..." class="border rounded-lg px-3 py-2 text-sm w-full sm:w-48 md:w-64">
              <select id="startup-filter" class="border rounded-lg px-3 py-2 text-sm w-full sm:w-auto">
                <option value="">All</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div id="startups-list" class="space-y-4">
            <p class="text-gray-500 text-center py-8">Loading startups...</p>
          </div>

          <!-- Startup Detail Modal -->
          <div id="startup-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-2 md:p-4" style="display: none;">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[95vh] md:max-h-[90vh] overflow-y-auto">
              <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-3 md:p-6 text-white sticky top-0 z-10">
                <div class="flex items-center justify-between">
                  <h2 class="text-base md:text-2xl font-bold" id="startup-modal-title">
                    <i class="fas fa-rocket mr-1 md:mr-2"></i>Startup Details
                  </h2>
                  <button onclick="closeStartupDetailModal()" class="text-white hover:text-purple-200 text-xl md:text-2xl">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>

              <div class="p-3 md:p-6" id="startup-detail-content">
                <p class="text-gray-500 text-center py-8">Loading...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Competitions Management Tab -->
        <div id="competitions-content" class="admin-tab-content p-6 hidden">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold">Manage Competitions</h2>
            <button onclick="showCreateCompetitionForm()" class="bg-primary text-white px-6 py-2 rounded-lg font-semibold hover:bg-primary-dark transition">
              <i class="fas fa-plus mr-2"></i>Create Competition
            </button>
          </div>

          <div id="competitions-list" class="space-y-4">
            <p class="text-gray-500 text-center py-8">Loading competitions...</p>
          </div>
        </div>

        <!-- Users Tab -->
        <div id="users-content" class="admin-tab-content p-6 hidden">
          <h2 class="text-xl font-bold mb-4">User Management</h2>
          
          <!-- Search and Filter -->
          <div class="mb-4 flex gap-4">
            <input type="text" id="user-search" placeholder="Search users..." class="flex-1 border rounded-lg px-4 py-2">
            <select id="role-filter" class="border rounded-lg px-4 py-2">
              <option value="">All Roles</option>
              <option value="founder">Founders</option>
              <option value="investor">Investors</option>
              <option value="validator">Validators</option>
              <option value="admin">Admins</option>
            </select>
          </div>

          <div id="users-list" class="space-y-2">
            <p class="text-gray-500 text-center py-8">Loading users...</p>
          </div>
        </div>

        <!-- Activity Tab (Chat & AI Monitoring) -->
        <div id="activity-content" class="admin-tab-content p-3 md:p-6 hidden">
          <h2 class="text-lg md:text-xl font-bold mb-4">Chat & Activity Monitoring</h2>
          
          <!-- Chat Stats Overview -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-3 md:p-4 text-white">
              <div class="flex items-center justify-between">
                <i class="fas fa-comments text-xl md:text-2xl opacity-80"></i>
                <span id="total-user-chats" class="text-xl md:text-2xl font-bold">0</span>
              </div>
              <p class="text-xs md:text-sm text-blue-100 mt-1">User Conversations</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-3 md:p-4 text-white">
              <div class="flex items-center justify-between">
                <i class="fas fa-envelope text-xl md:text-2xl opacity-80"></i>
                <span id="total-messages" class="text-xl md:text-2xl font-bold">0</span>
              </div>
              <p class="text-xs md:text-sm text-green-100 mt-1">Total Messages</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-3 md:p-4 text-white">
              <div class="flex items-center justify-between">
                <i class="fas fa-robot text-xl md:text-2xl opacity-80"></i>
                <span id="total-ai-chats" class="text-xl md:text-2xl font-bold">0</span>
              </div>
              <p class="text-xs md:text-sm text-purple-100 mt-1">AI Conversations</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-3 md:p-4 text-white">
              <div class="flex items-center justify-between">
                <i class="fas fa-user-clock text-xl md:text-2xl opacity-80"></i>
                <span id="ai-unique-users" class="text-xl md:text-2xl font-bold">0</span>
              </div>
              <p class="text-xs md:text-sm text-orange-100 mt-1">AI Users</p>
            </div>
          </div>

          <!-- Engagement Chart -->
          <div class="border rounded-lg p-4 mb-6">
            <h3 class="font-semibold mb-3">Engagement Over Time (30 Days)</h3>
            <canvas id="engagement-chart" height="150"></canvas>
          </div>

          <!-- Activity Sub-tabs -->
          <div class="border-b border-gray-200 mb-4">
            <nav class="flex space-x-4">
              <button onclick="showActivitySubTab('user-chats')" id="user-chats-subtab" class="activity-subtab py-2 px-3 border-b-2 font-medium text-sm border-primary text-primary">
                <i class="fas fa-comments mr-1"></i>User Chats
              </button>
              <button onclick="showActivitySubTab('ai-chats')" id="ai-chats-subtab" class="activity-subtab py-2 px-3 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                <i class="fas fa-robot mr-1"></i>AI Agent Chats
              </button>
              <button onclick="showActivitySubTab('active-users')" id="active-users-subtab" class="activity-subtab py-2 px-3 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                <i class="fas fa-user-clock mr-1"></i>Active Users
              </button>
            </nav>
          </div>

          <!-- User Chats Content -->
          <div id="user-chats-content" class="activity-subtab-content">
            <div id="user-conversations-list" class="space-y-3">
              <p class="text-gray-500 text-center py-8">Loading conversations...</p>
            </div>
          </div>

          <!-- AI Chats Content -->
          <div id="ai-chats-content" class="activity-subtab-content hidden">
            <div id="ai-conversations-list" class="space-y-3">
              <p class="text-gray-500 text-center py-8">Loading AI conversations...</p>
            </div>
          </div>

          <!-- Active Users Content -->
          <div id="active-users-content" class="activity-subtab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h4 class="font-semibold mb-3"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Top Messagers</h4>
                <div id="top-messagers-list" class="space-y-2">
                  <p class="text-gray-500 text-center py-4">Loading...</p>
                </div>
              </div>
              <div>
                <h4 class="font-semibold mb-3"><i class="fas fa-clock text-green-500 mr-2"></i>Recently Active (7 days)</h4>
                <div id="recent-active-list" class="space-y-2">
                  <p class="text-gray-500 text-center py-4">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Conversation Messages Modal -->
        <div id="conversation-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
          <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-4 md:p-6 text-white sticky top-0 z-10">
              <div class="flex items-center justify-between">
                <h2 id="conversation-modal-title" class="text-lg md:text-xl font-bold">
                  <i class="fas fa-comments mr-2"></i>Conversation
                </h2>
                <button onclick="closeConversationModal()" class="text-white hover:text-gray-200 text-xl md:text-2xl">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <div id="conversation-messages" class="p-4 md:p-6 space-y-4">
              <p class="text-gray-500 text-center py-8">Loading messages...</p>
            </div>
          </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-content" class="admin-tab-content p-6 hidden">
          <h2 class="text-xl font-bold mb-4">Generated Reports</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button onclick="generateReport('startups')" class="border-2 border-primary text-primary px-6 py-4 rounded-lg font-semibold hover:bg-primary hover:text-white transition">
              <i class="fas fa-rocket mr-2"></i>Startup Report
            </button>
            <button onclick="generateReport('competitions')" class="border-2 border-primary text-primary px-6 py-4 rounded-lg font-semibold hover:bg-primary hover:text-white transition">
              <i class="fas fa-trophy mr-2"></i>Competition Report
            </button>
            <button onclick="generateReport('revenue')" class="border-2 border-primary text-primary px-6 py-4 rounded-lg font-semibold hover:bg-primary hover:text-white transition">
              <i class="fas fa-dollar-sign mr-2"></i>Revenue Report
            </button>
            <button onclick="generateReport('users')" class="border-2 border-primary text-primary px-6 py-4 rounded-lg font-semibold hover:bg-primary hover:text-white transition">
              <i class="fas fa-users mr-2"></i>User Report
            </button>
          </div>

          <div id="report-output" class="border rounded-lg p-6 bg-gray-50 hidden">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold">Report Output</h3>
              <button onclick="downloadReport()" class="text-primary hover:underline">
                <i class="fas fa-download mr-1"></i>Download CSV
              </button>
            </div>
            <div id="report-content"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Competition Modal -->
    <div id="create-competition-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-primary to-secondary p-6 text-white">
          <div class="flex items-center justify-between">
            <h2 id="competition-modal-title" class="text-2xl font-bold">Create New Competition</h2>
            <button onclick="closeCreateCompetitionModal()" class="text-white hover:text-purple-200 text-2xl">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <form id="create-competition-form" class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Competition Title *</label>
            <input type="text" name="title" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
            <textarea name="description" required rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2"></textarea>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Competition Type *</label>
              <select name="competition_type" required class="w-full border border-gray-300 rounded-lg px-4 py-2" onchange="toggleTicketFields(this.value)">
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Prize Amount</label>
              <input type="text" name="prize_amount" placeholder="$10,000" class="w-full border border-gray-300 rounded-lg px-4 py-2">
            </div>
          </div>

          <div id="ticket-fields" class="space-y-4 hidden">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ticket Price</label>
                <input type="number" name="ticket_price" step="0.01" placeholder="25.00" class="w-full border border-gray-300 rounded-lg px-4 py-2">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Event Date</label>
                <input type="date" name="event_date" class="w-full border border-gray-300 rounded-lg px-4 py-2">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Event Time</label>
                <input type="time" name="event_time" class="w-full border border-gray-300 rounded-lg px-4 py-2">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                <input type="text" name="location" placeholder="MAGERIT LAGASCA 18" class="w-full border border-gray-300 rounded-lg px-4 py-2">
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Link (Four Revenues)</label>
              <input type="url" name="payment_link" placeholder="https://4rev.com/..." class="w-full border border-gray-300 rounded-lg px-4 py-2">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
            <input type="datetime-local" name="deadline" class="w-full border border-gray-300 rounded-lg px-4 py-2">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Guidelines</label>
            <textarea name="guidelines" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Rules and submission requirements..."></textarea>
          </div>

          <div class="flex justify-end space-x-3 pt-4">
            <button type="button" onclick="closeCreateCompetitionModal()" class="px-6 py-2 border border-gray-300 rounded-lg font-semibold hover:bg-gray-50">
              Cancel
            </button>
            <button type="submit" id="competition-submit-btn" class="bg-primary text-white px-6 py-2 rounded-lg font-semibold hover:bg-primary-dark">
              Create Competition
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Participants Modal -->
    <div id="participants-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6 text-white">
          <div class="flex items-center justify-between">
            <h2 class="text-2xl font-bold">
              <i class="fas fa-users mr-2"></i>Competition Participants
            </h2>
            <button onclick="closeParticipantsModal()" class="text-white hover:text-purple-200 text-2xl">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="p-6">
          <div id="participants-list" class="space-y-3">
            <p class="text-gray-500 text-center py-8">Loading participants...</p>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    <script>
      let currentReportData = null;
      let editingCompetitionId = null;

      function getAuthToken() {
        return document.cookie.split('; ')
          .find(row => row.startsWith('authToken='))
          ?.split('=')[1];
      }

      async function loadAdminStats() {
        try {
          const token = getAuthToken();
          const headers = { Authorization: \`Bearer \${token}\` };

          const [usersRes, projectsRes, competitionsRes] = await Promise.all([
            axios.get('/api/admin/stats/users', { headers }),
            axios.get('/api/admin/stats/projects', { headers }),
            axios.get('/api/admin/stats/competitions', { headers })
          ]);

          document.getElementById('total-users').textContent = usersRes.data.total || 0;
          document.getElementById('total-projects').textContent = projectsRes.data.total || 0;
          document.getElementById('active-competitions').textContent = competitionsRes.data.active || 0;
          document.getElementById('total-revenue').textContent = '$' + (competitionsRes.data.revenue || 0);

        } catch (error) {
          console.error('Failed to load admin stats:', error);
        }
      }

      async function loadRecentActivity() {
        try {
          const token = getAuthToken();
          const response = await axios.get('/api/admin/activity', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const activityHtml = response.data.activities.map(a => \`
            <div class="flex items-center justify-between py-2 border-b">
              <div class="flex items-center">
                <i class="fas fa-\${a.icon} text-gray-400 mr-3"></i>
                <div>
                  <p class="text-sm font-medium">\${a.description}</p>
                  <p class="text-xs text-gray-500">\${new Date(a.created_at).toLocaleString()}</p>
                </div>
              </div>
            </div>
          \`).join('');

          document.getElementById('recent-activity').innerHTML = activityHtml || '<p class="text-gray-500 text-center py-4">No recent activity</p>';
        } catch (error) {
          console.error('Failed to load activity:', error);
        }
      }

      async function loadCompetitionsList() {
        try {
          const token = getAuthToken();
          const response = await axios.get('/api/competitions', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const competitionsHtml = response.data.competitions.map(c => \`
            <div class="border rounded-lg p-4 hover:shadow-md transition">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <h3 class="font-semibold text-lg">\${c.title}</h3>
                  <p class="text-sm text-gray-600 mt-1">\${c.description}</p>
                  <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                    <span><i class="fas fa-trophy mr-1"></i>\${c.prize_amount || 'No prize'}</span>
                    <span><i class="fas fa-users mr-1"></i>\${c.participant_count || 0} participants</span>
                    <span class="px-2 py-1 rounded-full text-xs font-semibold \${c.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">\${c.status}</span>
                  </div>
                </div>
                <div class="flex items-center space-x-2">
                  <button onclick="viewLeaderboard(\${c.id})" class="text-yellow-600 hover:text-yellow-800 p-2" title="View Leaderboard">
                    <i class="fas fa-trophy"></i>
                  </button>
                  <button onclick="viewParticipants(\${c.id})" class="text-purple-600 hover:text-purple-800 p-2" title="View Participants">
                    <i class="fas fa-users"></i>
                  </button>
                  <button onclick="editCompetition(\${c.id})" class="text-blue-600 hover:text-blue-800 p-2" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="announceWinners(\${c.id})" class="text-green-600 hover:text-green-800 p-2" title="Announce Winners">
                    <i class="fas fa-trophy"></i>
                  </button>
                  <button onclick="deleteCompetition(\${c.id})" class="text-red-600 hover:text-red-800 p-2" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          \`).join('');

          document.getElementById('competitions-list').innerHTML = competitionsHtml || '<p class="text-gray-500 text-center py-8">No competitions yet</p>';
        } catch (error) {
          console.error('Failed to load competitions:', error);
        }
      }

      async function loadUsersList() {
        try {
          const token = getAuthToken();
          const response = await axios.get('/api/admin/users', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const usersHtml = response.data.users.map(u => \`
            <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
              <div class="flex items-center">
                <img src="\${u.avatar_url || '/default-avatar.png'}" alt="\${u.name}" class="w-10 h-10 rounded-full mr-3">
                <div>
                  <p class="font-medium">\${u.name}</p>
                  <p class="text-sm text-gray-500">\${u.email}</p>
                </div>
              </div>
              <div class="flex items-center space-x-3">
                <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">\${u.role}</span>
                <span class="text-xs text-gray-500">\${u.project_count || 0} projects</span>
              </div>
            </div>
          \`).join('');

          document.getElementById('users-list').innerHTML = usersHtml || '<p class="text-gray-500 text-center py-8">No users found</p>';
        } catch (error) {
          console.error('Failed to load users:', error);
        }
      }

      function showAdminTab(tab) {
        // Update tab buttons
        document.querySelectorAll('.admin-tab').forEach(t => {
          t.classList.remove('text-primary', 'border-primary');
          t.classList.add('text-gray-500', 'border-transparent');
        });
        document.getElementById(tab + '-tab').classList.remove('text-gray-500', 'border-transparent');
        document.getElementById(tab + '-tab').classList.add('text-primary', 'border-primary');

        // Show/hide content
        document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(tab + '-content').classList.remove('hidden');

        // Load data for specific tabs
        if (tab === 'competitions') {
          loadCompetitionsList();
        } else if (tab === 'users') {
          loadUsersList();
        } else if (tab === 'statistics') {
          loadRecentActivity();
        } else if (tab === 'startups') {
          loadStartupsList();
        } else if (tab === 'activity') {
          loadActivityData();
        }
      }

      function showCreateCompetitionForm() {
        editingCompetitionId = null;
        document.getElementById('competition-modal-title').textContent = 'Create New Competition';
        document.getElementById('competition-submit-btn').textContent = 'Create Competition';
        document.getElementById('create-competition-form').reset();
        document.getElementById('create-competition-modal').style.display = 'flex';
      }

      function closeCreateCompetitionModal() {
        editingCompetitionId = null;
        document.getElementById('create-competition-modal').style.display = 'none';
        document.getElementById('create-competition-form').reset();
      }

      async function editCompetition(id) {
        try {
          editingCompetitionId = id;
          const token = getAuthToken();
          const response = await axios.get(\`/api/competitions/\${id}\`, {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const comp = response.data.competition;
          
          document.getElementById('competition-modal-title').textContent = 'Edit Competition';
          document.getElementById('competition-submit-btn').textContent = 'Update Competition';
          
          const form = document.getElementById('create-competition-form');
          form.elements['title'].value = comp.title || '';
          form.elements['description'].value = comp.description || '';
          form.elements['competition_type'].value = comp.competition_type || 'weekly';
          form.elements['prize_amount'].value = comp.prize_amount || '';
          form.elements['deadline'].value = comp.deadline || '';
          form.elements['guidelines'].value = comp.guidelines || '';
          
          toggleTicketFields(comp.competition_type);
          
          if (comp.competition_type === 'monthly') {
            form.elements['ticket_price'].value = comp.ticket_price || '';
            form.elements['event_date'].value = comp.event_date || '';
            form.elements['event_time'].value = comp.event_time || '';
            form.elements['location'].value = comp.location || '';
            form.elements['payment_link'].value = comp.payment_link || '';
          }

          document.getElementById('create-competition-modal').style.display = 'flex';
        } catch (error) {
          alert('Failed to load competition: ' + error.message);
        }
      }

      async function viewParticipants(competitionId) {
        try {
          const token = getAuthToken();
          const response = await axios.get(\`/api/admin/competitions/\${competitionId}/participants\`, {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const participants = response.data.participants || [];
          
          const participantsHtml = participants.map(p => \`
            <div class="border rounded-lg p-4 hover:shadow-md transition">
              <div class="flex items-start justify-between">
                <div class="flex items-center space-x-3 flex-1">
                  <img src="\${p.avatar_url || '/default-avatar.png'}" alt="\${p.name}" class="w-12 h-12 rounded-full">
                  <div class="flex-1">
                    <div class="flex items-center space-x-2">
                      <h4 class="font-semibold">\${p.name}</h4>
                      <span class="text-xs px-2 py-1 rounded-full \${p.payment_status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                        \${p.payment_status}
                      </span>
                    </div>
                    <p class="text-sm text-gray-600">\${p.email}</p>
                    <p class="text-sm font-medium text-purple-600 mt-1">\${p.startup_name || p.project_title || 'No project'}</p>
                    \${p.project_description ? \`<p class="text-xs text-gray-500 mt-1">\${p.project_description.substring(0, 100)}...</p>\` : ''}
                    \${p.pitch_deck_url ? \`<a href="\${p.pitch_deck_url}" target="_blank" class="text-xs text-blue-600 hover:underline mt-1 inline-block"><i class="fas fa-link mr-1"></i>Pitch Deck</a>\` : ''}
                  </div>
                </div>
                <div class="text-right text-xs text-gray-500">
                  \${new Date(p.created_at).toLocaleDateString()}
                </div>
              </div>
              \${p.submission_notes ? \`
                <div class="mt-3 pt-3 border-t">
                  <p class="text-xs text-gray-600"><strong>Notes:</strong> \${p.submission_notes}</p>
                </div>
              \` : ''}
            </div>
          \`).join('');

          document.getElementById('participants-list').innerHTML = participantsHtml || '<p class="text-gray-500 text-center py-8">No participants yet</p>';
          document.getElementById('participants-modal').style.display = 'flex';
        } catch (error) {
          alert('Failed to load participants: ' + error.message);
        }
      }

      function closeParticipantsModal() {
        document.getElementById('participants-modal').style.display = 'none';
      }

      function viewLeaderboard(competitionId) {
        // Redirect to competition leaderboard page
        window.open(\`/competitions/\${competitionId}/leaderboard\`, '_blank');
      }

      function toggleTicketFields(type) {
        const ticketFields = document.getElementById('ticket-fields');
        if (type === 'monthly') {
          ticketFields.classList.remove('hidden');
        } else {
          ticketFields.classList.add('hidden');
        }
      }

      document.getElementById('create-competition-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {
          title: formData.get('title'),
          description: formData.get('description'),
          competition_type: formData.get('competition_type'),
          prize_amount: formData.get('prize_amount'),
          deadline: formData.get('deadline'),
          guidelines: formData.get('guidelines'),
          ticket_price: formData.get('ticket_price') || 0,
          event_date: formData.get('event_date'),
          event_time: formData.get('event_time'),
          location: formData.get('location'),
          payment_link: formData.get('payment_link'),
          ticket_required: formData.get('competition_type') === 'monthly'
        };

        try {
          const token = getAuthToken();
          
          if (editingCompetitionId) {
            // Update existing competition
            await axios.put(\`/api/admin/competitions/\${editingCompetitionId}\`, data, {
              headers: { Authorization: \`Bearer \${token}\` }
            });
            alert('Competition updated successfully!');
          } else {
            // Create new competition
            await axios.post('/api/admin/competitions', data, {
              headers: { Authorization: \`Bearer \${token}\` }
            });
            alert('Competition created successfully!');
          }

          closeCreateCompetitionModal();
          loadCompetitionsList();
        } catch (error) {
          alert('Failed to save competition: ' + (error.response?.data?.error || error.message));
        }
      });

      async function generateReport(type) {
        try {
          const token = getAuthToken();
          const response = await axios.get(\`/api/admin/reports/\${type}\`, {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          currentReportData = response.data;
          
          document.getElementById('report-output').classList.remove('hidden');
          document.getElementById('report-content').innerHTML = \`
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    \${Object.keys(currentReportData.data[0] || {}).map(key => \`
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">\${key}</th>
                    \`).join('')}
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  \${currentReportData.data.map(row => \`
                    <tr>
                      \${Object.values(row).map(val => \`
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">\${val || '-'}</td>
                      \`).join('')}
                    </tr>
                  \`).join('')}
                </tbody>
              </table>
            </div>
          \`;
        } catch (error) {
          alert('Failed to generate report: ' + error.message);
        }
      }

      function downloadReport() {
        if (!currentReportData) return;

        const csv = [
          Object.keys(currentReportData.data[0]).join(','),
          ...currentReportData.data.map(row => Object.values(row).join(','))
        ].join('\\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = \`report-\${Date.now()}.csv\`;
        a.click();
      }

      async function announceWinners(competitionId) {
        const winners = prompt('Enter winners (format: userId1:position:prize,userId2:position:prize)');
        if (!winners) return;

        try {
          const token = getAuthToken();
          const winnersData = winners.split(',').map(w => {
            const [user_id, position, prize_amount] = w.split(':');
            return { user_id: parseInt(user_id), position: parseInt(position), prize_amount };
          });

          await axios.post(\`/api/competitions/\${competitionId}/winners\`, 
            { winners: winnersData },
            { headers: { Authorization: \`Bearer \${token}\` }}
          );

          alert('Winners announced successfully!');
          loadCompetitionsList();
        } catch (error) {
          alert('Failed to announce winners: ' + error.message);
        }
      }

      async function deleteCompetition(id) {
        if (!confirm('Are you sure you want to delete this competition?')) return;

        try {
          const token = getAuthToken();
          await axios.delete(\`/api/admin/competitions/\${id}\`, {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          alert('Competition deleted successfully!');
          loadCompetitionsList();
        } catch (error) {
          alert('Failed to delete competition: ' + error.message);
        }
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        loadAdminStats();
        loadRecentActivity();
      });

      // ========== STARTUPS TAB FUNCTIONS ==========

      async function loadStartupsList() {
        try {
          const token = getAuthToken();
          console.log('Loading startups with token:', token ? 'present' : 'missing');
          
          const response = await axios.get('/api/projects/leaderboard/top', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          console.log('API Response:', response.data);
          
          // El API devuelve { leaderboard: [...], isAdmin: true } o { projects: [...] }
          const startups = response.data.leaderboard || response.data.projects || [];
          console.log('Startups found:', startups.length);
          
          const searchInput = document.getElementById('startup-search');
          const filterSelect = document.getElementById('startup-filter');

          function renderStartups(filteredStartups = startups) {
            console.log('Rendering startups:', filteredStartups.length);
            
            if (filteredStartups.length === 0) {
              document.getElementById('startups-list').innerHTML = '<p class="text-gray-500 text-center py-8">No startups found. Total projects in DB: ' + startups.length + '</p>';
              return;
            }

            const startupsHtml = filteredStartups.map(startup => \`
              <div class="border rounded-lg p-6 hover:shadow-lg transition-shadow cursor-pointer bg-white" onclick="viewStartupDetails(\${startup.user_id || startup.creator_id || startup.company_user_id})">
                <div class="flex items-start justify-between">
                  <div class="flex items-center space-x-4 flex-1">
                    <img src="\${startup.creator_avatar_url || startup.avatar_url || '/default-avatar.png'}" alt="\${startup.creator_name || 'User'}" class="w-16 h-16 rounded-full border-2 border-purple-200">
                    <div class="flex-1">
                      <h3 class="text-lg font-bold text-gray-900">\${startup.title}</h3>
                      <p class="text-sm text-gray-600 mb-2"><i class="fas fa-user mr-1"></i>\${startup.creator_name} (\${startup.creator_email || 'No email'})</p>
                      <p class="text-sm text-gray-700 line-clamp-2">\${startup.description || 'No description available'}</p>
                      
                      <div class="flex items-center space-x-4 mt-3">
                        <span class="text-xs px-3 py-1 rounded-full bg-purple-100 text-purple-700">
                          <i class="fas fa-fire mr-1"></i>\${startup.votes_count || startup.votes || 0} votes
                        </span>
                        <span class="text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-700">
                          <i class="fas fa-bullseye mr-1"></i>\${startup.total_goals || startup.goals_count || 0} goals
                        </span>
                        <span class="text-xs px-3 py-1 rounded-full bg-green-100 text-green-700">
                          <i class="fas fa-check-circle mr-1"></i>\${startup.completed_goals || 0} completed
                        </span>
                        \${startup.current_users ? \`
                          <span class="text-xs px-3 py-1 rounded-full bg-indigo-100 text-indigo-700">
                            <i class="fas fa-users mr-1"></i>\${startup.current_users} users
                          </span>
                        \` : ''}
                        \${startup.current_revenue ? \`
                          <span class="text-xs px-3 py-1 rounded-full bg-emerald-100 text-emerald-700">
                            <i class="fas fa-dollar-sign mr-1"></i>$\${startup.current_revenue}
                          </span>
                        \` : ''}
                      </div>
                    </div>
                  </div>
                  <div class="text-right">
                    <button class="text-blue-600 hover:text-blue-800">
                      <i class="fas fa-arrow-right text-xl"></i>
                    </button>
                  </div>
                </div>
              </div>
            \`).join('');

            document.getElementById('startups-list').innerHTML = startupsHtml;
          }

          // Search and filter handlers (only add once)
          searchInput.onchange = null;
          searchInput.oninput = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const filtered = startups.filter(s => 
              s.title.toLowerCase().includes(searchTerm) ||
              s.creator_name.toLowerCase().includes(searchTerm) ||
              (s.description && s.description.toLowerCase().includes(searchTerm))
            );
            renderStartups(filtered);
          };

          filterSelect.onchange = null;
          filterSelect.onchange = () => {
            const filterValue = filterSelect.value;
            let filtered = startups;
            
            if (filterValue === 'active') {
              filtered = startups.filter(s => (s.total_goals || s.goals_count || 0) > 0);
            } else if (filterValue === 'inactive') {
              filtered = startups.filter(s => (s.total_goals || s.goals_count || 0) === 0);
            }
            
            renderStartups(filtered);
          };

          renderStartups();
        } catch (error) {
          console.error('Failed to load startups:', error);
          document.getElementById('startups-list').innerHTML = '<p class="text-red-500 text-center py-8">Failed to load startups: ' + error.message + '</p>';
        }
      }

      async function viewStartupDetails(userId) {
        try {
          const token = getAuthToken();
          
          // Load user goals using the specific endpoint
          let userGoals = [];
          try {
            console.log('Fetching goals for user:', userId);
            const goalsResponse = await axios.get(\`/api/dashboard/goals/user/\${userId}\`, {
              headers: { Authorization: \`Bearer \${token}\` }
            });
            
            console.log('Goals API response for user', userId, ':', goalsResponse.data);
            userGoals = goalsResponse.data.goals || [];
            console.log('User goals found:', userGoals.length);
            if (userGoals.length > 0) {
              console.log('First goal sample:', userGoals[0]);
            }
          } catch (goalsError) {
            console.error('Error loading goals:', goalsError);
            console.error('Error details:', goalsError.response?.data);
          }
          
          console.log('About to calculate completedGoals with userGoals.length =', userGoals.length);
          
          // Load user projects
          const projectsResponse = await axios.get('/api/projects/leaderboard/top', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          console.log('Projects response:', projectsResponse.data);
          const allProjects = projectsResponse.data.leaderboard || projectsResponse.data.projects || [];
          const userProjects = allProjects.filter(p => (p.user_id == userId || p.creator_id == userId || p.company_user_id == userId));
          
          console.log('User projects found:', userProjects.length, userProjects);
          
          const userInfo = userProjects[0] || { creator_name: 'Unknown User', user_id: userId };

          // Use metrics from the project data directly (already includes current_users, current_revenue, etc.)
          const userMetrics = {
            total_users: userInfo.current_users || 0,
            users: userInfo.current_users || 0,
            total_revenue: userInfo.current_revenue || 0,
            revenue: userInfo.current_revenue || 0,
            completed_goals: userInfo.completed_goals || userGoals.filter(g => g.status === 'completed' || g.goal_status === 'completed').length,
            total_goals: userInfo.total_goals || userGoals.length,
            mrr: userInfo.mrr || 0,
            active_users: userInfo.active_users || 0,
            users_growth: userInfo.users_growth || 'N/A',
            revenue_growth: userInfo.revenue_growth || 'N/A',
            churn_rate: userInfo.churn_rate || 'N/A',
            last_updated: userInfo.updated_at || userInfo.created_at
          };
          
          console.log('User metrics:', userMetrics);

          document.getElementById('startup-modal-title').innerHTML = \`
            <i class="fas fa-rocket mr-2"></i>\${userInfo.creator_name || 'User'}'s Complete Profile
          \`;

          const completedGoals = userGoals.filter(g => g.status === 'completed' || g.goal_status === 'completed').length;
          const activeGoals = userGoals.filter(g => g.status === 'in_progress' || g.goal_status === 'in_progress').length;
          const pendingGoals = userGoals.filter(g => g.status === 'pending' || g.goal_status === 'pending' || (!g.status && !g.goal_status)).length;

          // Group goals by category/type
          const goalsByCategory = {
            'Product': userGoals.filter(g => g.category === 'product' || (g.description && g.description.toLowerCase().includes('product'))),
            'Marketing': userGoals.filter(g => g.category === 'marketing' || (g.description && g.description.toLowerCase().includes('marketing'))),
            'Sales': userGoals.filter(g => g.category === 'sales' || (g.description && (g.description.toLowerCase().includes('sales') || g.description.toLowerCase().includes('revenue')))),
            'Growth': userGoals.filter(g => g.category === 'growth' || (g.description && (g.description.toLowerCase().includes('user') || g.description.toLowerCase().includes('growth')))),
            'Other': userGoals.filter(g => !['product', 'marketing', 'sales', 'growth'].includes(g.category))
          };

          const detailHtml = \`
            <div class="space-y-6">
              <!-- User Info Header -->
              <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-4">
                    <img src="\${userInfo.creator_avatar_url || '/default-avatar.png'}" alt="\${userInfo.creator_name}" class="w-20 h-20 rounded-full border-4 border-white shadow">
                    <div>
                      <h3 class="text-2xl font-bold text-gray-900">\${userInfo.creator_name || 'Unknown'}</h3>
                      <p class="text-gray-600">\${userInfo.creator_email || 'No email'}</p>
                      <div class="flex items-center space-x-3 mt-2">
                        <span class="text-xs px-3 py-1 rounded-full bg-purple-600 text-white">
                          <i class="fas fa-id-badge mr-1"></i>ID: \${userId}
                        </span>
                        <span class="text-xs px-3 py-1 rounded-full bg-blue-600 text-white">
                          <i class="fas fa-user mr-1"></i>\${userInfo.creator_role || 'Founder'}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Key Metrics Dashboard -->
              <div>
                <h4 class="text-lg font-bold mb-3 flex items-center">
                  <i class="fas fa-chart-line mr-2 text-green-600"></i>Key Metrics Overview
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                    <div class="text-3xl font-bold text-blue-700">\${userProjects.length}</div>
                    <div class="text-sm text-blue-600 font-medium">Projects</div>
                  </div>
                  <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                    <div class="text-3xl font-bold text-green-700">\${completedGoals}</div>
                    <div class="text-sm text-green-600 font-medium">Completed Goals</div>
                  </div>
                  <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
                    <div class="text-3xl font-bold text-yellow-700">\${activeGoals}</div>
                    <div class="text-sm text-yellow-600 font-medium">Active Goals</div>
                  </div>
                  <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                    <div class="text-3xl font-bold text-purple-700">\${userProjects.reduce((sum, p) => sum + (p.votes || 0), 0)}</div>
                    <div class="text-sm text-purple-600 font-medium">Total Votes</div>
                  </div>
                  <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-lg border border-emerald-200">
                    <div class="text-3xl font-bold text-emerald-700">\${userMetrics.total_users || userMetrics.users || 0}</div>
                    <div class="text-sm text-emerald-600 font-medium">Users</div>
                    \${userMetrics.users_growth ? \`<div class="text-xs text-emerald-500 mt-1"><i class="fas fa-arrow-up mr-1"></i>\${userMetrics.users_growth}</div>\` : ''}
                  </div>
                  <div class="bg-gradient-to-br from-pink-50 to-pink-100 p-4 rounded-lg border border-pink-200">
                    <div class="text-3xl font-bold text-pink-700">$\${userMetrics.total_revenue || userMetrics.revenue || 0}</div>
                    <div class="text-sm text-pink-600 font-medium">Revenue</div>
                    \${userMetrics.revenue_growth ? \`<div class="text-xs text-pink-500 mt-1"><i class="fas fa-arrow-up mr-1"></i>\${userMetrics.revenue_growth}</div>\` : ''}
                  </div>
                  <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-lg border border-indigo-200">
                    <div class="text-3xl font-bold text-indigo-700">\${pendingGoals}</div>
                    <div class="text-sm text-indigo-600 font-medium">Pending Goals</div>
                  </div>
                  <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                    <div class="text-3xl font-bold text-orange-700">\${Math.round((completedGoals / (userGoals.length || 1)) * 100)}%</div>
                    <div class="text-sm text-orange-600 font-medium">Completion Rate</div>
                  </div>
                </div>
              </div>

              <!-- Revenue & Users History -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="border rounded-lg p-4 bg-gradient-to-br from-green-50 to-emerald-50">
                  <h5 class="font-bold text-gray-900 mb-3 flex items-center">
                    <i class="fas fa-dollar-sign mr-2 text-green-600"></i>Revenue Metrics
                  </h5>
                  <div class="space-y-2">
                    <div class="flex justify-between items-center py-2 border-b border-green-200">
                      <span class="text-sm text-gray-600">Current MRR:</span>
                      <span class="font-bold text-green-700">$\${userMetrics.mrr || 0}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-green-200">
                      <span class="text-sm text-gray-600">Total Revenue:</span>
                      <span class="font-bold text-green-700">$\${userMetrics.total_revenue || userMetrics.revenue || 0}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-green-200">
                      <span class="text-sm text-gray-600">Growth Rate:</span>
                      <span class="font-bold text-green-700">\${userMetrics.revenue_growth || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                      <span class="text-sm text-gray-600">Last Updated:</span>
                      <span class="text-xs text-gray-500">\${userMetrics.last_updated ? new Date(userMetrics.last_updated).toLocaleDateString() : 'N/A'}</span>
                    </div>
                  </div>
                </div>

                <div class="border rounded-lg p-4 bg-gradient-to-br from-blue-50 to-indigo-50">
                  <h5 class="font-bold text-gray-900 mb-3 flex items-center">
                    <i class="fas fa-users mr-2 text-blue-600"></i>User Metrics
                  </h5>
                  <div class="space-y-2">
                    <div class="flex justify-between items-center py-2 border-b border-blue-200">
                      <span class="text-sm text-gray-600">Total Users:</span>
                      <span class="font-bold text-blue-700">\${userMetrics.total_users || userMetrics.users || 0}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-blue-200">
                      <span class="text-sm text-gray-600">Active Users:</span>
                      <span class="font-bold text-blue-700">\${userMetrics.active_users || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-blue-200">
                      <span class="text-sm text-gray-600">Growth Rate:</span>
                      <span class="font-bold text-blue-700">\${userMetrics.users_growth || 'N/A'}</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                      <span class="text-sm text-gray-600">Churn Rate:</span>
                      <span class="text-xs text-gray-500">\${userMetrics.churn_rate || 'N/A'}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Projects Section -->
              <div>
                <h4 class="text-lg font-bold mb-3 flex items-center">
                  <i class="fas fa-rocket mr-2 text-purple-600"></i>Projects (\${userProjects.length})
                </h4>
                <div class="space-y-3">
                  \${userProjects.length > 0 ? userProjects.map(project => \`
                    <div class="border rounded-lg p-4 bg-white hover:shadow-md transition">
                      <div class="flex items-start justify-between">
                        <div class="flex-1">
                          <div class="flex items-center space-x-2 mb-2">
                            <h5 class="font-semibold text-gray-900 text-lg">\${project.title}</h5>
                            <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700">
                              <i class="fas fa-fire mr-1"></i>\${project.votes || 0} votes
                            </span>
                          </div>
                          <p class="text-sm text-gray-600 mt-1">\${project.description || 'No description'}</p>
                          <div class="flex items-center space-x-3 mt-3">
                            \${project.image_url ? \`<a href="\${project.image_url}" target="_blank" class="text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200"><i class="fas fa-image mr-1"></i>Image</a>\` : ''}
                            \${project.link ? \`<a href="\${project.link}" target="_blank" class="text-xs px-3 py-1 rounded-full bg-green-100 text-green-700 hover:bg-green-200"><i class="fas fa-link mr-1"></i>Website</a>\` : ''}
                            <span class="text-xs text-gray-500"><i class="fas fa-calendar mr-1"></i>\${project.created_at ? new Date(project.created_at).toLocaleDateString() : 'N/A'}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  \`).join('') : '<p class="text-gray-500 text-center py-4">No projects yet</p>'}
                </div>
              </div>

              <!-- Goals by Category -->
              <div>
                <h4 class="text-lg font-bold mb-3 flex items-center">
                  <i class="fas fa-bullseye mr-2 text-blue-600"></i>All Goals (\${userGoals.length}) - Organized by Category
                </h4>
                
                <!-- Goals Summary -->
                <div class="grid grid-cols-3 gap-3 mb-4">
                  <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-green-700">\${completedGoals}</div>
                    <div class="text-xs text-green-600">Completed</div>
                  </div>
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-700">\${activeGoals}</div>
                    <div class="text-xs text-blue-600">In Progress</div>
                  </div>
                  <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-gray-700">\${pendingGoals}</div>
                    <div class="text-xs text-gray-600">Pending</div>
                  </div>
                </div>

                <!-- Goals by Category -->
                <div class="space-y-4">
                  \${Object.entries(goalsByCategory).map(([category, goals]) => {
                    if (goals.length === 0) return '';
                    return \`
                      <div class="border rounded-lg p-4 bg-gray-50">
                        <h5 class="font-bold text-gray-900 mb-3 flex items-center">
                          <i class="fas fa-\${
                            category === 'Product' ? 'box' :
                            category === 'Marketing' ? 'bullhorn' :
                            category === 'Sales' ? 'dollar-sign' :
                            category === 'Growth' ? 'chart-line' : 'star'
                          } mr-2"></i>\${category} Goals (\${goals.length})
                        </h5>
                        <div class="space-y-2">
                          \${goals.map(goal => \`
                            <div class="border rounded-lg p-3 bg-white hover:bg-gray-50 transition">
                              <div class="flex items-start justify-between">
                                <div class="flex-1">
                                  <div class="flex items-center space-x-2">
                                    <h6 class="font-medium text-gray-900">\${goal.task || goal.description || 'Goal'}</h6>
                                    <span class="text-xs px-2 py-1 rounded-full \${
                                      (goal.status === 'completed' || goal.goal_status === 'completed') ? 'bg-green-100 text-green-700' :
                                      (goal.status === 'in_progress' || goal.goal_status === 'in_progress') ? 'bg-blue-100 text-blue-700' :
                                      'bg-gray-100 text-gray-700'
                                    }">
                                      <i class="fas fa-\${(goal.status === 'completed' || goal.goal_status === 'completed') ? 'check-circle' : (goal.status === 'in_progress' || goal.goal_status === 'in_progress') ? 'spinner' : 'clock'} mr-1"></i>\${goal.goal_status || goal.status || 'pending'}
                                    </span>
                                    \${goal.priority ? \`<span class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-700">\${goal.priority_label || 'P' + goal.priority}</span>\` : ''}
                                  </div>
                                  \${goal.description && goal.task !== goal.description ? \`<p class="text-xs text-gray-600 mt-1">\${goal.description}</p>\` : ''}
                                  <div class="flex items-center space-x-3 mt-2 text-xs text-gray-500">
                                    \${goal.deadline ? \`<span><i class="fas fa-calendar mr-1"></i>\${new Date(goal.deadline).toLocaleDateString()}</span>\` : ''}
                                    \${goal.created_at ? \`<span><i class="fas fa-clock mr-1"></i>Created: \${new Date(goal.created_at).toLocaleDateString()}</span>\` : ''}
                                    \${goal.cadence ? \`<span><i class="fas fa-repeat mr-1"></i>\${goal.cadence}</span>\` : ''}
                                    \${goal.dri ? \`<span><i class="fas fa-user mr-1"></i>DRI: \${goal.dri}</span>\` : ''}
                                  </div>
                                </div>
                              </div>
                            </div>
                          \`).join('')}
                        </div>
                      </div>
                    \`;
                  }).join('')}
                </div>

                <!-- All Goals if no categorization -->
                \${userGoals.length > 0 && Object.values(goalsByCategory).every(g => g.length === 0) ? \`
                  <div class="space-y-2">
                    \${userGoals.map(goal => \`
                      <div class="border rounded-lg p-3 bg-white hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                          <div class="flex-1">
                            <div class="flex items-center space-x-2">
                              <h5 class="font-medium text-gray-900">\${goal.task || goal.description || 'Goal'}</h5>
                              <span class="text-xs px-2 py-1 rounded-full \${
                                (goal.status === 'completed' || goal.goal_status === 'completed') ? 'bg-green-100 text-green-700' :
                                (goal.status === 'in_progress' || goal.goal_status === 'in_progress') ? 'bg-blue-100 text-blue-700' :
                                'bg-gray-100 text-gray-700'
                              }">
                                \${goal.goal_status || goal.status || 'pending'}
                              </span>
                            </div>
                            \${goal.description && goal.task !== goal.description ? \`<p class="text-xs text-gray-600 mt-1">\${goal.description}</p>\` : ''}
                            <div class="flex items-center space-x-2 mt-2">
                              \${goal.deadline ? \`<span class="text-xs text-gray-500"><i class="fas fa-calendar mr-1"></i>\${new Date(goal.deadline).toLocaleDateString()}</span>\` : ''}
                            </div>
                          </div>
                        </div>
                      </div>
                    \`).join('')}
                  </div>
                \` : ''}

                \${userGoals.length === 0 ? '<p class="text-gray-500 text-center py-4">No goals yet</p>' : ''}
              </div>
            </div>
          \`;

          document.getElementById('startup-detail-content').innerHTML = detailHtml;
          document.getElementById('startup-detail-modal').style.display = 'flex';
        } catch (error) {
          console.error('Failed to load startup details:', error);
          alert('Failed to load startup details: ' + error.message);
        }
      }

      function closeStartupDetailModal() {
        document.getElementById('startup-detail-modal').style.display = 'none';
      }

      // =====================================================
      // ACTIVITY TAB FUNCTIONS
      // =====================================================
      
      let engagementChart = null;

      async function loadActivityData() {
        await Promise.all([
          loadChatStats(),
          loadEngagementTimeline(),
          loadUserConversations(),
          loadActiveUsers()
        ]);
      }

      async function loadChatStats() {
        try {
          const token = getAuthToken();
          const response = await axios.get('/api/admin/stats/chat', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const data = response.data;
          document.getElementById('total-user-chats').textContent = data.userChats?.totalConversations || 0;
          document.getElementById('total-messages').textContent = data.userChats?.totalMessages || 0;
          document.getElementById('total-ai-chats').textContent = data.aiChats?.totalMessages || 0;
          document.getElementById('ai-unique-users').textContent = data.aiChats?.uniqueUsers || 0;
        } catch (error) {
          console.error('Failed to load chat stats:', error);
        }
      }

      async function loadEngagementTimeline() {
        try {
          const token = getAuthToken();
          const response = await axios.get('/api/admin/stats/engagement-timeline?days=30', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const data = response.data;
          renderEngagementChart(data);
        } catch (error) {
          console.error('Failed to load engagement timeline:', error);
        }
      }

      function renderEngagementChart(data) {
        const ctx = document.getElementById('engagement-chart');
        if (!ctx) return;

        // Destroy existing chart
        if (engagementChart) {
          engagementChart.destroy();
        }

        // Prepare data - merge dates from both sources
        const allDates = new Set();
        (data.messages || []).forEach(m => allDates.add(m.date));
        (data.aiChats || []).forEach(a => allDates.add(a.date));
        
        const sortedDates = Array.from(allDates).sort();
        
        const messagesMap = new Map((data.messages || []).map(m => [m.date, m.count]));
        const aiChatsMap = new Map((data.aiChats || []).map(a => [a.date, a.count]));

        engagementChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: sortedDates.map(d => new Date(d).toLocaleDateString('es', { month: 'short', day: 'numeric' })),
            datasets: [
              {
                label: 'User Messages',
                data: sortedDates.map(d => messagesMap.get(d) || 0),
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.3
              },
              {
                label: 'AI Conversations',
                data: sortedDates.map(d => aiChatsMap.get(d) || 0),
                borderColor: '#8B5CF6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                fill: true,
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }

      async function loadUserConversations() {
        try {
          const token = getAuthToken();
          const response = await axios.get('/api/admin/conversations?limit=20', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const conversations = response.data.conversations || [];
          
          if (conversations.length === 0) {
            document.getElementById('user-conversations-list').innerHTML = '<p class="text-gray-500 text-center py-8">No conversations yet</p>';
            return;
          }

          const html = conversations.map(c => \`
            <div class="border rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="viewConversation(\${c.id}, 'user')">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <div class="flex -space-x-2">
                    <img src="\${c.user1_avatar || '/default-avatar.png'}" alt="\${c.user1_name}" class="w-8 h-8 rounded-full border-2 border-white">
                    <img src="\${c.user2_avatar || '/default-avatar.png'}" alt="\${c.user2_name}" class="w-8 h-8 rounded-full border-2 border-white">
                  </div>
                  <div>
                    <p class="font-medium text-sm">\${c.user1_name} <i class="fas fa-exchange-alt text-gray-400 mx-1"></i> \${c.user2_name}</p>
                    <p class="text-xs text-gray-500">\${c.message_count} messages</p>
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-xs px-2 py-1 rounded-full \${c.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">\${c.status}</span>
                  <p class="text-xs text-gray-500 mt-1">\${c.last_message_at ? new Date(c.last_message_at).toLocaleDateString() : ''}</p>
                </div>
              </div>
              \${c.last_message ? \`<p class="text-xs text-gray-600 mt-2 truncate"><i class="fas fa-quote-left text-gray-300 mr-1"></i>\${c.last_message}</p>\` : ''}
            </div>
          \`).join('');

          document.getElementById('user-conversations-list').innerHTML = html;
        } catch (error) {
          console.error('Failed to load user conversations:', error);
          document.getElementById('user-conversations-list').innerHTML = '<p class="text-red-500 text-center py-8">Error loading conversations</p>';
        }
      }

      async function loadAgentConversations() {
        try {
          const token = getAuthToken();
          const response = await axios.get('/api/admin/agent-conversations?limit=20', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const conversations = response.data.conversations || [];
          
          if (conversations.length === 0) {
            document.getElementById('ai-conversations-list').innerHTML = '<p class="text-gray-500 text-center py-8">No AI conversations yet</p>';
            return;
          }

          const html = conversations.map(c => \`
            <div class="border rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="viewConversation(\${c.user_id}, 'ai')">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <img src="\${c.user_avatar || '/default-avatar.png'}" alt="\${c.user_name}" class="w-10 h-10 rounded-full">
                  <div>
                    <p class="font-medium">\${c.user_name}</p>
                    <p class="text-xs text-gray-500">\${c.user_email}</p>
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-xs px-2 py-1 rounded-full bg-purple-100 text-purple-700">
                    <i class="fas fa-robot mr-1"></i>\${c.message_count} messages
                  </span>
                </div>
              </div>
              <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
                <span><i class="fas fa-clock mr-1"></i>\${c.last_message_at ? new Date(c.last_message_at).toLocaleString() : ''}</span>
                \${c.last_message ? \`<span class="truncate max-w-xs"><i class="fas fa-quote-left text-gray-300 mr-1"></i>\${c.last_message.substring(0, 80)}...</span>\` : ''}
              </div>
            </div>
          \`).join('');

          document.getElementById('ai-conversations-list').innerHTML = html;
        } catch (error) {
          console.error('Failed to load AI conversations:', error);
          document.getElementById('ai-conversations-list').innerHTML = '<p class="text-red-500 text-center py-8">Error loading AI conversations</p>';
        }
      }

      async function loadActiveUsers() {
        try {
          const token = getAuthToken();
          const response = await axios.get('/api/admin/stats/active-users', {
            headers: { Authorization: \`Bearer \${token}\` }
          });

          const { topMessagers, recentActive } = response.data;

          // Top messagers
          const topHtml = (topMessagers || []).map((u, i) => \`
            <div class="flex items-center justify-between p-2 border rounded-lg hover:bg-gray-50">
              <div class="flex items-center space-x-2">
                <span class="text-sm font-bold text-gray-400 w-5">#\${i + 1}</span>
                <img src="\${u.avatar_url || '/default-avatar.png'}" alt="\${u.name}" class="w-8 h-8 rounded-full">
                <div>
                  <p class="text-sm font-medium">\${u.name}</p>
                  <p class="text-xs text-gray-500">\${u.email}</p>
                </div>
              </div>
              <div class="text-right text-xs">
                <span class="text-blue-600">\${u.message_count} msgs</span>
                <span class="text-purple-600 ml-2">\${u.ai_chat_count} AI</span>
              </div>
            </div>
          \`).join('') || '<p class="text-gray-500 text-center py-4">No data</p>';

          // Recent active
          const recentHtml = (recentActive || []).map(u => \`
            <div class="flex items-center justify-between p-2 border rounded-lg hover:bg-gray-50">
              <div class="flex items-center space-x-2">
                <img src="\${u.avatar_url || '/default-avatar.png'}" alt="\${u.name}" class="w-8 h-8 rounded-full">
                <div>
                  <p class="text-sm font-medium">\${u.name}</p>
                  <p class="text-xs text-gray-500">\${u.email}</p>
                </div>
              </div>
              <span class="text-xs text-gray-500">\${u.last_activity ? new Date(u.last_activity).toLocaleString() : ''}</span>
            </div>
          \`).join('') || '<p class="text-gray-500 text-center py-4">No recent activity</p>';

          document.getElementById('top-messagers-list').innerHTML = topHtml;
          document.getElementById('recent-active-list').innerHTML = recentHtml;
        } catch (error) {
          console.error('Failed to load active users:', error);
        }
      }

      function showActivitySubTab(subtab) {
        // Update subtab buttons
        document.querySelectorAll('.activity-subtab').forEach(t => {
          t.classList.remove('text-primary', 'border-primary');
          t.classList.add('text-gray-500', 'border-transparent');
        });
        document.getElementById(subtab + '-subtab').classList.remove('text-gray-500', 'border-transparent');
        document.getElementById(subtab + '-subtab').classList.add('text-primary', 'border-primary');

        // Show/hide content
        document.querySelectorAll('.activity-subtab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(subtab + '-content').classList.remove('hidden');

        // Load data
        if (subtab === 'user-chats') {
          loadUserConversations();
        } else if (subtab === 'ai-chats') {
          loadAgentConversations();
        } else if (subtab === 'active-users') {
          loadActiveUsers();
        }
      }

      async function viewConversation(id, type) {
        try {
          const token = getAuthToken();
          
          if (type === 'user') {
            const response = await axios.get(\`/api/admin/conversations/\${id}/messages\`, {
              headers: { Authorization: \`Bearer \${token}\` }
            });

            const messages = response.data.messages || [];
            
            document.getElementById('conversation-modal-title').innerHTML = '<i class="fas fa-comments mr-2"></i>User Conversation';
            
            const html = messages.map(m => \`
              <div class="flex \${m.sender_id % 2 === 0 ? 'justify-start' : 'justify-end'}">
                <div class="max-w-[80%] \${m.sender_id % 2 === 0 ? 'bg-gray-100' : 'bg-blue-100'} rounded-lg p-3">
                  <div class="flex items-center space-x-2 mb-1">
                    <img src="\${m.sender_avatar || '/default-avatar.png'}" alt="\${m.sender_name}" class="w-6 h-6 rounded-full">
                    <span class="text-xs font-medium">\${m.sender_name}</span>
                    <span class="text-xs text-gray-500">\${new Date(m.created_at).toLocaleString()}</span>
                  </div>
                  <p class="text-sm">\${m.message}</p>
                </div>
              </div>
            \`).join('') || '<p class="text-gray-500 text-center py-4">No messages</p>';

            document.getElementById('conversation-messages').innerHTML = html;
          } else {
            // AI conversation - id is actually user_id
            const response = await axios.get(\`/api/admin/agent-conversations/\${id}\`, {
              headers: { Authorization: \`Bearer \${token}\` }
            });

            const conv = response.data.conversation;
            const messages = conv.messages || [];
            
            document.getElementById('conversation-modal-title').innerHTML = \`<i class="fas fa-robot mr-2"></i>AI Conversation with \${conv.user_name}\`;
            
            const html = \`
              <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-sm"><strong>User:</strong> \${conv.user_name} (\${conv.user_email})</p>
                <p class="text-xs text-gray-500">Total messages: \${messages.length}</p>
              </div>
              <div class="space-y-4">
                \${messages.map(m => \`
                  <div class="flex \${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[80%] \${m.role === 'user' ? 'bg-blue-100' : 'bg-purple-100'} rounded-lg p-3">
                      <div class="flex items-center space-x-2 mb-1">
                        <i class="fas \${m.role === 'user' ? 'fa-user' : 'fa-robot'} text-xs"></i>
                        <span class="text-xs font-medium capitalize">\${m.role}</span>
                        <span class="text-xs text-gray-500">\${new Date(m.created_at).toLocaleString()}</span>
                      </div>
                      <p class="text-sm whitespace-pre-wrap">\${m.content || ''}</p>
                    </div>
                  </div>
                \`).join('')}
              </div>
            \`;

            document.getElementById('conversation-messages').innerHTML = html || '<p class="text-gray-500 text-center py-4">No messages</p>';
          }

          document.getElementById('conversation-modal').style.display = 'flex';
        } catch (error) {
          console.error('Failed to load conversation:', error);
          alert('Failed to load conversation: ' + error.message);
        }
      }

      function closeConversationModal() {
        document.getElementById('conversation-modal').style.display = 'none';
      }
    <\/script>
  `,currentPage:"dashboard",userName:t,userAvatar:r,pageTitle:"🛡️ Admin Dashboard - ASTAR*",userRole:a})}function Nu(e){const{competitionTitle:t,competitionDescription:r,prizeAmount:a,participants:s}=e;return`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏆 ${t} - Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#8B5CF6',
              secondary: '#A78BFA',
            }
          }
        }
      }
    <\/script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      .text-gradient {
        background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(139, 92, 246, 0.2);
      }
      
      .nav-blur {
        backdrop-filter: blur(12px);
        background-color: rgba(0, 0, 0, 0.9);
      }

      .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
      .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%); }
      .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
    </style>
</head>
<body class="bg-black min-h-screen">
    <!-- Navigation -->
    <nav class="nav-blur sticky top-0 z-50 border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-black text-gradient">
                        <i class="fas fa-rocket mr-2"></i>ASTAR*
                    </a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <a href="/competitions" class="text-gray-300 hover:text-white transition font-semibold">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Competitions
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-5xl font-black mb-4">
                🏆 ${t}
            </h1>
            <p class="text-xl opacity-90 mb-4">${r}</p>
            ${a?`<div class="inline-block bg-yellow-500 text-black px-6 py-2 rounded-full font-bold text-lg">
                Prize: ${a}
            </div>`:""}
        </div>
    </div>

    <!-- Leaderboard -->
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        ${s.length===0?`
            <div class="text-center py-20">
                <i class="fas fa-users text-6xl text-gray-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-2">No Participants Yet</h2>
                <p class="text-gray-400">Be the first to join this competition!</p>
            </div>
        `:`
            <div class="space-y-4">
                ${s.map((o,n)=>{const i=n+1,l=i<=3;return`
                    <div class="card-hover ${i===1?"rank-1":i===2?"rank-2":i===3?"rank-3":"bg-gray-800"} rounded-lg p-6 ${l?"border-2 border-yellow-400":""}">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4 flex-1">
                          <div class="text-4xl font-black ${l?"text-white":"text-purple-400"}">
                            ${(i===1?"🥇":i===2?"🥈":i===3?"🥉":"")||`#${i}`}
                          </div>
                          
                          <div class="flex items-center space-x-3 flex-1">
                            <img src="${o.avatar_url||"/default-avatar.png"}" alt="${o.name}" 
                                 class="w-16 h-16 rounded-full border-4 ${l?"border-white":"border-purple-500"}">
                            <div class="flex-1">
                              <h3 class="text-xl font-bold text-white">${o.name}</h3>
                              <p class="text-sm ${l?"text-white opacity-90":"text-gray-400"}">${o.startup_name||o.project_title||"Startup"}</p>
                              ${o.project_description?`
                                <p class="text-xs ${l?"text-white opacity-80":"text-gray-500"} mt-1 line-clamp-2">
                                  ${o.project_description.substring(0,150)}...
                                </p>
                              `:""}
                            </div>
                          </div>
                        </div>

                        <div class="flex flex-col items-end space-y-2">
                          ${o.payment_status==="completed"?`
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${l?"bg-white text-black":"bg-green-500 text-white"}">
                              <i class="fas fa-check-circle mr-1"></i>Verified
                            </span>
                          `:""}
                          ${o.pitch_deck_url?`
                            <a href="${o.pitch_deck_url}" target="_blank" 
                               class="px-3 py-1 rounded-lg text-xs font-semibold ${l?"bg-white text-black":"bg-purple-600 text-white"} hover:opacity-80 transition">
                              <i class="fas fa-link mr-1"></i>Pitch Deck
                            </a>
                          `:""}
                          <span class="text-xs ${l?"text-white opacity-70":"text-gray-500"}">
                            ${new Date(o.registration_date).toLocaleDateString()}
                          </span>
                        </div>
                      </div>

                      ${o.submission_notes?`
                        <div class="mt-4 pt-4 border-t ${l?"border-white border-opacity-30":"border-gray-700"}">
                          <p class="text-sm ${l?"text-white opacity-90":"text-gray-300"} italic">
                            "${o.submission_notes}"
                          </p>
                        </div>
                      `:""}
                    </div>
                  `}).join("")}
            </div>
        `}
    </div>

    <!-- Footer -->
    <div class="bg-gray-900 py-8 mt-20">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-400">
                Powered by <span class="text-gradient font-bold">ASTAR*</span>
            </p>
        </div>
    </div>
</body>
</html>
  `}const we=new ee;function Be(e){if(!e.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");return e.JWT_SECRET}const Hn=60,Pu=5;async function id(e,t,r){if(!e)return{allowed:!0};const a=`auth_rate_limit:${r}:${t}`;try{const s=await e.get(a),o=s?parseInt(s):0;return o>=Pu?{allowed:!1,retryAfter:Hn,attempts:o}:(await e.put(a,(o+1).toString(),{expirationTtl:Hn}),{allowed:!0,attempts:o+1})}catch(s){return console.error("Rate limit check failed:",s),{allowed:!0}}}const Un=1e5,Lu=16,ld=32;async function dd(e){const t=new TextEncoder,r=crypto.getRandomValues(new Uint8Array(Lu)),a=await crypto.subtle.importKey("raw",t.encode(e),"PBKDF2",!1,["deriveBits"]),s=await crypto.subtle.deriveBits({name:"PBKDF2",salt:r,iterations:Un,hash:"SHA-256"},a,ld*8),o=new Uint8Array(s),n=Array.from(r).map(l=>l.toString(16).padStart(2,"0")).join(""),i=Array.from(o).map(l=>l.toString(16).padStart(2,"0")).join("");return`pbkdf2:${Un}:${n}:${i}`}async function cd(e,t){if(!t.startsWith("pbkdf2:"))try{return(typeof btoa<"u"?btoa(e):Buffer.from(e,"utf-8").toString("base64"))===t}catch{return!1}const[,r,a,s]=t.split(":"),o=new TextEncoder,n=new Uint8Array(a.match(/.{2}/g).map(u=>parseInt(u,16))),i=await crypto.subtle.importKey("raw",o.encode(e),"PBKDF2",!1,["deriveBits"]),l=await crypto.subtle.deriveBits({name:"PBKDF2",salt:n,iterations:parseInt(r),hash:"SHA-256"},i,ld*8),d=Array.from(new Uint8Array(l)).map(u=>u.toString(16).padStart(2,"0")).join("");if(d.length!==s.length)return!1;let c=0;for(let u=0;u<d.length;u++)c|=d.charCodeAt(u)^s.charCodeAt(u);return c===0}we.post("/register",async e=>{try{const{email:t,password:r,name:a,role:s="founder"}=await e.req.json();if(!t||!r||!a)return e.json({error:"Email, password and name are required"},400);const o=e.req.header("CF-Connecting-IP")||e.req.header("X-Forwarded-For")||"unknown",n=await id(e.env.CACHE,o,"register");if(!n.allowed)return e.json({error:`Too many registration attempts. Please try again in ${n.retryAfter} seconds.`},429);if(!["founder","investor","scout","partner","job_seeker","other","validator","admin"].includes(s))return e.json({error:"Invalid role"},400);if(await e.env.DB.prepare("SELECT id FROM users WHERE email = ?").bind(t).first())return e.json({error:"Email already registered"},400);const d=await dd(r),u=(await e.env.DB.prepare(`
      INSERT INTO users (email, password, name, role, plan)
      VALUES (?, ?, ?, ?, ?)
    `).bind(t,d,a,s,"starter").run()).meta.last_row_id;s==="validator"&&await e.env.DB.prepare(`
        INSERT INTO validators (user_id, title, expertise)
        VALUES (?, ?, ?)
      `).bind(u,"New Validator","[]").run();const p=await e.env.DB.prepare(`
      SELECT ti.*, st.name as team_name
      FROM team_invitations ti
      JOIN startup_teams st ON ti.team_id = st.id
      WHERE ti.email = ? AND ti.status = 'pending'
    `).bind(t.toLowerCase()).all();let m=s;if(p.results&&p.results.length>0){for(const b of p.results)await e.env.DB.prepare(`
          INSERT INTO startup_team_members (team_id, user_id, role, is_creator)
          VALUES (?, ?, ?, 0)
        `).bind(b.team_id,u,b.role).run(),await e.env.DB.prepare(`
          UPDATE team_invitations
          SET status = 'accepted'
          WHERE id = ?
        `).bind(b.id).run(),b.role==="founder"&&(m="founder",await e.env.DB.prepare(`
            UPDATE users SET role = 'founder' WHERE id = ?
          `).bind(u).run());console.log(`User ${t} accepted ${p.results.length} team invitation(s)`)}const g=await yr({userId:u,email:t,role:m,exp:Math.floor(Date.now()/1e3)+3600*24*7},Be(e.env));return e.json({message:"Registration successful",token:g,user:{id:u,email:t,name:a,role:m}})}catch(t){return console.error("Registration error:",t),e.json({error:"Registration failed"},500)}});we.post("/login",async e=>{try{const{email:t,password:r}=await e.req.json();if(!t||!r)return e.json({error:"Email and password are required"},400);const a=e.req.header("CF-Connecting-IP")||e.req.header("X-Forwarded-For")||"unknown",s=await id(e.env.CACHE,`${a}:${t}`,"login");if(!s.allowed)return console.warn(`[SECURITY] Rate limit exceeded for login: IP=${a}, email=${t}`),e.json({error:`Too many login attempts. Please try again in ${s.retryAfter} seconds.`},429);const o=await e.env.DB.prepare("SELECT id, email, password, name, role, plan, avatar_url FROM users WHERE email = ?").bind(t).first();if(!o)return e.json({error:"Invalid credentials"},401);if(!await cd(r,o.password))return e.json({error:"Invalid credentials"},401);const i=await yr({userId:o.id,email:o.email,role:o.role,exp:Math.floor(Date.now()/1e3)+3600*24*7},Be(e.env));return e.json({message:"Login successful",token:i,user:{id:o.id,email:o.email,name:o.name,role:o.role,plan:o.plan,avatar_url:o.avatar_url}})}catch(t){return console.error("Login error:",t),e.json({error:"Login failed"},500)}});we.get("/me",async e=>{try{const t=e.req.header("Authorization");if(!t||!t.startsWith("Bearer "))return e.json({error:"Unauthorized"},401);const r=t.substring(7),a=await te(r,Be(e.env)),s=await e.env.DB.prepare(`
      SELECT 
        u.id, u.email, u.name, u.role, u.plan, u.avatar_url, u.bio, u.company,
        v.id as validator_id, v.title, v.expertise, v.rating, v.total_validations
      FROM users u
      LEFT JOIN validators v ON u.id = v.user_id
      WHERE u.id = ?
    `).bind(a.userId).first();return s?e.json({user:s}):e.json({error:"User not found"},404)}catch(t){return console.error("Auth error:",t),e.json({error:"Invalid or expired token"},401)}});we.put("/profile",async e=>{try{const t=e.req.header("Authorization");if(!t||!t.startsWith("Bearer "))return e.json({error:"Unauthorized"},401);const r=t.substring(7),a=await te(r,Be(e.env)),{name:s,bio:o,company:n,avatar_url:i}=await e.req.json();return await e.env.DB.prepare(`
      UPDATE users 
      SET name = COALESCE(?, name),
          bio = COALESCE(?, bio),
          company = COALESCE(?, company),
          avatar_url = COALESCE(?, avatar_url)
      WHERE id = ?
    `).bind(s,o,n,i,a.userId).run(),e.json({message:"Profile updated successfully"})}catch(t){return console.error("Profile update error:",t),e.json({error:"Profile update failed"},500)}});we.put("/role",async e=>{try{const t=e.req.header("Authorization");if(!t||!t.startsWith("Bearer "))return e.json({error:"Unauthorized"},401);const r=t.substring(7),a=await te(r,Be(e.env)),{newRole:s}=await e.req.json();if(!s)return e.json({error:"New role is required"},400);if(!["founder","investor","scout","partner","job_seeker","other","validator","admin"].includes(s))return e.json({error:"Invalid role"},400);await e.env.DB.prepare(`
      UPDATE users 
      SET role = ?
      WHERE id = ?
    `).bind(s,a.userId).run(),s==="validator"&&(await e.env.DB.prepare("SELECT id FROM validators WHERE user_id = ?").bind(a.userId).first()||await e.env.DB.prepare(`
          INSERT INTO validators (user_id, title, expertise)
          VALUES (?, ?, ?)
        `).bind(a.userId,"New Validator","[]").run());const n=await yr({userId:a.userId,email:a.email,role:s,exp:Math.floor(Date.now()/1e3)+3600*24*7},Be(e.env)),i=await e.env.DB.prepare("SELECT id, email, name, role FROM users WHERE id = ?").bind(a.userId).first();return e.json({message:"Role updated successfully",token:n,user:i})}catch(t){return console.error("Role update error:",t),e.json({error:"Role update failed"},500)}});we.post("/change-password",async e=>{try{const t=e.req.header("Authorization");if(!t||!t.startsWith("Bearer "))return e.json({error:"Unauthorized"},401);const r=t.substring(7),a=await te(r,Be(e.env)),{currentPassword:s,newPassword:o}=await e.req.json();if(!s||!o)return e.json({error:"Current and new password are required"},400);const n=await e.env.DB.prepare("SELECT password FROM users WHERE id = ?").bind(a.userId).first();if(!await cd(s,n.password))return e.json({error:"Current password is incorrect"},401);const l=await dd(o);return await e.env.DB.prepare("UPDATE users SET password = ? WHERE id = ?").bind(l,a.userId).run(),e.json({message:"Password changed successfully"})}catch(t){return console.error("Password change error:",t),e.json({error:"Password change failed"},500)}});we.post("/logout",async e=>{try{const t=e.req.header("Authorization");if(t&&t.startsWith("Bearer ")){const r=t.substring(7),a=await te(r,Be(e.env));console.log(`User ${a.userId} logged out at ${new Date().toISOString()}`)}return e.json({message:"Logout successful"})}catch{return e.json({message:"Logout successful"})}});we.get("/google",async e=>{const t=e.env.GOOGLE_CLIENT_ID,r=`${new URL(e.req.url).origin}/api/auth/google/callback`;if(!t)return e.json({error:"Google OAuth not configured"},500);const a=e.req.query("role")||"founder",s=e.req.query("redirect")||"",o="https://accounts.google.com/o/oauth2/v2/auth?"+new URLSearchParams({client_id:t,redirect_uri:r,response_type:"code",scope:"openid email profile",state:JSON.stringify({role:a,redirect:s}),access_type:"offline",prompt:"consent"});return e.redirect(o)});we.get("/google/callback",async e=>{console.log("[GOOGLE-CALLBACK] Starting OAuth callback..."),console.log("[GOOGLE-CALLBACK] Full URL:",e.req.url);try{const t=e.req.query("code"),r=e.req.query("error"),a=e.req.query("state")||'{"role":"founder"}';if(console.log("[GOOGLE-CALLBACK] Code present:",!!t),console.log("[GOOGLE-CALLBACK] Error param:",r),console.log("[GOOGLE-CALLBACK] State:",a),r)return console.error("[GOOGLE-CALLBACK] OAuth error from Google:",r),e.redirect("/?error="+r);if(!t)return console.error("[GOOGLE-CALLBACK] No authorization code provided"),e.redirect("/?error=no_code");let s;try{s=JSON.parse(a)}catch{console.log("[GOOGLE-CALLBACK] Failed to parse state, using defaults"),s={role:"founder",redirect:""}}let o=s.role||"founder";const n=s.redirect||"",i=e.env.GOOGLE_CLIENT_ID,l=e.env.GOOGLE_CLIENT_SECRET,d=`${new URL(e.req.url).origin}/api/auth/google/callback`;if(console.log("[GOOGLE-CALLBACK] Redirect URI:",d),console.log("[GOOGLE-CALLBACK] Client ID present:",!!i),!i||!l)return console.error("[GOOGLE-CALLBACK] Google OAuth not configured"),e.redirect("/?error=oauth_not_configured");console.log("[GOOGLE-CALLBACK] Exchanging code for token...");const u=await(await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:i,client_secret:l,code:t,grant_type:"authorization_code",redirect_uri:d})})).json();if(console.log("[GOOGLE-CALLBACK] Token response:",u.error||"Success"),!u.access_token)return console.error("[GOOGLE-CALLBACK] Failed to get access token:",u.error,u.error_description),e.redirect("/?error=token_exchange_failed");console.log("[GOOGLE-CALLBACK] Getting user info from Google...");const m=await(await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${u.access_token}`}})).json();if(console.log("[GOOGLE-CALLBACK] User email:",m.email),!m.email)return console.error("[GOOGLE-CALLBACK] Failed to get user email"),e.redirect("/?error=no_email");let g=await e.env.DB.prepare("SELECT id, role FROM users WHERE email = ?").bind(m.email).first(),b;if(g)console.log("[GOOGLE-CALLBACK] Existing user found:",g.id),b=g.id,o=g.role,await e.env.DB.prepare(`
        UPDATE users
        SET name = COALESCE(?, name),
            avatar_url = COALESCE(?, avatar_url)
        WHERE id = ?
      `).bind(m.name,m.picture,b).run();else{console.log("[GOOGLE-CALLBACK] Creating new user..."),o=s.role,["founder","investor","scout","partner","job_seeker","other","validator","admin"].includes(o)||(o="founder"),b=(await e.env.DB.prepare(`
        INSERT INTO users (email, name, role, plan, avatar_url)
        VALUES (?, ?, ?, ?, ?)
      `).bind(m.email,m.name,o,"starter",m.picture).run()).meta.last_row_id,console.log("[GOOGLE-CALLBACK] New user created:",b),o==="validator"&&await e.env.DB.prepare(`
          INSERT INTO validators (user_id, title, expertise)
          VALUES (?, ?, ?)
        `).bind(b,"New Validator","[]").run();const I=await e.env.DB.prepare(`
        SELECT ti.*, st.name as team_name
        FROM team_invitations ti
        JOIN startup_teams st ON ti.team_id = st.id
        WHERE ti.email = ? AND ti.status = 'pending'
      `).bind(m.email.toLowerCase()).all();if(I.results&&I.results.length>0){for(const M of I.results)await e.env.DB.prepare(`
            INSERT INTO startup_team_members (team_id, user_id, role, is_creator)
            VALUES (?, ?, ?, 0)
          `).bind(M.team_id,b,M.role).run(),await e.env.DB.prepare(`
            UPDATE team_invitations
            SET status = 'accepted'
            WHERE id = ?
          `).bind(M.id).run(),M.role==="founder"&&(o="founder",await e.env.DB.prepare(`
              UPDATE users SET role = 'founder' WHERE id = ?
            `).bind(b).run());console.log(`[GOOGLE-CALLBACK] User ${m.email} accepted ${I.results.length} team invitation(s)`)}g={id:b,role:o,needsOnboarding:!0}}const v=await yr({userId:b,email:m.email,userName:m.name,role:o,exp:Math.floor(Date.now()/1e3)+3600*24*7},Be(e.env));console.log("[GOOGLE-CALLBACK] JWT token generated");const y=new URL(e.req.url).origin,f=g.needsOnboarding?"/onboarding":n||"/dashboard",_=!y.includes("localhost")&&!y.includes("127.0.0.1")?"; Secure":"";return e.header("Set-Cookie",`authToken=${v}; Path=/; Max-Age=${3600*24*7}; SameSite=Lax${_}`),console.log("[GOOGLE-CALLBACK] Redirecting to:",f),e.redirect(f)}catch(t){return console.error("[GOOGLE-CALLBACK] ERROR:",t),console.error("[GOOGLE-CALLBACK] Error stack:",t instanceof Error?t.stack:"No stack"),e.redirect("/?error=callback_failed")}});we.post("/complete-onboarding",async e=>{try{const t=e.req.header("Authorization");if(!t||!t.startsWith("Bearer "))return e.json({error:"No token provided"},401);const r=t.substring(7),a=await te(r,Be(e.env)),s=a.userId,o=a.role,n=await e.req.json(),i=["bio","company"],l=[],d=[];for(const c of i)n[c]!==void 0&&(l.push(`${c} = ?`),d.push(n[c]));if(l.length>0){d.push(s);const c=`UPDATE users SET ${l.join(", ")} WHERE id = ?`;await e.env.DB.prepare(c).bind(...d).run()}if(await e.env.DB.prepare(`
      INSERT INTO onboarding_sessions (user_id, session_data, completed, completed_at)
      VALUES (?, ?, 1, CURRENT_TIMESTAMP)
    `).bind(s,JSON.stringify(n)).run(),o==="founder"&&n.startup_name){const c=await e.env.DB.prepare(`
        SELECT id FROM beta_products WHERE company_user_id = ?
      `).bind(s).first(),u=n.startup_name,p=n.industry?`${n.startup_name} - ${n.industry} startup at ${n.startup_stage||"early"} stage`:`${n.startup_name} - Building the future`,m=n.industry||"Tech",g=n.startup_stage==="idea"?"concept":n.startup_stage==="mvp"?"alpha":n.startup_stage==="early_revenue"?"beta":"production",b=n.funding_status==="bootstrapped"||n.funding_status==="pre_seed"?"Early feedback, validators, and potential investors":"Product validation and user feedback";c?await e.env.DB.prepare(`
          UPDATE beta_products 
          SET title = ?,
              description = ?,
              category = ?,
              stage = ?,
              looking_for = ?,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ?
        `).bind(u,p,m,g,b,c.id).run():await e.env.DB.prepare(`
          INSERT INTO beta_products (
            company_user_id, 
            title, 
            description, 
            category, 
            stage, 
            looking_for,
            compensation_type,
            status
          ) VALUES (?, ?, ?, ?, ?, ?, 'free_access', 'active')
        `).bind(s,u,p,m,g,b).run();const v=await e.env.DB.prepare(`
        SELECT id FROM projects WHERE user_id = ?
      `).bind(s).first();v?await e.env.DB.prepare(`
          UPDATE projects 
          SET title = ?,
              description = ?,
              target_market = ?,
              status = 'draft',
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ?
        `).bind(u,p,n.target_market||n.industry||"General",v.id).run():await e.env.DB.prepare(`
          INSERT INTO projects (
            user_id,
            title,
            description,
            target_market,
            status
          ) VALUES (?, ?, ?, ?, 'draft')
        `).bind(s,u,p,n.target_market||n.industry||"General").run()}return e.json({success:!0})}catch(t){return console.error("[COMPLETE-ONBOARDING] Error:",t),e.json({error:"Failed to save onboarding data"},500)}});async function j(e,t){try{const r=e.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return e.json({error:"Unauthorized - No token provided"},401);const a=r.substring(7),s=await te(a,Be(e.env));e.set("userId",s.userId),e.set("userRole",s.role),e.set("userEmail",s.email),await t()}catch{return e.json({error:"Unauthorized - Invalid token"},401)}}we.post("/check-user",async e=>{try{const{email:t}=await e.req.json();if(!t)return e.json({error:"Email is required"},400);const r=await e.env.DB.prepare("SELECT id, email, name, role, plan FROM users WHERE email = ?").bind(t).first();if(!r)return e.json({error:"User not found"},404);const a=await e.env.DB.prepare("SELECT password FROM users WHERE id = ?").bind(r.id).first();return e.json({exists:!0,user:{id:r.id,email:r.email,name:r.name,role:r.role,plan:r.plan},auth_provider:a&&a.password?"password":"google"})}catch(t){return console.error("Check user error:",t),e.json({error:"Check user failed"},500)}});we.post("/generate-whatsapp-code",j,async e=>{try{const t=e.get("userId"),r=await e.env.DB.prepare("SELECT code FROM whatsapp_codes WHERE user_id = ?").bind(t).first();if(r)return e.json({message:"Tu código de WhatsApp (permanente)",code:r.code,expires_in:"Nunca - código permanente"});const a=Math.floor(1e5+Math.random()*9e5).toString();return await e.env.DB.prepare(`
      INSERT OR REPLACE INTO whatsapp_codes (user_id, code, expires_at)
      VALUES (?, ?, ?)
    `).bind(t,a,"9999-12-31 23:59:59").run(),e.json({message:"Código generado exitosamente",code:a,expires_in:"Nunca - código permanente"})}catch(t){return console.error("Generate WhatsApp code error:",t),e.json({error:"Failed to generate code"},500)}});we.post("/verify-whatsapp-code",async e=>{try{const{email:t,code:r}=await e.req.json();if(!t||!r)return e.json({error:"Email and code are required"},400);const a=await e.env.DB.prepare("SELECT id, email, name, role, plan FROM users WHERE email = ?").bind(t).first();if(!a)return e.json({error:"User not found"},404);const s=await e.env.DB.prepare(`
      SELECT * FROM whatsapp_codes
      WHERE user_id = ? AND code = ?
    `).bind(a.id,r).first();if(console.log("Code verification:",{userId:a.id,codeProvided:r,found:!!s}),!s)return e.json({error:"Invalid code"},401);const o=await yr({userId:a.id,email:a.email,role:a.role,exp:Math.floor(Date.now()/1e3)+3600*24*7},Be(e.env));return e.json({message:"Code verified successfully",token:o,user:{id:a.id,email:a.email,name:a.name,role:a.role,plan:a.plan}})}catch(t){return console.error("Verify WhatsApp code error:",t),e.json({error:"Code verification failed"},500)}});function Xa(...e){return async(t,r)=>{const a=t.get("userRole");if(!e.includes(a))return t.json({error:"Forbidden - Insufficient permissions"},403);await r()}}we.get("/users-by-role",async e=>{try{const t=e.req.query("role");if(!t)return e.json({error:"Role parameter is required"},400);if(!["founder","investor","scout","partner","job_seeker","other","validator"].includes(t))return e.json({error:"Invalid role"},400);const a=await e.env.DB.prepare(`
      SELECT 
        id,
        name,
        email,
        role,
        company,
        avatar_url,
        location,
        skills,
        interests,
        investment_range,
        looking_for,
        linkedin_url,
        twitter_url,
        website_url,
        created_at
      FROM users
      WHERE role = ?
      ORDER BY created_at DESC
      LIMIT 50
    `).bind(t).all();return e.json(a.results||[])}catch(t){return console.error("[AUTH] Error getting users by role:",t),e.json({error:"Failed to get users"},500)}});we.get("/user-profile/:userId",async e=>{try{const t=e.req.param("userId");if(!t)return e.json({error:"User ID is required"},400);const r=await e.env.DB.prepare(`
      SELECT 
        id,
        name,
        email,
        role,
        bio,
        company,
        avatar_url,
        location,
        skills,
        interests,
        investment_range,
        looking_for,
        linkedin_url,
        twitter_url,
        website_url,
        created_at
      FROM users
      WHERE id = ?
    `).bind(t).first();if(!r)return e.json({error:"User not found"},404);const a=await e.env.DB.prepare(`
      SELECT session_data, completed, completed_at
      FROM onboarding_sessions
      WHERE user_id = ?
      ORDER BY completed_at DESC
      LIMIT 1
    `).bind(t).first();let s=null;if(a&&a.session_data)try{s=JSON.parse(a.session_data)}catch(o){console.error("Error parsing onboarding data:",o)}return e.json({...r,onboarding:s})}catch(t){return console.error("[AUTH] Error getting user profile:",t),e.json({error:"Failed to get user profile"},500)}});const Gn=5;async function ju(e,t){if(!e)return{allowed:!0};const r=`vote_rate_limit:${t}`;try{const a=await e.get(r);if(a){const s=Date.now()-parseInt(a),o=Gn*1e3-s;if(o>0)return{allowed:!1,retryAfter:Math.ceil(o/1e3)}}return await e.put(r,Date.now().toString(),{expirationTtl:Gn}),{allowed:!0}}catch(a){return console.error("Rate limit check failed:",a),{allowed:!0}}}const Me=new ee;Me.get("/",async e=>{const{results:t}=await e.env.DB.prepare("SELECT id, user_id, title, description, target_market, value_proposition, status, category, rating_average, votes_count, created_at, updated_at FROM projects ORDER BY created_at DESC").all();return e.json({projects:t})});Me.get("/:id",async e=>{const t=e.req.param("id"),r=await e.env.DB.prepare("SELECT id, user_id, title, description, target_market, value_proposition, status, category, rating_average, votes_count, created_at, updated_at FROM projects WHERE id = ?").bind(t).first();if(!r)return e.json({error:"Project not found"},404);const a=await e.env.DB.prepare(`
    SELECT 
      bp.*,
      u.name as company_name,
      u.avatar_url as company_avatar,
      u.company,
      u.bio as company_bio
    FROM beta_products bp
    JOIN users u ON bp.company_user_id = u.id
    WHERE bp.project_id = ?
  `).bind(t).first(),s=await e.env.DB.prepare("SELECT * FROM market_analysis WHERE project_id = ?").bind(t).first(),o=await e.env.DB.prepare("SELECT * FROM mvp_prototypes WHERE project_id = ?").bind(t).first(),{results:n}=await e.env.DB.prepare(`
    SELECT tr.*, bu.name as user_name, bu.role as user_role, bu.rating as user_rating
    FROM test_results tr
    JOIN beta_users bu ON tr.beta_user_id = bu.id
    WHERE tr.project_id = ?
  `).bind(t).all(),{results:i}=await e.env.DB.prepare("SELECT * FROM growth_strategies WHERE project_id = ? ORDER BY priority DESC").bind(t).all(),{results:l}=await e.env.DB.prepare("SELECT * FROM metrics WHERE project_id = ? ORDER BY date DESC").bind(t).all();return e.json({project:r,betaProduct:a,marketAnalysis:s?{...s,competitors:JSON.parse(s.competitors),market_trends:JSON.parse(s.market_trends),opportunities:JSON.parse(s.opportunities),threats:JSON.parse(s.threats)}:null,mvpPrototype:o?{...o,features:JSON.parse(o.features),tech_stack:JSON.parse(o.tech_stack)}:null,testResults:n,growthStrategies:i.map(d=>({...d,channels:JSON.parse(d.channels)})),metrics:l})});Me.post("/",async e=>{const r=await e.req.json(),{title:a,description:s,target_market:o,value_proposition:n,category:i="general"}=r,l=await e.env.DB.prepare(`
    INSERT INTO projects (user_id, title, description, target_market, value_proposition, category, status)
    VALUES (?, ?, ?, ?, ?, ?, 'draft')
  `).bind(1,a,s,o,n,i).run();return e.json({id:l.meta.last_row_id,message:"Project created successfully"})});Me.patch("/:id/status",async e=>{const t=e.req.param("id"),{status:r}=await e.req.json();return await e.env.DB.prepare("UPDATE projects SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?").bind(r,t).run(),e.json({message:"Status updated"})});Me.post("/:id/vote",j,async e=>{var o;const t=e.req.param("id"),r=e.var.userId,a=await ju(e.env.CACHE,r);if(!a.allowed)return e.json({error:`Please wait ${a.retryAfter} seconds before voting again`,retryAfter:a.retryAfter},429);const{rating:s}=await e.req.json();if(!s||s<1||s>5)return e.json({error:"Rating must be between 1 and 5"},400);try{const n=await e.env.DB.prepare("SELECT id, category FROM projects WHERE id = ?").bind(t).first();if(!n)return e.json({error:"Project not found"},404);await e.env.DB.prepare(`
      INSERT INTO project_votes (project_id, user_id, rating, updated_at)
      VALUES (?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(project_id, user_id) DO UPDATE SET
        rating = excluded.rating,
        updated_at = CURRENT_TIMESTAMP
    `).bind(t,r,s).run();try{const l=["leaderboard:all:all:50",`leaderboard:${n.category||"general"}:all:50`,"leaderboard:all:week:50","leaderboard:all:month:50","leaderboard:all:year:50"];for(const d of l)await((o=e.env.CACHE)==null?void 0:o.delete(d))}catch{}return e.json({message:"Vote recorded successfully",success:!0,rating:s})}catch(n){return console.error("Error recording vote:",n),e.json({error:"Failed to record vote"},500)}});Me.get("/:id/vote",async e=>{const t=e.req.param("id"),a=await e.env.DB.prepare("SELECT rating FROM project_votes WHERE project_id = ? AND user_id = ?").bind(t,1).first();return e.json({vote:a||null})});Me.get("/leaderboard/top",async e=>{var c,u,p;const t=e.req.query("category")||"all",r=parseInt(e.req.query("limit")||"50"),a=e.req.query("timeframe")||"all",s=e.req.header("Authorization")||e.req.header("Cookie");let o=!1;if(s)try{const m=s.includes("Bearer ")?s.replace("Bearer ",""):(c=s.match(/authToken=([^;]+)/))==null?void 0:c[1];if(m){const{verify:g}=await Promise.resolve().then(()=>Ya);e.env.JWT_SECRET&&(o=(await g(m,e.env.JWT_SECRET)).role==="admin")}}catch{}const n=`leaderboard:${t}:${a}:${r}${o?":admin":""}:v2`;if(!o)try{const m=await((u=e.env.CACHE)==null?void 0:u.get(n,"json"));if(m)return e.json(m)}catch{}let i=`
    SELECT
      bp.id,
      bp.title,
      bp.description,
      bp.category,
      bp.rating_average,
      bp.votes_count,
      bp.created_at,
      u.name as creator_name,
      bp.company_user_id as user_id,
      -- Contar goals del usuario dueño del producto
      (SELECT COUNT(*) FROM goals WHERE user_id = bp.company_user_id) as total_goals,
      (SELECT COUNT(*) FROM goals WHERE user_id = bp.company_user_id AND status = 'completed') as completed_goals,
      (SELECT COUNT(*) FROM goals WHERE user_id = bp.company_user_id AND status = 'in_progress') as active_goals,
      (SELECT COUNT(*) FROM goals WHERE user_id = bp.company_user_id AND created_at >= datetime('now', '-7 days')) as recent_goals,
      -- Métricas actuales
      (SELECT metric_value FROM user_metrics WHERE user_id = bp.company_user_id AND metric_name = 'users' ORDER BY recorded_date DESC LIMIT 1) as current_users,
      (SELECT metric_value FROM user_metrics WHERE user_id = bp.company_user_id AND metric_name = 'revenue' ORDER BY recorded_date DESC LIMIT 1) as current_revenue,
      -- Métricas de hace 7 días (para calcular WoW growth)
      (SELECT metric_value FROM user_metrics WHERE user_id = bp.company_user_id AND metric_name = 'users' AND recorded_date <= datetime('now', '-7 days') ORDER BY recorded_date DESC LIMIT 1) as users_7d_ago,
      (SELECT metric_value FROM user_metrics WHERE user_id = bp.company_user_id AND metric_name = 'revenue' AND recorded_date <= datetime('now', '-7 days') ORDER BY recorded_date DESC LIMIT 1) as revenue_7d_ago,
      -- Métricas de hace 30 días (para calcular MoM growth)
      (SELECT metric_value FROM user_metrics WHERE user_id = bp.company_user_id AND metric_name = 'users' AND recorded_date <= datetime('now', '-30 days') ORDER BY recorded_date DESC LIMIT 1) as users_30d_ago,
      (SELECT metric_value FROM user_metrics WHERE user_id = bp.company_user_id AND metric_name = 'revenue' AND recorded_date <= datetime('now', '-30 days') ORDER BY recorded_date DESC LIMIT 1) as revenue_30d_ago,
      -- Weekly traction data from goal_weekly_traction (last 4 weeks)
      (SELECT SUM(revenue_amount) FROM goal_weekly_traction WHERE user_id = bp.company_user_id AND created_at >= datetime('now', '-28 days')) as traction_revenue_4w,
      (SELECT SUM(new_users) FROM goal_weekly_traction WHERE user_id = bp.company_user_id AND created_at >= datetime('now', '-28 days')) as traction_new_users_4w,
      (SELECT AVG(active_users) FROM goal_weekly_traction WHERE user_id = bp.company_user_id AND created_at >= datetime('now', '-28 days')) as traction_avg_active_4w,
      (SELECT SUM(churned_users) FROM goal_weekly_traction WHERE user_id = bp.company_user_id AND created_at >= datetime('now', '-28 days')) as traction_churned_4w,
      (SELECT COUNT(*) FROM goal_weekly_traction WHERE user_id = bp.company_user_id) as traction_reporting_weeks,
      -- Latest week traction (for growth calculation)
      (SELECT revenue_amount FROM goal_weekly_traction WHERE user_id = bp.company_user_id ORDER BY year DESC, week_number DESC LIMIT 1) as traction_latest_revenue,
      (SELECT active_users FROM goal_weekly_traction WHERE user_id = bp.company_user_id ORDER BY year DESC, week_number DESC LIMIT 1) as traction_latest_active,
      -- Previous week traction (for WoW growth)
      (SELECT revenue_amount FROM goal_weekly_traction WHERE user_id = bp.company_user_id ORDER BY year DESC, week_number DESC LIMIT 1 OFFSET 1) as traction_prev_revenue,
      (SELECT active_users FROM goal_weekly_traction WHERE user_id = bp.company_user_id ORDER BY year DESC, week_number DESC LIMIT 1 OFFSET 1) as traction_prev_active,
      -- Actividad reciente (engagement)
      (SELECT COUNT(*) FROM agent_chat_messages WHERE user_id = bp.company_user_id AND created_at >= datetime('now', '-7 days')) as weekly_engagement,
      -- Días desde creación
      CAST((julianday('now') - julianday(bp.created_at)) AS INTEGER) as days_active
    FROM beta_products bp
    JOIN users u ON bp.company_user_id = u.id
    WHERE bp.status = 'active'
  `;const l=[];if(t!=="all"&&(i+=" AND bp.category = ?",l.push(t)),a!=="all"){const g={week:7,month:30,year:365}[a]||365;i+=` AND bp.created_at >= datetime('now', '-${g} days')`}const d=i+" ORDER BY bp.rating_average DESC, bp.votes_count DESC";try{const{results:m}=await e.env.DB.prepare(d).bind(...l).all(),g=m.map(y=>{const f=Bu(y);return{...y,leaderboard_score:f.finalScore,vc_score:f.vcScore,growth_velocity:f.growthVelocity,score_breakdown:f.breakdown,growth_wow:f.growthWoW,growth_mom:f.growthMoM,tractionData:f.tractionData}});g.sort((y,f)=>f.leaderboard_score-y.leaderboard_score);const v={leaderboard:o?g:g.slice(0,r),isAdmin:o};try{await((p=e.env.CACHE)==null?void 0:p.put(n,JSON.stringify(v),{expirationTtl:300}))}catch{}return e.json(v)}catch(m){return console.error("Error fetching leaderboard:",m),e.json({error:"Failed to fetch leaderboard"},500)}});function Bu(e){const t=e.current_users||0,r=e.current_revenue||0,a=e.users_7d_ago||0,s=e.revenue_7d_ago||0,o=e.users_30d_ago||0,n=e.revenue_30d_ago||0;e.days_active;const i=e.traction_revenue_4w||0,l=e.traction_new_users_4w||0,d=e.traction_avg_active_4w||0,c=e.traction_churned_4w||0,u=e.traction_reporting_weeks||0,p=e.traction_latest_revenue||0,m=e.traction_latest_active||0,g=e.traction_prev_revenue||0,b=e.traction_prev_active||0,v=u>=4?10:u*2.5;let y=0,f=0;b>0&&m>0?y=(m-b)/b*100:a>0?y=(t-a)/a*100:(t>0||m>0)&&(y=50),g>0&&p>0?f=(p-g)/g*100:s>0?f=(r-s)/s*100:(r>0||p>0)&&(f=50);const x=o>0?(t-o)/o*100:t>0?50:0,_=n>0?(r-n)/n*100:r>0?50:0,C=Math.min(Math.max(y*5,0),100),A=Math.min(Math.max(f*5,0),100),I=C*.4+A*.6,M=Math.max(t,d),F=M>0?Math.min(Math.log10(M+1)/Math.log10(1e5)*100,100):0,N=i>0?i:r,E=N>0?Math.min(Math.log10(N+1)/Math.log10(1e6)*100,100):0,O=M>0?N/M:0,B=Math.min(O/100*100,100),H=l>0?Math.min(l/100*100,50):0,P=F*.3+E*.4+B*.2+H*.1,D=e.votes_count||0,k=e.rating_average||0,T=Math.min(D/50*100,100),L=k/5*100,ae=D>0?T*.4+L*.6:0,ce=e.total_goals||0,Y=e.completed_goals||0,se=e.active_goals||0,Ce=e.recent_goals||0,Oe=ce>0?Y/ce*100:0,ve=se>0?20:0,Xe=Ce>0?Math.min(Ce*10,30):0,We=Math.min(Oe+ve+Xe+v,100),me=e.weekly_engagement||0,z=Math.min(me/50*100,100),Z=I*.35+P*.25+ae*.2+We*.15+z*.05;let J="C";return Z>=80?J="A+":Z>=70?J="A":Z>=60?J="B+":Z>=50?J="B":Z>=40?J="C+":Z>=30?J="C":J="D",{finalScore:Math.round(Z*10)/10,vcScore:J,growthVelocity:Math.round((y+f)/2*10)/10,growthWoW:{users:Math.round(y*10)/10,revenue:Math.round(f*10)/10},growthMoM:{users:Math.round(x*10)/10,revenue:Math.round(_*10)/10},tractionData:{revenue4w:i,newUsers4w:l,avgActive4w:Math.round(d),churned4w:c,reportingWeeks:u,consistencyBonus:Math.round(v*10)/10,latestRevenue:p,latestActive:m,prevRevenue:g,prevActive:b,userWoWGrowth:Math.round(y*10)/10,revenueWoWGrowth:Math.round(f*10)/10},breakdown:{growth:Math.round(I*10)/10,traction:Math.round(P*10)/10,validation:Math.round(ae*10)/10,execution:Math.round(We*10)/10,engagement:Math.round(z*10)/10}}}Me.get("/leaderboard/categories",async e=>{try{const{results:t}=await e.env.DB.prepare(`
      SELECT
        category,
        COUNT(*) as project_count,
        AVG(rating_average) as avg_rating,
        SUM(votes_count) as total_votes
      FROM projects
      WHERE status = 'published' AND votes_count > 0
      GROUP BY category
      ORDER BY avg_rating DESC
    `).all();return e.json({categories:t})}catch(t){return console.error("Error fetching category stats:",t),e.json({error:"Failed to fetch category stats"},500)}});Me.get("/:id/founders",async e=>{const t=e.req.param("id");try{const{results:r}=await e.env.DB.prepare(`
      SELECT 
        pf.*,
        u.email as user_email,
        u.avatar_url as user_avatar
      FROM project_founders pf
      LEFT JOIN users u ON pf.user_id = u.id
      WHERE pf.project_id = ?
      ORDER BY pf.is_creator DESC, pf.joined_at ASC
    `).bind(t).all();return e.json({founders:r||[]})}catch(r){return console.error("Error fetching founders:",r),e.json({error:"Failed to fetch founders"},500)}});Me.post("/:id/founders",j,async e=>{const t=e.req.param("id"),r=e.var.userId,a=await e.req.json(),{name:s,email:o,role:n,equity_percentage:i,user_id:l}=a;if(!s||!n)return e.json({error:"Name and role are required"},400);try{const d=await e.env.DB.prepare("SELECT user_id FROM projects WHERE id = ?").bind(t).first();if(!d)return e.json({error:"Project not found"},404);if(d.user_id!==r)return e.json({error:"Not authorized to add founders to this project"},403);const c=await e.env.DB.prepare(`
      INSERT INTO project_founders (project_id, user_id, name, email, role, equity_percentage, is_creator)
      VALUES (?, ?, ?, ?, ?, ?, 0)
    `).bind(t,l||null,s,o||null,n,i||null).run();return e.json({success:!0,id:c.meta.last_row_id,message:"Founder added successfully"})}catch(d){return console.error("Error adding founder:",d),e.json({error:"Failed to add founder"},500)}});Me.put("/:id/founders/:founderId",j,async e=>{const t=e.req.param("id"),r=e.req.param("founderId"),a=e.var.userId,s=await e.req.json(),{name:o,email:n,role:i,equity_percentage:l}=s;try{const d=await e.env.DB.prepare("SELECT user_id FROM projects WHERE id = ?").bind(t).first();return!d||d.user_id!==a?e.json({error:"Not authorized"},403):(await e.env.DB.prepare(`
      UPDATE project_founders
      SET name = ?, email = ?, role = ?, equity_percentage = ?
      WHERE id = ? AND project_id = ?
    `).bind(o,n,i,l,r,t).run(),e.json({success:!0,message:"Founder updated successfully"}))}catch(d){return console.error("Error updating founder:",d),e.json({error:"Failed to update founder"},500)}});Me.delete("/:id/founders/:founderId",j,async e=>{const t=e.req.param("id"),r=e.req.param("founderId"),a=e.var.userId;try{const s=await e.env.DB.prepare("SELECT user_id FROM projects WHERE id = ?").bind(t).first();if(!s||s.user_id!==a)return e.json({error:"Not authorized"},403);const o=await e.env.DB.prepare("SELECT is_creator FROM project_founders WHERE id = ? AND project_id = ?").bind(r,t).first();return(o==null?void 0:o.is_creator)===1?e.json({error:"Cannot delete project creator"},400):(await e.env.DB.prepare("DELETE FROM project_founders WHERE id = ? AND project_id = ?").bind(r,t).run(),e.json({success:!0,message:"Founder removed successfully"}))}catch(s){return console.error("Error deleting founder:",s),e.json({error:"Failed to delete founder"},500)}});async function Qo(e,t,r="openai/gpt-oss-120b",a=5e4){var s,o;try{const n=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:r,messages:e,temperature:.7,max_tokens:a,top_p:1,stream:!1})});if(!n.ok){const d=await n.text();throw console.error("Groq API error:",d),new Error(`Groq API failed: ${n.status} - ${d}`)}const l=((o=(s=(await n.json()).choices[0])==null?void 0:s.message)==null?void 0:o.content)||"";if(!l)throw new Error("Empty response from Groq API");return l}catch(n){throw console.error("Error calling Groq:",n),n}}async function Xo(e,t,r="openai/gpt-oss-120b",a=5e4,s=3){let o=null;for(let n=1;n<=s;n++)try{console.log(`🔄 Groq API attempt ${n}/${s}`);const i=await Qo(e,t,r,a);return console.log(`✅ Groq API succeeded on attempt ${n}`),i}catch(i){if(o=i,console.error(`❌ Groq API attempt ${n} failed:`,i),n<s){const l=Math.min(1e3*Math.pow(2,n-1),5e3);console.log(`⏳ Waiting ${l}ms before retry...`),await new Promise(d=>setTimeout(d,l))}}throw new Error(`Groq API failed after ${s} attempts: ${o==null?void 0:o.message}`)}async function Fu(e,t){const r=`Analyze this startup idea and provide detailed market insights:

Title: ${e.title}
Description: ${e.description}
Target Market: ${e.target_market}
Value Proposition: ${e.value_proposition}

Provide a comprehensive analysis with:
1. Top 5 real competitors (actual company names)
2. Top 5 current market trends
3. Top 5 key opportunities
4. Top 5 main threats
5. Estimated market size with sources
6. Estimated growth rate (CAGR)
7. Success probability (between 0 and 1)

IMPORTANT: Respond ONLY with valid JSON. Use this exact format:
{
  "competitors": ["Company 1", "Company 2", "Company 3", "Company 4", "Company 5"],
  "market_trends": ["Trend 1", "Trend 2", "Trend 3", "Trend 4", "Trend 5"],
  "opportunities": ["Opp 1", "Opp 2", "Opp 3", "Opp 4", "Opp 5"],
  "threats": ["Threat 1", "Threat 2", "Threat 3", "Threat 4", "Threat 5"],
  "market_size": "Detailed market size",
  "growth_rate": "X% CAGR",
  "success_probability": 0.75
}`,o=(await Qo([{role:"system",content:"You are an expert startup analyst with deep knowledge of markets, competitors, and trends. Always respond with valid JSON only, no markdown or explanations."},{role:"user",content:r}],t)).match(/\{[\s\S]*\}/);if(!o)throw new Error("No valid JSON found in response");return JSON.parse(o[0])}async function $u(e,t){const r=`Generate a detailed MVP specification for this startup:

Title: ${e.title}
Description: ${e.description}
Target Market: ${e.target_market}
Value Proposition: ${e.value_proposition}

Create a complete MVP specification with:
1. MVP name (creative and relevant)
2. Brief description (2-3 sentences explaining the MVP)
3. 6-8 core features (specific and actionable)
4. Recommended tech stack (5-7 modern technologies)
5. Estimated development time (realistic)
6. Estimated cost range (based on market rates)

IMPORTANT: Respond ONLY with valid JSON. Use this exact format:
{
  "name": "MVP Name",
  "description": "Detailed description of the MVP",
  "features": ["Feature 1", "Feature 2", "Feature 3", "Feature 4", "Feature 5", "Feature 6"],
  "tech_stack": ["Tech 1", "Tech 2", "Tech 3", "Tech 4", "Tech 5"],
  "estimated_time": "X-Y weeks",
  "estimated_cost": "$X,XXX - $Y,YYY"
}`,o=(await Qo([{role:"system",content:"You are a senior technical architect with expertise in MVP development and modern tech stacks. Always respond with valid JSON only, no markdown or explanations."},{role:"user",content:r}],t)).match(/\{[\s\S]*\}/);if(!o)throw new Error("No valid JSON found in response");return JSON.parse(o[0])}const ia=new ee;async function Hu(e,t){if(!t)return null;try{return await Fu(e,t)}catch(r){return console.error("Groq API error:",r),null}}async function Uu(e,t){if(!t)return null;try{const r=`Analyze this startup idea and provide market insights:

Title: ${e.title}
Description: ${e.description}
Target Market: ${e.target_market}
Value Proposition: ${e.value_proposition}

Please provide:
1. Top 5 competitors (just names)
2. Top 5 market trends
3. Top 5 opportunities
4. Top 5 threats
5. Estimated market size
6. Estimated growth rate
7. Success probability (0-1)

Format your response as JSON with these exact keys: competitors, market_trends, opportunities, threats, market_size, growth_rate, success_probability`,a=await t.run("@cf/meta/llama-3.1-8b-instruct",{messages:[{role:"system",content:"You are a startup validation expert. Always respond with valid JSON."},{role:"user",content:r}],max_tokens:2e3}),s=a.response||JSON.stringify(a),o=s.match(/```json\n?([\s\S]*?)\n?```/)||s.match(/\{[\s\S]*\}/),n=o?o[1]||o[0]:s;return JSON.parse(n)}catch(r){return console.error("Cloudflare AI error:",r),null}}function Gu(e){const t=`${e.title} ${e.description} ${e.target_market}`.toLowerCase(),r=t.includes("health")||t.includes("medical")||t.includes("salud"),a=t.includes("fintech")||t.includes("financial")||t.includes("payment"),s=t.includes("saas")||t.includes("software")||t.includes("platform"),o=t.includes("ecommerce")||t.includes("marketplace")||t.includes("shop"),n=t.includes("ai")||t.includes("inteligencia")||t.includes("machine learning");let i={competitors:[],market_trends:[],opportunities:[],threats:[],market_size:"",growth_rate:"",success_probability:.65};return r?i={competitors:["Teladoc Health","Amwell","Doctor on Demand","HealthTap","MDLive"],market_trends:["Telemedicina creciendo 38% anual post-COVID","IA en diagnósticos alcanza $36B en 2025","Regulaciones favorables para salud digital","Wearables integrados con plataformas médicas","Adopción masiva de historiales clínicos digitales"],opportunities:["Mercado LATAM menos saturado que USA","Necesidad de soluciones en español","Partnerships con aseguradoras y hospitales","Integración con sistemas de salud existentes","Prevención vs tratamiento es tendencia"],threats:["Competidores con más funding (Series C+)","Regulaciones estrictas de datos médicos (HIPAA)","Resistencia de médicos tradicionales","Necesidad de certificaciones médicas","Responsabilidad legal en diagnósticos"],market_size:"$254B mercado global de HealthTech para 2027",growth_rate:"37% CAGR",success_probability:.73}:a?i={competitors:["Stripe","Square","PayPal","Revolut","Wise"],market_trends:["Pagos digitales crecen 20% anual","Open Banking revoluciona servicios financieros","Crypto y blockchain mainstream","Buy Now Pay Later (BNPL) en auge","Banking as a Service (BaaS) democratiza finanzas"],opportunities:["Underbanked populations en LATAM","Remesas internacionales caras y lentas","SMBs necesitan mejores herramientas financieras","Millennials prefieren apps vs bancos","Regulación favorable (PSD2, Open Banking)"],threats:["Regulaciones financieras complejas","Bancos tradicionales digitalizándose","Ciberseguridad es crítica","Alto costo de adquisición de usuarios","Necesidad de licencias bancarias"],market_size:"$305B mercado global de FinTech para 2025",growth_rate:"23% CAGR",success_probability:.68}:s?i={competitors:["Salesforce","HubSpot","Monday.com","Notion","Airtable"],market_trends:["SaaS alcanza $195B en 2023","Shift hacia vertical SaaS especializado","AI-powered features son must-have","Product-Led Growth (PLG) domina","Multi-cloud y APIs abiertas"],opportunities:["Nichos verticales sin soluciones específicas","Integraciones y APIs demandadas","Freemium funciona para user acquisition","Remote work impulsa herramientas colaborativas","Menor costo de infraestructura (cloud)"],threats:["Saturación de mercado en categorías populares","Giants pueden copiar features rápido","Churn alto si no hay product-market fit","Customer acquisition cost (CAC) alto","Necesidad de escalabilidad técnica"],market_size:"$232B mercado SaaS global para 2024",growth_rate:"18% CAGR",success_probability:.71}:o?i={competitors:["Shopify","WooCommerce","Amazon","MercadoLibre","Etsy"],market_trends:["E-commerce crece 14% anual globalmente","Social commerce (TikTok, Instagram)","Headless commerce arquitectures","Sustainability en packaging y shipping","AR/VR para try-before-buy"],opportunities:["D2C brands evitan intermediarios","Micro-influencers marketing","Nicho específico vs generalista","Suscripciones y recurring revenue","Cross-border commerce facilitado"],threats:["Amazon dominance en muchas categorías","Logística y fulfillment complejo","Márgenes bajos en productos físicos","Retornos y customer service costoso","Competencia en precio es brutal"],market_size:"$5.5T ventas e-commerce globales en 2024",growth_rate:"14% CAGR",success_probability:.64}:n?i={competitors:["OpenAI","Anthropic","Google AI","Hugging Face","Cohere"],market_trends:["IA generativa crece 80% anual","LLMs open source democratizan acceso","AI agents y automatización","Edge AI y on-device processing","Multimodal AI (texto, imagen, audio)"],opportunities:["Aplicaciones específicas de industria","Fine-tuning para casos de uso nicho","AI tooling y infrastructure","Privacidad y data sovereignty","Vertical AI solutions para empresas"],threats:["Big Tech domina investigación","Costos de compute altos","Regulaciones AI emergentes","Talent war por AI engineers","Cambios rápidos en tecnología"],market_size:"$184B mercado de AI para 2024",growth_rate:"37% CAGR",success_probability:.78}:i={competitors:["Competidor A (líder)","Competidor B (innovador)","Competidor C (low-cost)","Startup emergente D","Player tradicional E"],market_trends:["Digitalización acelerada post-pandemia","Consumidores demandan experiencias personalizadas","Sostenibilidad es factor de decisión","Mobile-first es el estándar","Automatización reduce costos operativos"],opportunities:["Mercado fragmentado con espacio para nuevos players","Tecnología permite diferenciación","Cambio de comportamiento del consumidor","Posibilidad de partnerships estratégicos","Funding disponible para ideas validadas"],threats:["Competencia de incumbents establecidos","Barreras de entrada en distribución","Ciclos económicos afectan demanda","Necesidad de capital para escalar","Cambios regulatorios pueden impactar"],market_size:"$1B+ mercado potencial",growth_rate:"15-25% CAGR estimado",success_probability:.65},e.value_proposition.length>100&&(i.success_probability+=.05),(e.target_market.toLowerCase().includes("latam")||e.target_market.toLowerCase().includes("europa"))&&(i.success_probability+=.03),i.success_probability=Math.min(i.success_probability,.92),i}ia.post("/analyze",async e=>{const{projectId:t}=await e.req.json(),r=await e.env.DB.prepare("SELECT * FROM projects WHERE id = ?").bind(t).first();if(!r)return e.json({error:"Project not found"},404);await e.env.DB.prepare("UPDATE projects SET status = ? WHERE id = ?").bind("analyzing",t).run();try{let a=await Hu(r,e.env.GROQ_API_KEY);return!a&&e.env.AI&&(a=await Uu(r,e.env.AI)),a||(a=Gu(r)),await e.env.DB.prepare(`
      INSERT INTO market_analysis 
      (project_id, competitors, market_trends, opportunities, threats, market_size, growth_rate, success_probability)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(t,JSON.stringify(a.competitors||[]),JSON.stringify(a.market_trends||[]),JSON.stringify(a.opportunities||[]),JSON.stringify(a.threats||[]),a.market_size||"Unknown",a.growth_rate||"Unknown",a.success_probability||.5).run(),await e.env.DB.prepare("UPDATE projects SET status = ? WHERE id = ?").bind("validated",t).run(),e.json({message:"Analysis completed",analysis:a})}catch(a){return console.error("Analysis error:",a),await e.env.DB.prepare("UPDATE projects SET status = ? WHERE id = ?").bind("failed",t).run(),e.json({error:"Analysis failed",details:a instanceof Error?a.message:"Unknown error"},500)}});ia.post("/generate-mvp",async e=>{const{projectId:t}=await e.req.json(),r=await e.env.DB.prepare("SELECT * FROM projects WHERE id = ?").bind(t).first();if(!r)return e.json({error:"Project not found"},404);try{let a;if(e.env.GROQ_API_KEY)try{a=await $u(r,e.env.GROQ_API_KEY)}catch(s){console.error("Groq MVP generation failed:",s)}return a||(a={name:`${r.title} MVP v1.0`,description:"A functional prototype with core features to validate the product-market fit.",features:["User authentication and profiles","Core functionality dashboard","Data visualization","Mobile-responsive design","API integration","Analytics tracking"],tech_stack:["React","Node.js","PostgreSQL","Cloudflare Workers","Tailwind CSS"],estimated_time:"8-12 weeks",estimated_cost:"$35,000 - $50,000"}),await e.env.DB.prepare(`
      INSERT INTO mvp_prototypes 
      (project_id, name, description, features, tech_stack, estimated_time, estimated_cost)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(t,a.name,a.description,JSON.stringify(a.features||[]),JSON.stringify(a.tech_stack||[]),a.estimated_time||"8-12 weeks",a.estimated_cost||"$35,000 - $50,000").run(),e.json({message:"MVP generated",mvp:a})}catch(a){return console.error("MVP generation error:",a),e.json({error:"MVP generation failed",details:a instanceof Error?a.message:"Unknown error"},500)}});ia.post("/generate-growth",async e=>{const{projectId:t}=await e.req.json();if(!await e.env.DB.prepare("SELECT * FROM projects WHERE id = ?").bind(t).first())return e.json({error:"Project not found"},404);const a=[{strategy_type:"PLG",title:"Product-Led Growth con Freemium",description:"Ofrecer versión gratuita con funcionalidades limitadas para atraer usuarios y convertirlos a planes premium",channels:["Product virality","In-app referrals","Free tier"],estimated_cac:"$50-$120",estimated_ltv:"$1,200-$3,000",priority:"high"},{strategy_type:"Content",title:"Content Marketing & SEO",description:"Crear contenido educativo de alto valor optimizado para SEO para atraer tráfico orgánico cualificado",channels:["SEO blog","LinkedIn articles","Industry webinars"],estimated_cac:"$80-$200",estimated_ltv:"$1,200-$3,000",priority:"high"},{strategy_type:"Partnerships",title:"Alianzas Estratégicas B2B",description:"Establecer partnerships con empresas complementarias para acceder a su base de clientes",channels:["B2B partnerships","Co-marketing","Integration marketplace"],estimated_cac:"$300-$600",estimated_ltv:"$3,000-$8,000",priority:"medium"},{strategy_type:"Referral",title:"Programa de Referidos",description:"Implementar sistema de referidos con incentivos duales para maximizar crecimiento viral",channels:["Referral program","Email marketing","Social sharing"],estimated_cac:"$40-$100",estimated_ltv:"$1,200-$3,000",priority:"high"}];for(const s of a)await e.env.DB.prepare(`
      INSERT INTO growth_strategies 
      (project_id, strategy_type, title, description, channels, estimated_cac, estimated_ltv, priority)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(t,s.strategy_type,s.title,s.description,JSON.stringify(s.channels),s.estimated_cac,s.estimated_ltv,s.priority).run();return e.json({message:"Growth strategies generated",strategies:a})});ia.get("/validators",async e=>{var r;console.log("[VALIDATION] Getting validators list");const t=e.env.DB;try{if(!await t.prepare(`
      SELECT name FROM sqlite_master WHERE type='table' AND name='validators'
    `).first())return console.log("[VALIDATION] Validators table does not exist yet"),e.json([]);const s=await t.prepare(`
      SELECT 
        v.id,
        v.user_id,
        v.title,
        v.expertise,
        v.bio,
        v.rating,
        v.total_validations,
        v.response_rate,
        v.avg_response_time,
        v.available,
        v.hourly_rate,
        u.name,
        u.email,
        u.avatar_url,
        u.created_at
      FROM validators v
      JOIN users u ON v.user_id = u.id
      WHERE v.available = 1
      ORDER BY v.rating DESC, v.total_validations DESC
    `).all();return console.log("[VALIDATION] Found validators:",((r=s.results)==null?void 0:r.length)||0),e.json(s.results||[])}catch(a){return console.error("[VALIDATION] Error fetching validators:",a),e.json([])}});const Za=new ee;Za.get("/",async e=>{try{const{results:t}=await e.env.DB.prepare("SELECT * FROM beta_users WHERE available = 1 ORDER BY rating DESC LIMIT 50").all();return e.json({betaUsers:t})}catch{return e.json({error:"Internal server error"},500)}});Za.get("/:id",async e=>{const t=e.req.param("id"),r=await e.env.DB.prepare("SELECT * FROM beta_users WHERE id = ?").bind(t).first();return r?e.json({user:r}):e.json({error:"User not found"},404)});Za.post("/feedback",async e=>{const{projectId:t,betaUserId:r,rating:a,feedback:s,wouldPay:o,suggestedPrice:n}=await e.req.json(),i=await e.env.DB.prepare(`
    INSERT INTO test_results (project_id, beta_user_id, rating, feedback, would_pay, suggested_price)
    VALUES (?, ?, ?, ?, ?, ?)
  `).bind(t,r,a,s,o?1:0,n).run();return e.json({id:i.meta.last_row_id,message:"Feedback submitted successfully"})});async function Wu(e,t,r,a){console.log("🤖 Starting PURE Groq AI MVP generation"),console.log("📋 Project:",e.title),console.log("✨ Features:",t.features);const s=await qu(e,t,r,a);return console.log("✅ MVP generation completed!"),console.log("📁 Files generated:",Object.keys(s)),s}async function qu(e,t,r,a){console.log("📝 Generating files separately for better reliability...");const s={};console.log("1️⃣ Generating database schema...");const o=await Vu(e,t,a);Object.assign(s,o),console.log("2️⃣ Generating backend code...");const n=await zu(e,t,r,a);Object.assign(s,n),console.log("3️⃣ Generating frontend code...");const i=await Ju(e,t,a);Object.assign(s,i),console.log("4️⃣ Generating config files...");const l=Yu(e,t);return Object.assign(s,l),s}async function Vu(e,t,r){const a=`Generate COMPLETE SQLite database schema for: ${e.title}

FEATURES: ${t.features.join(", ")}

Create SQL with:
1. Tables for ALL features (minimum 4 tables)
2. Proper relationships and foreign keys
3. Indexes for performance
4. Sample data (at least 5 rows per table)

DO NOT wrap in JSON. Just output the complete SQL code.
Start with: -- Database schema for ${e.title}`;let n=(await Xo([{role:"system",content:"You generate complete database schemas. Output only SQL code, no JSON, no markdown, no explanations."},{role:"user",content:a}],r,"openai/gpt-oss-120b",5e4,3)).trim();return n.startsWith("```")&&(n=n.replace(/```sql\n?/g,"").replace(/```\n?/g,"")),{"migrations/0001_initial.sql":n}}async function zu(e,t,r,a){e.title.toLowerCase().replace(/\s+/g,"-");const s=`Generate COMPLETE Hono backend TypeScript code for: ${e.title}

FEATURES TO IMPLEMENT:
${t.features.map((l,d)=>`${d+1}. ${l}`).join(`
`)}

Requirements for src/index.tsx:
- Import Hono and create app
- Type: type Bindings = { DB: D1Database }
- API endpoint for EACH feature (minimum 6 endpoints)
- Complete HTML page with Tailwind CSS
- Sections for each feature with interactive elements
- 500+ lines of complete code

DO NOT wrap in JSON. Just output the complete TypeScript code directly.
Start with: import { Hono } from 'hono';`;let i=(await Xo([{role:"system",content:"You are a senior backend engineer. Generate complete, working Hono code. Output only the code, no JSON, no markdown blocks, no explanations."},{role:"user",content:s}],a,"openai/gpt-oss-120b",5e4,3)).trim();return i.startsWith("```")&&(i=i.replace(/```typescript\n?/g,"").replace(/```\n?/g,"")),{"src/index.tsx":i}}async function Ju(e,t,r){const a=`Generate frontend JavaScript for: ${e.title}

FEATURES: ${t.features.join(", ")}

Create app.js with:
- Function for EACH feature
- API calls using axios
- Event handlers
- State management
- 300+ lines of functional code

DO NOT wrap in JSON. Just output the complete JavaScript code.
Start with: // ${e.title} - Frontend Application`;let n=(await Xo([{role:"system",content:"You generate complete frontend JavaScript. Output only code, no JSON, no markdown, no explanations."},{role:"user",content:a}],r,"openai/gpt-oss-120b",5e4,3)).trim();n.startsWith("```")&&(n=n.replace(/```javascript\n?/g,"").replace(/```\n?/g,""));const i=`/* Custom styles for ${e.title} */
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.card {
  background: white;
  border-radius: 0.75rem;
  padding: 2rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
}

button {
  transition: all 0.2s ease;
}

button:active {
  transform: scale(0.98);
}`;return{"public/static/app.js":n,"public/static/styles.css":i}}function Yu(e,t){const r=e.title.toLowerCase().replace(/\s+/g,"-");return{"package.json":JSON.stringify({name:r,version:"1.0.0",type:"module",scripts:{dev:"vite",build:"vite build",deploy:"npm run build && wrangler pages deploy dist","db:migrate":`wrangler d1 migrations apply ${r}-db --local`},dependencies:{hono:"^4.10.1"},devDependencies:{"@cloudflare/workers-types":"4.20250705.0","@hono/vite-cloudflare-pages":"^0.4.2",vite:"^5.0.0",wrangler:"^3.78.0",typescript:"^5.0.0"}},null,2),"wrangler.jsonc":JSON.stringify({name:r,compatibility_date:"2024-01-01",pages_build_output_dir:"./dist",compatibility_flags:["nodejs_compat"],d1_databases:[{binding:"DB",database_name:`${r}-db`,database_id:"your-database-id-here"}]},null,2),"vite.config.ts":`import { defineConfig } from 'vite';
import pages from '@hono/vite-cloudflare-pages';

export default defineConfig({
  plugins: [pages()],
  build: {
    outDir: 'dist'
  }
});`,"tsconfig.json":JSON.stringify({compilerOptions:{target:"ES2020",module:"ESNext",lib:["ES2020"],jsx:"react-jsx",jsxImportSource:"hono/jsx",moduleResolution:"bundler",types:["@cloudflare/workers-types"]}},null,2),"README.md":`# ${e.title}

${e.description}

## Features

${t.features.map((a,s)=>`${s+1}. ${a}`).join(`
`)}

## Setup

\`\`\`bash
npm install
npx wrangler d1 create ${r}-db
# Update database_id in wrangler.jsonc
npm run db:migrate
npm run dev
\`\`\`

## Deploy

\`\`\`bash
npm run deploy
\`\`\`

---
Generated by ValidAI Studio
`}}const Zo=new ee;Zo.post("/generate-full",async e=>{try{const t=await e.req.json(),{projectId:r}=t;if(!r)return e.json({error:"projectId es requerido"},400);const a=await e.env.DB.prepare("SELECT * FROM projects WHERE id = ?").bind(r).first();if(!a)return e.json({error:"Proyecto no encontrado"},404);const s=await e.env.DB.prepare("SELECT * FROM mvp_prototypes WHERE project_id = ?").bind(r).first();if(!s)return e.json({error:"Prototipo MVP no encontrado"},404);const o=await e.env.DB.prepare("SELECT * FROM market_analysis WHERE project_id = ?").bind(r).first();let n=[],i=[];try{n=JSON.parse(s.features),i=JSON.parse(s.tech_stack)}catch{return e.json({error:"Error parsing MVP features"},500)}let l={competitors:[],market_trends:[],opportunities:[],threats:[],market_size:"Unknown",growth_rate:"Unknown"};if(o)try{l={competitors:JSON.parse(o.competitors||"[]"),market_trends:JSON.parse(o.market_trends||"[]"),opportunities:JSON.parse(o.opportunities||"[]"),threats:JSON.parse(o.threats||"[]"),market_size:o.market_size||"Unknown",growth_rate:o.growth_rate||"Unknown"}}catch{}if(!e.env.GROQ_API_KEY)return e.json({error:"Configuración de IA no disponible"},500);const d=await Wu({id:a.id,title:a.title,description:a.description,target_market:a.target_market,value_proposition:a.value_proposition},{name:s.name,description:s.description,features:n,tech_stack:i,estimated_time:s.estimated_time,estimated_cost:s.estimated_cost},l,e.env.GROQ_API_KEY);console.log("✅ MVP generated! Files:",Object.keys(d));const c=JSON.stringify(d);await e.env.DB.prepare(`
      UPDATE mvp_prototypes 
      SET wireframe_url = ?
      WHERE project_id = ?
    `).bind(c,r).run();const u={status:"ready",files:Object.keys(d),features:n,generated_at:new Date().toISOString()};let p=null;try{const m=await e.env.DB.prepare("SELECT user_id FROM projects WHERE id = ?").bind(r).first();if(m&&m.user_id){const g=m.user_id;p=(await e.env.DB.prepare(`
          INSERT INTO beta_products (
            company_user_id, title, description, category, stage,
            looking_for, compensation_type, compensation_amount,
            duration_days, validators_needed, status
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(g,a.title,`${a.description}

✨ MVP generado automáticamente usando IA`,"MVP Generated","mvp","Validación de MVP generado por IA","free",0,30,3,"active").run()).meta.last_row_id,console.log(`✅ Marketplace product created: ${p}`)}}catch(m){console.error("Error creating marketplace product:",m)}return e.json({message:"MVP personalizado generado exitosamente",files:d,deployment:u,features_implemented:n,marketplace_product_id:p,marketplace_url:p?`/marketplace?product=${p}`:null,next_steps:["Descargar archivos generados","Ejecutar: npm install","Crear base de datos D1","Ejecutar: npm run db:migrate","Ejecutar: npm run dev","Desplegar a Cloudflare Pages",...p?["🌟 Tu producto ya está en el marketplace para validación"]:[]]})}catch(t){return console.error("Error generando MVP:",t),e.json({error:"Error al generar MVP",details:t instanceof Error?t.message:"Unknown error"},500)}});Zo.get("/download/:projectId",async e=>{const t=e.req.param("projectId"),r=await e.env.DB.prepare("SELECT * FROM mvp_prototypes WHERE project_id = ?").bind(t).first();if(!r||!r.wireframe_url)return e.json({error:"No hay código generado para este proyecto"},404);try{const a=JSON.parse(r.wireframe_url);return e.json({message:"Código disponible para descarga",files:a,instructions:"Crea una carpeta nueva y copia estos archivos"})}catch{return e.json({error:"Error al obtener archivos"},500)}});const es=new ee;es.get("/preview/:projectId",async e=>{const t=e.req.param("projectId");try{const r=await e.env.DB.prepare("SELECT * FROM mvp_prototypes WHERE project_id = ? ORDER BY created_at DESC LIMIT 1").bind(t).first();if(!r||!r.wireframe_url)return e.html(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Preview no disponible</title>
          <script src="https://cdn.tailwindcss.com"><\/script>
        </head>
        <body class="bg-gray-100 flex items-center justify-center min-h-screen">
          <div class="bg-white rounded-xl shadow-lg p-8 max-w-md text-center">
            <i class="fas fa-exclamation-circle text-red-500 text-6xl mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-900 mb-4">Preview no disponible</h1>
            <p class="text-gray-600 mb-6">No hay código generado para este proyecto.</p>
            <a href="/project/${t}" class="bg-primary text-white px-6 py-3 rounded-lg inline-block">
              Volver al proyecto
            </a>
          </div>
        </body>
        </html>
      `);let a={};try{a=JSON.parse(r.wireframe_url)}catch(n){console.error("Error parsing MVP files:",n)}const s=a["src/index.tsx"]||a["index.html"]||"";let o="";if(s.includes("c.html")){const n=s.match(/c\.html\(`([\s\S]*?)`\)/);n&&(o=n[1])}else o=s;if(!o){const n=await e.env.DB.prepare("SELECT * FROM projects WHERE id = ?").bind(t).first();o=`
        <!DOCTYPE html>
        <html lang="es">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${(n==null?void 0:n.title)||"MVP Preview"}</title>
          <script src="https://cdn.tailwindcss.com"><\/script>
          <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        </head>
        <body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
          <div class="max-w-7xl mx-auto px-4 py-16">
            <div class="text-center mb-12">
              <div class="inline-block bg-white rounded-full p-6 shadow-lg mb-6">
                <i class="fas fa-rocket text-6xl text-primary"></i>
              </div>
              <h1 class="text-5xl font-bold text-gray-900 mb-4">${(n==null?void 0:n.title)||"MVP Preview"}</h1>
              <p class="text-xl text-gray-600 max-w-2xl mx-auto">${(n==null?void 0:n.description)||"Vista previa del MVP generado"}</p>
            </div>
            
            <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
              <h2 class="text-3xl font-bold text-gray-900 mb-6">🎯 Propuesta de Valor</h2>
              <p class="text-lg text-gray-700 mb-8">${(n==null?void 0:n.value_proposition)||"Solución innovadora para tu mercado"}</p>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="text-center p-6 bg-blue-50 rounded-xl">
                  <i class="fas fa-users text-4xl text-blue-600 mb-4"></i>
                  <h3 class="font-bold text-gray-900 mb-2">Mercado Objetivo</h3>
                  <p class="text-gray-600">${(n==null?void 0:n.target_market)||"Usuarios específicos"}</p>
                </div>
                <div class="text-center p-6 bg-purple-50 rounded-xl">
                  <i class="fas fa-chart-line text-4xl text-purple-600 mb-4"></i>
                  <h3 class="font-bold text-gray-900 mb-2">Escalable</h3>
                  <p class="text-gray-600">Diseñado para crecer rápidamente</p>
                </div>
                <div class="text-center p-6 bg-green-50 rounded-xl">
                  <i class="fas fa-check-circle text-4xl text-green-600 mb-4"></i>
                  <h3 class="font-bold text-gray-900 mb-2">Validado</h3>
                  <p class="text-gray-600">Con análisis de mercado real</p>
                </div>
              </div>
              
              <div class="text-center">
                <button class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-lg text-lg font-semibold hover:opacity-90 transition transform hover:scale-105">
                  <i class="fas fa-rocket mr-2"></i>Comenzar Ahora
                </button>
              </div>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-6">
              <div class="flex items-start">
                <i class="fas fa-info-circle text-yellow-600 text-2xl mr-4 mt-1"></i>
                <div>
                  <h3 class="font-bold text-gray-900 mb-2">Vista Previa Simplificada</h3>
                  <p class="text-gray-700">Este es un preview básico del MVP. El código completo incluye backend con API, base de datos, autenticación y mucho más. Descarga el código o despliega a Cloudflare Pages para ver la versión completa.</p>
                </div>
              </div>
            </div>
          </div>
        </body>
        </html>
      `}return e.html(o)}catch(r){return console.error("Error loading preview:",r),e.html(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Error</title>
        <script src="https://cdn.tailwindcss.com"><\/script>
      </head>
      <body class="bg-gray-100 flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-md text-center">
          <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
          <h1 class="text-2xl font-bold text-gray-900 mb-4">Error al cargar preview</h1>
          <p class="text-gray-600 mb-6">${r instanceof Error?r.message:"Error desconocido"}</p>
          <a href="/project/${t}" class="bg-primary text-white px-6 py-3 rounded-lg inline-block">
            Volver al proyecto
          </a>
        </div>
      </body>
      </html>
    `)}});es.post("/cloudflare/:projectId",async e=>{const t=e.req.param("projectId"),{projectName:r}=await e.req.json();try{const a=await e.env.DB.prepare("SELECT * FROM mvp_prototypes WHERE project_id = ? ORDER BY created_at DESC LIMIT 1").bind(t).first();if(!a||!a.wireframe_url)return e.json({error:"No hay código generado para desplegar"},404);const s=JSON.parse(a.wireframe_url),o=await e.env.DB.prepare("SELECT * FROM projects WHERE id = ?").bind(t).first(),n=r||(o==null?void 0:o.title).toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,""),i={message:"MVP listo para deployment",instructions:['1. Descarga el código generado usando el botón "Descargar Código"',"2. Extrae los archivos en una carpeta local","3. Abre la terminal en esa carpeta","4. Ejecuta: npm install","5. Ejecuta: npm run build",`6. Ejecuta: npx wrangler pages deploy dist --project-name ${n}`,"7. ¡Tu MVP estará en vivo en Cloudflare Pages!"],commands:["npm install","npm run build",`npx wrangler pages deploy dist --project-name ${n}`],projectName:n,estimatedUrl:`https://${n}.pages.dev`,files:Object.keys(s),githubOption:{title:"Opción alternativa: Deploy via GitHub",steps:["1. Crea un nuevo repositorio en GitHub","2. Sube los archivos descargados","3. Conecta el repo a Cloudflare Pages desde el dashboard","4. Cloudflare Pages desplegará automáticamente"]}};return e.json(i)}catch(a){return console.error("Deployment preparation error:",a),e.json({error:"Error preparando deployment",details:a instanceof Error?a.message:"Unknown error"},500)}});es.get("/status/:projectId",async e=>{const t=e.req.param("projectId"),r=await e.env.DB.prepare("SELECT * FROM mvp_prototypes WHERE project_id = ?").bind(t).first();if(!r)return e.json({status:"not_generated",message:"MVP no generado todavía"});const a=r.wireframe_url&&r.wireframe_url!=="";return e.json({status:a?"ready_to_deploy":"generating",message:a?"MVP listo para desplegar":"Generando código...",preview_url:`/api/deploy/preview/${t}`,has_code:a,created_at:r.created_at})});const Fe=new ee;Fe.get("/",async e=>{try{const{results:t}=await e.env.DB.prepare(`
      SELECT 
        id, name, display_name, description, 
        price_monthly, price_yearly, 
        validators_limit, products_limit, 
        features, display_order, category,
        stripe_product_id, stripe_price_id_monthly, stripe_price_id_yearly
      FROM pricing_plans
      WHERE is_active = 1
        AND stripe_product_id IS NOT NULL
        AND stripe_product_id != ''
        AND stripe_price_id_monthly IS NOT NULL
        AND stripe_price_id_monthly != ''
      ORDER BY display_order ASC
    `).all();return e.json({plans:t})}catch(t){return console.error("Error fetching plans:",t),e.json({error:"Internal server error"},500)}});Fe.get("/:id",async e=>{const t=e.req.param("id"),r=await e.env.DB.prepare(`
    SELECT 
      id, name, display_name, description, 
      price_monthly, price_yearly, 
      validators_limit, products_limit, 
      features, display_order, category
    FROM pricing_plans
    WHERE id = ? AND is_active = 1
  `).bind(t).first();return r?e.json({plan:r}):e.json({error:"Plan not found"},404)});Fe.get("/my/current",j,async e=>{const t=e.get("userId"),r=await e.env.DB.prepare(`
    SELECT 
      u.id as user_id,
      u.plan_id,
      u.plan_status,
      u.plan_started_at,
      u.plan_expires_at,
      u.billing_cycle,
      u.validators_used,
      u.products_count,
      p.name as plan_name,
      p.display_name as plan_display_name,
      p.description as plan_description,
      p.price_monthly,
      p.price_yearly,
      p.validators_limit,
      p.products_limit,
      p.features
    FROM users u
    JOIN pricing_plans p ON u.plan_id = p.id
    WHERE u.id = ?
  `).bind(t).first();if(!r)return e.json({error:"User not found"},404);const a=r.validators_limit===-1?0:Math.round(r.validators_used/r.validators_limit*100),s=r.products_limit===-1?0:Math.round(r.products_count/r.products_limit*100);return e.json({user_plan:r,usage:{validators:{used:r.validators_used,limit:r.validators_limit,percentage:a,is_unlimited:r.validators_limit===-1},products:{used:r.products_count,limit:r.products_limit,percentage:s,is_unlimited:r.products_limit===-1}}})});Fe.get("/my/check-limit",j,async e=>{const t=e.get("userId"),{action:r,amount:a="1"}=e.req.query();if(!r||!["validators","products"].includes(r))return e.json({error:'Invalid action. Use "validators" or "products"'},400);const s=parseInt(a),o=await e.env.DB.prepare(`
    SELECT 
      u.validators_used,
      u.products_count,
      p.validators_limit,
      p.products_limit
    FROM users u
    JOIN pricing_plans p ON u.plan_id = p.id
    WHERE u.id = ?
  `).bind(t).first();if(!o)return e.json({error:"User not found"},404);let n=!1,i=0,l=0,d=0;return r==="validators"?(l=o.validators_limit,i=o.validators_used,d=l===-1?-1:l-i,n=l===-1||i+s<=l):r==="products"&&(l=o.products_limit,i=o.products_count,d=l===-1?-1:l-i,n=l===-1||i+s<=l),e.json({can_proceed:n,action:r,current_usage:i,limit:l,remaining:d,requested_amount:s,is_unlimited:l===-1})});Fe.get("/my/history",j,async e=>{const t=e.get("userId"),{results:r}=await e.env.DB.prepare(`
    SELECT 
      ph.*,
      p.display_name as plan_name,
      prev_p.display_name as previous_plan_name
    FROM plan_usage_history ph
    JOIN pricing_plans p ON ph.plan_id = p.id
    LEFT JOIN pricing_plans prev_p ON ph.previous_plan_id = prev_p.id
    WHERE ph.user_id = ?
    ORDER BY ph.created_at DESC
  `).bind(t).all();return e.json({history:r})});Fe.post("/my/upgrade-request",j,async e=>{const t=e.get("userId"),{requested_plan_id:r,reason:a}=await e.req.json();if(!r)return e.json({error:"requested_plan_id is required"},400);const s=await e.env.DB.prepare("SELECT plan_id FROM users WHERE id = ?").bind(t).first();if(!s)return e.json({error:"User not found"},404);if(!await e.env.DB.prepare("SELECT id FROM pricing_plans WHERE id = ? AND is_active = 1").bind(r).first())return e.json({error:"Invalid plan ID"},400);if(await e.env.DB.prepare(`
    SELECT id FROM plan_upgrade_requests 
    WHERE user_id = ? AND status = 'pending'
  `).bind(t).first())return e.json({error:"You already have a pending upgrade request"},400);const i=await e.env.DB.prepare(`
    INSERT INTO plan_upgrade_requests (
      user_id, current_plan_id, requested_plan_id, reason, status
    ) VALUES (?, ?, ?, ?, 'pending')
  `).bind(t,s.plan_id,r,a||null).run();return e.json({id:i.meta.last_row_id,message:"Upgrade request submitted successfully. Our team will review it shortly."})});Fe.get("/my/upgrade-requests",j,async e=>{const t=e.get("userId"),{results:r}=await e.env.DB.prepare(`
    SELECT 
      ur.*,
      cp.display_name as current_plan_name,
      rp.display_name as requested_plan_name,
      reviewer.name as reviewer_name
    FROM plan_upgrade_requests ur
    JOIN pricing_plans cp ON ur.current_plan_id = cp.id
    JOIN pricing_plans rp ON ur.requested_plan_id = rp.id
    LEFT JOIN users reviewer ON ur.reviewed_by = reviewer.id
    WHERE ur.user_id = ?
    ORDER BY ur.created_at DESC
  `).bind(t).all();return e.json({requests:r})});Fe.get("/admin/upgrade-requests",j,Xa("admin"),async e=>{const{status:t="pending"}=e.req.query();let r=`
    SELECT 
      ur.*,
      u.name as user_name,
      u.email as user_email,
      cp.display_name as current_plan_name,
      rp.display_name as requested_plan_name,
      reviewer.name as reviewer_name
    FROM plan_upgrade_requests ur
    JOIN users u ON ur.user_id = u.id
    JOIN pricing_plans cp ON ur.current_plan_id = cp.id
    JOIN pricing_plans rp ON ur.requested_plan_id = rp.id
    LEFT JOIN users reviewer ON ur.reviewed_by = reviewer.id
  `;const a=[];t&&(r+=" WHERE ur.status = ?",a.push(t)),r+=" ORDER BY ur.created_at DESC";const{results:s}=await e.env.DB.prepare(r).bind(...a).all();return e.json({requests:s})});Fe.post("/admin/upgrade-requests/:id/review",j,Xa("admin"),async e=>{const t=e.get("userId"),r=e.req.param("id"),{action:a,note:s}=await e.req.json();if(!a||!["approve","reject"].includes(a))return e.json({error:'Invalid action. Use "approve" or "reject"'},400);const o=await e.env.DB.prepare(`
    SELECT * FROM plan_upgrade_requests WHERE id = ?
  `).bind(r).first();if(!o)return e.json({error:"Request not found"},404);if(o.status!=="pending")return e.json({error:"Request already reviewed"},400);const n=a==="approve"?"approved":"rejected";return await e.env.DB.prepare(`
    UPDATE plan_upgrade_requests 
    SET status = ?, reviewed_by = ?, reviewed_at = CURRENT_TIMESTAMP
    WHERE id = ?
  `).bind(n,t,r).run(),a==="approve"&&(await e.env.DB.prepare(`
      UPDATE users 
      SET 
        plan_id = ?,
        plan_started_at = CURRENT_TIMESTAMP,
        plan_expires_at = datetime(CURRENT_TIMESTAMP, '+30 days')
      WHERE id = ?
    `).bind(o.requested_plan_id,o.user_id).run(),await e.env.DB.prepare(`
      INSERT INTO plan_usage_history (
        user_id, plan_id, previous_plan_id, action, started_at, expires_at
      ) VALUES (?, ?, ?, 'upgrade', CURRENT_TIMESTAMP, datetime(CURRENT_TIMESTAMP, '+30 days'))
    `).bind(o.user_id,o.requested_plan_id,o.current_plan_id).run()),e.json({message:`Request ${n} successfully`,status:n})});Fe.post("/admin/users/:userId/change-plan",j,Xa("admin"),async e=>{const t=e.req.param("userId"),{plan_id:r,billing_cycle:a="monthly",duration_days:s=30}=await e.req.json();if(!r)return e.json({error:"plan_id is required"},400);if(!await e.env.DB.prepare("SELECT id FROM pricing_plans WHERE id = ? AND is_active = 1").bind(r).first())return e.json({error:"Invalid plan ID"},400);const n=await e.env.DB.prepare("SELECT plan_id FROM users WHERE id = ?").bind(t).first();return n?(await e.env.DB.prepare(`
    UPDATE users 
    SET 
      plan_id = ?,
      billing_cycle = ?,
      plan_started_at = CURRENT_TIMESTAMP,
      plan_expires_at = datetime(CURRENT_TIMESTAMP, '+${s} days'),
      plan_status = 'active'
    WHERE id = ?
  `).bind(r,a,t).run(),await e.env.DB.prepare(`
    INSERT INTO plan_usage_history (
      user_id, plan_id, previous_plan_id, action, started_at, 
      expires_at, billing_cycle
    ) VALUES (?, ?, ?, 'admin_change', CURRENT_TIMESTAMP, 
      datetime(CURRENT_TIMESTAMP, '+${s} days'), ?)
  `).bind(t,r,n.plan_id,a).run(),e.json({message:"Plan changed successfully",user_id:t,new_plan_id:r})):e.json({error:"User not found"},404)});Fe.get("/admin/statistics",j,Xa("admin"),async e=>{const{results:t}=await e.env.DB.prepare(`
    SELECT 
      p.display_name as plan_name,
      COUNT(u.id) as user_count,
      SUM(u.validators_used) as total_validators_used,
      SUM(u.products_count) as total_products
    FROM pricing_plans p
    LEFT JOIN users u ON p.id = u.plan_id
    WHERE u.role = 'founder'
    GROUP BY p.id, p.display_name
    ORDER BY p.display_order
  `).all(),r=await e.env.DB.prepare(`
    SELECT 
      COUNT(*) as total_payments,
      SUM(amount) as total_revenue,
      AVG(amount) as avg_payment
    FROM subscription_payments
    WHERE payment_status = 'completed'
  `).first(),a=await e.env.DB.prepare(`
    SELECT COUNT(*) as count
    FROM users
    WHERE plan_status = 'active' AND role = 'founder'
  `).first();return e.json({plan_distribution:t,revenue:r,active_subscriptions:a.count})});async function Uo(e,t,r,a=1){const s=r==="validators"?"validators_used":"products_count";await e.prepare(`
    UPDATE users 
    SET ${s} = GREATEST(0, ${s} - ?)
    WHERE id = ?
  `).bind(a,t).run()}const W=new ee;W.get("/validators",async e=>{const{expertise:t,min_rating:r,availability:a,limit:s="20",offset:o="0"}=e.req.query();let n=`
    SELECT 
      v.*,
      u.name, u.email, u.avatar_url, u.bio, u.company
    FROM validators v
    JOIN users u ON v.user_id = u.id
    WHERE 1=1
  `;const i=[];t&&(n+=" AND v.expertise LIKE ?",i.push(`%${t}%`)),r&&(n+=" AND v.rating >= ?",i.push(parseFloat(r))),a&&(n+=" AND v.availability = ?",i.push(a)),n+=" ORDER BY v.rating DESC, v.total_validations DESC LIMIT ? OFFSET ?",i.push(parseInt(s),parseInt(o));const{results:l}=await e.env.DB.prepare(n).bind(...i).all();return e.json({validators:l})});W.get("/validators/search",async e=>{const{q:t,expertise:r,min_rating:a,max_rate:s,availability:o,languages:n,verified_only:i,sort:l="rating",limit:d="20",offset:c="0"}=e.req.query();let u=`
    SELECT 
      v.*,
      u.name, u.email, u.avatar_url, u.bio, u.company,
      COUNT(DISTINCT vs.id) as completed_sessions
    FROM validators v
    JOIN users u ON v.user_id = u.id
    LEFT JOIN validation_sessions vs ON v.id = vs.validator_id AND vs.status = 'completed'
    WHERE 1=1
  `;const p=[];if(t){u+=` AND (
      u.name LIKE ? OR 
      v.title LIKE ? OR 
      v.expertise LIKE ? OR
      u.bio LIKE ?
    )`;const g=`%${t}%`;p.push(g,g,g,g)}switch(r&&(u+=" AND v.expertise LIKE ?",p.push(`%${r}%`)),a&&(u+=" AND v.rating >= ?",p.push(parseFloat(a))),s&&(u+=" AND v.hourly_rate <= ?",p.push(parseFloat(s))),o&&(u+=" AND v.availability = ?",p.push(o)),n&&(u+=" AND v.languages LIKE ?",p.push(`%${n}%`)),i==="true"&&(u+=" AND v.verified = 1"),u+=" GROUP BY v.id",l){case"rate_low":u+=" ORDER BY v.hourly_rate ASC";break;case"rate_high":u+=" ORDER BY v.hourly_rate DESC";break;case"experience":u+=" ORDER BY v.experience_years DESC";break;case"popular":u+=" ORDER BY completed_contracts DESC";break;default:u+=" ORDER BY v.rating DESC, v.total_validations DESC"}u+=" LIMIT ? OFFSET ?",p.push(parseInt(d),parseInt(c));const{results:m}=await e.env.DB.prepare(u).bind(...p).all();return e.json({validators:m,total:m.length,filters:{q:t,expertise:r,min_rating:a,max_rate:s,availability:o,languages:n,verified_only:i,sort:l}})});W.get("/validators/:id",async e=>{const t=e.req.param("id"),r=await e.env.DB.prepare(`
    SELECT 
      v.*,
      u.name, u.email, u.avatar_url, u.bio, u.company,
      u.created_at as user_created_at
    FROM validators v
    JOIN users u ON v.user_id = u.id
    WHERE v.id = ?
  `).bind(t).first();if(!r)return e.json({error:"Validator not found"},404);const{results:a}=await e.env.DB.prepare("SELECT * FROM validator_certifications WHERE validator_id = ?").bind(t).all(),{results:s}=await e.env.DB.prepare(`
    SELECT 
      r.*,
      u.name as reviewer_name,
      u.avatar_url as reviewer_avatar
    FROM reviews r
    JOIN users u ON r.reviewer_id = u.id
    WHERE r.reviewee_id = ? AND r.reviewee_type = 'validator'
    ORDER BY r.created_at DESC
    LIMIT 10
  `).bind(t).all();return e.json({validator:r,certifications:a,reviews:s})});W.put("/validators/profile",j,async e=>{const t=e.get("userId"),{title:r,expertise:a,experience_years:s,hourly_rate:o,availability:n,languages:i,portfolio_url:l,linkedin_url:d}=await e.req.json(),c=await e.env.DB.prepare("SELECT id FROM validators WHERE user_id = ?").bind(t).first();return c?(await e.env.DB.prepare(`
    UPDATE validators
    SET title = COALESCE(?, title),
        expertise = COALESCE(?, expertise),
        experience_years = COALESCE(?, experience_years),
        hourly_rate = COALESCE(?, hourly_rate),
        availability = COALESCE(?, availability),
        languages = COALESCE(?, languages),
        portfolio_url = COALESCE(?, portfolio_url),
        linkedin_url = COALESCE(?, linkedin_url)
    WHERE id = ?
  `).bind(r,a,s,o,n,i,l,d,c.id).run(),e.json({message:"Profile updated successfully"})):e.json({error:"Validator profile not found"},404)});W.get("/products",async e=>{const{category:t,stage:r,status:a="active",featured:s,limit:o="20",offset:n="0"}=e.req.query();let i=`
    SELECT 
      p.*,
      u.name as company_name, u.avatar_url as company_avatar, u.company
    FROM beta_products p
    JOIN users u ON p.company_user_id = u.id
    WHERE p.status = ?
  `;const l=[a];t&&(i+=" AND p.category = ?",l.push(t)),r&&(i+=" AND p.stage = ?",l.push(r)),s&&(i+=" AND p.featured = 1"),i+=" ORDER BY p.featured DESC, p.created_at DESC LIMIT ? OFFSET ?",l.push(parseInt(o),parseInt(n));const{results:d}=await e.env.DB.prepare(i).bind(...l).all();return e.json({products:d})});W.get("/products/search",async e=>{const{q:t,category:r,stage:a,pricing_model:s,status:o="active",min_budget:n,max_budget:i,tags:l,sort:d="recent",limit:c="20",offset:u="0"}=e.req.query();let p=`
    SELECT 
      p.*,
      u.name as company_name,
      u.avatar_url as company_avatar,
      u.company,
      COUNT(DISTINCT a.id) as application_count
    FROM beta_products p
    JOIN users u ON p.company_user_id = u.id
    LEFT JOIN validator_applications a ON p.id = a.product_id
    WHERE p.status = ?
  `;const m=[o];if(t){p+=` AND (
      p.title LIKE ? OR 
      p.description LIKE ? OR 
      p.requirements LIKE ?
    )`;const b=`%${t}%`;m.push(b,b,b)}switch(r&&(p+=" AND p.category = ?",m.push(r)),a&&(p+=" AND p.stage = ?",m.push(a)),s&&(p+=" AND p.pricing_model = ?",m.push(s)),n&&(p+=" AND p.compensation >= ?",m.push(parseFloat(n))),i&&(p+=" AND p.compensation <= ?",m.push(parseFloat(i))),l&&(p+=" AND p.requirements LIKE ?",m.push(`%${l}%`)),p+=" GROUP BY p.id",d){case"budget_high":p+=" ORDER BY p.compensation DESC";break;case"budget_low":p+=" ORDER BY p.compensation ASC";break;case"popular":p+=" ORDER BY application_count DESC, p.created_at DESC";break;case"featured":p+=" ORDER BY p.featured DESC, p.created_at DESC";break;default:p+=" ORDER BY p.created_at DESC"}p+=" LIMIT ? OFFSET ?",m.push(parseInt(c),parseInt(u));const{results:g}=await e.env.DB.prepare(p).bind(...m).all();return e.json({products:g,total:g.length,filters:{q:t,category:r,stage:a,min_budget:n,max_budget:i,tags:l,sort:d}})});W.get("/products/:id",async e=>{const t=e.req.param("id"),r=await e.env.DB.prepare(`
    SELECT 
      p.*,
      u.name as company_name,
      u.avatar_url as company_avatar,
      u.company,
      u.bio as company_bio
    FROM beta_products p
    JOIN users u ON p.company_user_id = u.id
    WHERE p.id = ?
  `).bind(t).first();if(!r)return e.json({error:"Product not found"},404);const a=await e.env.DB.prepare("SELECT COUNT(*) as count FROM validator_applications WHERE product_id = ?").bind(t).first(),{results:s}=await e.env.DB.prepare(`
    SELECT 
      r.*,
      u.name as reviewer_name,
      u.avatar_url as reviewer_avatar,
      v.title as reviewer_title
    FROM reviews r
    JOIN users u ON r.reviewer_id = u.id
    LEFT JOIN validators v ON u.id = v.user_id
    WHERE r.reviewee_id = ? AND r.reviewee_type = 'product'
    ORDER BY r.created_at DESC
    LIMIT 10
  `).bind(t).all();return e.json({...r,application_count:a.count,reviews:s})});W.post("/products",j,async e=>{const t=e.get("userId");console.log("=== CREATING PRODUCT ==="),console.log("User ID:",t),console.log("User Role:",e.get("userRole"));const{title:r,description:a,category:s,subcategory:o,stage:n,url:i,looking_for:l,compensation_type:d,compensation_amount:c,pricing_model:u,duration_days:p,validators_needed:m,requirements:g}=await e.req.json(),b=o||null,v=g||"{}",y=l||"General feedback",f=d||"free_access",x=c||0,_=u||"subscription_monthly",C=p||14,A=m||5;if(!r||!a||!s)return e.json({error:"Missing required fields"},400);e.get("userRole"),console.log("Creando producto con los siguientes datos:",{userId:t,title:r,description:a,category:s,subcategory:b,stage:n,url:i,looking_for:y,compensation_type:f,compensation_amount:x,duration_days:C,validators_needed:A,requirements:v}),console.log("Intentando insertar producto con los siguientes datos:",{userId:t,title:r,description:a,category:s,subcategory:b,stage:n,url:i,looking_for:y,compensation_type:f,compensation_amount:x,duration_days:C,validators_needed:A,requirements:v});try{const I=await e.env.DB.prepare(`
      INSERT INTO beta_products (
        company_user_id, title, description, category, subcategory,
        stage, url, looking_for, compensation_type, compensation_amount,
        pricing_model, duration_days, validators_needed, requirements, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(t,r,a,s,b,n,i,y,f,x,_,C,A,v,"active").run();return e.json({success:!0,id:I.meta.last_row_id,message:"Product created successfully",validators_allocated:A})}catch(I){return console.error("Error al crear el producto:",I),e.json({success:!1,error:"Error interno al crear el producto"},500)}});W.put("/products/:id",j,async e=>{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare("SELECT company_user_id FROM beta_products WHERE id = ?").bind(r).first();if(!a)return e.json({error:"Product not found"},404);if(a.company_user_id!==t)return e.json({error:"Unauthorized"},403);const s=await e.req.json(),o=[],n=[],i=["title","description","category","subcategory","stage","url","looking_for","compensation_type","compensation_amount","pricing_model","duration_days","validators_needed","requirements","status"];for(const l of i)s[l]!==void 0&&(o.push(`${l} = ?`),n.push(s[l]));return o.length===0?e.json({error:"No fields to update"},400):(o.push("updated_at = CURRENT_TIMESTAMP"),n.push(r),await e.env.DB.prepare(`UPDATE beta_products SET ${o.join(", ")} WHERE id = ?`).bind(...n).run(),e.json({message:"Product updated successfully"}))});W.post("/applications",j,async e=>{const t=e.get("userId");if(e.get("userRole")!=="validator")return e.json({error:"Only validators can apply"},403);const{product_id:a,message:s}=await e.req.json();if(!a)return e.json({error:"Product ID required"},400);const o=await e.env.DB.prepare("SELECT id FROM validators WHERE user_id = ?").bind(t).first();if(!o)return e.json({error:"Validator profile not found"},404);if(!await e.env.DB.prepare("SELECT id, validators_needed, validators_accepted FROM beta_products WHERE id = ? AND status = ?").bind(a,"active").first())return e.json({error:"Product not found or not accepting applications"},404);if(await e.env.DB.prepare("SELECT id FROM validator_applications WHERE product_id = ? AND validator_id = ?").bind(a,o.id).first())return e.json({error:"Already applied to this product"},400);const l=await e.env.DB.prepare(`
    INSERT INTO validator_applications (product_id, validator_id, message, status)
    VALUES (?, ?, ?, 'pending')
  `).bind(a,o.id,s).run();return await e.env.DB.prepare(`
    INSERT INTO notifications (user_id, type, title, message, link)
    SELECT company_user_id, 'application', 'Nueva aplicación para validación', ?, ?
    FROM beta_products WHERE id = ?
  `).bind("Un validador ha aplicado para probar tu producto",`/marketplace/applications/${l.meta.last_row_id}`,a).run(),e.json({id:l.meta.last_row_id,message:"Application submitted successfully"})});W.get("/products/:id/applications",j,async e=>{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare("SELECT company_user_id FROM beta_products WHERE id = ?").bind(r).first();if(!a||a.company_user_id!==t)return e.json({error:"Unauthorized"},403);const{results:s}=await e.env.DB.prepare(`
    SELECT 
      a.*,
      v.title, v.expertise, v.rating, v.total_validations, v.hourly_rate,
      u.name, u.avatar_url, u.bio
    FROM validator_applications a
    JOIN validators v ON a.validator_id = v.id
    JOIN users u ON v.user_id = u.id
    WHERE a.product_id = ?
    ORDER BY a.created_at DESC
  `).bind(r).all();return e.json({applications:s})});W.get("/my-applications",j,async e=>{const t=e.get("userId"),r=await e.env.DB.prepare("SELECT id FROM validators WHERE user_id = ?").bind(t).first();if(!r)return e.json({error:"Validator profile not found"},404);const{results:a}=await e.env.DB.prepare(`
    SELECT 
      a.*,
      p.title as product_title, p.description, p.category, p.compensation_type, p.compensation_amount,
      u.name as company_name, u.avatar_url as company_avatar
    FROM validator_applications a
    JOIN beta_products p ON a.product_id = p.id
    JOIN users u ON p.company_user_id = u.id
    WHERE a.validator_id = ?
    ORDER BY a.created_at DESC
  `).bind(r.id).all();return e.json({applications:a})});W.post("/applications/:id/decision",j,async e=>{const t=e.get("userId"),r=e.req.param("id"),{decision:a}=await e.req.json();if(!["accept","reject"].includes(a))return e.json({error:"Invalid decision"},400);const s=await e.env.DB.prepare(`
    SELECT a.*, p.company_user_id, p.duration_days, p.validators_accepted, p.validators_needed
    FROM validator_applications a
    JOIN beta_products p ON a.product_id = p.id
    WHERE a.id = ?
  `).bind(r).first();if(!s)return e.json({error:"Application not found"},404);if(s.company_user_id!==t)return e.json({error:"Unauthorized"},403);if(a==="accept"&&s.validators_accepted>=s.validators_needed)return e.json({error:"Validator slots full",message:"This product has already reached its maximum number of validators"},400);const o=a==="accept"?"accepted":"rejected";if(await e.env.DB.prepare(`
    UPDATE validator_applications
    SET status = ?, accepted_at = CASE WHEN ? = 'accepted' THEN CURRENT_TIMESTAMP ELSE NULL END
    WHERE id = ?
  `).bind(o,o,r).run(),a==="accept"){const n=new Date().toISOString(),i=new Date(Date.now()+s.duration_days*24*60*60*1e3).toISOString();await e.env.DB.prepare(`
      INSERT INTO validation_sessions (application_id, product_id, validator_id, start_date, end_date, status)
      VALUES (?, ?, ?, ?, ?, 'active')
    `).bind(r,s.product_id,s.validator_id,n,i).run(),await e.env.DB.prepare(`
      UPDATE beta_products
      SET validators_accepted = validators_accepted + 1
      WHERE id = ?
    `).bind(s.product_id).run()}return await e.env.DB.prepare(`
    INSERT INTO notifications (user_id, type, title, message, link)
    SELECT user_id, 'application_decision', ?, ?, ?
    FROM validators WHERE id = ?
  `).bind(a==="accept"?"¡Aplicación aceptada!":"Aplicación rechazada",a==="accept"?"Tu aplicación ha sido aceptada. Ya puedes comenzar a validar el producto.":"Tu aplicación no fue aceptada en esta ocasión.","/marketplace/my-sessions",s.validator_id).run(),e.json({message:`Application ${o} successfully`})});W.delete("/products/:id",j,async e=>{const t=e.get("userId"),r=e.req.param("id");console.log("DELETE product request:",{userId:t,productId:r,userIdType:typeof t});const a=parseInt(r);if(isNaN(a))return e.json({error:"Invalid product ID"},400);try{const s=await e.env.DB.prepare(`
      SELECT company_user_id, validators_needed, status
      FROM beta_products 
      WHERE id = ?
    `).bind(a).first();if(console.log("DELETE product - Product found:",s),console.log("DELETE product - company_user_id:",s==null?void 0:s.company_user_id,"type:",typeof(s==null?void 0:s.company_user_id)),console.log("DELETE product - userId from token:",t,"type:",typeof t),!s)return console.log("DELETE product - Product not found"),e.json({error:"Product not found"},404);if(s.company_user_id===null||s.company_user_id===void 0)return console.log("DELETE product - Product has null company_user_id"),e.json({error:"Product ownership not set"},500);const o=s.company_user_id.toString(),n=t.toString();if(console.log("DELETE product - Ownership check:",{productOwnerId:o,requestUserId:n,areEqual:o===n}),o!==n)return console.log("DELETE product - Ownership check failed"),e.json({error:"Unauthorized - You do not own this product"},403);console.log("DELETE product - Checking related records for product:",a);const i=await e.env.DB.prepare("SELECT COUNT(*) as count FROM product_votes WHERE product_id = ?").bind(a).first();console.log("DELETE product - Product votes count:",i);const l=await e.env.DB.prepare("SELECT COUNT(*) as count FROM validator_applications WHERE product_id = ?").bind(a).first();console.log("DELETE product - Validator applications count:",l);const d=await e.env.DB.prepare("SELECT COUNT(*) as count FROM validation_sessions WHERE product_id = ?").bind(a).first();console.log("DELETE product - Validation sessions count:",d);const c=await e.env.DB.prepare("SELECT COUNT(*) as count FROM validation_reports WHERE product_id = ?").bind(a).first();console.log("DELETE product - Validation reports count:",c);const u=await e.env.DB.prepare("SELECT COUNT(*) as count FROM messages WHERE product_id = ? OR session_id IN (SELECT id FROM validation_sessions WHERE product_id = ?)").bind(a,a).first();console.log("DELETE product - Messages count:",u),console.log("DELETE product - Deleting related records...");try{const m=await e.env.DB.prepare("DELETE FROM validation_reports WHERE product_id = ?").bind(a).run();console.log("DELETE product - Validation reports deleted:",m)}catch(m){console.error("DELETE product - Error deleting validation reports:",m)}try{const m=await e.env.DB.prepare("DELETE FROM messages WHERE product_id = ? OR session_id IN (SELECT id FROM validation_sessions WHERE product_id = ?)").bind(a,a).run();console.log("DELETE product - Messages deleted:",m)}catch(m){console.error("DELETE product - Error deleting messages:",m)}try{const m=await e.env.DB.prepare("DELETE FROM validation_sessions WHERE product_id = ?").bind(a).run();console.log("DELETE product - Validation sessions deleted:",m)}catch(m){console.error("DELETE product - Error deleting validation sessions:",m)}try{const m=await e.env.DB.prepare("DELETE FROM validator_applications WHERE product_id = ?").bind(a).run();console.log("DELETE product - Validator applications deleted:",m)}catch(m){console.error("DELETE product - Error deleting validator applications:",m)}try{const m=await e.env.DB.prepare("DELETE FROM product_votes WHERE product_id = ?").bind(a).run();console.log("DELETE product - Votes deleted:",m)}catch(m){console.error("DELETE product - Error deleting votes:",m)}console.log("DELETE product - Related records deleted, now deleting product...");const p=await e.env.DB.prepare("DELETE FROM beta_products WHERE id = ?").bind(a).run();console.log("DELETE product - Product deleted successfully:",p);try{await Uo(e.env.DB,t,"products",1),s.validators_needed>0&&await Uo(e.env.DB,t,"validators",s.validators_needed)}catch(m){console.warn("Failed to decrement usage counters:",m)}return e.json({message:"Product deleted successfully"})}catch(s){console.error("Error deleting product:",s);const o=s instanceof Error?s.message:"Unknown error",n=s instanceof Error?s.stack:void 0;return console.error("Error stack:",n),e.json({error:"Internal server error",details:o,productId:r},500)}});W.post("/products/:id/close",j,async e=>{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare("SELECT company_user_id, validators_needed FROM beta_products WHERE id = ?").bind(r).first();return a?a.company_user_id!==t?e.json({error:"Unauthorized"},403):(await e.env.DB.prepare(`
    UPDATE beta_products 
    SET status = 'closed', updated_at = CURRENT_TIMESTAMP
    WHERE id = ?
  `).bind(r).run(),await Uo(e.env.DB,t,"validators",a.validators_needed),e.json({message:"Product closed successfully. Validators freed from your plan limit."})):e.json({error:"Product not found"},404)});W.get("/debug/dashboard",async e=>{try{console.log("DEBUG: Debug endpoint called");const t={role:"founder",total_products:5,active_products:3,active_sessions:2,completed_sessions:1,total_ratings_given:0,applications:{pending:1,approved:2,rejected:0},monthly_products:[]};return console.log("DEBUG: Returning hardcoded response"),e.json(t)}catch(t){return console.error("DEBUG: Error in debug endpoint:",t),e.json({error:"Debug endpoint failed"},500)}});W.get("/dashboard/debug",async e=>{console.log("Debug endpoint called");const t=e.req.header("Authorization");if(console.log("Auth header:",t),!t||!t.startsWith("Bearer "))return e.json({error:"No token provided",authHeader:t},401);const r=t.substring(7);console.log("Token:",r);try{const{verify:a}=await Promise.resolve().then(()=>Ya);if(!e.env.JWT_SECRET)return e.json({error:"JWT_SECRET not configured"},500);const s=await a(r,e.env.JWT_SECRET);return console.log("Token payload:",s),e.json({message:"Token is valid",userId:s.userId,role:s.role,email:s.email})}catch(a){return console.log("Token verification error:",a),e.json({error:"Invalid token",details:String(a)},401)}});W.get("/dashboard/metrics",j,async e=>{try{console.log("Dashboard metrics endpoint called");const t=e.get("userId");console.log("User ID from auth:",t);const r=await e.env.DB.prepare("SELECT role FROM users WHERE id = ?").bind(t).first();if(console.log("Current user query result:",r),!r)return console.log("User not found, returning 404"),e.json({error:"User not found"},404);if(console.log("User role:",r.role),r.role==="validator"){console.log("Processing validator metrics");try{const a=await e.env.DB.prepare(`
          SELECT * FROM validators WHERE user_id = ?
        `).bind(t).first();if(console.log("Validator query result:",a),!a)return console.log("Validator profile not found, returning 404"),e.json({error:"Validator profile not found"},404);const s=await e.env.DB.prepare(`
          SELECT COALESCE(SUM(ve.amount), 0) as total
          FROM validator_earnings ve
          JOIN validation_sessions vs ON ve.session_id = vs.id
          WHERE vs.validator_id = ? AND vs.status = 'completed'
        `).bind(a.id).first(),o=await e.env.DB.prepare(`
          SELECT
            status,
            COUNT(*) as count
          FROM validator_applications
          WHERE validator_id = ?
          GROUP BY status
        `).bind(a.id).all(),n=await e.env.DB.prepare(`
          SELECT
            strftime('%Y-%m', ve.created_at) as month,
            COALESCE(SUM(ve.amount), 0) as amount
          FROM validator_earnings ve
          JOIN validation_sessions vs ON ve.session_id = vs.id
          WHERE vs.validator_id = ? AND vs.status = 'completed'
          GROUP BY month
          ORDER BY month DESC
          LIMIT 6
        `).bind(a.id).all(),i=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM validation_sessions
          WHERE validator_id = ? AND status = 'active'
        `).bind(a.id).first(),l={role:"validator",total_earnings:(s==null?void 0:s.total)||0,rating:(a==null?void 0:a.rating)||0,total_validations:(a==null?void 0:a.total_validations)||0,active_sessions:(i==null?void 0:i.count)||0,applications:{pending:0,approved:0,rejected:0},monthly_earnings:[]};return o&&o.results&&o.results.forEach(d=>{d.status==="pending"&&(l.applications.pending=d.count),d.status==="approved"&&(l.applications.approved=d.count),d.status==="rejected"&&(l.applications.rejected=d.count)}),n&&n.results&&(l.monthly_earnings=n.results),e.json(l)}catch(a){return console.error("Validator metrics error:",a),e.json({role:"validator",total_earnings:0,rating:0,total_validations:0,active_sessions:0,applications:{pending:0,approved:0,rejected:0},monthly_earnings:[],sql_error:(a==null?void 0:a.message)||String(a)},500)}}else{console.log("Processing founder metrics for user:",t);try{const a=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM beta_products
          WHERE company_user_id = ?
        `).bind(t).first();console.log("Products query result:",a);const s=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM beta_products
          WHERE company_user_id = ? AND status = 'active'
        `).bind(t).first();console.log("Active products query result:",s);const o=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM validator_applications va
          INNER JOIN beta_products bp ON va.product_id = bp.id
          WHERE bp.company_user_id = ? AND va.status = 'pending'
        `).bind(t).first(),n=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM validator_applications va
          INNER JOIN beta_products bp ON va.product_id = bp.id
          WHERE bp.company_user_id = ? AND va.status = 'approved'
        `).bind(t).first(),i=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM validator_applications va
          INNER JOIN beta_products bp ON va.product_id = bp.id
          WHERE bp.company_user_id = ? AND va.status = 'rejected'
        `).bind(t).first(),l=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM validation_sessions vs
          INNER JOIN beta_products bp ON vs.product_id = bp.id
          WHERE bp.company_user_id = ? AND vs.status = 'active'
        `).bind(t).first(),d=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM validation_sessions vs
          INNER JOIN beta_products bp ON vs.product_id = bp.id
          WHERE bp.company_user_id = ? AND vs.status = 'completed'
        `).bind(t).first(),c=await e.env.DB.prepare(`
          SELECT COUNT(*) as count FROM validator_ratings
          WHERE founder_id = ?
        `).bind(t).first(),u=await e.env.DB.prepare(`
          SELECT
            strftime('%Y-%m', created_at) as month,
            COUNT(*) as count
          FROM beta_products
          WHERE company_user_id = ?
          GROUP BY strftime('%Y-%m', created_at)
          ORDER BY month DESC
          LIMIT 6
        `).bind(t).all(),p={role:"founder",total_products:(a==null?void 0:a.count)||0,active_products:(s==null?void 0:s.count)||0,active_sessions:(l==null?void 0:l.count)||0,completed_sessions:(d==null?void 0:d.count)||0,total_ratings_given:(c==null?void 0:c.count)||0,applications:{pending:(o==null?void 0:o.count)||0,approved:(n==null?void 0:n.count)||0,rejected:(i==null?void 0:i.count)||0},monthly_products:(u==null?void 0:u.results)||[]};return console.log("About to return founder response:",p),e.json(p)}catch(a){return console.error("Query error in founder metrics:",a),e.json({role:"founder",total_products:0,active_products:0,active_sessions:0,completed_sessions:0,total_ratings_given:0,applications:{pending:0,approved:0,rejected:0},monthly_products:[],sql_error:(a==null?void 0:a.message)||String(a)},500)}}}catch(t){console.error("Dashboard metrics error:",t),t instanceof Error&&console.error("Error stack:",t.stack);const r=t instanceof Error?t.message:String(t);return e.json({error:"Failed to load dashboard metrics",details:r},500)}});W.get("/notifications",j,async e=>{const t=e.get("userId"),{unread_only:r,limit:a="50",offset:s="0"}=e.req.query();let o=`
    SELECT * FROM notifications 
    WHERE user_id = ?
  `;const n=[t];r==="true"&&(o+=" AND read = 0"),o+=" ORDER BY created_at DESC LIMIT ? OFFSET ?",n.push(parseInt(a),parseInt(s));const{results:i}=await e.env.DB.prepare(o).bind(...n).all(),l=await e.env.DB.prepare("SELECT COUNT(*) as count FROM notifications WHERE user_id = ? AND read = 0").bind(t).first();return e.json({notifications:i,unread_count:(l==null?void 0:l.count)||0,total:i.length})});W.put("/notifications/:id/read",j,async e=>{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare("SELECT user_id FROM notifications WHERE id = ?").bind(r).first();return!a||a.user_id!==t?e.json({error:"Notification not found"},404):(await e.env.DB.prepare("UPDATE notifications SET read = 1 WHERE id = ?").bind(r).run(),e.json({message:"Notification marked as read"}))});W.put("/notifications/read-all",j,async e=>{const t=e.get("userId");return await e.env.DB.prepare("UPDATE notifications SET read = 1 WHERE user_id = ? AND read = 0").bind(t).run(),e.json({message:"All notifications marked as read"})});W.delete("/notifications/:id",j,async e=>{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare("SELECT user_id FROM notifications WHERE id = ?").bind(r).first();return!a||a.user_id!==t?e.json({error:"Notification not found"},404):(await e.env.DB.prepare("DELETE FROM notifications WHERE id = ?").bind(r).run(),e.json({message:"Notification deleted"}))});W.get("/notifications/unread-count",j,async e=>{const t=e.get("userId"),r=await e.env.DB.prepare("SELECT COUNT(*) as count FROM notifications WHERE user_id = ? AND read = 0").bind(t).first();return e.json({unread_count:(r==null?void 0:r.count)||0})});W.get("/my-products",j,async e=>{const t=e.get("userId"),r=await e.env.DB.prepare(`
    SELECT 
      p.*,
      u.name as company_name,
      COUNT(DISTINCT va.id) as validators_count
    FROM beta_products p
    JOIN users u ON p.company_user_id = u.id
    LEFT JOIN validator_applications va ON p.id = va.product_id AND va.status = 'approved'
    WHERE p.company_user_id = ?
    GROUP BY p.id
    ORDER BY p.created_at DESC
  `).bind(t).all();return e.json({products:r.results||[]})});W.post("/products/:productId/invite-validator",j,async e=>{const t=e.get("userId"),r=e.req.param("productId"),{validator_id:a}=await e.req.json();if(console.log("Invitando validador:",{userId:t,productId:r,validator_id:a}),!a)return e.json({error:"validator_id is required"},400);try{console.log("Verificando propiedad del producto...");const s=await e.env.DB.prepare("SELECT * FROM beta_products WHERE id = ? AND company_user_id = ?").bind(r,t).first();if(console.log("Producto encontrado:",s?"Sí":"No"),!s)return e.json({error:"Product not found or unauthorized"},404);console.log("Verificando límite de validadores...");const o=await e.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM validator_applications 
      WHERE product_id = ? AND status IN ('approved', 'accepted', 'completed')
    `).bind(r).first();console.log("Validadores actuales:",(o==null?void 0:o.count)||0);const n=s.validators_needed||3;if(console.log("Límite máximo:",n),((o==null?void 0:o.count)||0)>=n)return e.json({error:`Product has reached the maximum limit of ${n} validators`},400);console.log("Verificando aplicación existente...");const i=await e.env.DB.prepare("SELECT * FROM validator_applications WHERE product_id = ? AND validator_id = ?").bind(r,a).first();if(console.log("Aplicación existente:",i?"Sí":"No"),i)return e.json({error:"Validator already has an application for this product"},400);console.log("Verificando que el validador existe...");const l=await e.env.DB.prepare("SELECT id, user_id FROM validators WHERE id = ?").bind(a).first();if(console.log("Validador existe:",l?"Sí":"No"),!l)return e.json({error:"Validator not found"},404);console.log("Creando invitación...");const d=await e.env.DB.prepare(`
      INSERT INTO validator_applications (
        product_id, validator_id, status, message, created_at
      ) VALUES (?, ?, ?, ?, datetime('now'))
    `).bind(r,a,"invited","Invitado por el founder del producto").run();console.log("Invitación creada:",d),console.log("Buscando información del validador...");try{const c=await e.env.DB.prepare("SELECT user_id, title FROM validators WHERE id = ?").bind(a).first();if(console.log("Validador encontrado:",c?"Sí":"No"),console.log("Datos del validador:",c),c&&c.user_id){console.log("Verificando que el user_id existe en users...");const u=await e.env.DB.prepare("SELECT id FROM users WHERE id = ?").bind(c.user_id).first();if(console.log("Usuario existe:",u?"Sí":"No"),u){console.log("Creando notificación...");const p=await e.env.DB.prepare(`
            INSERT INTO notifications (user_id, type, title, message, link)
            VALUES (?, ?, ?, ?, ?)
          `).bind(c.user_id,"product_invitation","Nueva invitación de producto",`Has sido invitado a validar: ${s.title}`,`/marketplace?tab=dashboard&product=${r}`).run();console.log("Notificación creada exitosamente:",p)}else console.log("No se puede crear notificación: user_id no existe en tabla users")}else console.log("No se puede crear notificación: validador no encontrado o sin user_id")}catch(c){console.error("Error al crear notificación (continuando):",c)}return console.log("Invitación completada exitosamente"),e.json({message:"Validator invited successfully",status:"invited"})}catch(s){return console.error("Error completo al invitar validador:",s),e.json({error:"Internal server error while inviting validator"},500)}});W.get("/validator/invitations",j,async e=>{const t=e.get("userId"),r=await e.env.DB.prepare("SELECT id FROM validators WHERE user_id = ?").bind(t).first();if(!r)return e.json({error:"Validator profile not found"},404);const a=await e.env.DB.prepare(`
    SELECT 
      va.id,
      va.product_id,
      va.status,
      va.message,
      va.created_at,
      bp.title as product_title,
      bp.description as product_description,
      bp.category,
      bp.stage,
      u.name as founder_name
    FROM validator_applications va
    JOIN beta_products bp ON va.product_id = bp.id
    JOIN users u ON bp.company_user_id = u.id
    WHERE va.validator_id = ? AND va.status = 'invited'
    ORDER BY va.created_at DESC
  `).bind(r.id).all();return e.json({invitations:a.results||[]})});W.post("/validator/invitations/:invitationId/respond",j,async e=>{const t=e.get("userId"),r=e.req.param("invitationId"),{decision:a}=await e.req.json();if(!["accept","reject"].includes(a))return e.json({error:'Invalid decision. Must be "accept" or "reject"'},400);const s=await e.env.DB.prepare("SELECT id FROM validators WHERE user_id = ?").bind(t).first();if(!s)return e.json({error:"Validator profile not found"},404);const o=await e.env.DB.prepare(`
    SELECT va.*, bp.company_user_id, bp.duration_days, bp.validators_accepted, bp.validators_needed
    FROM validator_applications va
    JOIN beta_products bp ON va.product_id = bp.id
    WHERE va.id = ? AND va.validator_id = ? AND va.status = 'invited'
  `).bind(r,s.id).first();if(!o)return e.json({error:"Invitation not found or already responded to"},404);if(a==="accept"&&o.validators_accepted>=o.validators_needed)return e.json({error:"Validator slots full",message:"This product has already reached its maximum number of validators"},400);const n=a==="accept"?"accepted":"rejected";if(await e.env.DB.prepare(`
    UPDATE validator_applications
    SET status = ?, accepted_at = CASE WHEN ? = 'accepted' THEN CURRENT_TIMESTAMP ELSE NULL END
    WHERE id = ?
  `).bind(n,n,r).run(),a==="accept"){const i=new Date().toISOString(),l=new Date(Date.now()+o.duration_days*24*60*60*1e3).toISOString();await e.env.DB.prepare(`
      INSERT INTO validation_sessions (application_id, product_id, validator_id, start_date, end_date, status)
      VALUES (?, ?, ?, ?, ?, 'active')
    `).bind(r,o.product_id,s.id,i,l).run(),await e.env.DB.prepare(`
      UPDATE beta_products
      SET validators_accepted = validators_accepted + 1
      WHERE id = ?
    `).bind(o.product_id).run()}return e.json({success:!0,message:`Invitation ${a}ed successfully`})});W.get("/sessions/validator/:validatorId",j,async e=>{const t=e.get("userId"),r=e.req.param("validatorId"),a=await e.env.DB.prepare(`
    SELECT vs.*, bp.title as product_title
    FROM validation_sessions vs
    JOIN validator_applications va ON vs.application_id = va.id
    JOIN beta_products bp ON vs.product_id = bp.id
    WHERE (bp.company_user_id = ? OR vs.validator_id = ?)
      AND vs.validator_id = ?
      AND vs.status = 'active'
    ORDER BY vs.created_at DESC
    LIMIT 1
  `).bind(t,r,r).first();return e.json({session:a})});W.get("/sessions/company/:companyId",j,async e=>{const t=e.get("userId"),r=e.req.param("companyId"),a=await e.env.DB.prepare(`
    SELECT vs.*, bp.title as product_title, u.name as company_name
    FROM validation_sessions vs
    JOIN validator_applications va ON vs.application_id = va.id
    JOIN beta_products bp ON vs.product_id = bp.id
    JOIN users u ON bp.company_user_id = u.id
    WHERE vs.validator_id = (SELECT id FROM validators WHERE user_id = ?)
      AND bp.company_user_id = ?
      AND vs.status = 'active'
    ORDER BY vs.created_at DESC
    LIMIT 1
  `).bind(t,r).first();return e.json({session:a})});W.get("/sessions/:sessionId/messages",j,async e=>{const t=e.get("userId"),r=e.req.param("sessionId"),a=await e.env.DB.prepare(`
    SELECT vs.*, bp.company_user_id
    FROM validation_sessions vs
    JOIN beta_products bp ON vs.product_id = bp.id
    WHERE vs.id = ?
  `).bind(r).first();if(!a)return e.json({error:"Session not found"},404);const s=await e.env.DB.prepare("SELECT user_id FROM validators WHERE id = ?").bind(a.validator_id).first();if(t!==a.company_user_id&&t!==(s==null?void 0:s.user_id))return e.json({error:"Unauthorized"},403);const o=await e.env.DB.prepare(`
    SELECT 
      m.*,
      u.name as sender_name
    FROM messages m
    JOIN users u ON m.sender_id = u.id
    WHERE m.session_id = ?
    ORDER BY m.created_at ASC
  `).bind(r).all();return await e.env.DB.prepare("UPDATE messages SET read = 1 WHERE session_id = ? AND receiver_id = ? AND read = 0").bind(r,t).run(),e.json({messages:o.results||[]})});W.post("/sessions/:sessionId/messages",j,async e=>{const t=e.get("userId"),r=e.req.param("sessionId"),{message:a}=await e.req.json();if(!a||a.trim().length===0)return e.json({error:"Message is required"},400);const s=await e.env.DB.prepare(`
    SELECT vs.*, bp.company_user_id
    FROM validation_sessions vs
    JOIN beta_products bp ON vs.product_id = bp.id
    WHERE vs.id = ?
  `).bind(r).first();if(!s)return e.json({error:"Session not found"},404);const o=await e.env.DB.prepare("SELECT user_id FROM validators WHERE id = ?").bind(s.validator_id).first();if(t!==s.company_user_id&&t!==(o==null?void 0:o.user_id))return e.json({error:"Unauthorized"},403);const n=t===s.company_user_id?o.user_id:s.company_user_id,i=await e.env.DB.prepare(`
    INSERT INTO messages (session_id, sender_id, receiver_id, message)
    VALUES (?, ?, ?, ?)
  `).bind(r,t,n,a.trim()).run();return e.json({message:"Message sent",messageId:i.meta.last_row_id})});W.get("/my-active-sessions",j,async e=>{const t=e.get("userId"),r=await e.env.DB.prepare("SELECT id FROM validators WHERE user_id = ?").bind(t).first();if(!r)return e.json({error:"User is not a validator"},403);const a=await e.env.DB.prepare(`
    SELECT 
      vs.*,
      bp.title as product_title,
      bp.company_user_id,
      u.name as company_name
    FROM validation_sessions vs
    JOIN beta_products bp ON vs.product_id = bp.id
    JOIN users u ON bp.company_user_id = u.id
    WHERE vs.validator_id = ? AND vs.status = 'active'
    ORDER BY vs.created_at DESC
  `).bind(r.id).all();return e.json({sessions:a.results||[]})});W.post("/products/:id/vote",j,async e=>{const t=e.req.param("id"),r=e.var.userId,{rating:a}=await e.req.json();if(!a||a<1||a>5)return e.json({error:"Rating must be between 1 and 5"},400);try{return await e.env.DB.prepare("SELECT id FROM beta_products WHERE id = ?").bind(t).first()?(await e.env.DB.prepare(`
      INSERT INTO product_votes (product_id, user_id, rating, updated_at)
      VALUES (?, ?, ?, CURRENT_TIMESTAMP)
      ON CONFLICT(product_id, user_id) DO UPDATE SET
        rating = excluded.rating,
        updated_at = CURRENT_TIMESTAMP
    `).bind(t,r,a).run(),await e.env.DB.prepare(`
      UPDATE beta_products
      SET
        rating_average = (
          SELECT AVG(rating)
          FROM product_votes
          WHERE product_id = ?
        ),
        votes_count = (
          SELECT COUNT(*)
          FROM product_votes
          WHERE product_id = ?
        ),
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(t,t,t).run(),e.json({message:"Vote recorded successfully"})):e.json({error:"Product not found"},404)}catch(s){return console.error("Error recording product vote:",s),e.json({error:"Failed to record vote"},500)}});W.get("/products/:id/vote",j,async e=>{const t=e.req.param("id"),r=e.get("userId");try{const a=await e.env.DB.prepare("SELECT rating FROM product_votes WHERE product_id = ? AND user_id = ?").bind(t,r).first();return e.json({vote:a?a.rating:null})}catch(a){return console.error("Error getting product vote:",a),e.json({error:"Failed to get vote"},500)}});W.post("/sync-products-to-leaderboard",j,async e=>{try{const{results:t}=await e.env.DB.prepare("SELECT * FROM beta_products WHERE status = ?").bind("active").all(),r=[];for(const a of t)await Ku(e.env.DB,a.id),r.push({id:a.id,title:a.title});return e.json({message:"Synchronization complete",synced:r.length,projects:r})}catch(t){return console.error("Error syncing products to leaderboard:",t),e.json({error:"Failed to sync products"},500)}});async function Ku(e,t){try{const r=await e.prepare("SELECT * FROM beta_products WHERE id = ?").bind(t).first();if(!r)return;const a=await e.prepare("SELECT id FROM projects WHERE title = ? AND user_id = ?").bind(r.title,r.company_user_id).first();a?await e.prepare(`
        UPDATE projects
        SET rating_average = ?, votes_count = ?, updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
      `).bind(r.rating_average||0,r.votes_count||0,a.id).run():await e.prepare(`
        INSERT INTO projects (user_id, title, description, target_market, value_proposition, category, status, rating_average, votes_count)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(r.company_user_id,r.title,r.description,r.category,r.looking_for,r.category,"published",r.rating_average||0,r.votes_count||0).run()}catch(r){console.error("Error syncing product to leaderboard:",r)}}W.get("/my-active-validators",j,async e=>{const t=e.get("userId"),r=await e.env.DB.prepare(`
    SELECT 
      v.id as validator_id,
      v.user_id as validator_user_id,
      u.name as name,
      v.title,
      bp.title as product_title,
      COALESCE(v.rating, 0) as rating,
      COALESCE(v.total_validations, 0) as total_ratings
    FROM validation_sessions vs
    JOIN validators v ON vs.validator_id = v.id
    JOIN users u ON v.user_id = u.id
    JOIN beta_products bp ON vs.product_id = bp.id
    WHERE bp.company_user_id = ? AND vs.status = 'active'
    ORDER BY vs.created_at DESC
  `).bind(t).all();return e.json({validators:r.results||[]})});W.post("/validators/:validatorId/rate",j,async e=>{const t=e.get("userId"),r=e.req.param("validatorId"),{rating:a}=await e.req.json();return!a||a<1||a>5?e.json({error:"Rating must be between 1 and 5"},400):await e.env.DB.prepare(`
    SELECT vs.id, bp.company_user_id
    FROM validation_sessions vs
    JOIN beta_products bp ON vs.product_id = bp.id
    WHERE vs.validator_id = ? AND bp.company_user_id = ? AND vs.status = 'active'
    LIMIT 1
  `).bind(r,t).first()?(await e.env.DB.prepare(`
    SELECT id FROM validator_ratings 
    WHERE validator_id = ? AND founder_id = ?
  `).bind(r,t).first()?await e.env.DB.prepare(`
      UPDATE validator_ratings 
      SET rating = ?, updated_at = CURRENT_TIMESTAMP 
      WHERE validator_id = ? AND founder_id = ?
    `).bind(a,r,t).run():await e.env.DB.prepare(`
      INSERT INTO validator_ratings (validator_id, founder_id, rating)
      VALUES (?, ?, ?)
    `).bind(r,t,a).run(),await e.env.DB.prepare(`
    UPDATE validators 
    SET rating = (
      SELECT AVG(rating) FROM validator_ratings WHERE validator_id = validators.id
    ),
    total_validations = (
      SELECT COUNT(*) FROM validator_ratings WHERE validator_id = validators.id
    )
    WHERE id = ?
  `).bind(r).run(),e.json({message:"Rating submitted successfully"})):e.json({error:"No active session found with this validator"},403)});W.get("/dashboard/debug",j,async e=>e.json({message:"Dashboard authentication successful",user:e.get("userId"),timestamp:new Date().toISOString()}));W.post("/sync-existing-products",j,async e=>{try{const{results:t}=await e.env.DB.prepare("SELECT * FROM beta_products WHERE project_id IS NULL").all(),r=[];for(const a of t)try{const o=(await e.env.DB.prepare(`
          INSERT INTO projects (
            user_id, title, description, target_market, value_proposition,
            category, status, rating_average, votes_count, created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(a.company_user_id,a.title,a.description,a.category,a.looking_for,a.category,"published",a.rating_average||0,a.votes_count||0,a.created_at,a.updated_at).run()).meta.last_row_id;await e.env.DB.prepare("UPDATE beta_products SET project_id = ? WHERE id = ?").bind(o,a.id).run();const{results:n}=await e.env.DB.prepare("SELECT user_id, rating, created_at FROM product_votes WHERE product_id = ?").bind(a.id).all();for(const i of n)await e.env.DB.prepare(`
            INSERT INTO project_votes (project_id, user_id, rating, created_at, updated_at)
            VALUES (?, ?, ?, ?, ?)
            ON CONFLICT(project_id, user_id) DO UPDATE SET
              rating = excluded.rating,
              updated_at = excluded.updated_at
          `).bind(o,i.user_id,i.rating,i.created_at,i.created_at).run();r.push({product_id:a.id,project_id:o,title:a.title,votes_synced:n.length})}catch(s){console.error(`Error syncing product ${a.id}:`,s)}return e.json({message:"Products synced successfully",synced_count:r.length,products:r})}catch(t){return console.error("Error syncing products:",t),e.json({error:"Failed to sync products"},500)}});var Wn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Qu(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if(typeof t=="function"){var r=function a(){return this instanceof a?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(a){var s=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(r,a,s.get?s:{enumerable:!0,get:function(){return e[a]}})}),r}var Rs,qn;function xr(){return qn||(qn=1,Rs=TypeError),Rs}const Xu={},Zu=Object.freeze(Object.defineProperty({__proto__:null,default:Xu},Symbol.toStringTag,{value:"Module"})),ep=Qu(Zu);var As,Vn;function ts(){if(Vn)return As;Vn=1;var e=typeof Map=="function"&&Map.prototype,t=Object.getOwnPropertyDescriptor&&e?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,r=e&&t&&typeof t.get=="function"?t.get:null,a=e&&Map.prototype.forEach,s=typeof Set=="function"&&Set.prototype,o=Object.getOwnPropertyDescriptor&&s?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,n=s&&o&&typeof o.get=="function"?o.get:null,i=s&&Set.prototype.forEach,l=typeof WeakMap=="function"&&WeakMap.prototype,d=l?WeakMap.prototype.has:null,c=typeof WeakSet=="function"&&WeakSet.prototype,u=c?WeakSet.prototype.has:null,p=typeof WeakRef=="function"&&WeakRef.prototype,m=p?WeakRef.prototype.deref:null,g=Boolean.prototype.valueOf,b=Object.prototype.toString,v=Function.prototype.toString,y=String.prototype.match,f=String.prototype.slice,x=String.prototype.replace,_=String.prototype.toUpperCase,C=String.prototype.toLowerCase,A=RegExp.prototype.test,I=Array.prototype.concat,M=Array.prototype.join,F=Array.prototype.slice,N=Math.floor,E=typeof BigInt=="function"?BigInt.prototype.valueOf:null,O=Object.getOwnPropertySymbols,B=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?Symbol.prototype.toString:null,H=typeof Symbol=="function"&&typeof Symbol.iterator=="object",P=typeof Symbol=="function"&&Symbol.toStringTag&&(typeof Symbol.toStringTag===H||!0)?Symbol.toStringTag:null,D=Object.prototype.propertyIsEnumerable,k=(typeof Reflect=="function"?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(w){return w.__proto__}:null);function T(w,S){if(w===1/0||w===-1/0||w!==w||w&&w>-1e3&&w<1e3||A.call(/e/,S))return S;var Q=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if(typeof w=="number"){var oe=w<0?-N(-w):N(w);if(oe!==w){var ne=String(oe),q=f.call(S,ne.length+1);return x.call(ne,Q,"$&_")+"."+x.call(x.call(q,/([0-9]{3})/g,"$&_"),/_$/,"")}}return x.call(S,Q,"$&_")}var L=ep,ae=L.custom,ce=xe(ae)?ae:null,Y={__proto__:null,double:'"',single:"'"},se={__proto__:null,double:/(["\\])/g,single:/(['\\])/g};As=function w(S,Q,oe,ne){var q=Q||{};if(Re(q,"quoteStyle")&&!Re(Y,q.quoteStyle))throw new TypeError('option "quoteStyle" must be "single" or "double"');if(Re(q,"maxStringLength")&&(typeof q.maxStringLength=="number"?q.maxStringLength<0&&q.maxStringLength!==1/0:q.maxStringLength!==null))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var mt=Re(q,"customInspect")?q.customInspect:!0;if(typeof mt!="boolean"&&mt!=="symbol")throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(Re(q,"indent")&&q.indent!==null&&q.indent!=="	"&&!(parseInt(q.indent,10)===q.indent&&q.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(Re(q,"numericSeparator")&&typeof q.numericSeparator!="boolean")throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var At=q.numericSeparator;if(typeof S>"u")return"undefined";if(S===null)return"null";if(typeof S=="boolean")return S?"true":"false";if(typeof S=="string")return vn(S,q);if(typeof S=="number"){if(S===0)return 1/0/S>0?"0":"-0";var ke=String(S);return At?T(S,ke):ke}if(typeof S=="bigint"){var gt=String(S)+"n";return At?T(S,gt):gt}var ms=typeof q.depth>"u"?5:q.depth;if(typeof oe>"u"&&(oe=0),oe>=ms&&ms>0&&typeof S=="object")return Xe(S)?"[Array]":"[Object]";var Yt=qd(q,oe);if(typeof ne>"u")ne=[];else if(pt(ne,S)>=0)return"[Circular]";function Ve(Kt,ga,zd){if(ga&&(ne=F.call(ne),ne.push(ga)),zd){var Cn={depth:q.depth};return Re(q,"quoteStyle")&&(Cn.quoteStyle=q.quoteStyle),w(Kt,Cn,oe+1,ne)}return w(Kt,q,oe+1,ne)}if(typeof S=="function"&&!me(S)){var bn=qt(S),xn=pa(S,Ve);return"[Function"+(bn?": "+bn:" (anonymous)")+"]"+(xn.length>0?" { "+M.call(xn,", ")+" }":"")}if(xe(S)){var _n=H?x.call(String(S),/^(Symbol\(.*\))_[^)]*$/,"$1"):B.call(S);return typeof S=="object"&&!H?Tr(_n):_n}if(Ud(S)){for(var Sr="<"+C.call(String(S.nodeName)),gs=S.attributes||[],ma=0;ma<gs.length;ma++)Sr+=" "+gs[ma].name+"="+Ce(Oe(gs[ma].value),"double",q);return Sr+=">",S.childNodes&&S.childNodes.length&&(Sr+="..."),Sr+="</"+C.call(String(S.nodeName))+">",Sr}if(Xe(S)){if(S.length===0)return"[]";var hs=pa(S,Ve);return Yt&&!Wd(hs)?"["+ps(hs,Yt)+"]":"[ "+M.call(hs,", ")+" ]"}if(z(S)){var fs=pa(S,Ve);return!("cause"in Error.prototype)&&"cause"in S&&!D.call(S,"cause")?"{ ["+String(S)+"] "+M.call(I.call("[cause]: "+Ve(S.cause),fs),", ")+" }":fs.length===0?"["+String(S)+"]":"{ ["+String(S)+"] "+M.call(fs,", ")+" }"}if(typeof S=="object"&&mt){if(ce&&typeof S[ce]=="function"&&L)return L(S,{depth:ms-oe});if(mt!=="symbol"&&typeof S.inspect=="function")return S.inspect()}if(qe(S)){var En=[];return a&&a.call(S,function(Kt,ga){En.push(Ve(ga,S,!0)+" => "+Ve(Kt,S))}),yn("Map",r.call(S),En,Yt)}if(Jt(S)){var wn=[];return i&&i.call(S,function(Kt){wn.push(Ve(Kt,S))}),yn("Set",n.call(S),wn,Yt)}if(Vt(S))return us("WeakMap");if(Hd(S))return us("WeakSet");if(zt(S))return us("WeakRef");if(J(S))return Tr(Ve(Number(S)));if(Ne(S))return Tr(Ve(E.call(S)));if(ge(S))return Tr(g.call(S));if(Z(S))return Tr(Ve(String(S)));if(typeof window<"u"&&S===window)return"{ [object Window] }";if(typeof globalThis<"u"&&S===globalThis||typeof Wn<"u"&&S===Wn)return"{ [object globalThis] }";if(!We(S)&&!me(S)){var vs=pa(S,Ve),Tn=k?k(S)===Object.prototype:S instanceof Object||S.constructor===Object,ys=S instanceof Object?"":"null prototype",Sn=!Tn&&P&&Object(S)===S&&P in S?f.call(Pe(S),8,-1):ys?"Object":"",Vd=Tn||typeof S.constructor!="function"?"":S.constructor.name?S.constructor.name+" ":"",bs=Vd+(Sn||ys?"["+M.call(I.call([],Sn||[],ys||[]),": ")+"] ":"");return vs.length===0?bs+"{}":Yt?bs+"{"+ps(vs,Yt)+"}":bs+"{ "+M.call(vs,", ")+" }"}return String(S)};function Ce(w,S,Q){var oe=Q.quoteStyle||S,ne=Y[oe];return ne+w+ne}function Oe(w){return x.call(String(w),/"/g,"&quot;")}function ve(w){return!P||!(typeof w=="object"&&(P in w||typeof w[P]<"u"))}function Xe(w){return Pe(w)==="[object Array]"&&ve(w)}function We(w){return Pe(w)==="[object Date]"&&ve(w)}function me(w){return Pe(w)==="[object RegExp]"&&ve(w)}function z(w){return Pe(w)==="[object Error]"&&ve(w)}function Z(w){return Pe(w)==="[object String]"&&ve(w)}function J(w){return Pe(w)==="[object Number]"&&ve(w)}function ge(w){return Pe(w)==="[object Boolean]"&&ve(w)}function xe(w){if(H)return w&&typeof w=="object"&&w instanceof Symbol;if(typeof w=="symbol")return!0;if(!w||typeof w!="object"||!B)return!1;try{return B.call(w),!0}catch{}return!1}function Ne(w){if(!w||typeof w!="object"||!E)return!1;try{return E.call(w),!0}catch{}return!1}var _e=Object.prototype.hasOwnProperty||function(w){return w in this};function Re(w,S){return _e.call(w,S)}function Pe(w){return b.call(w)}function qt(w){if(w.name)return w.name;var S=y.call(v.call(w),/^function\s*([\w$]+)/);return S?S[1]:null}function pt(w,S){if(w.indexOf)return w.indexOf(S);for(var Q=0,oe=w.length;Q<oe;Q++)if(w[Q]===S)return Q;return-1}function qe(w){if(!r||!w||typeof w!="object")return!1;try{r.call(w);try{n.call(w)}catch{return!0}return w instanceof Map}catch{}return!1}function Vt(w){if(!d||!w||typeof w!="object")return!1;try{d.call(w,d);try{u.call(w,u)}catch{return!0}return w instanceof WeakMap}catch{}return!1}function zt(w){if(!m||!w||typeof w!="object")return!1;try{return m.call(w),!0}catch{}return!1}function Jt(w){if(!n||!w||typeof w!="object")return!1;try{n.call(w);try{r.call(w)}catch{return!0}return w instanceof Set}catch{}return!1}function Hd(w){if(!u||!w||typeof w!="object")return!1;try{u.call(w,u);try{d.call(w,d)}catch{return!0}return w instanceof WeakSet}catch{}return!1}function Ud(w){return!w||typeof w!="object"?!1:typeof HTMLElement<"u"&&w instanceof HTMLElement?!0:typeof w.nodeName=="string"&&typeof w.getAttribute=="function"}function vn(w,S){if(w.length>S.maxStringLength){var Q=w.length-S.maxStringLength,oe="... "+Q+" more character"+(Q>1?"s":"");return vn(f.call(w,0,S.maxStringLength),S)+oe}var ne=se[S.quoteStyle||"single"];ne.lastIndex=0;var q=x.call(x.call(w,ne,"\\$1"),/[\x00-\x1f]/g,Gd);return Ce(q,"single",S)}function Gd(w){var S=w.charCodeAt(0),Q={8:"b",9:"t",10:"n",12:"f",13:"r"}[S];return Q?"\\"+Q:"\\x"+(S<16?"0":"")+_.call(S.toString(16))}function Tr(w){return"Object("+w+")"}function us(w){return w+" { ? }"}function yn(w,S,Q,oe){var ne=oe?ps(Q,oe):M.call(Q,", ");return w+" ("+S+") {"+ne+"}"}function Wd(w){for(var S=0;S<w.length;S++)if(pt(w[S],`
`)>=0)return!1;return!0}function qd(w,S){var Q;if(w.indent==="	")Q="	";else if(typeof w.indent=="number"&&w.indent>0)Q=M.call(Array(w.indent+1)," ");else return null;return{base:Q,prev:M.call(Array(S+1),Q)}}function ps(w,S){if(w.length===0)return"";var Q=`
`+S.prev+S.base;return Q+M.call(w,","+Q)+`
`+S.prev}function pa(w,S){var Q=Xe(w),oe=[];if(Q){oe.length=w.length;for(var ne=0;ne<w.length;ne++)oe[ne]=Re(w,ne)?S(w[ne],w):""}var q=typeof O=="function"?O(w):[],mt;if(H){mt={};for(var At=0;At<q.length;At++)mt["$"+q[At]]=q[At]}for(var ke in w)Re(w,ke)&&(Q&&String(Number(ke))===ke&&ke<w.length||H&&mt["$"+ke]instanceof Symbol||(A.call(/[^\w$]/,ke)?oe.push(S(ke,w)+": "+S(w[ke],w)):oe.push(ke+": "+S(w[ke],w))));if(typeof O=="function")for(var gt=0;gt<q.length;gt++)D.call(w,q[gt])&&oe.push("["+S(q[gt])+"]: "+S(w[q[gt]],w));return oe}return As}var Os,zn;function tp(){if(zn)return Os;zn=1;var e=ts(),t=xr(),r=function(i,l,d){for(var c=i,u;(u=c.next)!=null;c=u)if(u.key===l)return c.next=u.next,d||(u.next=i.next,i.next=u),u},a=function(i,l){if(i){var d=r(i,l);return d&&d.value}},s=function(i,l,d){var c=r(i,l);c?c.value=d:i.next={key:l,next:i.next,value:d}},o=function(i,l){return i?!!r(i,l):!1},n=function(i,l){if(i)return r(i,l,!0)};return Os=function(){var l,d={assert:function(c){if(!d.has(c))throw new t("Side channel does not contain "+e(c))},delete:function(c){var u=l&&l.next,p=n(l,c);return p&&u&&u===p&&(l=void 0),!!p},get:function(c){return a(l,c)},has:function(c){return o(l,c)},set:function(c,u){l||(l={next:void 0}),s(l,c,u)}};return d},Os}var ks,Jn;function ud(){return Jn||(Jn=1,ks=Object),ks}var Ds,Yn;function rp(){return Yn||(Yn=1,Ds=Error),Ds}var Ms,Kn;function ap(){return Kn||(Kn=1,Ms=EvalError),Ms}var Ns,Qn;function sp(){return Qn||(Qn=1,Ns=RangeError),Ns}var Ps,Xn;function op(){return Xn||(Xn=1,Ps=ReferenceError),Ps}var Ls,Zn;function np(){return Zn||(Zn=1,Ls=SyntaxError),Ls}var js,ei;function ip(){return ei||(ei=1,js=URIError),js}var Bs,ti;function lp(){return ti||(ti=1,Bs=Math.abs),Bs}var Fs,ri;function dp(){return ri||(ri=1,Fs=Math.floor),Fs}var $s,ai;function cp(){return ai||(ai=1,$s=Math.max),$s}var Hs,si;function up(){return si||(si=1,Hs=Math.min),Hs}var Us,oi;function pp(){return oi||(oi=1,Us=Math.pow),Us}var Gs,ni;function mp(){return ni||(ni=1,Gs=Math.round),Gs}var Ws,ii;function gp(){return ii||(ii=1,Ws=Number.isNaN||function(t){return t!==t}),Ws}var qs,li;function hp(){if(li)return qs;li=1;var e=gp();return qs=function(r){return e(r)||r===0?r:r<0?-1:1},qs}var Vs,di;function fp(){return di||(di=1,Vs=Object.getOwnPropertyDescriptor),Vs}var zs,ci;function pd(){if(ci)return zs;ci=1;var e=fp();if(e)try{e([],"length")}catch{e=null}return zs=e,zs}var Js,ui;function vp(){if(ui)return Js;ui=1;var e=Object.defineProperty||!1;if(e)try{e({},"a",{value:1})}catch{e=!1}return Js=e,Js}var Ys,pi;function yp(){return pi||(pi=1,Ys=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var t={},r=Symbol("test"),a=Object(r);if(typeof r=="string"||Object.prototype.toString.call(r)!=="[object Symbol]"||Object.prototype.toString.call(a)!=="[object Symbol]")return!1;var s=42;t[r]=s;for(var o in t)return!1;if(typeof Object.keys=="function"&&Object.keys(t).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(t).length!==0)return!1;var n=Object.getOwnPropertySymbols(t);if(n.length!==1||n[0]!==r||!Object.prototype.propertyIsEnumerable.call(t,r))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var i=Object.getOwnPropertyDescriptor(t,r);if(i.value!==s||i.enumerable!==!0)return!1}return!0}),Ys}var Ks,mi;function bp(){if(mi)return Ks;mi=1;var e=typeof Symbol<"u"&&Symbol,t=yp();return Ks=function(){return typeof e!="function"||typeof Symbol!="function"||typeof e("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:t()},Ks}var Qs,gi;function md(){return gi||(gi=1,Qs=typeof Reflect<"u"&&Reflect.getPrototypeOf||null),Qs}var Xs,hi;function gd(){if(hi)return Xs;hi=1;var e=ud();return Xs=e.getPrototypeOf||null,Xs}var Zs,fi;function xp(){if(fi)return Zs;fi=1;var e="Function.prototype.bind called on incompatible ",t=Object.prototype.toString,r=Math.max,a="[object Function]",s=function(l,d){for(var c=[],u=0;u<l.length;u+=1)c[u]=l[u];for(var p=0;p<d.length;p+=1)c[p+l.length]=d[p];return c},o=function(l,d){for(var c=[],u=d,p=0;u<l.length;u+=1,p+=1)c[p]=l[u];return c},n=function(i,l){for(var d="",c=0;c<i.length;c+=1)d+=i[c],c+1<i.length&&(d+=l);return d};return Zs=function(l){var d=this;if(typeof d!="function"||t.apply(d)!==a)throw new TypeError(e+d);for(var c=o(arguments,1),u,p=function(){if(this instanceof u){var y=d.apply(this,s(c,arguments));return Object(y)===y?y:this}return d.apply(l,s(c,arguments))},m=r(0,d.length-c.length),g=[],b=0;b<m;b++)g[b]="$"+b;if(u=Function("binder","return function ("+n(g,",")+"){ return binder.apply(this,arguments); }")(p),d.prototype){var v=function(){};v.prototype=d.prototype,u.prototype=new v,v.prototype=null}return u},Zs}var eo,vi;function rs(){if(vi)return eo;vi=1;var e=xp();return eo=Function.prototype.bind||e,eo}var to,yi;function en(){return yi||(yi=1,to=Function.prototype.call),to}var ro,bi;function hd(){return bi||(bi=1,ro=Function.prototype.apply),ro}var ao,xi;function _p(){return xi||(xi=1,ao=typeof Reflect<"u"&&Reflect&&Reflect.apply),ao}var so,_i;function Ep(){if(_i)return so;_i=1;var e=rs(),t=hd(),r=en(),a=_p();return so=a||e.call(r,t),so}var oo,Ei;function fd(){if(Ei)return oo;Ei=1;var e=rs(),t=xr(),r=en(),a=Ep();return oo=function(o){if(o.length<1||typeof o[0]!="function")throw new t("a function is required");return a(e,r,o)},oo}var no,wi;function wp(){if(wi)return no;wi=1;var e=fd(),t=pd(),r;try{r=[].__proto__===Array.prototype}catch(n){if(!n||typeof n!="object"||!("code"in n)||n.code!=="ERR_PROTO_ACCESS")throw n}var a=!!r&&t&&t(Object.prototype,"__proto__"),s=Object,o=s.getPrototypeOf;return no=a&&typeof a.get=="function"?e([a.get]):typeof o=="function"?function(i){return o(i==null?i:s(i))}:!1,no}var io,Ti;function Tp(){if(Ti)return io;Ti=1;var e=md(),t=gd(),r=wp();return io=e?function(s){return e(s)}:t?function(s){if(!s||typeof s!="object"&&typeof s!="function")throw new TypeError("getProto: not an object");return t(s)}:r?function(s){return r(s)}:null,io}var lo,Si;function Sp(){if(Si)return lo;Si=1;var e=Function.prototype.call,t=Object.prototype.hasOwnProperty,r=rs();return lo=r.call(e,t),lo}var co,Ci;function tn(){if(Ci)return co;Ci=1;var e,t=ud(),r=rp(),a=ap(),s=sp(),o=op(),n=np(),i=xr(),l=ip(),d=lp(),c=dp(),u=cp(),p=up(),m=pp(),g=mp(),b=hp(),v=Function,y=function(me){try{return v('"use strict"; return ('+me+").constructor;")()}catch{}},f=pd(),x=vp(),_=function(){throw new i},C=f?(function(){try{return arguments.callee,_}catch{try{return f(arguments,"callee").get}catch{return _}}})():_,A=bp()(),I=Tp(),M=gd(),F=md(),N=hd(),E=en(),O={},B=typeof Uint8Array>"u"||!I?e:I(Uint8Array),H={__proto__:null,"%AggregateError%":typeof AggregateError>"u"?e:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?e:ArrayBuffer,"%ArrayIteratorPrototype%":A&&I?I([][Symbol.iterator]()):e,"%AsyncFromSyncIteratorPrototype%":e,"%AsyncFunction%":O,"%AsyncGenerator%":O,"%AsyncGeneratorFunction%":O,"%AsyncIteratorPrototype%":O,"%Atomics%":typeof Atomics>"u"?e:Atomics,"%BigInt%":typeof BigInt>"u"?e:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?e:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?e:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?e:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":r,"%eval%":eval,"%EvalError%":a,"%Float16Array%":typeof Float16Array>"u"?e:Float16Array,"%Float32Array%":typeof Float32Array>"u"?e:Float32Array,"%Float64Array%":typeof Float64Array>"u"?e:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?e:FinalizationRegistry,"%Function%":v,"%GeneratorFunction%":O,"%Int8Array%":typeof Int8Array>"u"?e:Int8Array,"%Int16Array%":typeof Int16Array>"u"?e:Int16Array,"%Int32Array%":typeof Int32Array>"u"?e:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":A&&I?I(I([][Symbol.iterator]())):e,"%JSON%":typeof JSON=="object"?JSON:e,"%Map%":typeof Map>"u"?e:Map,"%MapIteratorPrototype%":typeof Map>"u"||!A||!I?e:I(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":t,"%Object.getOwnPropertyDescriptor%":f,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?e:Promise,"%Proxy%":typeof Proxy>"u"?e:Proxy,"%RangeError%":s,"%ReferenceError%":o,"%Reflect%":typeof Reflect>"u"?e:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?e:Set,"%SetIteratorPrototype%":typeof Set>"u"||!A||!I?e:I(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?e:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":A&&I?I(""[Symbol.iterator]()):e,"%Symbol%":A?Symbol:e,"%SyntaxError%":n,"%ThrowTypeError%":C,"%TypedArray%":B,"%TypeError%":i,"%Uint8Array%":typeof Uint8Array>"u"?e:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?e:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?e:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?e:Uint32Array,"%URIError%":l,"%WeakMap%":typeof WeakMap>"u"?e:WeakMap,"%WeakRef%":typeof WeakRef>"u"?e:WeakRef,"%WeakSet%":typeof WeakSet>"u"?e:WeakSet,"%Function.prototype.call%":E,"%Function.prototype.apply%":N,"%Object.defineProperty%":x,"%Object.getPrototypeOf%":M,"%Math.abs%":d,"%Math.floor%":c,"%Math.max%":u,"%Math.min%":p,"%Math.pow%":m,"%Math.round%":g,"%Math.sign%":b,"%Reflect.getPrototypeOf%":F};if(I)try{null.error}catch(me){var P=I(I(me));H["%Error.prototype%"]=P}var D=function me(z){var Z;if(z==="%AsyncFunction%")Z=y("async function () {}");else if(z==="%GeneratorFunction%")Z=y("function* () {}");else if(z==="%AsyncGeneratorFunction%")Z=y("async function* () {}");else if(z==="%AsyncGenerator%"){var J=me("%AsyncGeneratorFunction%");J&&(Z=J.prototype)}else if(z==="%AsyncIteratorPrototype%"){var ge=me("%AsyncGenerator%");ge&&I&&(Z=I(ge.prototype))}return H[z]=Z,Z},k={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},T=rs(),L=Sp(),ae=T.call(E,Array.prototype.concat),ce=T.call(N,Array.prototype.splice),Y=T.call(E,String.prototype.replace),se=T.call(E,String.prototype.slice),Ce=T.call(E,RegExp.prototype.exec),Oe=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,ve=/\\(\\)?/g,Xe=function(z){var Z=se(z,0,1),J=se(z,-1);if(Z==="%"&&J!=="%")throw new n("invalid intrinsic syntax, expected closing `%`");if(J==="%"&&Z!=="%")throw new n("invalid intrinsic syntax, expected opening `%`");var ge=[];return Y(z,Oe,function(xe,Ne,_e,Re){ge[ge.length]=_e?Y(Re,ve,"$1"):Ne||xe}),ge},We=function(z,Z){var J=z,ge;if(L(k,J)&&(ge=k[J],J="%"+ge[0]+"%"),L(H,J)){var xe=H[J];if(xe===O&&(xe=D(J)),typeof xe>"u"&&!Z)throw new i("intrinsic "+z+" exists, but is not available. Please file an issue!");return{alias:ge,name:J,value:xe}}throw new n("intrinsic "+z+" does not exist!")};return co=function(z,Z){if(typeof z!="string"||z.length===0)throw new i("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof Z!="boolean")throw new i('"allowMissing" argument must be a boolean');if(Ce(/^%?[^%]*%?$/,z)===null)throw new n("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var J=Xe(z),ge=J.length>0?J[0]:"",xe=We("%"+ge+"%",Z),Ne=xe.name,_e=xe.value,Re=!1,Pe=xe.alias;Pe&&(ge=Pe[0],ce(J,ae([0,1],Pe)));for(var qt=1,pt=!0;qt<J.length;qt+=1){var qe=J[qt],Vt=se(qe,0,1),zt=se(qe,-1);if((Vt==='"'||Vt==="'"||Vt==="`"||zt==='"'||zt==="'"||zt==="`")&&Vt!==zt)throw new n("property names with quotes must have matching quotes");if((qe==="constructor"||!pt)&&(Re=!0),ge+="."+qe,Ne="%"+ge+"%",L(H,Ne))_e=H[Ne];else if(_e!=null){if(!(qe in _e)){if(!Z)throw new i("base intrinsic for "+z+" exists, but the property is not available.");return}if(f&&qt+1>=J.length){var Jt=f(_e,qe);pt=!!Jt,pt&&"get"in Jt&&!("originalValue"in Jt.get)?_e=Jt.get:_e=_e[qe]}else pt=L(_e,qe),_e=_e[qe];pt&&!Re&&(H[Ne]=_e)}}return _e},co}var uo,Ii;function vd(){if(Ii)return uo;Ii=1;var e=tn(),t=fd(),r=t([e("%String.prototype.indexOf%")]);return uo=function(s,o){var n=e(s,!!o);return typeof n=="function"&&r(s,".prototype.")>-1?t([n]):n},uo}var po,Ri;function yd(){if(Ri)return po;Ri=1;var e=tn(),t=vd(),r=ts(),a=xr(),s=e("%Map%",!0),o=t("Map.prototype.get",!0),n=t("Map.prototype.set",!0),i=t("Map.prototype.has",!0),l=t("Map.prototype.delete",!0),d=t("Map.prototype.size",!0);return po=!!s&&function(){var u,p={assert:function(m){if(!p.has(m))throw new a("Side channel does not contain "+r(m))},delete:function(m){if(u){var g=l(u,m);return d(u)===0&&(u=void 0),g}return!1},get:function(m){if(u)return o(u,m)},has:function(m){return u?i(u,m):!1},set:function(m,g){u||(u=new s),n(u,m,g)}};return p},po}var mo,Ai;function Cp(){if(Ai)return mo;Ai=1;var e=tn(),t=vd(),r=ts(),a=yd(),s=xr(),o=e("%WeakMap%",!0),n=t("WeakMap.prototype.get",!0),i=t("WeakMap.prototype.set",!0),l=t("WeakMap.prototype.has",!0),d=t("WeakMap.prototype.delete",!0);return mo=o?function(){var u,p,m={assert:function(g){if(!m.has(g))throw new s("Side channel does not contain "+r(g))},delete:function(g){if(o&&g&&(typeof g=="object"||typeof g=="function")){if(u)return d(u,g)}else if(a&&p)return p.delete(g);return!1},get:function(g){return o&&g&&(typeof g=="object"||typeof g=="function")&&u?n(u,g):p&&p.get(g)},has:function(g){return o&&g&&(typeof g=="object"||typeof g=="function")&&u?l(u,g):!!p&&p.has(g)},set:function(g,b){o&&g&&(typeof g=="object"||typeof g=="function")?(u||(u=new o),i(u,g,b)):a&&(p||(p=a()),p.set(g,b))}};return m}:a,mo}var go,Oi;function Ip(){if(Oi)return go;Oi=1;var e=xr(),t=ts(),r=tp(),a=yd(),s=Cp(),o=s||a||r;return go=function(){var i,l={assert:function(d){if(!l.has(d))throw new e("Side channel does not contain "+t(d))},delete:function(d){return!!i&&i.delete(d)},get:function(d){return i&&i.get(d)},has:function(d){return!!i&&i.has(d)},set:function(d,c){i||(i=o()),i.set(d,c)}};return l},go}var ho,ki;function rn(){if(ki)return ho;ki=1;var e=String.prototype.replace,t=/%20/g,r={RFC1738:"RFC1738",RFC3986:"RFC3986"};return ho={default:r.RFC3986,formatters:{RFC1738:function(a){return e.call(a,t,"+")},RFC3986:function(a){return String(a)}},RFC1738:r.RFC1738,RFC3986:r.RFC3986},ho}var fo,Di;function bd(){if(Di)return fo;Di=1;var e=rn(),t=Object.prototype.hasOwnProperty,r=Array.isArray,a=(function(){for(var v=[],y=0;y<256;++y)v.push("%"+((y<16?"0":"")+y.toString(16)).toUpperCase());return v})(),s=function(y){for(;y.length>1;){var f=y.pop(),x=f.obj[f.prop];if(r(x)){for(var _=[],C=0;C<x.length;++C)typeof x[C]<"u"&&_.push(x[C]);f.obj[f.prop]=_}}},o=function(y,f){for(var x=f&&f.plainObjects?{__proto__:null}:{},_=0;_<y.length;++_)typeof y[_]<"u"&&(x[_]=y[_]);return x},n=function v(y,f,x){if(!f)return y;if(typeof f!="object"&&typeof f!="function"){if(r(y))y.push(f);else if(y&&typeof y=="object")(x&&(x.plainObjects||x.allowPrototypes)||!t.call(Object.prototype,f))&&(y[f]=!0);else return[y,f];return y}if(!y||typeof y!="object")return[y].concat(f);var _=y;return r(y)&&!r(f)&&(_=o(y,x)),r(y)&&r(f)?(f.forEach(function(C,A){if(t.call(y,A)){var I=y[A];I&&typeof I=="object"&&C&&typeof C=="object"?y[A]=v(I,C,x):y.push(C)}else y[A]=C}),y):Object.keys(f).reduce(function(C,A){var I=f[A];return t.call(C,A)?C[A]=v(C[A],I,x):C[A]=I,C},_)},i=function(y,f){return Object.keys(f).reduce(function(x,_){return x[_]=f[_],x},y)},l=function(v,y,f){var x=v.replace(/\+/g," ");if(f==="iso-8859-1")return x.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(x)}catch{return x}},d=1024,c=function(y,f,x,_,C){if(y.length===0)return y;var A=y;if(typeof y=="symbol"?A=Symbol.prototype.toString.call(y):typeof y!="string"&&(A=String(y)),x==="iso-8859-1")return escape(A).replace(/%u[0-9a-f]{4}/gi,function(B){return"%26%23"+parseInt(B.slice(2),16)+"%3B"});for(var I="",M=0;M<A.length;M+=d){for(var F=A.length>=d?A.slice(M,M+d):A,N=[],E=0;E<F.length;++E){var O=F.charCodeAt(E);if(O===45||O===46||O===95||O===126||O>=48&&O<=57||O>=65&&O<=90||O>=97&&O<=122||C===e.RFC1738&&(O===40||O===41)){N[N.length]=F.charAt(E);continue}if(O<128){N[N.length]=a[O];continue}if(O<2048){N[N.length]=a[192|O>>6]+a[128|O&63];continue}if(O<55296||O>=57344){N[N.length]=a[224|O>>12]+a[128|O>>6&63]+a[128|O&63];continue}E+=1,O=65536+((O&1023)<<10|F.charCodeAt(E)&1023),N[N.length]=a[240|O>>18]+a[128|O>>12&63]+a[128|O>>6&63]+a[128|O&63]}I+=N.join("")}return I},u=function(y){for(var f=[{obj:{o:y},prop:"o"}],x=[],_=0;_<f.length;++_)for(var C=f[_],A=C.obj[C.prop],I=Object.keys(A),M=0;M<I.length;++M){var F=I[M],N=A[F];typeof N=="object"&&N!==null&&x.indexOf(N)===-1&&(f.push({obj:A,prop:F}),x.push(N))}return s(f),y},p=function(y){return Object.prototype.toString.call(y)==="[object RegExp]"},m=function(y){return!y||typeof y!="object"?!1:!!(y.constructor&&y.constructor.isBuffer&&y.constructor.isBuffer(y))},g=function(y,f){return[].concat(y,f)},b=function(y,f){if(r(y)){for(var x=[],_=0;_<y.length;_+=1)x.push(f(y[_]));return x}return f(y)};return fo={arrayToObject:o,assign:i,combine:g,compact:u,decode:l,encode:c,isBuffer:m,isRegExp:p,maybeMap:b,merge:n},fo}var vo,Mi;function Rp(){if(Mi)return vo;Mi=1;var e=Ip(),t=bd(),r=rn(),a=Object.prototype.hasOwnProperty,s={brackets:function(v){return v+"[]"},comma:"comma",indices:function(v,y){return v+"["+y+"]"},repeat:function(v){return v}},o=Array.isArray,n=Array.prototype.push,i=function(b,v){n.apply(b,o(v)?v:[v])},l=Date.prototype.toISOString,d=r.default,c={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,commaRoundTrip:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:t.encode,encodeValuesOnly:!1,filter:void 0,format:d,formatter:r.formatters[d],indices:!1,serializeDate:function(v){return l.call(v)},skipNulls:!1,strictNullHandling:!1},u=function(v){return typeof v=="string"||typeof v=="number"||typeof v=="boolean"||typeof v=="symbol"||typeof v=="bigint"},p={},m=function b(v,y,f,x,_,C,A,I,M,F,N,E,O,B,H,P,D,k){for(var T=v,L=k,ae=0,ce=!1;(L=L.get(p))!==void 0&&!ce;){var Y=L.get(v);if(ae+=1,typeof Y<"u"){if(Y===ae)throw new RangeError("Cyclic object value");ce=!0}typeof L.get(p)>"u"&&(ae=0)}if(typeof F=="function"?T=F(y,T):T instanceof Date?T=O(T):f==="comma"&&o(T)&&(T=t.maybeMap(T,function(Ne){return Ne instanceof Date?O(Ne):Ne})),T===null){if(C)return M&&!P?M(y,c.encoder,D,"key",B):y;T=""}if(u(T)||t.isBuffer(T)){if(M){var se=P?y:M(y,c.encoder,D,"key",B);return[H(se)+"="+H(M(T,c.encoder,D,"value",B))]}return[H(y)+"="+H(String(T))]}var Ce=[];if(typeof T>"u")return Ce;var Oe;if(f==="comma"&&o(T))P&&M&&(T=t.maybeMap(T,M)),Oe=[{value:T.length>0?T.join(",")||null:void 0}];else if(o(F))Oe=F;else{var ve=Object.keys(T);Oe=N?ve.sort(N):ve}var Xe=I?String(y).replace(/\./g,"%2E"):String(y),We=x&&o(T)&&T.length===1?Xe+"[]":Xe;if(_&&o(T)&&T.length===0)return We+"[]";for(var me=0;me<Oe.length;++me){var z=Oe[me],Z=typeof z=="object"&&z&&typeof z.value<"u"?z.value:T[z];if(!(A&&Z===null)){var J=E&&I?String(z).replace(/\./g,"%2E"):String(z),ge=o(T)?typeof f=="function"?f(We,J):We:We+(E?"."+J:"["+J+"]");k.set(v,ae);var xe=e();xe.set(p,k),i(Ce,b(Z,ge,f,x,_,C,A,I,f==="comma"&&P&&o(T)?null:M,F,N,E,O,B,H,P,D,xe))}}return Ce},g=function(v){if(!v)return c;if(typeof v.allowEmptyArrays<"u"&&typeof v.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof v.encodeDotInKeys<"u"&&typeof v.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(v.encoder!==null&&typeof v.encoder<"u"&&typeof v.encoder!="function")throw new TypeError("Encoder has to be a function.");var y=v.charset||c.charset;if(typeof v.charset<"u"&&v.charset!=="utf-8"&&v.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var f=r.default;if(typeof v.format<"u"){if(!a.call(r.formatters,v.format))throw new TypeError("Unknown format option provided.");f=v.format}var x=r.formatters[f],_=c.filter;(typeof v.filter=="function"||o(v.filter))&&(_=v.filter);var C;if(v.arrayFormat in s?C=v.arrayFormat:"indices"in v?C=v.indices?"indices":"repeat":C=c.arrayFormat,"commaRoundTrip"in v&&typeof v.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");var A=typeof v.allowDots>"u"?v.encodeDotInKeys===!0?!0:c.allowDots:!!v.allowDots;return{addQueryPrefix:typeof v.addQueryPrefix=="boolean"?v.addQueryPrefix:c.addQueryPrefix,allowDots:A,allowEmptyArrays:typeof v.allowEmptyArrays=="boolean"?!!v.allowEmptyArrays:c.allowEmptyArrays,arrayFormat:C,charset:y,charsetSentinel:typeof v.charsetSentinel=="boolean"?v.charsetSentinel:c.charsetSentinel,commaRoundTrip:!!v.commaRoundTrip,delimiter:typeof v.delimiter>"u"?c.delimiter:v.delimiter,encode:typeof v.encode=="boolean"?v.encode:c.encode,encodeDotInKeys:typeof v.encodeDotInKeys=="boolean"?v.encodeDotInKeys:c.encodeDotInKeys,encoder:typeof v.encoder=="function"?v.encoder:c.encoder,encodeValuesOnly:typeof v.encodeValuesOnly=="boolean"?v.encodeValuesOnly:c.encodeValuesOnly,filter:_,format:f,formatter:x,serializeDate:typeof v.serializeDate=="function"?v.serializeDate:c.serializeDate,skipNulls:typeof v.skipNulls=="boolean"?v.skipNulls:c.skipNulls,sort:typeof v.sort=="function"?v.sort:null,strictNullHandling:typeof v.strictNullHandling=="boolean"?v.strictNullHandling:c.strictNullHandling}};return vo=function(b,v){var y=b,f=g(v),x,_;typeof f.filter=="function"?(_=f.filter,y=_("",y)):o(f.filter)&&(_=f.filter,x=_);var C=[];if(typeof y!="object"||y===null)return"";var A=s[f.arrayFormat],I=A==="comma"&&f.commaRoundTrip;x||(x=Object.keys(y)),f.sort&&x.sort(f.sort);for(var M=e(),F=0;F<x.length;++F){var N=x[F],E=y[N];f.skipNulls&&E===null||i(C,m(E,N,A,I,f.allowEmptyArrays,f.strictNullHandling,f.skipNulls,f.encodeDotInKeys,f.encode?f.encoder:null,f.filter,f.sort,f.allowDots,f.serializeDate,f.format,f.formatter,f.encodeValuesOnly,f.charset,M))}var O=C.join(f.delimiter),B=f.addQueryPrefix===!0?"?":"";return f.charsetSentinel&&(f.charset==="iso-8859-1"?B+="utf8=%26%2310003%3B&":B+="utf8=%E2%9C%93&"),O.length>0?B+O:""},vo}var yo,Ni;function Ap(){if(Ni)return yo;Ni=1;var e=bd(),t=Object.prototype.hasOwnProperty,r=Array.isArray,a={allowDots:!1,allowEmptyArrays:!1,allowPrototypes:!1,allowSparse:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decodeDotInKeys:!1,decoder:e.decode,delimiter:"&",depth:5,duplicates:"combine",ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictDepth:!1,strictNullHandling:!1,throwOnLimitExceeded:!1},s=function(p){return p.replace(/&#(\d+);/g,function(m,g){return String.fromCharCode(parseInt(g,10))})},o=function(p,m,g){if(p&&typeof p=="string"&&m.comma&&p.indexOf(",")>-1)return p.split(",");if(m.throwOnLimitExceeded&&g>=m.arrayLimit)throw new RangeError("Array limit exceeded. Only "+m.arrayLimit+" element"+(m.arrayLimit===1?"":"s")+" allowed in an array.");return p},n="utf8=%26%2310003%3B",i="utf8=%E2%9C%93",l=function(m,g){var b={__proto__:null},v=g.ignoreQueryPrefix?m.replace(/^\?/,""):m;v=v.replace(/%5B/gi,"[").replace(/%5D/gi,"]");var y=g.parameterLimit===1/0?void 0:g.parameterLimit,f=v.split(g.delimiter,g.throwOnLimitExceeded?y+1:y);if(g.throwOnLimitExceeded&&f.length>y)throw new RangeError("Parameter limit exceeded. Only "+y+" parameter"+(y===1?"":"s")+" allowed.");var x=-1,_,C=g.charset;if(g.charsetSentinel)for(_=0;_<f.length;++_)f[_].indexOf("utf8=")===0&&(f[_]===i?C="utf-8":f[_]===n&&(C="iso-8859-1"),x=_,_=f.length);for(_=0;_<f.length;++_)if(_!==x){var A=f[_],I=A.indexOf("]="),M=I===-1?A.indexOf("="):I+1,F,N;M===-1?(F=g.decoder(A,a.decoder,C,"key"),N=g.strictNullHandling?null:""):(F=g.decoder(A.slice(0,M),a.decoder,C,"key"),N=e.maybeMap(o(A.slice(M+1),g,r(b[F])?b[F].length:0),function(O){return g.decoder(O,a.decoder,C,"value")})),N&&g.interpretNumericEntities&&C==="iso-8859-1"&&(N=s(String(N))),A.indexOf("[]=")>-1&&(N=r(N)?[N]:N);var E=t.call(b,F);E&&g.duplicates==="combine"?b[F]=e.combine(b[F],N):(!E||g.duplicates==="last")&&(b[F]=N)}return b},d=function(p,m,g,b){var v=0;if(p.length>0&&p[p.length-1]==="[]"){var y=p.slice(0,-1).join("");v=Array.isArray(m)&&m[y]?m[y].length:0}for(var f=b?m:o(m,g,v),x=p.length-1;x>=0;--x){var _,C=p[x];if(C==="[]"&&g.parseArrays)_=g.allowEmptyArrays&&(f===""||g.strictNullHandling&&f===null)?[]:e.combine([],f);else{_=g.plainObjects?{__proto__:null}:{};var A=C.charAt(0)==="["&&C.charAt(C.length-1)==="]"?C.slice(1,-1):C,I=g.decodeDotInKeys?A.replace(/%2E/g,"."):A,M=parseInt(I,10);!g.parseArrays&&I===""?_={0:f}:!isNaN(M)&&C!==I&&String(M)===I&&M>=0&&g.parseArrays&&M<=g.arrayLimit?(_=[],_[M]=f):I!=="__proto__"&&(_[I]=f)}f=_}return f},c=function(m,g,b,v){if(m){var y=b.allowDots?m.replace(/\.([^.[]+)/g,"[$1]"):m,f=/(\[[^[\]]*])/,x=/(\[[^[\]]*])/g,_=b.depth>0&&f.exec(y),C=_?y.slice(0,_.index):y,A=[];if(C){if(!b.plainObjects&&t.call(Object.prototype,C)&&!b.allowPrototypes)return;A.push(C)}for(var I=0;b.depth>0&&(_=x.exec(y))!==null&&I<b.depth;){if(I+=1,!b.plainObjects&&t.call(Object.prototype,_[1].slice(1,-1))&&!b.allowPrototypes)return;A.push(_[1])}if(_){if(b.strictDepth===!0)throw new RangeError("Input depth exceeded depth option of "+b.depth+" and strictDepth is true");A.push("["+y.slice(_.index)+"]")}return d(A,g,b,v)}},u=function(m){if(!m)return a;if(typeof m.allowEmptyArrays<"u"&&typeof m.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof m.decodeDotInKeys<"u"&&typeof m.decodeDotInKeys!="boolean")throw new TypeError("`decodeDotInKeys` option can only be `true` or `false`, when provided");if(m.decoder!==null&&typeof m.decoder<"u"&&typeof m.decoder!="function")throw new TypeError("Decoder has to be a function.");if(typeof m.charset<"u"&&m.charset!=="utf-8"&&m.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");if(typeof m.throwOnLimitExceeded<"u"&&typeof m.throwOnLimitExceeded!="boolean")throw new TypeError("`throwOnLimitExceeded` option must be a boolean");var g=typeof m.charset>"u"?a.charset:m.charset,b=typeof m.duplicates>"u"?a.duplicates:m.duplicates;if(b!=="combine"&&b!=="first"&&b!=="last")throw new TypeError("The duplicates option must be either combine, first, or last");var v=typeof m.allowDots>"u"?m.decodeDotInKeys===!0?!0:a.allowDots:!!m.allowDots;return{allowDots:v,allowEmptyArrays:typeof m.allowEmptyArrays=="boolean"?!!m.allowEmptyArrays:a.allowEmptyArrays,allowPrototypes:typeof m.allowPrototypes=="boolean"?m.allowPrototypes:a.allowPrototypes,allowSparse:typeof m.allowSparse=="boolean"?m.allowSparse:a.allowSparse,arrayLimit:typeof m.arrayLimit=="number"?m.arrayLimit:a.arrayLimit,charset:g,charsetSentinel:typeof m.charsetSentinel=="boolean"?m.charsetSentinel:a.charsetSentinel,comma:typeof m.comma=="boolean"?m.comma:a.comma,decodeDotInKeys:typeof m.decodeDotInKeys=="boolean"?m.decodeDotInKeys:a.decodeDotInKeys,decoder:typeof m.decoder=="function"?m.decoder:a.decoder,delimiter:typeof m.delimiter=="string"||e.isRegExp(m.delimiter)?m.delimiter:a.delimiter,depth:typeof m.depth=="number"||m.depth===!1?+m.depth:a.depth,duplicates:b,ignoreQueryPrefix:m.ignoreQueryPrefix===!0,interpretNumericEntities:typeof m.interpretNumericEntities=="boolean"?m.interpretNumericEntities:a.interpretNumericEntities,parameterLimit:typeof m.parameterLimit=="number"?m.parameterLimit:a.parameterLimit,parseArrays:m.parseArrays!==!1,plainObjects:typeof m.plainObjects=="boolean"?m.plainObjects:a.plainObjects,strictDepth:typeof m.strictDepth=="boolean"?!!m.strictDepth:a.strictDepth,strictNullHandling:typeof m.strictNullHandling=="boolean"?m.strictNullHandling:a.strictNullHandling,throwOnLimitExceeded:typeof m.throwOnLimitExceeded=="boolean"?m.throwOnLimitExceeded:!1}};return yo=function(p,m){var g=u(m);if(p===""||p===null||typeof p>"u")return g.plainObjects?{__proto__:null}:{};for(var b=typeof p=="string"?l(p,g):p,v=g.plainObjects?{__proto__:null}:{},y=Object.keys(b),f=0;f<y.length;++f){var x=y[f],_=c(x,b[x],g,typeof p=="string");v=e.merge(v,_,g)}return g.allowSparse===!0?v:e.compact(v)},yo}var bo,Pi;function Op(){if(Pi)return bo;Pi=1;var e=Rp(),t=Ap(),r=rn();return bo={formats:r,parse:t,stringify:e},bo}var kp=Op();const an=["apiKey","idempotencyKey","stripeAccount","apiVersion","maxNetworkRetries","timeout","host","authenticator","stripeContext","additionalHeaders","streaming"];function xd(e){return e&&typeof e=="object"&&an.some(t=>Object.prototype.hasOwnProperty.call(e,t))}function as(e,t){return kp.stringify(e,{serializeDate:r=>Math.floor(r.getTime()/1e3).toString(),arrayFormat:t=="v2"?"repeat":"indices"}).replace(/%5B/g,"[").replace(/%5D/g,"]")}const Go=(()=>{const e={"\n":"\\n",'"':'\\"',"\u2028":"\\u2028","\u2029":"\\u2029"};return t=>{const r=t.replace(/["\n\r\u2028\u2029]/g,a=>e[a]);return a=>r.replace(/\{([\s\S]+?)\}/g,(s,o)=>{const n=a[o];return Dp(n)?encodeURIComponent(n):""})}})();function Dp(e){return["number","string","boolean"].includes(typeof e)}function Mp(e){const t=e.match(/\{\w+\}/g);return t?t.map(r=>r.replace(/[{}]/g,"")):[]}function sn(e){if(!Array.isArray(e)||!e[0]||typeof e[0]!="object")return{};if(!xd(e[0]))return e.shift();const t=Object.keys(e[0]),r=t.filter(a=>an.includes(a));return r.length>0&&r.length!==t.length&&qa(`Options found in arguments (${r.join(", ")}). Did you mean to pass an options object? See https://github.com/stripe/stripe-node/wiki/Passing-Options.`),{}}function _d(e){const t={host:null,headers:{},settings:{},streaming:!1};if(e.length>0){const r=e[e.length-1];if(typeof r=="string")t.authenticator=Wo(e.pop());else if(xd(r)){const a=Object.assign({},e.pop()),s=Object.keys(a).filter(o=>!an.includes(o));if(s.length&&qa(`Invalid options found (${s.join(", ")}); ignoring.`),a.apiKey&&(t.authenticator=Wo(a.apiKey)),a.idempotencyKey&&(t.headers["Idempotency-Key"]=a.idempotencyKey),a.stripeAccount&&(t.headers["Stripe-Account"]=a.stripeAccount),a.stripeContext){if(t.headers["Stripe-Account"])throw new Error("Can't specify both stripeAccount and stripeContext.");t.headers["Stripe-Context"]=a.stripeContext}if(a.apiVersion&&(t.headers["Stripe-Version"]=a.apiVersion),Number.isInteger(a.maxNetworkRetries)&&(t.settings.maxNetworkRetries=a.maxNetworkRetries),Number.isInteger(a.timeout)&&(t.settings.timeout=a.timeout),a.host&&(t.host=a.host),a.authenticator){if(a.apiKey)throw new Error("Can't specify both apiKey and authenticator.");if(typeof a.authenticator!="function")throw new Error("The authenticator must be a function receiving a request as the first parameter.");t.authenticator=a.authenticator}a.additionalHeaders&&(t.headers=a.additionalHeaders),a.streaming&&(t.streaming=!0)}}return t}function Np(e){const t=this,r=Object.prototype.hasOwnProperty.call(e,"constructor")?e.constructor:function(...a){t.apply(this,a)};return Object.assign(r,t),r.prototype=Object.create(t.prototype),Object.assign(r.prototype,e),r}function xo(e){if(typeof e!="object")throw new Error("Argument must be an object");return Object.keys(e).reduce((t,r)=>(e[r]!=null&&(t[r]=e[r]),t),{})}function Pp(e){return e&&typeof e=="object"?Object.keys(e).reduce((t,r)=>(t[Lp(r)]=e[r],t),{}):e}function Lp(e){return e.split("-").map(t=>t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()).join("-")}function on(e,t){return t?e.then(r=>{setTimeout(()=>{t(null,r)},0)},r=>{setTimeout(()=>{t(r,null)},0)}):e}function jp(e){return e==="OAuth"?"oauth":e[0].toLowerCase()+e.substring(1)}function qa(e){return typeof process.emitWarning!="function"?console.warn(`Stripe: ${e}`):process.emitWarning(e,"Stripe")}function Bp(e){const t=typeof e;return(t==="function"||t==="object")&&!!e}function Fp(e){const t={},r=(a,s)=>{Object.entries(a).forEach(([o,n])=>{const i=s?`${s}[${o}]`:o;if(Bp(n)){if(!(n instanceof Uint8Array)&&!Object.prototype.hasOwnProperty.call(n,"data"))return r(n,i);t[i]=n}else t[i]=String(n)})};return r(e,null),t}function _o(e,t,r){if(!Number.isInteger(t)){if(r!==void 0)return r;throw new Error(`${e} must be an integer`)}return t}function $p(){return typeof process>"u"?{}:{lang_version:process.version,platform:process.platform}}function Wo(e){const t=r=>(r.headers.Authorization="Bearer "+e,Promise.resolve());return t._apiKey=e,t}function Hp(e,t){return this[e]instanceof Date?Math.floor(this[e].getTime()/1e3).toString():t}function Up(e){return JSON.stringify(e,Hp)}function nn(e){return e&&e.startsWith("/v2")?"v2":"v1"}function qo(e){return Array.isArray(e)?e.join(", "):String(e)}function Gp(e){const t=Array.isArray(e)?e[0]:e;return Number(t)}function Wp(e){return Object.entries(e).map(([t,r])=>[t,qo(r)])}class je{getClientName(){throw new Error("getClientName not implemented.")}makeRequest(t,r,a,s,o,n,i,l){throw new Error("makeRequest not implemented.")}static makeTimeoutError(){const t=new TypeError(je.TIMEOUT_ERROR_CODE);return t.code=je.TIMEOUT_ERROR_CODE,t}}je.CONNECTION_CLOSED_ERROR_CODES=["ECONNRESET","EPIPE"];je.TIMEOUT_ERROR_CODE="ETIMEDOUT";class Ed{constructor(t,r){this._statusCode=t,this._headers=r}getStatusCode(){return this._statusCode}getHeaders(){return this._headers}getRawResponse(){throw new Error("getRawResponse not implemented.")}toStream(t){throw new Error("toStream not implemented.")}toJSON(){throw new Error("toJSON not implemented.")}}class Va extends je{constructor(t){if(super(),!t){if(!globalThis.fetch)throw new Error("fetch() function not provided and is not defined in the global scope. You must provide a fetch implementation.");t=globalThis.fetch}globalThis.AbortController?this._fetchFn=Va.makeFetchWithAbortTimeout(t):this._fetchFn=Va.makeFetchWithRaceTimeout(t)}static makeFetchWithRaceTimeout(t){return(r,a,s)=>{let o;const n=new Promise((l,d)=>{o=setTimeout(()=>{o=null,d(je.makeTimeoutError())},s)}),i=t(r,a);return Promise.race([i,n]).finally(()=>{o&&clearTimeout(o)})}}static makeFetchWithAbortTimeout(t){return async(r,a,s)=>{const o=new AbortController;let n=setTimeout(()=>{n=null,o.abort(je.makeTimeoutError())},s);try{return await t(r,Object.assign(Object.assign({},a),{signal:o.signal}))}catch(i){throw i.name==="AbortError"?je.makeTimeoutError():i}finally{n&&clearTimeout(n)}}}getClientName(){return"fetch"}async makeRequest(t,r,a,s,o,n,i,l){const d=i==="http",c=new URL(a,`${d?"http":"https"}://${t}`);c.port=r;const u=s=="POST"||s=="PUT"||s=="PATCH",p=n||(u?"":void 0),m=await this._fetchFn(c.toString(),{method:s,headers:Wp(o),body:p},l);return new ln(m)}}class ln extends Ed{constructor(t){super(t.status,ln._transformHeadersToObject(t.headers)),this._res=t}getRawResponse(){return this._res}toStream(t){return t(),this._res.body}toJSON(){return this._res.json()}static _transformHeadersToObject(t){const r={};for(const a of t){if(!Array.isArray(a)||a.length!=2)throw new Error("Response objects produced by the fetch function given to FetchHttpClient do not have an iterable headers map. Response#headers should be an iterable object.");r[a[0]]=a[1]}return r}}class wd{computeHMACSignature(t,r){throw new Error("computeHMACSignature not implemented.")}computeHMACSignatureAsync(t,r){throw new Error("computeHMACSignatureAsync not implemented.")}computeSHA256Async(t){throw new Error("computeSHA256 not implemented.")}}class Td extends Error{}class qp extends wd{constructor(t){super(),this.subtleCrypto=t||crypto.subtle}computeHMACSignature(t,r){throw new Td("SubtleCryptoProvider cannot be used in a synchronous context.")}async computeHMACSignatureAsync(t,r){const a=new TextEncoder,s=await this.subtleCrypto.importKey("raw",a.encode(r),{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),o=await this.subtleCrypto.sign("hmac",s,a.encode(t)),n=new Uint8Array(o),i=new Array(n.length);for(let l=0;l<n.length;l++)i[l]=Vo[n[l]];return i.join("")}async computeSHA256Async(t){return new Uint8Array(await this.subtleCrypto.digest("SHA-256",t))}}const Vo=new Array(256);for(let e=0;e<Vo.length;e++)Vo[e]=e.toString(16).padStart(2,"0");class Vp{constructor(){this._fetchFn=null,this._agent=null}getUname(){throw new Error("getUname not implemented.")}uuid4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const r=Math.random()*16|0;return(t==="x"?r:r&3|8).toString(16)})}secureCompare(t,r){if(t.length!==r.length)return!1;const a=t.length;let s=0;for(let o=0;o<a;++o)s|=t.charCodeAt(o)^r.charCodeAt(o);return s===0}createEmitter(){throw new Error("createEmitter not implemented.")}tryBufferData(t){throw new Error("tryBufferData not implemented.")}createNodeHttpClient(t){throw new Error("createNodeHttpClient not implemented.")}createFetchHttpClient(t){return new Va(t)}createDefaultHttpClient(){throw new Error("createDefaultHttpClient not implemented.")}createNodeCryptoProvider(){throw new Error("createNodeCryptoProvider not implemented.")}createSubtleCryptoProvider(t){return new qp(t)}createDefaultCryptoProvider(){throw new Error("createDefaultCryptoProvider not implemented.")}}class zp extends Event{constructor(t,r){super(t),this.data=r}}class Jp{constructor(){this.eventTarget=new EventTarget,this.listenerMapping=new Map}on(t,r){const a=s=>{r(s.data)};return this.listenerMapping.set(r,a),this.eventTarget.addEventListener(t,a)}removeListener(t,r){const a=this.listenerMapping.get(r);return this.listenerMapping.delete(r),this.eventTarget.removeEventListener(t,a)}once(t,r){const a=s=>{r(s.data)};return this.listenerMapping.set(r,a),this.eventTarget.addEventListener(t,a,{once:!0})}emit(t,r){return this.eventTarget.dispatchEvent(new zp(t,r))}}class Yp extends Vp{getUname(){return Promise.resolve(null)}createEmitter(){return new Jp}tryBufferData(t){if(t.file.data instanceof ReadableStream)throw new Error("Uploading a file as a stream is not supported in non-Node environments. Please open or upvote an issue at github.com/stripe/stripe-node if you use this, detailing your use-case.");return Promise.resolve(t)}createNodeHttpClient(){throw new Error("Stripe: `createNodeHttpClient()` is not available in non-Node environments. Please use `createFetchHttpClient()` instead.")}createDefaultHttpClient(){return super.createFetchHttpClient()}createNodeCryptoProvider(){throw new Error("Stripe: `createNodeCryptoProvider()` is not available in non-Node environments. Please use `createSubtleCryptoProvider()` instead.")}createDefaultCryptoProvider(){return this.createSubtleCryptoProvider()}}const ss=e=>{switch(e.type){case"card_error":return new Cd(e);case"invalid_request_error":return new dn(e);case"api_error":return new cn(e);case"authentication_error":return new un(e);case"rate_limit_error":return new pn(e);case"idempotency_error":return new Ad(e);case"invalid_grant":return new Od(e);default:return new kd(e)}},Sd=e=>{switch(e.type){case"temporary_session_expired":return new Dd(e)}switch(e.code){case"invalid_fields":return new dn(e)}return ss(e)};class Te extends Error{constructor(t={},r=null){var a;super(t.message),this.type=r||this.constructor.name,this.raw=t,this.rawType=t.type,this.code=t.code,this.doc_url=t.doc_url,this.param=t.param,this.detail=t.detail,this.headers=t.headers,this.requestId=t.requestId,this.statusCode=t.statusCode,this.message=(a=t.message)!==null&&a!==void 0?a:"",this.userMessage=t.user_message,this.charge=t.charge,this.decline_code=t.decline_code,this.payment_intent=t.payment_intent,this.payment_method=t.payment_method,this.payment_method_type=t.payment_method_type,this.setup_intent=t.setup_intent,this.source=t.source}}Te.generate=ss;class Cd extends Te{constructor(t={}){super(t,"StripeCardError")}}class dn extends Te{constructor(t={}){super(t,"StripeInvalidRequestError")}}class cn extends Te{constructor(t={}){super(t,"StripeAPIError")}}class un extends Te{constructor(t={}){super(t,"StripeAuthenticationError")}}class Id extends Te{constructor(t={}){super(t,"StripePermissionError")}}class pn extends Te{constructor(t={}){super(t,"StripeRateLimitError")}}class Rd extends Te{constructor(t={}){super(t,"StripeConnectionError")}}class yt extends Te{constructor(t,r,a={}){super(a,"StripeSignatureVerificationError"),this.header=t,this.payload=r}}class Ad extends Te{constructor(t={}){super(t,"StripeIdempotencyError")}}class Od extends Te{constructor(t={}){super(t,"StripeInvalidGrantError")}}class kd extends Te{constructor(t={}){super(t,"StripeUnknownError")}}class Dd extends Te{constructor(t={}){super(t,"TemporarySessionExpiredError")}}const Li=Object.freeze(Object.defineProperty({__proto__:null,StripeAPIError:cn,StripeAuthenticationError:un,StripeCardError:Cd,StripeConnectionError:Rd,StripeError:Te,StripeIdempotencyError:Ad,StripeInvalidGrantError:Od,StripeInvalidRequestError:dn,StripePermissionError:Id,StripeRateLimitError:pn,StripeSignatureVerificationError:yt,StripeUnknownError:kd,TemporarySessionExpiredError:Dd,generateV1Error:ss,generateV2Error:Sd},Symbol.toStringTag,{value:"Module"})),Kp=60;class Yr{constructor(t,r){this._stripe=t,this._maxBufferedRequestMetric=r}_normalizeStripeContext(t,r){return t?t.toString()||null:(r==null?void 0:r.toString())||null}_addHeadersDirectlyToObject(t,r){t.requestId=r["request-id"],t.stripeAccount=t.stripeAccount||r["stripe-account"],t.apiVersion=t.apiVersion||r["stripe-version"],t.idempotencyKey=t.idempotencyKey||r["idempotency-key"]}_makeResponseEvent(t,r,a){const s=Date.now(),o=s-t.request_start_time;return xo({api_version:a["stripe-version"],account:a["stripe-account"],idempotency_key:a["idempotency-key"],method:t.method,path:t.path,status:r,request_id:this._getRequestId(a),elapsed:o,request_start_time:t.request_start_time,request_end_time:s})}_getRequestId(t){return t["request-id"]}_streamingResponseHandler(t,r,a){return s=>{const o=s.getHeaders(),n=()=>{const l=this._makeResponseEvent(t,s.getStatusCode(),o);this._stripe._emitter.emit("response",l),this._recordRequestMetrics(this._getRequestId(o),l.elapsed,r)},i=s.toStream(n);return this._addHeadersDirectlyToObject(i,o),a(null,i)}}_jsonResponseHandler(t,r,a,s){return o=>{const n=o.getHeaders(),i=this._getRequestId(n),l=o.getStatusCode(),d=this._makeResponseEvent(t,l,n);this._stripe._emitter.emit("response",d),o.toJSON().then(c=>{if(c.error){let u;throw typeof c.error=="string"&&(c.error={type:c.error,message:c.error_description}),c.error.headers=n,c.error.statusCode=l,c.error.requestId=i,l===401?u=new un(c.error):l===403?u=new Id(c.error):l===429?u=new pn(c.error):r==="v2"?u=Sd(c.error):u=ss(c.error),u}return c},c=>{throw new cn({message:"Invalid JSON received from the Stripe API",exception:c,requestId:n["request-id"]})}).then(c=>{this._recordRequestMetrics(i,d.elapsed,a);const u=o.getRawResponse();this._addHeadersDirectlyToObject(u,n),Object.defineProperty(c,"lastResponse",{enumerable:!1,writable:!1,value:u}),s(null,c)},c=>s(c,null))}}static _generateConnectionErrorMessage(t){return`An error occurred with our connection to Stripe.${t>0?` Request was retried ${t} times.`:""}`}static _shouldRetry(t,r,a,s){return s&&r===0&&je.CONNECTION_CLOSED_ERROR_CODES.includes(s.code)?!0:r>=a?!1:t?t.getHeaders()["stripe-should-retry"]==="false"?!1:t.getHeaders()["stripe-should-retry"]==="true"||t.getStatusCode()===409||t.getStatusCode()>=500:!0}_getSleepTimeInMS(t,r=null){const a=this._stripe.getInitialNetworkRetryDelay(),s=this._stripe.getMaxNetworkRetryDelay();let o=Math.min(a*Math.pow(2,t-1),s);return o*=.5*(1+Math.random()),o=Math.max(a,o),Number.isInteger(r)&&r<=Kp&&(o=Math.max(o,r)),o*1e3}_getMaxNetworkRetries(t={}){return t.maxNetworkRetries!==void 0&&Number.isInteger(t.maxNetworkRetries)?t.maxNetworkRetries:this._stripe.getMaxNetworkRetries()}_defaultIdempotencyKey(t,r,a){const s=this._getMaxNetworkRetries(r),o=()=>`stripe-node-retry-${this._stripe._platformFunctions.uuid4()}`;if(a==="v2"){if(t==="POST"||t==="DELETE")return o()}else if(a==="v1"&&t==="POST"&&s>0)return o();return null}_makeHeaders({contentType:t,contentLength:r,apiVersion:a,clientUserAgent:s,method:o,userSuppliedHeaders:n,userSuppliedSettings:i,stripeAccount:l,stripeContext:d,apiMode:c}){const u={Accept:"application/json","Content-Type":t,"User-Agent":this._getUserAgentString(c),"X-Stripe-Client-User-Agent":s,"X-Stripe-Client-Telemetry":this._getTelemetryHeader(),"Stripe-Version":a,"Stripe-Account":l,"Stripe-Context":d,"Idempotency-Key":this._defaultIdempotencyKey(o,i,c)},p=o=="POST"||o=="PUT"||o=="PATCH";return(p||r)&&(p||qa(`${o} method had non-zero contentLength but no payload is expected for this verb`),u["Content-Length"]=r),Object.assign(xo(u),Pp(n))}_getUserAgentString(t){const r=this._stripe.getConstant("PACKAGE_VERSION"),a=this._stripe._appInfo?this._stripe.getAppInfoAsString():"";return`Stripe/${t} NodeBindings/${r} ${a}`.trim()}_getTelemetryHeader(){if(this._stripe.getTelemetryEnabled()&&this._stripe._prevRequestMetrics.length>0){const t=this._stripe._prevRequestMetrics.shift();return JSON.stringify({last_request_metrics:t})}}_recordRequestMetrics(t,r,a){if(this._stripe.getTelemetryEnabled()&&t)if(this._stripe._prevRequestMetrics.length>this._maxBufferedRequestMetric)qa("Request metrics buffer is full, dropping telemetry message.");else{const s={request_id:t,request_duration_ms:r};a&&a.length>0&&(s.usage=a),this._stripe._prevRequestMetrics.push(s)}}_rawRequest(t,r,a,s,o){return new Promise((i,l)=>{let d;try{const g=t.toUpperCase();if(g!=="POST"&&a&&Object.keys(a).length!==0)throw new Error("rawRequest only supports params on POST requests. Please pass null and add your parameters to path.");const b=[].slice.call([a,s]),v=sn(b),y=g==="POST"?Object.assign({},v):null,f=_d(b),x=f.headers,_=f.authenticator;d={requestMethod:g,requestPath:r,bodyData:y,queryData:{},authenticator:_,headers:x,host:f.host,streaming:!!f.streaming,settings:{},usage:o||["raw_request"]}}catch(g){l(g);return}function c(g,b){g?l(g):i(b)}const{headers:u,settings:p}=d,m=d.authenticator;this._request(d.requestMethod,d.host,r,d.bodyData,m,{headers:u,settings:p,streaming:d.streaming},d.usage,c)})}_request(t,r,a,s,o,n,i=[],l,d=null){var c;let u;o=(c=o??this._stripe._authenticator)!==null&&c!==void 0?c:null;const p=nn(a),m=(v,y,f,x,_)=>setTimeout(v,this._getSleepTimeInMS(x,_),y,f,x+1),g=(v,y,f)=>{const x=n.settings&&n.settings.timeout&&Number.isInteger(n.settings.timeout)&&n.settings.timeout>=0?n.settings.timeout:this._stripe.getApiField("timeout"),_={host:r||this._stripe.getApiField("host"),port:this._stripe.getApiField("port"),path:a,method:t,headers:Object.assign({},y),body:u,protocol:this._stripe.getApiField("protocol")};o(_).then(()=>{const C=this._stripe.getApiField("httpClient").makeRequest(_.host,_.port,_.path,_.method,_.headers,_.body,_.protocol,x),A=Date.now(),I=xo({api_version:v,account:qo(y["Stripe-Account"]),idempotency_key:qo(y["Idempotency-Key"]),method:t,path:a,request_start_time:A}),M=f||0,F=this._getMaxNetworkRetries(n.settings||{});this._stripe._emitter.emit("request",I),C.then(N=>Yr._shouldRetry(N,M,F)?m(g,v,y,M,Gp(N.getHeaders()["retry-after"])):n.streaming&&N.getStatusCode()<400?this._streamingResponseHandler(I,i,l)(N):this._jsonResponseHandler(I,p,i,l)(N)).catch(N=>{if(Yr._shouldRetry(null,M,F,N))return m(g,v,y,M,null);{const E=N.code&&N.code===je.TIMEOUT_ERROR_CODE;return l(new Rd({message:E?`Request aborted due to timeout being reached (${x}ms)`:Yr._generateConnectionErrorMessage(M),detail:N}))}})}).catch(C=>{throw new Te({message:"Unable to authenticate the request",exception:C})})},b=(v,y)=>{if(v)return l(v);u=y,this._stripe.getClientUserAgent(f=>{var x,_,C;const A=this._stripe.getApiField("version"),I=this._makeHeaders({contentType:p=="v2"?"application/json":"application/x-www-form-urlencoded",contentLength:u.length,apiVersion:A,clientUserAgent:f,method:t,userSuppliedHeaders:(x=n.headers)!==null&&x!==void 0?x:null,userSuppliedSettings:(_=n.settings)!==null&&_!==void 0?_:{},stripeAccount:(C=n.stripeAccount)!==null&&C!==void 0?C:this._stripe.getApiField("stripeAccount"),stripeContext:this._normalizeStripeContext(n.stripeContext,this._stripe.getApiField("stripeContext")),apiMode:p});g(A,I,0)})};if(d)d(t,s,n.headers,b);else{let v;p=="v2"?v=s?Up(s):"":v=as(s||{},p),b(null,v)}}}class Md{constructor(t,r,a,s){this.index=0,this.pagePromise=t,this.promiseCache={currentPromise:null},this.requestArgs=r,this.spec=a,this.stripeResource=s}async iterate(t){if(!(t&&t.data&&typeof t.data.length=="number"))throw Error("Unexpected: Stripe API response does not have a well-formed `data` array.");const r=Nd(this.requestArgs);if(this.index<t.data.length){const a=r?t.data.length-1-this.index:this.index,s=t.data[a];return this.index+=1,{value:s,done:!1}}else if(t.has_more){this.index=0,this.pagePromise=this.getNextPage(t);const a=await this.pagePromise;return this.iterate(a)}return{done:!0,value:void 0}}getNextPage(t){throw new Error("Unimplemented")}async _next(){return this.iterate(await this.pagePromise)}next(){if(this.promiseCache.currentPromise)return this.promiseCache.currentPromise;const t=(async()=>{const r=await this._next();return this.promiseCache.currentPromise=null,r})();return this.promiseCache.currentPromise=t,t}}class Qp extends Md{getNextPage(t){const r=Nd(this.requestArgs),a=sm(t,r);return this.stripeResource._makeRequest(this.requestArgs,this.spec,{[r?"ending_before":"starting_after"]:a})}}class Xp extends Md{getNextPage(t){if(!t.next_page)throw Error("Unexpected: Stripe API response does not have a well-formed `next_page` field, but `has_more` was true.");return this.stripeResource._makeRequest(this.requestArgs,this.spec,{page:t.next_page})}}class Zp{constructor(t,r,a,s){this.currentPageIterator=(async()=>(await t).data[Symbol.iterator]())(),this.nextPageUrl=(async()=>(await t).next_page_url||null)(),this.requestArgs=r,this.spec=a,this.stripeResource=s}async turnPage(){const t=await this.nextPageUrl;if(!t)return null;this.spec.fullPath=t;const r=await this.stripeResource._makeRequest([],this.spec,{});return this.nextPageUrl=Promise.resolve(r.next_page_url),this.currentPageIterator=Promise.resolve(r.data[Symbol.iterator]()),this.currentPageIterator}async next(){{const a=(await this.currentPageIterator).next();if(!a.done)return{done:!1,value:a.value}}const t=await this.turnPage();if(!t)return{done:!0,value:void 0};const r=t.next();return r.done?{done:!0,value:void 0}:{done:!1,value:r.value}}}const em=(e,t,r,a)=>{const s=nn(r.fullPath||r.path);return s!=="v2"&&r.methodType==="search"?Eo(new Xp(a,t,r,e)):s!=="v2"&&r.methodType==="list"?Eo(new Qp(a,t,r,e)):s==="v2"&&r.methodType==="list"?Eo(new Zp(a,t,r,e)):null},Eo=e=>{const t=om((...s)=>e.next(...s)),r=nm(t),a={autoPagingEach:t,autoPagingToArray:r,next:()=>e.next(),return:()=>({}),[tm()]:()=>a};return a};function tm(){return typeof Symbol<"u"&&Symbol.asyncIterator?Symbol.asyncIterator:"@@asyncIterator"}function rm(e){if(e.length<2)return null;const t=e[1];if(typeof t!="function")throw Error(`The second argument to autoPagingEach, if present, must be a callback function; received ${typeof t}`);return t}function am(e){if(e.length===0)return;const t=e[0];if(typeof t!="function")throw Error(`The first argument to autoPagingEach, if present, must be a callback function; received ${typeof t}`);if(t.length===2)return t;if(t.length>2)throw Error(`The \`onItem\` callback function passed to autoPagingEach must accept at most two arguments; got ${t}`);return function(a,s){const o=t(a);s(o)}}function sm(e,t){const r=t?0:e.data.length-1,a=e.data[r],s=a&&a.id;if(!s)throw Error("Unexpected: No `id` found on the last item while auto-paging a list.");return s}function om(e){return function(){const r=[].slice.call(arguments),a=am(r),s=rm(r);if(r.length>2)throw Error(`autoPagingEach takes up to two arguments; received ${r}`);const o=im(e,a);return on(o,s)}}function nm(e){return function(r,a){const s=r&&r.limit;if(!s)throw Error("You must pass a `limit` option to autoPagingToArray, e.g., `autoPagingToArray({limit: 1000});`.");if(s>1e4)throw Error("You cannot specify a limit of more than 10,000 items to fetch in `autoPagingToArray`; use `autoPagingEach` to iterate through longer lists.");const o=new Promise((n,i)=>{const l=[];e(d=>{if(l.push(d),l.length>=s)return!1}).then(()=>{n(l)}).catch(i)});return on(o,a)}}function im(e,t){return new Promise((r,a)=>{function s(o){if(o.done){r();return}const n=o.value;return new Promise(i=>{t(n,i)}).then(i=>i===!1?s({done:!0,value:void 0}):e().then(s))}e().then(s).catch(a)})}function Nd(e){const t=[].slice.call(e);return!!sn(t).ending_before}function lm(e){if(e.path!==void 0&&e.fullPath!==void 0)throw new Error(`Method spec specified both a 'path' (${e.path}) and a 'fullPath' (${e.fullPath}).`);return function(...t){const r=typeof t[t.length-1]=="function"&&t.pop();e.urlParams=Mp(e.fullPath||this.createResourcePathWithSymbols(e.path||""));const a=on(this._makeRequest(t,e,{}),r);return Object.assign(a,em(this,t,e,a)),a}}h.extend=Np;h.method=lm;h.MAX_BUFFERED_REQUEST_METRICS=100;function h(e,t){if(this._stripe=e,t)throw new Error("Support for curried url params was dropped in stripe-node v7.0.0. Instead, pass two ids.");this.basePath=Go(this.basePath||e.getApiField("basePath")),this.resourcePath=this.path,this.path=Go(this.path),this.initialize(...arguments)}h.prototype={_stripe:null,path:"",resourcePath:"",basePath:null,initialize(){},requestDataProcessor:null,validateRequest:null,createFullPath(e,t){const r=[this.basePath(t),this.path(t)];if(typeof e=="function"){const a=e(t);a&&r.push(a)}else r.push(e);return this._joinUrlParts(r)},createResourcePathWithSymbols(e){return e?`/${this._joinUrlParts([this.resourcePath,e])}`:`/${this.resourcePath}`},_joinUrlParts(e){return e.join("/").replace(/\/{2,}/g,"/")},_getRequestOpts(e,t,r){var a;const s=(t.method||"GET").toUpperCase(),o=t.usage||[],n=t.urlParams||[],i=t.encode||(I=>I),l=!!t.fullPath,d=Go(l?t.fullPath:t.path||""),c=l?t.fullPath:this.createResourcePathWithSymbols(t.path),u=[].slice.call(e),p=n.reduce((I,M)=>{const F=u.shift();if(typeof F!="string")throw new Error(`Stripe: Argument "${M}" must be a string, but got: ${F} (on API request to \`${s} ${c}\`)`);return I[M]=F,I},{}),m=sn(u),g=i(Object.assign({},m,r)),b=_d(u),v=b.host||t.host,y=!!t.streaming||!!b.streaming;if(u.filter(I=>I!=null).length)throw new Error(`Stripe: Unknown arguments (${u}). Did you mean to pass an options object? See https://github.com/stripe/stripe-node/wiki/Passing-Options. (on API request to ${s} \`${c}\`)`);const f=l?d(p):this.createFullPath(d,p),x=Object.assign(b.headers,t.headers);t.validator&&t.validator(g,{headers:x});const _=t.method==="GET"||t.method==="DELETE";return{requestMethod:s,requestPath:f,bodyData:_?null:g,queryData:_?g:{},authenticator:(a=b.authenticator)!==null&&a!==void 0?a:null,headers:x,host:v??null,streaming:y,settings:b.settings,usage:o}},_makeRequest(e,t,r){return new Promise((a,s)=>{var o;let n;try{n=this._getRequestOpts(e,t,r)}catch(p){s(p);return}function i(p,m){p?s(p):a(t.transformResponseData?t.transformResponseData(m):m)}const l=Object.keys(n.queryData).length===0,d=[n.requestPath,l?"":"?",as(n.queryData,nn(n.requestPath))].join(""),{headers:c,settings:u}=n;this._stripe._requestSender._request(n.requestMethod,n.host,d,n.bodyData,n.authenticator,{headers:c,settings:u,streaming:n.streaming},n.usage,i,(o=this.requestDataProcessor)===null||o===void 0?void 0:o.bind(this))})}};class jt{constructor(t=[]){this._segments=[...t]}get segments(){return[...this._segments]}push(t){if(!t)throw new Error("Segment cannot be null or undefined");return new jt([...this._segments,t])}pop(){if(this._segments.length===0)throw new Error("Cannot pop from an empty context");return new jt(this._segments.slice(0,-1))}toString(){return this._segments.join("/")}static parse(t){return t?new jt(t.split("/")):new jt([])}}function dm(e){const t={DEFAULT_TOLERANCE:300,signature:null,constructEvent(c,u,p,m,g,b){try{if(!this.signature)throw new Error("ERR: missing signature helper, unable to verify");this.signature.verifyHeader(c,u,p,m||t.DEFAULT_TOLERANCE,g,b)}catch(y){throw y instanceof Td&&(y.message+="\nUse `await constructEventAsync(...)` instead of `constructEvent(...)`"),y}return c instanceof Uint8Array?JSON.parse(new TextDecoder("utf8").decode(c)):JSON.parse(c)},async constructEventAsync(c,u,p,m,g,b){if(!this.signature)throw new Error("ERR: missing signature helper, unable to verify");return await this.signature.verifyHeaderAsync(c,u,p,m||t.DEFAULT_TOLERANCE,g,b),c instanceof Uint8Array?JSON.parse(new TextDecoder("utf8").decode(c)):JSON.parse(c)},generateTestHeaderString:function(c){const u=d(c),p=u.signature||u.cryptoProvider.computeHMACSignature(u.payloadString,u.secret);return u.generateHeaderString(p)},generateTestHeaderStringAsync:async function(c){const u=d(c),p=u.signature||await u.cryptoProvider.computeHMACSignatureAsync(u.payloadString,u.secret);return u.generateHeaderString(p)}},r={EXPECTED_SCHEME:"v1",verifyHeader(c,u,p,m,g,b){const{decodedHeader:v,decodedPayload:y,details:f,suspectPayloadType:x}=s(c,u,this.EXPECTED_SCHEME),_=/\s/.test(p);g=g||l();const C=g.computeHMACSignature(a(y,f),p);return o(y,v,f,C,m,x,_,b),!0},async verifyHeaderAsync(c,u,p,m,g,b){const{decodedHeader:v,decodedPayload:y,details:f,suspectPayloadType:x}=s(c,u,this.EXPECTED_SCHEME),_=/\s/.test(p);g=g||l();const C=await g.computeHMACSignatureAsync(a(y,f),p);return o(y,v,f,C,m,x,_,b)}};function a(c,u){return`${u.timestamp}.${c}`}function s(c,u,p){if(!c)throw new yt(u,c,{message:"No webhook payload was provided."});const m=typeof c!="string"&&!(c instanceof Uint8Array),g=new TextDecoder("utf8"),b=c instanceof Uint8Array?g.decode(c):c;if(Array.isArray(u))throw new Error("Unexpected: An array was passed as a header, which should not be possible for the stripe-signature header.");if(u==null||u=="")throw new yt(u,c,{message:"No stripe-signature header value was provided."});const v=u instanceof Uint8Array?g.decode(u):u,y=n(v,p);if(!y||y.timestamp===-1)throw new yt(v,b,{message:"Unable to extract timestamp and signatures from header"});if(!y.signatures.length)throw new yt(v,b,{message:"No signatures found with expected scheme"});return{decodedPayload:b,decodedHeader:v,details:y,suspectPayloadType:m}}function o(c,u,p,m,g,b,v,y){const f=!!p.signatures.filter(e.secureCompare.bind(e,m)).length,x=`
Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature`,_=v?`

Note: The provided signing secret contains whitespace. This often indicates an extra newline or space is in the value`:"";if(!f)throw b?new yt(u,c,{message:`Webhook payload must be provided as a string or a Buffer (https://nodejs.org/api/buffer.html) instance representing the _raw_ request body.Payload was provided as a parsed JavaScript object instead. 
Signature verification is impossible without access to the original signed material. 
`+x+`
`+_}):new yt(u,c,{message:`No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.
`+x+`
`+_});const C=Math.floor((typeof y=="number"?y:Date.now())/1e3)-p.timestamp;if(g>0&&C>g)throw new yt(u,c,{message:"Timestamp outside the tolerance zone"});return!0}function n(c,u){return typeof c!="string"?null:c.split(",").reduce((p,m)=>{const g=m.split("=");return g[0]==="t"&&(p.timestamp=parseInt(g[1],10)),g[0]===u&&p.signatures.push(g[1]),p},{timestamp:-1,signatures:[]})}let i=null;function l(){return i||(i=e.createDefaultCryptoProvider()),i}function d(c){if(!c)throw new Te({message:"Options are required"});const u=Math.floor(c.timestamp)||Math.floor(Date.now()/1e3),p=c.scheme||r.EXPECTED_SCHEME,m=c.cryptoProvider||l(),g=`${u}.${c.payload}`,b=v=>`t=${u},${p}=${v}`;return Object.assign(Object.assign({},c),{timestamp:u,scheme:p,cryptoProvider:m,payloadString:g,generateHeaderString:b})}return t.signature=r,t}const Pd="2025-09-30.clover";function cm(e,t){for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const a=r[0].toLowerCase()+r.substring(1),s=new t[r](e);this[a]=s}}function ie(e,t){return function(r){return new cm(r,t)}}const Ot=h.method,um=h.extend({retrieve:Ot({method:"GET",fullPath:"/v1/financial_connections/accounts/{account}"}),list:Ot({method:"GET",fullPath:"/v1/financial_connections/accounts",methodType:"list"}),disconnect:Ot({method:"POST",fullPath:"/v1/financial_connections/accounts/{account}/disconnect"}),listOwners:Ot({method:"GET",fullPath:"/v1/financial_connections/accounts/{account}/owners",methodType:"list"}),refresh:Ot({method:"POST",fullPath:"/v1/financial_connections/accounts/{account}/refresh"}),subscribe:Ot({method:"POST",fullPath:"/v1/financial_connections/accounts/{account}/subscribe"}),unsubscribe:Ot({method:"POST",fullPath:"/v1/financial_connections/accounts/{account}/unsubscribe"})}),ji=h.method,pm=h.extend({retrieve:ji({method:"GET",fullPath:"/v1/entitlements/active_entitlements/{id}"}),list:ji({method:"GET",fullPath:"/v1/entitlements/active_entitlements",methodType:"list"})}),Xt=h.method,mm=h.extend({create:Xt({method:"POST",fullPath:"/v1/billing/alerts"}),retrieve:Xt({method:"GET",fullPath:"/v1/billing/alerts/{id}"}),list:Xt({method:"GET",fullPath:"/v1/billing/alerts",methodType:"list"}),activate:Xt({method:"POST",fullPath:"/v1/billing/alerts/{id}/activate"}),archive:Xt({method:"POST",fullPath:"/v1/billing/alerts/{id}/archive"}),deactivate:Xt({method:"POST",fullPath:"/v1/billing/alerts/{id}/deactivate"})}),Ir=h.method,gm=h.extend({retrieve:Ir({method:"GET",fullPath:"/v1/issuing/authorizations/{authorization}"}),update:Ir({method:"POST",fullPath:"/v1/issuing/authorizations/{authorization}"}),list:Ir({method:"GET",fullPath:"/v1/issuing/authorizations",methodType:"list"}),approve:Ir({method:"POST",fullPath:"/v1/issuing/authorizations/{authorization}/approve"}),decline:Ir({method:"POST",fullPath:"/v1/issuing/authorizations/{authorization}/decline"})}),kt=h.method,hm=h.extend({create:kt({method:"POST",fullPath:"/v1/test_helpers/issuing/authorizations"}),capture:kt({method:"POST",fullPath:"/v1/test_helpers/issuing/authorizations/{authorization}/capture"}),expire:kt({method:"POST",fullPath:"/v1/test_helpers/issuing/authorizations/{authorization}/expire"}),finalizeAmount:kt({method:"POST",fullPath:"/v1/test_helpers/issuing/authorizations/{authorization}/finalize_amount"}),increment:kt({method:"POST",fullPath:"/v1/test_helpers/issuing/authorizations/{authorization}/increment"}),respond:kt({method:"POST",fullPath:"/v1/test_helpers/issuing/authorizations/{authorization}/fraud_challenges/respond"}),reverse:kt({method:"POST",fullPath:"/v1/test_helpers/issuing/authorizations/{authorization}/reverse"})}),wo=h.method,fm=h.extend({create:wo({method:"POST",fullPath:"/v1/tax/calculations"}),retrieve:wo({method:"GET",fullPath:"/v1/tax/calculations/{calculation}"}),listLineItems:wo({method:"GET",fullPath:"/v1/tax/calculations/{calculation}/line_items",methodType:"list"})}),fa=h.method,vm=h.extend({create:fa({method:"POST",fullPath:"/v1/issuing/cardholders"}),retrieve:fa({method:"GET",fullPath:"/v1/issuing/cardholders/{cardholder}"}),update:fa({method:"POST",fullPath:"/v1/issuing/cardholders/{cardholder}"}),list:fa({method:"GET",fullPath:"/v1/issuing/cardholders",methodType:"list"})}),va=h.method,ym=h.extend({create:va({method:"POST",fullPath:"/v1/issuing/cards"}),retrieve:va({method:"GET",fullPath:"/v1/issuing/cards/{card}"}),update:va({method:"POST",fullPath:"/v1/issuing/cards/{card}"}),list:va({method:"GET",fullPath:"/v1/issuing/cards",methodType:"list"})}),Rr=h.method,bm=h.extend({deliverCard:Rr({method:"POST",fullPath:"/v1/test_helpers/issuing/cards/{card}/shipping/deliver"}),failCard:Rr({method:"POST",fullPath:"/v1/test_helpers/issuing/cards/{card}/shipping/fail"}),returnCard:Rr({method:"POST",fullPath:"/v1/test_helpers/issuing/cards/{card}/shipping/return"}),shipCard:Rr({method:"POST",fullPath:"/v1/test_helpers/issuing/cards/{card}/shipping/ship"}),submitCard:Rr({method:"POST",fullPath:"/v1/test_helpers/issuing/cards/{card}/shipping/submit"})}),ya=h.method,xm=h.extend({create:ya({method:"POST",fullPath:"/v1/billing_portal/configurations"}),retrieve:ya({method:"GET",fullPath:"/v1/billing_portal/configurations/{configuration}"}),update:ya({method:"POST",fullPath:"/v1/billing_portal/configurations/{configuration}"}),list:ya({method:"GET",fullPath:"/v1/billing_portal/configurations",methodType:"list"})}),Ar=h.method,_m=h.extend({create:Ar({method:"POST",fullPath:"/v1/terminal/configurations"}),retrieve:Ar({method:"GET",fullPath:"/v1/terminal/configurations/{configuration}"}),update:Ar({method:"POST",fullPath:"/v1/terminal/configurations/{configuration}"}),list:Ar({method:"GET",fullPath:"/v1/terminal/configurations",methodType:"list"}),del:Ar({method:"DELETE",fullPath:"/v1/terminal/configurations/{configuration}"})}),Em=h.method,wm=h.extend({create:Em({method:"POST",fullPath:"/v1/test_helpers/confirmation_tokens"})}),Tm=h.method,Sm=h.extend({create:Tm({method:"POST",fullPath:"/v1/terminal/connection_tokens"})}),Cm=h.method,Im=h.extend({retrieve:Cm({method:"GET",fullPath:"/v1/billing/credit_balance_summary"})}),Bi=h.method,Rm=h.extend({retrieve:Bi({method:"GET",fullPath:"/v1/billing/credit_balance_transactions/{id}"}),list:Bi({method:"GET",fullPath:"/v1/billing/credit_balance_transactions",methodType:"list"})}),Zt=h.method,Am=h.extend({create:Zt({method:"POST",fullPath:"/v1/billing/credit_grants"}),retrieve:Zt({method:"GET",fullPath:"/v1/billing/credit_grants/{id}"}),update:Zt({method:"POST",fullPath:"/v1/billing/credit_grants/{id}"}),list:Zt({method:"GET",fullPath:"/v1/billing/credit_grants",methodType:"list"}),expire:Zt({method:"POST",fullPath:"/v1/billing/credit_grants/{id}/expire"}),voidGrant:Zt({method:"POST",fullPath:"/v1/billing/credit_grants/{id}/void"})}),To=h.method,Om=h.extend({create:To({method:"POST",fullPath:"/v1/treasury/credit_reversals"}),retrieve:To({method:"GET",fullPath:"/v1/treasury/credit_reversals/{credit_reversal}"}),list:To({method:"GET",fullPath:"/v1/treasury/credit_reversals",methodType:"list"})}),km=h.method,Dm=h.extend({fundCashBalance:km({method:"POST",fullPath:"/v1/test_helpers/customers/{customer}/fund_cash_balance"})}),So=h.method,Mm=h.extend({create:So({method:"POST",fullPath:"/v1/treasury/debit_reversals"}),retrieve:So({method:"GET",fullPath:"/v1/treasury/debit_reversals/{debit_reversal}"}),list:So({method:"GET",fullPath:"/v1/treasury/debit_reversals",methodType:"list"})}),Or=h.method,Nm=h.extend({create:Or({method:"POST",fullPath:"/v1/issuing/disputes"}),retrieve:Or({method:"GET",fullPath:"/v1/issuing/disputes/{dispute}"}),update:Or({method:"POST",fullPath:"/v1/issuing/disputes/{dispute}"}),list:Or({method:"GET",fullPath:"/v1/issuing/disputes",methodType:"list"}),submit:Or({method:"POST",fullPath:"/v1/issuing/disputes/{dispute}/submit"})}),Fi=h.method,Pm=h.extend({retrieve:Fi({method:"GET",fullPath:"/v1/radar/early_fraud_warnings/{early_fraud_warning}"}),list:Fi({method:"GET",fullPath:"/v1/radar/early_fraud_warnings",methodType:"list"})}),ht=h.method,Lm=h.extend({create:ht({method:"POST",fullPath:"/v2/core/event_destinations"}),retrieve:ht({method:"GET",fullPath:"/v2/core/event_destinations/{id}"}),update:ht({method:"POST",fullPath:"/v2/core/event_destinations/{id}"}),list:ht({method:"GET",fullPath:"/v2/core/event_destinations",methodType:"list"}),del:ht({method:"DELETE",fullPath:"/v2/core/event_destinations/{id}"}),disable:ht({method:"POST",fullPath:"/v2/core/event_destinations/{id}/disable"}),enable:ht({method:"POST",fullPath:"/v2/core/event_destinations/{id}/enable"}),ping:ht({method:"POST",fullPath:"/v2/core/event_destinations/{id}/ping"})}),Co=h.method,jm=h.extend({retrieve(...e){return Co({method:"GET",fullPath:"/v2/core/events/{id}",transformResponseData:r=>this.addFetchRelatedObjectIfNeeded(r)}).apply(this,e)},list(...e){return Co({method:"GET",fullPath:"/v2/core/events",methodType:"list",transformResponseData:r=>Object.assign(Object.assign({},r),{data:r.data.map(this.addFetchRelatedObjectIfNeeded.bind(this))})}).apply(this,e)},addFetchRelatedObjectIfNeeded(e){return!e.related_object||!e.related_object.url?e:Object.assign(Object.assign({},e),{fetchRelatedObject:()=>Co({method:"GET",fullPath:e.related_object.url}).apply(this,[{stripeContext:e.context}])})}}),ba=h.method,Bm=h.extend({create:ba({method:"POST",fullPath:"/v1/entitlements/features"}),retrieve:ba({method:"GET",fullPath:"/v1/entitlements/features/{id}"}),update:ba({method:"POST",fullPath:"/v1/entitlements/features/{id}"}),list:ba({method:"GET",fullPath:"/v1/entitlements/features",methodType:"list"})}),Dt=h.method,Fm=h.extend({create:Dt({method:"POST",fullPath:"/v1/treasury/financial_accounts"}),retrieve:Dt({method:"GET",fullPath:"/v1/treasury/financial_accounts/{financial_account}"}),update:Dt({method:"POST",fullPath:"/v1/treasury/financial_accounts/{financial_account}"}),list:Dt({method:"GET",fullPath:"/v1/treasury/financial_accounts",methodType:"list"}),close:Dt({method:"POST",fullPath:"/v1/treasury/financial_accounts/{financial_account}/close"}),retrieveFeatures:Dt({method:"GET",fullPath:"/v1/treasury/financial_accounts/{financial_account}/features"}),updateFeatures:Dt({method:"POST",fullPath:"/v1/treasury/financial_accounts/{financial_account}/features"})}),Io=h.method,$m=h.extend({fail:Io({method:"POST",fullPath:"/v1/test_helpers/treasury/inbound_transfers/{id}/fail"}),returnInboundTransfer:Io({method:"POST",fullPath:"/v1/test_helpers/treasury/inbound_transfers/{id}/return"}),succeed:Io({method:"POST",fullPath:"/v1/test_helpers/treasury/inbound_transfers/{id}/succeed"})}),xa=h.method,Hm=h.extend({create:xa({method:"POST",fullPath:"/v1/treasury/inbound_transfers"}),retrieve:xa({method:"GET",fullPath:"/v1/treasury/inbound_transfers/{id}"}),list:xa({method:"GET",fullPath:"/v1/treasury/inbound_transfers",methodType:"list"}),cancel:xa({method:"POST",fullPath:"/v1/treasury/inbound_transfers/{inbound_transfer}/cancel"})}),kr=h.method,Um=h.extend({create:kr({method:"POST",fullPath:"/v1/terminal/locations"}),retrieve:kr({method:"GET",fullPath:"/v1/terminal/locations/{location}"}),update:kr({method:"POST",fullPath:"/v1/terminal/locations/{location}"}),list:kr({method:"GET",fullPath:"/v1/terminal/locations",methodType:"list"}),del:kr({method:"DELETE",fullPath:"/v1/terminal/locations/{location}"})}),Gm=h.method,Wm=h.extend({create:Gm({method:"POST",fullPath:"/v1/billing/meter_event_adjustments"})}),qm=h.method,Vm=h.extend({create:qm({method:"POST",fullPath:"/v2/billing/meter_event_adjustments"})}),zm=h.method,Jm=h.extend({create:zm({method:"POST",fullPath:"/v2/billing/meter_event_session"})}),Ym=h.method,Km=h.extend({create:Ym({method:"POST",fullPath:"/v2/billing/meter_event_stream",host:"meter-events.stripe.com"})}),Qm=h.method,Xm=h.extend({create:Qm({method:"POST",fullPath:"/v1/billing/meter_events"})}),Zm=h.method,eg=h.extend({create:Zm({method:"POST",fullPath:"/v2/billing/meter_events"})}),Mt=h.method,tg=h.extend({create:Mt({method:"POST",fullPath:"/v1/billing/meters"}),retrieve:Mt({method:"GET",fullPath:"/v1/billing/meters/{id}"}),update:Mt({method:"POST",fullPath:"/v1/billing/meters/{id}"}),list:Mt({method:"GET",fullPath:"/v1/billing/meters",methodType:"list"}),deactivate:Mt({method:"POST",fullPath:"/v1/billing/meters/{id}/deactivate"}),listEventSummaries:Mt({method:"GET",fullPath:"/v1/billing/meters/{id}/event_summaries",methodType:"list"}),reactivate:Mt({method:"POST",fullPath:"/v1/billing/meters/{id}/reactivate"})}),Dr=h.method,rg=h.extend({create:Dr({method:"POST",fullPath:"/v1/climate/orders"}),retrieve:Dr({method:"GET",fullPath:"/v1/climate/orders/{order}"}),update:Dr({method:"POST",fullPath:"/v1/climate/orders/{order}"}),list:Dr({method:"GET",fullPath:"/v1/climate/orders",methodType:"list"}),cancel:Dr({method:"POST",fullPath:"/v1/climate/orders/{order}/cancel"})}),_a=h.method,ag=h.extend({update:_a({method:"POST",fullPath:"/v1/test_helpers/treasury/outbound_payments/{id}"}),fail:_a({method:"POST",fullPath:"/v1/test_helpers/treasury/outbound_payments/{id}/fail"}),post:_a({method:"POST",fullPath:"/v1/test_helpers/treasury/outbound_payments/{id}/post"}),returnOutboundPayment:_a({method:"POST",fullPath:"/v1/test_helpers/treasury/outbound_payments/{id}/return"})}),Ea=h.method,sg=h.extend({create:Ea({method:"POST",fullPath:"/v1/treasury/outbound_payments"}),retrieve:Ea({method:"GET",fullPath:"/v1/treasury/outbound_payments/{id}"}),list:Ea({method:"GET",fullPath:"/v1/treasury/outbound_payments",methodType:"list"}),cancel:Ea({method:"POST",fullPath:"/v1/treasury/outbound_payments/{id}/cancel"})}),wa=h.method,og=h.extend({update:wa({method:"POST",fullPath:"/v1/test_helpers/treasury/outbound_transfers/{outbound_transfer}"}),fail:wa({method:"POST",fullPath:"/v1/test_helpers/treasury/outbound_transfers/{outbound_transfer}/fail"}),post:wa({method:"POST",fullPath:"/v1/test_helpers/treasury/outbound_transfers/{outbound_transfer}/post"}),returnOutboundTransfer:wa({method:"POST",fullPath:"/v1/test_helpers/treasury/outbound_transfers/{outbound_transfer}/return"})}),Ta=h.method,ng=h.extend({create:Ta({method:"POST",fullPath:"/v1/treasury/outbound_transfers"}),retrieve:Ta({method:"GET",fullPath:"/v1/treasury/outbound_transfers/{outbound_transfer}"}),list:Ta({method:"GET",fullPath:"/v1/treasury/outbound_transfers",methodType:"list"}),cancel:Ta({method:"POST",fullPath:"/v1/treasury/outbound_transfers/{outbound_transfer}/cancel"})}),Sa=h.method,ig=h.extend({create:Sa({method:"POST",fullPath:"/v1/issuing/personalization_designs"}),retrieve:Sa({method:"GET",fullPath:"/v1/issuing/personalization_designs/{personalization_design}"}),update:Sa({method:"POST",fullPath:"/v1/issuing/personalization_designs/{personalization_design}"}),list:Sa({method:"GET",fullPath:"/v1/issuing/personalization_designs",methodType:"list"})}),Ro=h.method,lg=h.extend({activate:Ro({method:"POST",fullPath:"/v1/test_helpers/issuing/personalization_designs/{personalization_design}/activate"}),deactivate:Ro({method:"POST",fullPath:"/v1/test_helpers/issuing/personalization_designs/{personalization_design}/deactivate"}),reject:Ro({method:"POST",fullPath:"/v1/test_helpers/issuing/personalization_designs/{personalization_design}/reject"})}),$i=h.method,dg=h.extend({retrieve:$i({method:"GET",fullPath:"/v1/issuing/physical_bundles/{physical_bundle}"}),list:$i({method:"GET",fullPath:"/v1/issuing/physical_bundles",methodType:"list"})}),Hi=h.method,cg=h.extend({retrieve:Hi({method:"GET",fullPath:"/v1/climate/products/{product}"}),list:Hi({method:"GET",fullPath:"/v1/climate/products",methodType:"list"})}),De=h.method,ug=h.extend({create:De({method:"POST",fullPath:"/v1/terminal/readers"}),retrieve:De({method:"GET",fullPath:"/v1/terminal/readers/{reader}"}),update:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}"}),list:De({method:"GET",fullPath:"/v1/terminal/readers",methodType:"list"}),del:De({method:"DELETE",fullPath:"/v1/terminal/readers/{reader}"}),cancelAction:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}/cancel_action"}),collectInputs:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}/collect_inputs"}),collectPaymentMethod:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}/collect_payment_method"}),confirmPaymentIntent:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}/confirm_payment_intent"}),processPaymentIntent:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}/process_payment_intent"}),processSetupIntent:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}/process_setup_intent"}),refundPayment:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}/refund_payment"}),setReaderDisplay:De({method:"POST",fullPath:"/v1/terminal/readers/{reader}/set_reader_display"})}),Ao=h.method,pg=h.extend({presentPaymentMethod:Ao({method:"POST",fullPath:"/v1/test_helpers/terminal/readers/{reader}/present_payment_method"}),succeedInputCollection:Ao({method:"POST",fullPath:"/v1/test_helpers/terminal/readers/{reader}/succeed_input_collection"}),timeoutInputCollection:Ao({method:"POST",fullPath:"/v1/test_helpers/terminal/readers/{reader}/timeout_input_collection"})}),mg=h.method,gg=h.extend({create:mg({method:"POST",fullPath:"/v1/test_helpers/treasury/received_credits"})}),Ui=h.method,hg=h.extend({retrieve:Ui({method:"GET",fullPath:"/v1/treasury/received_credits/{id}"}),list:Ui({method:"GET",fullPath:"/v1/treasury/received_credits",methodType:"list"})}),fg=h.method,vg=h.extend({create:fg({method:"POST",fullPath:"/v1/test_helpers/treasury/received_debits"})}),Gi=h.method,yg=h.extend({retrieve:Gi({method:"GET",fullPath:"/v1/treasury/received_debits/{id}"}),list:Gi({method:"GET",fullPath:"/v1/treasury/received_debits",methodType:"list"})}),bg=h.method,xg=h.extend({expire:bg({method:"POST",fullPath:"/v1/test_helpers/refunds/{refund}/expire"})}),Ca=h.method,_g=h.extend({create:Ca({method:"POST",fullPath:"/v1/tax/registrations"}),retrieve:Ca({method:"GET",fullPath:"/v1/tax/registrations/{id}"}),update:Ca({method:"POST",fullPath:"/v1/tax/registrations/{id}"}),list:Ca({method:"GET",fullPath:"/v1/tax/registrations",methodType:"list"})}),Oo=h.method,Eg=h.extend({create:Oo({method:"POST",fullPath:"/v1/reporting/report_runs"}),retrieve:Oo({method:"GET",fullPath:"/v1/reporting/report_runs/{report_run}"}),list:Oo({method:"GET",fullPath:"/v1/reporting/report_runs",methodType:"list"})}),Wi=h.method,wg=h.extend({retrieve:Wi({method:"GET",fullPath:"/v1/reporting/report_types/{report_type}"}),list:Wi({method:"GET",fullPath:"/v1/reporting/report_types",methodType:"list"})}),ko=h.method,Tg=h.extend({create:ko({method:"POST",fullPath:"/v1/forwarding/requests"}),retrieve:ko({method:"GET",fullPath:"/v1/forwarding/requests/{id}"}),list:ko({method:"GET",fullPath:"/v1/forwarding/requests",methodType:"list"})}),qi=h.method,Sg=h.extend({retrieve:qi({method:"GET",fullPath:"/v1/sigma/scheduled_query_runs/{scheduled_query_run}"}),list:qi({method:"GET",fullPath:"/v1/sigma/scheduled_query_runs",methodType:"list"})}),Ia=h.method,Cg=h.extend({create:Ia({method:"POST",fullPath:"/v1/apps/secrets"}),list:Ia({method:"GET",fullPath:"/v1/apps/secrets",methodType:"list"}),deleteWhere:Ia({method:"POST",fullPath:"/v1/apps/secrets/delete"}),find:Ia({method:"GET",fullPath:"/v1/apps/secrets/find"})}),Ig=h.method,Rg=h.extend({create:Ig({method:"POST",fullPath:"/v1/billing_portal/sessions"})}),er=h.method,Ag=h.extend({create:er({method:"POST",fullPath:"/v1/checkout/sessions"}),retrieve:er({method:"GET",fullPath:"/v1/checkout/sessions/{session}"}),update:er({method:"POST",fullPath:"/v1/checkout/sessions/{session}"}),list:er({method:"GET",fullPath:"/v1/checkout/sessions",methodType:"list"}),expire:er({method:"POST",fullPath:"/v1/checkout/sessions/{session}/expire"}),listLineItems:er({method:"GET",fullPath:"/v1/checkout/sessions/{session}/line_items",methodType:"list"})}),Vi=h.method,Og=h.extend({create:Vi({method:"POST",fullPath:"/v1/financial_connections/sessions"}),retrieve:Vi({method:"GET",fullPath:"/v1/financial_connections/sessions/{session}"})}),zi=h.method,kg=h.extend({retrieve:zi({method:"GET",fullPath:"/v1/tax/settings"}),update:zi({method:"POST",fullPath:"/v1/tax/settings"})}),Ji=h.method,Dg=h.extend({retrieve:Ji({method:"GET",fullPath:"/v1/climate/suppliers/{supplier}"}),list:Ji({method:"GET",fullPath:"/v1/climate/suppliers",methodType:"list"})}),Mr=h.method,Mg=h.extend({create:Mr({method:"POST",fullPath:"/v1/test_helpers/test_clocks"}),retrieve:Mr({method:"GET",fullPath:"/v1/test_helpers/test_clocks/{test_clock}"}),list:Mr({method:"GET",fullPath:"/v1/test_helpers/test_clocks",methodType:"list"}),del:Mr({method:"DELETE",fullPath:"/v1/test_helpers/test_clocks/{test_clock}"}),advance:Mr({method:"POST",fullPath:"/v1/test_helpers/test_clocks/{test_clock}/advance"})}),Do=h.method,Ng=h.extend({retrieve:Do({method:"GET",fullPath:"/v1/issuing/tokens/{token}"}),update:Do({method:"POST",fullPath:"/v1/issuing/tokens/{token}"}),list:Do({method:"GET",fullPath:"/v1/issuing/tokens",methodType:"list"})}),Yi=h.method,Pg=h.extend({retrieve:Yi({method:"GET",fullPath:"/v1/treasury/transaction_entries/{id}"}),list:Yi({method:"GET",fullPath:"/v1/treasury/transaction_entries",methodType:"list"})}),Ki=h.method,Lg=h.extend({retrieve:Ki({method:"GET",fullPath:"/v1/financial_connections/transactions/{transaction}"}),list:Ki({method:"GET",fullPath:"/v1/financial_connections/transactions",methodType:"list"})}),Mo=h.method,jg=h.extend({retrieve:Mo({method:"GET",fullPath:"/v1/issuing/transactions/{transaction}"}),update:Mo({method:"POST",fullPath:"/v1/issuing/transactions/{transaction}"}),list:Mo({method:"GET",fullPath:"/v1/issuing/transactions",methodType:"list"})}),Ra=h.method,Bg=h.extend({retrieve:Ra({method:"GET",fullPath:"/v1/tax/transactions/{transaction}"}),createFromCalculation:Ra({method:"POST",fullPath:"/v1/tax/transactions/create_from_calculation"}),createReversal:Ra({method:"POST",fullPath:"/v1/tax/transactions/create_reversal"}),listLineItems:Ra({method:"GET",fullPath:"/v1/tax/transactions/{transaction}/line_items",methodType:"list"})}),No=h.method,Fg=h.extend({createForceCapture:No({method:"POST",fullPath:"/v1/test_helpers/issuing/transactions/create_force_capture"}),createUnlinkedRefund:No({method:"POST",fullPath:"/v1/test_helpers/issuing/transactions/create_unlinked_refund"}),refund:No({method:"POST",fullPath:"/v1/test_helpers/issuing/transactions/{transaction}/refund"})}),Qi=h.method,$g=h.extend({retrieve:Qi({method:"GET",fullPath:"/v1/treasury/transactions/{id}"}),list:Qi({method:"GET",fullPath:"/v1/treasury/transactions",methodType:"list"})}),Aa=h.method,Hg=h.extend({create:Aa({method:"POST",fullPath:"/v1/radar/value_list_items"}),retrieve:Aa({method:"GET",fullPath:"/v1/radar/value_list_items/{item}"}),list:Aa({method:"GET",fullPath:"/v1/radar/value_list_items",methodType:"list"}),del:Aa({method:"DELETE",fullPath:"/v1/radar/value_list_items/{item}"})}),Nr=h.method,Ug=h.extend({create:Nr({method:"POST",fullPath:"/v1/radar/value_lists"}),retrieve:Nr({method:"GET",fullPath:"/v1/radar/value_lists/{value_list}"}),update:Nr({method:"POST",fullPath:"/v1/radar/value_lists/{value_list}"}),list:Nr({method:"GET",fullPath:"/v1/radar/value_lists",methodType:"list"}),del:Nr({method:"DELETE",fullPath:"/v1/radar/value_lists/{value_list}"})}),Xi=h.method,Gg=h.extend({retrieve:Xi({method:"GET",fullPath:"/v1/identity/verification_reports/{report}"}),list:Xi({method:"GET",fullPath:"/v1/identity/verification_reports",methodType:"list"})}),tr=h.method,Wg=h.extend({create:tr({method:"POST",fullPath:"/v1/identity/verification_sessions"}),retrieve:tr({method:"GET",fullPath:"/v1/identity/verification_sessions/{session}"}),update:tr({method:"POST",fullPath:"/v1/identity/verification_sessions/{session}"}),list:tr({method:"GET",fullPath:"/v1/identity/verification_sessions",methodType:"list"}),cancel:tr({method:"POST",fullPath:"/v1/identity/verification_sessions/{session}/cancel"}),redact:tr({method:"POST",fullPath:"/v1/identity/verification_sessions/{session}/redact"})}),ue=h.method,Zi=h.extend({create:ue({method:"POST",fullPath:"/v1/accounts"}),retrieve(e,...t){return typeof e=="string"?ue({method:"GET",fullPath:"/v1/accounts/{id}"}).apply(this,[e,...t]):(e==null&&[].shift.apply([e,...t]),ue({method:"GET",fullPath:"/v1/account"}).apply(this,[e,...t]))},update:ue({method:"POST",fullPath:"/v1/accounts/{account}"}),list:ue({method:"GET",fullPath:"/v1/accounts",methodType:"list"}),del:ue({method:"DELETE",fullPath:"/v1/accounts/{account}"}),createExternalAccount:ue({method:"POST",fullPath:"/v1/accounts/{account}/external_accounts"}),createLoginLink:ue({method:"POST",fullPath:"/v1/accounts/{account}/login_links"}),createPerson:ue({method:"POST",fullPath:"/v1/accounts/{account}/persons"}),deleteExternalAccount:ue({method:"DELETE",fullPath:"/v1/accounts/{account}/external_accounts/{id}"}),deletePerson:ue({method:"DELETE",fullPath:"/v1/accounts/{account}/persons/{person}"}),listCapabilities:ue({method:"GET",fullPath:"/v1/accounts/{account}/capabilities",methodType:"list"}),listExternalAccounts:ue({method:"GET",fullPath:"/v1/accounts/{account}/external_accounts",methodType:"list"}),listPersons:ue({method:"GET",fullPath:"/v1/accounts/{account}/persons",methodType:"list"}),reject:ue({method:"POST",fullPath:"/v1/accounts/{account}/reject"}),retrieveCurrent:ue({method:"GET",fullPath:"/v1/account"}),retrieveCapability:ue({method:"GET",fullPath:"/v1/accounts/{account}/capabilities/{capability}"}),retrieveExternalAccount:ue({method:"GET",fullPath:"/v1/accounts/{account}/external_accounts/{id}"}),retrievePerson:ue({method:"GET",fullPath:"/v1/accounts/{account}/persons/{person}"}),updateCapability:ue({method:"POST",fullPath:"/v1/accounts/{account}/capabilities/{capability}"}),updateExternalAccount:ue({method:"POST",fullPath:"/v1/accounts/{account}/external_accounts/{id}"}),updatePerson:ue({method:"POST",fullPath:"/v1/accounts/{account}/persons/{person}"})}),qg=h.method,Vg=h.extend({create:qg({method:"POST",fullPath:"/v1/account_links"})}),zg=h.method,Jg=h.extend({create:zg({method:"POST",fullPath:"/v1/account_sessions"})}),Oa=h.method,Yg=h.extend({create:Oa({method:"POST",fullPath:"/v1/apple_pay/domains"}),retrieve:Oa({method:"GET",fullPath:"/v1/apple_pay/domains/{domain}"}),list:Oa({method:"GET",fullPath:"/v1/apple_pay/domains",methodType:"list"}),del:Oa({method:"DELETE",fullPath:"/v1/apple_pay/domains/{domain}"})}),rr=h.method,Kg=h.extend({retrieve:rr({method:"GET",fullPath:"/v1/application_fees/{id}"}),list:rr({method:"GET",fullPath:"/v1/application_fees",methodType:"list"}),createRefund:rr({method:"POST",fullPath:"/v1/application_fees/{id}/refunds"}),listRefunds:rr({method:"GET",fullPath:"/v1/application_fees/{id}/refunds",methodType:"list"}),retrieveRefund:rr({method:"GET",fullPath:"/v1/application_fees/{fee}/refunds/{id}"}),updateRefund:rr({method:"POST",fullPath:"/v1/application_fees/{fee}/refunds/{id}"})}),Qg=h.method,Xg=h.extend({retrieve:Qg({method:"GET",fullPath:"/v1/balance"})}),el=h.method,Zg=h.extend({retrieve:el({method:"GET",fullPath:"/v1/balance_settings"}),update:el({method:"POST",fullPath:"/v1/balance_settings"})}),tl=h.method,eh=h.extend({retrieve:tl({method:"GET",fullPath:"/v1/balance_transactions/{id}"}),list:tl({method:"GET",fullPath:"/v1/balance_transactions",methodType:"list"})}),ar=h.method,th=h.extend({create:ar({method:"POST",fullPath:"/v1/charges"}),retrieve:ar({method:"GET",fullPath:"/v1/charges/{charge}"}),update:ar({method:"POST",fullPath:"/v1/charges/{charge}"}),list:ar({method:"GET",fullPath:"/v1/charges",methodType:"list"}),capture:ar({method:"POST",fullPath:"/v1/charges/{charge}/capture"}),search:ar({method:"GET",fullPath:"/v1/charges/search",methodType:"search"})}),rh=h.method,ah=h.extend({retrieve:rh({method:"GET",fullPath:"/v1/confirmation_tokens/{confirmation_token}"})}),rl=h.method,sh=h.extend({retrieve:rl({method:"GET",fullPath:"/v1/country_specs/{country}"}),list:rl({method:"GET",fullPath:"/v1/country_specs",methodType:"list"})}),Pr=h.method,oh=h.extend({create:Pr({method:"POST",fullPath:"/v1/coupons"}),retrieve:Pr({method:"GET",fullPath:"/v1/coupons/{coupon}"}),update:Pr({method:"POST",fullPath:"/v1/coupons/{coupon}"}),list:Pr({method:"GET",fullPath:"/v1/coupons",methodType:"list"}),del:Pr({method:"DELETE",fullPath:"/v1/coupons/{coupon}"})}),ft=h.method,nh=h.extend({create:ft({method:"POST",fullPath:"/v1/credit_notes"}),retrieve:ft({method:"GET",fullPath:"/v1/credit_notes/{id}"}),update:ft({method:"POST",fullPath:"/v1/credit_notes/{id}"}),list:ft({method:"GET",fullPath:"/v1/credit_notes",methodType:"list"}),listLineItems:ft({method:"GET",fullPath:"/v1/credit_notes/{credit_note}/lines",methodType:"list"}),listPreviewLineItems:ft({method:"GET",fullPath:"/v1/credit_notes/preview/lines",methodType:"list"}),preview:ft({method:"GET",fullPath:"/v1/credit_notes/preview"}),voidCreditNote:ft({method:"POST",fullPath:"/v1/credit_notes/{id}/void"})}),ih=h.method,lh=h.extend({create:ih({method:"POST",fullPath:"/v1/customer_sessions"})}),re=h.method,dh=h.extend({create:re({method:"POST",fullPath:"/v1/customers"}),retrieve:re({method:"GET",fullPath:"/v1/customers/{customer}"}),update:re({method:"POST",fullPath:"/v1/customers/{customer}"}),list:re({method:"GET",fullPath:"/v1/customers",methodType:"list"}),del:re({method:"DELETE",fullPath:"/v1/customers/{customer}"}),createBalanceTransaction:re({method:"POST",fullPath:"/v1/customers/{customer}/balance_transactions"}),createFundingInstructions:re({method:"POST",fullPath:"/v1/customers/{customer}/funding_instructions"}),createSource:re({method:"POST",fullPath:"/v1/customers/{customer}/sources"}),createTaxId:re({method:"POST",fullPath:"/v1/customers/{customer}/tax_ids"}),deleteDiscount:re({method:"DELETE",fullPath:"/v1/customers/{customer}/discount"}),deleteSource:re({method:"DELETE",fullPath:"/v1/customers/{customer}/sources/{id}"}),deleteTaxId:re({method:"DELETE",fullPath:"/v1/customers/{customer}/tax_ids/{id}"}),listBalanceTransactions:re({method:"GET",fullPath:"/v1/customers/{customer}/balance_transactions",methodType:"list"}),listCashBalanceTransactions:re({method:"GET",fullPath:"/v1/customers/{customer}/cash_balance_transactions",methodType:"list"}),listPaymentMethods:re({method:"GET",fullPath:"/v1/customers/{customer}/payment_methods",methodType:"list"}),listSources:re({method:"GET",fullPath:"/v1/customers/{customer}/sources",methodType:"list"}),listTaxIds:re({method:"GET",fullPath:"/v1/customers/{customer}/tax_ids",methodType:"list"}),retrieveBalanceTransaction:re({method:"GET",fullPath:"/v1/customers/{customer}/balance_transactions/{transaction}"}),retrieveCashBalance:re({method:"GET",fullPath:"/v1/customers/{customer}/cash_balance"}),retrieveCashBalanceTransaction:re({method:"GET",fullPath:"/v1/customers/{customer}/cash_balance_transactions/{transaction}"}),retrievePaymentMethod:re({method:"GET",fullPath:"/v1/customers/{customer}/payment_methods/{payment_method}"}),retrieveSource:re({method:"GET",fullPath:"/v1/customers/{customer}/sources/{id}"}),retrieveTaxId:re({method:"GET",fullPath:"/v1/customers/{customer}/tax_ids/{id}"}),search:re({method:"GET",fullPath:"/v1/customers/search",methodType:"search"}),updateBalanceTransaction:re({method:"POST",fullPath:"/v1/customers/{customer}/balance_transactions/{transaction}"}),updateCashBalance:re({method:"POST",fullPath:"/v1/customers/{customer}/cash_balance"}),updateSource:re({method:"POST",fullPath:"/v1/customers/{customer}/sources/{id}"}),verifySource:re({method:"POST",fullPath:"/v1/customers/{customer}/sources/{id}/verify"})}),ka=h.method,ch=h.extend({retrieve:ka({method:"GET",fullPath:"/v1/disputes/{dispute}"}),update:ka({method:"POST",fullPath:"/v1/disputes/{dispute}"}),list:ka({method:"GET",fullPath:"/v1/disputes",methodType:"list"}),close:ka({method:"POST",fullPath:"/v1/disputes/{dispute}/close"})}),al=h.method,uh=h.extend({create:al({method:"POST",fullPath:"/v1/ephemeral_keys",validator:(e,t)=>{if(!t.headers||!t.headers["Stripe-Version"])throw new Error("Passing apiVersion in a separate options hash is required to create an ephemeral key. See https://stripe.com/docs/api/versioning?lang=node")}}),del:al({method:"DELETE",fullPath:"/v1/ephemeral_keys/{key}"})}),sl=h.method,ph=h.extend({retrieve:sl({method:"GET",fullPath:"/v1/events/{id}"}),list:sl({method:"GET",fullPath:"/v1/events",methodType:"list"})}),ol=h.method,mh=h.extend({retrieve:ol({method:"GET",fullPath:"/v1/exchange_rates/{rate_id}"}),list:ol({method:"GET",fullPath:"/v1/exchange_rates",methodType:"list"})}),Da=h.method,gh=h.extend({create:Da({method:"POST",fullPath:"/v1/file_links"}),retrieve:Da({method:"GET",fullPath:"/v1/file_links/{link}"}),update:Da({method:"POST",fullPath:"/v1/file_links/{link}"}),list:Da({method:"GET",fullPath:"/v1/file_links",methodType:"list"})}),hh=(e,t,r)=>{const a=(Math.round(Math.random()*1e16)+Math.round(Math.random()*1e16)).toString();r["Content-Type"]=`multipart/form-data; boundary=${a}`;const s=new TextEncoder;let o=new Uint8Array(0);const n=s.encode(`\r
`);function i(c){const u=o,p=c instanceof Uint8Array?c:new Uint8Array(s.encode(c));o=new Uint8Array(u.length+p.length+2),o.set(u),o.set(p,u.length),o.set(n,o.length-2)}function l(c){return`"${c.replace(/"|"/g,"%22").replace(/\r\n|\r|\n/g," ")}"`}const d=Fp(t);for(const c in d){if(!Object.prototype.hasOwnProperty.call(d,c))continue;const u=d[c];if(i(`--${a}`),Object.prototype.hasOwnProperty.call(u,"data")){const p=u;i(`Content-Disposition: form-data; name=${l(c)}; filename=${l(p.name||"blob")}`),i(`Content-Type: ${p.type||"application/octet-stream"}`),i(""),i(p.data)}else i(`Content-Disposition: form-data; name=${l(c)}`),i(""),i(u)}return i(`--${a}--`),o};function fh(e,t,r,a){if(t=t||{},e!=="POST")return a(null,as(t));this._stripe._platformFunctions.tryBufferData(t).then(s=>{const o=hh(e,s,r);return a(null,o)}).catch(s=>a(s,null))}const Po=h.method,vh=h.extend({create:Po({method:"POST",fullPath:"/v1/files",headers:{"Content-Type":"multipart/form-data"},host:"files.stripe.com"}),retrieve:Po({method:"GET",fullPath:"/v1/files/{file}"}),list:Po({method:"GET",fullPath:"/v1/files",methodType:"list"}),requestDataProcessor:fh}),Lr=h.method,yh=h.extend({create:Lr({method:"POST",fullPath:"/v1/invoiceitems"}),retrieve:Lr({method:"GET",fullPath:"/v1/invoiceitems/{invoiceitem}"}),update:Lr({method:"POST",fullPath:"/v1/invoiceitems/{invoiceitem}"}),list:Lr({method:"GET",fullPath:"/v1/invoiceitems",methodType:"list"}),del:Lr({method:"DELETE",fullPath:"/v1/invoiceitems/{invoiceitem}"})}),nl=h.method,bh=h.extend({retrieve:nl({method:"GET",fullPath:"/v1/invoice_payments/{invoice_payment}"}),list:nl({method:"GET",fullPath:"/v1/invoice_payments",methodType:"list"})}),Ma=h.method,xh=h.extend({retrieve:Ma({method:"GET",fullPath:"/v1/invoice_rendering_templates/{template}"}),list:Ma({method:"GET",fullPath:"/v1/invoice_rendering_templates",methodType:"list"}),archive:Ma({method:"POST",fullPath:"/v1/invoice_rendering_templates/{template}/archive"}),unarchive:Ma({method:"POST",fullPath:"/v1/invoice_rendering_templates/{template}/unarchive"})}),ye=h.method,_h=h.extend({create:ye({method:"POST",fullPath:"/v1/invoices"}),retrieve:ye({method:"GET",fullPath:"/v1/invoices/{invoice}"}),update:ye({method:"POST",fullPath:"/v1/invoices/{invoice}"}),list:ye({method:"GET",fullPath:"/v1/invoices",methodType:"list"}),del:ye({method:"DELETE",fullPath:"/v1/invoices/{invoice}"}),addLines:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/add_lines"}),attachPayment:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/attach_payment"}),createPreview:ye({method:"POST",fullPath:"/v1/invoices/create_preview"}),finalizeInvoice:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/finalize"}),listLineItems:ye({method:"GET",fullPath:"/v1/invoices/{invoice}/lines",methodType:"list"}),markUncollectible:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/mark_uncollectible"}),pay:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/pay"}),removeLines:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/remove_lines"}),search:ye({method:"GET",fullPath:"/v1/invoices/search",methodType:"search"}),sendInvoice:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/send"}),updateLines:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/update_lines"}),updateLineItem:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/lines/{line_item_id}"}),voidInvoice:ye({method:"POST",fullPath:"/v1/invoices/{invoice}/void"})}),Eh=h.method,wh=h.extend({retrieve:Eh({method:"GET",fullPath:"/v1/mandates/{mandate}"})}),il=h.method,Lo="connect.stripe.com",Th=h.extend({basePath:"/",authorizeUrl(e,t){e=e||{},t=t||{};let r="oauth/authorize";return t.express&&(r=`express/${r}`),e.response_type||(e.response_type="code"),e.client_id||(e.client_id=this._stripe.getClientId()),e.scope||(e.scope="read_write"),`https://${Lo}/${r}?${as(e)}`},token:il({method:"POST",path:"oauth/token",host:Lo}),deauthorize(e,...t){return e.client_id||(e.client_id=this._stripe.getClientId()),il({method:"POST",path:"oauth/deauthorize",host:Lo}).apply(this,[e,...t])}}),ze=h.method,Sh=h.extend({create:ze({method:"POST",fullPath:"/v1/payment_intents"}),retrieve:ze({method:"GET",fullPath:"/v1/payment_intents/{intent}"}),update:ze({method:"POST",fullPath:"/v1/payment_intents/{intent}"}),list:ze({method:"GET",fullPath:"/v1/payment_intents",methodType:"list"}),applyCustomerBalance:ze({method:"POST",fullPath:"/v1/payment_intents/{intent}/apply_customer_balance"}),cancel:ze({method:"POST",fullPath:"/v1/payment_intents/{intent}/cancel"}),capture:ze({method:"POST",fullPath:"/v1/payment_intents/{intent}/capture"}),confirm:ze({method:"POST",fullPath:"/v1/payment_intents/{intent}/confirm"}),incrementAuthorization:ze({method:"POST",fullPath:"/v1/payment_intents/{intent}/increment_authorization"}),search:ze({method:"GET",fullPath:"/v1/payment_intents/search",methodType:"search"}),verifyMicrodeposits:ze({method:"POST",fullPath:"/v1/payment_intents/{intent}/verify_microdeposits"})}),jr=h.method,Ch=h.extend({create:jr({method:"POST",fullPath:"/v1/payment_links"}),retrieve:jr({method:"GET",fullPath:"/v1/payment_links/{payment_link}"}),update:jr({method:"POST",fullPath:"/v1/payment_links/{payment_link}"}),list:jr({method:"GET",fullPath:"/v1/payment_links",methodType:"list"}),listLineItems:jr({method:"GET",fullPath:"/v1/payment_links/{payment_link}/line_items",methodType:"list"})}),Na=h.method,Ih=h.extend({create:Na({method:"POST",fullPath:"/v1/payment_method_configurations"}),retrieve:Na({method:"GET",fullPath:"/v1/payment_method_configurations/{configuration}"}),update:Na({method:"POST",fullPath:"/v1/payment_method_configurations/{configuration}"}),list:Na({method:"GET",fullPath:"/v1/payment_method_configurations",methodType:"list"})}),Br=h.method,Rh=h.extend({create:Br({method:"POST",fullPath:"/v1/payment_method_domains"}),retrieve:Br({method:"GET",fullPath:"/v1/payment_method_domains/{payment_method_domain}"}),update:Br({method:"POST",fullPath:"/v1/payment_method_domains/{payment_method_domain}"}),list:Br({method:"GET",fullPath:"/v1/payment_method_domains",methodType:"list"}),validate:Br({method:"POST",fullPath:"/v1/payment_method_domains/{payment_method_domain}/validate"})}),sr=h.method,Ah=h.extend({create:sr({method:"POST",fullPath:"/v1/payment_methods"}),retrieve:sr({method:"GET",fullPath:"/v1/payment_methods/{payment_method}"}),update:sr({method:"POST",fullPath:"/v1/payment_methods/{payment_method}"}),list:sr({method:"GET",fullPath:"/v1/payment_methods",methodType:"list"}),attach:sr({method:"POST",fullPath:"/v1/payment_methods/{payment_method}/attach"}),detach:sr({method:"POST",fullPath:"/v1/payment_methods/{payment_method}/detach"})}),or=h.method,Oh=h.extend({create:or({method:"POST",fullPath:"/v1/payouts"}),retrieve:or({method:"GET",fullPath:"/v1/payouts/{payout}"}),update:or({method:"POST",fullPath:"/v1/payouts/{payout}"}),list:or({method:"GET",fullPath:"/v1/payouts",methodType:"list"}),cancel:or({method:"POST",fullPath:"/v1/payouts/{payout}/cancel"}),reverse:or({method:"POST",fullPath:"/v1/payouts/{payout}/reverse"})}),Fr=h.method,kh=h.extend({create:Fr({method:"POST",fullPath:"/v1/plans"}),retrieve:Fr({method:"GET",fullPath:"/v1/plans/{plan}"}),update:Fr({method:"POST",fullPath:"/v1/plans/{plan}"}),list:Fr({method:"GET",fullPath:"/v1/plans",methodType:"list"}),del:Fr({method:"DELETE",fullPath:"/v1/plans/{plan}"})}),$r=h.method,Dh=h.extend({create:$r({method:"POST",fullPath:"/v1/prices"}),retrieve:$r({method:"GET",fullPath:"/v1/prices/{price}"}),update:$r({method:"POST",fullPath:"/v1/prices/{price}"}),list:$r({method:"GET",fullPath:"/v1/prices",methodType:"list"}),search:$r({method:"GET",fullPath:"/v1/prices/search",methodType:"search"})}),Ze=h.method,Mh=h.extend({create:Ze({method:"POST",fullPath:"/v1/products"}),retrieve:Ze({method:"GET",fullPath:"/v1/products/{id}"}),update:Ze({method:"POST",fullPath:"/v1/products/{id}"}),list:Ze({method:"GET",fullPath:"/v1/products",methodType:"list"}),del:Ze({method:"DELETE",fullPath:"/v1/products/{id}"}),createFeature:Ze({method:"POST",fullPath:"/v1/products/{product}/features"}),deleteFeature:Ze({method:"DELETE",fullPath:"/v1/products/{product}/features/{id}"}),listFeatures:Ze({method:"GET",fullPath:"/v1/products/{product}/features",methodType:"list"}),retrieveFeature:Ze({method:"GET",fullPath:"/v1/products/{product}/features/{id}"}),search:Ze({method:"GET",fullPath:"/v1/products/search",methodType:"search"})}),Pa=h.method,Nh=h.extend({create:Pa({method:"POST",fullPath:"/v1/promotion_codes"}),retrieve:Pa({method:"GET",fullPath:"/v1/promotion_codes/{promotion_code}"}),update:Pa({method:"POST",fullPath:"/v1/promotion_codes/{promotion_code}"}),list:Pa({method:"GET",fullPath:"/v1/promotion_codes",methodType:"list"})}),et=h.method,Ph=h.extend({create:et({method:"POST",fullPath:"/v1/quotes"}),retrieve:et({method:"GET",fullPath:"/v1/quotes/{quote}"}),update:et({method:"POST",fullPath:"/v1/quotes/{quote}"}),list:et({method:"GET",fullPath:"/v1/quotes",methodType:"list"}),accept:et({method:"POST",fullPath:"/v1/quotes/{quote}/accept"}),cancel:et({method:"POST",fullPath:"/v1/quotes/{quote}/cancel"}),finalizeQuote:et({method:"POST",fullPath:"/v1/quotes/{quote}/finalize"}),listComputedUpfrontLineItems:et({method:"GET",fullPath:"/v1/quotes/{quote}/computed_upfront_line_items",methodType:"list"}),listLineItems:et({method:"GET",fullPath:"/v1/quotes/{quote}/line_items",methodType:"list"}),pdf:et({method:"GET",fullPath:"/v1/quotes/{quote}/pdf",host:"files.stripe.com",streaming:!0})}),Hr=h.method,Lh=h.extend({create:Hr({method:"POST",fullPath:"/v1/refunds"}),retrieve:Hr({method:"GET",fullPath:"/v1/refunds/{refund}"}),update:Hr({method:"POST",fullPath:"/v1/refunds/{refund}"}),list:Hr({method:"GET",fullPath:"/v1/refunds",methodType:"list"}),cancel:Hr({method:"POST",fullPath:"/v1/refunds/{refund}/cancel"})}),jo=h.method,jh=h.extend({retrieve:jo({method:"GET",fullPath:"/v1/reviews/{review}"}),list:jo({method:"GET",fullPath:"/v1/reviews",methodType:"list"}),approve:jo({method:"POST",fullPath:"/v1/reviews/{review}/approve"})}),Bh=h.method,Fh=h.extend({list:Bh({method:"GET",fullPath:"/v1/setup_attempts",methodType:"list"})}),Nt=h.method,$h=h.extend({create:Nt({method:"POST",fullPath:"/v1/setup_intents"}),retrieve:Nt({method:"GET",fullPath:"/v1/setup_intents/{intent}"}),update:Nt({method:"POST",fullPath:"/v1/setup_intents/{intent}"}),list:Nt({method:"GET",fullPath:"/v1/setup_intents",methodType:"list"}),cancel:Nt({method:"POST",fullPath:"/v1/setup_intents/{intent}/cancel"}),confirm:Nt({method:"POST",fullPath:"/v1/setup_intents/{intent}/confirm"}),verifyMicrodeposits:Nt({method:"POST",fullPath:"/v1/setup_intents/{intent}/verify_microdeposits"})}),La=h.method,Hh=h.extend({create:La({method:"POST",fullPath:"/v1/shipping_rates"}),retrieve:La({method:"GET",fullPath:"/v1/shipping_rates/{shipping_rate_token}"}),update:La({method:"POST",fullPath:"/v1/shipping_rates/{shipping_rate_token}"}),list:La({method:"GET",fullPath:"/v1/shipping_rates",methodType:"list"})}),Ur=h.method,Uh=h.extend({create:Ur({method:"POST",fullPath:"/v1/sources"}),retrieve:Ur({method:"GET",fullPath:"/v1/sources/{source}"}),update:Ur({method:"POST",fullPath:"/v1/sources/{source}"}),listSourceTransactions:Ur({method:"GET",fullPath:"/v1/sources/{source}/source_transactions",methodType:"list"}),verify:Ur({method:"POST",fullPath:"/v1/sources/{source}/verify"})}),Gr=h.method,Gh=h.extend({create:Gr({method:"POST",fullPath:"/v1/subscription_items"}),retrieve:Gr({method:"GET",fullPath:"/v1/subscription_items/{item}"}),update:Gr({method:"POST",fullPath:"/v1/subscription_items/{item}"}),list:Gr({method:"GET",fullPath:"/v1/subscription_items",methodType:"list"}),del:Gr({method:"DELETE",fullPath:"/v1/subscription_items/{item}"})}),nr=h.method,Wh=h.extend({create:nr({method:"POST",fullPath:"/v1/subscription_schedules"}),retrieve:nr({method:"GET",fullPath:"/v1/subscription_schedules/{schedule}"}),update:nr({method:"POST",fullPath:"/v1/subscription_schedules/{schedule}"}),list:nr({method:"GET",fullPath:"/v1/subscription_schedules",methodType:"list"}),cancel:nr({method:"POST",fullPath:"/v1/subscription_schedules/{schedule}/cancel"}),release:nr({method:"POST",fullPath:"/v1/subscription_schedules/{schedule}/release"})}),st=h.method,qh=h.extend({create:st({method:"POST",fullPath:"/v1/subscriptions"}),retrieve:st({method:"GET",fullPath:"/v1/subscriptions/{subscription_exposed_id}"}),update:st({method:"POST",fullPath:"/v1/subscriptions/{subscription_exposed_id}"}),list:st({method:"GET",fullPath:"/v1/subscriptions",methodType:"list"}),cancel:st({method:"DELETE",fullPath:"/v1/subscriptions/{subscription_exposed_id}"}),deleteDiscount:st({method:"DELETE",fullPath:"/v1/subscriptions/{subscription_exposed_id}/discount"}),migrate:st({method:"POST",fullPath:"/v1/subscriptions/{subscription}/migrate"}),resume:st({method:"POST",fullPath:"/v1/subscriptions/{subscription}/resume"}),search:st({method:"GET",fullPath:"/v1/subscriptions/search",methodType:"search"})}),ll=h.method,Vh=h.extend({retrieve:ll({method:"GET",fullPath:"/v1/tax_codes/{id}"}),list:ll({method:"GET",fullPath:"/v1/tax_codes",methodType:"list"})}),ja=h.method,zh=h.extend({create:ja({method:"POST",fullPath:"/v1/tax_ids"}),retrieve:ja({method:"GET",fullPath:"/v1/tax_ids/{id}"}),list:ja({method:"GET",fullPath:"/v1/tax_ids",methodType:"list"}),del:ja({method:"DELETE",fullPath:"/v1/tax_ids/{id}"})}),Ba=h.method,Jh=h.extend({create:Ba({method:"POST",fullPath:"/v1/tax_rates"}),retrieve:Ba({method:"GET",fullPath:"/v1/tax_rates/{tax_rate}"}),update:Ba({method:"POST",fullPath:"/v1/tax_rates/{tax_rate}"}),list:Ba({method:"GET",fullPath:"/v1/tax_rates",methodType:"list"})}),dl=h.method,Yh=h.extend({create:dl({method:"POST",fullPath:"/v1/tokens"}),retrieve:dl({method:"GET",fullPath:"/v1/tokens/{token}"})}),Wr=h.method,Kh=h.extend({create:Wr({method:"POST",fullPath:"/v1/topups"}),retrieve:Wr({method:"GET",fullPath:"/v1/topups/{topup}"}),update:Wr({method:"POST",fullPath:"/v1/topups/{topup}"}),list:Wr({method:"GET",fullPath:"/v1/topups",methodType:"list"}),cancel:Wr({method:"POST",fullPath:"/v1/topups/{topup}/cancel"})}),vt=h.method,Qh=h.extend({create:vt({method:"POST",fullPath:"/v1/transfers"}),retrieve:vt({method:"GET",fullPath:"/v1/transfers/{transfer}"}),update:vt({method:"POST",fullPath:"/v1/transfers/{transfer}"}),list:vt({method:"GET",fullPath:"/v1/transfers",methodType:"list"}),createReversal:vt({method:"POST",fullPath:"/v1/transfers/{id}/reversals"}),listReversals:vt({method:"GET",fullPath:"/v1/transfers/{id}/reversals",methodType:"list"}),retrieveReversal:vt({method:"GET",fullPath:"/v1/transfers/{transfer}/reversals/{id}"}),updateReversal:vt({method:"POST",fullPath:"/v1/transfers/{transfer}/reversals/{id}"})}),qr=h.method,Xh=h.extend({create:qr({method:"POST",fullPath:"/v1/webhook_endpoints"}),retrieve:qr({method:"GET",fullPath:"/v1/webhook_endpoints/{webhook_endpoint}"}),update:qr({method:"POST",fullPath:"/v1/webhook_endpoints/{webhook_endpoint}"}),list:qr({method:"GET",fullPath:"/v1/webhook_endpoints",methodType:"list"}),del:qr({method:"DELETE",fullPath:"/v1/webhook_endpoints/{webhook_endpoint}"})}),Zh=ie("apps",{Secrets:Cg}),ef=ie("billing",{Alerts:mm,CreditBalanceSummary:Im,CreditBalanceTransactions:Rm,CreditGrants:Am,MeterEventAdjustments:Wm,MeterEvents:Xm,Meters:tg}),tf=ie("billingPortal",{Configurations:xm,Sessions:Rg}),rf=ie("checkout",{Sessions:Ag}),af=ie("climate",{Orders:rg,Products:cg,Suppliers:Dg}),sf=ie("entitlements",{ActiveEntitlements:pm,Features:Bm}),of=ie("financialConnections",{Accounts:um,Sessions:Og,Transactions:Lg}),nf=ie("forwarding",{Requests:Tg}),lf=ie("identity",{VerificationReports:Gg,VerificationSessions:Wg}),df=ie("issuing",{Authorizations:gm,Cardholders:vm,Cards:ym,Disputes:Nm,PersonalizationDesigns:ig,PhysicalBundles:dg,Tokens:Ng,Transactions:jg}),cf=ie("radar",{EarlyFraudWarnings:Pm,ValueListItems:Hg,ValueLists:Ug}),uf=ie("reporting",{ReportRuns:Eg,ReportTypes:wg}),pf=ie("sigma",{ScheduledQueryRuns:Sg}),mf=ie("tax",{Calculations:fm,Registrations:_g,Settings:kg,Transactions:Bg}),gf=ie("terminal",{Configurations:_m,ConnectionTokens:Sm,Locations:Um,Readers:ug}),hf=ie("testHelpers",{ConfirmationTokens:wm,Customers:Dm,Refunds:xg,TestClocks:Mg,Issuing:ie("issuing",{Authorizations:hm,Cards:bm,PersonalizationDesigns:lg,Transactions:Fg}),Terminal:ie("terminal",{Readers:pg}),Treasury:ie("treasury",{InboundTransfers:$m,OutboundPayments:ag,OutboundTransfers:og,ReceivedCredits:gg,ReceivedDebits:vg})}),ff=ie("treasury",{CreditReversals:Om,DebitReversals:Mm,FinancialAccounts:Fm,InboundTransfers:Hm,OutboundPayments:sg,OutboundTransfers:ng,ReceivedCredits:hg,ReceivedDebits:yg,TransactionEntries:Pg,Transactions:$g}),vf=ie("v2",{Billing:ie("billing",{MeterEventAdjustments:Vm,MeterEventSession:Jm,MeterEventStream:Km,MeterEvents:eg}),Core:ie("core",{EventDestinations:Lm,Events:jm})}),Fa=Object.freeze(Object.defineProperty({__proto__:null,Account:Zi,AccountLinks:Vg,AccountSessions:Jg,Accounts:Zi,ApplePayDomains:Yg,ApplicationFees:Kg,Apps:Zh,Balance:Xg,BalanceSettings:Zg,BalanceTransactions:eh,Billing:ef,BillingPortal:tf,Charges:th,Checkout:rf,Climate:af,ConfirmationTokens:ah,CountrySpecs:sh,Coupons:oh,CreditNotes:nh,CustomerSessions:lh,Customers:dh,Disputes:ch,Entitlements:sf,EphemeralKeys:uh,Events:ph,ExchangeRates:mh,FileLinks:gh,Files:vh,FinancialConnections:of,Forwarding:nf,Identity:lf,InvoiceItems:yh,InvoicePayments:bh,InvoiceRenderingTemplates:xh,Invoices:_h,Issuing:df,Mandates:wh,OAuth:Th,PaymentIntents:Sh,PaymentLinks:Ch,PaymentMethodConfigurations:Ih,PaymentMethodDomains:Rh,PaymentMethods:Ah,Payouts:Oh,Plans:kh,Prices:Dh,Products:Mh,PromotionCodes:Nh,Quotes:Ph,Radar:cf,Refunds:Lh,Reporting:uf,Reviews:jh,SetupAttempts:Fh,SetupIntents:$h,ShippingRates:Hh,Sigma:pf,Sources:Uh,SubscriptionItems:Gh,SubscriptionSchedules:Wh,Subscriptions:qh,Tax:mf,TaxCodes:Vh,TaxIds:zh,TaxRates:Jh,Terminal:gf,TestHelpers:hf,Tokens:Yh,Topups:Kh,Transfers:Qh,Treasury:ff,V2:vf,WebhookEndpoints:Xh},Symbol.toStringTag,{value:"Module"})),cl="api.stripe.com",ul="443",pl="/v1/",ml=Pd,gl=8e4,hl=5,fl=.5,yf=["name","version","url","partner_id"],vl=["authenticator","apiVersion","typescript","maxNetworkRetries","httpAgent","httpClient","timeout","host","port","protocol","telemetry","appInfo","stripeAccount","stripeContext"],bf=e=>new Yr(e,h.MAX_BUFFERED_REQUEST_METRICS);function xf(e,t=bf){r.PACKAGE_VERSION="19.1.0",r.API_VERSION=Pd,r.USER_AGENT=Object.assign({bindings_version:r.PACKAGE_VERSION,lang:"node",publisher:"stripe",uname:null,typescript:!1},$p()),r.StripeResource=h,r.StripeContext=jt,r.resources=Fa,r.HttpClient=je,r.HttpClientResponse=Ed,r.CryptoProvider=wd,r.webhooks=dm(e);function r(a,s={}){if(!(this instanceof r))return new r(a,s);const o=this._getPropsFromConfig(s);this._platformFunctions=e,Object.defineProperty(this,"_emitter",{value:this._platformFunctions.createEmitter(),enumerable:!1,configurable:!1,writable:!1}),this.VERSION=r.PACKAGE_VERSION,this.on=this._emitter.on.bind(this._emitter),this.once=this._emitter.once.bind(this._emitter),this.off=this._emitter.removeListener.bind(this._emitter);const n=o.httpAgent||null;this._api={host:o.host||cl,port:o.port||ul,protocol:o.protocol||"https",basePath:pl,version:o.apiVersion||ml,timeout:_o("timeout",o.timeout,gl),maxNetworkRetries:_o("maxNetworkRetries",o.maxNetworkRetries,2),agent:n,httpClient:o.httpClient||(n?this._platformFunctions.createNodeHttpClient(n):this._platformFunctions.createDefaultHttpClient()),dev:!1,stripeAccount:o.stripeAccount||null,stripeContext:o.stripeContext||null};const i=o.typescript||!1;i!==r.USER_AGENT.typescript&&(r.USER_AGENT.typescript=i),o.appInfo&&this._setAppInfo(o.appInfo),this._prepResources(),this._setAuthenticator(a,o.authenticator),this.errors=Li,this.webhooks=r.webhooks,this._prevRequestMetrics=[],this._enableTelemetry=o.telemetry!==!1,this._requestSender=t(this),this.StripeResource=r.StripeResource}return r.errors=Li,r.createNodeHttpClient=e.createNodeHttpClient,r.createFetchHttpClient=e.createFetchHttpClient,r.createNodeCryptoProvider=e.createNodeCryptoProvider,r.createSubtleCryptoProvider=e.createSubtleCryptoProvider,r.prototype={_appInfo:void 0,on:null,off:null,once:null,VERSION:null,StripeResource:null,webhooks:null,errors:null,_api:null,_prevRequestMetrics:null,_emitter:null,_enableTelemetry:null,_requestSender:null,_platformFunctions:null,rawRequest(a,s,o,n){return this._requestSender._rawRequest(a,s,o,n)},_setAuthenticator(a,s){if(a&&s)throw new Error("Can't specify both apiKey and authenticator");if(!a&&!s)throw new Error("Neither apiKey nor config.authenticator provided");this._authenticator=a?Wo(a):s},_setAppInfo(a){if(a&&typeof a!="object")throw new Error("AppInfo must be an object.");if(a&&!a.name)throw new Error("AppInfo.name is required");a=a||{},this._appInfo=yf.reduce((s,o)=>(typeof a[o]=="string"&&(s=s||{},s[o]=a[o]),s),{})},_setApiField(a,s){this._api[a]=s},getApiField(a){return this._api[a]},setClientId(a){this._clientId=a},getClientId(){return this._clientId},getConstant:a=>{switch(a){case"DEFAULT_HOST":return cl;case"DEFAULT_PORT":return ul;case"DEFAULT_BASE_PATH":return pl;case"DEFAULT_API_VERSION":return ml;case"DEFAULT_TIMEOUT":return gl;case"MAX_NETWORK_RETRY_DELAY_SEC":return hl;case"INITIAL_NETWORK_RETRY_DELAY_SEC":return fl}return r[a]},getMaxNetworkRetries(){return this.getApiField("maxNetworkRetries")},_setApiNumberField(a,s,o){const n=_o(a,s,o);this._setApiField(a,n)},getMaxNetworkRetryDelay(){return hl},getInitialNetworkRetryDelay(){return fl},getClientUserAgent(a){return this.getClientUserAgentSeeded(r.USER_AGENT,a)},getClientUserAgentSeeded(a,s){this._platformFunctions.getUname().then(o=>{var n;const i={};for(const d in a)Object.prototype.hasOwnProperty.call(a,d)&&(i[d]=encodeURIComponent((n=a[d])!==null&&n!==void 0?n:"null"));i.uname=encodeURIComponent(o||"UNKNOWN");const l=this.getApiField("httpClient");l&&(i.httplib=encodeURIComponent(l.getClientName())),this._appInfo&&(i.application=this._appInfo),s(JSON.stringify(i))})},getAppInfoAsString(){if(!this._appInfo)return"";let a=this._appInfo.name;return this._appInfo.version&&(a+=`/${this._appInfo.version}`),this._appInfo.url&&(a+=` (${this._appInfo.url})`),a},getTelemetryEnabled(){return this._enableTelemetry},_prepResources(){for(const a in Fa)Object.prototype.hasOwnProperty.call(Fa,a)&&(this[jp(a)]=new Fa[a](this))},_getPropsFromConfig(a){if(!a)return{};const s=typeof a=="string";if(!(a===Object(a)&&!Array.isArray(a))&&!s)throw new Error("Config must either be an object or a string");if(s)return{apiVersion:a};if(Object.keys(a).filter(i=>!vl.includes(i)).length>0)throw new Error(`Config object may only contain the following: ${vl.join(", ")}`);return a},parseEventNotification(a,s,o,n,i,l){const d=this.webhooks.constructEvent(a,s,o,n,i,l);return d.context&&(d.context=jt.parse(d.context)),d.fetchEvent=()=>this._requestSender._rawRequest("GET",`/v2/core/events/${d.id}`,void 0,{stripeContext:d.context},["fetch_event"]),d.fetchRelatedObject=()=>d.related_object?this._requestSender._rawRequest("GET",d.related_object.url,void 0,{stripeContext:d.context},["fetch_related_object"]):Promise.resolve(null),d}},r}const _f=xf(new Yp),_r=new ee;function mn(e){return new _f(e,{apiVersion:"2024-12-18.acacia"})}async function Ef(e,t,r,a,s){const o=await t.prepare(`
    SELECT stripe_customer_id FROM users WHERE id = ?
  `).bind(r).first();if(o!=null&&o.stripe_customer_id)return o.stripe_customer_id;const n=await e.customers.create({email:a,name:s,metadata:{user_id:r.toString()}});return await t.prepare(`
    UPDATE users SET stripe_customer_id = ? WHERE id = ?
  `).bind(n.id,r).run(),n.id}_r.post("/create-checkout-session",j,async e=>{try{const t=e.get("userId"),{plan_id:r,billing_cycle:a="monthly"}=await e.req.json();if(!r)return e.json({error:"plan_id is required"},400);if(!["monthly","yearly"].includes(a))return e.json({error:'billing_cycle must be "monthly" or "yearly"'},400);const s=await e.env.DB.prepare(`
      SELECT id, email, name, stripe_customer_id FROM users WHERE id = ?
    `).bind(t).first();if(!s)return e.json({error:"User not found"},404);const o=await e.env.DB.prepare(`
      SELECT * FROM pricing_plans WHERE id = ? AND is_active = 1
    `).bind(r).first();if(!o)return e.json({error:"Plan not found"},404);const n=mn(e.env.STRIPE_SECRET_KEY),i=await Ef(n,e.env.DB,t,s.email,s.name),l=a==="monthly"?o.price_monthly:o.price_yearly,d=a==="monthly"?o.stripe_price_id_monthly:o.stripe_price_id_yearly,c={customer:i,mode:d?"subscription":"payment",payment_method_types:["card"],success_url:`${new URL(e.req.url).origin}/dashboard?payment=success&session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${new URL(e.req.url).origin}/pricing?payment=cancelled`,metadata:{user_id:t.toString(),plan_id:r.toString(),billing_cycle:a}};d?(c.line_items=[{price:d,quantity:1}],c.subscription_data={metadata:{user_id:t.toString(),plan_id:r.toString()}}):c.line_items=[{price_data:{currency:"usd",product_data:{name:o.display_name,description:o.description},unit_amount:Math.round(l*100),...a==="yearly"&&{recurring:{interval:"year"}},...a==="monthly"&&{recurring:{interval:"month"}}},quantity:1}];const u=await n.checkout.sessions.create(c);return await e.env.DB.prepare(`
      INSERT INTO subscription_payments (
        user_id, plan_id, amount, currency, billing_cycle,
        payment_status, stripe_session_id
      ) VALUES (?, ?, ?, 'USD', ?, 'pending', ?)
    `).bind(t,r,l,a,u.id).run(),e.json({sessionId:u.id,url:u.url})}catch(t){return console.error("Error creating checkout session:",t),e.json({error:"Failed to create checkout session",details:t.message},500)}});_r.get("/config",async e=>e.json({publishableKey:e.env.STRIPE_PUBLISHABLE_KEY}));_r.get("/payment-history",j,async e=>{const t=e.get("userId"),{results:r}=await e.env.DB.prepare(`
    SELECT 
      sp.*,
      pp.display_name as plan_name
    FROM subscription_payments sp
    JOIN pricing_plans pp ON sp.plan_id = pp.id
    WHERE sp.user_id = ?
    ORDER BY sp.created_at DESC
  `).bind(t).all();return e.json({payments:r})});_r.post("/cancel-subscription",j,async e=>{try{const t=e.get("userId"),r=await e.env.DB.prepare(`
      SELECT stripe_customer_id FROM users WHERE id = ?
    `).bind(t).first();if(!(r!=null&&r.stripe_customer_id))return e.json({error:"No active subscription found"},404);const a=mn(e.env.STRIPE_SECRET_KEY),s=await a.subscriptions.list({customer:r.stripe_customer_id,status:"active"});if(s.data.length===0)return e.json({error:"No active subscription found"},404);const o=s.data[0];return await a.subscriptions.cancel(o.id),await e.env.DB.prepare(`
      UPDATE users SET plan_status = 'cancelled' WHERE id = ?
    `).bind(t).run(),e.json({message:"Subscription cancelled successfully",subscription_id:o.id})}catch(t){return console.error("Error cancelling subscription:",t),e.json({error:"Failed to cancel subscription",details:t.message},500)}});_r.post("/webhook",async e=>{try{const t=mn(e.env.STRIPE_SECRET_KEY),r=e.req.header("stripe-signature"),a=await e.req.text();if(!r)return e.json({error:"Missing stripe-signature header"},400);let s;try{s=t.webhooks.constructEvent(a,r,e.env.STRIPE_WEBHOOK_SECRET)}catch(n){return console.error("Webhook signature verification failed:",n.message),e.json({error:`Webhook Error: ${n.message}`},400)}if(await e.env.DB.prepare(`
      SELECT id FROM stripe_events WHERE stripe_event_id = ?
    `).bind(s.id).first())return e.json({received:!0,message:"Event already processed"});switch(await e.env.DB.prepare(`
      INSERT INTO stripe_events (stripe_event_id, event_type, event_data)
      VALUES (?, ?, ?)
    `).bind(s.id,s.type,JSON.stringify(s.data.object)).run(),s.type){case"checkout.session.completed":{const n=s.data.object;await wf(e.env.DB,n);break}case"invoice.payment_succeeded":{const n=s.data.object;await Tf(e.env.DB,n);break}case"invoice.payment_failed":{const n=s.data.object;await Sf(e.env.DB,n);break}case"customer.subscription.deleted":{const n=s.data.object;await Cf(e.env.DB,n);break}default:console.log(`Unhandled event type: ${s.type}`)}return await e.env.DB.prepare(`
      UPDATE stripe_events 
      SET processed = 1, processed_at = CURRENT_TIMESTAMP 
      WHERE stripe_event_id = ?
    `).bind(s.id).run(),e.json({received:!0})}catch(t){return console.error("Webhook processing error:",t),e.req.header("stripe-signature")&&await e.env.DB.prepare(`
        UPDATE stripe_events 
        SET error_message = ?
        WHERE stripe_event_id = ?
      `).bind(t.message,"unknown").run(),e.json({error:"Webhook processing failed",details:t.message},500)}});async function wf(e,t){var n,i,l;const r=parseInt(((n=t.metadata)==null?void 0:n.user_id)||"0"),a=parseInt(((i=t.metadata)==null?void 0:i.plan_id)||"0"),s=((l=t.metadata)==null?void 0:l.billing_cycle)||"monthly";if(!r||!a){console.error("Missing metadata in checkout session");return}await e.prepare(`
    UPDATE subscription_payments
    SET 
      payment_status = 'completed',
      paid_at = CURRENT_TIMESTAMP,
      stripe_subscription_id = ?
    WHERE stripe_session_id = ?
  `).bind(t.subscription||null,t.id).run();const o=s==="yearly"?365:30;await e.prepare(`
    UPDATE users
    SET 
      plan_id = ?,
      plan_status = 'active',
      billing_cycle = ?,
      plan_started_at = CURRENT_TIMESTAMP,
      plan_expires_at = datetime(CURRENT_TIMESTAMP, '+${o} days')
    WHERE id = ?
  `).bind(a,s,r).run(),await e.prepare(`
    INSERT INTO plan_usage_history (
      user_id, plan_id, action, billing_cycle,
      started_at, expires_at, price_paid
    ) VALUES (?, ?, 'purchase', ?, CURRENT_TIMESTAMP, 
      datetime(CURRENT_TIMESTAMP, '+${o} days'), ?)
  `).bind(r,a,s,t.amount_total?t.amount_total/100:0).run(),console.log(`✅ Checkout completed for user ${r}, plan ${a}`)}async function Tf(e,t){const r=t.customer;t.subscription;const a=await e.prepare(`
    SELECT id FROM users WHERE stripe_customer_id = ?
  `).bind(r).first();if(!a){console.error("User not found for customer:",r);return}await e.prepare(`
    UPDATE users
    SET 
      plan_status = 'active',
      plan_expires_at = datetime(CURRENT_TIMESTAMP, '+30 days')
    WHERE id = ?
  `).bind(a.id).run(),console.log(`✅ Invoice payment succeeded for user ${a.id}`)}async function Sf(e,t){const r=t.customer,a=await e.prepare(`
    SELECT id FROM users WHERE stripe_customer_id = ?
  `).bind(r).first();if(!a){console.error("User not found for customer:",r);return}await e.prepare(`
    UPDATE users SET plan_status = 'payment_failed' WHERE id = ?
  `).bind(a.id).run(),console.log(`❌ Invoice payment failed for user ${a.id}`)}async function Cf(e,t){const r=t.customer,a=await e.prepare(`
    SELECT id FROM users WHERE stripe_customer_id = ?
  `).bind(r).first();if(!a){console.error("User not found for customer:",r);return}await e.prepare(`
    UPDATE users
    SET 
      plan_id = 1,
      plan_status = 'cancelled',
      plan_expires_at = CURRENT_TIMESTAMP
    WHERE id = ?
  `).bind(a.id).run(),console.log(`🗑️ Subscription deleted for user ${a.id}`)}const le=new ee;le.get("/goals",j,async e=>{const t=e.get("userId"),r=e.get("role");try{if(r==="admin"){const{results:o}=await e.env.DB.prepare(`
        SELECT g.id, g.user_id, g.description, g.status, g.target_value, g.current_value, 
               g.deadline, g.category, g.task, g.priority, g.priority_label, g.cadence, g.dri, 
               g.goal_status, g.day_mon, g.day_tue, g.day_wed, g.day_thu, g.day_fri, g.day_sat, g.day_sun,
               g.week_1, g.week_2, g.week_3, g.week_4, g.week_5,
               g.hypothesis_expected_behavior, g.hypothesis_validation_signal, g.hypothesis_status,
               g.build_tech_stack, g.build_hours_spent, g.build_hypothesis_id,
               g.users_spoken, g.users_used_product, g.key_learning,
               g.users_interacted, g.repeated_actions, g.drop_off_points, g.key_insight,
               g.week_number, g.year_number,
               gwt.revenue_amount as traction_revenue, gwt.new_users as traction_new_users,
               gwt.active_users as traction_active_users, gwt.churned_users as traction_churned,
               gwt.strongest_signal as traction_signal,
               g.week_of, g.order_index, g.created_at, g.updated_at,
               u.name as user_name, u.email as user_email
        FROM goals g
        LEFT JOIN users u ON g.user_id = u.id
        LEFT JOIN goal_weekly_traction gwt ON g.week_number = gwt.week_number 
                                           AND g.year_number = gwt.year 
                                           AND g.user_id = gwt.user_id
                                           AND g.category = 'traction'
        ORDER BY g.created_at DESC
      `).all();return e.json({goals:o||[],isAdmin:!0})}const a=await e.env.DB.prepare(`
      SELECT team_id
      FROM startup_team_members
      WHERE user_id = ?
      ORDER BY is_creator DESC, joined_at ASC
      LIMIT 1
    `).bind(t).first();let s;return a&&a.team_id?s=await e.env.DB.prepare(`
        SELECT 
          g.id, g.user_id, g.description, g.status, g.target_value, g.current_value, 
          g.deadline, g.category, g.task, g.priority, g.priority_label, g.cadence, g.dri, 
          g.assigned_to_user_id, g.priority_order,
          g.goal_status, g.day_mon, g.day_tue, g.day_wed, g.day_thu, g.day_fri, g.day_sat, g.day_sun,
          g.week_1, g.week_2, g.week_3, g.week_4, g.week_5,
          g.scheduled_dates,
          g.hypothesis_expected_behavior, g.hypothesis_validation_signal, g.hypothesis_status,
          g.build_tech_stack, g.build_hours_spent, g.build_hypothesis_id,
          g.users_spoken, g.users_used_product, g.key_learning,
          g.users_interacted, g.repeated_actions, g.drop_off_points, g.key_insight,
          g.week_number, g.year_number,
          gwt.revenue_amount as traction_revenue, gwt.new_users as traction_new_users,
          gwt.active_users as traction_active_users, gwt.churned_users as traction_churned,
          gwt.strongest_signal as traction_signal,
          g.week_of, g.order_index, g.created_at, g.updated_at,
          u.name as creator_name,
          u.avatar_url as creator_avatar,
          assigned_user.name as assigned_user_name,
          assigned_user.email as assigned_user_email,
          assigned_user.avatar_url as assigned_user_avatar
        FROM goals g
        INNER JOIN startup_team_members stm ON g.user_id = stm.user_id
        LEFT JOIN users u ON g.user_id = u.id
        LEFT JOIN users assigned_user ON g.assigned_to_user_id = assigned_user.id
        LEFT JOIN goal_weekly_traction gwt ON g.week_number = gwt.week_number 
                                           AND g.year_number = gwt.year 
                                           AND g.user_id = gwt.user_id
                                           AND g.category = 'traction'
        WHERE stm.team_id = ?
        ORDER BY g.priority_order ASC, g.order_index ASC, g.priority ASC, g.created_at DESC
      `).bind(a.team_id).all():s=await e.env.DB.prepare(`
        SELECT g.id, g.user_id, g.description, g.status, g.target_value, g.current_value, 
               g.deadline, g.category, g.task, g.priority, g.priority_label, g.cadence, g.dri, 
               g.assigned_to_user_id, g.priority_order,
               g.goal_status, g.day_mon, g.day_tue, g.day_wed, g.day_thu, g.day_fri, g.day_sat, g.day_sun,
               g.scheduled_dates,
               g.hypothesis_expected_behavior, g.hypothesis_validation_signal, g.hypothesis_status,
               g.build_tech_stack, g.build_hours_spent, g.build_hypothesis_id,
               g.users_spoken, g.users_used_product, g.key_learning,
               g.users_interacted, g.repeated_actions, g.drop_off_points, g.key_insight,
               g.week_number, g.year_number,
               gwt.revenue_amount as traction_revenue, gwt.new_users as traction_new_users,
               gwt.active_users as traction_active_users, gwt.churned_users as traction_churned,
               gwt.strongest_signal as traction_signal,
               g.week_of, g.order_index, g.created_at, g.updated_at,
               assigned_user.name as assigned_user_name,
               assigned_user.email as assigned_user_email,
               assigned_user.avatar_url as assigned_user_avatar
        FROM goals g
        LEFT JOIN users assigned_user ON g.assigned_to_user_id = assigned_user.id
        LEFT JOIN goal_weekly_traction gwt ON g.week_number = gwt.week_number 
                                           AND g.year_number = gwt.year 
                                           AND g.user_id = gwt.user_id
                                           AND g.category = 'traction'
        WHERE g.user_id = ? 
        ORDER BY g.priority_order ASC, g.order_index ASC, g.priority ASC, g.created_at DESC
      `).bind(t).all(),e.json({goals:s.results||[]})}catch(a){return console.error("Error fetching goals:",a),e.json({goals:[]})}});le.get("/goals/user/:userId",j,async e=>{const t=e.get("userId"),r=e.get("role"),a=e.req.param("userId");console.log("Goals/user endpoint - requestUserId:",t,"userRole:",r,"targetUserId:",a);let s=!1;if(t){const o=await e.env.DB.prepare("SELECT role FROM users WHERE id = ?").bind(t).first();s=(o==null?void 0:o.role)==="admin",console.log("User from DB:",o,"isAdmin:",s)}if(!s&&t!==parseInt(a))return console.log("Access denied - not admin and not own user"),e.json({error:"Unauthorized",details:{isAdmin:s,requestUserId:t,targetUserId:a}},403);try{const{results:o}=await e.env.DB.prepare(`
      SELECT id, user_id, description, status, target_value, current_value, 
             deadline, category, task, priority, priority_label, cadence, dri, 
             goal_status, day_mon, day_tue, day_wed, day_thu, day_fri, day_sat, day_sun,
             week_of, order_index, created_at, updated_at
      FROM goals 
      WHERE user_id = ? 
      ORDER BY order_index ASC, priority ASC, created_at DESC
    `).bind(a).all();return console.log("Found",(o==null?void 0:o.length)||0,"goals for user",a),e.json({goals:o||[]})}catch(o){return console.error("Error fetching user goals:",o),e.json({goals:[],error:o.message},500)}});le.post("/goals",j,async e=>{const t=e.get("userId"),r=await e.req.json(),{description:a,target_value:s,current_value:o,deadline:n,category:i,task:l,priority:d,priority_label:c,cadence:u,dri:p,assigned_to_user_id:m,goal_status:g,week_of:b,order_index:v}=r;if(!(a!=null&&a.trim()))return e.json({error:"Description is required"},400);try{if(m){const f=await e.env.DB.prepare(`
        SELECT team_id
        FROM startup_team_members
        WHERE user_id = ?
        LIMIT 1
      `).bind(t).first();if(f&&!await e.env.DB.prepare(`
          SELECT user_id
          FROM startup_team_members
          WHERE team_id = ? AND user_id = ?
        `).bind(f.team_id,m).first())return e.json({error:"Assigned user is not in your team"},400)}const y=await e.env.DB.prepare(`
      INSERT INTO goals (
        user_id, description, target_value, current_value, deadline, category, 
        task, priority, priority_label, cadence, dri, assigned_to_user_id, 
        goal_status, week_of, order_index, status
      ) 
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'active') 
      RETURNING *
    `).bind(t,a.trim(),s||100,o||0,n||null,i||"Build",l||a.trim(),d||"P0",c||"Urgent & important",u||"One time",p||null,m||null,g||"To start",b||null,v||0).first();return e.json({goal:y,success:!0},201)}catch(y){return console.error("Error creating goal:",y),e.json({error:"Failed to create goal"},500)}});le.put("/goals/:id",j,async e=>{var P,D,k;const t=e.get("userId"),r=e.req.param("id");let a;try{a=await e.req.json(),console.log("[GOAL UPDATE] goalId:",r,"userId:",t,"body:",JSON.stringify(a))}catch(T){return console.error("[GOAL UPDATE] Failed to parse body:",T==null?void 0:T.message),e.json({error:"Invalid request body"},400)}const{status:s,current_value:o,target_value:n,description:i,task:l,priority:d,priority_label:c,cadence:u,dri:p,assigned_to_user_id:m,goal_status:g,day_mon:b,day_tue:v,day_wed:y,day_thu:f,day_fri:x,day_sat:_,day_sun:C,week_1:A,week_2:I,week_3:M,week_4:F,week_5:N,scheduled_dates:E,week_of:O,order_index:B,category:H}=a;try{if(m!==void 0){const Y=await e.env.DB.prepare(`
        SELECT team_id
        FROM startup_team_members
        WHERE user_id = ?
        LIMIT 1
      `).bind(t).first();if(Y&&m!==null&&!await e.env.DB.prepare(`
          SELECT user_id
          FROM startup_team_members
          WHERE team_id = ? AND user_id = ?
        `).bind(Y.team_id,m).first())return e.json({error:"Assigned user is not in your team"},400)}const T=[],L=[];if(s!==void 0&&(T.push("status = ?"),L.push(s)),o!==void 0&&(T.push("current_value = ?"),L.push(o)),n!==void 0&&(T.push("target_value = ?"),L.push(n)),i!==void 0&&(T.push("description = ?"),L.push(i)),l!==void 0&&(T.push("task = ?"),L.push(l)),d!==void 0&&(T.push("priority = ?"),L.push(d)),c!==void 0&&(T.push("priority_label = ?"),L.push(c)),u!==void 0&&(T.push("cadence = ?"),L.push(u)),p!==void 0&&(T.push("dri = ?"),L.push(p)),m!==void 0&&(T.push("assigned_to_user_id = ?"),L.push(m)),g!==void 0&&(T.push("goal_status = ?"),L.push(g)),b!==void 0&&(T.push("day_mon = ?"),L.push(b)),v!==void 0&&(T.push("day_tue = ?"),L.push(v)),y!==void 0&&(T.push("day_wed = ?"),L.push(y)),f!==void 0&&(T.push("day_thu = ?"),L.push(f)),x!==void 0&&(T.push("day_fri = ?"),L.push(x)),_!==void 0&&(T.push("day_sat = ?"),L.push(_)),C!==void 0&&(T.push("day_sun = ?"),L.push(C)),A!==void 0&&(T.push("week_1 = ?"),L.push(A)),I!==void 0&&(T.push("week_2 = ?"),L.push(I)),M!==void 0&&(T.push("week_3 = ?"),L.push(M)),F!==void 0&&(T.push("week_4 = ?"),L.push(F)),N!==void 0&&(T.push("week_5 = ?"),L.push(N)),E!==void 0){T.push("scheduled_dates = ?");let Y;typeof E=="string"?Y=E:Array.isArray(E)?Y=JSON.stringify(E):Y="[]",L.push(Y),console.log("[GOAL UPDATE] Setting scheduled_dates to:",Y)}if(O!==void 0&&(T.push("week_of = ?"),L.push(O)),B!==void 0&&(T.push("order_index = ?"),L.push(B)),H!==void 0&&(T.push("category = ?"),L.push(H)),T.length===0)return e.json({error:"No fields to update"},400);T.push("updated_at = CURRENT_TIMESTAMP");const ae=`
      UPDATE goals 
      SET ${T.join(", ")}
      WHERE id = ?
    `,ce=[...L,r];console.log("[GOAL UPDATE] Query:",ae),console.log("[GOAL UPDATE] Values:",JSON.stringify(ce));try{const Y=await e.env.DB.prepare(ae).bind(...ce).run();return console.log("[GOAL UPDATE] Success! Rows affected:",(P=Y.meta)==null?void 0:P.changes),((D=Y.meta)==null?void 0:D.changes)===0?e.json({error:"Goal not found or no permission to update"},404):e.json({success:!0,rowsAffected:(k=Y.meta)==null?void 0:k.changes})}catch(Y){return console.error("[GOAL UPDATE] Database error:",Y==null?void 0:Y.message,Y),e.json({error:"Database error",details:Y==null?void 0:Y.message},500)}}catch(T){return console.error("Error updating goal:",(T==null?void 0:T.message)||T,"Stack:",T==null?void 0:T.stack),e.json({error:"Failed to update goal",details:T==null?void 0:T.message},500)}});le.delete("/goals/:id",j,async e=>{const t=e.get("userId"),r=e.req.param("id");try{return await e.env.DB.prepare(`
      DELETE FROM goals WHERE id = ? AND user_id = ?
    `).bind(r,t).run(),e.json({success:!0})}catch(a){return console.error("Error deleting goal:",a),e.json({error:"Failed to delete goal"},500)}});le.post("/goals/complete",j,async e=>{const t=e.get("userId"),{goalId:r}=await e.req.json();try{return await e.env.DB.prepare(`
      UPDATE goals 
      SET status = 'completed', 
          current_value = target_value, 
          updated_at = CURRENT_TIMESTAMP 
      WHERE id = ? AND user_id = ?
    `).bind(r,t).run(),e.json({success:!0})}catch(a){return console.error("Error completing goal:",a),e.json({error:"Failed to complete goal"},500)}});le.get("/primary-metrics",j,async e=>{const t=e.get("userId");try{const r=await e.env.DB.prepare("SELECT * FROM primary_metrics WHERE user_id = ?").bind(t).first();return r?e.json({primaryMetrics:r}):(await e.env.DB.prepare("INSERT INTO primary_metrics (user_id, metric1_name, metric2_name) VALUES (?, ?, ?)").bind(t,"users","revenue").run(),e.json({primaryMetrics:{metric1_name:"users",metric2_name:"revenue"}}))}catch(r){return console.error("Error in primary-metrics:",r),e.json({primaryMetrics:{metric1_name:"users",metric2_name:"revenue"}})}});le.put("/primary-metrics",j,async e=>{const t=e.get("userId"),{metric1_name:r,metric2_name:a}=await e.req.json(),s=["users","revenue","conversion","churn","mrr","arr"];if(!s.includes(r)||!s.includes(a))return e.json({error:"Invalid metric names"},400);try{return await e.env.DB.prepare("INSERT OR REPLACE INTO primary_metrics (user_id, metric1_name, metric2_name, updated_at) VALUES (?, ?, ?, CURRENT_TIMESTAMP)").bind(t,r,a).run(),e.json({success:!0})}catch(o){return console.error("Error updating primary metrics:",o),e.json({error:"Failed to update primary metrics"},500)}});le.get("/metrics-history",j,async e=>{const t=e.get("userId");try{const r=await e.env.DB.prepare(`
      SELECT team_id
      FROM startup_team_members
      WHERE user_id = ?
      ORDER BY is_creator DESC, joined_at ASC
      LIMIT 1
    `).bind(t).first();let a;return r&&r.team_id?a=(await e.env.DB.prepare(`
        SELECT um.id, um.metric_name, um.metric_value, um.recorded_date, um.created_at
        FROM user_metrics um
        INNER JOIN startup_team_members stm ON um.user_id = stm.user_id
        WHERE stm.team_id = ?
        ORDER BY um.recorded_date DESC, um.created_at DESC
        LIMIT 100
      `).bind(r.team_id).all()).results:a=(await e.env.DB.prepare(`
        SELECT id, metric_name, metric_value, recorded_date, created_at
        FROM user_metrics 
        WHERE user_id = ? 
        ORDER BY recorded_date DESC, created_at DESC
        LIMIT 100
      `).bind(t).all()).results,e.json({metricsHistory:a||[]})}catch(r){return console.error("Error fetching metrics history:",r),e.json({metricsHistory:[]})}});le.post("/metrics",j,async e=>{const t=e.get("userId"),{metric_name:r,metric_value:a,recorded_date:s}=await e.req.json();if(!["users","revenue","conversion","churn","mrr","arr"].includes(r))return e.json({error:"Invalid metric name"},400);if(typeof a!="number"||a<0)return e.json({error:"Invalid metric value"},400);const n=s||new Date().toISOString().split("T")[0];try{const i=await e.env.DB.prepare(`
      INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date) 
      VALUES (?, ?, ?, ?)
      RETURNING *
    `).bind(t,r,a,n).first();return e.json({metric:i,success:!0},201)}catch(i){return console.error("Error adding metric:",i),e.json({error:"Failed to add metric"},500)}});le.delete("/metrics/:id",j,async e=>{const t=e.get("userId"),r=e.req.param("id");try{return await e.env.DB.prepare(`
      DELETE FROM user_metrics WHERE id = ? AND user_id = ?
    `).bind(r,t).run(),e.json({success:!0})}catch(a){return console.error("Error deleting metric:",a),e.json({error:"Failed to delete metric"},500)}});le.get("/goals/:id/daily-completion",j,async e=>{const t=e.req.param("id");try{const{results:r}=await e.env.DB.prepare(`
      SELECT completion_date, is_completed, completed_at
      FROM goal_daily_completion
      WHERE goal_id = ?
      ORDER BY completion_date ASC
    `).bind(t).all();return e.json({dailyCompletion:r||[]})}catch(r){return console.error("Error fetching daily completion:",r),e.json({dailyCompletion:[]})}});le.post("/goals/:id/daily-completion",j,async e=>{const t=e.req.param("id"),{completion_date:r}=await e.req.json();if(!r)return e.json({error:"completion_date is required"},400);try{const a=await e.env.DB.prepare(`
      SELECT is_completed FROM goal_daily_completion
      WHERE goal_id = ? AND completion_date = ?
    `).bind(t,r).first();if(a){const s=a.is_completed===1?0:1;return await e.env.DB.prepare(`
        UPDATE goal_daily_completion
        SET is_completed = ?, 
            completed_at = CASE WHEN ? = 1 THEN CURRENT_TIMESTAMP ELSE NULL END,
            updated_at = CURRENT_TIMESTAMP
        WHERE goal_id = ? AND completion_date = ?
      `).bind(s,s,t,r).run(),e.json({success:!0,is_completed:s===1})}else return await e.env.DB.prepare(`
        INSERT INTO goal_daily_completion (goal_id, completion_date, is_completed, completed_at)
        VALUES (?, ?, 1, CURRENT_TIMESTAMP)
      `).bind(t,r).run(),e.json({success:!0,is_completed:!0})}catch(a){return console.error("Error toggling daily completion:",a),e.json({error:"Failed to update daily completion"},500)}});le.put("/goals/:id/priority-order",j,async e=>{const t=e.req.param("id"),{priority_order:r}=await e.req.json();if(r===void 0)return e.json({error:"priority_order is required"},400);try{return await e.env.DB.prepare(`
      UPDATE goals
      SET priority_order = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(r,t).run(),e.json({success:!0})}catch(a){return console.error("Error updating priority order:",a),e.json({error:"Failed to update priority order"},500)}});le.get("/team-members",j,async e=>{const t=e.get("userId");try{const r=await e.env.DB.prepare(`
      SELECT team_id
      FROM startup_team_members
      WHERE user_id = ?
      ORDER BY is_creator DESC, joined_at ASC
      LIMIT 1
    `).bind(t).first();if(!r||!r.team_id)return e.json({teamMembers:[]});const{results:a}=await e.env.DB.prepare(`
      SELECT 
        u.id as user_id,
        u.name,
        u.email,
        u.avatar_url,
        stm.role,
        stm.is_creator
      FROM startup_team_members stm
      INNER JOIN users u ON stm.user_id = u.id
      WHERE stm.team_id = ?
      ORDER BY stm.is_creator DESC, u.name ASC
    `).bind(r.team_id).all();return console.log("[TEAM-MEMBERS] Found",(a==null?void 0:a.length)||0,"team members for team",r.team_id),e.json({teamMembers:a||[]})}catch(r){return console.error("Error fetching team members:",r),e.json({teamMembers:[]})}});le.get("/weekly-updates",j,async e=>{const t=e.get("userId");try{const{results:r}=await e.env.DB.prepare("SELECT * FROM weekly_updates WHERE user_id = ? ORDER BY created_at DESC LIMIT 12").bind(t).all();return e.json({weeklyUpdates:r||[]})}catch{return e.json({weeklyUpdates:[]})}});le.post("/weekly-updates",j,async e=>{const t=e.get("userId"),{week:r,goalStatuses:a}=await e.req.json();try{const s=await e.env.DB.prepare("INSERT INTO weekly_updates (user_id, week, goal_statuses) VALUES (?, ?, ?) RETURNING *").bind(t,r,JSON.stringify(a)).first();return e.json({weeklyUpdate:s,success:!0},201)}catch{return e.json({error:"Failed to create weekly update"},500)}});le.get("/achievements",j,async e=>{const t=e.get("userId");try{const{results:r}=await e.env.DB.prepare("SELECT * FROM achievements WHERE user_id = ? ORDER BY created_at DESC").bind(t).all();return e.json({achievements:r||[]})}catch{return e.json({achievements:[]})}});le.post("/achievements",j,async e=>{const t=e.get("userId"),{date:r,description:a}=await e.req.json();try{const s=await e.env.DB.prepare("INSERT INTO achievements (user_id, date, description) VALUES (?, ?, ?) RETURNING *").bind(t,r,a).first();return e.json({achievement:s,success:!0},201)}catch{return e.json({error:"Failed to create achievement"},500)}});le.get("/summary",j,async e=>{const t=e.get("userId");try{const{results:r}=await e.env.DB.prepare(`
      SELECT status, COUNT(*) as count FROM goals WHERE user_id = ? GROUP BY status
    `).bind(t).all(),a={total:0,active:0,completed:0};r==null||r.forEach(l=>{a.total+=l.count,(l.status==="active"||l.status==="in_progress")&&(a.active+=l.count),l.status==="completed"&&(a.completed+=l.count)});const s=await e.env.DB.prepare(`
      SELECT team_id
      FROM startup_team_members
      WHERE user_id = ?
      ORDER BY is_creator DESC, joined_at ASC
      LIMIT 1
    `).bind(t).first();let o;s&&s.team_id?o=(await e.env.DB.prepare(`
        SELECT um.metric_name, um.metric_value
        FROM user_metrics um
        INNER JOIN startup_team_members stm ON um.user_id = stm.user_id
        WHERE stm.team_id = ?
        ORDER BY um.recorded_date DESC, um.created_at DESC
        LIMIT 10
      `).bind(s.team_id).all()).results:o=(await e.env.DB.prepare(`
        SELECT metric_name, metric_value 
        FROM user_metrics 
        WHERE user_id = ? 
        ORDER BY recorded_date DESC, created_at DESC
        LIMIT 10
      `).bind(t).all()).results;const n={};o==null||o.forEach(l=>{n[l.metric_name]||(n[l.metric_name]=l.metric_value)});const i=await e.env.DB.prepare(`
      SELECT COUNT(*) as count FROM achievements WHERE user_id = ?
    `).bind(t).first();return e.json({goals:a,metrics:{users:n.users||0,revenue:n.revenue||0},achievementsCount:(i==null?void 0:i.count)||0,completionRate:a.total>0?Math.round(a.completed/a.total*100):0})}catch(r){return console.error("Error getting summary:",r),e.json({goals:{total:0,active:0,completed:0},metrics:{users:0,revenue:0},achievementsCount:0,completionRate:0})}});le.get("/leaderboard",j,async e=>{const t=e.get("userId");try{const{results:r}=await e.env.DB.prepare("SELECT id, email, name FROM users ORDER BY email").all(),{results:a}=await e.env.DB.prepare("SELECT user_id, status FROM goals").all(),{results:s}=await e.env.DB.prepare("SELECT user_id, metric_name, metric_value FROM user_metrics").all(),{results:o}=await e.env.DB.prepare("SELECT user_id FROM achievements").all(),n=(r==null?void 0:r.map(l=>{var f,x;const d=(a==null?void 0:a.filter(_=>_.user_id===l.id))||[],c=d.length,u=d.filter(_=>_.status==="completed").length,p=(s==null?void 0:s.filter(_=>_.user_id===l.id))||[],m=((f=p.find(_=>_.metric_name==="users"))==null?void 0:f.metric_value)||0,g=((x=p.find(_=>_.metric_name==="revenue"))==null?void 0:x.metric_value)||0,b=(o==null?void 0:o.filter(_=>_.user_id===l.id).length)||0,v=u*10+c*2+p.length*1+b*5,y=c>0?u/c*100:0;return{user_id:l.id,email:l.email,name:l.name||l.email.split("@")[0],total_goals:c,completed_goals:u,completion_rate:Math.round(y),total_users:m,total_revenue:g,achievements_count:b,score:v,is_current_user:l.id===t}}))||[];n.sort((l,d)=>d.score-l.score),n.forEach((l,d)=>{l.rank=d+1});const i=n.find(l=>l.user_id===t);return e.json({leaderboard:n.slice(0,50),current_user:i||null,total_users:(r==null?void 0:r.length)||0})}catch(r){return console.error("Error in leaderboard:",r),e.json({leaderboard:[],current_user:null,total_users:0})}});le.get("/my-stats",j,async e=>{var r,a,s;const t=e.get("userId");try{const{results:o}=await e.env.DB.prepare("SELECT status FROM goals WHERE user_id = ?").bind(t).all(),n=(o==null?void 0:o.length)||0,i=(o==null?void 0:o.filter(b=>b.status==="completed").length)||0,l=await e.env.DB.prepare(`
      SELECT team_id
      FROM startup_team_members
      WHERE user_id = ?
      ORDER BY is_creator DESC, joined_at ASC
      LIMIT 1
    `).bind(t).first();let d;l&&l.team_id?d=(await e.env.DB.prepare(`
        SELECT um.metric_name, um.metric_value
        FROM user_metrics um
        INNER JOIN startup_team_members stm ON um.user_id = stm.user_id
        WHERE stm.team_id = ?
        ORDER BY um.recorded_date DESC
      `).bind(l.team_id).all()).results:d=(await e.env.DB.prepare("SELECT metric_name, metric_value FROM user_metrics WHERE user_id = ? ORDER BY recorded_date DESC").bind(t).all()).results;const c=((r=d==null?void 0:d.find(b=>b.metric_name==="users"))==null?void 0:r.metric_value)||0,u=((a=d==null?void 0:d.find(b=>b.metric_name==="revenue"))==null?void 0:a.metric_value)||0,{results:p}=await e.env.DB.prepare("SELECT COUNT(*) as count FROM achievements WHERE user_id = ?").bind(t).all(),m=((s=p==null?void 0:p[0])==null?void 0:s.count)||0,g=i*10+n*2+((d==null?void 0:d.length)||0)*1+m*5;return e.json({total_goals:n,completed_goals:i,completion_rate:n>0?Math.round(i/n*100):0,latest_users:c,latest_revenue:u,achievements_count:m,score:g})}catch(o){return console.error("Error in my-stats:",o),e.json({total_goals:0,completed_goals:0,completion_rate:0,latest_users:0,latest_revenue:0,achievements_count:0,score:0})}});const Ct=new ee;Ct.use("*",j);Ct.post("/send",async e=>{console.log("Starting validator request send");try{const t=e.get("userId"),r=e.get("userRole");if(console.log("User info:",{founderId:t,userRole:r}),r!=="founder")return console.log("User is not a founder"),e.json({error:"Only founders can send validator requests"},403);const{validatorId:a,projectId:s,message:o}=await e.req.json();if(!a||!o)return e.json({error:"Validator ID and message are required"},400);const n=parseInt(a),i=t,l=s?parseInt(s):null;if(isNaN(n)||isNaN(i)||s&&(l===null||isNaN(l)))return e.json({error:"Invalid ID format"},400);if(!await e.env.DB.prepare(`
      SELECT id, name FROM users WHERE id = ?
    `).bind(i).first())return e.json({error:"Founder account not found"},404);const c=await e.env.DB.prepare(`
      SELECT v.id, v.user_id, u.name, u.email
      FROM validators v
      JOIN users u ON v.user_id = u.id
      WHERE v.id = ?
    `).bind(n).first();if(!c)return console.log("Validator not found:",n),e.json({error:"Validator not found"},404);if(await e.env.DB.prepare(`
      SELECT id FROM validator_requests
      WHERE founder_id = ? AND validator_id = ? AND status = 'pending'
    `).bind(i,n).first())return e.json({error:"You already have a pending request to this validator"},400);console.log("Creating validator request with:",{founderIdNum:i,validatorIdNum:n,projectId:s});const m=(await e.env.DB.prepare(`
      INSERT INTO validator_requests (founder_id, validator_id, project_id, message, status)
      VALUES (?, ?, NULL, ?, 'pending')
    `).bind(i,n,o).run()).meta.last_row_id;console.log("Validator request created with ID:",m);try{await e.env.DB.prepare(`
        INSERT INTO notifications (user_id, type, title, message, link)
        VALUES (?, 'validator_request', ?, ?, ?)
      `).bind(c.user_id,"New Validation Request","A founder wants your opinion on their project",`/marketplace?tab=my-dashboard&section=requests&request=${m}`).run()}catch(g){console.error("Error creating notification:",g)}return e.json({success:!0,requestId:m,message:"Request sent successfully. You will be notified when the validator responds."})}catch(t){console.error("Error sending validator request:",t);const r=t instanceof Error?t.message:"Unknown error";return console.error("Error details:",r),e.json({error:"Failed to send request",details:r},500)}});Ct.get("/pending",async e=>{try{const t=e.get("userId");if(e.get("userRole")!=="validator")return e.json({error:"Only validators can view pending requests"},403);const a=await e.env.DB.prepare(`
      SELECT id FROM validators WHERE user_id = ?
    `).bind(t).first();if(!a)return e.json({error:"Validator profile not found"},404);const s=await e.env.DB.prepare(`
      SELECT 
        vr.id,
        vr.message,
        vr.created_at,
        vr.expires_at,
        vr.project_id,
        u.id as founder_id,
        u.name as founder_name,
        u.email as founder_email,
        u.avatar_url as founder_avatar,
        p.title as project_title,
        p.description as project_description
      FROM validator_requests vr
      JOIN users u ON vr.founder_id = u.id
      LEFT JOIN projects p ON vr.project_id = p.id
      WHERE vr.validator_id = ? AND vr.status = 'pending'
      ORDER BY vr.created_at DESC
    `).bind(a.id).all();return e.json({requests:s.results||[]})}catch(t){return console.error("Error getting pending requests:",t),e.json({error:"Failed to get requests"},500)}});Ct.post("/:id/accept",async e=>{try{const t=e.get("userId"),r=e.get("userRole"),a=e.req.param("id");if(r!=="validator")return e.json({error:"Only validators can accept requests"},403);const s=await e.env.DB.prepare(`
      SELECT id FROM validators WHERE user_id = ?
    `).bind(t).first();if(!s)return e.json({error:"Validator profile not found"},404);const o=await e.env.DB.prepare(`
      SELECT * FROM validator_requests
      WHERE id = ? AND validator_id = ? AND status = 'pending'
    `).bind(a,s.id).first();if(!o)return e.json({error:"Request not found or already responded"},404);await e.env.DB.prepare(`
      UPDATE validator_requests
      SET status = 'accepted', responded_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a).run();const i=(await e.env.DB.prepare(`
      INSERT INTO chat_conversations (request_id, founder_id, validator_id, project_id, status)
      VALUES (?, ?, ?, ?, 'active')
    `).bind(a,o.founder_id,s.id,o.project_id||null).run()).meta.last_row_id;return await e.env.DB.prepare(`
      INSERT INTO notifications (user_id, type, title, message, link)
      VALUES (?, 'request_accepted', ?, ?, ?)
    `).bind(o.founder_id,"Request Accepted!","A validator has accepted your request. You can now chat with them.",`/marketplace?tab=my-dashboard&section=chats&conversation=${i}`).run(),await e.env.DB.prepare(`
      UPDATE validators
      SET total_validations = total_validations + 1
      WHERE id = ?
    `).bind(s.id).run(),e.json({success:!0,conversationId:i,message:"Request accepted. You can now chat with the founder."})}catch(t){return console.error("Error accepting request:",t),e.json({error:"Failed to accept request"},500)}});Ct.post("/:id/reject",async e=>{try{const t=e.get("userId"),r=e.get("userRole"),a=e.req.param("id");if(r!=="validator")return e.json({error:"Only validators can reject requests"},403);const s=await e.env.DB.prepare(`
      SELECT id FROM validators WHERE user_id = ?
    `).bind(t).first();if(!s)return e.json({error:"Validator profile not found"},404);const o=await e.env.DB.prepare(`
      SELECT * FROM validator_requests
      WHERE id = ? AND validator_id = ? AND status = 'pending'
    `).bind(a,s.id).first();return o?(await e.env.DB.prepare(`
      UPDATE validator_requests
      SET status = 'rejected', responded_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a).run(),await e.env.DB.prepare(`
      INSERT INTO notifications (user_id, type, title, message, link)
      VALUES (?, 'request_rejected', ?, ?, ?)
    `).bind(o.founder_id,"Request Declined","A validator has declined your request. Try reaching out to other validators.","/marketplace?tab=validators").run(),e.json({success:!0,message:"Request declined"})):e.json({error:"Request not found or already responded"},404)}catch(t){return console.error("Error rejecting request:",t),e.json({error:"Failed to reject request"},500)}});Ct.get("/sent",async e=>{try{const t=e.get("userId");if(e.get("userRole")!=="founder")return e.json({error:"Only founders can view sent requests"},403);const a=await e.env.DB.prepare(`
      SELECT 
        vr.id,
        vr.message,
        vr.status,
        vr.created_at,
        vr.responded_at,
        vr.project_id,
        v.id as validator_id,
        u.name as validator_name,
        u.avatar_url as validator_avatar,
        v.title as validator_title,
        v.expertise,
        p.title as project_title
      FROM validator_requests vr
      JOIN validators v ON vr.validator_id = v.id
      JOIN users u ON v.user_id = u.id
      LEFT JOIN projects p ON vr.project_id = p.id
      WHERE vr.founder_id = ?
      ORDER BY vr.created_at DESC
    `).bind(t).all();return e.json({requests:a.results||[]})}catch(t){return console.error("Error getting sent requests:",t),e.json({error:"Failed to get requests"},500)}});Ct.get("/stats",async e=>{try{const t=e.get("userId");if(e.get("userRole")!=="founder")return e.json({error:"Only founders can view request stats"},403);const a=await e.env.DB.prepare(`
      SELECT 
        COUNT(*) as total_requests,
        SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
        SUM(CASE WHEN status = 'accepted' THEN 1 ELSE 0 END) as accepted,
        SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END) as rejected,
        COUNT(DISTINCT validator_id) as validators_contacted
      FROM validator_requests
      WHERE founder_id = ?
    `).bind(t).first();return e.json({stats:a||{total_requests:0,pending:0,accepted:0,rejected:0,validators_contacted:0}})}catch(t){return console.error("Error getting request stats:",t),e.json({error:"Failed to get stats"},500)}});const tt=new ee;function If(e){if(!e.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");return e.JWT_SECRET}async function Rf(e,t){try{const r=e.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return e.json({error:"Unauthorized - No token provided"},401);const a=r.substring(7),s=await te(a,If(e.env));e.set("userId",s.userId),e.set("userRole",s.role),e.set("userEmail",s.email),await t()}catch{return e.json({error:"Unauthorized - Invalid token"},401)}}tt.use("*",Rf);tt.post("/conversations",async e=>{try{const t=e.get("userId"),{other_user_id:r,project_id:a}=await e.req.json();if(console.log("[CHAT] Creating conversation",{userId:t,other_user_id:r,project_id:a}),!r)return e.json({error:"other_user_id is required"},400);const s=Math.min(t,r),o=Math.max(t,r);let n=await e.env.DB.prepare(`
      SELECT id FROM user_conversations 
      WHERE user1_id = ? AND user2_id = ? AND status = 'active'
      LIMIT 1
    `).bind(s,o).first();if(n)return console.log("[CHAT] Conversation already exists:",n.id),e.json({conversation_id:n.id,existing:!0});const i=await e.env.DB.prepare(`
      INSERT INTO user_conversations (user1_id, user2_id, status, last_message_at)
      VALUES (?, ?, 'active', CURRENT_TIMESTAMP)
    `).bind(s,o).run();return console.log("[CHAT] Created conversation:",i.meta.last_row_id),e.json({conversation_id:i.meta.last_row_id,existing:!1})}catch(t){return console.error("[CHAT] Error creating conversation:",t),e.json({error:"Failed to create conversation"},500)}});tt.get("/conversations",async e=>{try{const t=e.get("userId"),r=await e.env.DB.prepare(`
      SELECT 
        uc.id,
        uc.user1_id,
        uc.user2_id,
        uc.status,
        uc.last_message_at,
        uc.created_at,
        CASE 
          WHEN uc.user1_id = ? THEN u2.id
          ELSE u1.id
        END as other_user_id,
        CASE 
          WHEN uc.user1_id = ? THEN u2.name
          ELSE u1.name
        END as other_user_name,
        CASE 
          WHEN uc.user1_id = ? THEN u2.avatar_url
          ELSE u1.avatar_url
        END as other_user_avatar,
        (SELECT COUNT(*) FROM user_messages 
         WHERE conversation_id = uc.id 
         AND is_read = 0 
         AND sender_id != ?) as unread_count,
        (SELECT message FROM user_messages 
         WHERE conversation_id = uc.id 
         ORDER BY created_at DESC LIMIT 1) as last_message
      FROM user_conversations uc
      JOIN users u1 ON uc.user1_id = u1.id
      JOIN users u2 ON uc.user2_id = u2.id
      WHERE (uc.user1_id = ? OR uc.user2_id = ?) AND uc.status = 'active'
      ORDER BY uc.last_message_at DESC
    `).bind(t,t,t,t,t,t).all();return e.json({conversations:r.results||[]})}catch(t){return console.error("Error getting conversations:",t),e.json({error:"Failed to get conversations"},500)}});tt.get("/conversations/:id",async e=>{try{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare(`
      SELECT 
        uc.id,
        uc.user1_id,
        uc.user2_id,
        uc.status,
        uc.last_message_at,
        uc.created_at,
        CASE 
          WHEN uc.user1_id = ? THEN u2.id
          ELSE u1.id
        END as other_user_id,
        CASE 
          WHEN uc.user1_id = ? THEN u2.name
          ELSE u1.name
        END as other_user_name,
        CASE 
          WHEN uc.user1_id = ? THEN u2.avatar_url
          ELSE u1.avatar_url
        END as other_user_avatar
      FROM user_conversations uc
      JOIN users u1 ON uc.user1_id = u1.id
      JOIN users u2 ON uc.user2_id = u2.id
      WHERE uc.id = ? AND (uc.user1_id = ? OR uc.user2_id = ?)
    `).bind(t,t,t,r,t,t).first();return a?e.json(a):e.json({error:"Conversation not found"},404)}catch(t){return console.error("Error getting conversation:",t),e.json({error:"Failed to get conversation"},500)}});tt.get("/conversations/:id/messages",async e=>{try{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare(`
      SELECT user1_id, user2_id 
      FROM user_conversations 
      WHERE id = ?
    `).bind(r).first();if(!a)return e.json({error:"Conversation not found"},404);if(!(a.user1_id===t||a.user2_id===t))return e.json({error:"Unauthorized to access this conversation"},403);const o=await e.env.DB.prepare(`
      SELECT 
        um.id,
        um.sender_id,
        um.message,
        um.is_read,
        um.created_at,
        u.name as sender_name,
        u.avatar_url as sender_avatar
      FROM user_messages um
      JOIN users u ON um.sender_id = u.id
      WHERE um.conversation_id = ?
      ORDER BY um.created_at ASC
    `).bind(r).all();return await e.env.DB.prepare(`
      UPDATE user_messages
      SET is_read = 1
      WHERE conversation_id = ? AND sender_id != ? AND is_read = 0
    `).bind(r,t).run(),e.json({messages:o.results||[]})}catch(t){return console.error("Error getting messages:",t),e.json({error:"Failed to get messages"},500)}});tt.post("/conversations/:id/messages",async e=>{try{const t=e.get("userId"),r=e.req.param("id"),{message:a}=await e.req.json();if(!a||a.trim().length===0)return e.json({error:"Message cannot be empty"},400);const s=await e.env.DB.prepare(`
      SELECT user1_id, user2_id 
      FROM user_conversations 
      WHERE id = ? AND status = 'active'
    `).bind(r).first();if(!s)return e.json({error:"Conversation not found or closed"},404);if(!(s.user1_id===t||s.user2_id===t))return e.json({error:"Unauthorized to send messages in this conversation"},403);const n=s.user1_id===t?s.user2_id:s.user1_id,l=(await e.env.DB.prepare(`
      INSERT INTO user_messages (conversation_id, sender_id, message, is_read)
      VALUES (?, ?, ?, 0)
    `).bind(r,t,a.trim()).run()).meta.last_row_id;await e.env.DB.prepare(`
      UPDATE user_conversations
      SET last_message_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(r).run();try{await e.env.DB.prepare(`
        INSERT INTO notifications (user_id, type, title, message, link)
        VALUES (?, 'new_message', ?, ?, ?)
      `).bind(n,"New Message","You have a new message","/dashboard?tab=inbox").run()}catch(d){console.error("Error creating notification:",d)}return e.json({success:!0,messageId:l,message:"Message sent successfully"})}catch(t){return console.error("Error sending message:",t),e.json({error:"Failed to send message"},500)}});tt.get("/unread-count",async e=>{try{const t=e.get("userId"),r=e.get("userRole");let a=0;if(r==="founder")a=(await e.env.DB.prepare(`
        SELECT COUNT(*) as count
        FROM chat_messages cm
        JOIN chat_conversations cc ON cm.conversation_id = cc.id
        WHERE cc.founder_id = ? 
        AND cm.sender_id != ? 
        AND cm.is_read = 0
      `).bind(t,t).first()).count||0;else{const s=await e.env.DB.prepare(`
        SELECT id FROM validators WHERE user_id = ?
      `).bind(t).first();s&&(a=(await e.env.DB.prepare(`
          SELECT COUNT(*) as count
          FROM chat_messages cm
          JOIN chat_conversations cc ON cm.conversation_id = cc.id
          WHERE cc.validator_id = ? 
          AND cm.sender_id != ? 
          AND cm.is_read = 0
        `).bind(s.id,t).first()).count||0)}return e.json({unreadCount:a})}catch(t){return console.error("Error getting unread count:",t),e.json({error:"Failed to get unread count"},500)}});tt.post("/conversations/:id/close",async e=>{try{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare(`
      SELECT founder_id, validator_id
      FROM chat_conversations 
      WHERE id = ?
    `).bind(r).first();if(!a)return e.json({error:"Conversation not found"},404);const s=await e.env.DB.prepare(`
      SELECT user_id FROM validators WHERE id = ?
    `).bind(a.validator_id).first();return a.founder_id===t||s&&s.user_id===t?(await e.env.DB.prepare(`
      UPDATE chat_conversations
      SET status = 'closed'
      WHERE id = ?
    `).bind(r).run(),e.json({success:!0,message:"Conversation closed successfully"})):e.json({error:"Unauthorized to close this conversation"},403)}catch(t){return console.error("Error closing conversation:",t),e.json({error:"Failed to close conversation"},500)}});tt.put("/conversations/:id/read",async e=>{try{const t=e.get("userId"),r=e.req.param("id"),a=await e.env.DB.prepare(`
      SELECT user1_id, user2_id
      FROM user_conversations 
      WHERE id = ?
    `).bind(r).first();return a?a.user1_id===t||a.user2_id===t?(await e.env.DB.prepare(`
      UPDATE user_messages
      SET is_read = 1
      WHERE conversation_id = ? AND sender_id != ? AND is_read = 0
    `).bind(r,t).run(),e.json({success:!0,message:"Messages marked as read"})):e.json({error:"Unauthorized to access this conversation"},403):e.json({error:"Conversation not found"},404)}catch(t){return console.error("Error marking messages as read:",t),e.json({error:"Failed to mark messages as read"},500)}});const Gt=new ee;function Af(e){if(!e.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");return e.JWT_SECRET}async function Of(e,t){try{const r=e.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return e.json({error:"Unauthorized - No token provided"},401);const a=r.substring(7),s=await te(a,Af(e.env));e.set("userId",s.userId),e.set("userRole",s.role),await t()}catch{return e.json({error:"Unauthorized - Invalid token"},401)}}Gt.use("*",Of);Gt.get("/",async e=>{try{const t=e.get("userId"),r=parseInt(e.req.query("limit")||"50"),a=e.req.query("unread_only")==="true";let s=`
      SELECT 
        id,
        type,
        title,
        message,
        link,
        is_read,
        read_at,
        created_at
      FROM notifications
      WHERE user_id = ?
    `;a&&(s+=" AND is_read = 0"),s+=" ORDER BY created_at DESC LIMIT ?";const o=await e.env.DB.prepare(s).bind(t,r).all();return e.json({notifications:o.results||[]})}catch(t){return console.error("Error getting notifications:",t),e.json({error:"Failed to get notifications"},500)}});Gt.get("/unread-count",async e=>{try{const t=e.get("userId"),r=await e.env.DB.prepare(`
      SELECT COUNT(*) as count
      FROM notifications
      WHERE user_id = ? AND is_read = 0
    `).bind(t).first();return e.json({unreadCount:r.count||0})}catch(t){return console.error("Error getting unread count:",t),e.json({error:"Failed to get unread count"},500)}});Gt.post("/:id/mark-read",async e=>{try{const t=e.get("userId"),r=e.req.param("id");return await e.env.DB.prepare(`
      SELECT id FROM notifications WHERE id = ? AND user_id = ?
    `).bind(r,t).first()?(await e.env.DB.prepare(`
      UPDATE notifications
      SET is_read = 1, read_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(r).run(),e.json({success:!0,message:"Notification marked as read"})):e.json({error:"Notification not found"},404)}catch(t){return console.error("Error marking notification as read:",t),e.json({error:"Failed to mark notification as read"},500)}});Gt.post("/mark-all-read",async e=>{try{const t=e.get("userId");return await e.env.DB.prepare(`
      UPDATE notifications
      SET is_read = 1, read_at = CURRENT_TIMESTAMP
      WHERE user_id = ? AND is_read = 0
    `).bind(t).run(),e.json({success:!0,message:"All notifications marked as read"})}catch(t){return console.error("Error marking all notifications as read:",t),e.json({error:"Failed to mark all notifications as read"},500)}});Gt.delete("/:id",async e=>{try{const t=e.get("userId"),r=e.req.param("id");return await e.env.DB.prepare(`
      SELECT id FROM notifications WHERE id = ? AND user_id = ?
    `).bind(r,t).first()?(await e.env.DB.prepare(`
      DELETE FROM notifications WHERE id = ?
    `).bind(r).run(),e.json({success:!0,message:"Notification deleted"})):e.json({error:"Notification not found"},404)}catch(t){return console.error("Error deleting notification:",t),e.json({error:"Failed to delete notification"},500)}});const Ld=new ee;Ld.post("/submit",async e=>{var t,r,a;try{if(console.log("Quick pitch endpoint called"),!e.env.GROQ_API_KEY)return console.error("GROQ_API_KEY is not configured!"),e.json({error:"AI service not configured",details:"GROQ_API_KEY is missing"},500);const s=await e.req.json();console.log("Request body:",s);const{idea:o,problemSolving:n,targetMarket:i,pricingModel:l,userId:d,email:c}=s;if(!d)return e.json({error:"Authentication required",message:"Please sign up or log in to validate your idea",requiresAuth:!0,redirectTo:"/marketplace#signup"},401);if(!o||!n||!i||!l)return e.json({error:"All fields are required"},400);const u=`Analiza esta idea de startup y proporciona un análisis breve en formato JSON:

Idea: ${o}
Problema que resuelve: ${n}
Mercado objetivo: ${i}

Devuelve SOLO un objeto JSON con esta estructura (sin markdown, sin explicaciones extra):
{
  "title": "Título corto y atractivo para la startup (máximo 60 caracteres)",
  "description": "Descripción optimizada y profesional (150-200 palabras)",
  "value_proposition": "Propuesta de valor única en una frase impactante",
  "category": "una de estas: saas, ecommerce, fintech, healthtech, edtech, marketplace, social, productivity, entertainment, other",
  "strengths": ["fortaleza 1", "fortaleza 2", "fortaleza 3"],
  "opportunities": ["oportunidad 1", "oportunidad 2"],
  "ai_score": 85
}`;console.log("Requesting AI analysis from Groq...");const p=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e.env.GROQ_API_KEY||""}`,"Content-Type":"application/json"},body:JSON.stringify({model:"llama-3.3-70b-versatile",messages:[{role:"system",content:"Eres un experto analista de startups. Devuelve SOLO JSON válido, sin markdown ni texto adicional."},{role:"user",content:u}],temperature:.7,max_tokens:1e3})});if(!p.ok)throw console.error("Groq API error:",await p.text()),new Error("Failed to get AI analysis");const g=((a=(r=(t=(await p.json()).choices)==null?void 0:t[0])==null?void 0:r.message)==null?void 0:a.content)||"{}";console.log("AI Response:",g);let b=g.trim();b.startsWith("```json")&&(b=b.replace(/```json\n?/g,"").replace(/```\n?/g,"")),b.startsWith("```")&&(b=b.replace(/```\n?/g,""));let v;try{v=JSON.parse(b)}catch(A){console.error("JSON parse error:",A),console.error("Cleaned response:",b),v={title:o.substring(0,60),description:`${o}

Problema: ${n}

Mercado: ${i}`,value_proposition:n,category:"other",strengths:["Idea innovadora","Mercado identificado"],opportunities:["Validación de mercado","Desarrollo de MVP"],ai_score:70}}let y=d;if(!y){const A=await e.env.DB.prepare(`
        SELECT id FROM users WHERE email = 'anonymous@quickpitch.com' LIMIT 1
      `).first();A?y=A.id:y=(await e.env.DB.prepare(`
          INSERT INTO users (email, username, role, created_at)
          VALUES ('anonymous@quickpitch.com', 'Anonymous Quick Pitch', 'user', CURRENT_TIMESTAMP)
        `).run()).meta.last_row_id}const x=(await e.env.DB.prepare(`
      INSERT INTO projects (
        user_id, 
        title, 
        description, 
        target_market, 
        value_proposition, 
        category, 
        status,
        ai_analysis,
        created_at
      )
      VALUES (?, ?, ?, ?, ?, ?, 'active', ?, CURRENT_TIMESTAMP)
    `).bind(y,v.title,v.description,i,v.value_proposition,v.category||"other",JSON.stringify({strengths:v.strengths||[],opportunities:v.opportunities||[],ai_score:v.ai_score||70,original_idea:o,problem_solving:n})).run()).meta.last_row_id;console.log("Project created successfully:",x);const C=(await e.env.DB.prepare(`
      INSERT INTO beta_products (
        company_user_id,
        title,
        description,
        category,
        stage,
        looking_for,
        compensation_type,
        pricing_model,
        duration_days,
        validators_needed,
        status,
        created_at
      )
      VALUES (?, ?, ?, ?, 'alpha', 'General feedback and validation', 'free_access', ?, 14, 5, 'active', CURRENT_TIMESTAMP)
    `).bind(y,v.title,v.description,v.category||"other",l).run()).meta.last_row_id;return console.log("Product created in marketplace:",C),console.log("Product created in marketplace:",C),e.json({success:!0,message:"Pitch analyzed and project created successfully!",projectId:x,productId:C,analysis:v,redirectTo:"/marketplace#my-dashboard",nextStep:{action:"dashboard",message:"Your project is now live in the marketplace! Set up your goals and start tracking your progress."}})}catch(s){return console.error("Error in quick pitch:",s),e.json({error:"Failed to process pitch",details:s instanceof Error?s.message:"Unknown error"},500)}});const la=new ee;function kf(e){const t=e.toLowerCase().trim();return/^(mis\s+)?goals?$|^ver\s+goals?$|^objetivos?$|^lista/i.test(t)?"LIST_GOALS":/^nuevo\s+goal|^crear\s+goal|^añadir\s+goal|^agregar/i.test(t)?"ADD_GOAL":/^completar|^terminar|^hecho|^completé|^marcar/i.test(t)?"COMPLETE_GOAL":/^usuarios?\s+\d|^revenue\s+\d|^ingresos?\s+\d|^métricas?$|^mis\s+métricas?$/i.test(t)?"ADD_METRIC":/^leaderboard$|^ranking$|^posición$|^top/i.test(t)?"VIEW_LEADERBOARD":/^ayuda$|^help$|^\?$|^comandos$/i.test(t)?"HELP":/^estado$|^status$|^mi\s+cuenta$/i.test(t)?"STATUS":/^login$|^entrar$|^iniciar\s+sesión$/i.test(t)?"LOGIN":"UNKNOWN"}const cr={welcome:`🎯 *¡Bienvenido a LovableGrowth!*

Soy tu asistente de productividad. Te ayudaré a:
• 📋 Gestionar tus goals
• 📊 Registrar métricas
• 🏆 Competir en el leaderboard

Para comenzar, necesito vincular tu cuenta.

📧 *Envía tu email* registrado en LovableGrowth:`,help:`📚 *COMANDOS DISPONIBLES:*

📋 *Goals:*
• mis goals - ver tus goals
• nuevo goal [descripción] - crear goal
• completar [número] - marcar completado

📊 *Métricas:*
• mis métricas - ver historial
• usuarios [número] - registrar usuarios
• revenue [número] - registrar ingresos

🏆 *Ranking:*
• leaderboard - ver posiciones

⚙️ *Cuenta:*
• estado - ver tu estado
• ayuda - ver este mensaje`,unknown:`🤔 No entendí tu mensaje.

Prueba con:
• 'mis goals' - ver goals
• 'completar [#]' - completar goal
• 'nuevo goal [desc]' - crear goal
• 'leaderboard' - ver ranking
• 'ayuda' - ver opciones`,notLinked:`⚠️ Tu cuenta no está vinculada.

Envía tu email de LovableGrowth para vincularla.`,loginRequired:`🔐 Primero necesito vincular tu cuenta.

📧 Envía tu email registrado en LovableGrowth:`};async function Df(e,t,r,a,s){try{const n=new TextEncoder().encode(`${e}:${t}`),i=btoa(String.fromCharCode(...n)),l=await fetch(`https://api.twilio.com/2010-04-01/Accounts/${e}/Messages.json`,{method:"POST",headers:{Authorization:`Basic ${i}`,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({From:r,To:a,Body:s}).toString()});if(!l.ok){const d=await l.text();console.error("Twilio API error:",d)}return l.ok}catch(o){return console.error("Twilio error:",o),!1}}function Vr(e){const t=`<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Message>${Mf(e)}</Message>
</Response>`;return new Response(t,{headers:{"Content-Type":"text/xml"}})}function Mf(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}async function Nf(e,t){const{results:r}=await e.prepare("SELECT * FROM goals WHERE user_id = ? ORDER BY created_at DESC LIMIT 10").bind(t).all();if(!r||r.length===0)return`📋 *TUS GOALS*

No tienes goals aún.

Para crear uno:
> nuevo goal [descripción]

Ejemplo:
> nuevo goal Lanzar MVP esta semana`;const a=r.map((o,n)=>{const i=o.status==="completed"?"✅":"⏳";return`${n+1}. ${i} ${o.description}`}).join(`
`);return`📋 *TUS GOALS* (${r.filter(o=>o.status==="completed").length}/${r.length} completados)

${a}

_Para completar: completar [número]_
_Para añadir: nuevo goal [desc]_`}async function Pf(e,t,r){return!r||r.length<3?`❌ Describe tu goal.

Ejemplo:
> nuevo goal Conseguir 100 usuarios`:(await e.prepare("INSERT INTO goals (user_id, description, status) VALUES (?, ?, ?)").bind(t,r,"in_progress").run(),`✅ *Goal creado:*

"${r}"

¡Mucho éxito! 🚀`)}async function Lf(e,t,r){const{results:a}=await e.prepare("SELECT * FROM goals WHERE user_id = ? ORDER BY created_at DESC LIMIT 10").bind(t).all();if(!a||r<1||r>a.length)return`❌ Número de goal inválido.

Escribe 'mis goals' para ver la lista.`;const s=a[r-1];return await e.prepare("UPDATE goals SET status = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?").bind("completed",s.id).run(),await $f(e,t),`🎉 *¡Goal completado!*

"${s.description}"

Tu progreso ha sido actualizado en el leaderboard.

_Escribe 'leaderboard' para ver tu posición._`}async function jf(e,t,r){let a=null,s=0;const o=r.match(/usuarios?\s+(\d+)/i),n=r.match(/(?:revenue|ingresos?)\s+(\d+(?:\.\d+)?)/i);if(o?(a="users",s=parseInt(o[1],10)):n&&(a="revenue",s=parseFloat(n[1])),!a)return`📊 *REGISTRAR MÉTRICA*

Formatos válidos:
• usuarios [número] - ej: usuarios 150
• revenue [número] - ej: revenue 5000

¿Cuántos usuarios o ingresos quieres registrar?`;try{return await e.prepare(`INSERT INTO user_metrics (user_id, metric_type, value, date) 
       VALUES (?, ?, ?, date('now'))`).bind(t,a,s).run(),`${a==="users"?"👥":"💰"} *Métrica registrada:*

${a==="users"?"usuarios":"revenue"}: ${s.toLocaleString()}

_Escribe 'mis métricas' para ver tu historial._`}catch{return"❌ Error al registrar la métrica. Intenta de nuevo."}}async function Bf(e,t){const{results:r}=await e.prepare(`
    SELECT 
      u.id as userId,
      u.name,
      COALESCE(g.completed, 0) as completed,
      COALESCE(g.total, 0) as total,
      COALESCE(g.completed, 0) * 10 as score
    FROM users u
    LEFT JOIN (
      SELECT 
        user_id,
        COUNT(*) as total,
        SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed
      FROM goals
      GROUP BY user_id
    ) g ON u.id = g.user_id
    ORDER BY score DESC
    LIMIT 10
  `).all();if(!r||r.length===0)return`🏆 *LEADERBOARD*

Aún no hay participantes.

¡Sé el primero en completar goals!`;const a=["🥇","🥈","🥉","4️⃣","5️⃣","6️⃣","7️⃣","8️⃣","9️⃣","🔟"];let s=0;const o=r.map((i,l)=>(i.userId===t&&(s=l+1),`${a[l]} ${i.name||"Anónimo"} - ${i.completed} goals (${i.score} pts)`)).join(`
`),n=s>0?`

📍 *Tu posición:* #${s}`:`

_Completa goals para entrar al ranking_`;return`🏆 *LEADERBOARD TOP 10*

${o}${n}`}async function Ff(e,t,r){var i,l;const a=await e.prepare("SELECT * FROM users WHERE id = ?").bind(t).first(),{results:s}=await e.prepare("SELECT status, COUNT(*) as count FROM goals WHERE user_id = ? GROUP BY status").bind(t).all(),o=((i=s==null?void 0:s.find(d=>d.status==="completed"))==null?void 0:i.count)||0,n=((l=s==null?void 0:s.find(d=>d.status==="in_progress"))==null?void 0:l.count)||0;return`👤 *TU ESTADO*

📧 Email: ${(a==null?void 0:a.email)||"No vinculado"}
📱 WhatsApp: ${r}

📊 *Progreso:*
• Goals completados: ${o}
• Goals en progreso: ${n}
• Puntos: ${o*10}

_Escribe 'mis goals' para ver detalles._`}async function $f(e,t){var o;const{results:r}=await e.prepare(`
    SELECT COUNT(*) as completed FROM goals WHERE user_id = ? AND status = 'completed'
  `).bind(t).all(),a=((o=r==null?void 0:r[0])==null?void 0:o.completed)||0,s=[{count:1,name:"First Goal",description:"Completaste tu primer goal"},{count:5,name:"Getting Started",description:"Completaste 5 goals"},{count:10,name:"Achiever",description:"Completaste 10 goals"},{count:25,name:"Goal Master",description:"Completaste 25 goals"},{count:50,name:"Legend",description:"Completaste 50 goals"}];for(const n of s)a>=n.count&&(await e.prepare("SELECT id FROM achievements WHERE user_id = ? AND name = ?").bind(t,n.name).first()||await e.prepare("INSERT INTO achievements (user_id, name, description, icon, unlocked_at) VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)").bind(t,n.name,n.description,"🏆").run())}async function Hf(e,t,r){const a=await e.prepare("SELECT id, email, name FROM users WHERE email = ?").bind(r.toLowerCase().trim()).first();return a?(await e.prepare(`
    INSERT INTO whatsapp_users (phone_number, user_id, email, is_verified) 
    VALUES (?, ?, ?, 1)
    ON CONFLICT(phone_number) DO UPDATE SET user_id = ?, email = ?, is_verified = 1
  `).bind(t,a.id,a.email,a.id,a.email).run(),`✅ *¡Cuenta vinculada!*

Hola ${a.name||"usuario"} 👋

Tu WhatsApp está ahora conectado a tu cuenta de LovableGrowth.

${cr.help}`):`❌ No encontré una cuenta con ese email.

Verifica que esté bien escrito o regístrate en lovablegrowth.com primero.

📧 Intenta de nuevo:`}la.post("/webhook",async e=>{try{const t=await e.req.parseBody(),r=String(t.From||""),a=String(t.Body||"").trim();console.log(`📨 WhatsApp de ${r}: ${a}`);let s=await e.env.DB.prepare("SELECT * FROM whatsapp_users WHERE phone_number = ?").bind(r).first();if(!s)return await e.env.DB.prepare("INSERT INTO whatsapp_users (phone_number, is_verified) VALUES (?, 0)").bind(r).run(),Vr(cr.welcome);if(!s.is_verified||!s.user_id){if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)){const l=await Hf(e.env.DB,r,a);return Vr(l)}return Vr(cr.loginRequired)}const o=kf(a);let n;switch(o){case"LIST_GOALS":n=await Nf(e.env.DB,s.user_id);break;case"ADD_GOAL":{const i=a.replace(/^(nuevo|crear|añadir|agregar)\s+goal\s*/i,"").trim();n=await Pf(e.env.DB,s.user_id,i);break}case"COMPLETE_GOAL":{const i=a.match(/\d+/),l=i?parseInt(i[0],10):0;n=await Lf(e.env.DB,s.user_id,l);break}case"ADD_METRIC":n=await jf(e.env.DB,s.user_id,a);break;case"VIEW_LEADERBOARD":n=await Bf(e.env.DB,s.user_id);break;case"STATUS":n=await Ff(e.env.DB,s.user_id,r);break;case"HELP":n=cr.help;break;case"LOGIN":n=`Ya estás conectado ✅

Tu cuenta está vinculada correctamente.

${cr.help}`;break;default:n=cr.unknown}return Vr(n)}catch(t){return console.error("Webhook error:",t),Vr("❌ Error interno. Intenta de nuevo.")}});la.get("/webhook",async e=>e.json({status:"ok",message:"WhatsApp webhook activo",timestamp:new Date().toISOString()}));la.get("/info",async e=>{const t=e.env.TWILIO_WHATSAPP_NUMBER||"No configurado",r=e.env.TWILIO_SANDBOX_CODE||"No configurado";return e.json({service:"LovableGrowth WhatsApp Agent",status:"active",twilio_number:t,sandbox_code:r,instructions:{step1:"Guarda el número en tus contactos",step2:`Envía "${r}" para activar el sandbox`,step3:'Escribe "ayuda" para ver comandos'},webhook_url:`${e.req.url.replace("/info","/webhook")}`})});la.post("/send",async e=>{const t=e.req.header("X-API-Key"),r=e.env.INTERNAL_API_KEY;if(!r||t!==r)return e.json({error:"Unauthorized"},401);const a=await e.req.json(),{to:s,message:o}=a;if(!s||!o)return e.json({error:"Missing to or message"},400);const n=e.env.TWILIO_WHATSAPP_NUMBER||"",i=e.env.TWILIO_ACCOUNT_SID||"",l=e.env.TWILIO_AUTH_TOKEN||"",d=await Df(i,l,n,s,o);return e.json({success:d})});const Ae=new ee;Ae.use("*",vr({origin:e=>e||"*",credentials:!0,allowMethods:["GET","POST","PUT","DELETE","OPTIONS"],allowHeaders:["Content-Type","Authorization","Cookie","X-Requested-With"],exposeHeaders:["Set-Cookie"]}));const $e=async(e,t)=>{var a,s,o,n,i;const r=((a=e.req.header("Authorization"))==null?void 0:a.replace("Bearer ",""))||((o=(s=e.req.header("cookie"))==null?void 0:s.match(/authToken=([^;]+)/))==null?void 0:o[1])||((i=(n=e.req.header("Cookie"))==null?void 0:n.match(/authToken=([^;]+)/))==null?void 0:i[1]);if(!r)return e.json({error:"No authentication token provided"},401);try{const l=await te(r,e.env.JWT_SECRET||"your-secret-key-change-in-production-use-env-var");e.set("user",l),await t()}catch{return e.json({error:"Invalid authentication token"},401)}};Ae.get("/status",$e,async e=>{const t=!!e.env.GROQ_API_KEY,r=!!e.env.OPENAI_API_KEY,a=e.env.GROQ_API_KEY?e.env.GROQ_API_KEY.substring(0,10)+"...":"not set";return e.json({ai_enabled:t||r,groq_configured:t,openai_configured:r,groq_key_preview:a,message:t?"AI is enabled with Groq":r?"AI is enabled with OpenAI":"AI is disabled - no API key found"})});async function gn(e,t){var r,a;console.log("[GET-CONTEXT] Fetching context for user:",t);try{console.log("[GET-CONTEXT] Querying goals table...");const s=await e.prepare(`
      SELECT id, description, status, target_value, current_value, deadline, category, created_at
      FROM goals 
      WHERE user_id = ? 
      ORDER BY created_at DESC
    `).bind(t).all();console.log("[GET-CONTEXT] Goals query result:",s);const o=s.results||[];console.log("[GET-CONTEXT] Goals count:",o.length),console.log("[GET-CONTEXT] Querying metrics...");const i=(await e.prepare(`
      SELECT metric_name, metric_value, recorded_date
      FROM user_metrics 
      WHERE user_id = ? 
      ORDER BY recorded_date DESC
      LIMIT 60
    `).bind(t).all()).results||[];console.log("[GET-CONTEXT] Metrics count:",i.length),console.log("[GET-CONTEXT] Querying primary metrics...");const l=await e.prepare(`
      SELECT metric1_name, metric2_name 
      FROM primary_metrics 
      WHERE user_id = ?
    `).bind(t).first(),d=o.filter(y=>y.status==="active"||y.status==="in_progress"),c=o.filter(y=>y.status==="completed");console.log("[GET-CONTEXT] Active goals:",d.length,"Completed:",c.length);const u=((r=i.find(y=>y.metric_name==="users"))==null?void 0:r.metric_value)||0,p=((a=i.find(y=>y.metric_name==="revenue"))==null?void 0:a.metric_value)||0,m=i.filter(y=>y.metric_name==="users"),g=i.filter(y=>y.metric_name==="revenue"),b=m.length>=2?((m[0].metric_value-m[1].metric_value)/(m[1].metric_value||1)*100).toFixed(1):0,v=g.length>=2?((g[0].metric_value-g[1].metric_value)/(g[1].metric_value||1)*100).toFixed(1):0;return console.log("[GET-CONTEXT] Context built successfully"),{goals:{all:o,active:d,completed:c,totalCount:o.length,completedCount:c.length,completionRate:o.length>0?Math.round(c.length/o.length*100):0},metrics:{current:{users:u,revenue:p},growth:{users:b,revenue:v},history:i,primaryConfig:l||{metric1_name:"users",metric2_name:"revenue"}},summary:`
        Startup has ${o.length} goals (${c.length} completed, ${d.length} active).
        Current metrics: ${u} users, $${p} revenue.
        Growth: ${b}% users, ${v}% revenue.
      `}}catch(s){throw console.error("[GET-CONTEXT] ERROR:",s),console.error("[GET-CONTEXT] Error details:",s instanceof Error?s.message:String(s)),s}}async function jd(e,t,r,a,s,o=[]){var c,u;const l={goals:{totalCount:a.goals.totalCount,completedCount:a.goals.completedCount,active:a.goals.active.slice(0,5)},metrics:{current:a.metrics.current,growth:a.metrics.growth}},d=o.slice(-10);if(console.log("[AI] Using conversation history:",d.length,"messages"),e)for(let p=1;p<=2;p++)try{console.log(`[AI] Using Groq API (attempt ${p}/2)`);const m=new AbortController,g=setTimeout(()=>m.abort(),25e3),b=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:"meta-llama/llama-4-maverick-17b-128e-instruct",messages:[{role:"system",content:t},...d.map(y=>({role:y.role,content:y.content})),{role:"user",content:`Contexto: ${JSON.stringify(l)}

Pregunta: ${r}`}],max_tokens:1500,temperature:.7}),signal:m.signal});if(clearTimeout(g),!b.ok){const y=await b.text();if(console.error("[AI] Groq API error:",b.status,y),p<2&&(b.status===429||b.status>=500)){await new Promise(f=>setTimeout(f,1e3*p));continue}throw new Error(`Groq API error: ${b.status}`)}const v=await b.json();return console.log("[AI] Groq response received successfully"),((u=(c=v.choices[0])==null?void 0:c.message)==null?void 0:u.content)||"No pude generar una respuesta."}catch(m){if(console.error(`[AI] Groq attempt ${p} error:`,m),m.name==="AbortError"&&(console.log("[AI] Request timed out"),p<2)){await new Promise(g=>setTimeout(g,500));continue}if(p>=2)throw m;await new Promise(g=>setTimeout(g,1e3*p))}if(s)try{console.log("[AI] Groq failed, using Cloudflare Workers AI as fallback");const p=[{role:"system",content:t},...d.map(g=>({role:g.role,content:g.content})),{role:"user",content:`Contexto: ${JSON.stringify(l)}

Pregunta: ${r}`}];return(await s.run("@cf/meta/llama-3.2-3b-instruct",{messages:p,max_tokens:1500,temperature:.7})).response||"No pude generar una respuesta."}catch(p){console.error("[AI] Cloudflare AI error:",p)}throw console.error("[AI] All AI providers failed, using fallback"),new Error("No AI provider available")}Ae.get("/history",$e,async e=>{const t=e.get("user");try{const r=await e.env.DB.prepare(`
      SELECT id, role, content, created_at FROM agent_chat_messages
      WHERE user_id = ?
      ORDER BY created_at ASC
      LIMIT 50
    `).bind(t.userId).all();return e.json({messages:r.results.map(a=>({id:a.id,role:a.role,content:a.content,timestamp:a.created_at}))})}catch(r){return console.error("Error fetching chat history:",r),e.json({messages:[]})}});Ae.post("/message",$e,async e=>{var _,C,A,I,M,F,N;console.log("[CHAT] === NEW MESSAGE REQUEST ===");const t=e.get("user");console.log("[CHAT] User ID:",t.userId);let r;try{r=await e.req.json(),console.log("[CHAT] Request body:",JSON.stringify(r))}catch(E){return console.error("[CHAT] Failed to parse JSON:",E),e.json({error:"Invalid JSON"},400)}let{message:a,useMetricsAgent:s,useBrandAgent:o,websiteUrl:n,industry:i,stage:l,goalData:d,emailContext:c,flowState:u}=r;if(console.log("[CHAT] Flags:",{useMetricsAgent:s,useBrandAgent:o,websiteUrl:n,industry:i,stage:l,hasGoalData:!!d,emailContext:c,flowState:u}),c&&!(a!=null&&a.trim())){console.log("[CHAT] ========== EMAIL CONTEXT DETECTED =========="),console.log("[CHAT] Context:",c);let E="",O="ASTAR";switch(c){case"hipotesis":E=`💡 **Monday Update — Ideas Day**

Let me capture your hypothesis for this week!

**Question 1 of 3:**
What is your **#1 hypothesis** you will test this week?

_Example: "If new users can complete onboarding in under 2 minutes, more of them will reach the first aha moment."_`,O="hypothesis";break;case"construccion":E=`🛠️ **Tuesday Update — Build Day**

Let me capture your build progress!

**Question 1 of 4:**
What did you **build today**?
_(Feature, flow, or experiment — be specific)_

_Example: "Built a basic onboarding flow that lets users create their first project."_`,O="build";break;case"usuarios":E=`💬 **Wednesday Update — User Learning Day**

Let me capture your user conversations!

**Question 1 of 3:**
How many users did you **speak with today**?
_(Conversations, interviews, or live feedback sessions)_

_Example: "6 users (4 live calls, 2 async chats)"_`,O="user_learning";break;case"metricas":E=`📊 **Thursday Update — Measurement & Insights**

Let me capture your user behavior insights!

**Question 1 of 4:**
How many users **interacted with your product today**?
_(Any meaningful usage)_

_Example: "9 users total"_`,O="insight";break;case"traction":E=`📈 **Friday Update — Traction Metrics**

Let me capture your weekly traction!

**Question 1 of 5:**
How much **revenue** did you generate this week? (€)
_(Cash collected or committed)_

_Example: "€420 (7 users × €60)"_`,O="traction";break;case"reflexion":E=`🧘 **Weekend Reflection**

Share any final thoughts from the week:

• What feedback did you close?
• What signal leaves you most confident (or worried)?

_This is optional — feel free to skip!_`,O="reflect";break;default:E="👋 Hi! How can I help you today?"}return await e.env.DB.prepare(`
      INSERT INTO agent_chat_messages (user_id, role, content, created_at)
      VALUES (?, 'assistant', ?, datetime('now'))
    `).bind(t.userId,E).run(),e.json({message:E,emailContext:c,category:O,flowState:"question_1",waitingForUserResponse:!0})}if(!(a!=null&&a.trim()))return console.error("[CHAT] No message provided"),e.json({error:"Message is required"},400);if(a.includes("__TRIGGER_GOAL_FLOW__"))return console.log("[CHAT] ========== ASTAR TRIGGER DETECTED =========="),a=a.replace("__TRIGGER_GOAL_FLOW__","").trim(),console.log("[CHAT] Cleaned message:",a),e.json({message:a,triggerGoalFlow:!0,category:"ASTAR"});if(c&&(a!=null&&a.trim())){console.log("[CHAT] ========== PROCESSING EMAIL CONTEXT RESPONSE =========="),console.log("[CHAT] Context:",c,"Message:",a,"FlowState:",u);const E=e.env.DB;await E.prepare(`
      INSERT INTO agent_chat_messages (user_id, role, content, created_at)
      VALUES (?, 'user', ?, datetime('now'))
    `).bind(t.userId,a).run();try{let O="",B="",H=!1;switch(c){case"hipotesis":{if(!u||u==="question_1")await E.prepare(`
              INSERT OR REPLACE INTO agent_chat_messages (user_id, role, content, metadata, created_at)
              VALUES (?, 'system', ?, ?, datetime('now'))
            `).bind(t.userId,"temp_hypothesis",JSON.stringify({hypothesis:a})).run(),O=`✅ Got it!

💡 **Hypothesis:** "`+a+`"

---

**Question 2 of 3:**
What **user behavior** do you expect to see if this hypothesis is correct?

_Example: "At least 50% of new users complete onboarding and interact with the core feature within their first session."_`,B="question_2";else if(u==="question_2"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_hypothesis'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{};D.expected_behavior=a,await E.prepare(`
              UPDATE agent_chat_messages 
              SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_hypothesis'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Perfect!

📊 **Expected behavior:** "`+a+`"

---

**Question 3 of 3:**
How will you know the hypothesis is **validated**? (specific signal)

_Example: "6 out of 10 new users complete onboarding and trigger the core action within 24 hours."_`,B="question_3"}else if(u==="question_3"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_hypothesis'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=new Date,T=new Date(k.getFullYear(),0,1),L=Math.ceil(((k.getTime()-T.getTime())/864e5+T.getDay()+1)/7),ae=await E.prepare(`
              INSERT INTO goals (
                user_id, category, description, task, 
                hypothesis_expected_behavior, hypothesis_validation_signal, hypothesis_status,
                priority, priority_label, cadence, goal_status, 
                week_number, year_number, status, created_at
              )
              VALUES (?, 'hypothesis', ?, 'Validate hypothesis', ?, ?, 'testing', 'P1', 'Urgent & important', 'Recurrent', 'To start', ?, ?, 'active', CURRENT_TIMESTAMP)
            `).bind(t.userId,D.hypothesis||a,D.expected_behavior||"",a,L,k.getFullYear()).run();await E.prepare(`
              DELETE FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_hypothesis'
            `).bind(t.userId).run(),H=!0,O=`🎉 **Monday Update Complete!**

---

💡 **Hypothesis:**
"`+D.hypothesis+`"

📊 **Expected behavior:**
"`+D.expected_behavior+`"

✅ **Validation signal:**
"`+a+`"

---

📋 Saved to your Goals with category **hypothesis**
🎯 Goal ID: #`+((_=ae.meta)==null?void 0:_.last_row_id)+`

Good luck validating this week! 🚀`,B="complete"}break}case"construccion":{if(!u||u==="question_1")await E.prepare(`
              INSERT OR REPLACE INTO agent_chat_messages (user_id, role, content, metadata, created_at)
              VALUES (?, 'system', ?, ?, datetime('now'))
            `).bind(t.userId,"temp_build",JSON.stringify({build_description:a})).run(),O=`✅ Great!

🛠️ **Build:** "`+a+`"

---

**Question 2 of 4:**
What **tech stack or tools** did you use?
_(Frameworks, no-code tools, APIs, AI models, etc.)_

_Example: "Frontend: Next.js + Tailwind | Backend: Firebase | AI: OpenAI API"_`,B="question_2";else if(u==="question_2"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_build'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{};D.tech_stack=a,await E.prepare(`
              UPDATE agent_chat_messages SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_build'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Nice stack!

⚙️ **Tech:** `+a+`

---

**Question 3 of 4:**
How **long** did it take you to build this?
_(Approximate hours)_

_Example: "~3.5 hours"_`,B="question_3"}else if(u==="question_3"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_build'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=a.match(/(\d+(?:\.\d+)?)/);D.hours_spent=k?parseFloat(k[1]):0,await E.prepare(`
              UPDATE agent_chat_messages SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_build'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Tracked!

⏱️ **Time:** `+a+`

---

**Question 4 of 4:**
Which **hypothesis** is this build testing?
_(Link it to your Monday hypothesis)_

_Example: "Testing if users can generate a useful output in their first session to increase activation."_`,B="question_4"}else if(u==="question_4"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_build'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=new Date,T=new Date(k.getFullYear(),0,1),L=Math.ceil(((k.getTime()-T.getTime())/864e5+T.getDay()+1)/7),ae=await E.prepare(`
              INSERT INTO goals (
                user_id, category, description, task,
                build_tech_stack, build_hours_spent,
                priority, priority_label, cadence, goal_status,
                week_number, year_number, status, created_at
              )
              VALUES (?, 'build', ?, ?, ?, ?, 'P1', 'Urgent & important', 'Recurrent', 'Done', ?, ?, 'active', CURRENT_TIMESTAMP)
            `).bind(t.userId,D.build_description||"","Build: "+a,D.tech_stack||"",D.hours_spent||0,L,k.getFullYear()).run();await E.prepare(`
              DELETE FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_build'
            `).bind(t.userId).run(),H=!0,O=`🎉 **Tuesday Update Complete!**

---

🛠️ **Built:** "`+D.build_description+`"

⚙️ **Tech stack:** `+D.tech_stack+`

⏱️ **Time spent:** `+D.hours_spent+` hours

💡 **Testing hypothesis:** "`+a+`"

---

📋 Saved to your Goals with category **build**
🎯 Goal ID: #`+((C=ae.meta)==null?void 0:C.last_row_id)+`

Great progress! Keep building! 🚀`,B="complete"}break}case"usuarios":{if(!u||u==="question_1"){const P=a.match(/(\d+)/);await E.prepare(`
              INSERT OR REPLACE INTO agent_chat_messages (user_id, role, content, metadata, created_at)
              VALUES (?, 'system', ?, ?, datetime('now'))
            `).bind(t.userId,"temp_users",JSON.stringify({users_spoken:P?parseInt(P[1]):0})).run(),O=`✅ Great!

💬 **Users spoken:** `+a+`

---

**Question 2 of 3:**
How many of them **actually used the product**?
_(Touched the product, not just gave opinions)_

_Example: "4 users completed the core flow, 2 dropped off during onboarding"_`,B="question_2"}else if(u==="question_2"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_users'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=a.match(/(\d+)/);D.users_used_product=k?parseInt(k[1]):0,D.users_detail=a,await E.prepare(`
              UPDATE agent_chat_messages SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_users'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Noted!

📱 **Used product:** `+a+`

---

**Question 3 of 3:**
What was the **single most important thing** you learned today?
_(One sentence only)_

_Example: "Users understand the value only after seeing a real example, not from the landing page."_`,B="question_3"}else if(u==="question_3"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_users'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=new Date,T=new Date(k.getFullYear(),0,1),L=Math.ceil(((k.getTime()-T.getTime())/864e5+T.getDay()+1)/7),ae=`User Learning Week ${L}: Spoke with ${D.users_spoken||0} users, ${D.users_used_product||0} used the product. ${D.users_detail||"Details in task field."}`,ce=await E.prepare(`
              INSERT INTO goals (
                user_id, category, description, task,
                users_spoken, users_used_product, key_learning,
                priority, priority_label, cadence, goal_status,
                week_number, year_number, status, created_at
              )
              VALUES (?, 'user_learning', ?, ?, ?, ?, ?, 'P1', 'Urgent & important', 'Recurrent', 'Done', ?, ?, 'active', CURRENT_TIMESTAMP)
            `).bind(t.userId,ae,D.users_detail||"User conversations and product usage details",D.users_spoken||0,D.users_used_product||0,a,L,k.getFullYear()).run();await E.prepare(`
              DELETE FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_users'
            `).bind(t.userId).run(),H=!0,O=`🎉 **Wednesday Update Complete!**

---

💬 **Users spoken:** `+D.users_spoken+`

📱 **Used product:** `+(D.users_detail||D.users_used_product)+`

💡 **Key learning:**
"`+a+`"

---

📋 Saved to your Goals with category **user_learning**
🎯 Goal ID: #`+((A=ce.meta)==null?void 0:A.last_row_id)+`

Great insights! Keep talking to users! 🚀`,B="complete"}break}case"metricas":{if(!u||u==="question_1"){const P=a.match(/(\d+)/);await E.prepare(`
              INSERT OR REPLACE INTO agent_chat_messages (user_id, role, content, metadata, created_at)
              VALUES (?, 'system', ?, ?, datetime('now'))
            `).bind(t.userId,"temp_insights",JSON.stringify({users_interacted:P?parseInt(P[1]):0})).run(),O=`✅ Got it!

📊 **Users interacted:** `+a+`

---

**Question 2 of 4:**
What actions did users **repeat most often**?
_(Core behaviors, not edge cases)_

_Example: "6 users generated a second output within the same session, 3 users returned later the same day"_`,B="question_2"}else if(u==="question_2"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_insights'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{};D.repeated_actions=a,await E.prepare(`
              UPDATE agent_chat_messages SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_insights'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Interesting patterns!

🔄 **Repeated actions:** `+a+`

---

**Question 3 of 4:**
Where did users **get stuck, drop off, or ask for help**?

_Example: "Most users hesitated on the pricing screen, 2 users didn't understand what to do after the first result"_`,B="question_3"}else if(u==="question_3"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_insights'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{};D.drop_off_points=a,await E.prepare(`
              UPDATE agent_chat_messages SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_insights'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Important friction points!

⚠️ **Drop-off points:** `+a+`

---

**Question 4 of 4:**
What **insight** does this reveal about your product?
_(One sentence only)_

_Example: "The core feature is valuable, but the next step is unclear after first success."_`,B="question_4"}else if(u==="question_4"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_insights'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=new Date,T=new Date(k.getFullYear(),0,1),L=Math.ceil(((k.getTime()-T.getTime())/864e5+T.getDay()+1)/7),ae=await E.prepare(`
              INSERT INTO goals (
                user_id, category, description, task,
                users_interacted, repeated_actions, drop_off_points, key_insight,
                priority, priority_label, cadence, goal_status,
                week_number, year_number, status, created_at
              )
              VALUES (?, 'insight', ?, 'User behavior insights', ?, ?, ?, ?, 'P1', 'Urgent & important', 'Recurrent', 'Done', ?, ?, 'active', CURRENT_TIMESTAMP)
            `).bind(t.userId,a,D.users_interacted||0,D.repeated_actions||"",D.drop_off_points||"",a,L,k.getFullYear()).run();await E.prepare(`
              DELETE FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_insights'
            `).bind(t.userId).run(),H=!0,O=`🎉 **Thursday Update Complete!**

---

📊 **Users interacted:** `+D.users_interacted+`

🔄 **Repeated actions:** `+D.repeated_actions+`

⚠️ **Drop-off points:** `+D.drop_off_points+`

💡 **Key insight:**
"`+a+`"

---

📋 Saved to your Goals with category **insight**
🎯 Goal ID: #`+((I=ae.meta)==null?void 0:I.last_row_id)+`

Great analysis! Use these insights tomorrow! 🚀`,B="complete"}break}case"traction":{if(!u||u==="question_1"){const P=a.match(/[€$]?(\d+(?:[.,]\d+)?)/);await E.prepare(`
              INSERT OR REPLACE INTO agent_chat_messages (user_id, role, content, metadata, created_at)
              VALUES (?, 'system', ?, ?, datetime('now'))
            `).bind(t.userId,"temp_traction",JSON.stringify({revenue:P?parseFloat(P[1].replace(",",".")):0})).run(),O=`✅ Tracked!

💰 **Revenue:** `+a+`

---

**Question 2 of 5:**
How many **new users** did you acquire this week?

_Example: "18 new users"_`,B="question_2"}else if(u==="question_2"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_traction'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=a.match(/(\d+)/);D.new_users=k?parseInt(k[1]):0,await E.prepare(`
              UPDATE agent_chat_messages SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_traction'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Great!

👥 **New users:** `+a+`

---

**Question 3 of 5:**
How many users were **active** this week?
_(Used the product at least once)_

_Example: "12 users used the product at least once"_`,B="question_3"}else if(u==="question_3"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_traction'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=a.match(/(\d+)/);D.active_users=k?parseInt(k[1]):0,await E.prepare(`
              UPDATE agent_chat_messages SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_traction'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Noted!

📱 **Active users:** `+a+`

---

**Question 4 of 5:**
How many users **churned** this week?
_(Stopped using the product or explicitly dropped off)_

_Example: "3 users stopped using the product"_`,B="question_4"}else if(u==="question_4"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_traction'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=a.match(/(\d+)/);D.churned_users=k?parseInt(k[1]):0,await E.prepare(`
              UPDATE agent_chat_messages SET metadata = ?
              WHERE user_id = ? AND role = 'system' AND content = 'temp_traction'
            `).bind(JSON.stringify(D),t.userId).run(),O=`✅ Important metric!

📉 **Churned:** `+a+`

---

**Question 5 of 5:**
What was the **strongest traction signal** this week?
_(One sentence only)_

_Example: "Two users upgraded without being prompted after their first successful use"_`,B="question_5"}else if(u==="question_5"){const P=await E.prepare(`
              SELECT metadata FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_traction'
              ORDER BY created_at DESC LIMIT 1
            `).bind(t.userId).first(),D=P?JSON.parse(P.metadata):{},k=new Date,T=new Date(k.getFullYear(),0,1),L=Math.ceil(((k.getTime()-T.getTime())/864e5+T.getDay()+1)/7),ae=await E.prepare(`
              INSERT OR REPLACE INTO goal_weekly_traction (
                user_id, revenue_amount, new_users, active_users, churned_users, strongest_signal,
                week_number, year, created_at
              )
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            `).bind(t.userId,D.revenue||0,D.new_users||0,D.active_users||0,D.churned_users||0,a,L,k.getFullYear()).run(),ce=k.toISOString().split("T")[0];await E.prepare(`
              DELETE FROM user_metrics WHERE user_id = ? AND metric_name = 'users' AND recorded_date = ?
            `).bind(t.userId,ce).run(),await E.prepare(`
              INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date)
              VALUES (?, 'users', ?, ?)
            `).bind(t.userId,D.active_users||0,ce).run(),await E.prepare(`
              DELETE FROM user_metrics WHERE user_id = ? AND metric_name = 'revenue' AND recorded_date = ?
            `).bind(t.userId,ce).run(),await E.prepare(`
              INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date)
              VALUES (?, 'revenue', ?, ?)
            `).bind(t.userId,D.revenue||0,ce).run(),await E.prepare(`
              INSERT INTO goals (
                user_id, category, description, task,
                priority, priority_label, cadence, goal_status,
                week_number, year_number, status, created_at
              )
              VALUES (?, 'traction', ?, 'Weekly traction metrics', 'P1', 'Urgent & important', 'Recurrent', 'Done', ?, ?, 'active', CURRENT_TIMESTAMP)
            `).bind(t.userId,a,L,k.getFullYear()).run(),await E.prepare(`
              DELETE FROM agent_chat_messages 
              WHERE user_id = ? AND role = 'system' AND content = 'temp_traction'
            `).bind(t.userId).run(),H=!0,O=`🎉 **Friday Update Complete!**

---

💰 **Revenue:** €`+D.revenue+`

👥 **New users:** `+D.new_users+`

📱 **Active users:** `+D.active_users+`

📉 **Churned:** `+D.churned_users+`

🚀 **Strongest signal:**
"`+a+`"

---

📋 Saved to **weekly traction** metrics
📊 This data will be used for the Weekly Leaderboard!

Great week! See you on the leaderboard! 🏆`,B="complete"}break}case"reflexion":{const P=new Date,D=new Date(P.getFullYear(),0,1),k=Math.ceil(((P.getTime()-D.getTime())/864e5+D.getDay()+1)/7),T=await E.prepare(`
            INSERT INTO goals (
              user_id, category, description, task,
              priority, priority_label, cadence, goal_status,
              week_number, year_number, status, created_at
            )
            VALUES (?, 'reflect', ?, 'Weekly reflection', 'P2', 'Urgent or important', 'Recurrent', 'Done', ?, ?, 'active', CURRENT_TIMESTAMP)
          `).bind(t.userId,a,k,P.getFullYear()).run();H=!0,O=`🎉 **Reflection Saved!**

---

🤔 **Your insight:**
"`+a+`"

---

📋 Saved with category **reflect**
🎯 Goal ID: #`+((M=T.meta)==null?void 0:M.last_row_id)+`

📊 Week `+k+` reflection complete!

Have a restful weekend and come back strong on Monday! 💪`,B="complete";break}}return await E.prepare(`
        INSERT INTO agent_chat_messages (user_id, role, content, created_at)
        VALUES (?, 'assistant', ?, datetime('now'))
      `).bind(t.userId,O).run(),e.json({message:O,goalCreated:H,emailContextProcessed:!0,flowState:B,emailContext:c})}catch(O){console.error("[CHAT] Error processing email context response:",O);const B="❌ Hubo un error al procesar tu respuesta. Por favor, intenta de nuevo.";return await E.prepare(`
        INSERT INTO agent_chat_messages (user_id, role, content, created_at)
        VALUES (?, 'assistant', ?, datetime('now'))
      `).bind(t.userId,B).run(),e.json({message:B})}}if(d){console.log("[CHAT] ========== GOAL CREATION FROM FLOW =========="),console.log("[CHAT] Goal data received:",JSON.stringify(d));try{const E=e.env.DB,O=await E.prepare(`
        INSERT INTO goals (
          user_id, category, description, task, priority, priority_label, 
          cadence, dri, goal_status, week_of, status, created_at
        )
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', CURRENT_TIMESTAMP)
      `).bind(t.userId,d.category||"ASTAR",d.description,d.task||null,d.priority||"P0",d.priority_label||"Urgent & important",d.cadence||"One time",d.dri||null,d.goal_status||"To start",d.week_of||null).run();console.log("[CHAT] Goal created successfully! ID:",(F=O.meta)==null?void 0:F.last_row_id);const B=`✅ Goal created successfully!

📋 **`+d.description+`**
🎯 Task: `+(d.task||"N/A")+`
🏷️ Category: `+d.category+`
⚡ Priority: `+d.priority+" - "+d.priority_label+`
🔄 Cadence: `+d.cadence+`
👤 Owner: `+(d.dri||"Not assigned")+`
📊 Status: `+d.goal_status+`
📅 Week: `+(d.week_of||"Not specified")+`

🆔 Goal ID: `+((N=O.meta)==null?void 0:N.last_row_id)+`

Now available in your dashboard!`;return await E.prepare(`
        INSERT INTO agent_chat_messages (user_id, role, content, created_at)
        VALUES (?, 'user', ?, datetime('now'))
      `).bind(t.userId,a).run(),await E.prepare(`
        INSERT INTO agent_chat_messages (user_id, role, content, created_at)
        VALUES (?, 'assistant', ?, datetime('now'))
      `).bind(t.userId,B).run(),e.json({message:B})}catch(E){console.error("[CHAT] Error creating goal from flow:",E);const O="❌ There was an error creating the goal. Please try again.";try{await e.env.DB.prepare(`
          INSERT INTO agent_chat_messages (user_id, role, content, created_at)
          VALUES (?, 'assistant', ?, datetime('now'))
        `).bind(t.userId,O).run()}catch(B){console.error("[CHAT] DB error:",B)}return e.json({message:O})}}const p=a.toLowerCase();if(["crear goal","create goal","nuevo goal","new goal","crear objetivo","nuevo objetivo","añadir objetivo","agregar objetivo","quiero crear","necesito crear","me gustaria crear","me gustaría crear","registrar goal","definir objetivo","establecer goal","poner un objetivo","añadir goal","agregar goal","add goal","añadir meta","nueva meta","crear una meta","quiero un objetivo","quiero un goal","crea un goal","crea un objetivo","hazme un goal","hazme un objetivo","agrega un goal","agrega un objetivo","pon un objetivo","i want to create","set a goal","add a goal","make a goal"].some(E=>p.includes(E)))return console.log("[CHAT] ========== GOAL CREATION DETECTED =========="),console.log("[CHAT] User wants to create a goal. Triggering flow directly"),await e.env.DB.prepare(`
      INSERT INTO agent_chat_messages (user_id, role, content, created_at)
      VALUES (?, 'user', ?, datetime('now'))
    `).bind(t.userId,a).run(),console.log("[CHAT] Returning goal flow trigger"),e.json({message:"✨ Perfect! Let's create your goal. I'll ask you a few quick questions to complete all the information.",triggerGoalFlow:!0,startFlow:!0});const b=p.includes("genera")&&(p.includes("imagen")||p.includes("imágenes")||p.includes("image"))||p.includes("crea")&&(p.includes("imagen")||p.includes("banner")||p.includes("post"))||p.includes("quiero una imagen")||p.includes("hazme una imagen")||p.includes("crear imagen")||p.includes("generar imagen")||p.includes("diseña")&&(p.includes("banner")||p.includes("post")||p.includes("imagen"))||p.includes("instagram")&&(p.includes("imagen")||p.includes("post")||p.includes("crea")||p.includes("genera"))||p.includes("linkedin")&&(p.includes("imagen")||p.includes("post")||p.includes("crea"))||p.includes("twitter")&&(p.includes("imagen")||p.includes("post"))||p.includes("tiktok")&&(p.includes("imagen")||p.includes("thumbnail"))||p.includes("banner para")||p.includes("imagen para")||p.includes("post para")||p.includes("thumbnail")||p.includes("hero image")||p.includes("imagen de portada")||p.includes("diseño para")&&(p.includes("red")||p.includes("social")),v=p.includes("analiza")&&(p.includes("marca")||p.includes("brand")||p.includes("web")||p.includes("sitio"))||p.includes("plan de marketing")||p.includes("estrategia de marketing")||p.includes("marketing plan")||p.includes("analizar mi marca")||p.includes("análisis de marca")||p.includes("identidad de marca")||p.includes("branding"),y=p.includes("métrica")||p.includes("metrica")||p.includes("analiza")&&(p.includes("dato")||p.includes("número")||p.includes("estadística"))||p.includes("kpi")||p.includes("rendimiento")||p.includes("crecimiento")&&(p.includes("analiza")||p.includes("cómo va")),f=a.match(/https?:\/\/[^\s]+/);let x=n||(f?f[0]:null);console.log("[CHAT] Intent detection:",{wantsImage:b,wantsBrandAnalysis:v,wantsMetrics:y,detectedUrl:x});try{console.log("[CHAT] Saving user message to DB..."),await e.env.DB.prepare(`
      INSERT INTO agent_chat_messages (user_id, role, content, created_at)
      VALUES (?, 'user', ?, datetime('now'))
    `).bind(t.userId,a).run(),console.log("[CHAT] User message saved successfully");let E=e.env.RAILWAY_API_URL||"http://localhost:5000";if(E&&!E.startsWith("http://")&&!E.startsWith("https://")&&(E="https://"+E),b&&E&&!E.includes("localhost")){console.log("[CHAT] Auto-routing to Railway for image generation...");try{const k=await fetch(`${E}/api/agents/brand/generate-images`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({website_url:x||"general",user_id:String(t.userId||t.id||"1"),cloudflare_api_url:new URL(e.req.url).origin,custom_prompt:a})});if(k.ok){const T=await k.json();let L=`🎨 **Generating marketing images...**

`;return T.analysis&&(L+=T.analysis+`

`),T.images_generated>0?(L+=`✅ **${T.images_generated} image(s) generated!**

`,L+=`📸 You can view and approve them in the **AI CMO** section of the menu.

`,L+="💡 *Tip: Approve the ones you like to download them in high resolution.*"):L+="⏳ Images are being processed. Check the **AI CMO** section in a moment.",await e.env.DB.prepare(`
            INSERT INTO agent_chat_messages (user_id, role, content, created_at)
            VALUES (?, 'assistant', ?, datetime('now'))
          `).bind(t.userId,L).run(),e.json({message:L})}}catch(k){console.error("[CHAT] Error generating images:",k)}}if(v&&x&&E&&!E.includes("localhost")){console.log("[CHAT] Auto-routing to Railway for brand analysis...");try{const k=await fetch(`${E}/api/agents/brand/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({website_url:x,custom_prompt:a})});if(k.ok){const T=await k.json();if(T.success&&T.response){const L=`🎨 **BRAND ANALYSIS**

${T.response}`;return await e.env.DB.prepare(`
              INSERT INTO agent_chat_messages (user_id, role, content, created_at)
              VALUES (?, 'assistant', ?, datetime('now'))
            `).bind(t.userId,L).run(),e.json({message:L})}}}catch(k){console.error("[CHAT] Error in brand analysis:",k)}}if(console.log("[CHAT] Railway URL configured as:",E),console.log("[CHAT] Environment check - RAILWAY_API_URL exists:",!!e.env.RAILWAY_API_URL),o&&n){if(console.log("[CHAT] Delegating to Brand Marketing Agent on Railway..."),console.log("[CHAT] Website URL:",n),console.log("[CHAT] Target URL:",`${E}/api/agents/brand/analyze`),E.includes("your-railway-app")||E==="http://localhost:5000"){console.error("[CHAT] Railway URL not configured! Using placeholder.");const k=`⚠️ **Railway is not configured**

Configure \`RAILWAY_API_URL\` in Cloudflare Dashboard > Settings > Environment Variables.

💡 In the meantime, use the normal chat for questions.`;try{await e.env.DB.prepare(`
            INSERT INTO agent_chat_messages (user_id, role, content, created_at)
            VALUES (?, 'assistant', ?, datetime('now'))
          `).bind(t.userId,k).run()}catch(T){console.error("[CHAT] DB error saving message:",T)}return e.json({message:k})}try{const k=await fetch(`${E}/api/agents/brand/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({website_url:n,custom_prompt:a})});if(console.log("[CHAT] Railway response status:",k.status),k.ok){const T=await k.json();if(console.log("[CHAT] Railway response:",T),T.success&&T.response){const L=`🎨 **BRAND ANALYSIS**

${T.response}

---
*Analysis generated by ASTAR* Brand Marketing Agent 🚀*`;return await e.env.DB.prepare(`
              INSERT INTO agent_chat_messages (user_id, role, content, created_at)
              VALUES (?, 'assistant', ?, datetime('now'))
            `).bind(t.userId,L).run(),e.json({message:L})}else throw new Error(T.error||"Agent returned no response")}else{const T=await k.text();throw console.error("[CHAT] Railway API error response:",T),new Error(`Railway API error: ${k.status} - ${T}`)}}catch(k){console.error("[CHAT] Error calling Railway brand agent:",k);const T=`⚠️ **Error conectando con Railway**

${k instanceof Error?k.message:String(k)}

**Verifica:**
- Railway está corriendo
- RAILWAY_API_URL configurado correctamente
- Endpoint /api/agents/brand/analyze existe`;try{await e.env.DB.prepare(`
            INSERT INTO agent_chat_messages (user_id, role, content, created_at)
            VALUES (?, 'assistant', ?, datetime('now'))
          `).bind(t.userId,T).run()}catch(L){console.error("[CHAT] DB error:",L)}return e.json({message:T})}}if(s){if(console.log("[CHAT] Delegating to Metrics Agent on Railway..."),console.log("[CHAT] Target URL:",`${E}/api/agents/metrics/chat`),E.includes("your-railway-app")||E==="http://localhost:5000"){console.error("[CHAT] Railway URL not configured!");const k="⚠️ **Railway no está configurado**\n\nConfigura `RAILWAY_API_URL` en Cloudflare Dashboard.";try{await e.env.DB.prepare(`
            INSERT INTO agent_chat_messages (user_id, role, content, created_at)
            VALUES (?, 'assistant', ?, datetime('now'))
          `).bind(t.userId,k).run()}catch(T){console.error("[CHAT] DB error:",T)}return e.json({message:k})}try{const k=await fetch(`${E}/api/agents/metrics/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t.userId,message:a,session_id:`chat_${t.userId}_${Date.now()}`,industry:i||"SaaS",stage:l||"seed"})});if(console.log("[CHAT] Metrics agent response status:",k.status),k.ok){const T=await k.json();if(console.log("[CHAT] Metrics agent response:",T),T.success&&T.response){const L=`📊 **ANÁLISIS DE MÉTRICAS**

${T.response}

---
*Análisis generado por ASTAR* Metrics Agent 📈*`;return await e.env.DB.prepare(`
              INSERT INTO agent_chat_messages (user_id, role, content, created_at)
              VALUES (?, 'assistant', ?, datetime('now'))
            `).bind(t.userId,L).run(),e.json({message:L})}else throw new Error(T.error||"Agent returned no response")}else{const T=await k.text();throw console.error("[CHAT] Metrics API error response:",T),new Error(`Railway API error: ${k.status} - ${T}`)}}catch(k){console.error("[CHAT] Error calling Railway metrics agent:",k);const T=`⚠️ **Error conectando con Metrics Agent**

${k instanceof Error?k.message:String(k)}

Verifica Railway y RAILWAY_API_URL`;try{await e.env.DB.prepare(`
            INSERT INTO agent_chat_messages (user_id, role, content, created_at)
            VALUES (?, 'assistant', ?, datetime('now'))
          `).bind(t.userId,T).run()}catch(L){console.error("[CHAT] DB error:",L)}return e.json({message:T})}}const B=((await e.env.DB.prepare(`
      SELECT role, content, created_at 
      FROM agent_chat_messages 
      WHERE user_id = ?
      ORDER BY created_at DESC 
      LIMIT 50
    `).bind(t.userId).all()).results||[]).reverse();console.log("[CHAT] Retrieved chat history:",B.length,"messages");const H=await gn(e.env.DB,t.userId),P=e.env.GROQ_API_KEY;console.log("[CHAT] GROQ API Key available:",!!P);let D;try{const k=`You are ASTAR* Agent 🚀, a growth assistant for startups.

🚫 ABSOLUTELY PROHIBITED:
- NEVER create goals directly
- NEVER use ACTION:CREATE_GOAL (that command DOES NOT EXIST)
- NEVER respond with "New Goal created" or goal data
- NEVER show IDs, categories, or technical values

⚠️ RULE #1 - CREATE GOALS:
When user asks to create a goal, respond EXACTLY with these 2 words:
TRIGGER:START_GOAL_FLOW

Do NOT add ANYTHING else. Just those 2 words.

CORRECT Examples:
User: "create goal" 
You: TRIGGER:START_GOAL_FLOW

User: "new goal"
You: TRIGGER:START_GOAL_FLOW

User: "I want to create a goal"
You: TRIGGER:START_GOAL_FLOW

User: "add goal"
You: TRIGGER:START_GOAL_FLOW

❌ WRONG (DON'T DO THIS):
User: "create goal"
You: "New Goal created: ID: 177..." ← NEVER DO THIS!

📊 COMMANDS FOR METRICS (USERS AND REVENUE):

🔴 IMPORTANT: The context provides current metrics from database:
- Current users: ${H.metrics.current.users}
- Current revenue: $${H.metrics.current.revenue}

USE THESE DATABASE VALUES when responding about metrics!

ACTION:SET_USERS|value - Set ABSOLUTE number of users (use when user says "I have X users", "update to X", "we are at X")
ACTION:SET_REVENUE|value - Set ABSOLUTE revenue (use when user says "revenue is X", "update to $X")
ACTION:ADD_USERS|value - Add users to current total (ONLY when user says "got X NEW users", "X MORE users", "gained X")
ACTION:ADD_REVENUE|value - Add revenue to current total (ONLY when user says "made $X today", "X MORE in sales", "gained $X")

📝 METRIC EXAMPLES (ALWAYS include ACTION first, then response):

User: "we have 500 users"
You: ACTION:SET_USERS|500
👥 Set to 500 users!

User: "actualiza a 15 usuarios" or "update users to 15"
You: ACTION:SET_USERS|15
👥 Set to 15 users!

User: "tengo 100 usuarios" or "I have 100 users"
You: ACTION:SET_USERS|100
👥 Set to 100 users!

User: "update revenue to 15000"
You: ACTION:SET_REVENUE|15000
💰 Revenue set to $15,000!

User: "we got 50 NEW users" or "50 MORE users" (current DB: ${H.metrics.current.users})
You: ACTION:ADD_USERS|50
🎉 +50 users! Now you have ${H.metrics.current.users+50} total.

User: "gained 30 users today" (current DB: ${H.metrics.current.users})
You: ACTION:ADD_USERS|30
🎉 +30 users! Now you have ${H.metrics.current.users+30} total.

User: "we made 2000 in sales today" (current DB: $${H.metrics.current.revenue})
You: ACTION:ADD_REVENUE|2000
💵 +$2,000! Total revenue: $${H.metrics.current.revenue+2e3}

User: "we now have 1200 users and $8000 revenue"
You: ACTION:SET_USERS|1200
ACTION:SET_REVENUE|8000
📊 Metrics set! 1,200 users and $8,000 revenue.

⚠️ CRITICAL: ALWAYS output ACTION: commands on their own lines BEFORE your response text!

🔧 COMMANDS TO EDIT EXISTING GOALS:

ACTION:UPDATE_GOAL_STATUS|goal_id|status - Change status (WIP, To start, Done, etc.)
ACTION:UPDATE_GOAL_DESCRIPTION|goal_id|new_description - Change description
ACTION:COMPLETE_GOAL|goal_id - Mark as completed
ACTION:DELETE_GOAL|goal_id - Delete goal

📝 EDITING EXAMPLES:

User: "complete goal 145"
You: ACTION:COMPLETE_GOAL|145
🎉 Goal completed!

User: "delete goal 136"
You: ACTION:DELETE_GOAL|136
🗑️ Deleted

📊 USER CONTEXT:
- Has \${context.goals.totalCount} goals (\${context.goals.completedCount} completed)
- \${context.metrics.current.users} users, $\${context.metrics.current.revenue} revenue

🎯 ACTIVE GOALS (use these IDs to edit):
\${context.goals.active.slice(0, 10).map((g: any) => \`[ID:\${g.id}] \${g.description} - Status: \${g.status}\`).join('\\n')}

REMEMBER:
- To CREATE → respond ONLY: TRIGGER:START_GOAL_FLOW
- To EDIT → use ACTION: with the correct ID
- Be brief and natural
- Respond in English`,T=await jd(P||"",k,a,H,e.env.AI,B);D=await Uf(e.env.DB,t.userId,T,H)}catch(k){console.error("[CHAT] AI error:",k),D=zo(a,H)}return await e.env.DB.prepare(`
      INSERT INTO agent_chat_messages (user_id, role, content, created_at)
      VALUES (?, 'assistant', ?, datetime('now'))
    `).bind(t.userId,D).run(),e.json({message:D})}catch(E){console.error("[CHAT] ===== ERROR PROCESSING MESSAGE ====="),console.error("[CHAT] Error type:",typeof E),console.error("[CHAT] Error:",E),console.error("[CHAT] Error stack:",E instanceof Error?E.stack:"No stack"),console.error("[CHAT] Error name:",E instanceof Error?E.name:"Unknown"),console.error("[CHAT] Error message:",E instanceof Error?E.message:String(E)),console.error("[CHAT] ===== END ERROR =====");let O="Lo siento, ocurrió un error. Por favor intenta de nuevo.",B="unknown";return E instanceof Error&&(E.name==="AbortError"||E.message.includes("aborted")?(O="La respuesta tardó demasiado. Intenta con una pregunta más corta.",B="timeout"):E.message.includes("429")?(O="Muchas solicitudes. Espera un momento e intenta de nuevo.",B="rate_limit"):(E.message.includes("network")||E.message.includes("fetch"))&&(O="Problema de conexión. Verifica tu internet e intenta de nuevo.",B="network")),e.json({error:"Failed to process message",errorType:B,message:O,details:E instanceof Error?E.message:String(E)},500)}});Ae.post("/determine-category",$e,async e=>{var a,s,o;e.get("user");const{description:t,task:r}=await e.req.json();if(!t||!r)return e.json({category:"OTHER"});try{const n=e.env.GROQ_API_KEY;if(!n){const c=`${t} ${r}`.toLowerCase();return c.includes("astar")||c.includes("blockchain")||c.includes("web3")?e.json({category:"ASTAR"}):c.includes("magcient")||c.includes("ai")||c.includes("machine learning")?e.json({category:"MAGCIENT"}):e.json({category:"OTHER"})}const i=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({model:"meta-llama/llama-4-maverick-17b-128e-instruct",messages:[{role:"system",content:`You are a goal classifier for startups. You must classify each goal into one of these 3 categories:

- ASTAR: Everything related to blockchain, web3, Astar Network, smart contracts, DeFi, NFTs, crypto
- MAGCIENT: Everything related to AI, Machine Learning, automation, data science, AI agents, LLMs
- OTHER: Everything else (marketing, sales, product, operations, finance, etc.)

Respond ONLY with one word: ASTAR, MAGCIENT or OTHER.`},{role:"user",content:`Description: ${t}
Task: ${r}

Category?`}],max_tokens:10,temperature:.3})});if(!i.ok)return e.json({category:"OTHER"});const d=((o=(s=(a=(await i.json()).choices[0])==null?void 0:a.message)==null?void 0:s.content)==null?void 0:o.trim().toUpperCase())||"OTHER";return["ASTAR","MAGCIENT","OTHER"].includes(d)?e.json({category:d}):e.json({category:"OTHER"})}catch(n){return console.error("[DETERMINE-CATEGORY] Error:",n),e.json({category:"OTHER"})}});async function Uf(e,t,r,a){var i,l,d,c,u,p,m,g;console.log("[PROCESS-ACTIONS] AI Response:",r),console.log("[PROCESS-ACTIONS] User ID:",t);const s=r.match(/ACTION:([A-Z_]+)\|([^\n]+)/g);if(console.log("[PROCESS-ACTIONS] Found actions:",s),!s||s.length===0)return console.log("[PROCESS-ACTIONS] No actions found in response"),r;let o=r,n=[];for(const b of s){const v=b.replace("ACTION:","").split("|"),y=v[0];console.log("[PROCESS-ACTIONS] Processing action:",y,"with parts:",v);try{if(y==="SET_USERS"){const[,f]=v,x=new Date().toISOString().split("T")[0],_=parseFloat(f.replace(/[^0-9.-]/g,""));isNaN(_)?n.push(`❌ Valor inválido para usuarios: ${f}`):(await e.prepare(`
            DELETE FROM user_metrics 
            WHERE user_id = ? AND metric_name = 'users' AND recorded_date = ?
          `).bind(t,x).run(),await e.prepare(`
            INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date)
            VALUES (?, 'users', ?, ?)
          `).bind(t,_,x).run(),n.push(`👥 Updated! You now have ${_.toLocaleString()} users.`),console.log("[ACTION] Users set to:",_))}else if(y==="SET_REVENUE"){const[,f]=v,x=new Date().toISOString().split("T")[0],_=parseFloat(f.replace(/[^0-9.-]/g,""));isNaN(_)?n.push(`❌ Valor inválido para revenue: ${f}`):(await e.prepare(`
            DELETE FROM user_metrics 
            WHERE user_id = ? AND metric_name = 'revenue' AND recorded_date = ?
          `).bind(t,x).run(),await e.prepare(`
            INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date)
            VALUES (?, 'revenue', ?, ?)
          `).bind(t,_,x).run(),n.push(`💰 Revenue updated to $${_.toLocaleString()}!`),console.log("[ACTION] Revenue set to:",_))}else if(y==="ADD_USERS"){const[,f]=v,x=new Date().toISOString().split("T")[0],_=parseFloat(f.replace(/[^0-9.-]/g,""));if(isNaN(_))n.push(`❌ Valor inválido para usuarios: ${f}`);else{const C=await e.prepare(`
            SELECT metric_value FROM user_metrics 
            WHERE user_id = ? AND metric_name = 'users'
            ORDER BY recorded_date DESC LIMIT 1
          `).bind(t).first(),I=((C==null?void 0:C.metric_value)||0)+_;await e.prepare(`
            DELETE FROM user_metrics 
            WHERE user_id = ? AND metric_name = 'users' AND recorded_date = ?
          `).bind(t,x).run(),await e.prepare(`
            INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date)
            VALUES (?, 'users', ?, ?)
          `).bind(t,I,x).run(),n.push(`🎉 ¡+${_.toLocaleString()} usuarios! Total: ${I.toLocaleString()}`),console.log("[ACTION] Users added:",_,"Total:",I)}}else if(y==="ADD_REVENUE"){const[,f]=v,x=new Date().toISOString().split("T")[0],_=parseFloat(f.replace(/[^0-9.-]/g,""));if(isNaN(_))n.push(`❌ Valor inválido para revenue: ${f}`);else{const C=await e.prepare(`
            SELECT metric_value FROM user_metrics 
            WHERE user_id = ? AND metric_name = 'revenue'
            ORDER BY recorded_date DESC LIMIT 1
          `).bind(t).first(),I=((C==null?void 0:C.metric_value)||0)+_;await e.prepare(`
            DELETE FROM user_metrics 
            WHERE user_id = ? AND metric_name = 'revenue' AND recorded_date = ?
          `).bind(t,x).run(),await e.prepare(`
            INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date)
            VALUES (?, 'revenue', ?, ?)
          `).bind(t,I,x).run(),n.push(`💵 ¡+$${_.toLocaleString()}! Revenue total: $${I.toLocaleString()}`),console.log("[ACTION] Revenue added:",_,"Total:",I)}}else if(y==="ADD_METRIC"){const[,f,x]=v,_=new Date().toISOString().split("T")[0];await e.prepare(`
          INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date)
          VALUES (?, ?, ?, ?)
        `).bind(t,f,parseFloat(x),_).run(),n.push(`✅ Métrica registrada: ${f} = ${x}`),console.log("[ACTION] Metric added:",f,x)}else if(y==="UPDATE_GOAL"){const[,f,x]=v;console.log("[ACTION] ========== UPDATE_GOAL START =========="),console.log("[ACTION] UPDATE_GOAL - goalId:",f),console.log("[ACTION] UPDATE_GOAL - newDescription:",x),console.log("[ACTION] UPDATE_GOAL - userId:",t);const _=await e.prepare(`
          UPDATE goals 
          SET description = ?,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ? AND user_id = ?
        `).bind(x,parseInt(f),t).run();console.log("[ACTION] UPDATE_GOAL - Rows affected:",(i=_.meta)==null?void 0:i.changes),console.log("[ACTION] ========== UPDATE_GOAL END =========="),((l=_.meta)==null?void 0:l.changes)===0?n.push(`❌ Goal ${f} not found`):n.push(`✅ Goal ${f} updated`)}else if(y==="UPDATE_GOAL_STATUS"){const[,f,x]=v,_=["WIP","To start","On Hold","Delayed","Blocked","Done"];if(console.log("[ACTION] ========== UPDATE_GOAL_STATUS START =========="),console.log("[ACTION] UPDATE_GOAL_STATUS - goalId:",f),console.log("[ACTION] UPDATE_GOAL_STATUS - newGoalStatus:",x),console.log("[ACTION] UPDATE_GOAL_STATUS - userId:",t),console.log("[ACTION] UPDATE_GOAL_STATUS - Valid statuses:",_),!_.includes(x))console.log("[ACTION] UPDATE_GOAL_STATUS - Invalid status provided"),n.push("❌ Invalid status. Use: WIP, To start, On Hold, Delayed, Blocked, Done");else{const C=await e.prepare(`
            UPDATE goals 
            SET goal_status = ?,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = ? AND user_id = ?
          `).bind(x,parseInt(f),t).run();if(console.log("[ACTION] UPDATE_GOAL_STATUS result:",JSON.stringify(C)),console.log("[ACTION] UPDATE_GOAL_STATUS - Rows affected:",(d=C.meta)==null?void 0:d.changes),console.log("[ACTION] ========== UPDATE_GOAL_STATUS END =========="),((c=C.meta)==null?void 0:c.changes)===0)n.push(`❌ Goal ${f} not found`);else{const A=x==="Done"?"✅":x==="WIP"?"🔄":"⏳";n.push(`${A} Status updated to ${x}`)}console.log("[ACTION] Goal status updated:",f,x)}}else if(y==="UPDATE_GOAL_DESCRIPTION"){const[,f,...x]=v,_=x.join("|");await e.prepare(`
          UPDATE goals 
          SET description = ?,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ? AND user_id = ?
        `).bind(_,parseInt(f),t).run(),n.push("📝"),console.log("[ACTION] Goal description updated:",f)}else if(y==="UPDATE_GOAL_DEADLINE"){const[,f,x]=v;await e.prepare(`
          UPDATE goals 
          SET deadline = ?,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ? AND user_id = ?
        `).bind(x,parseInt(f),t).run(),n.push("📅"),console.log("[ACTION] Goal deadline updated:",f,x)}else if(y==="UPDATE_GOAL_CATEGORY"){const[,f,x]=v;await e.prepare(`
          UPDATE goals 
          SET category = ?,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ? AND user_id = ?
        `).bind(x,parseInt(f),t).run();const _=x==="high"?"🔥":x==="medium"?"⚡":"📌";n.push(`${_}`),console.log("[ACTION] Goal category updated:",f,x)}else if(y==="COMPLETE_GOAL"){const[,f]=v;console.log("[ACTION] COMPLETE_GOAL - goalId:",f,"userId:",t);const x=await e.prepare(`
          UPDATE goals 
          SET status = 'completed',
              current_value = target_value,
              updated_at = CURRENT_TIMESTAMP
          WHERE id = ? AND user_id = ?
        `).bind(parseInt(f),t).run();console.log("[ACTION] COMPLETE_GOAL result:",JSON.stringify(x)),console.log("[ACTION] Rows affected:",(u=x.meta)==null?void 0:u.changes),((p=x.meta)==null?void 0:p.changes)===0?n.push(`❌ No se encontró el objetivo ${f}`):n.push("🎉"),console.log("[ACTION] Goal completed:",f)}else if(y==="DELETE_GOAL"){const[,f]=v;console.log("[ACTION] DELETE_GOAL - goalId:",f,"userId:",t);const x=await e.prepare(`
          DELETE FROM goals 
          WHERE id = ? AND user_id = ?
        `).bind(parseInt(f),t).run();console.log("[ACTION] DELETE_GOAL result:",JSON.stringify(x)),console.log("[ACTION] Rows affected:",(m=x.meta)==null?void 0:m.changes),((g=x.meta)==null?void 0:g.changes)===0?n.push(`❌ No se encontró el objetivo ${f}`):n.push("🗑️"),console.log("[ACTION] Goal deleted:",f)}else if(y==="FETCH_LEADERBOARD"){const[,f]=v;if(console.log("[ACTION] Fetching leaderboard:",f),f==="global"){const x=await e.prepare(`
            SELECT 
              p.id,
              p.title,
              p.description,
              p.rating_average,
              p.votes_count,
              u.name as founder_name,
              u.avatar_url as founder_avatar,
              'project' as type
            FROM projects p
            JOIN users u ON p.user_id = u.id
            ORDER BY p.rating_average DESC, p.votes_count DESC
            LIMIT 10
          `).all(),_=await e.prepare(`
            SELECT 
              bp.id,
              bp.title,
              bp.description,
              COALESCE(bp.rating_average, 0) as rating_average,
              COALESCE(bp.votes_count, 0) as votes_count,
              u.name as founder_name,
              u.avatar_url as founder_avatar,
              'product' as type
            FROM beta_products bp
            JOIN users u ON bp.company_user_id = u.id
            ORDER BY bp.rating_average DESC, bp.votes_count DESC
            LIMIT 10
          `).all(),C=[...x.results||[],..._.results||[]].sort((A,I)=>I.rating_average!==A.rating_average?I.rating_average-A.rating_average:I.votes_count-A.votes_count).slice(0,10);if(C.length>0){let A=`🏆 **GLOBAL LEADERBOARD** (Top startups):

`;C.forEach((I,M)=>{A+=`${M+1}. **${I.title}** - ${I.founder_name}
`,A+=`   ⭐ Rating: ${I.rating_average||0} | 👥 Votes: ${I.votes_count||0}
`,A+=`   Type: ${I.type==="project"?"📊 Startup":"🚀 Product"}

`}),n.push(A)}else n.push("📊 No startups in the leaderboard yet.")}else if(f==="goals"){const _=(await e.prepare(`
            SELECT 
              u.id,
              u.name,
              u.avatar_url,
              COUNT(CASE WHEN g.status = 'completed' THEN 1 END) as completed_goals,
              COUNT(g.id) as total_goals,
              CAST(COUNT(CASE WHEN g.status = 'completed' THEN 1 END) AS REAL) * 10 as score
            FROM users u
            LEFT JOIN goals g ON u.id = g.user_id
            GROUP BY u.id, u.name, u.avatar_url
            HAVING COUNT(g.id) > 0
            ORDER BY score DESC, completed_goals DESC
            LIMIT 10
          `).all()).results||[];if(_.length>0){let C=`🎯 **GOALS LEADERBOARD** (Top founders):

`;_.forEach((A,I)=>{C+=`${I+1}. **${A.name}**
`,C+=`   ✅ Completed: ${A.completed_goals} / ${A.total_goals}
`,C+=`   🏅 Score: ${A.score}

`}),n.push(C)}else n.push("🎯 No completed goals yet.")}else if(f==="competitions"){const _=(await e.prepare(`
            SELECT 
              c.id,
              c.title,
              c.description,
              c.prize_amount,
              c.event_date,
              c.status,
              COUNT(DISTINCT cp.id) as participants_count
            FROM competitions c
            LEFT JOIN competition_participants cp ON c.id = cp.competition_id
            WHERE c.status = 'active'
            GROUP BY c.id, c.title, c.description, c.prize_amount, c.event_date, c.status
            ORDER BY c.event_date DESC
            LIMIT 5
          `).all()).results||[];if(_.length>0){let C=`🏅 **ACTIVE COMPETITIONS:**

`;_.forEach(A=>{C+=`**${A.title}**
`,C+=`💰 Prize: $${A.prize_amount}
`,C+=`👥 Participants: ${A.participants_count}
`,C+=`📅 Date: ${A.event_date}

`}),C+=`
💡 To see the ranking of a specific competition, visit /competitions`,n.push(C)}else n.push("🏅 No active competitions at the moment.")}}}catch(f){console.error("[ACTION-ERROR]",y,"Error details:",f);const x=f instanceof Error?f.message:String(f);n.push(`❌ Error executing ${y}: ${x}`)}o=o.replace(b,"").trim()}return n.length>0?n.join(`
`)+`

`+o:o}function zo(e,t){const r=e.toLowerCase();if(r.includes("añadir")||r.includes("crear")||r.includes("nuevo objetivo")||r.includes("new goal")||r.includes("add")||r.includes("create")||r.includes("quiero")&&!r.includes("analiza"))return`🎯 **To enable the AI that creates goals automatically:**

1. Get a free API key at https://console.groq.com/
2. Add it to your project in Cloudflare

**In the meantime**, you can:
• Go to the **Traction** view in the dashboard
• Click on "Add Goal"
• Create your goals manually

💡 With the API key configured, I can create goals just by telling me "I want to reach 1000 users"`;if(r.includes("objetivo")||r.includes("goal")||r.includes("meta")||r.includes("analiza")||r.includes("analyze")){const{goals:a}=t;if(a.totalCount===0)return`📊 You don't have any goals registered yet.

💡 I recommend creating your first goal. Go to the Traction section and add goals like:
- Get X users
- Reach $X in revenue
- Launch X feature`;let s=`📊 **Analysis of your goals:**

`;return s+=`• Total: ${a.totalCount} goals
`,s+=`• Completed: ${a.completedCount} (${a.completionRate}%)
`,s+=`• Active: ${a.active.length}

`,a.active.length>0&&(s+=`**Active goals:**
`,a.active.slice(0,5).forEach((o,n)=>{const i=o.target_value>0?Math.round(o.current_value/o.target_value*100):0;s+=`${n+1}. ${o.description} - ${i}% (${o.current_value}/${o.target_value})
`})),s}if(r.includes("métrica")||r.includes("metric")||r.includes("crecimiento")||r.includes("growth")){const{metrics:a}=t;let s=`📈 **Metrics summary:**

`;return s+=`• Current users: ${a.current.users}
`,s+=`• Current revenue: $${a.current.revenue}
`,s+=`• User growth: ${a.growth.users}%
`,s+=`• Revenue growth: ${a.growth.revenue}%
`,a.history.length<2&&(s+=`
💡 Tip: Record metrics regularly to see growth trends.`),s}return r.includes("marketing")||r.includes("plan")?`🚀 **Marketing Recommendations:**

Based on your ${t.goals.totalCount} goals and ${t.metrics.current.users} users:

1. **Content Marketing**: Create content that solves your users' problems
2. **Social Proof**: Share testimonials and success stories
3. **Referrals**: Implement a referral program
4. **SEO**: Optimize your search engine presence

💡 Would you like me to go deeper into any specific strategy?`:`👋 Hi! I'm your ASTAR Agent.

I can help you with:
• 📊 Analyze your goals
• 📈 Review your growth metrics
• 🎯 Create marketing plans
• 💡 Generate content ideas

**Your current summary:**
• ${t.goals.totalCount} goals (${t.goals.completionRate}% completed)
• ${t.metrics.current.users} users, $${t.metrics.current.revenue} revenue

How can I help you?`}Ae.post("/analyze-goals",$e,async e=>{const t=e.get("user");console.log("[ANALYZE-GOALS] Starting analysis for user:",t.userId);try{console.log("[ANALYZE-GOALS] Fetching startup context...");const r=await gn(e.env.DB,t.userId);console.log("[ANALYZE-GOALS] Context fetched:",JSON.stringify(r).substring(0,200));const a=e.env.GROQ_API_KEY||e.env.OPENAI_API_KEY;console.log("[ANALYZE-GOALS] API Key available:",!!a);let s;if(!a)console.log("[ANALYZE-GOALS] Using fallback response (no API key)"),s=zo("analyze my goals",r);else{console.log("[ANALYZE-GOALS] Generating AI response...");const o=`You are an expert startup analyst. Analyze the user's goals and provide:
1. Current status of each goal with progress percentage
2. Which goals are at risk of not being completed
3. Specific recommendations for improvement
4. Suggested prioritization

Respond in English, be specific and use the provided data.`;try{s=await jd(a,o,"Analyze my goals and give me recommendations",r),console.log("[ANALYZE-GOALS] AI response generated successfully")}catch(n){console.error("[ANALYZE-GOALS] AI generation failed:",n),s=zo("analiza mis objetivos",r)}}return console.log("[ANALYZE-GOALS] Saving to chat history..."),await e.env.DB.prepare(`
      INSERT INTO agent_chat_messages (user_id, role, content, created_at)
      VALUES (?, 'user', ?, datetime('now'))
    `).bind(t.userId,"Analiza mis objetivos").run(),await e.env.DB.prepare(`
      INSERT INTO agent_chat_messages (user_id, role, content, created_at)
      VALUES (?, 'assistant', ?, datetime('now'))
    `).bind(t.userId,s).run(),console.log("[ANALYZE-GOALS] Success, returning analysis"),e.json({analysis:s})}catch(r){return console.error("[ANALYZE-GOALS] ERROR:",r),console.error("[ANALYZE-GOALS] Error stack:",r instanceof Error?r.stack:"No stack"),console.error("[ANALYZE-GOALS] Error message:",r instanceof Error?r.message:String(r)),e.json({error:"Failed to analyze goals",details:r instanceof Error?r.message:String(r)},500)}});Ae.delete("/history",$e,async e=>{const t=e.get("user");try{return await e.env.DB.prepare(`
      DELETE FROM agent_chat_messages WHERE user_id = ?
    `).bind(t.userId).run(),e.json({success:!0})}catch(r){return console.error("Error clearing chat history:",r),e.json({error:"Failed to clear chat history"},500)}});Ae.get("/startup-summary",$e,async e=>{const t=e.get("user");try{const r=await gn(e.env.DB,t.userId);return e.json(r)}catch(r){return console.error("Error getting startup summary:",r),e.json({error:"Failed to get startup summary"},500)}});Ae.get("/leaderboard/global",$e,async e=>{try{const t=parseInt(e.req.query("limit")||"10"),r=await e.env.DB.prepare(`
      SELECT 
        p.id,
        p.title,
        p.description,
        p.rating_average,
        p.votes_count,
        u.name as founder_name,
        u.avatar_url as founder_avatar,
        'project' as type
      FROM projects p
      JOIN users u ON p.user_id = u.id
      ORDER BY p.rating_average DESC, p.votes_count DESC
      LIMIT ?
    `).bind(t).all(),a=await e.env.DB.prepare(`
      SELECT 
        bp.id,
        bp.title,
        bp.description,
        COALESCE(bp.rating_average, 0) as rating_average,
        COALESCE(bp.votes_count, 0) as votes_count,
        u.name as founder_name,
        u.avatar_url as founder_avatar,
        'product' as type
      FROM beta_products bp
      JOIN users u ON bp.company_user_id = u.id
      ORDER BY bp.rating_average DESC, bp.votes_count DESC
      LIMIT ?
    `).bind(t).all(),s=[...r.results||[],...a.results||[]].sort((o,n)=>n.rating_average!==o.rating_average?n.rating_average-o.rating_average:n.votes_count-o.votes_count).slice(0,t);return e.json({leaderboard:s,type:"global_combined"})}catch(t){return console.error("Error getting global leaderboard:",t),e.json({error:"Failed to get global leaderboard"},500)}});Ae.get("/leaderboard/goals",$e,async e=>{try{const t=parseInt(e.req.query("limit")||"10"),r=await e.env.DB.prepare(`
      SELECT 
        u.id,
        u.name,
        u.avatar_url,
        COUNT(CASE WHEN g.status = 'completed' THEN 1 END) as completed_goals,
        COUNT(g.id) as total_goals,
        CAST(COUNT(CASE WHEN g.status = 'completed' THEN 1 END) AS REAL) * 10 as score
      FROM users u
      LEFT JOIN goals g ON u.id = g.user_id
      GROUP BY u.id, u.name, u.avatar_url
      HAVING COUNT(g.id) > 0
      ORDER BY score DESC, completed_goals DESC
      LIMIT ?
    `).bind(t).all();return e.json({leaderboard:r.results||[],type:"goals_leaderboard"})}catch(t){return console.error("Error getting goals leaderboard:",t),e.json({error:"Failed to get goals leaderboard"},500)}});Ae.get("/leaderboard/competitions",$e,async e=>{try{const t=await e.env.DB.prepare(`
      SELECT 
        c.id,
        c.title,
        c.description,
        c.prize_amount,
        c.event_date,
        c.status,
        COUNT(DISTINCT cp.id) as participants_count
      FROM competitions c
      LEFT JOIN competition_participants cp ON c.id = cp.competition_id
      WHERE c.status = 'active'
      GROUP BY c.id, c.title, c.description, c.prize_amount, c.event_date, c.status
      ORDER BY c.event_date DESC
      LIMIT 5
    `).all();return e.json({competitions:t.results||[],type:"active_competitions"})}catch(t){return console.error("Error getting competitions list:",t),e.json({error:"Failed to get competitions"},500)}});Ae.get("/leaderboard/competitions/:id",$e,async e=>{try{const t=e.req.param("id"),r=await e.env.DB.prepare(`
      SELECT 
        cp.id,
        cp.startup_name,
        cp.current_rank,
        cp.total_score,
        cp.vote_score,
        cp.growth_score,
        u.name as founder_name,
        u.avatar_url as founder_avatar,
        COALESCE(p.title, bp.title) as project_title,
        CASE WHEN p.id IS NOT NULL THEN 'project' ELSE 'product' END as type
      FROM competition_participants cp
      JOIN users u ON cp.user_id = u.id
      LEFT JOIN projects p ON cp.project_id = p.id
      LEFT JOIN beta_products bp ON cp.project_id = bp.id
      WHERE cp.competition_id = ?
      ORDER BY cp.current_rank ASC, cp.total_score DESC
      LIMIT 20
    `).bind(t).all(),a=await e.env.DB.prepare(`
      SELECT id, title, description, prize_amount
      FROM competitions
      WHERE id = ?
    `).bind(t).first();return e.json({competition:a,leaderboard:r.results||[],type:"competition_leaderboard"})}catch(t){return console.error("Error getting competition leaderboard:",t),e.json({error:"Failed to get competition leaderboard"},500)}});Ae.post("/brand/generate-images",$e,async e=>{try{const t=e.get("user"),r=await e.req.json(),{website_url:a,custom_prompt:s}=r;if(console.log("[BRAND] User object:",JSON.stringify(t)),!a&&!s)return e.json({error:"website_url or custom_prompt is required"},400);const o=(t==null?void 0:t.id)||(t==null?void 0:t.userId)||(t==null?void 0:t.sub)||"1";let n=e.env.RAILWAY_API_URL||"";if(!n)return e.json({error:"Railway API not configured",message:"Configure RAILWAY_API_URL in Cloudflare environment variables"},500);!n.startsWith("http://")&&!n.startsWith("https://")&&(n="https://"+n),console.log("[BRAND] Calling Railway generate-images:",`${n}/api/agents/brand/generate-images`),console.log("[BRAND] User ID:",o),console.log("[BRAND] Custom prompt:",s);const i=await fetch(`${n}/api/agents/brand/generate-images`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({website_url:a||"general",user_id:String(o),cloudflare_api_url:new URL(e.req.url).origin,custom_prompt:s||null})});if(!i.ok){const d=await i.text();return console.error("[BRAND] Railway error:",i.status,d),e.json({error:"Railway API error",detail:d},i.status)}const l=await i.json();return e.json(l)}catch(t){return console.error("[BRAND] Error calling Railway:",t),e.json({error:"Failed to generate images",detail:t instanceof Error?t.message:"Unknown error"},500)}});const He=new ee;function Gf(e){if(!e.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");return e.JWT_SECRET}async function Wf(e,t){try{const r=e.req.header("Authorization");if(!r||!r.startsWith("Bearer "))return e.json({error:"Unauthorized - No token provided"},401);const a=r.substring(7),s=await te(a,Gf(e.env));e.set("userId",s.userId),e.set("userRole",s.role),await t()}catch{return e.json({error:"Unauthorized - Invalid token"},401)}}He.use("*",Wf);He.post("/chat",async e=>{try{const t=e.get("userId"),{message:r,context:a}=await e.req.json();if(!r||r.trim().length===0)return e.json({error:"Message cannot be empty"},400);console.log("[MARKETING AI] User message:",{userId:t,message:r});const s=await qf(r,a);return await e.env.DB.prepare(`
      INSERT INTO marketing_ai_conversations (user_id, message, response, created_at)
      VALUES (?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(t,r,s).run(),e.json({success:!0,response:s,timestamp:new Date().toISOString()})}catch(t){return console.error("[MARKETING AI] Error:",t),e.json({error:"Failed to process message"},500)}});He.get("/history",async e=>{try{const t=e.get("userId"),r=parseInt(e.req.query("limit")||"50"),{results:a}=await e.env.DB.prepare(`
      SELECT id, message, response, created_at
      FROM marketing_ai_conversations
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT ?
    `).bind(t,r).all();return e.json({history:a||[]})}catch(t){return console.error("[MARKETING AI] Error fetching history:",t),e.json({error:"Failed to fetch history"},500)}});He.post("/analyze-business",async e=>{try{const t=e.get("userId"),{business_description:r,goals:a}=await e.req.json();if(!r)return e.json({error:"Business description is required"},400);console.log("[MARKETING AI] Business analysis:",{userId:t,business_description:r});const s=await Vf(r,a);return await e.env.DB.prepare(`
      INSERT INTO marketing_ai_analyses (user_id, business_description, goals, analysis, created_at)
      VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(t,r,a||"",s).run(),e.json({success:!0,analysis:s})}catch(t){return console.error("[MARKETING AI] Error in analysis:",t),e.json({error:"Failed to analyze business"},500)}});He.post("/generate-campaign",async e=>{try{const t=e.get("userId"),{topic:r,platforms:a,duration_days:s}=await e.req.json();if(!r||!a||!Array.isArray(a))return e.json({error:"Topic and platforms are required"},400);console.log("[MARKETING AI] Campaign generation:",{userId:t,topic:r,platforms:a});const o=await zf(r,a,s||30);return await e.env.DB.prepare(`
      INSERT INTO marketing_ai_campaigns (user_id, topic, platforms, duration_days, campaign, created_at)
      VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    `).bind(t,r,JSON.stringify(a),s||30,o).run(),e.json({success:!0,campaign:o})}catch(t){return console.error("[MARKETING AI] Error generating campaign:",t),e.json({error:"Failed to generate campaign"},500)}});He.post("/analyze-competition",async e=>{try{const t=e.get("userId"),{industry:r,competitors:a}=await e.req.json();if(!r||!a||!Array.isArray(a))return e.json({error:"Industry and competitors are required"},400);console.log("[MARKETING AI] Competition analysis:",{userId:t,industry:r,competitors:a});const s=await Jf(r,a);return e.json({success:!0,analysis:s})}catch(t){return console.error("[MARKETING AI] Error in competition analysis:",t),e.json({error:"Failed to analyze competition"},500)}});He.post("/social-strategy",async e=>{try{const t=e.get("userId"),{brand:r,target_audience:a,goals:s}=await e.req.json();if(!r||!a||!s)return e.json({error:"Brand, target audience and goals are required"},400);console.log("[MARKETING AI] Social strategy:",{userId:t,brand:r});const o=await Yf(r,a,s);return e.json({success:!0,strategy:o})}catch(t){return console.error("[MARKETING AI] Error creating social strategy:",t),e.json({error:"Failed to create social strategy"},500)}});He.post("/create-goal",async e=>{try{const t=e.get("userId"),{description:r,task:a,priority:s,priority_label:o,cadence:n,dri:i,goal_status:l,category:d,week_of:c}=await e.req.json();if(!r||!a)return e.json({error:"Description and task are required"},400);const u=await e.env.DB.prepare(`
      INSERT INTO goals (
        user_id, description, task, priority, priority_label, 
        cadence, dri, goal_status, category, week_of, 
        order_index, status
      ) 
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, 'active') 
      RETURNING *
    `).bind(t,r,a,s||"P0",o||"Urgent & important",n||"One time",i||"Giorgio",l||"To start",d||"ASTAR",c||null).first();return e.json({success:!0,goal:u,message:`✅ Goal created: ${a}`})}catch(t){return console.error("[MARKETING AI] Error creating goal:",t),e.json({error:"Failed to create goal"},500)}});He.put("/update-goal/:id",async e=>{try{const t=e.get("userId"),r=e.req.param("id"),a=await e.req.json(),s=["description","task","priority","priority_label","cadence","dri","goal_status","category","week_of","order_index","day_mon","day_tue","day_wed","day_thu","day_fri","day_sat","day_sun"],o=[],n=[];for(const[i,l]of Object.entries(a))s.includes(i)&&l!==void 0&&(o.push(`${i} = ?`),n.push(l));return o.length===0?e.json({error:"No valid fields to update"},400):(o.push("updated_at = CURRENT_TIMESTAMP"),n.push(r,t),await e.env.DB.prepare(`
      UPDATE goals 
      SET ${o.join(", ")}
      WHERE id = ? AND user_id = ?
    `).bind(...n).run(),e.json({success:!0,message:"✅ Goal updated successfully"}))}catch(t){return console.error("[MARKETING AI] Error updating goal:",t),e.json({error:"Failed to update goal"},500)}});He.get("/get-goals",async e=>{try{const t=e.get("userId"),r=e.req.query("category"),a=e.req.query("priority");let s=`
      SELECT id, description, task, priority, priority_label, cadence, 
             dri, goal_status, category, week_of, order_index,
             day_mon, day_tue, day_wed, day_thu, day_fri, day_sat, day_sun,
             created_at, updated_at
      FROM goals 
      WHERE user_id = ? AND status = 'active'
    `;const o=[t];r&&(s+=" AND category = ?",o.push(r)),a&&(s+=" AND priority = ?",o.push(a)),s+=" ORDER BY order_index ASC, priority ASC, created_at DESC";const{results:n}=await e.env.DB.prepare(s).bind(...o).all();return e.json({success:!0,goals:n||[]})}catch(t){return console.error("[MARKETING AI] Error fetching goals:",t),e.json({error:"Failed to fetch goals"},500)}});He.delete("/delete-goal/:id",async e=>{try{const t=e.get("userId"),r=e.req.param("id");return await e.env.DB.prepare(`
      DELETE FROM goals WHERE id = ? AND user_id = ?
    `).bind(r,t).run(),e.json({success:!0,message:"✅ Goal deleted successfully"})}catch(t){return console.error("[MARKETING AI] Error deleting goal:",t),e.json({error:"Failed to delete goal"},500)}});async function qf(e,t){return`🤖 **Marketing AI Response**

Gracias por tu consulta: "${e}"

📊 **Análisis preliminar:**
He analizado tu mensaje y puedo ayudarte con:
- Estrategias de marketing digital
- Análisis de competencia
- Creación de contenido
- Campañas en redes sociales
- Optimización de conversiones

💡 **Recomendaciones inmediatas:**
1. Define claramente tu audiencia objetivo
2. Analiza a tus principales competidores
3. Establece KPIs medibles
4. Crea un calendario de contenido

¿En qué aspecto específico te gustaría profundizar?

_Nota: Para análisis más profundos, usa las funciones especializadas como "Analizar Negocio" o "Generar Campaña"._`}async function Vf(e,t){return`🎯 **ANÁLISIS COMPLETO DE MARKETING**

**NEGOCIO:** ${e}
**OBJETIVOS:** ${t||"Crecimiento general y aumento de visibilidad"}

📊 **1. ANÁLISIS DE MERCADO**
- Mercado objetivo: Empresas B2B/B2C en fase de crecimiento
- Tamaño de mercado: $XXM con crecimiento anual del XX%
- Competencia: Media-Alta
- Barreras de entrada: Moderadas

🎯 **2. ESTRATEGIA RECOMENDADA**
- Content Marketing (40%): Blog, videos, webinars
- Social Media (30%): LinkedIn, Twitter, Instagram
- SEO/SEM (20%): Posicionamiento orgánico y ads
- Email Marketing (10%): Nurturing y conversión

📅 **3. PLAN DE CONTENIDO (30 DÍAS)**
Semana 1: Setup y contenido fundacional
Semana 2-3: Amplificación y engagement
Semana 4: Análisis y optimización

📈 **4. MÉTRICAS Y KPIS**
- CAC: < $XX
- LTV: > $XXX
- Conversion Rate: X-X%
- Engagement Rate: X%

💰 **5. PRESUPUESTO ESTIMADO**
Total: $X,XXX/mes
- Contenido: $XXX
- Ads: $XXX
- Tools: $XXX

🚀 **PRÓXIMOS PASOS:**
1. Configurar analytics
2. Crear calendario de contenido
3. Identificar 5 competidores clave
4. Setup de herramientas básicas`}async function zf(e,t,r){const a=t.join(", ");return`📅 **CAMPAÑA DE CONTENIDO**

**TEMA:** ${e}
**PLATAFORMAS:** ${a}
**DURACIÓN:** ${r} días

📝 **CALENDARIO SEMANAL:**

**Semana 1: Awareness**
${t.map(s=>`- ${s}: 3 posts educativos sobre ${e}`).join(`
`)}

**Semana 2: Engagement**
${t.map(s=>`- ${s}: 2 posts interactivos + 1 caso de estudio`).join(`
`)}

**Semana 3: Conversión**
${t.map(s=>`- ${s}: 2 posts de valor + 1 CTA directo`).join(`
`)}

**Semana 4: Análisis**
${t.map(s=>`- ${s}: 2 posts based on best performers`).join(`
`)}

🎯 **ESTRATEGIA DE ENGAGEMENT:**
- Responder a todos los comentarios en < 2h
- Repostear UGC relevante
- Colaboraciones con micro-influencers

📊 **KPIS A MEDIR:**
- Reach total
- Engagement rate
- Click-through rate
- Conversiones

💰 **PRESUPUESTO:** $XXX - $X,XXX`}async function Jf(e,t){return`🏆 **ANÁLISIS COMPETITIVO**

**INDUSTRIA:** ${e}
**COMPETIDORES:** ${t.join(", ")}

${t.map((r,a)=>`
**${a+1}. ${r}**
📊 Posicionamiento: [Análisis]
💪 Fortalezas: [Lista]
⚠️ Debilidades: [Lista]
📱 Redes Sociales: [Presencia]
💰 Pricing: [Estructura]
`).join(`
`)}

💡 **OPORTUNIDADES IDENTIFICADAS:**
1. Gap en servicio/producto X
2. Audiencia desatendida Y
3. Canal infrautilizado Z

🎯 **ESTRATEGIA DE DIFERENCIACIÓN:**
- Propuesta de valor única
- Nicho específico
- Innovación en X

📈 **PRÓXIMOS PASOS:**
1. Profundizar análisis de [Competidor Top]
2. Benchmarking de pricing
3. Análisis de content gaps`}async function Yf(e,t,r){return`📱 **ESTRATEGIA DE REDES SOCIALES**

**MARCA:** ${e}
**AUDIENCIA:** ${t}
**OBJETIVOS:** ${r}

🎯 **PLATAFORMAS PRIORITARIAS:**
1. LinkedIn (B2B, profesionales)
2. Instagram (visuales, engagement)
3. Twitter (thought leadership)

📅 **CALENDARIO MENSUAL:**
- Lunes: Motivacional/Inspiracional
- Martes: Educativo/Tutorial
- Miércoles: Behind the scenes
- Jueves: User Generated Content
- Viernes: Casos de éxito

📝 **TIPOS DE CONTENIDO:**
- 40% Educativo
- 30% Entretenimiento
- 20% Promocional
- 10% Personal/Cultura

🤝 **ESTRATEGIA DE CRECIMIENTO:**
- Hashtag strategy
- Collaboraciones
- Paid amplification
- Community management

📊 **MÉTRICAS:**
- Followers growth: +XX%
- Engagement rate: X%
- Click-through: X%
- Conversions: XX/mes

💰 **PRESUPUESTO:** $XXX/mes`}const rt=new ee;function Kf(e){if(!e.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");return e.JWT_SECRET}const da=async(e,t)=>{var a,s,o,n,i;const r=((a=e.req.header("Authorization"))==null?void 0:a.replace("Bearer ",""))||((o=(s=e.req.header("cookie"))==null?void 0:s.match(/authToken=([^;]+)/))==null?void 0:o[1])||((i=(n=e.req.header("Cookie"))==null?void 0:n.match(/authToken=([^;]+)/))==null?void 0:i[1]);if(!r)return e.json({error:"No authentication token provided"},401);try{const l=await te(r,Kf(e.env));e.set("user",l),await t()}catch{return e.json({error:"Invalid authentication token"},401)}};rt.get("/",async e=>{try{const t=e.req.query("type"),r=e.req.query("status")||"active";let a=`
      SELECT 
        c.*,
        COUNT(DISTINCT cp.id) as participant_count,
        (SELECT COUNT(*) FROM competition_participants WHERE competition_id = c.id AND payment_status = 'completed') as paid_count
      FROM competitions c
      LEFT JOIN competition_participants cp ON c.id = cp.competition_id
      WHERE c.status = ?
    `;const s=[r];t&&(a+=" AND c.competition_type = ?",s.push(t)),a+=" GROUP BY c.id ORDER BY c.created_at DESC";const o=await e.env.DB.prepare(a).bind(...s).all();return e.json({competitions:o.results||[]})}catch(t){return console.error("[COMPETITIONS] Error fetching competitions:",t),e.json({error:"Failed to fetch competitions"},500)}});rt.get("/:id",async e=>{try{const t=e.req.param("id"),r=await e.env.DB.prepare(`
      SELECT * FROM competitions WHERE id = ?
    `).bind(t).first();if(!r)return e.json({error:"Competition not found"},404);const a=await e.env.DB.prepare(`
      SELECT 
        cp.*,
        u.name,
        u.email,
        u.avatar_url
      FROM competition_participants cp
      JOIN users u ON cp.user_id = u.id
      WHERE cp.competition_id = ?
      ORDER BY cp.registration_date DESC
    `).bind(t).all(),s=await e.env.DB.prepare(`
      SELECT 
        cw.*,
        u.name,
        u.email,
        u.avatar_url,
        cp.startup_name
      FROM competition_winners cw
      JOIN users u ON cw.user_id = u.id
      LEFT JOIN competition_participants cp ON cw.competition_id = cp.competition_id AND cw.user_id = cp.user_id
      WHERE cw.competition_id = ?
      ORDER BY cw.position ASC
    `).bind(t).all();return e.json({competition:r,participants:a.results||[],winners:s.results||[]})}catch(t){return console.error("[COMPETITIONS] Error fetching competition details:",t),e.json({error:"Failed to fetch competition details"},500)}});rt.post("/:id/register",da,async e=>{try{const t=e.req.param("id"),r=e.get("user"),{project_id:a,startup_name:s,pitch_deck_url:o,submission_notes:n}=await e.req.json(),i=await e.env.DB.prepare(`
      SELECT * FROM competitions WHERE id = ? AND status = 'active'
    `).bind(t).first();if(!i)return e.json({error:"Competition not found or closed"},404);if(await e.env.DB.prepare(`
      SELECT id FROM competition_participants 
      WHERE competition_id = ? AND user_id = ?
    `).bind(t,r.userId).first())return e.json({error:"Already registered for this competition"},400);let d=null;return a&&(d=await e.env.DB.prepare(`
        SELECT id, title, description FROM projects 
        WHERE id = ? AND user_id = ?
      `).bind(a,r.userId).first(),d||(d=await e.env.DB.prepare(`
          SELECT id, title, description FROM beta_products 
          WHERE id = ? AND company_user_id = ?
        `).bind(a,r.userId).first()),!d)?e.json({error:"Project/Product not found or does not belong to you"},404):(await e.env.DB.prepare(`
      INSERT INTO competition_participants 
      (competition_id, user_id, project_id, startup_name, pitch_deck_url, submission_notes, payment_status)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(t,r.userId,a||null,s||(d?d.title:null),o||null,n||(d?d.description:null),i.ticket_required?"pending":"completed").run(),e.json({success:!0,message:"Successfully registered for competition",requires_payment:!!i.ticket_required,payment_link:i.payment_link||null}))}catch(t){return console.error("[COMPETITIONS] Error registering for competition:",t),e.json({error:"Failed to register for competition"},500)}});rt.post("/:id/payment",da,async e=>{try{const t=e.req.param("id"),r=e.get("user"),{payment_id:a,payment_status:s}=await e.req.json();return await e.env.DB.prepare(`
      UPDATE competition_participants 
      SET payment_status = ?, payment_id = ?
      WHERE competition_id = ? AND user_id = ?
    `).bind(s,a,t,r.userId).run(),e.json({success:!0})}catch(t){return console.error("[COMPETITIONS] Error updating payment:",t),e.json({error:"Failed to update payment"},500)}});rt.get("/:id/check-registration",da,async e=>{try{const t=e.req.param("id"),r=e.get("user"),a=await e.env.DB.prepare(`
      SELECT * FROM competition_participants 
      WHERE competition_id = ? AND user_id = ?
    `).bind(t,r.userId).first();return e.json({registered:!!a,registration:a||null})}catch(t){return console.error("[COMPETITIONS] Error checking registration:",t),e.json({error:"Failed to check registration"},500)}});rt.post("/:id/participants/:participantId/vote",da,async e=>{try{const t=e.req.param("id"),r=e.req.param("participantId"),a=e.get("user");if(a.role!=="validator"&&a.role!=="investor")return e.json({error:"Only validators and investors can vote"},403);const{vote_score:s,comment:o}=await e.req.json();return!s||s<1||s>10?e.json({error:"Vote score must be between 1 and 10"},400):(await e.env.DB.prepare(`
      INSERT INTO competition_votes 
        (competition_id, participant_id, voter_id, voter_role, vote_score, comment)
      VALUES (?, ?, ?, ?, ?, ?)
      ON CONFLICT(competition_id, participant_id, voter_id) 
      DO UPDATE SET 
        vote_score = excluded.vote_score,
        comment = excluded.comment,
        updated_at = CURRENT_TIMESTAMP
    `).bind(t,r,a.userId,a.role,s,o||null).run(),await Qf(e.env.DB,parseInt(t)),e.json({success:!0,message:"Vote submitted successfully"}))}catch(t){return console.error("[COMPETITIONS] Error submitting vote:",t),e.json({error:"Failed to submit vote"},500)}});rt.get("/:id/participants/:participantId/votes",async e=>{try{const t=e.req.param("participantId"),r=await e.env.DB.prepare(`
      SELECT 
        cv.*,
        u.name as voter_name,
        u.avatar_url as voter_avatar
      FROM competition_votes cv
      JOIN users u ON cv.voter_id = u.id
      WHERE cv.participant_id = ?
      ORDER BY cv.created_at DESC
    `).bind(t).all();return e.json({votes:r.results||[]})}catch(t){return console.error("[COMPETITIONS] Error fetching votes:",t),e.json({error:"Failed to fetch votes"},500)}});rt.get("/:id/leaderboard-data",async e=>{try{const t=e.req.param("id"),a=(await e.env.DB.prepare(`
      SELECT 
        cp.id,
        cp.user_id,
        cp.competition_id,
        cp.project_id,
        cp.startup_name,
        cp.pitch_deck_url,
        cp.submission_notes,
        cp.payment_status,
        cp.registration_date,
        cp.total_score,
        cp.vote_score,
        cp.growth_score,
        cp.current_rank,
        u.name,
        u.email,
        u.avatar_url,
        p.title as project_title,
        p.description as project_description
      FROM competition_participants cp
      JOIN users u ON cp.user_id = u.id
      LEFT JOIN projects p ON cp.project_id = p.id
      WHERE cp.competition_id = ?
      ORDER BY cp.current_rank ASC, cp.total_score DESC
    `).bind(t).all()).results||[],s=await Promise.all(a.map(async o=>{try{const n=await e.env.DB.prepare(`
            SELECT 
              COUNT(*) as vote_count,
              AVG(vote_score) as avg_vote_score
            FROM competition_votes
            WHERE participant_id = ?
          `).bind(o.id).first();return{...o,vote_count:(n==null?void 0:n.vote_count)||0,avg_vote_score:(n==null?void 0:n.avg_vote_score)||null}}catch(n){return console.error("[COMPETITIONS] Error fetching votes for participant:",o.id,n),{...o,vote_count:0,avg_vote_score:null}}}));return e.json({participants:s})}catch(t){return console.error("[COMPETITIONS] Error fetching leaderboard:",t),e.json({error:"Failed to fetch leaderboard",details:t.message},500)}});rt.post("/:id/winners",da,async e=>{try{const t=e.req.param("id"),r=e.get("user");if(r.role!=="admin"&&r.email!=="cadamar1236@gmail.com")return e.json({error:"Unauthorized"},403);const{winners:a}=await e.req.json();for(const s of a)await e.env.DB.prepare(`
        INSERT INTO competition_winners (competition_id, user_id, position, prize_amount)
        VALUES (?, ?, ?, ?)
      `).bind(t,s.user_id,s.position,s.prize_amount).run();return e.json({success:!0})}catch(t){return console.error("[COMPETITIONS] Error announcing winners:",t),e.json({error:"Failed to announce winners"},500)}});async function Qf(e,t){try{const r=await e.prepare(`
      SELECT id, user_id, project_id FROM competition_participants
      WHERE competition_id = ?
    `).bind(t).all();for(const o of r.results||[]){const n=await e.prepare(`
        SELECT 
          SUM(CASE WHEN voter_role = 'investor' THEN vote_score * 2 ELSE vote_score END) as weighted_sum,
          SUM(CASE WHEN voter_role = 'investor' THEN 2 ELSE 1 END) as total_weight
        FROM competition_votes
        WHERE participant_id = ?
      `).bind(o.id).first(),i=n!=null&&n.weighted_sum&&(n!=null&&n.total_weight)?n.weighted_sum/n.total_weight:0;let l=0;if(o.user_id){const c=await e.prepare(`
          SELECT 
            COUNT(*) as total_goals,
            SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed_goals
          FROM goals
          WHERE user_id = ?
        `).bind(o.user_id).first(),u=(c==null?void 0:c.total_goals)||0,p=(c==null?void 0:c.completed_goals)||0;l=p*10+(u>0?p/u*20:0)}const d=i+l;await e.prepare(`
        UPDATE competition_participants
        SET 
          vote_score = ?,
          growth_score = ?,
          total_score = ?,
          updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
      `).bind(i,l,d,o.id).run()}const a=await e.prepare(`
      SELECT id FROM competition_participants
      WHERE competition_id = ?
      ORDER BY total_score DESC, registration_date ASC
    `).bind(t).all();let s=1;for(const o of a.results||[])await e.prepare(`
        UPDATE competition_participants
        SET current_rank = ?
        WHERE id = ?
      `).bind(s,o.id).run(),s++;console.log(`[COMPETITIONS] Rankings recalculated for competition ${t}`)}catch(r){console.error("[COMPETITIONS] Error recalculating rankings:",r)}}const de=new ee;function Xf(e){if(!e.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");return e.JWT_SECRET}const pe=async(e,t)=>{var a,s,o,n,i;const r=((a=e.req.header("Authorization"))==null?void 0:a.replace("Bearer ",""))||((o=(s=e.req.header("cookie"))==null?void 0:s.match(/authToken=([^;]+)/))==null?void 0:o[1])||((i=(n=e.req.header("Cookie"))==null?void 0:n.match(/authToken=([^;]+)/))==null?void 0:i[1]);if(!r)return e.json({error:"No authentication token provided"},401);try{const l=await te(r,Xf(e.env)),d=await e.env.DB.prepare(`
      SELECT id, email, name, role FROM users WHERE id = ?
    `).bind(l.userId).first();if(!d||d.role!=="admin")return e.json({error:"Admin access required"},403);e.set("user",l),e.set("adminUser",d),await t()}catch{return e.json({error:"Invalid authentication token"},401)}};de.get("/stats/users",pe,async e=>{try{const t=await e.env.DB.prepare(`
      SELECT COUNT(*) as count FROM users
    `).first(),r=await e.env.DB.prepare(`
      SELECT role, COUNT(*) as count 
      FROM users 
      GROUP BY role
    `).all(),a=await e.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM users 
      WHERE created_at >= datetime('now', '-30 days')
    `).first();return e.json({total:(t==null?void 0:t.count)||0,byRole:r.results||[],recentSignups:(a==null?void 0:a.count)||0})}catch(t){return console.error("[ADMIN] Error fetching user stats:",t),e.json({error:"Failed to fetch user statistics"},500)}});de.get("/stats/projects",pe,async e=>{try{const t=await e.env.DB.prepare(`
      SELECT COUNT(*) as count FROM projects
    `).first(),r=await e.env.DB.prepare(`
      SELECT status, COUNT(*) as count 
      FROM projects 
      GROUP BY status
    `).all(),a=await e.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM projects 
      WHERE created_at >= datetime('now', '-30 days')
    `).first();return e.json({total:(t==null?void 0:t.count)||0,byStatus:r.results||[],recentProjects:(a==null?void 0:a.count)||0})}catch(t){return console.error("[ADMIN] Error fetching project stats:",t),e.json({error:"Failed to fetch project statistics"},500)}});de.get("/stats/competitions",pe,async e=>{try{const t=await e.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM competitions 
      WHERE status = 'active'
    `).first(),r=await e.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM competition_participants
    `).first(),a=await e.env.DB.prepare(`
      SELECT COUNT(*) as count, SUM(c.ticket_price) as revenue
      FROM competition_participants cp
      JOIN competitions c ON cp.competition_id = c.id
      WHERE cp.payment_status = 'completed' AND c.ticket_required = 1
    `).first();return e.json({active:(t==null?void 0:t.count)||0,totalParticipants:(r==null?void 0:r.count)||0,revenue:(a==null?void 0:a.revenue)||0})}catch(t){return console.error("[ADMIN] Error fetching competition stats:",t),e.json({error:"Failed to fetch competition statistics"},500)}});de.get("/activity",pe,async e=>{try{const t=await e.env.DB.prepare(`
      SELECT id, name, email, created_at, 'user' as type
      FROM users
      ORDER BY created_at DESC
      LIMIT 10
    `).all(),r=await e.env.DB.prepare(`
      SELECT p.id, p.title, u.name as user_name, p.created_at, 'project' as type
      FROM projects p
      JOIN users u ON p.user_id = u.id
      ORDER BY p.created_at DESC
      LIMIT 10
    `).all(),a=await e.env.DB.prepare(`
      SELECT cp.id, u.name as user_name, c.title as competition_name, cp.registration_date as created_at, 'registration' as type
      FROM competition_participants cp
      JOIN users u ON cp.user_id = u.id
      JOIN competitions c ON cp.competition_id = c.id
      ORDER BY cp.registration_date DESC
      LIMIT 10
    `).all(),s=[...(t.results||[]).map(o=>({id:o.id,description:`${o.name} joined the platform`,icon:"user-plus",created_at:o.created_at})),...(r.results||[]).map(o=>({id:o.id,description:`${o.user_name} created project "${o.title}"`,icon:"rocket",created_at:o.created_at})),...(a.results||[]).map(o=>({id:o.id,description:`${o.user_name} registered for "${o.competition_name}"`,icon:"trophy",created_at:o.created_at}))].sort((o,n)=>new Date(n.created_at).getTime()-new Date(o.created_at).getTime()).slice(0,20);return e.json({activities:s})}catch(t){return console.error("[ADMIN] Error fetching activity:",t),e.json({error:"Failed to fetch activity"},500)}});de.get("/users",pe,async e=>{try{const t=await e.env.DB.prepare(`
      SELECT 
        u.id,
        u.email,
        u.name,
        u.role,
        u.avatar_url,
        u.created_at,
        COUNT(DISTINCT p.id) as project_count
      FROM users u
      LEFT JOIN projects p ON u.id = p.user_id
      GROUP BY u.id
      ORDER BY u.created_at DESC
    `).all();return e.json({users:t.results||[]})}catch(t){return console.error("[ADMIN] Error fetching users:",t),e.json({error:"Failed to fetch users"},500)}});de.post("/competitions",pe,async e=>{try{const{title:t,description:r,prize_amount:a,competition_type:s,event_date:o,event_time:n,deadline:i,guidelines:l,payment_link:d,ticket_required:c,ticket_price:u,location:p}=await e.req.json();if(!t||!r||!s)return e.json({error:"Title, description, and competition type are required"},400);const m=await e.env.DB.prepare(`
      INSERT INTO competitions (
        title, description, prize_amount, competition_type, 
        event_date, event_time, deadline, guidelines, 
        payment_link, ticket_required, ticket_price, location, status
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'active')
    `).bind(t,r,a||null,s,o||null,n||null,i||null,l||null,d||null,c?1:0,u||0,p||null).run();return e.json({success:!0,competitionId:m.meta.last_row_id})}catch(t){return console.error("[ADMIN] Error creating competition:",t),e.json({error:"Failed to create competition"},500)}});de.delete("/competitions/:id",pe,async e=>{try{const t=e.req.param("id");return await e.env.DB.prepare(`
      DELETE FROM competition_winners WHERE competition_id = ?
    `).bind(t).run(),await e.env.DB.prepare(`
      DELETE FROM competition_participants WHERE competition_id = ?
    `).bind(t).run(),await e.env.DB.prepare(`
      DELETE FROM competitions WHERE id = ?
    `).bind(t).run(),e.json({success:!0})}catch(t){return console.error("[ADMIN] Error deleting competition:",t),e.json({error:"Failed to delete competition"},500)}});de.put("/competitions/:id",pe,async e=>{try{const t=e.req.param("id"),{title:r,description:a,prize_amount:s,competition_type:o,event_date:n,event_time:i,deadline:l,guidelines:d,payment_link:c,ticket_required:u,ticket_price:p,location:m,status:g}=await e.req.json();return await e.env.DB.prepare(`
      UPDATE competitions
      SET title = ?,
          description = ?,
          prize_amount = ?,
          competition_type = ?,
          event_date = ?,
          event_time = ?,
          deadline = ?,
          guidelines = ?,
          payment_link = ?,
          ticket_required = ?,
          ticket_price = ?,
          location = ?,
          status = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(r,a,s||null,o,n||null,i||null,l||null,d||null,c||null,u?1:0,p||0,m||null,g||"active",t).run(),e.json({success:!0})}catch(t){return console.error("[ADMIN] Error updating competition:",t),e.json({error:"Failed to update competition"},500)}});de.get("/competitions/:id/participants",pe,async e=>{try{const t=e.req.param("id"),r=await e.env.DB.prepare(`
      SELECT 
        cp.*,
        u.name,
        u.email,
        u.avatar_url,
        p.title as project_title,
        p.description as project_description
      FROM competition_participants cp
      JOIN users u ON cp.user_id = u.id
      LEFT JOIN projects p ON cp.project_id = p.id
      WHERE cp.competition_id = ?
      ORDER BY cp.registration_date DESC
    `).bind(t).all();return e.json({participants:r.results||[]})}catch(t){return console.error("[ADMIN] Error fetching participants:",t),e.json({error:"Failed to fetch participants"},500)}});de.put("/competitions/:id",pe,async e=>{try{const t=e.req.param("id"),{title:r,description:a,prize_amount:s,competition_type:o,event_date:n,event_time:i,deadline:l,guidelines:d,payment_link:c,ticket_required:u,ticket_price:p,location:m,status:g}=await e.req.json();return await e.env.DB.prepare(`
      UPDATE competitions
      SET title = ?,
          description = ?,
          prize_amount = ?,
          competition_type = ?,
          event_date = ?,
          event_time = ?,
          deadline = ?,
          guidelines = ?,
          payment_link = ?,
          ticket_required = ?,
          ticket_price = ?,
          location = ?,
          status = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(r,a,s||null,o,n||null,i||null,l||null,d||null,c||null,u?1:0,p||0,m||null,g||"active",t).run(),e.json({success:!0})}catch(t){return console.error("[ADMIN] Error updating competition:",t),e.json({error:"Failed to update competition"},500)}});de.get("/competitions/:id/participants",pe,async e=>{try{const t=e.req.param("id"),r=await e.env.DB.prepare(`
      SELECT 
        cp.*,
        u.name,
        u.email,
        u.avatar_url,
        p.title as project_title,
        p.description as project_description
      FROM competition_participants cp
      JOIN users u ON cp.user_id = u.id
      LEFT JOIN projects p ON cp.project_id = p.id
      WHERE cp.competition_id = ?
      ORDER BY cp.registration_date DESC
    `).bind(t).all();return e.json({participants:r.results||[]})}catch(t){return console.error("[ADMIN] Error fetching participants:",t),e.json({error:"Failed to fetch participants"},500)}});de.get("/reports/:type",pe,async e=>{try{const t=e.req.param("type");let r=[];switch(t){case"startups":r=(await e.env.DB.prepare(`
          SELECT 
            u.name as founder_name,
            u.email as founder_email,
            p.title as project_name,
            p.description,
            p.status,
            p.created_at
          FROM projects p
          JOIN users u ON p.user_id = u.id
          ORDER BY p.created_at DESC
        `).all()).results||[];break;case"competitions":r=(await e.env.DB.prepare(`
          SELECT 
            c.title,
            c.competition_type,
            c.prize_amount,
            c.status,
            COUNT(DISTINCT cp.id) as participants,
            COUNT(DISTINCT CASE WHEN cp.payment_status = 'completed' THEN cp.id END) as paid_participants,
            c.created_at
          FROM competitions c
          LEFT JOIN competition_participants cp ON c.id = cp.competition_id
          GROUP BY c.id
          ORDER BY c.created_at DESC
        `).all()).results||[];break;case"revenue":r=(await e.env.DB.prepare(`
          SELECT 
            c.title as competition,
            c.ticket_price,
            COUNT(cp.id) as tickets_sold,
            (c.ticket_price * COUNT(cp.id)) as total_revenue,
            cp.registration_date as sale_date
          FROM competition_participants cp
          JOIN competitions c ON cp.competition_id = c.id
          WHERE cp.payment_status = 'completed' AND c.ticket_required = 1
          GROUP BY c.id, cp.registration_date
          ORDER BY cp.registration_date DESC
        `).all()).results||[];break;case"users":r=(await e.env.DB.prepare(`
          SELECT 
            u.name,
            u.email,
            u.role,
            COUNT(DISTINCT p.id) as projects,
            COUNT(DISTINCT cp.id) as competitions_entered,
            u.created_at
          FROM users u
          LEFT JOIN projects p ON u.id = p.user_id
          LEFT JOIN competition_participants cp ON u.id = cp.user_id
          GROUP BY u.id
          ORDER BY u.created_at DESC
        `).all()).results||[];break;default:return e.json({error:"Invalid report type"},400)}return e.json({data:r})}catch(t){return console.error("[ADMIN] Error generating report:",t),e.json({error:"Failed to generate report"},500)}});de.post("/competitions",pe,async e=>{try{const t=await e.req.json(),{title:r,description:a,competition_type:s,prize_amount:o,deadline:n,guidelines:i,ticket_price:l,event_date:d,event_time:c,location:u,payment_link:p,ticket_required:m}=t,g=await e.env.DB.prepare(`
      INSERT INTO competitions (
        title, description, competition_type, prize_amount, deadline,
        guidelines, ticket_price, event_date, event_time, location,
        payment_link, ticket_required, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'active')
    `).bind(r,a||null,s,o||0,n||null,i||null,l||0,d||null,c||null,u||null,p||null,m?1:0).run();return e.json({success:!0,competitionId:g.meta.last_row_id})}catch(t){return console.error("[ADMIN] Error creating competition:",t),e.json({error:"Failed to create competition"},500)}});de.put("/competitions/:id",pe,async e=>{try{const t=e.req.param("id"),r=await e.req.json(),{title:a,description:s,competition_type:o,prize_amount:n,deadline:i,guidelines:l,ticket_price:d,event_date:c,event_time:u,location:p,payment_link:m,ticket_required:g,status:b}=r;return await e.env.DB.prepare(`
      UPDATE competitions SET
        title = ?,
        description = ?,
        competition_type = ?,
        prize_amount = ?,
        deadline = ?,
        guidelines = ?,
        ticket_price = ?,
        event_date = ?,
        event_time = ?,
        location = ?,
        payment_link = ?,
        ticket_required = ?,
        status = COALESCE(?, status),
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a,s||null,o,n||0,i||null,l||null,d||0,c||null,u||null,p||null,m||null,g?1:0,b||null,t).run(),e.json({success:!0})}catch(t){return console.error("[ADMIN] Error updating competition:",t),e.json({error:"Failed to update competition"},500)}});de.delete("/competitions/:id",pe,async e=>{try{const t=e.req.param("id");return await e.env.DB.prepare(`
      DELETE FROM competition_votes WHERE competition_id = ?
    `).bind(t).run(),await e.env.DB.prepare(`
      DELETE FROM competition_winners WHERE competition_id = ?
    `).bind(t).run(),await e.env.DB.prepare(`
      DELETE FROM competition_participants WHERE competition_id = ?
    `).bind(t).run(),await e.env.DB.prepare(`
      DELETE FROM competitions WHERE id = ?
    `).bind(t).run(),e.json({success:!0})}catch(t){return console.error("[ADMIN] Error deleting competition:",t),e.json({error:"Failed to delete competition"},500)}});de.get("/stats/chat",pe,async e=>{try{const t=await e.env.DB.prepare(`
      SELECT 
        COUNT(*) as total_conversations,
        COUNT(CASE WHEN status = 'active' THEN 1 END) as active_conversations
      FROM user_conversations
    `).first(),r=await e.env.DB.prepare(`
      SELECT COUNT(*) as count FROM user_messages
    `).first(),a=await e.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM user_messages 
      WHERE created_at >= datetime('now', '-7 days')
    `).first(),s=await e.env.DB.prepare(`
      SELECT 
        COUNT(*) as total_messages,
        COUNT(DISTINCT user_id) as unique_users
      FROM agent_chat_messages
    `).first(),o=await e.env.DB.prepare(`
      SELECT COUNT(*) as count 
      FROM agent_chat_messages 
      WHERE created_at >= datetime('now', '-7 days')
    `).first(),n=await e.env.DB.prepare(`
      SELECT role, COUNT(*) as count
      FROM agent_chat_messages
      GROUP BY role
      ORDER BY count DESC
    `).all();return e.json({userChats:{totalConversations:(t==null?void 0:t.total_conversations)||0,activeConversations:(t==null?void 0:t.active_conversations)||0,totalMessages:(r==null?void 0:r.count)||0,recentMessages:(a==null?void 0:a.count)||0},aiChats:{totalMessages:(s==null?void 0:s.total_messages)||0,uniqueUsers:(s==null?void 0:s.unique_users)||0,recentMessages:(o==null?void 0:o.count)||0,byRole:n.results||[]}})}catch(t){return console.error("[ADMIN] Error fetching chat stats:",t),e.json({error:"Failed to fetch chat statistics"},500)}});de.get("/conversations",pe,async e=>{try{const t=parseInt(e.req.query("limit")||"50"),r=parseInt(e.req.query("offset")||"0"),a=await e.env.DB.prepare(`
      SELECT 
        uc.id,
        uc.status,
        uc.created_at,
        uc.last_message_at,
        u1.id as user1_id,
        u1.name as user1_name,
        u1.email as user1_email,
        u1.avatar_url as user1_avatar,
        u2.id as user2_id,
        u2.name as user2_name,
        u2.email as user2_email,
        u2.avatar_url as user2_avatar,
        (SELECT COUNT(*) FROM user_messages WHERE conversation_id = uc.id) as message_count,
        (SELECT message FROM user_messages WHERE conversation_id = uc.id ORDER BY created_at DESC LIMIT 1) as last_message
      FROM user_conversations uc
      JOIN users u1 ON uc.user1_id = u1.id
      JOIN users u2 ON uc.user2_id = u2.id
      ORDER BY uc.last_message_at DESC
      LIMIT ? OFFSET ?
    `).bind(t,r).all(),s=await e.env.DB.prepare(`
      SELECT COUNT(*) as count FROM user_conversations
    `).first();return e.json({conversations:a.results||[],total:(s==null?void 0:s.count)||0,limit:t,offset:r})}catch(t){return console.error("[ADMIN] Error fetching conversations:",t),e.json({error:"Failed to fetch conversations"},500)}});de.get("/conversations/:id/messages",pe,async e=>{try{const t=e.req.param("id"),r=await e.env.DB.prepare(`
      SELECT 
        m.id,
        m.message,
        m.is_read,
        m.created_at,
        u.id as sender_id,
        u.name as sender_name,
        u.email as sender_email,
        u.avatar_url as sender_avatar
      FROM user_messages m
      JOIN users u ON m.sender_id = u.id
      WHERE m.conversation_id = ?
      ORDER BY m.created_at ASC
    `).bind(t).all();return e.json({messages:r.results||[]})}catch(t){return console.error("[ADMIN] Error fetching messages:",t),e.json({error:"Failed to fetch messages"},500)}});de.get("/agent-conversations",pe,async e=>{try{const t=parseInt(e.req.query("limit")||"50"),r=parseInt(e.req.query("offset")||"0"),a=await e.env.DB.prepare(`
      SELECT 
        u.id as user_id,
        u.name as user_name,
        u.email as user_email,
        u.avatar_url as user_avatar,
        COUNT(acm.id) as message_count,
        MAX(acm.created_at) as last_message_at,
        (SELECT content FROM agent_chat_messages WHERE user_id = u.id ORDER BY created_at DESC LIMIT 1) as last_message
      FROM users u
      JOIN agent_chat_messages acm ON u.id = acm.user_id
      GROUP BY u.id
      ORDER BY last_message_at DESC
      LIMIT ? OFFSET ?
    `).bind(t,r).all(),s=await e.env.DB.prepare(`
      SELECT COUNT(DISTINCT user_id) as count FROM agent_chat_messages
    `).first();return e.json({conversations:a.results||[],total:(s==null?void 0:s.count)||0,limit:t,offset:r})}catch(t){return console.error("[ADMIN] Error fetching agent conversations:",t),e.json({error:"Failed to fetch agent conversations"},500)}});de.get("/agent-conversations/:userId",pe,async e=>{try{const t=e.req.param("userId"),r=await e.env.DB.prepare(`
      SELECT id, name, email, avatar_url FROM users WHERE id = ?
    `).bind(t).first();if(!r)return e.json({error:"User not found"},404);const a=await e.env.DB.prepare(`
      SELECT 
        id,
        role,
        content,
        metadata,
        created_at
      FROM agent_chat_messages
      WHERE user_id = ?
      ORDER BY created_at ASC
    `).bind(t).all();return e.json({conversation:{user_id:r.id,user_name:r.name,user_email:r.email,user_avatar:r.avatar_url,messages:a.results||[]}})}catch(t){return console.error("[ADMIN] Error fetching agent conversation:",t),e.json({error:"Failed to fetch conversation"},500)}});de.get("/stats/active-users",pe,async e=>{try{const t=await e.env.DB.prepare(`
      SELECT 
        u.id,
        u.name,
        u.email,
        u.avatar_url,
        COUNT(DISTINCT m.id) as message_count,
        COUNT(DISTINCT acm.id) as ai_chat_count
      FROM users u
      LEFT JOIN user_messages m ON u.id = m.sender_id
      LEFT JOIN agent_chat_messages acm ON u.id = acm.user_id
      GROUP BY u.id
      HAVING message_count > 0 OR ai_chat_count > 0
      ORDER BY (message_count + ai_chat_count) DESC
      LIMIT 20
    `).all(),r=await e.env.DB.prepare(`
      SELECT DISTINCT 
        u.id,
        u.name,
        u.email,
        u.avatar_url,
        MAX(COALESCE(m.created_at, acm.created_at)) as last_activity
      FROM users u
      LEFT JOIN user_messages m ON u.id = m.sender_id AND m.created_at >= datetime('now', '-7 days')
      LEFT JOIN agent_chat_messages acm ON u.id = acm.user_id AND acm.created_at >= datetime('now', '-7 days')
      WHERE m.id IS NOT NULL OR acm.id IS NOT NULL
      GROUP BY u.id
      ORDER BY last_activity DESC
      LIMIT 20
    `).all();return e.json({topMessagers:t.results||[],recentActive:r.results||[]})}catch(t){return console.error("[ADMIN] Error fetching active users:",t),e.json({error:"Failed to fetch active users"},500)}});de.get("/stats/engagement-timeline",pe,async e=>{try{const t=parseInt(e.req.query("days")||"30"),r=await e.env.DB.prepare(`
      SELECT 
        DATE(created_at) as date,
        COUNT(*) as count
      FROM user_messages
      WHERE created_at >= datetime('now', '-' || ? || ' days')
      GROUP BY DATE(created_at)
      ORDER BY date ASC
    `).bind(t).all(),a=await e.env.DB.prepare(`
      SELECT 
        DATE(created_at) as date,
        COUNT(*) as count
      FROM agent_chat_messages
      WHERE created_at >= datetime('now', '-' || ? || ' days')
      GROUP BY DATE(created_at)
      ORDER BY date ASC
    `).bind(t).all();return e.json({messages:r.results||[],aiChats:a.results||[]})}catch(t){return console.error("[ADMIN] Error fetching engagement timeline:",t),e.json({error:"Failed to fetch engagement timeline"},500)}});const Ue=new ee;Ue.use("*",vr({origin:e=>e||"*",credentials:!0,allowMethods:["GET","POST","PUT","DELETE","OPTIONS"],allowHeaders:["Content-Type","Authorization","Cookie","X-Requested-With","X-Agent-Key"],exposeHeaders:["Set-Cookie"]}));const ct=async(e,t)=>{var a,s,o,n,i;const r=((a=e.req.header("Authorization"))==null?void 0:a.replace("Bearer ",""))||((o=(s=e.req.header("cookie"))==null?void 0:s.match(/authToken=([^;]+)/))==null?void 0:o[1])||((i=(n=e.req.header("Cookie"))==null?void 0:n.match(/authToken=([^;]+)/))==null?void 0:i[1]);if(!r)return e.json({error:"No authentication provided"},401);try{const l=await te(r,e.env.JWT_SECRET||"your-secret-key-change-in-production-use-env-var");e.set("user",l),await t()}catch{return e.json({error:"Invalid authentication"},401)}};async function hn(e,t){var r,a,s,o,n,i,l,d,c,u,p,m,g,b,v,y,f,x;console.log("[METRICS-DATA] Fetching context for user:",t);try{const C=(await e.prepare(`
      SELECT id, description, status, target_value, current_value, deadline, category, created_at, updated_at
      FROM goals 
      WHERE user_id = ? 
      ORDER BY created_at DESC
    `).bind(t).all()).results||[],A=await e.prepare(`
      SELECT team_id
      FROM startup_team_members
      WHERE user_id = ?
      ORDER BY is_creator DESC, joined_at ASC
      LIMIT 1
    `).bind(t).first();let I;A&&A.team_id?I=await e.prepare(`
        SELECT um.metric_name, um.metric_value, um.recorded_date
        FROM user_metrics um
        INNER JOIN startup_team_members stm ON um.user_id = stm.user_id
        WHERE stm.team_id = ?
        ORDER BY um.recorded_date DESC
        LIMIT 180
      `).bind(A.team_id).all():I=await e.prepare(`
        SELECT metric_name, metric_value, recorded_date
        FROM user_metrics 
        WHERE user_id = ? 
        ORDER BY recorded_date DESC
        LIMIT 180
      `).bind(t).all();const M=I.results||[],F=await e.prepare(`
      SELECT metric1_name, metric2_name 
      FROM primary_metrics 
      WHERE user_id = ?
    `).bind(t).first(),N={};M.forEach(se=>{N[se.metric_name]||(N[se.metric_name]=[]),N[se.metric_name].push({value:se.metric_value,date:se.recorded_date})});const E={};Object.keys(N).forEach(se=>{const Ce=N[se];if(Ce.length>=2){const Oe=Ce[0].value,ve=Ce[1].value;E[se]=ve>0?(Oe-ve)/ve*100:0}else E[se]=0});const O=C.filter(se=>se.status==="active"||se.status==="in_progress"),B=C.filter(se=>se.status==="completed"),H=((a=(r=N.users)==null?void 0:r[0])==null?void 0:a.value)||0,P=((o=(s=N.revenue)==null?void 0:s[0])==null?void 0:o.value)||0,D=((i=(n=N.mrr)==null?void 0:n[0])==null?void 0:i.value)||0,k=((d=(l=N.churn)==null?void 0:l[0])==null?void 0:d.value)||0,T=((u=(c=N.cac)==null?void 0:c[0])==null?void 0:u.value)||0,L=((m=(p=N.ltv)==null?void 0:p[0])==null?void 0:m.value)||0,ae=((b=(g=N.nps)==null?void 0:g[0])==null?void 0:b.value)||0,ce=((y=(v=N.dau)==null?void 0:v[0])==null?void 0:y.value)||0,Y=((x=(f=N.mau)==null?void 0:f[0])==null?void 0:x.value)||0;return{userId:t,goals:{all:C,active:O,completed:B,totalCount:C.length,completedCount:B.length,completionRate:C.length>0?Math.round(B.length/C.length*100):0},metrics:{current:{users:H,revenue:P,mrr:D,churn:k,cac:T,ltv:L,nps:ae,dau:ce,mau:Y},growth:E,history:N,rawHistory:M,primaryConfig:F||{metric1_name:"users",metric2_name:"revenue"}},timestamp:new Date().toISOString()}}catch(_){throw console.error("[METRICS-DATA] ERROR:",_),_}}function Bd(e,t){const r={SaaS:{seed:{monthly_growth:15,churn_rate:5,ltv_cac_ratio:3,nps:30,conversion_rate:2},series_a:{monthly_growth:10,churn_rate:3,ltv_cac_ratio:4,nps:40,conversion_rate:3},series_b:{monthly_growth:7,churn_rate:2,ltv_cac_ratio:5,nps:50,conversion_rate:4}},fintech:{seed:{monthly_growth:12,churn_rate:4,ltv_cac_ratio:4,nps:35,conversion_rate:1.5},series_a:{monthly_growth:8,churn_rate:2.5,ltv_cac_ratio:5,nps:45,conversion_rate:2.5}},ecommerce:{seed:{monthly_growth:20,churn_rate:8,ltv_cac_ratio:2,nps:25,conversion_rate:3},series_a:{monthly_growth:15,churn_rate:6,ltv_cac_ratio:3,nps:35,conversion_rate:4}}},a=r[e]||r.SaaS;return a[t]||a.seed}Ue.get("/health",e=>e.json({status:"healthy",service:"metrics-data-api",timestamp:new Date().toISOString()}));Ue.get("/context",ct,async e=>{const t=e.get("user");try{const r=await hn(e.env.DB,t.userId);return e.json({success:!0,data:r})}catch(r){return console.error("[METRICS-DATA] Error getting context:",r),e.json({success:!1,error:r instanceof Error?r.message:"Unknown error"},500)}});Ue.get("/goals",ct,async e=>{const t=e.get("user");try{const r=await e.env.DB.prepare(`
      SELECT team_id
      FROM startup_team_members
      WHERE user_id = ?
      ORDER BY is_creator DESC, joined_at ASC
      LIMIT 1
    `).bind(t.userId).first();let a;r&&r.team_id?a=await e.env.DB.prepare(`
        SELECT 
          g.id, 
          g.description, 
          g.status, 
          g.target_value, 
          g.current_value, 
          g.deadline, 
          g.category, 
          g.created_at, 
          g.updated_at,
          g.user_id,
          u.name as creator_name,
          u.avatar_url as creator_avatar
        FROM goals g
        INNER JOIN startup_team_members stm ON g.user_id = stm.user_id
        LEFT JOIN users u ON g.user_id = u.id
        WHERE stm.team_id = ?
        ORDER BY g.created_at DESC
      `).bind(r.team_id).all():a=await e.env.DB.prepare(`
        SELECT 
          id, 
          description, 
          status, 
          target_value, 
          current_value, 
          deadline, 
          category, 
          created_at, 
          updated_at,
          user_id
        FROM goals 
        WHERE user_id = ? 
        ORDER BY created_at DESC
      `).bind(t.userId).all();const s=a.results||[],o=s.filter(i=>i.status==="active"||i.status==="in_progress"),n=s.filter(i=>i.status==="completed");return e.json({success:!0,goals:s,summary:{total:s.length,active:o.length,completed:n.length,completionRate:s.length>0?Math.round(n.length/s.length*100):0}})}catch(r){return console.error("[METRICS-DATA] Error getting goals:",r),e.json({success:!1,error:r instanceof Error?r.message:"Unknown error"},500)}});Ue.get("/metrics",ct,async e=>{const t=e.get("user"),r=parseInt(e.req.query("days")||"90");try{const a=await e.env.DB.prepare(`
      SELECT team_id
      FROM startup_team_members
      WHERE user_id = ?
      ORDER BY is_creator DESC, joined_at ASC
      LIMIT 1
    `).bind(t.userId).first();let s;a&&a.team_id?s=await e.env.DB.prepare(`
        SELECT um.metric_name, um.metric_value, um.recorded_date
        FROM user_metrics um
        INNER JOIN startup_team_members stm ON um.user_id = stm.user_id
        WHERE stm.team_id = ?
        ORDER BY um.recorded_date DESC
        LIMIT ?
      `).bind(a.team_id,r*2).all():s=await e.env.DB.prepare(`
        SELECT metric_name, metric_value, recorded_date
        FROM user_metrics 
        WHERE user_id = ? 
        ORDER BY recorded_date DESC
        LIMIT ?
      `).bind(t.userId,r*2).all();const o=s.results||[],n={};o.forEach(d=>{n[d.metric_name]||(n[d.metric_name]=[]),n[d.metric_name].push({value:d.metric_value,date:d.recorded_date})});const i={},l={};return Object.keys(n).forEach(d=>{var u;const c=n[d];if(i[d]=((u=c[0])==null?void 0:u.value)||0,c.length>=2){const p=c[1].value;l[d]=p>0?(i[d]-p)/p*100:0}else l[d]=0}),e.json({success:!0,metrics:{current:i,growth:l,history:n}})}catch(a){return console.error("[METRICS-DATA] Error getting metrics:",a),e.json({success:!1,error:a instanceof Error?a.message:"Unknown error"},500)}});Ue.get("/benchmarks",ct,async e=>{const t=e.req.query("industry")||"SaaS",r=e.req.query("stage")||"seed",a=Bd(t,r);return e.json({success:!0,industry:t,stage:r,benchmarks:a})});Ue.post("/compare",ct,async e=>{const t=e.get("user"),{industry:r,stage:a}=await e.req.json();try{const s=await hn(e.env.DB,t.userId),o=Bd(r||"SaaS",a||"seed"),n={},i=s.metrics.growth.users||0;n.growth={current:i,benchmark:o.monthly_growth,difference:i-o.monthly_growth,status:i>=o.monthly_growth?"above":"below"};const l=s.metrics.current.churn||0;n.churn={current:l,benchmark:o.churn_rate,difference:o.churn_rate-l,status:l<=o.churn_rate?"above":"below"};const d=s.metrics.current.ltv||0,c=s.metrics.current.cac||1,u=c>0?d/c:0;n.ltv_cac={current:u,benchmark:o.ltv_cac_ratio,difference:u-o.ltv_cac_ratio,status:u>=o.ltv_cac_ratio?"above":"below"};const p=s.metrics.current.nps||0;n.nps={current:p,benchmark:o.nps,difference:p-o.nps,status:p>=o.nps?"above":"below"};let m=0;Object.values(n).forEach(b=>{b.status==="above"&&m++});const g=Math.round(m/Object.keys(n).length*100);return e.json({success:!0,comparison:n,overallScore:g,industry:r,stage:a,benchmarks:o})}catch(s){return console.error("[METRICS-DATA] Error comparing metrics:",s),e.json({success:!1,error:s instanceof Error?s.message:"Unknown error"},500)}});Ue.post("/goals/:goalId/progress",ct,async e=>{const t=e.get("user"),r=e.req.param("goalId"),{currentValue:a,status:s}=await e.req.json();try{const o=await e.env.DB.prepare(`
      SELECT id, target_value FROM goals WHERE id = ? AND user_id = ?
    `).bind(r,t.userId).first();if(!o)return e.json({success:!1,error:"Goal not found"},404);const n=s||(a>=o.target_value?"completed":"active");return await e.env.DB.prepare(`
      UPDATE goals 
      SET current_value = ?, status = ?, updated_at = datetime('now')
      WHERE id = ? AND user_id = ?
    `).bind(a,n,r,t.userId).run(),e.json({success:!0,goalId:r,currentValue:a,status:n})}catch(o){return console.error("[METRICS-DATA] Error updating goal:",o),e.json({success:!1,error:o instanceof Error?o.message:"Unknown error"},500)}});Ue.post("/metrics/add",ct,async e=>{const t=e.get("user"),{metricName:r,value:a,date:s}=await e.req.json();if(!r||a===void 0)return e.json({success:!1,error:"metricName and value are required"},400);try{const o=s||new Date().toISOString().split("T")[0];return await e.env.DB.prepare(`
      INSERT INTO user_metrics (user_id, metric_name, metric_value, recorded_date)
      VALUES (?, ?, ?, ?)
    `).bind(t.userId,r,a,o).run(),e.json({success:!0,metric:{name:r,value:a,date:o}})}catch(o){return console.error("[METRICS-DATA] Error adding metric:",o),e.json({success:!1,error:o instanceof Error?o.message:"Unknown error"},500)}});Ue.post("/report",ct,async e=>{const t=e.get("user"),{period:r}=await e.req.json();try{const a=await hn(e.env.DB,t.userId),s={period:r||"weekly",generatedAt:new Date().toISOString(),userId:t.userId,summary:{totalGoals:a.goals.totalCount,completedGoals:a.goals.completedCount,completionRate:a.goals.completionRate,activeGoals:a.goals.active.length},metrics:{current:a.metrics.current,growth:a.metrics.growth},highlights:[],concerns:[],recommendations:[]};Object.entries(a.metrics.growth).forEach(([i,l])=>{typeof l=="number"&&l>10&&s.highlights.push(`${i} creció ${l.toFixed(1)}% - ¡Excelente!`)}),a.goals.completionRate>70&&s.highlights.push(`Tasa de completitud de objetivos del ${a.goals.completionRate}%`),Object.entries(a.metrics.growth).forEach(([i,l])=>{typeof l=="number"&&l<-5&&s.concerns.push(`${i} disminuyó ${Math.abs(l).toFixed(1)}%`)}),a.metrics.current.churn>5&&s.concerns.push(`Churn rate alto: ${a.metrics.current.churn}%`),a.goals.active.length===0&&s.recommendations.push("Crea nuevos objetivos para mantener el momentum"),Object.keys(a.metrics.history).length<3&&s.recommendations.push("Registra más métricas para un análisis más completo");const o=a.metrics.current.ltv||0,n=a.metrics.current.cac||1;return n>0&&o/n<3&&s.recommendations.push("Mejora tu ratio LTV/CAC (actualmente: "+(o/n).toFixed(1)+"x)"),e.json({success:!0,report:s})}catch(a){return console.error("[METRICS-DATA] Error generating report:",a),e.json({success:!1,error:a instanceof Error?a.message:"Unknown error"},500)}});Ue.get("/leaderboard",ct,async e=>{const t=e.req.query("type")||"global";try{if(t==="global"){const r=await e.env.DB.prepare(`
        SELECT 
          p.id, p.title, p.description, p.rating_average, p.votes_count,
          u.name as founder_name, 'project' as type
        FROM projects p
        JOIN users u ON p.user_id = u.id
        ORDER BY p.rating_average DESC, p.votes_count DESC
        LIMIT 10
      `).all(),a=await e.env.DB.prepare(`
        SELECT 
          bp.id, bp.title, bp.description,
          COALESCE(bp.rating_average, 0) as rating_average,
          COALESCE(bp.votes_count, 0) as votes_count,
          u.name as founder_name, 'product' as type
        FROM beta_products bp
        JOIN users u ON bp.company_user_id = u.id
        ORDER BY bp.rating_average DESC, bp.votes_count DESC
        LIMIT 10
      `).all(),s=[...r.results||[],...a.results||[]].sort((o,n)=>n.rating_average!==o.rating_average?n.rating_average-o.rating_average:n.votes_count-o.votes_count).slice(0,10);return e.json({success:!0,leaderboard:s,type:"global"})}if(t==="goals"){const r=await e.env.DB.prepare(`
        SELECT 
          u.id, u.name,
          COUNT(CASE WHEN g.status = 'completed' THEN 1 END) as completed_goals,
          COUNT(g.id) as total_goals
        FROM users u
        LEFT JOIN goals g ON u.id = g.user_id
        GROUP BY u.id, u.name
        HAVING COUNT(g.id) > 0
        ORDER BY completed_goals DESC
        LIMIT 10
      `).all();return e.json({success:!0,leaderboard:r.results||[],type:"goals"})}return e.json({success:!1,error:"Invalid leaderboard type"},400)}catch(r){return console.error("[METRICS-DATA] Error getting leaderboard:",r),e.json({success:!1,error:r instanceof Error?r.message:"Unknown error"},500)}});const It=new ee;It.use("*",vr({origin:e=>e||"*",credentials:!0,allowMethods:["GET","POST","PUT","DELETE","OPTIONS"],allowHeaders:["Content-Type","Authorization","Cookie"]}));const ca=async(e,t)=>{const r=e.req.header("Authorization"),a=e.req.header("cookie")||e.req.header("Cookie")||"";console.log("[AI-CMO] Auth header:",r?"present":"missing"),console.log("[AI-CMO] Cookie header:",a?"present":"missing");let s=null;if(r&&r.startsWith("Bearer ")&&(s=r.replace("Bearer ","")),!s&&a){const o=a.match(/authToken=([^;]+)/);o&&(s=o[1])}if(console.log("[AI-CMO] Token found:",!!s),!s)return console.log("[AI-CMO] No token - returning 401"),e.json({error:"No authentication token provided"},401);try{if(!e.env.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");const o=await te(s,e.env.JWT_SECRET);console.log("[AI-CMO] JWT payload:",JSON.stringify(o));const n=o.id||o.userId||o.sub||o.user_id;if(!n)return console.log("[AI-CMO] No userId in payload"),e.json({error:"Invalid token payload"},401);e.set("userId",n),await t()}catch(o){return console.error("[AI-CMO] JWT verification failed:",o),e.json({error:"Invalid authentication token"},401)}};It.get("/images",ca,async e=>{try{const t=e.get("userId");if(!t)return e.json({error:"Unauthorized"},401);const a=await e.env.DB.prepare(`
      SELECT 
        id,
        user_id,
        image_url,
        prompt,
        status,
        image_type,
        metadata,
        created_at,
        updated_at
      FROM ai_generated_images
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT 100
    `).bind(t).all();return e.json({success:!0,images:a.results||[]})}catch(t){return console.error("Error fetching AI images:",t),e.json({error:"Failed to fetch images"},500)}});It.post("/images/:id/approve",ca,async e=>{try{const t=e.get("userId");if(!t)return e.json({error:"Unauthorized"},401);const r=e.req.param("id"),a=e.env.DB;return await a.prepare(`
      SELECT id FROM ai_generated_images
      WHERE id = ? AND user_id = ?
    `).bind(r,t).first()?(await a.prepare(`
      UPDATE ai_generated_images
      SET status = 'approved', updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(r).run(),e.json({success:!0})):e.json({error:"Image not found"},404)}catch(t){return console.error("Error approving image:",t),e.json({error:"Failed to approve image"},500)}});It.post("/images/:id/reject",ca,async e=>{try{const t=e.get("userId");if(!t)return e.json({error:"Unauthorized"},401);const r=e.req.param("id"),a=e.env.DB;return await a.prepare(`
      SELECT id FROM ai_generated_images
      WHERE id = ? AND user_id = ?
    `).bind(r,t).first()?(await a.prepare(`
      UPDATE ai_generated_images
      SET status = 'rejected', updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(r).run(),e.json({success:!0})):e.json({error:"Image not found"},404)}catch(t){return console.error("Error rejecting image:",t),e.json({error:"Failed to reject image"},500)}});It.post("/images/:id/regenerate",ca,async e=>{try{const t=e.get("userId");if(!t)return e.json({error:"Unauthorized"},401);const r=e.req.param("id"),a=e.env.DB,s=await a.prepare(`
      SELECT prompt, image_type, metadata FROM ai_generated_images
      WHERE id = ? AND user_id = ?
    `).bind(r,t).first();if(!s)return e.json({error:"Image not found"},404);const o=crypto.randomUUID();return await a.prepare(`
      INSERT INTO ai_generated_images (
        id, user_id, prompt, status, image_type, metadata, created_at
      ) VALUES (?, ?, ?, 'pending', ?, ?, CURRENT_TIMESTAMP)
    `).bind(o,t,s.prompt,s.image_type,s.metadata).run(),e.json({success:!0,imageId:o})}catch(t){return console.error("Error regenerating image:",t),e.json({error:"Failed to regenerate image"},500)}});It.post("/images",ca,async e=>{try{const t=e.get("userId");if(!t)return e.json({error:"Unauthorized"},401);const{image_url:r,prompt:a,image_type:s,metadata:o}=await e.req.json();if(!r)return e.json({error:"image_url is required"},400);const n=e.env.DB,i=crypto.randomUUID();return await n.prepare(`
      INSERT INTO ai_generated_images (
        id, user_id, image_url, prompt, status, image_type, metadata, created_at
      ) VALUES (?, ?, ?, ?, 'pending', ?, ?, CURRENT_TIMESTAMP)
    `).bind(i,t,r,a||"",s||"general",o?JSON.stringify(o):null).run(),e.json({success:!0,imageId:i})}catch(t){return console.error("Error storing AI image:",t),e.json({error:"Failed to store image"},500)}});It.post("/images/from-agent",async e=>{try{const{user_id:t,image_url:r,prompt:a,image_type:s,metadata:o}=await e.req.json();if(!t||!r)return e.json({error:"user_id and image_url are required"},400);const n=e.env.DB,i=crypto.randomUUID();return await n.prepare(`
      INSERT INTO ai_generated_images (
        id, user_id, image_url, prompt, status, image_type, metadata, created_at
      ) VALUES (?, ?, ?, ?, 'pending', ?, ?, CURRENT_TIMESTAMP)
    `).bind(i,t,r,a||"",s||"general",o?JSON.stringify(o):null).run(),e.json({success:!0,imageId:i})}catch(t){return console.error("Error storing AI image from agent:",t),e.json({error:"Failed to store image"},500)}});const Se=new ee;Se.use("*",vr({origin:e=>e||"*",credentials:!0,allowMethods:["GET","POST","PUT","DELETE","OPTIONS"],allowHeaders:["Content-Type","Authorization","Cookie","X-Requested-With"],exposeHeaders:["Set-Cookie"]}));const Zf="your-secret-key-change-in-production-use-env-var";async function ev(e,t){var r;try{let a=(r=e.req.header("Authorization"))==null?void 0:r.replace("Bearer ","");if(!a){const o=e.req.header("Cookie");if(o){const n=o.match(/authToken=([^;]+)/);n&&(a=n[1])}}if(!a)return console.error("[AUTH] No token found in Authorization header or cookies"),e.json({error:"Unauthorized - No token provided"},401);const s=await te(a,e.env.JWT_SECRET||Zf);e.set("userId",s.userId),e.set("userRole",s.role),await t()}catch(a){return console.error("[AUTH] Token verification failed:",a),e.json({error:"Invalid token"},401)}}function os(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let t="";for(let r=0;r<32;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}function ns(e){return`
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center;">
      <p style="color: #9ca3af; font-size: 12px; margin: 0;">
        ¿No quieres recibir más emails de ASTAR?
        <a href="${e}" style="color: #6b7280; text-decoration: underline;">
          Cancelar suscripción
        </a>
      </p>
    </div>
  `}async function is(e,t,r,a,s="ASTAR <astar@aihelpstudy.com>"){try{const o=await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({from:s,to:[t],subject:r,html:a})});if(!o.ok){const i=await o.text();return console.error("Resend error:",i),{success:!1,error:i}}return{success:!0,emailId:(await o.json()).id}}catch(o){return console.error("Error sending email:",o),{success:!1,error:String(o)}}}function ut(e){const t=new Date(e.getFullYear(),0,1),r=(e.getTime()-t.getTime())/864e5;return Math.ceil((r+t.getDay()+1)/7)}function ls(e,t){let r=e;for(const[a,s]of Object.entries(t))r=r.replace(new RegExp(`{{${a}}}`,"g"),String(s??""));return r=r.replace(/{{#if\s+(\w+)}}([\s\S]*?){{\/if}}/g,(a,s,o)=>t[s]?o:""),r}function tv(e="general"){let t="https://astarlabshub.com/marketplace?tab=traction",r="💬 Responder en el Chat",a="";switch(e.toLowerCase()){case"ideas":case"hypothesis":a="hipotesis",r="💡 Compartir mis Hipótesis";break;case"build":case"construction":a="construccion",r="🛠️ Contar mi Progreso";break;case"measure":case"measurement":case"feedback":a="metricas",r="📊 Compartir mis Números";break;case"reflection":case"weekly_review":a="reflexion",r="🤔 Compartir Aprendizajes";break;default:a="general",r="💬 Responder en el Chat"}return t=`https://astarlabshub.com/marketplace?tab=traction&chat=${a}`,`
<div style="text-align: center; margin: 32px 0;">
  <a href="${t}" 
     style="display: inline-block; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;">
    ${r}
  </a>
</div>
<p style="text-align: center; color: #666; font-size: 14px; margin-top: 16px;">
  El chat automáticamente convertirá tu respuesta en objetivos, métricas o actualizaciones
</p>`}function ds(e,t="general"){const r="___DASHBOARD_BUTTON___";let s=e.replace(/{{dashboard_link}}/g,r).split(`

`).map(n=>n.trim()===r?r:`<p style="margin: 16px 0; line-height: 1.6;">${n.replace(/\n/g,"<br>")}</p>`).join("").replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/👉/g,"→");const o=tv(t);return s.replace(new RegExp(r,"g"),o)}async function rv(e,t,r,a){const s=await e.prepare(`
    SELECT * FROM astar_weekly_metrics 
    WHERE user_id = ? AND week_number = ? AND year = ?
  `).bind(t,r,a).first();if(!s)return 0;const o=s.users_contacted*10+s.hypotheses_tested*20+s.learnings_count*15,n=.5+s.response_rate*1;return Math.round(o*n)}async function Fd(e,t,r){let a="",s="",o="https://astarlabshub.com/marketplace?tab=traction";switch(r.day_of_week){case 1:r.time_of_day==="evening"&&(a="💡 Time to define your hypothesis",s="What is your #1 hypothesis for this week? Share your expected user behavior and validation signal.",o+="&chat=hipotesis");break;case 2:r.time_of_day==="evening"&&(a="🛠️ Share your build progress",s="What did you build today? Include tech stack, time spent, and which hypothesis it tests.",o+="&chat=construccion");break;case 3:r.time_of_day==="evening"&&(a="💬 Report your user conversations",s="How many users did you speak with? How many used the product? What was your key learning?",o+="&chat=usuarios");break;case 4:r.time_of_day==="evening"&&(a="📊 Share your user behavior insights",s="What actions did users repeat? Where did they drop off? What insight does this reveal?",o+="&chat=metricas");break;case 5:r.time_of_day==="evening"&&(a="📈 Report your weekly traction metrics",s="Share revenue, new users, active users, churn, and your strongest traction signal.",o+="&chat=traction");break;case 6:r.time_of_day==="evening"&&(a="🧘 Optional weekend reflection",s="Any final thoughts from the week? Feel free to skip and rest!",o+="&chat=reflexion");break;case 0:r.time_of_day==="evening"&&(a="🏁 Weekly Leaderboard is live!",s="Check out how everyone performed this week and your position in the leaderboard.",o+="&chat=reflexion");break}if(a&&s)try{await e.prepare(`
        INSERT INTO notifications (user_id, type, title, message, link)
        VALUES (?, ?, ?, ?, ?)
      `).bind(t,"astar_weekly_update",a,s,o).run()}catch(n){console.error("Error creating notification:",n)}}Se.post("/cron/send-daily",async e=>{try{const t=e.req.header("X-Cron-Secret"),r=e.env.CRON_SECRET;if(r&&r!=="CONFIGURE_IN_CLOUDFLARE_DASHBOARD"&&t!==r)return e.json({error:"Unauthorized - Invalid cron secret"},401);const a=new Date,s=a.getDay(),n=a.getHours()<12?"morning":"evening",i=ut(a),l=a.getFullYear(),d=await e.env.DB.prepare(`
      SELECT * FROM astar_message_templates 
      WHERE day_of_week = ? AND time_of_day = ?
    `).bind(s,n).first();if(!d)return e.json({message:"No template for this time",sent:0});const c=await e.env.DB.prepare(`
      SELECT u.id, u.email, u.name 
      FROM users u
      WHERE u.email IN ('aihelpstudy@gmail.com', 'giorgio.rodrigano@gmail.com')
        AND (u.email_unsubscribed IS NULL OR u.email_unsubscribed = 0)
    `).all();let u=0,p=0;const m=[];for(const g of c.results||[]){if(await e.env.DB.prepare(`
        SELECT 1 FROM astar_sent_messages 
        WHERE user_id = ? AND template_id = ? AND week_number = ? AND year = ?
      `).bind(g.id,d.id,i,l).first())continue;const v=os();await e.env.DB.prepare(`
        INSERT INTO email_unsubscribe_tokens (user_id, token)
        VALUES (?, ?)
      `).bind(g.id,v).run();const y=`https://astarlabshub.com/api/astar-messages/unsubscribe/${v}`,f={name:g.name||"Founder"};if(s===3&&n==="evening"){const I=await e.env.DB.prepare(`
          SELECT users_contacted FROM astar_weekly_metrics 
          WHERE user_id = ? AND week_number = ? AND year = ?
        `).bind(g.id,i-1,l).first();I&&(f.last_week_users=I.users_contacted,f.target_users=Math.ceil(I.users_contacted*1.1))}if(s===0&&n==="evening"){const I=await e.env.DB.prepare(`
          SELECT 
            u.name, u.email,
            m.users_contacted, m.iteration_score as score
          FROM astar_weekly_metrics m
          JOIN users u ON m.user_id = u.id
          WHERE m.week_number = ? AND m.year = ?
          ORDER BY m.iteration_score DESC
          LIMIT 3
        `).bind(i,l).all();if(I.results&&I.results.length>0){const F=I.results;f.rankings=!0,f.first_place=F[0]||{name:"-",users:0,score:0},f.second_place=F[1]||{name:"-",users:0,score:0},f.third_place=F[2]||{name:"-",users:0,score:0}}const M=await e.env.DB.prepare(`
          SELECT 
            (SELECT COUNT(*) + 1 FROM astar_weekly_metrics m2 
             WHERE m2.week_number = ? AND m2.year = ? 
             AND m2.iteration_score > m.iteration_score) as rank,
            m.users_contacted as total_users,
            m.iteration_score as score
          FROM astar_weekly_metrics m
          WHERE m.user_id = ? AND m.week_number = ? AND m.year = ?
        `).bind(i,l,g.id,i,l).first();M&&(f.user_rank=M.rank,f.user_total_users=M.total_users,f.user_score=M.score)}const x=ls(d.body_template,f),C=ds(x,d.category)+ns(y),A=await is(e.env.RESEND_API_KEY,g.email,d.subject,C);A.success?(await e.env.DB.prepare(`
          INSERT INTO astar_sent_messages (user_id, template_id, week_number, year, email_id)
          VALUES (?, ?, ?, ?, ?)
        `).bind(g.id,d.id,i,l,A.emailId||null).run(),d.expects_response===1&&await Fd(e.env.DB,g.id,d),u++):m.push(`User ${g.id}: ${A.error}`)}return e.json({success:!0,template:d.subject,sent:u,errors:m.length>0?m:void 0})}catch(t){return console.error("Error in cron send-daily:",t),e.json({error:"Failed to send daily messages"},500)}});Se.get("/cron/test-email",async e=>{try{const t=new Date,r=e.req.query("email")||"aihelpstudy@gmail.com",a=parseInt(e.req.query("day")||"1"),s=e.req.query("time")||"morning",o=await e.env.DB.prepare(`
      SELECT * FROM astar_message_templates 
      WHERE day_of_week = ? AND time_of_day = ?
      LIMIT 1
    `).bind(a,s).first();if(!o)return e.json({error:"No template found for specified day/time",day:a,time:s},404);let n=await e.env.DB.prepare(`
      SELECT u.id, u.email, u.name 
      FROM users u
      WHERE u.email = ?
    `).bind(r).first();if(!n&&(await e.env.DB.prepare(`
        INSERT INTO users (email, name, created_at)
        VALUES (?, ?, CURRENT_TIMESTAMP)
      `).bind(r,"Test User").run(),n=await e.env.DB.prepare(`
        SELECT u.id, u.email, u.name 
        FROM users u
        WHERE u.email = ?
      `).bind(r).first(),!n))return e.json({error:"Failed to create test user"},500);const i=os();await e.env.DB.prepare(`
      INSERT INTO email_unsubscribe_tokens (user_id, token)
      VALUES (?, ?)
    `).bind(n.id,i).run();const l=`https://astarlabshub.com/api/astar-messages/unsubscribe/${i}`,d=ls(o.body_template,{name:n.name||"Founder",dashboard_link:"{{dashboard_link}}"}),c=`
      <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9fafb;">
        <div style="background-color: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h2 style="color: #1f2937; margin-bottom: 24px;">${o.subject}</h2>
          ${ds(d,o.category)}
        </div>
        ${ns(l)}
        <p style="text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px;">
          ASTAR Labs - Ayudando founders a iterar más rápido
        </p>
      </div>
    `,u=await is(e.env.RESEND_API_KEY,n.email,`[TEST] ${o.subject}`,c);if(u.success){const p=ut(t),m=t.getFullYear();return await e.env.DB.prepare(`
        DELETE FROM astar_user_responses 
        WHERE sent_message_id IN (
          SELECT id FROM astar_sent_messages 
          WHERE user_id = ? AND template_id = ? AND week_number = ? AND year = ?
        )
      `).bind(n.id,o.id,p,m).run(),await e.env.DB.prepare(`
        DELETE FROM astar_sent_messages 
        WHERE user_id = ? AND template_id = ? AND week_number = ? AND year = ?
      `).bind(n.id,o.id,p,m).run(),await e.env.DB.prepare(`
        INSERT INTO astar_sent_messages (user_id, template_id, week_number, year, sent_at, email_id)
        VALUES (?, ?, ?, ?, datetime('now'), ?)
      `).bind(n.id,o.id,p,m,u.emailId).run(),e.json({success:!0,message:"Test email sent successfully",template:o.subject,emailId:u.emailId,savedToDb:!0,user:n.email,category:o.category,expects_response:o.expects_response===1})}else return e.json({error:u.error||"Unknown error",template:o.subject,user:n.email,resend_api_key_configured:!!e.env.RESEND_API_KEY},500)}catch(t){return console.error("Error in test-email:",t),e.json({error:"Failed to send test email",details:t.message||String(t),stack:t.stack},500)}});Se.post("/cron/send-all-week/:email",async e=>{try{const t=e.req.param("email"),r=new Date,a=ut(r),s=r.getFullYear(),o=await e.env.DB.prepare(`
      SELECT id, email, name FROM users WHERE email = ?
    `).bind(t).first();if(!o)return e.json({error:"User not found",email:t},404);const n=await e.env.DB.prepare(`
      SELECT * FROM astar_message_templates ORDER BY day_of_week, time_of_day
    `).all();if(!n.results||n.results.length===0)return e.json({error:"No templates found"},404);const i=os();await e.env.DB.prepare(`
      INSERT INTO email_unsubscribe_tokens (user_id, token)
      VALUES (?, ?)
    `).bind(o.id,i).run();const l=`https://astarlabshub.com/api/astar-messages/unsubscribe/${i}`,d=[],c=[];for(const u of n.results){const p={name:o.name||"Founder",dashboard_link:"{{dashboard_link}}"},m=ls(u.body_template,p),g=`
        <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9fafb;">
          <div style="background-color: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="color: #1f2937; margin-bottom: 24px;">${u.subject}</h2>
            ${ds(m,u.category)}
          </div>
          ${ns(l)}
          <p style="text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px;">
            ASTAR Labs - Ayudando founders a iterar más rápido
          </p>
        </div>
      `,b=await is(e.env.RESEND_API_KEY,o.email,u.subject,g);b.success?(await e.env.DB.prepare(`
          DELETE FROM astar_user_responses 
          WHERE sent_message_id IN (
            SELECT id FROM astar_sent_messages 
            WHERE user_id = ? AND template_id = ? AND week_number = ? AND year = ?
          )
        `).bind(o.id,u.id,a,s).run(),await e.env.DB.prepare(`
          DELETE FROM astar_sent_messages 
          WHERE user_id = ? AND template_id = ? AND week_number = ? AND year = ?
        `).bind(o.id,u.id,a,s).run(),await e.env.DB.prepare(`
          INSERT INTO astar_sent_messages (user_id, template_id, week_number, year, sent_at, email_id)
          VALUES (?, ?, ?, ?, datetime('now'), ?)
        `).bind(o.id,u.id,a,s,b.emailId).run(),d.push({day:u.day_of_week,time:u.time_of_day,subject:u.subject,emailId:b.emailId,success:!0})):(c.push(`${u.subject}: ${b.error}`),d.push({day:u.day_of_week,time:u.time_of_day,subject:u.subject,error:b.error,success:!1})),await new Promise(v=>setTimeout(v,500))}return e.json({success:!0,user:o.email,totalTemplates:n.results.length,sent:d.filter(u=>u.success).length,failed:d.filter(u=>!u.success).length,results:d,errors:c.length>0?c:void 0})}catch(t){return console.error("Error sending all week emails:",t),e.json({error:"Failed to send week emails",details:t.message||String(t)},500)}});Se.use("/*",async(e,t)=>{const r=e.req.url;return r.includes("cron/send-daily")||r.includes("cron/test-email")||r.includes("cron/send-all-week")||r.includes("cron/send-by-day")||r.includes("debug/")||r.includes("unsubscribe/")?t():ev(e,t)});Se.get("/unsubscribe/:token",async e=>{try{const t=e.req.param("token"),r=await e.env.DB.prepare(`
      SELECT ut.*, u.email, u.name 
      FROM email_unsubscribe_tokens ut
      JOIN users u ON ut.user_id = u.id
      WHERE ut.token = ? AND ut.used_at IS NULL
    `).bind(t).first();return r?(await e.env.DB.prepare(`
      UPDATE users SET email_unsubscribed = 1 WHERE id = ?
    `).bind(r.user_id).run(),await e.env.DB.prepare(`
      UPDATE email_unsubscribe_tokens SET used_at = datetime('now') WHERE id = ?
    `).bind(r.id).run(),e.html(`
      <!DOCTYPE html>
      <html lang="es">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Suscripción cancelada - ASTAR</title>
        <style>
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
          .card { background: white; padding: 48px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); text-align: center; max-width: 450px; }
          h1 { color: #1f2937; margin-bottom: 16px; }
          .checkmark { font-size: 64px; margin-bottom: 16px; }
          p { color: #6b7280; line-height: 1.6; margin: 8px 0; }
          .email { color: #667eea; font-weight: 600; }
          .resubscribe { margin-top: 32px; padding-top: 24px; border-top: 1px solid #e5e7eb; }
          .btn { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; margin-top: 16px; }
          .btn:hover { opacity: 0.9; }
        </style>
      </head>
      <body>
        <div class="card">
          <div class="checkmark">✅</div>
          <h1>Suscripción cancelada</h1>
          <p>Ya no recibirás más emails semanales de ASTAR en:</p>
          <p class="email">${r.email}</p>
          <p style="margin-top: 16px; font-size: 14px;">Lamentamos verte ir. ¡Esperamos que tu startup siga creciendo! 🚀</p>
          <div class="resubscribe">
            <p style="font-size: 14px;">¿Cambiaste de opinión?</p>
            <a href="https://astarlabshub.com/api/astar-messages/resubscribe/${t}" class="btn">
              Volver a suscribirme
            </a>
          </div>
        </div>
      </body>
      </html>
    `)):e.html(`
        <!DOCTYPE html>
        <html lang="es">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Error - ASTAR</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
            .card { background: white; padding: 48px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; max-width: 400px; }
            h1 { color: #ef4444; margin-bottom: 16px; }
            p { color: #6b7280; line-height: 1.6; }
            a { color: #667eea; text-decoration: none; }
          </style>
        </head>
        <body>
          <div class="card">
            <h1>❌ Link inválido</h1>
            <p>Este link de cancelación de suscripción no es válido o ya fue usado.</p>
            <p style="margin-top: 24px;"><a href="https://astarlabshub.com">Volver a ASTAR</a></p>
          </div>
        </body>
        </html>
      `)}catch(t){return console.error("Error processing unsubscribe:",t),e.html(`
      <!DOCTYPE html>
      <html lang="es">
      <head>
        <meta charset="UTF-8">
        <title>Error - ASTAR</title>
        <style>
          body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
          .card { background: white; padding: 48px; border-radius: 16px; text-align: center; }
          h1 { color: #ef4444; }
        </style>
      </head>
      <body>
        <div class="card">
          <h1>❌ Error</h1>
          <p>Ocurrió un error al procesar tu solicitud. Por favor intenta de nuevo.</p>
        </div>
      </body>
      </html>
    `)}});Se.get("/resubscribe/:token",async e=>{try{const t=e.req.param("token"),r=await e.env.DB.prepare(`
      SELECT ut.*, u.email, u.name 
      FROM email_unsubscribe_tokens ut
      JOIN users u ON ut.user_id = u.id
      WHERE ut.token = ?
    `).bind(t).first();return r?(await e.env.DB.prepare(`
      UPDATE users SET email_unsubscribed = 0 WHERE id = ?
    `).bind(r.user_id).run(),e.html(`
      <!DOCTYPE html>
      <html lang="es">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>¡Bienvenido de vuelta! - ASTAR</title>
        <style>
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
          .card { background: white; padding: 48px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); text-align: center; max-width: 450px; }
          h1 { color: #1f2937; margin-bottom: 16px; }
          .emoji { font-size: 64px; margin-bottom: 16px; }
          p { color: #6b7280; line-height: 1.6; }
          .email { color: #667eea; font-weight: 600; }
          .btn { display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; margin-top: 24px; }
        </style>
      </head>
      <body>
        <div class="card">
          <div class="emoji">🎉</div>
          <h1>¡Bienvenido de vuelta!</h1>
          <p>Has vuelto a suscribirte a los emails semanales de ASTAR.</p>
          <p class="email">${r.email}</p>
          <p style="margin-top: 16px;">Recibirás tips y recordatorios para hacer crecer tu startup cada semana.</p>
          <a href="https://astarlabshub.com/marketplace?tab=traction" class="btn">
            Ir al Dashboard
          </a>
        </div>
      </body>
      </html>
    `)):e.html(`
        <!DOCTYPE html>
        <html lang="es">
        <head>
          <meta charset="UTF-8">
          <title>Error - ASTAR</title>
          <style>
            body { font-family: 'Segoe UI', sans-serif; background: #f3f4f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
            .card { background: white; padding: 48px; border-radius: 16px; text-align: center; }
            h1 { color: #ef4444; }
          </style>
        </head>
        <body>
          <div class="card">
            <h1>❌ Link inválido</h1>
            <p>Este link no es válido.</p>
          </div>
        </body>
        </html>
      `)}catch(t){return console.error("Error processing resubscribe:",t),e.json({error:"Failed to resubscribe"},500)}});Se.get("/debug/pending/:email",async e=>{try{const t=e.req.param("email"),r=new Date,a=ut(r),s=r.getFullYear(),o=await e.env.DB.prepare(`
      SELECT id, email, name FROM users WHERE email = ?
    `).bind(t).first();if(!o)return e.json({error:"User not found",email:t});const n=await e.env.DB.prepare(`
      SELECT 
        sm.id as sent_message_id,
        sm.sent_at,
        sm.week_number,
        sm.year,
        t.subject,
        t.response_prompt,
        t.category,
        t.expects_response,
        r.id as response_id
      FROM astar_sent_messages sm
      JOIN astar_message_templates t ON sm.template_id = t.id
      LEFT JOIN astar_user_responses r ON sm.id = r.sent_message_id
      WHERE sm.user_id = ?
      ORDER BY sm.sent_at DESC
      LIMIT 10
    `).bind(o.id).all(),i=(n.results||[]).filter(l=>l.expects_response===1&&l.response_id===null&&l.week_number===a&&l.year===s);return e.json({user:o,currentWeek:a,currentYear:s,allMessages:n.results||[],pendingMessages:i,debug:{serverTime:r.toISOString(),weekCalculation:`Week ${a} of ${s}`}})}catch(t){return console.error("Debug error:",t),e.json({error:"Debug failed",details:String(t)},500)}});Se.get("/pending",async e=>{try{const t=e.get("userId"),r=new Date,a=ut(r),s=r.getFullYear(),o=await e.env.DB.prepare(`
      SELECT 
        sm.id as sent_message_id,
        sm.sent_at,
        t.subject,
        t.response_prompt,
        t.category
      FROM astar_sent_messages sm
      JOIN astar_message_templates t ON sm.template_id = t.id
      LEFT JOIN astar_user_responses r ON sm.id = r.sent_message_id
      WHERE sm.user_id = ? 
        AND sm.week_number = ? 
        AND sm.year = ?
        AND t.expects_response = 1
        AND r.id IS NULL
      ORDER BY sm.sent_at DESC
    `).bind(t,a,s).all();return e.json({pending:o.results||[]})}catch(t){return console.error("Error getting pending messages:",t),e.json({error:"Failed to get pending messages"},500)}});Se.post("/respond",async e=>{try{const t=e.get("userId"),r=await e.req.json(),{sent_message_id:a,response_text:s}=r;if(!a||!(s!=null&&s.trim()))return e.json({error:"Missing required fields"},400);const o=await e.env.DB.prepare(`
      SELECT sm.id, sm.user_id, sm.template_id, sm.week_number, sm.year, 
             t.category, t.response_prompt
      FROM astar_sent_messages sm
      JOIN astar_message_templates t ON sm.template_id = t.id
      WHERE sm.id = ? AND sm.user_id = ?
    `).bind(a,t).first();if(!o)return e.json({error:"Message not found"},404);const n=await e.env.DB.prepare(`
      INSERT INTO astar_user_responses (
        user_id, sent_message_id, response_text, response_type, 
        extracted_data, created_goal_id
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).bind(t,a,s,o.category,"{}",null).run();return e.json({success:!0,response_id:n.meta.last_row_id,category:o.category,response_text:s,response_prompt:o.response_prompt,redirect_to_chat:!0})}catch(t){return console.error("Error saving response:",t),e.json({error:"Failed to save response",details:String(t)},500)}});Se.get("/my-metrics",async e=>{try{const t=e.get("userId"),r=new Date,a=ut(r),s=r.getFullYear(),o=await e.env.DB.prepare(`
      SELECT * FROM astar_weekly_metrics 
      WHERE user_id = ? AND week_number = ? AND year = ?
    `).bind(t,a,s).first(),n=await e.env.DB.prepare(`
      SELECT * FROM astar_weekly_metrics 
      WHERE user_id = ?
      ORDER BY year DESC, week_number DESC
      LIMIT 4
    `).bind(t).all();return e.json({current:o||{users_contacted:0,hypotheses_tested:0,learnings_count:0,response_rate:0,iteration_score:0},history:n.results||[]})}catch(t){return console.error("Error getting metrics:",t),e.json({error:"Failed to get metrics"},500)}});Se.get("/ranking",async e=>{try{const t=new Date,r=parseInt(e.req.query("week")||String(ut(t))),a=parseInt(e.req.query("year")||String(t.getFullYear())),s=e.get("userId"),o=await e.env.DB.prepare(`
      SELECT 
        m.user_id,
        u.name,
        u.email,
        m.users_contacted,
        m.hypotheses_tested,
        m.learnings_count,
        m.response_rate,
        m.iteration_score,
        RANK() OVER (ORDER BY m.iteration_score DESC) as rank
      FROM astar_weekly_metrics m
      JOIN users u ON m.user_id = u.id
      WHERE m.week_number = ? AND m.year = ?
      ORDER BY m.iteration_score DESC
      LIMIT 20
    `).bind(r,a).all(),n=await e.env.DB.prepare(`
      SELECT 
        (SELECT COUNT(*) + 1 FROM astar_weekly_metrics m2 
         WHERE m2.week_number = ? AND m2.year = ? 
         AND m2.iteration_score > m.iteration_score) as rank,
        m.*
      FROM astar_weekly_metrics m
      WHERE m.user_id = ? AND m.week_number = ? AND m.year = ?
    `).bind(r,a,s,r,a).first();return e.json({week_number:r,year:a,rankings:o.results||[],my_position:n})}catch(t){return console.error("Error getting ranking:",t),e.json({error:"Failed to get ranking"},500)}});Se.get("/history",async e=>{try{const t=e.get("userId"),r=parseInt(e.req.query("limit")||"20"),a=await e.env.DB.prepare(`
      SELECT 
        sm.id as message_id,
        sm.sent_at,
        sm.week_number,
        t.subject,
        t.category,
        t.response_prompt,
        r.response_text,
        r.response_type,
        r.extracted_data,
        r.created_at as responded_at
      FROM astar_sent_messages sm
      JOIN astar_message_templates t ON sm.template_id = t.id
      LEFT JOIN astar_user_responses r ON sm.id = r.sent_message_id
      WHERE sm.user_id = ?
      ORDER BY sm.sent_at DESC
      LIMIT ?
    `).bind(t,r).all();return e.json({history:a.results||[]})}catch(t){return console.error("Error getting history:",t),e.json({error:"Failed to get history"},500)}});Se.post("/update-metrics",async e=>{try{const t=e.get("userId"),r=await e.req.json(),a=new Date,s=ut(a),o=a.getFullYear();await e.env.DB.prepare(`
      INSERT INTO astar_weekly_metrics (user_id, week_number, year, users_contacted, hypotheses_tested, learnings_count)
      VALUES (?, ?, ?, ?, ?, ?)
      ON CONFLICT(user_id, week_number, year) DO UPDATE SET
        users_contacted = COALESCE(?, users_contacted),
        hypotheses_tested = COALESCE(?, hypotheses_tested),
        learnings_count = COALESCE(?, learnings_count),
        updated_at = CURRENT_TIMESTAMP
    `).bind(t,s,o,r.users_contacted||0,r.hypotheses_tested||0,r.learnings_count||0,r.users_contacted,r.hypotheses_tested,r.learnings_count).run();const n=await rv(e.env.DB,t,s,o);return await e.env.DB.prepare(`
      UPDATE astar_weekly_metrics SET iteration_score = ?
      WHERE user_id = ? AND week_number = ? AND year = ?
    `).bind(n,t,s,o).run(),e.json({success:!0,new_score:n})}catch(t){return console.error("Error updating metrics:",t),e.json({error:"Failed to update metrics"},500)}});Se.post("/cron/send-by-day/:dayOfWeek",async e=>{try{const t=e.req.param("dayOfWeek"),a={lunes:1,monday:1,martes:2,tuesday:2,miercoles:3,wednesday:3,jueves:4,thursday:4,viernes:5,friday:5,sabado:6,saturday:6,domingo:0,sunday:0}[t.toLowerCase()];if(a===void 0)return e.json({error:"Invalid day. Use: lunes, martes, miercoles, jueves, viernes, sabado, domingo (or English equivalents)",provided:t},400);const s=new Date,o=ut(s),n=s.getFullYear();let i=await e.env.DB.prepare(`
      SELECT id, email, name FROM users WHERE email = 'aihelpstudy@gmail.com'
    `).first();if(!i&&(await e.env.DB.prepare(`
        INSERT INTO users (email, name, created_at)
        VALUES (?, ?, CURRENT_TIMESTAMP)
      `).bind("aihelpstudy@gmail.com","Test User").run(),i=await e.env.DB.prepare(`
        SELECT id, email, name FROM users WHERE email = 'aihelpstudy@gmail.com'
      `).first(),!i))return e.json({error:"Failed to create test user"},500);const l=await e.env.DB.prepare(`
      SELECT * FROM astar_message_templates 
      WHERE day_of_week = ?
      ORDER BY time_of_day
    `).bind(a).all();if(!l.results||l.results.length===0)return e.json({error:"No templates found for this day",dayOfWeek:a,dayName:t},404);const d=os();await e.env.DB.prepare(`
      INSERT INTO email_unsubscribe_tokens (user_id, token)
      VALUES (?, ?)
    `).bind(i.id,d).run();const c=`https://astarlabshub.com/api/astar-messages/unsubscribe/${d}`,u=[],p=[];for(const m of l.results){const g={name:i.name||"Founder",dashboard_link:"{{dashboard_link}}"};a===0&&m.time_of_day==="evening"&&(g.rankings=!0,g.first_place={name:"Ana García",users:15,score:85},g.second_place={name:"Carlos López",users:12,score:72},g.third_place={name:"María Torres",users:10,score:68},g.user_rank=5,g.user_total_users=8,g.user_score=55);const b=ls(m.body_template,g),v=`
        <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9fafb;">
          <div style="background-color: white; padding: 32px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h2 style="color: #1f2937; margin-bottom: 24px;">${m.subject}</h2>
            ${ds(b,m.category)}
          </div>
          ${ns(c)}
          <p style="text-align: center; color: #6b7280; font-size: 12px; margin-top: 20px;">
            ASTAR Labs - Ayudando founders a iterar más rápido
          </p>
        </div>
      `,y=await is(e.env.RESEND_API_KEY,i.email,`[${t.toUpperCase()}] ${m.subject}`,v);y.success?(await e.env.DB.prepare(`
          DELETE FROM astar_user_responses 
          WHERE sent_message_id IN (
            SELECT id FROM astar_sent_messages 
            WHERE user_id = ? AND template_id = ? AND week_number = ? AND year = ?
          )
        `).bind(i.id,m.id,o,n).run(),await e.env.DB.prepare(`
          DELETE FROM astar_sent_messages 
          WHERE user_id = ? AND template_id = ? AND week_number = ? AND year = ?
        `).bind(i.id,m.id,o,n).run(),await e.env.DB.prepare(`
          INSERT INTO astar_sent_messages (user_id, template_id, week_number, year, sent_at, email_id)
          VALUES (?, ?, ?, ?, datetime('now'), ?)
        `).bind(i.id,m.id,o,n,y.emailId).run(),m.expects_response===1&&await Fd(e.env.DB,i.id,m),u.push({time:m.time_of_day,subject:m.subject,category:m.category,emailId:y.emailId,success:!0})):(p.push(`${m.subject}: ${y.error}`),u.push({time:m.time_of_day,subject:m.subject,category:m.category,error:y.error,success:!1})),await new Promise(f=>setTimeout(f,500))}return e.json({success:!0,user:i.email,dayOfWeek:t,totalTemplates:l.results.length,sent:u.filter(m=>m.success).length,failed:u.filter(m=>!m.success).length,results:u,errors:p.length>0?p:void 0})}catch(t){return console.error("Error sending day emails:",t),e.json({error:"Failed to send day emails",details:t.message||String(t)},500)}});const Wt=new ee,av="your-secret-key-change-in-production-use-env-var";async function Er(e,t){var a,s;const r=(s=(a=e.req.header("cookie"))==null?void 0:a.split("; ").find(o=>o.startsWith("authToken=")))==null?void 0:s.split("=")[1];if(!r)return e.json({error:"Not authenticated"},401);try{const o=await te(r,e.env.JWT_SECRET||av);e.set("user",{userId:o.userId||o.id,email:o.email}),await t()}catch{return e.json({error:"Invalid token"},401)}}Wt.get("/my-team",Er,async e=>{const t=e.get("user");try{const r=await e.env.DB.prepare(`
      SELECT 
        st.id,
        st.name,
        st.creator_user_id,
        st.created_at,
        (SELECT COUNT(*) FROM startup_team_members WHERE team_id = st.id) as member_count
      FROM startup_teams st
      INNER JOIN startup_team_members stm ON st.id = stm.team_id
      WHERE stm.user_id = ?
      ORDER BY stm.is_creator DESC, stm.joined_at ASC
      LIMIT 1
    `).bind(t.userId).first();if(!r)return e.json({success:!1,error:"No team found"},404);const a=await e.env.DB.prepare(`
      SELECT 
        stm.id,
        stm.user_id,
        stm.role,
        stm.is_creator,
        stm.joined_at,
        u.name,
        u.email,
        u.avatar_url
      FROM startup_team_members stm
      LEFT JOIN users u ON stm.user_id = u.id
      WHERE stm.team_id = ?
      ORDER BY stm.is_creator DESC, stm.joined_at ASC
    `).bind(r.id).all();return e.json({success:!0,team:{...r,members:a.results||[]}})}catch(r){return console.error("[TEAM] Error fetching team:",r),e.json({success:!1,error:"Failed to fetch team"},500)}});Wt.post("/add-founder",Er,async e=>{const t=e.get("user");try{const{email:r,role:a}=await e.req.json();if(!r)return e.json({success:!1,error:"Email is required"},400);const s=await e.env.DB.prepare(`
      SELECT stm.team_id, stm.is_creator
      FROM startup_team_members stm
      WHERE stm.user_id = ?
      ORDER BY stm.is_creator DESC
      LIMIT 1
    `).bind(t.userId).first();if(!s)return e.json({success:!1,error:"You are not part of any team"},404);if(!s.is_creator)return e.json({success:!1,error:"Only the team creator can add founders"},403);const o=await e.env.DB.prepare(`
      SELECT id, name, email, avatar_url
      FROM users
      WHERE email = ?
    `).bind(r.toLowerCase()).first();if(!o){const d=await e.env.DB.prepare(`
        INSERT INTO team_invitations (team_id, email, role, invited_by_user_id, status)
        VALUES (?, ?, ?, ?, 'pending')
      `).bind(s.team_id,r.toLowerCase(),a||"Co-founder",t.userId).run();return d.success?e.json({success:!0,message:"Invitation sent! When this user registers, they will automatically join your team as a founder.",isPending:!0,invitation:{id:d.meta.last_row_id,email:r.toLowerCase(),role:a||"Co-founder",status:"pending"}}):e.json({success:!1,error:"Failed to create invitation"},500)}if(await e.env.DB.prepare(`
      SELECT id FROM startup_team_members
      WHERE team_id = ? AND user_id = ?
    `).bind(s.team_id,o.id).first())return e.json({success:!1,error:"User is already a team member"},400);const i=await e.env.DB.prepare(`
      SELECT stm.team_id, st.name as team_name
      FROM startup_team_members stm
      LEFT JOIN startup_teams st ON stm.team_id = st.id
      WHERE stm.user_id = ?
    `).bind(o.id).first();if(i&&i.team_id!==s.team_id){if(await e.env.DB.prepare(`
        SELECT id FROM team_invitations
        WHERE email = ? AND team_id = ? AND status = 'pending'
      `).bind(r.toLowerCase(),s.team_id).first())return e.json({success:!1,error:"An invitation is already pending for this user"},400);const c=await e.env.DB.prepare(`
        INSERT INTO team_invitations (
          team_id, email, role, invited_by_user_id, status, 
          invitation_type, current_team_id
        )
        VALUES (?, ?, ?, ?, 'pending', 'transfer', ?)
      `).bind(s.team_id,r.toLowerCase(),a||"Co-founder",t.userId,i.team_id).run();return c.success?e.json({success:!0,message:`Invitation sent to ${o.name||o.email}. They are currently in "${i.team_name}" and must accept to join your team.`,isPending:!0,requiresAcceptance:!0,invitation:{id:c.meta.last_row_id,email:r.toLowerCase(),role:a||"Co-founder",status:"pending",type:"transfer",currentTeam:i.team_name}}):e.json({success:!1,error:"Failed to create invitation"},500)}const l=await e.env.DB.prepare(`
      INSERT INTO startup_team_members (team_id, user_id, role, is_creator)
      VALUES (?, ?, ?, 0)
    `).bind(s.team_id,o.id,a||"Co-founder").run();return l.success?(await e.env.DB.prepare(`
      UPDATE users
      SET role = 'founder'
      WHERE id = ? AND role != 'founder'
    `).bind(o.id).run(),e.json({success:!0,message:"Founder added successfully",member:{id:l.meta.last_row_id,user_id:o.id,name:o.name,email:o.email,avatar_url:o.avatar_url,role:a||"Co-founder",is_creator:0}})):e.json({success:!1,error:"Failed to add founder"},500)}catch(r){return console.error("[TEAM] Error adding founder:",r),e.json({success:!1,error:"Failed to add founder"},500)}});Wt.delete("/remove-founder/:memberId",Er,async e=>{const t=e.get("user"),r=parseInt(e.req.param("memberId"));try{const a=await e.env.DB.prepare(`
      SELECT stm.team_id, stm.is_creator
      FROM startup_team_members stm
      WHERE stm.user_id = ?
      ORDER BY stm.is_creator DESC
      LIMIT 1
    `).bind(t.userId).first();if(!a)return e.json({success:!1,error:"You are not part of any team"},404);if(!a.is_creator)return e.json({success:!1,error:"Only the team creator can remove founders"},403);const s=await e.env.DB.prepare(`
      SELECT id, user_id, is_creator
      FROM startup_team_members
      WHERE id = ? AND team_id = ?
    `).bind(r,a.team_id).first();return s?s.is_creator?e.json({success:!1,error:"Cannot remove the team creator"},400):(await e.env.DB.prepare(`
      DELETE FROM startup_team_members
      WHERE id = ? AND team_id = ?
    `).bind(r,a.team_id).run()).success?e.json({success:!0,message:"Founder removed successfully"}):e.json({success:!1,error:"Failed to remove founder"},500):e.json({success:!1,error:"Member not found"},404)}catch(a){return console.error("[TEAM] Error removing founder:",a),e.json({success:!1,error:"Failed to remove founder"},500)}});Wt.put("/update-name",Er,async e=>{const t=e.get("user");try{const{name:r}=await e.req.json();if(!r||r.trim().length===0)return e.json({success:!1,error:"Team name is required"},400);const a=await e.env.DB.prepare(`
      SELECT stm.team_id, stm.is_creator
      FROM startup_team_members stm
      WHERE stm.user_id = ?
      ORDER BY stm.is_creator DESC
      LIMIT 1
    `).bind(t.userId).first();return a?a.is_creator?(await e.env.DB.prepare(`
      UPDATE startup_teams
      SET name = ?
      WHERE id = ?
    `).bind(r.trim(),a.team_id).run()).success?e.json({success:!0,message:"Team name updated successfully"}):e.json({success:!1,error:"Failed to update team name"},500):e.json({success:!1,error:"Only the team creator can update the team name"},403):e.json({success:!1,error:"You are not part of any team"},404)}catch(r){return console.error("[TEAM] Error updating team name:",r),e.json({success:!1,error:"Failed to update team name"},500)}});Wt.get("/my-invitations",Er,async e=>{const t=e.get("user");try{const r=await e.env.DB.prepare(`
      SELECT email FROM users WHERE id = ?
    `).bind(t.userId).first();if(!r)return e.json({success:!1,error:"User not found"},404);const a=await e.env.DB.prepare(`
      SELECT 
        ti.id,
        ti.team_id,
        ti.role,
        ti.status,
        ti.invitation_type,
        ti.invited_at,
        st.name as team_name,
        u.name as invited_by_name,
        u.email as invited_by_email,
        st2.name as current_team_name
      FROM team_invitations ti
      JOIN startup_teams st ON ti.team_id = st.id
      LEFT JOIN users u ON ti.invited_by_user_id = u.id
      LEFT JOIN startup_teams st2 ON ti.current_team_id = st2.id
      WHERE ti.email = ? AND ti.status = 'pending'
      ORDER BY ti.invited_at DESC
    `).bind(r.email).all();return e.json({success:!0,invitations:a.results||[]})}catch(r){return console.error("[TEAM] Error getting invitations:",r),e.json({success:!1,error:"Failed to get invitations"},500)}});Wt.post("/invitations/:id/:action",Er,async e=>{const t=e.get("user"),r=e.req.param("id"),a=e.req.param("action");try{if(a!=="accept"&&a!=="reject")return e.json({success:!1,error:"Invalid action"},400);const s=await e.env.DB.prepare(`
      SELECT email FROM users WHERE id = ?
    `).bind(t.userId).first();if(!s)return e.json({success:!1,error:"User not found"},404);const o=await e.env.DB.prepare(`
      SELECT 
        ti.*,
        st.name as team_name
      FROM team_invitations ti
      JOIN startup_teams st ON ti.team_id = st.id
      WHERE ti.id = ? AND ti.email = ? AND ti.status = 'pending'
    `).bind(r,s.email).first();if(!o)return e.json({success:!1,error:"Invitation not found or already processed"},404);if(a==="reject")return await e.env.DB.prepare(`
        UPDATE team_invitations SET status = 'rejected' WHERE id = ?
      `).bind(r).run(),e.json({success:!0,message:"Invitation rejected"});if(o.invitation_type==="transfer"){await e.env.DB.prepare(`
        DELETE FROM startup_team_members
        WHERE team_id = ? AND user_id = ?
      `).bind(o.current_team_id,t.userId).run(),await e.env.DB.prepare(`
        UPDATE goals SET team_id = ? WHERE user_id = ?
      `).bind(o.team_id,t.userId).run();const n=await e.env.DB.prepare(`
        SELECT COUNT(*) as count FROM startup_team_members WHERE team_id = ?
      `).bind(o.current_team_id).first();n&&n.count===0&&await e.env.DB.prepare(`
          DELETE FROM startup_teams WHERE id = ?
        `).bind(o.current_team_id).run()}return await e.env.DB.prepare(`
      INSERT INTO startup_team_members (team_id, user_id, role, is_creator)
      VALUES (?, ?, ?, 0)
    `).bind(o.team_id,t.userId,o.role).run(),await e.env.DB.prepare(`
      UPDATE users SET role = 'founder' WHERE id = ?
    `).bind(t.userId).run(),await e.env.DB.prepare(`
      UPDATE team_invitations SET status = 'accepted' WHERE id = ?
    `).bind(r).run(),e.json({success:!0,message:`You have joined "${o.team_name}" successfully!`})}catch(s){return console.error("[TEAM] Error processing invitation:",s),e.json({success:!1,error:"Failed to process invitation"},500)}});const wr=new ee,sv="https://proyectolovablemasgowth-production.up.railway.app";async function ov(e,t){var r;try{let a=`
      SELECT 
        id, 
        name, 
        email, 
        role as user_type,
        location as country,
        company as industry,
        plan as stage,
        avatar_url, 
        bio, 
        linkedin_url,
        interests,
        skills,
        looking_for
      FROM users
      WHERE name IS NOT NULL AND name != ''
    `;const s=[];t&&(a+=" AND id != ?",s.push(t)),a+=" LIMIT 100",console.log("Fetching users with query:",a);const o=await e.env.DB.prepare(a).bind(...s).all();console.log("DB returned:",((r=o.results)==null?void 0:r.length)||0,"users");const n=(o.results||[]).map(i=>({id:i.id,name:i.name,full_name:i.name,email:i.email,user_type:i.user_type||"founder",country:i.country||"",industry:i.industry||"",stage:i.stage||"starter",avatar_url:i.avatar_url,bio:i.bio,linkedin_url:i.linkedin_url,interests:i.interests?JSON.parse(i.interests):[],skills:i.skills?JSON.parse(i.skills):[],looking_for:i.looking_for?JSON.parse(i.looking_for):[]}));return console.log("Returning",n.length,"formatted users"),n}catch(a){return console.error("Error getting users for matching:",a),[]}}wr.post("/chat",async e=>{var t,r,a,s;try{const o=await e.req.json(),{message:n,session_id:i}=o;if(!n)return e.json({success:!1,error:"Message is required"},400);const l=((r=(t=e.req.header("cookie"))==null?void 0:t.match(/authToken=([^;]+)/))==null?void 0:r[1])||((a=e.req.header("Authorization"))==null?void 0:a.replace("Bearer ",""));let d=null,c=null;if(l)try{const{verify:m}=await Promise.resolve().then(()=>Ya);d=(await m(l,"your-secret-key-change-in-production-use-env-var")).userId,c=await e.env.DB.prepare(`
          SELECT id, name, email, user_type, country, industry, stage, bio, linkedin_url
          FROM users WHERE id = ?
        `).bind(d).first()}catch(m){console.error("Auth error:",m)}try{const m=await ov(e,d);console.log(`Calling Railway AI Agent with ${m.length} users...`);const g=await fetch(`${sv}/api/connector/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:n,session_id:i||`session_${Date.now()}`,user_id:d,user_profile:c,available_users:m})});if(console.log(`Railway API response status: ${g.status}`),g.ok){const b=await g.json();return console.log(`Railway AI returned ${((s=b.matches)==null?void 0:s.length)||0} matches`),d&&b.matches&&b.matches.length>0&&await yl(e,d,b.matches,n),e.json({...b,source:"railway_ai"})}else{const b=await g.text();console.error("Railway API error:",g.status,b)}}catch(m){console.error("Railway AI Agent error:",m)}console.log("Using local fallback matching...");const u=await nv(e,n,d,c);d&&u.length>0&&await yl(e,d,u,n);const p=dv(n,u,c);return e.json({success:!0,response:p+`

💡 _Nota: Usando matching local (Railway AI no disponible)_`,matches:u,session_id:i||`session_${Date.now()}`,source:"local_fallback"})}catch(o){return console.error("Connector chat error:",o),e.json({success:!1,error:o instanceof Error?o.message:"Unknown error"},500)}});async function nv(e,t,r,a){const s=t.toLowerCase();let o=[],n=[];(s.includes("founder")||s.includes("emprendedor"))&&o.push("founder"),(s.includes("investor")||s.includes("inversor")||s.includes("inversión")||s.includes("funding"))&&o.push("investor"),(s.includes("validator")||s.includes("validador")||s.includes("experto"))&&o.push("validator"),(s.includes("partner")||s.includes("socio")||s.includes("colaborar"))&&o.push("partner"),(s.includes("talent")||s.includes("talento")||s.includes("desarrollador")||s.includes("designer"))&&o.push("talent"),s.includes("scout")&&o.push("scout"),o.length===0&&(o=["founder","investor","validator","partner","talent","scout"]);const i={saas:"SaaS",fintech:"Fintech",healthtech:"Healthcare",health:"Healthcare",ecommerce:"E-commerce","e-commerce":"E-commerce",ai:"AI/ML","artificial intelligence":"AI/ML","machine learning":"AI/ML",edtech:"EdTech",education:"EdTech",marketplace:"Marketplace",mobile:"Mobile",b2b:"B2B",b2c:"B2C"};for(const[c,u]of Object.entries(i))s.includes(c)&&n.push(u);let l=`
    SELECT id, name, user_type, country, industry, stage, avatar_url as avatar, bio, email
    FROM users
    WHERE 1=1
  `;const d=[];r&&(l+=" AND id != ?",d.push(r)),l+=" ORDER BY RANDOM() LIMIT 50";try{console.log("Executing query for matches...");let u=(await e.env.DB.prepare(l).bind(...d).all()).results||[];if(console.log(`Found ${u.length} users from database`),u.length===0)return console.error("No users in database at all!"),[];const p=u.map(m=>{const{score:g,reasons:b}=iv(m,a,{userTypes:o,industries:n},s);return{id:m.id,name:m.name||"Usuario",user_type:m.user_type||"entrepreneur",industry:m.industry,country:m.country,stage:m.stage,avatar:m.avatar,bio:m.bio,score:g,reason:b.length>0?b.join(". ")+".":lv(m,a)}});return p.sort((m,g)=>g.score-m.score),p.slice(0,9)}catch(c){return console.error("Database error finding matches:",c),[]}}function iv(e,t,r,a){var n;let s=.3;const o=[];if(r.userTypes.length>0&&e.user_type&&r.userTypes.includes(e.user_type)){s+=.25;const i={founder:"🚀 Emprendedor",investor:"💰 Inversor",validator:"✅ Validador",partner:"🤝 Partner",talent:"👨‍💻 Talento",scout:"🔍 Scout"};o.push(i[e.user_type]||e.user_type)}if(r.industries.length>0&&e.industry){const i=e.industry.toLowerCase();for(const l of r.industries)if(i.includes(l.toLowerCase())){s+=.2,o.push(`Industria: ${e.industry}`);break}}else t!=null&&t.industry&&e.industry&&(e.industry.toLowerCase().includes(t.industry.toLowerCase())||t.industry.toLowerCase().includes(e.industry.toLowerCase()))&&(s+=.15,o.push(`Misma industria: ${e.industry}`));if(t!=null&&t.country&&e.country&&e.country.toLowerCase()===t.country.toLowerCase()&&(s+=.1,o.push(`📍 ${e.country}`)),t!=null&&t.stage&&e.stage&&e.stage===t.stage&&(s+=.05,o.push(`Stage: ${e.stage}`)),e.bio&&a){const i=e.bio.toLowerCase(),d=a.toLowerCase().split(/\s+/).filter(c=>c.length>3).filter(c=>i.includes(c));d.length>0&&(s+=Math.min(d.length*.05,.15),o.push("Intereses afines"))}return t!=null&&t.user_type&&e.user_type&&(n={founder:["investor","validator","talent","partner"],investor:["founder"],validator:["founder"],talent:["founder","partner"],partner:["founder","talent"],scout:["founder","investor"]}[t.user_type])!=null&&n.includes(e.user_type)&&(s+=.1,o.length===0&&o.push("Conexión complementaria")),s=Math.max(.3,Math.min(1,s)),{score:s,reasons:o}}function lv(e,t){const r=["Miembro activo de ASTAR","Conexión potencial interesante","Perfil relevante para tu red","Oportunidad de colaboración","Expande tu red de contactos"];return e.industry?`Trabaja en ${e.industry}. ${r[0]}`:e.user_type?`${{founder:"Emprendedor",investor:"Inversor",validator:"Validador/Experto",partner:"Partner potencial",talent:"Talento disponible",scout:"Scout"}[e.user_type]||e.user_type}. ${r[Math.floor(Math.random()*r.length)]}`:r[Math.floor(Math.random()*r.length)]}async function yl(e,t,r,a){try{for(const s of r)await e.env.DB.prepare(`
        INSERT OR REPLACE INTO connector_suggestions (user_id, suggested_user_id, score, reason, query, status, created_at)
        VALUES (?, ?, ?, ?, ?, 'pending', datetime('now'))
      `).bind(t,s.id,s.score,s.reason,a).run()}catch(s){console.error("Error saving suggestions:",s)}}function dv(e,t,r){const a=e.toLowerCase();if(t.length===0)return"🔍 Estoy analizando perfiles en nuestra comunidad. De momento no tenemos muchos usuarios activos, pero pronto habrá más. ¡Invita a otros emprendedores a unirse a ASTAR! 🚀";const s={};t.forEach(c=>{const u=c.user_type||"other";s[u]=(s[u]||0)+1});const o={founder:"emprendedor(es)",investor:"inversor(es)",validator:"validador(es)",partner:"partner(s)",talent:"talento(s)",scout:"scout(s)"},n=Object.entries(s).map(([c,u])=>`${u} ${o[c]||c}`).join(", ");let i="🎯 ";a.includes("inversor")||a.includes("investor")?i="💰 ":a.includes("founder")||a.includes("emprendedor")?i="🚀 ":a.includes("validator")||a.includes("validador")?i="✅ ":a.includes("partner")||a.includes("socio")?i="🤝 ":(a.includes("talent")||a.includes("talento"))&&(i="👨‍💻 ");const l=t.reduce((c,u)=>c+(u.score||0),0)/t.length,d=t.slice(0,3).map(c=>c.name).join(", ");return l>.7?`${i}¡Excelentes matches! He analizado los perfiles y encontré ${t.length} conexiones muy relevantes (${n}). Los mejores matches son: ${d}. La IA ha identificado que estos perfiles coinciden muy bien con lo que buscas. ¡Haz clic en "Connect" para iniciar conversación! 🔥`:l>.5?`${i}He analizado ${t.length} perfiles de la comunidad y encontré estas conexiones (${n}). Entre ellos: ${d}. Los he ordenado por relevancia basándome en intereses comunes, industria y objetivos. ¡Explora las opciones! 🤝`:`${i}He analizado todos los perfiles disponibles y aquí tienes ${t.length} miembros de ASTAR (${n}), incluyendo: ${d}. Aunque no todos coinciden exactamente con tu búsqueda, podrían ser conexiones valiosas. ¡Las mejores oportunidades a veces vienen de donde menos esperas! 🌟`}wr.get("/session/:id",async e=>{const t=e.req.param("id");return e.json({success:!0,session_id:t,messages:[]})});wr.delete("/session/:id",async e=>{const t=e.req.param("id");return e.json({success:!0,message:"Session cleared",session_id:t})});wr.get("/ai-suggestions",async e=>{var t,r,a;try{const s=((r=(t=e.req.header("cookie"))==null?void 0:t.match(/authToken=([^;]+)/))==null?void 0:r[1])||((a=e.req.header("Authorization"))==null?void 0:a.replace("Bearer ",""));if(!s)return e.json({success:!1,error:"Authentication required"},401);const{verify:o}=await Promise.resolve().then(()=>Ya),i=(await o(s,"your-secret-key-change-in-production-use-env-var")).userId,l=await e.env.DB.prepare(`
      SELECT id, name, email, user_type, country, industry, stage
      FROM users WHERE id = ?
    `).bind(i).first();if(!l)return e.json({success:!1,error:"User not found"},404);let d=[];return l.user_type==="founder"&&(d=((await e.env.DB.prepare(`
        SELECT id, name, user_type, country, industry, stage, avatar_url as avatar
        FROM users
        WHERE user_type IN ('investor', 'validator')
        AND id != ?
        ${l.industry?"AND (industry LIKE ? OR industry IS NULL)":""}
        LIMIT 6
      `).bind(i,l.industry?`%${l.industry}%`:"").all()).results||[]).map(u=>({id:u.id,name:u.name,user_type:u.user_type,industry:u.industry,country:u.country,stage:u.stage,avatar:u.avatar,score:.7,reason:`Suggested based on your ${l.industry||"startup"} focus`}))),l.user_type==="investor"&&(d=((await e.env.DB.prepare(`
        SELECT id, name, user_type, country, industry, stage, avatar_url as avatar
        FROM users
        WHERE user_type = 'founder'
        AND id != ?
        ${l.industry?"AND industry LIKE ?":""}
        LIMIT 6
      `).bind(i,l.industry?`%${l.industry}%`:"").all()).results||[]).map(u=>({id:u.id,name:u.name,user_type:u.user_type,industry:u.industry,country:u.country,stage:u.stage,avatar:u.avatar,score:.7,reason:`Promising founder in ${u.industry||"your interest area"}`}))),e.json({success:!0,suggestions:d})}catch(s){return console.error("Suggestions error:",s),e.json({success:!1,error:s instanceof Error?s.message:"Unknown error"},500)}});wr.get("/suggestions",async e=>{try{const t=e.req.header("Authorization"),r=t==null?void 0:t.replace("Bearer ","");if(!r)return e.json({success:!1,error:"No token provided"},401);let a=null;try{a=JSON.parse(atob(r.split(".")[1])).userId}catch(n){console.error("Token decode error:",n)}if(!a)return e.json({success:!1,error:"Invalid token"},401);const o=((await e.env.DB.prepare(`
      SELECT 
        cs.id,
        cs.suggested_user_id,
        cs.score,
        cs.reason,
        cs.created_at,
        u.name,
        u.role as user_type,
        u.avatar_url as avatar,
        u.company as industry,
        u.location as country,
        u.bio
      FROM connector_suggestions cs
      JOIN users u ON cs.suggested_user_id = u.id
      WHERE cs.user_id = ?
      AND cs.status = 'pending'
      ORDER BY cs.created_at DESC
    `).bind(a).all()).results||[]).map(n=>({id:n.suggested_user_id,suggestion_id:n.id,suggested_user_id:n.suggested_user_id,name:n.name,user_type:n.user_type||"founder",avatar:n.avatar,industry:n.industry,country:n.country,bio:n.bio,score:n.score,reason:n.reason,created_at:n.created_at}));return e.json({success:!0,suggestions:o})}catch(t){return console.error("Error loading suggestions:",t),e.json({success:!1,error:t instanceof Error?t.message:"Unknown error"},500)}});const Ge=new ee;async function cv(e,t){const r=await e.prepare(`
    SELECT team_id FROM startup_team_members WHERE user_id = ? LIMIT 1
  `).bind(t).first();return r?r.team_id:null}Ge.use("*",vr({origin:e=>e||"*",credentials:!0,allowMethods:["GET","POST","PUT","DELETE","OPTIONS"],allowHeaders:["Content-Type","Authorization","Cookie","X-Requested-With"],exposeHeaders:["Set-Cookie"]}));function uv(e){if(!e.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");return e.JWT_SECRET}const at=async(e,t)=>{var a,s,o,n,i;const r=((a=e.req.header("Authorization"))==null?void 0:a.replace("Bearer ",""))||((o=(s=e.req.header("cookie"))==null?void 0:s.match(/authToken=([^;]+)/))==null?void 0:o[1])||((i=(n=e.req.header("Cookie"))==null?void 0:n.match(/authToken=([^;]+)/))==null?void 0:i[1]);if(!r)return e.json({error:"No authentication token provided"},401);try{const l=await te(r,uv(e.env));e.set("user",l);const d=await cv(e.env.DB,l.userId);e.set("teamId",d),await t()}catch{return e.json({error:"Invalid authentication token"},401)}};Ge.get("/contacts",at,async e=>{const t=e.get("user"),r=e.get("teamId"),a=e.req.query("status"),s=e.req.query("type"),o=e.req.query("source"),n=e.req.query("search"),i=parseInt(e.req.query("limit")||"50"),l=parseInt(e.req.query("offset")||"0");try{const d=r!==null;let c=`
      SELECT 
        c.*,
        u.name as linked_user_name,
        u.avatar_url as linked_user_avatar,
        creator.name as created_by_name,
        (SELECT COUNT(*) FROM crm_activities WHERE contact_id = c.id) as activity_count,
        (SELECT activity_date FROM crm_activities WHERE contact_id = c.id ORDER BY activity_date DESC LIMIT 1) as last_activity
      FROM crm_contacts c
      LEFT JOIN users u ON c.linked_user_id = u.id
      LEFT JOIN users creator ON c.user_id = creator.id
      WHERE ${d?"c.team_id = ?":"c.user_id = ?"}
    `;const u=[d?r:t.userId];a&&(c+=" AND c.status = ?",u.push(a)),s&&(c+=" AND c.contact_type = ?",u.push(s)),o&&(c+=" AND c.source = ?",u.push(o)),n&&(c+=" AND (c.name LIKE ? OR c.email LIKE ? OR c.company LIKE ?)",u.push(`%${n}%`,`%${n}%`,`%${n}%`)),c+=" ORDER BY c.updated_at DESC LIMIT ? OFFSET ?",u.push(i,l);const p=await e.env.DB.prepare(c).bind(...u).all();let m=`SELECT COUNT(*) as total FROM crm_contacts WHERE ${d?"team_id = ?":"user_id = ?"}`;const g=[d?r:t.userId];a&&(m+=" AND status = ?",g.push(a)),s&&(m+=" AND contact_type = ?",g.push(s)),o&&(m+=" AND source = ?",g.push(o));const b=await e.env.DB.prepare(m).bind(...g).first();return e.json({contacts:p.results||[],total:(b==null?void 0:b.total)||0,limit:i,offset:l})}catch(d){return console.error("[CRM] Error fetching contacts:",d),e.json({error:"Failed to fetch contacts"},500)}});Ge.get("/contacts/:id",at,async e=>{const t=e.get("user"),r=e.get("teamId"),a=e.req.param("id");try{const s=r!==null,o=await e.env.DB.prepare(`
      SELECT 
        c.*,
        u.name as linked_user_name,
        u.avatar_url as linked_user_avatar,
        u.email as linked_user_email,
        creator.name as created_by_name
      FROM crm_contacts c
      LEFT JOIN users u ON c.linked_user_id = u.id
      LEFT JOIN users creator ON c.user_id = creator.id
      WHERE c.id = ? AND ${s?"c.team_id = ?":"c.user_id = ?"}
    `).bind(a,s?r:t.userId).first();if(!o)return e.json({error:"Contact not found"},404);const n=await e.env.DB.prepare(`
      SELECT * FROM crm_activities 
      WHERE contact_id = ? 
      ORDER BY activity_date DESC 
      LIMIT 50
    `).bind(a).all(),i=await e.env.DB.prepare(`
      SELECT * FROM crm_deals 
      WHERE contact_id = ? 
      ORDER BY created_at DESC
    `).bind(a).all();return e.json({contact:o,activities:n.results||[],deals:i.results||[]})}catch(s){return console.error("[CRM] Error fetching contact:",s),e.json({error:"Failed to fetch contact"},500)}});Ge.post("/contacts",at,async e=>{var C,A;const t=e.get("user"),r=e.get("teamId"),a=await e.req.json(),{name:s,email:o,phone:n,company:i,position:l,linkedin_url:d,website:c,avatar_url:u,contact_type:p,status:m,source:g,priority:b,linked_user_id:v,connector_suggestion_id:y,notes:f,tags:x,custom_fields:_}=a;if(!s)return e.json({error:"Name is required"},400);try{const I=await e.env.DB.prepare(`
      INSERT INTO crm_contacts (
        user_id, team_id, name, email, phone, company, position, linkedin_url, website, avatar_url,
        contact_type, status, source, priority, linked_user_id, connector_suggestion_id,
        notes, tags, custom_fields
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(t.userId,r,s,o||null,n||null,i||null,l||null,d||null,c||null,u||null,p||"lead",m||"new",g||"manual",b||"medium",v||null,y||null,f||null,x?JSON.stringify(x):null,_?JSON.stringify(_):null).run();return(C=I.meta)!=null&&C.last_row_id&&await e.env.DB.prepare(`
        INSERT INTO crm_activities (contact_id, user_id, activity_type, subject, description)
        VALUES (?, ?, 'note', 'Contact created', ?)
      `).bind(I.meta.last_row_id,t.userId,`Contact added via ${g||"manual"}`).run(),e.json({success:!0,contact_id:(A=I.meta)==null?void 0:A.last_row_id,message:"Contact created successfully"})}catch(I){return console.error("[CRM] Error creating contact:",I),e.json({error:"Failed to create contact"},500)}});Ge.put("/contacts/:id",at,async e=>{const t=e.get("user"),r=e.get("teamId"),a=e.req.param("id"),s=await e.req.json();try{const o=r!==null;if(!await e.env.DB.prepare(`SELECT id FROM crm_contacts WHERE id = ? AND ${o?"team_id = ?":"user_id = ?"}`).bind(a,o?r:t.userId).first())return e.json({error:"Contact not found"},404);const{name:i,email:l,phone:d,company:c,position:u,linkedin_url:p,website:m,avatar_url:g,contact_type:b,status:v,priority:y,last_contact_date:f,next_follow_up:x,deal_value:_,notes:C,tags:A,custom_fields:I}=s;return await e.env.DB.prepare(`
      UPDATE crm_contacts SET
        name = ?,
        email = ?,
        phone = ?,
        company = ?,
        position = ?,
        linkedin_url = ?,
        website = ?,
        avatar_url = ?,
        contact_type = ?,
        status = ?,
        priority = ?,
        last_contact_date = ?,
        next_follow_up = ?,
        deal_value = ?,
        notes = ?,
        tags = ?,
        custom_fields = ?,
        updated_at = datetime('now')
      WHERE id = ?
    `).bind(i||null,l||null,d||null,c||null,u||null,p||null,m||null,g||null,b||"lead",v||"new",y||"medium",f||null,x||null,_||null,C||null,A?JSON.stringify(A):null,I?JSON.stringify(I):null,a).run(),e.json({success:!0,message:"Contact updated successfully"})}catch(o){return console.error("[CRM] Error updating contact:",o),e.json({error:"Failed to update contact"},500)}});Ge.delete("/contacts/:id",at,async e=>{var s;const t=e.get("user"),r=e.get("teamId"),a=e.req.param("id");try{const o=r!==null;return((s=(await e.env.DB.prepare(`DELETE FROM crm_contacts WHERE id = ? AND ${o?"team_id = ?":"user_id = ?"}`).bind(a,o?r:t.userId).run()).meta)==null?void 0:s.changes)===0?e.json({error:"Contact not found"},404):e.json({success:!0,message:"Contact deleted successfully"})}catch(o){return console.error("[CRM] Error deleting contact:",o),e.json({error:"Failed to delete contact"},500)}});Ge.get("/contacts/:id/activities",at,async e=>{const t=e.get("user"),r=e.get("teamId"),a=e.req.param("id");try{const s=r!==null;if(!await e.env.DB.prepare(`SELECT id FROM crm_contacts WHERE id = ? AND ${s?"team_id = ?":"user_id = ?"}`).bind(a,s?r:t.userId).first())return e.json({error:"Contact not found"},404);const n=await e.env.DB.prepare(`
      SELECT a.*, u.name as created_by_name
      FROM crm_activities a
      LEFT JOIN users u ON a.user_id = u.id
      WHERE a.contact_id = ?
      ORDER BY a.activity_date DESC, a.created_at DESC
    `).bind(a).all();return e.json({success:!0,activities:n.results||[]})}catch(s){return console.error("[CRM] Error fetching activities:",s),e.json({error:"Failed to fetch activities"},500)}});Ge.post("/contacts/:id/activities",at,async e=>{var c;const t=e.get("user"),r=e.get("teamId"),a=e.req.param("id"),s=await e.req.json(),{activity_type:o,subject:n,description:i,outcome:l,activity_date:d}=s;if(!o)return e.json({error:"Activity type is required"},400);try{const u=r!==null;if(!await e.env.DB.prepare(`SELECT id FROM crm_contacts WHERE id = ? AND ${u?"team_id = ?":"user_id = ?"}`).bind(a,u?r:t.userId).first())return e.json({error:"Contact not found"},404);const m=await e.env.DB.prepare(`
      INSERT INTO crm_activities (contact_id, user_id, activity_type, subject, description, outcome, activity_date)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(a,t.userId,o,n||null,i||null,l||null,d||new Date().toISOString()).run();return await e.env.DB.prepare(`
      UPDATE crm_contacts SET last_contact_date = datetime('now'), updated_at = datetime('now')
      WHERE id = ?
    `).bind(a).run(),e.json({success:!0,activity_id:(c=m.meta)==null?void 0:c.last_row_id,message:"Activity added successfully"})}catch(u){return console.error("[CRM] Error adding activity:",u),e.json({error:"Failed to add activity"},500)}});Ge.post("/from-connector",at,async e=>{var p,m;const t=e.get("user"),r=e.get("teamId"),a=await e.req.json(),{suggestion_id:s,suggested_user_id:o,name:n,email:i,company:l,reason:d,avatar_url:c}=a;if(!o&&!n)return e.json({error:"Either suggested_user_id or name is required"},400);const u=r!==null;try{if(s){const x=await e.env.DB.prepare(`
        SELECT id FROM crm_contacts 
        WHERE ${u?"team_id = ?":"user_id = ?"} AND connector_suggestion_id = ?
      `).bind(u?r:t.userId,s).first();if(x)return e.json({success:!0,contact_id:x.id,message:"Contact already exists",already_exists:!0})}if(o){const x=await e.env.DB.prepare(`
        SELECT id FROM crm_contacts 
        WHERE ${u?"team_id = ?":"user_id = ?"} AND linked_user_id = ?
      `).bind(u?r:t.userId,o).first();if(x)return await e.env.DB.prepare(`
          UPDATE crm_contacts 
          SET connector_suggestion_id = ?, updated_at = datetime('now')
          WHERE id = ?
        `).bind(s,x.id).run(),e.json({success:!0,contact_id:x.id,message:"Contact updated with connector info",already_exists:!0})}let g=n,b=i,v=c,y=l;if(o){const x=await e.env.DB.prepare(`
        SELECT name, email, avatar_url, company FROM users WHERE id = ?
      `).bind(o).first();x&&(g=g||x.name,b=b||x.email,v=v||x.avatar_url,y=y||x.company)}const f=await e.env.DB.prepare(`
      INSERT INTO crm_contacts (
        user_id, team_id, name, email, company, avatar_url,
        contact_type, status, source, priority,
        linked_user_id, connector_suggestion_id, notes
      )
      VALUES (?, ?, ?, ?, ?, ?, 'lead', 'new', 'ai_connector', 'medium', ?, ?, ?)
    `).bind(t.userId,r,g,b||null,y||null,v||null,o||null,s||null,d?`AI Connector: ${d}`:"Added from AI Connector suggestion").run();return(p=f.meta)!=null&&p.last_row_id&&await e.env.DB.prepare(`
        INSERT INTO crm_activities (contact_id, user_id, activity_type, subject, description)
        VALUES (?, ?, 'note', 'Added from AI Connector', ?)
      `).bind(f.meta.last_row_id,t.userId,d||"Contact suggested by AI SuperConnector").run(),s&&await e.env.DB.prepare(`
        UPDATE connector_suggestions 
        SET status = 'contacted', contacted_at = datetime('now')
        WHERE id = ?
      `).bind(s).run(),e.json({success:!0,contact_id:(m=f.meta)==null?void 0:m.last_row_id,message:"Contact added to CRM from AI Connector"})}catch(g){return console.error("[CRM] Error adding from connector:",g),e.json({error:"Failed to add contact from connector"},500)}});Ge.get("/stats",at,async e=>{const t=e.get("user"),r=e.get("teamId"),a=r!==null,s=a?r:t.userId,o=a?"team_id":"user_id";try{const n=await e.env.DB.prepare(`
      SELECT 
        COUNT(*) as total_contacts,
        COUNT(CASE WHEN status = 'new' THEN 1 END) as new_contacts,
        COUNT(CASE WHEN status = 'contacted' THEN 1 END) as contacted,
        COUNT(CASE WHEN status = 'qualified' THEN 1 END) as qualified,
        COUNT(CASE WHEN status = 'negotiation' THEN 1 END) as negotiation,
        COUNT(CASE WHEN status = 'won' THEN 1 END) as won,
        COUNT(CASE WHEN status = 'lost' THEN 1 END) as lost,
        COUNT(CASE WHEN source = 'ai_connector' THEN 1 END) as from_ai_connector,
        COUNT(CASE WHEN source = 'manual' THEN 1 END) as manual_added,
        COUNT(CASE WHEN contact_type = 'lead' THEN 1 END) as leads,
        COUNT(CASE WHEN contact_type = 'customer' THEN 1 END) as customers,
        COUNT(CASE WHEN contact_type = 'investor' THEN 1 END) as investors,
        COUNT(CASE WHEN contact_type = 'partner' THEN 1 END) as partners,
        SUM(deal_value) as total_deal_value
      FROM crm_contacts
      WHERE ${o} = ?
    `).bind(s).first(),i=await e.env.DB.prepare(`
      SELECT 
        a.*,
        c.name as contact_name,
        c.avatar_url as contact_avatar,
        u.name as created_by_name
      FROM crm_activities a
      JOIN crm_contacts c ON a.contact_id = c.id
      LEFT JOIN users u ON a.user_id = u.id
      WHERE c.${o} = ?
      ORDER BY a.activity_date DESC
      LIMIT 10
    `).bind(s).all(),l=await e.env.DB.prepare(`
      SELECT * FROM crm_contacts
      WHERE ${o} = ? 
        AND next_follow_up IS NOT NULL 
        AND next_follow_up <= datetime('now', '+7 days')
      ORDER BY next_follow_up ASC
      LIMIT 10
    `).bind(s).all();return e.json({total:n.total_contacts||0,by_status:{new:n.new_contacts||0,contacted:n.contacted||0,qualified:n.qualified||0,negotiation:n.negotiation||0,won:n.won||0,lost:n.lost||0},by_type:{lead:n.leads||0,customer:n.customers||0,investor:n.investors||0,partner:n.partners||0},from_ai_connector:n.from_ai_connector||0,manual_added:n.manual_added||0,total_deal_value:n.total_deal_value||0,recent_activities:i.results||[],follow_ups_due:l.results||[]})}catch(n){return console.error("[CRM] Error fetching stats:",n),e.json({error:"Failed to fetch stats"},500)}});Ge.post("/import",at,async e=>{const t=e.get("user"),r=e.get("teamId"),a=await e.req.json(),{contacts:s}=a;if(!s||!Array.isArray(s))return e.json({error:"Contacts array is required"},400);try{let o=0,n=0;for(const i of s){if(!i.name){n++;continue}try{await e.env.DB.prepare(`
          INSERT INTO crm_contacts (
            user_id, team_id, name, email, phone, company, position, 
            contact_type, status, source, notes, tags
          )
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'new', 'import', ?, ?)
        `).bind(t.userId,r,i.name,i.email||null,i.phone||null,i.company||null,i.position||null,i.contact_type||"lead",i.notes||null,i.tags?JSON.stringify(i.tags):null).run(),o++}catch{n++}}return e.json({success:!0,imported:o,skipped:n,message:`Imported ${o} contacts, skipped ${n}`})}catch(o){return console.error("[CRM] Error importing contacts:",o),e.json({error:"Failed to import contacts"},500)}});const cs=new ee;cs.get("/metrics/:userId",async e=>{const t=e.req.param("userId"),r=parseInt(e.req.query("limit")||"12");try{const{results:a}=await e.env.DB.prepare(`
      SELECT 
        gwt.*,
        g.id as goal_id,
        g.description as goal_description,
        g.created_at as goal_created_at
      FROM goal_weekly_traction gwt
      LEFT JOIN goals g ON g.user_id = gwt.user_id 
        AND g.week_number = gwt.week_number 
        AND g.year_number = gwt.year
        AND g.category = 'traction'
      WHERE gwt.user_id = ?
      ORDER BY gwt.year DESC, gwt.week_number DESC
      LIMIT ?
    `).bind(t,r).all();return e.json({metrics:a||[],userId:t})}catch(a){return console.error("Error fetching traction metrics:",a),e.json({error:"Failed to fetch traction metrics"},500)}});cs.get("/leaderboard",async e=>{const t=e.req.query("metric")||"growth",r=parseInt(e.req.query("weeks")||"4"),a=parseInt(e.req.query("limit")||"50");try{const s=await e.env.DB.prepare(`
      SELECT 
        CAST(strftime('%W', 'now') AS INTEGER) as current_week,
        CAST(strftime('%Y', 'now') AS INTEGER) as current_year
    `).first(),o=(s==null?void 0:s.current_week)||0,n=(s==null?void 0:s.current_year)||2026,{results:i}=await e.env.DB.prepare(`
      WITH WeeklyMetrics AS (
        SELECT 
          gwt.user_id,
          gwt.week_number,
          gwt.year,
          gwt.revenue_amount,
          gwt.new_users,
          gwt.active_users,
          gwt.churned_users,
          gwt.strongest_signal,
          gwt.created_at,
          -- Calculate growth from previous week
          LAG(gwt.revenue_amount, 1) OVER (PARTITION BY gwt.user_id ORDER BY gwt.year, gwt.week_number) as prev_revenue,
          LAG(gwt.new_users, 1) OVER (PARTITION BY gwt.user_id ORDER BY gwt.year, gwt.week_number) as prev_new_users,
          LAG(gwt.active_users, 1) OVER (PARTITION BY gwt.user_id ORDER BY gwt.year, gwt.week_number) as prev_active_users
        FROM goal_weekly_traction gwt
        WHERE (gwt.year = ? AND gwt.week_number >= ? - ?)
          OR (gwt.year = ? - 1 AND gwt.week_number >= 52 - (? - ?) + ?)
      ),
      UserStats AS (
        SELECT 
          wm.user_id,
          u.name as user_name,
          u.avatar_url,
          u.email,
          -- Latest metrics
          MAX(CASE WHEN wm.year = ? AND wm.week_number = ? THEN wm.revenue_amount ELSE NULL END) as latest_revenue,
          MAX(CASE WHEN wm.year = ? AND wm.week_number = ? THEN wm.new_users ELSE NULL END) as latest_new_users,
          MAX(CASE WHEN wm.year = ? AND wm.week_number = ? THEN wm.active_users ELSE NULL END) as latest_active_users,
          -- Total metrics over period
          SUM(wm.revenue_amount) as total_revenue,
          SUM(wm.new_users) as total_new_users,
          AVG(wm.active_users) as avg_active_users,
          SUM(wm.churned_users) as total_churned,
          -- Growth calculations
          AVG(CASE 
            WHEN wm.prev_revenue > 0 
            THEN ((wm.revenue_amount - wm.prev_revenue) / wm.prev_revenue * 100)
            ELSE 0 
          END) as avg_revenue_growth_pct,
          AVG(CASE 
            WHEN wm.prev_active_users > 0 
            THEN ((wm.active_users - wm.prev_active_users) / wm.prev_active_users * 100)
            ELSE 0 
          END) as avg_user_growth_pct,
          -- Consistency metrics
          COUNT(*) as weeks_reporting,
          MAX(wm.strongest_signal) as best_signal,
          -- Get their project info
          (SELECT bp.title FROM beta_products bp WHERE bp.company_user_id = wm.user_id LIMIT 1) as project_title,
          (SELECT bp.category FROM beta_products bp WHERE bp.company_user_id = wm.user_id LIMIT 1) as project_category,
          (SELECT bp.id FROM beta_products bp WHERE bp.company_user_id = wm.user_id LIMIT 1) as project_id
        FROM WeeklyMetrics wm
        JOIN users u ON wm.user_id = u.id
        GROUP BY wm.user_id, u.name, u.avatar_url, u.email
        HAVING weeks_reporting >= 1
      )
      SELECT 
        *,
        -- Composite score (similar to VC scoring)
        (
          (COALESCE(avg_revenue_growth_pct, 0) * 0.35) +
          (COALESCE(total_revenue / 1000, 0) * 0.25) +
          (COALESCE(avg_user_growth_pct, 0) * 0.20) +
          (COALESCE(total_new_users, 0) * 0.15) +
          (weeks_reporting * 2.5)
        ) as composite_score
      FROM UserStats
      ORDER BY 
        CASE 
          WHEN ? = 'revenue' THEN total_revenue
          WHEN ? = 'users' THEN total_new_users
          WHEN ? = 'growth' THEN (avg_revenue_growth_pct + avg_user_growth_pct) / 2
          ELSE composite_score
        END DESC
      LIMIT ?
    `).bind(n,o,r,n,r,r,o,n,o,n,o,n,o,t,t,t,a).all();return e.json({leaderboard:i||[],metric:t,weeks:r,currentWeek:o,currentYear:n})}catch(s){return console.error("Error fetching traction leaderboard:",s),e.json({error:"Failed to fetch traction leaderboard",details:s.message},500)}});cs.get("/summary/:userId",async e=>{const t=e.req.param("userId");try{const r=await e.env.DB.prepare(`
      WITH RecentMetrics AS (
        SELECT 
          revenue_amount,
          new_users,
          active_users,
          churned_users,
          week_number,
          year,
          ROW_NUMBER() OVER (ORDER BY year DESC, week_number DESC) as rn
        FROM goal_weekly_traction
        WHERE user_id = ?
      )
      SELECT 
        -- Current week (latest)
        MAX(CASE WHEN rn = 1 THEN revenue_amount END) as current_revenue,
        MAX(CASE WHEN rn = 1 THEN new_users END) as current_new_users,
        MAX(CASE WHEN rn = 1 THEN active_users END) as current_active_users,
        MAX(CASE WHEN rn = 1 THEN churned_users END) as current_churned,
        -- Previous week
        MAX(CASE WHEN rn = 2 THEN revenue_amount END) as prev_revenue,
        MAX(CASE WHEN rn = 2 THEN active_users END) as prev_active_users,
        -- All-time totals
        SUM(revenue_amount) as total_revenue,
        SUM(new_users) as total_users_acquired,
        AVG(active_users) as avg_active_users,
        SUM(churned_users) as total_churned,
        COUNT(*) as weeks_tracked
      FROM RecentMetrics
    `).bind(t).first(),a=r!=null&&r.prev_revenue?(r.current_revenue-r.prev_revenue)/r.prev_revenue*100:0,s=r!=null&&r.prev_active_users?(r.current_active_users-r.prev_active_users)/r.prev_active_users*100:0;return e.json({...r,revenue_growth_wow:Math.round(a*10)/10,user_growth_wow:Math.round(s*10)/10})}catch(r){return console.error("Error fetching traction summary:",r),e.json({error:"Failed to fetch traction summary"},500)}});const Rt=new ee;function pv(e){if(!e.JWT_SECRET)throw new Error("JWT_SECRET environment variable is not configured");return e.JWT_SECRET}const ua=async(e,t)=>{var a,s,o,n,i;const r=((a=e.req.header("Authorization"))==null?void 0:a.replace("Bearer ",""))||((o=(s=e.req.header("cookie"))==null?void 0:s.match(/authToken=([^;]+)/))==null?void 0:o[1])||((i=(n=e.req.header("Cookie"))==null?void 0:n.match(/authToken=([^;]+)/))==null?void 0:i[1]);if(!r)return e.json({error:"No authentication token provided"},401);try{const l=await te(r,pv(e.env)),d=await e.env.DB.prepare(`
      SELECT id, email, name, role, avatar_url FROM users WHERE id = ?
    `).bind(l.userId).first();if(!d)return e.json({error:"User not found"},401);e.set("user",d),await t()}catch(l){return console.error("Auth error:",l),e.json({error:"Invalid authentication token"},401)}};async function fn(e,t){const r=e.get("user");if(!r||r.role!=="admin")return e.json({error:"Admin access required"},403);await t()}Rt.get("/",async e=>{try{const{status:t,featured:r}=e.req.query();let a=`
      SELECT 
        e.*,
        u.name as creator_name,
        (SELECT COUNT(*) FROM event_registrations WHERE event_id = e.id) as registered_count
      FROM events e
      LEFT JOIN users u ON e.created_by = u.id
      WHERE 1=1
    `;const s=[];t&&(a+=" AND e.status = ?",s.push(t)),r==="true"&&(a+=" AND e.is_featured = 1"),a+=" ORDER BY e.event_date ASC";const n=(await e.env.DB.prepare(a).bind(...s).all()).results.map(i=>({...i,tags:i.tags?JSON.parse(i.tags):[],is_featured:!!i.is_featured}));return e.json({success:!0,events:n})}catch(t){return console.error("Error fetching events:",t),e.json({error:"Failed to fetch events"},500)}});Rt.get("/:id",async e=>{try{const t=e.req.param("id"),r=await e.env.DB.prepare(`
      SELECT 
        e.*,
        u.name as creator_name,
        u.avatar_url as creator_avatar,
        (SELECT COUNT(*) FROM event_registrations WHERE event_id = e.id) as registered_count
      FROM events e
      LEFT JOIN users u ON e.created_by = u.id
      WHERE e.id = ?
    `).bind(t).first();if(!r)return e.json({error:"Event not found"},404);const a=await e.env.DB.prepare(`
      SELECT 
        er.*,
        u.name,
        u.email,
        u.avatar_url,
        u.company,
        u.role
      FROM event_registrations er
      LEFT JOIN users u ON er.user_id = u.id
      WHERE er.event_id = ?
      ORDER BY er.registered_at ASC
    `).bind(t).all();return e.json({success:!0,event:{...r,tags:r.tags?JSON.parse(r.tags):[],is_featured:!!r.is_featured,registrations:a.results}})}catch(t){return console.error("Error fetching event:",t),e.json({error:"Failed to fetch event"},500)}});Rt.post("/",ua,fn,async e=>{try{const t=e.get("user"),r=await e.req.json(),{title:a,description:s,event_type:o,event_date:n,event_time:i,duration_minutes:l,location:d,meeting_link:c,registration_link:u,max_participants:p,banner_image_url:m,host_name:g,host_avatar:b,tags:v,is_featured:y}=r;if(!a||!s||!n)return e.json({error:"Title, description, and event date are required"},400);const f=await e.env.DB.prepare(`
      INSERT INTO events (
        title, description, event_type, event_date, event_time, duration_minutes,
        location, meeting_link, registration_link, max_participants,
        banner_image_url, host_name, host_avatar, tags, is_featured, created_by
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(a,s,o||"pitch",n,i,l||60,d,c,u,p,m,g,b,v?JSON.stringify(v):null,y?1:0,t.id).run();return e.json({success:!0,message:"Event created successfully",event_id:f.meta.last_row_id})}catch(t){return console.error("Error creating event:",t),e.json({error:"Failed to create event"},500)}});Rt.put("/:id",ua,fn,async e=>{try{const t=e.req.param("id"),r=await e.req.json(),{title:a,description:s,event_type:o,event_date:n,event_time:i,duration_minutes:l,location:d,meeting_link:c,registration_link:u,max_participants:p,banner_image_url:m,host_name:g,host_avatar:b,tags:v,status:y,is_featured:f}=r;return await e.env.DB.prepare(`
      UPDATE events SET
        title = ?,
        description = ?,
        event_type = ?,
        event_date = ?,
        event_time = ?,
        duration_minutes = ?,
        location = ?,
        meeting_link = ?,
        registration_link = ?,
        max_participants = ?,
        banner_image_url = ?,
        host_name = ?,
        host_avatar = ?,
        tags = ?,
        status = ?,
        is_featured = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(a,s,o,n,i,l,d,c,u,p,m,g,b,v?JSON.stringify(v):null,y,f?1:0,t).run(),e.json({success:!0,message:"Event updated successfully"})}catch(t){return console.error("Error updating event:",t),e.json({error:"Failed to update event"},500)}});Rt.delete("/:id",ua,fn,async e=>{try{const t=e.req.param("id");return await e.env.DB.prepare("DELETE FROM events WHERE id = ?").bind(t).run(),e.json({success:!0,message:"Event deleted successfully"})}catch(t){return console.error("Error deleting event:",t),e.json({error:"Failed to delete event"},500)}});Rt.post("/:id/register",ua,async e=>{try{const t=e.get("user"),r=e.req.param("id"),a=await e.env.DB.prepare(`
      SELECT e.*, 
        (SELECT COUNT(*) FROM event_registrations WHERE event_id = e.id) as registered_count
      FROM events e
      WHERE e.id = ?
    `).bind(r).first();return a?a.max_participants&&a.registered_count>=a.max_participants?e.json({error:"Event is full"},400):await e.env.DB.prepare(`
      SELECT id FROM event_registrations WHERE event_id = ? AND user_id = ?
    `).bind(r,t.id).first()?e.json({error:"Already registered for this event"},400):(await e.env.DB.prepare(`
      INSERT INTO event_registrations (event_id, user_id)
      VALUES (?, ?)
    `).bind(r,t.id).run(),e.json({success:!0,message:"Successfully registered for event"})):e.json({error:"Event not found"},404)}catch(t){return console.error("Error registering for event:",t),e.json({error:"Failed to register for event"},500)}});Rt.delete("/:id/register",ua,async e=>{try{const t=e.get("user"),r=e.req.param("id");return await e.env.DB.prepare(`
      DELETE FROM event_registrations 
      WHERE event_id = ? AND user_id = ?
    `).bind(r,t.id).run(),e.json({success:!0,message:"Successfully unregistered from event"})}catch(t){return console.error("Error unregistering from event:",t),e.json({error:"Failed to unregister from event"},500)}});const G=new ee;G.use("/api/*",vr());G.use("/static/*",Bc({root:"./public"}));G.route("/api/auth",we);G.route("/api/marketplace",W);G.route("/api/plans",Fe);G.route("/api/stripe",_r);G.route("/api/projects",Me);G.route("/api/validation",ia);G.route("/api/beta-users",Za);G.route("/api/mvp",Zo);G.route("/api/deploy",es);G.route("/api/dashboard",le);G.route("/api/validator-requests",Ct);G.route("/api/chat",tt);G.route("/api/notifications",Gt);G.route("/api/quick-pitch",Ld);G.route("/api/whatsapp",la);G.route("/api/chat-agent",Ae);G.route("/api/marketing-ai",He);G.route("/api/competitions",rt);G.route("/api/admin",de);G.route("/api/metrics-data",Ue);G.route("/api/ai-cmo",It);G.route("/api/astar-messages",Se);G.route("/api/team",Wt);G.route("/api/connector",wr);G.route("/api/crm",Ge);G.route("/api/traction",cs);G.route("/api/events",Rt);G.get("/onboarding",async e=>{var n,i;const t=(i=(n=e.req.header("cookie"))==null?void 0:n.match(/authToken=([^;]+)/))==null?void 0:i[1],r=e.req.query("token");if(!t&&!r)return e.redirect("/");let a=null;const s=t||r;if(s)try{a=await te(s,e.env.JWT_SECRET)}catch{return e.redirect("/")}if(!a)return e.redirect("/");const o=Au({userName:a.userName||a.name||a.email||"User",userEmail:a.email,userRole:a.role||"founder",userId:a.userId,token:s});return e.html(o)});G.get("/dashboard",async e=>{var i,l;const t=(l=(i=e.req.header("cookie"))==null?void 0:i.match(/authToken=([^;]+)/))==null?void 0:l[1],r=e.req.query("token");let a=null;const s=t||r;if(s)try{a=await te(s,e.env.JWT_SECRET)}catch{}a||(a={userName:"Guest",email:"",userId:0,role:"guest"});let o=a.role||"founder";if(a.userId){const d=await e.env.DB.prepare(`
      SELECT role FROM users WHERE id = ?
    `).bind(a.userId).first();d&&(o=d.role||"founder")}const n=nd({userName:a.userName||a.name||a.email||"User",userAvatar:a.avatar_url,userRole:o});return e.html(n)});G.get("/competitions",async e=>{var n,i;const t=(i=(n=e.req.header("cookie"))==null?void 0:n.match(/authToken=([^;]+)/))==null?void 0:i[1],r=e.req.query("token");let a=null;const s=t||r;if(s)try{a=await te(s,e.env.JWT_SECRET)}catch{}a||(a={userName:"Guest",email:"",userId:0,role:"guest"});const o=Ou({userName:a.userName||a.name||a.email||"Guest",userAvatar:a.avatar_url,userRole:a.role||"guest"});return e.html(o)});G.get("/events",async e=>{var i,l;const t=(l=(i=e.req.header("cookie"))==null?void 0:i.match(/authToken=([^;]+)/))==null?void 0:l[1],r=e.req.query("token");let a=null;const s=t||r;if(s)try{a=await te(s,e.env.JWT_SECRET)}catch{}a||(a={userName:"Guest",email:"",userId:0,role:"guest"});let o=a.role||"guest";if(a.userId){const d=await e.env.DB.prepare(`
      SELECT role FROM users WHERE id = ?
    `).bind(a.userId).first();d&&(o=d.role||"guest")}const n=ku({userName:a.userName||a.name||a.email||"Guest",userAvatar:a.avatar_url,userRole:o});return e.html(n)});G.get("/team",async e=>{var l,d;const t=(d=(l=e.req.header("cookie"))==null?void 0:l.match(/authToken=([^;]+)/))==null?void 0:d[1],r=e.req.query("token");if(!t&&!r)return e.redirect("/");let a=null;const s=t||r;if(s)try{a=await te(s,e.env.JWT_SECRET)}catch{return e.redirect("/")}if(!a||!a.userId)return e.redirect("/");const o=await e.env.DB.prepare(`
    SELECT id, email, name, role, avatar_url FROM users WHERE id = ?
  `).bind(a.userId).first();if(!o)return e.redirect("/");const{renderTeamManagementPage:n}=await Promise.resolve().then(()=>hv),i=n(o);return e.html(i)});G.get("/admin",async e=>{var i,l;const t=(l=(i=e.req.header("cookie"))==null?void 0:i.match(/authToken=([^;]+)/))==null?void 0:l[1],r=e.req.query("token");if(!t&&!r)return e.redirect("/");let a=null;const s=t||r;if(s)try{a=await te(s,e.env.JWT_SECRET)}catch{return e.redirect("/")}if(!a||!a.userId)return e.redirect("/");const o=await e.env.DB.prepare(`
    SELECT id, email, name, role, avatar_url FROM users WHERE id = ?
  `).bind(a.userId).first();if(!o||o.role!=="admin")return e.html("<html><body><h1>403 Forbidden</h1><p>Admin access required</p></body></html>",403);const n=Mu({userName:o.name||a.name||a.email||"Admin",userAvatar:o.avatar_url||a.avatar_url,userRole:o.role});return e.html(n)});G.get("/competitions/:id/leaderboard",async e=>{try{const t=e.req.param("id"),r=await e.env.DB.prepare(`
      SELECT * FROM competitions WHERE id = ?
    `).bind(t).first();if(!r)return e.html("<html><body><h1>404 Not Found</h1><p>Competition not found</p></body></html>",404);const a=await e.env.DB.prepare(`
      SELECT 
        cp.*,
        u.name,
        u.email,
        u.avatar_url,
        p.title as project_title,
        p.description as project_description
      FROM competition_participants cp
      JOIN users u ON cp.user_id = u.id
      LEFT JOIN projects p ON cp.project_id = p.id
      WHERE cp.competition_id = ?
      ORDER BY cp.registration_date ASC
    `).bind(t).all(),s=Nu({competitionId:t,competitionTitle:r.title,competitionDescription:r.description,prizeAmount:r.prize_amount,participants:a.results||[]});return e.html(s)}catch(t){return console.error("[LEADERBOARD] Error loading competition leaderboard:",t),e.html("<html><body><h1>500 Error</h1><p>Failed to load leaderboard</p></body></html>",500)}});G.get("/marketplace",async e=>e.redirect("/dashboard"));G.get("/vote/:projectId",async e=>{var a,s;const t=e.req.param("projectId"),r=((s=(a=e.req.header("cookie"))==null?void 0:a.match(/authToken=([^;]+)/))==null?void 0:s[1])||e.req.query("token");if(!r)return e.redirect(`/api/auth/google?role=validator&redirect=/vote/${t}`);try{const o=await te(r,e.env.JWT_SECRET);if(!o||o.role!=="validator")return e.redirect(`/api/auth/google?role=validator&redirect=/vote/${t}`);const n=await e.env.DB.prepare(`
      SELECT p.*, u.name as creator_name
      FROM projects p
      JOIN users u ON p.user_id = u.id
      WHERE p.id = ?
    `).bind(t).first();if(!n){const l=Su();return e.jsx(l)}const i=Iu(n,t,r);return e.jsx(i)}catch{return e.redirect(`/api/auth/google?role=validator&redirect=/vote/${t}`)}});G.get("/",async e=>e.html(`
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTAR* - Connecting the brightest minds in the world</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      html {
        scroll-behavior: smooth;
      }
      
      body {
        font-family: 'Montserrat', system-ui, sans-serif;
        overflow-x: hidden;
        overflow-y: auto;
      }
      
      /* Cosmic Background */
      .cosmic-bg {
        background: linear-gradient(180deg, #050510 0%, #0a0a1a 50%, #1a1a3e 100%);
        position: relative;
        min-height: 100vh;
      }
      
      /* Stars Animation */
      .stars {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      
      .stars::before,
      .stars::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: 
          radial-gradient(2px 2px at 20% 30%, #fff, transparent),
          radial-gradient(2px 2px at 60% 70%, rgba(255,255,255,0.8), transparent),
          radial-gradient(1px 1px at 50% 50%, #fff, transparent),
          radial-gradient(2px 2px at 80% 10%, rgba(255,255,255,0.9), transparent),
          radial-gradient(1px 1px at 90% 60%, #fff, transparent),
          radial-gradient(2px 2px at 30% 80%, rgba(255,255,255,0.7), transparent);
        background-repeat: repeat;
        background-size: 200% 200%;
        animation: twinkle 8s ease-in-out infinite;
      }
      
      @keyframes twinkle {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
      }
      
      /* Planet Styles */
      .planet {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255,255,255,0.1);
      }
      
      .planet:hover {
        transform: scale(1.1);
        border-color: rgba(255,255,255,0.3);
      }
      
      .planet-founder {
        background: linear-gradient(135deg, #78909C 0%, #90A4AE 50%, #B0BEC5 100%);
        box-shadow: 0 0 60px rgba(120, 144, 156, 0.4), inset 0 0 40px rgba(255,255,255,0.1);
      }
      
      .planet-investor {
        background: linear-gradient(135deg, #26C6DA 0%, #00ACC1 50%, #0097A7 100%);
        box-shadow: 0 0 60px rgba(0, 172, 193, 0.5), inset 0 0 40px rgba(255,255,255,0.1);
      }
      
      .planet-scout {
        background: linear-gradient(135deg, #AB47BC 0%, #8E24AA 50%, #7B1FA2 100%);
        box-shadow: 0 0 60px rgba(142, 36, 170, 0.5), inset 0 0 40px rgba(255,255,255,0.1);
      }
      
      .planet-partner {
        background: linear-gradient(135deg, #EF5350 0%, #E53935 50%, #D32F2F 100%);
        box-shadow: 0 0 60px rgba(239, 83, 80, 0.5), inset 0 0 40px rgba(255,255,255,0.1);
      }
      
      .planet-jobseeker {
        background: linear-gradient(135deg, #FFCA28 0%, #FFB300 50%, #FFA000 100%);
        box-shadow: 0 0 60px rgba(255, 179, 0, 0.5), inset 0 0 40px rgba(255,255,255,0.1);
      }
      
      .planet-other {
        background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 50%, #1565C0 100%);
        box-shadow: 0 0 60px rgba(66, 165, 245, 0.5), inset 0 0 40px rgba(255,255,255,0.1);
      }
      
      /* Orbit Ring */
      .orbit-ring {
        position: absolute;
        border: 1px solid rgba(255, 184, 0, 0.3);
        border-radius: 50%;
        animation: rotate 20s linear infinite;
      }
      
      .planet-jobseeker .orbit-ring {
        width: 280px;
        height: 160px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotateX(75deg);
      }
      
      @keyframes rotate {
        from { transform: translate(-50%, -50%) rotateX(75deg) rotateZ(0deg); }
        to { transform: translate(-50%, -50%) rotateX(75deg) rotateZ(360deg); }
      }
      
      .planet-badge {
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        border: 1px solid rgba(255,255,255,0.2);
      }
      
      .nav-link {
        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
      }
      
      .nav-link:hover {
        background: rgba(255,255,255,0.1);
      }
    </style>
</head>
<body class="cosmic-bg min-h-screen text-white">
    <!-- Stars Background -->
    <div class="stars"></div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 bg-black bg-opacity-50 backdrop-blur-sm border-b border-white/10">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-2xl font-bold">ASTAR*</span>
                    <span class="text-gray-400 text-xs hidden sm:inline">Connecting the brightest minds in the world</span>
                </div>
                
                <div class="flex items-center space-x-6">
                    <a href="#roles" class="nav-link text-white flex items-center space-x-2">
                        <span>🏠</span>
                        <span class="hidden sm:inline">Home</span>
                    </a>
                    <a href="/dashboard" onclick="event.preventDefault(); const token = document.cookie.match(/authToken=([^;]+)/)?.[1]; if (!token) { showAuthModal('login'); } else { window.location.href='/dashboard'; }" class="nav-link text-white flex items-center space-x-2 cursor-pointer">
                        <span>🎯</span>
                        <span class="hidden sm:inline">Hub</span>
                    </a>
                    <a href="/competitions" class="nav-link text-white flex items-center space-x-2">
                        <span>🏅</span>
                        <span class="hidden sm:inline">Competitions</span>
                    </a>
                    <a href="/leaderboard" class="nav-link text-white flex items-center space-x-2">
                        <span>🏆</span>
                        <span class="hidden sm:inline">Leaderboard</span>
                    </a>
                    <a href="/dashboard?tab=directory" class="nav-link text-white flex items-center space-x-2">
                        <span>🔥</span>
                        <span class="hidden sm:inline">Trending Startups</span>
                    </a>
                    <button onclick="showAuthModal('login')" class="bg-white text-black px-6 py-2 rounded-full font-semibold hover:bg-gray-200 transition">
                        Sign In
                    </button>
                    <button onclick="showAuthModal('register')" class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 transition">
                        Launch Now
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section with Planets -->
    <main class="relative z-10 min-h-screen flex items-center justify-center px-6 pt-32 pb-20">
        <div class="max-w-6xl w-full text-center" id="roles">
            <!-- Hero Title -->
            <h1 class="text-5xl md:text-7xl font-bold mb-8 leading-tight">
                Welcome to the <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500">ASTAR*</span> ecosystem
            </h1>
            
            <p class="text-lg md:text-xl text-gray-300 mb-16 max-w-4xl mx-auto leading-relaxed">
                ASTAR* is an AI superconnector helping early-stage founders get traction. We operate weekly progress-based competitions and monthly live pitch events, enabling discovery, credibility, and momentum for founders worldwide.
            </p>

            <p class="text-2xl md:text-3xl font-semibold text-gray-200 mb-4">
                Choose your trajectory 🚀
            </p>
            
            <p class="text-lg md:text-xl text-gray-400 mb-16 max-w-4xl mx-auto leading-relaxed">
                <span class="text-gray-300 font-medium">Which role defines your mission in the ASTAR* ecosystem?</span>
            </p>

            <!-- Planets Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12 max-w-5xl mx-auto mb-12">
                <!-- Founder Planet -->
                <div class="flex flex-col items-center" onclick="selectRole('founder')">
                    <div class="planet planet-founder">
                        <span class="planet-badge">FOUNDER</span>
                    </div>
                    <h3 class="text-2xl font-bold mt-6 mb-3">FOUNDER</h3>
                    <p class="text-gray-300 text-center px-4">Building the next big thing</p>
                </div>

                <!-- Investor Planet -->
                <div class="flex flex-col items-center" onclick="selectRole('investor')">
                    <div class="planet planet-investor">
                        <span class="planet-badge">INVESTOR</span>
                    </div>
                    <h3 class="text-2xl font-bold mt-6 mb-3">INVESTOR</h3>
                    <p class="text-gray-300 text-center px-4">Fueling stellar growth</p>
                </div>

                <!-- Scout Planet -->
                <div class="flex flex-col items-center" onclick="selectRole('scout')">
                    <div class="planet planet-scout">
                        <span class="planet-badge">SCOUT</span>
                    </div>
                    <h3 class="text-2xl font-bold mt-6 mb-3">SCOUT</h3>
                    <p class="text-gray-300 text-center px-4">Finding hidden gems</p>
                </div>
            </div>

            <!-- Second Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12 max-w-5xl mx-auto">
                <!-- Partner Planet -->
                <div class="flex flex-col items-center" onclick="selectRole('partner')">
                    <div class="planet planet-partner">
                        <span class="planet-badge">PARTNER</span>
                    </div>
                    <h3 class="text-2xl font-bold mt-6 mb-3">PARTNER</h3>
                    <p class="text-gray-300 text-center px-4">Collaborate with ASTAR*</p>
                </div>

                <!-- Job Seeker Planet -->
                <div class="flex flex-col items-center" onclick="selectRole('job_seeker')">
                    <div class="planet planet-jobseeker">
                        <div class="orbit-ring"></div>
                        <span class="planet-badge">JOB SEEKER</span>
                    </div>
                    <h3 class="text-2xl font-bold mt-6 mb-3">JOB SEEKER</h3>
                    <p class="text-gray-300 text-center px-4">Join a promising startup</p>
                </div>

                <!-- Validator Planet -->
                <div class="flex flex-col items-center" onclick="selectRole('validator')">
                    <div class="planet planet-other">
                        <span class="planet-badge">VALIDATOR</span>
                    </div>
                    <h3 class="text-2xl font-bold mt-6 mb-3">VALIDATOR</h3>
                    <p class="text-gray-300 text-center px-4">Validate and vote on startups</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Auth Modal (same as before) -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-50 hidden flex items-center justify-center px-4">
      <div class="bg-gray-900 rounded-2xl p-8 max-w-md w-full border border-white/10" id="modal-content">
        <!-- Modal content will be inserted here -->
      </div>
    </div>

    <script>
      function selectRole(role) {
        window.location.href = '/api/auth/google?role=' + role;
      }

      function showAuthModal(mode) {
        const modal = document.getElementById('auth-modal');
        const modalContent = document.getElementById('modal-content');
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        if (mode === 'login') {
          const loginHtml = 
            '<div class="text-center">' +
              '<h2 class="text-2xl font-bold mb-4">Choose your role to Sign In</h2>' +
              '<p class="text-gray-400 mb-6">Sign in with Google to access your ASTAR* account</p>' +
              '<div class="space-y-3">' +
                '<button onclick="loginWithGoogle(\\'founder\\')" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center">' +
                  '<span class="mr-2">👨‍💻</span> Founder' +
                '</button>' +
                '<button onclick="loginWithGoogle(\\'investor\\')" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center">' +
                  '<span class="mr-2">💰</span> Investor' +
                '</button>' +
                '<button onclick="loginWithGoogle(\\'scout\\')" class="w-full bg-gradient-to-r from-purple-500 to-purple-700 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center">' +
                  '<span class="mr-2">🔍</span> Scout' +
                '</button>' +
                '<button onclick="loginWithGoogle(\\'partner\\')" class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center">' +
                  '<span class="mr-2">🤝</span> Partner' +
                '</button>' +
                '<button onclick="loginWithGoogle(\\'job_seeker\\')" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center">' +
                  '<span class="mr-2">💼</span> Job Seeker' +
                '</button>' +
                '<button onclick="loginWithGoogle(\\'validator\\')" class="w-full bg-gradient-to-r from-blue-500 to-blue-700 text-white py-3 rounded-xl font-semibold hover:shadow-lg transition flex items-center justify-center">' +
                  '<span class="mr-2">✅</span> Validator' +
                '</button>' +
              '</div>' +
              '<button onclick="closeAuthModal()" class="mt-6 text-gray-400 hover:text-white">Close</button>' +
            '</div>';
          modalContent.innerHTML = loginHtml;
        } else if (mode === 'register') {
          showAuthModal('login');
        }
      }

      function closeAuthModal() {
        const modal = document.getElementById('auth-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      function loginWithGoogle(role) {
        window.location.href = '/api/auth/google?role=' + role;
      }

      // Close modal on outside click
      document.getElementById('auth-modal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeAuthModal();
        }
      });
    <\/script>
</body>
</html>
  `));G.get("/project/:id",async e=>(e.req.param("id"),e.html(`
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto - ValidAI Studio</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#6366f1',
              primary: '#4F9BFF',
              secondary: '#FF6B9D',
              accent: '#FFB84F',
              purple: '#9D7BFF',
              cosmic: {
                dark: '#0a0a1a',
                darker: '#050510',
                purple: '#1a1a3e',
                blue: '#0d1b2a'
              }
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
              display: ['Space Grotesk', 'system-ui', 'sans-serif'],
            }
          }
        }
      }
    <\/script>
    <style>
      * {
        font-family: 'Inter', system-ui, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      h1, h2, h3, h4, .font-display {
        font-family: 'Space Grotesk', system-ui, sans-serif;
      }
      
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      
      /* Cosmic Background */
      .cosmic-bg {
        background: linear-gradient(180deg, #050510 0%, #0a0a1a 50%, #1a1a3e 100%);
        position: relative;
        overflow-x: hidden;
      }
      
      /* Stars Animation */
      .stars {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
      }
      
      .stars::before,
      .stars::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: 
          radial-gradient(2px 2px at 20px 30px, #fff, transparent),
          radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
          radial-gradient(1px 1px at 90px 40px, #fff, transparent),
          radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.9), transparent),
          radial-gradient(1px 1px at 230px 80px, #fff, transparent),
          radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.7), transparent),
          radial-gradient(1px 1px at 370px 200px, #fff, transparent),
          radial-gradient(2px 2px at 450px 60px, rgba(255,255,255,0.8), transparent),
          radial-gradient(1px 1px at 520px 180px, #fff, transparent),
          radial-gradient(2px 2px at 600px 100px, rgba(255,255,255,0.9), transparent),
          radial-gradient(1px 1px at 680px 250px, #fff, transparent),
          radial-gradient(2px 2px at 750px 30px, rgba(255,255,255,0.7), transparent),
          radial-gradient(1px 1px at 830px 170px, #fff, transparent),
          radial-gradient(2px 2px at 900px 220px, rgba(255,255,255,0.8), transparent),
          radial-gradient(1px 1px at 970px 90px, #fff, transparent);
        background-repeat: repeat;
        background-size: 1000px 300px;
        animation: twinkle 8s ease-in-out infinite;
      }
      
      .stars::after {
        background-image: 
          radial-gradient(1px 1px at 50px 100px, #fff, transparent),
          radial-gradient(2px 2px at 120px 200px, rgba(255,255,255,0.6), transparent),
          radial-gradient(1px 1px at 200px 50px, #fff, transparent),
          radial-gradient(2px 2px at 280px 180px, rgba(255,255,255,0.8), transparent),
          radial-gradient(1px 1px at 350px 130px, #fff, transparent),
          radial-gradient(2px 2px at 420px 80px, rgba(255,255,255,0.7), transparent),
          radial-gradient(1px 1px at 500px 240px, #fff, transparent),
          radial-gradient(2px 2px at 580px 160px, rgba(255,255,255,0.9), transparent),
          radial-gradient(1px 1px at 660px 40px, #fff, transparent),
          radial-gradient(2px 2px at 740px 280px, rgba(255,255,255,0.6), transparent);
        background-size: 800px 350px;
        animation: twinkle 12s ease-in-out infinite reverse;
      }
      
      @keyframes twinkle {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
      }
      
      /* Nebula Effect */
      .nebula {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.4;
        animation: nebula-float 20s ease-in-out infinite;
      }
      
      .nebula-1 {
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, rgba(139, 92, 246, 0.4) 0%, transparent 70%);
        top: -200px;
        right: -100px;
        animation-delay: 0s;
      }
      
      .nebula-2 {
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, rgba(6, 182, 212, 0.3) 0%, transparent 70%);
        bottom: 10%;
        left: -150px;
        animation-delay: -5s;
      }
      
      .nebula-3 {
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(245, 158, 11, 0.2) 0%, transparent 70%);
        top: 40%;
        right: 10%;
        animation-delay: -10s;
      }
      
      @keyframes nebula-float {
        0%, 100% { transform: translate(0, 0) scale(1); }
        25% { transform: translate(30px, -30px) scale(1.05); }
        50% { transform: translate(-20px, 20px) scale(0.95); }
        75% { transform: translate(20px, 30px) scale(1.02); }
      }
      
      /* Glow Effects */
      .glow-purple {
        box-shadow: 0 0 40px rgba(139, 92, 246, 0.3), 0 0 80px rgba(139, 92, 246, 0.2);
      }
      
      .glow-cyan {
        box-shadow: 0 0 40px rgba(6, 182, 212, 0.3), 0 0 80px rgba(6, 182, 212, 0.2);
      }
      
      .text-glow {
        text-shadow: 0 0 40px rgba(139, 92, 246, 0.5), 0 0 80px rgba(139, 92, 246, 0.3);
      }
      
      /* Gradient Text */
      .text-gradient-cosmic {
        background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 50%, #F59E0B 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .text-gradient-purple {
        background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      /* Button Styles */
      .btn-cosmic {
        background: linear-gradient(135deg, #8B5CF6 0%, #06B6D4 100%);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      
      .btn-cosmic::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
      }
      
      .btn-cosmic:hover::before {
        left: 100%;
      }
      
      .btn-cosmic:hover {
        transform: translateY(-3px);
        box-shadow: 0 20px 40px -10px rgba(139, 92, 246, 0.5);
      }
      
      .btn-outline-cosmic {
        border: 2px solid rgba(139, 92, 246, 0.5);
        background: rgba(139, 92, 246, 0.1);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }
      
      .btn-outline-cosmic:hover {
        border-color: #8B5CF6;
        background: rgba(139, 92, 246, 0.2);
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
      }
      
      /* Card Styles */
      .card-cosmic {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .card-cosmic:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(139, 92, 246, 0.3);
        transform: translateY(-8px);
        box-shadow: 0 25px 50px -12px rgba(139, 92, 246, 0.25);
      }
      
      /* Navigation */
      .nav-cosmic {
        backdrop-filter: blur(20px);
        background: rgba(10, 10, 26, 0.8);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      /* Floating Animation */
      @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(2deg); }
      }
      
      .float-animation {
        animation: float 6s ease-in-out infinite;
      }
      
      /* Planet/Orbit Animation */
      @keyframes orbit {
        0% { transform: rotate(0deg) translateX(150px) rotate(0deg); }
        100% { transform: rotate(360deg) translateX(150px) rotate(-360deg); }
      }
      
      .orbit-animation {
        animation: orbit 30s linear infinite;
      }
      
      /* Pulse Animation */
      @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); }
        50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8), 0 0 60px rgba(6, 182, 212, 0.4); }
      }
      
      .pulse-glow {
        animation: pulse-glow 3s ease-in-out infinite;
      }
      
      /* Shooting Star */
      @keyframes shooting-star {
        0% { transform: translateX(0) translateY(0); opacity: 1; }
        70% { opacity: 1; }
        100% { transform: translateX(300px) translateY(300px); opacity: 0; }
      }
      
      .shooting-star {
        position: absolute;
        width: 100px;
        height: 2px;
        background: linear-gradient(90deg, #fff, transparent);
        animation: shooting-star 3s ease-in-out infinite;
      }
      
      /* Stats Counter */
      .stat-number {
        font-variant-numeric: tabular-nums;
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .nebula {
          opacity: 0.2;
        }
        .nebula-1 { width: 300px; height: 300px; }
        .nebula-2 { width: 250px; height: 250px; }
        .nebula-3 { width: 200px; height: 200px; }
      }
    </style>
</head>
<body class="cosmic-bg min-h-screen text-white">
    <!-- Cosmic Background Effects -->
    <div class="stars"></div>
    <div class="nebula nebula-1"></div>
    <div class="nebula nebula-2"></div>
    <div class="nebula nebula-3"></div>
    
    <!-- Shooting Stars -->
    <div class="shooting-star" style="top: 10%; left: 20%; animation-delay: 0s;"></div>
    <div class="shooting-star" style="top: 30%; left: 60%; animation-delay: 2s;"></div>
    <div class="shooting-star" style="top: 50%; left: 10%; animation-delay: 4s;"></div>

    <!-- Navigation -->
    <nav class="nav-cosmic sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 relative">
                <div class="flex items-center">
                    <a href="/" class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center glow-purple">
                            <span class="text-white font-bold text-xl">✦</span>
                        </div>
                        <span class="text-2xl font-display font-bold text-gradient-cosmic">
                            ASTAR* Labs
                        </span>
                    </a>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="#journey" class="text-gray-300 hover:text-white transition font-medium">Journey</a>
                    <a href="#features" class="text-gray-300 hover:text-white transition font-medium">Features</a>
                    <a href="/marketplace" class="text-gray-300 hover:text-white transition font-medium flex items-center">
                        <i class="fas fa-rocket mr-2 text-primary"></i>Hub
                    </a>
                    <a href="/leaderboard" class="text-gray-300 hover:text-white transition font-medium flex items-center">
                        <i class="fas fa-trophy mr-2 text-accent"></i>Leaderboard
                    </a>
                    <div class="nav-auth-buttons flex items-center space-x-3 ml-4">
                        <button onclick="showAuthModal('login')" class="text-gray-300 hover:text-white transition font-medium px-4 py-2">
                            Sign In
                        </button>
                        <button onclick="showAuthModal('register')" class="btn-cosmic text-white px-6 py-2.5 rounded-xl font-semibold">
                            Launch Now
                        </button>
                    </div>
                </div>
                
                <!-- Mobile menu toggle -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="cursor-pointer p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-all duration-200 text-white">
                        <i class="fas fa-bars text-xl" id="menu-icon-bars"></i>
                        <i class="fas fa-times text-xl hidden" id="menu-icon-close"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <div class="hidden md:hidden bg-cosmic-dark/95 backdrop-blur-xl border-t border-white/10" id="mobile-menu-container">
            <div class="max-w-7xl mx-auto px-4 py-6 space-y-2">
                <a href="#journey" class="flex items-center px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 transition rounded-xl font-medium">
                    <i class="fas fa-route mr-3 text-lg text-primary"></i>Journey
                </a>
                <a href="#features" class="flex items-center px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 transition rounded-xl font-medium">
                    <i class="fas fa-star mr-3 text-lg text-secondary"></i>Features
                </a>
                <a href="/marketplace" class="flex items-center px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 transition rounded-xl font-medium">
                    <i class="fas fa-rocket mr-3 text-lg text-primary"></i>Hub
                </a>
                <a href="/leaderboard" class="flex items-center px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 transition rounded-xl font-medium">
                    <i class="fas fa-trophy mr-3 text-accent text-lg"></i>Leaderboard
                </a>
                <div class="border-t border-white/10 pt-4 mt-4 space-y-2">
                    <button onclick="showAuthModal('login');" class="w-full flex items-center px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 transition rounded-xl font-medium text-left">
                        <i class="fas fa-sign-in-alt mr-3 text-lg"></i>Sign In
                    </button>
                    <button onclick="showAuthModal('register');" class="w-full flex items-center px-4 py-3 btn-cosmic text-white rounded-xl font-bold text-left justify-center">
                        <i class="fas fa-rocket mr-3 text-lg"></i>Launch Now
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <script>
        // Mobile menu toggle
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenuContainer = document.getElementById('mobile-menu-container');
        const menuIconBars = document.getElementById('menu-icon-bars');
        const menuIconClose = document.getElementById('menu-icon-close');
        
        if (mobileMenuButton && mobileMenuContainer) {
            mobileMenuButton.addEventListener('click', function() {
                mobileMenuContainer.classList.toggle('hidden');
                menuIconBars.classList.toggle('hidden');
                menuIconClose.classList.toggle('hidden');
            });
            
            const menuLinks = mobileMenuContainer.querySelectorAll('a, button');
            menuLinks.forEach(link => {
                link.addEventListener('click', function() {
                    mobileMenuContainer.classList.add('hidden');
                    menuIconBars.classList.remove('hidden');
                    menuIconClose.classList.add('hidden');
                });
            });
        }
    <\/script>

    <!-- Hero Section - ASTAR* Simple Design -->
    <section class="relative min-h-screen flex flex-col items-center justify-center overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 py-20 sm:py-32 sm:px-6 lg:px-8 relative z-10 text-center">
            <!-- Large ASTAR* Logo -->
            <h1 class="font-display text-8xl sm:text-9xl md:text-[12rem] font-bold mb-12 leading-none tracking-tight">
                <span class="text-white">ASTAR</span><span class="text-primary text-glow">*</span>
            </h1>
            
            <!-- Tagline -->
            <p class="text-2xl sm:text-3xl md:text-4xl mb-16 text-gray-300 font-medium">
                Connecting the brightest minds in the universe
            </p>
            
            <!-- CTA Button -->
            <button onclick="showAuthModal('register')" class="btn-cosmic text-white px-12 py-6 rounded-full font-bold text-xl inline-flex items-center justify-center group mb-8 pulse-glow">
                <span class="mr-2">Sign Up</span>
                <span class="text-2xl">⭐</span>
            </button>
            
            <!-- Scroll indicator -->
            <div class="mt-20">
                <div class="inline-flex flex-col items-center text-gray-400">
                    <i class="fas fa-chevron-down text-2xl mb-2 animate-bounce"></i>
                    <span class="text-sm">Or scroll to explore</span>
                </div>
            </div>
        </div>
        
        <!-- Floating Elements -->
        <div class="absolute top-1/4 left-10 w-4 h-4 rounded-full bg-primary float-animation opacity-60" style="animation-delay: 0s;"></div>
        <div class="absolute top-1/3 right-20 w-3 h-3 rounded-full bg-secondary float-animation opacity-50" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-1/4 left-1/4 w-5 h-5 rounded-full bg-accent float-animation opacity-40" style="animation-delay: 2s;"></div>
        <div class="absolute bottom-1/3 right-1/4 w-2 h-2 rounded-full bg-white float-animation opacity-60" style="animation-delay: 3s;"></div>
    </section>

    <!-- User Type Selection Section -->
    <section class="relative py-32 border-t border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-16">
                <h2 class="font-display text-4xl sm:text-5xl font-bold text-white mb-4">
                    Welcome to the ASTAR* ecosystem!
                </h2>
                <h3 class="font-display text-3xl font-bold text-white mb-6">
                    Choose your trajectory 🚀
                </h3>
                <p class="text-xl text-gray-400 max-w-3xl mx-auto">
                    We make thoughtful introductions between startup founders, customers, investors, partners and talent. Which role defines your mission in the ASTAR* ecosystem?
                </p>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                <!-- FOUNDER -->
                <button onclick="loginWithGoogle('founder')" class="group relative overflow-hidden rounded-3xl p-8 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #B8C6DB 0%, #A8B8D0 100%);">
                    <div class="relative z-10 flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full bg-white/30 flex items-center justify-center mb-6 transition-transform group-hover:scale-110">
                            <span class="text-5xl">⚪</span>
                        </div>
                        <div class="px-6 py-2 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                            <span class="text-white text-sm font-bold uppercase tracking-wide">Founder</span>
                        </div>
                        <h3 class="font-display font-bold text-gray-900 text-xl mb-2">FOUNDER</h3>
                        <p class="text-gray-700 text-sm">Building the next big thing in the universe</p>
                    </div>
                </button>
                
                <!-- INVESTOR -->
                <button onclick="loginWithGoogle('investor')" class="group relative overflow-hidden rounded-3xl p-8 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #5DE0E6 0%, #4DD4DA 100%);">
                    <div class="relative z-10 flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full bg-white/30 flex items-center justify-center mb-6 transition-transform group-hover:scale-110">
                            <span class="text-5xl">🌐</span>
                        </div>
                        <div class="px-6 py-2 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                            <span class="text-white text-sm font-bold uppercase tracking-wide">Investor</span>
                        </div>
                        <h3 class="font-display font-bold text-gray-900 text-xl mb-2">INVESTOR</h3>
                        <p class="text-gray-700 text-sm">Fueling stellar growth with capital</p>
                    </div>
                </button>
                
                <!-- SCOUT -->
                <button onclick="loginWithGoogle('scout')" class="group relative overflow-hidden rounded-3xl p-8 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #A78BFA 0%, #9B7DF5 100%);">
                    <div class="relative z-10 flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full bg-white/30 flex items-center justify-center mb-6 transition-transform group-hover:scale-110">
                            <span class="text-5xl">🟣</span>
                        </div>
                        <div class="px-6 py-2 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                            <span class="text-white text-sm font-bold uppercase tracking-wide">Scout</span>
                        </div>
                        <h3 class="font-display font-bold text-gray-900 text-xl mb-2">SCOUT</h3>
                        <p class="text-gray-700 text-sm">Finding hidden gems and opportunities</p>
                    </div>
                </button>
                
                <!-- PARTNER -->
                <button onclick="loginWithGoogle('partner')" class="group relative overflow-hidden rounded-3xl p-8 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #FF6B9D 0%, #FF5A8F 100%);">
                    <div class="relative z-10 flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full bg-white/30 flex items-center justify-center mb-6 transition-transform group-hover:scale-110">
                            <span class="text-5xl">🔴</span>
                        </div>
                        <div class="px-6 py-2 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                            <span class="text-white text-sm font-bold uppercase tracking-wide">Partner</span>
                        </div>
                        <h3 class="font-display font-bold text-gray-900 text-xl mb-2">PARTNER</h3>
                        <p class="text-gray-700 text-sm">I want to partner/sponsor/collab with ASTAR*</p>
                    </div>
                </button>
                
                <!-- JOB SEEKER -->
                <button onclick="loginWithGoogle('job_seeker')" class="group relative overflow-hidden rounded-3xl p-8 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #FFB84F 0%, #FFA940 100%);">
                    <div class="relative z-10 flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full bg-white/30 flex items-center justify-center mb-6 transition-transform group-hover:scale-110">
                            <span class="text-5xl">🟠</span>
                        </div>
                        <div class="px-6 py-2 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                            <span class="text-white text-sm font-bold uppercase tracking-wide">Job Seeker</span>
                        </div>
                        <h3 class="font-display font-bold text-gray-900 text-xl mb-2">JOB SEEKER</h3>
                        <p class="text-gray-700 text-sm">Looking for a job at a promising startup</p>
                    </div>
                </button>
                
                <!-- OTHER -->
                <button onclick="loginWithGoogle('other')" class="group relative overflow-hidden rounded-3xl p-8 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #4A5568 0%, #3A4558 100%);">
                    <div class="relative z-10 flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full bg-white/30 flex items-center justify-center mb-6 transition-transform group-hover:scale-110">
                            <span class="text-5xl">🔵</span>
                        </div>
                        <div class="px-6 py-2 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                            <span class="text-white text-sm font-bold uppercase tracking-wide">Other</span>
                        </div>
                        <h3 class="font-display font-bold text-gray-100 text-xl mb-2">OTHER</h3>
                        <p class="text-gray-300 text-sm">I am curious about the ASTAR* ecosystem</p>
                    </div>
                </button>
            </div>
        </div>
    </section>

    <!-- Journey Section -->
    <section id="journey" class="relative py-32">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-20">
                <span class="text-primary font-semibold text-sm tracking-wider uppercase mb-4 block">Your Cosmic Journey</span>
                <h2 class="font-display text-4xl sm:text-5xl font-bold text-white mb-6">
                    From Idea to <span class="text-gradient-cosmic">Orbit</span>
                </h2>
                <p class="text-xl text-gray-400 max-w-2xl mx-auto">
                    Navigate through the startup universe with our proven 5-step launch sequence
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                <div class="card-cosmic rounded-2xl p-8 text-center group">
                    <div class="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center pulse-glow">
                        <span class="text-2xl font-bold text-white">1</span>
                    </div>
                    <h3 class="text-xl font-display font-bold mb-3 text-white group-hover:text-primary transition">Ignition</h3>
                    <p class="text-gray-400 mb-4 text-sm">Share your idea and target market details</p>
                    <div class="text-primary font-semibold text-sm">
                        <i class="fas fa-clock mr-1"></i>5 minutes
                    </div>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 text-center group">
                    <div class="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center pulse-glow" style="animation-delay: 0.5s;">
                        <span class="text-2xl font-bold text-white">2</span>
                    </div>
                    <h3 class="text-xl font-display font-bold mb-3 text-white group-hover:text-primary transition">AI Analysis</h3>
                    <p class="text-gray-400 mb-4 text-sm">Our AI scans the market universe for opportunities</p>
                    <div class="text-secondary font-semibold text-sm">
                        <i class="fas fa-robot mr-1"></i>Instant
                    </div>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 text-center group">
                    <div class="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center pulse-glow" style="animation-delay: 1s;">
                        <span class="text-2xl font-bold text-white">3</span>
                    </div>
                    <h3 class="text-xl font-display font-bold mb-3 text-white group-hover:text-primary transition">Validation</h3>
                    <p class="text-gray-400 mb-4 text-sm">Expert validators provide stellar feedback</p>
                    <div class="text-accent font-semibold text-sm">
                        <i class="fas fa-users mr-1"></i>24-48h
                    </div>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 text-center group">
                    <div class="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center pulse-glow" style="animation-delay: 1.5s;">
                        <span class="text-2xl font-bold text-white">4</span>
                    </div>
                    <h3 class="text-xl font-display font-bold mb-3 text-white group-hover:text-primary transition">Beta Testing</h3>
                    <p class="text-gray-400 mb-4 text-sm">Real users test your product in the wild</p>
                    <div class="text-green-400 font-semibold text-sm">
                        <i class="fas fa-vial mr-1"></i>1 week
                    </div>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 text-center group">
                    <div class="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center pulse-glow" style="animation-delay: 2s;">
                        <span class="text-2xl font-bold text-white">5</span>
                    </div>
                    <h3 class="text-xl font-display font-bold mb-3 text-white group-hover:text-primary transition">Orbit</h3>
                    <p class="text-gray-400 mb-4 text-sm">Launch with data-driven confidence</p>
                    <div class="text-primary font-semibold text-sm">
                        <i class="fas fa-chart-line mr-1"></i>Dashboard
                    </div>
                </div>
            </div>
            
            <!-- CTA Card -->
            <div class="mt-20 card-cosmic rounded-3xl p-10 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-primary/20 to-secondary/20"></div>
                <div class="relative z-10 flex flex-col md:flex-row items-center justify-between">
                    <div class="mb-8 md:mb-0 text-center md:text-left">
                        <h3 class="font-display text-3xl font-bold text-white mb-3 flex items-center justify-center md:justify-start">
                            <span class="text-4xl mr-3">✦</span>
                            ASTAR Hub
                        </h3>
                        <p class="text-xl text-gray-300">Your mission control for startup success</p>
                    </div>
                    <a href="/marketplace" class="btn-cosmic text-white px-10 py-5 rounded-2xl font-bold text-lg inline-flex items-center">
                        Enter Hub <i class="fas fa-arrow-right ml-3"></i>
                    </a>
                </div>
            </div>
        </div>
    </section>

        <!-- Validation Form (Hidden by default) - Cosmic Theme -->
        <div id="validation-form-section" class="hidden fixed inset-0 z-50 overflow-y-auto" style="background: rgba(5, 5, 16, 0.95); backdrop-filter: blur(10px);">
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="max-w-2xl w-full">
                    <!-- Close Button -->
                    <button onclick="hideValidationForm()" class="absolute top-6 right-6 text-gray-400 hover:text-white transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                    
                    <!-- Step Indicator -->
                    <div class="flex justify-center items-center mb-8 space-x-3 flex-wrap">
                        <div class="flex items-center">
                            <div id="step-indicator-1" class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm">1</div>
                            <span class="ml-2 font-medium text-white text-sm">Pitch</span>
                        </div>
                        <div class="w-8 h-0.5 bg-white/20"></div>
                        <div class="flex items-center">
                            <div id="step-indicator-2" class="w-10 h-10 rounded-full bg-white/10 text-gray-400 flex items-center justify-center font-bold text-sm">2</div>
                            <span class="ml-2 font-medium text-gray-400 text-sm">Analysis</span>
                        </div>
                        <div class="w-8 h-0.5 bg-white/20"></div>
                        <div class="flex items-center">
                            <div id="step-indicator-3" class="w-10 h-10 rounded-full bg-white/10 text-gray-400 flex items-center justify-center font-bold text-sm">3</div>
                            <span class="ml-2 font-medium text-gray-400 text-sm">Hub</span>
                        </div>
                        <div class="w-8 h-0.5 bg-white/20"></div>
                        <div class="flex items-center">
                            <div id="step-indicator-4" class="w-10 h-10 rounded-full bg-white/10 text-gray-400 flex items-center justify-center font-bold text-sm">4</div>
                            <span class="ml-2 font-medium text-gray-400 text-sm">Launch</span>
                        </div>
                    </div>

                    <!-- Step 1: Pitch Form -->
                    <div id="quick-pitch-step-1" class="card-cosmic rounded-3xl p-8">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center mx-auto mb-4 pulse-glow">
                                <i class="fas fa-rocket text-white text-2xl"></i>
                            </div>
                            <h2 class="font-display text-3xl font-bold text-white mb-3">Launch Your Idea</h2>
                            <p class="text-gray-400">Get instant AI analysis and join the ASTAR Hub</p>
                            <div class="inline-flex items-center mt-4 px-4 py-2 rounded-full bg-green-500/10 border border-green-500/30">
                                <i class="fas fa-sparkles text-green-400 mr-2"></i>
                                <span class="text-green-400 font-medium text-sm">Free AI Analysis</span>
                            </div>
                        </div>
                        
                        <form id="quick-pitch-form" class="space-y-5" onsubmit="event.preventDefault(); submitQuickPitchForm();">
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-2">
                                    <i class="fas fa-lightbulb text-primary mr-2"></i>What's your startup idea?
                                </label>
                                <textarea id="pitch-idea" required rows="3"
                                          class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition"
                                          placeholder="A mobile app that connects freelance designers with small businesses..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-2">
                                    <i class="fas fa-crosshairs text-secondary mr-2"></i>What problem does it solve?
                                </label>
                                <textarea id="pitch-problem" required rows="3"
                                          class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition"
                                          placeholder="Small businesses struggle to find affordable, quality design services..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-2">
                                    <i class="fas fa-users text-accent mr-2"></i>Who is your target market?
                                </label>
                                <input id="pitch-market" type="text" required
                                       class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition"
                                       placeholder="Small businesses with 10-50 employees in the US" />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-300 mb-2">
                                    <i class="fas fa-dollar-sign text-green-400 mr-2"></i>What's your pricing model?
                                </label>
                                <select id="pitch-pricing-model" required
                                        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition appearance-none cursor-pointer">
                                    <option value="" class="bg-cosmic-dark">Select pricing model...</option>
                                    <option value="free" class="bg-cosmic-dark">Free</option>
                                    <option value="freemium" class="bg-cosmic-dark">Freemium (Free + Paid tiers)</option>
                                    <option value="one_time" class="bg-cosmic-dark">One-time Payment</option>
                                    <option value="subscription_monthly" class="bg-cosmic-dark">Monthly Subscription</option>
                                    <option value="subscription_yearly" class="bg-cosmic-dark">Yearly Subscription</option>
                                    <option value="usage_based" class="bg-cosmic-dark">Usage-based / Pay-as-you-go</option>
                                    <option value="enterprise" class="bg-cosmic-dark">Enterprise / Custom Pricing</option>
                                </select>
                            </div>
                            
                            <button type="submit"
                                    class="w-full btn-cosmic text-white px-8 py-5 rounded-xl font-bold text-lg">
                                <i class="fas fa-rocket mr-2"></i>Launch Analysis
                            </button>
                        </form>
                    </div>

                    <!-- Step 2: AI Analysis -->
                    <div id="quick-pitch-step-2" class="hidden card-cosmic rounded-3xl p-8">
                        <div class="text-center">
                            <div class="relative w-32 h-32 mx-auto mb-6">
                                <div class="absolute inset-0 rounded-full bg-gradient-to-r from-primary to-secondary animate-spin" style="animation-duration: 3s;"></div>
                                <div class="absolute inset-2 rounded-full bg-cosmic-dark flex items-center justify-center">
                                    <i class="fas fa-brain text-primary text-4xl"></i>
                                </div>
                            </div>
                            <h3 class="font-display text-2xl font-bold text-white mb-3">Analyzing Your Idea...</h3>
                            <p class="text-gray-400">Our AI is scanning the market universe for opportunities</p>
                            
                            <div class="flex justify-center space-x-2 mt-8">
                                <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                                <div class="w-3 h-3 bg-secondary rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                                <div class="w-3 h-3 bg-accent rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Results -->
                    <div id="quick-pitch-step-3" class="hidden card-cosmic rounded-3xl p-8">
                        <div class="text-center mb-6">
                            <div class="w-20 h-20 bg-green-500 rounded-full mx-auto flex items-center justify-center mb-4">
                                <i class="fas fa-check text-white text-3xl"></i>
                            </div>
                            <h3 class="font-display text-2xl font-bold text-white mb-2">Analysis Complete!</h3>
                            <p class="text-gray-400">Your project is now live in the ASTAR Hub</p>
                        </div>
                        
                        <div id="analysis-results-container" class="space-y-4 text-white">
                            <!-- AI analysis results will be inserted here -->
                        </div>

                        <div class="mt-8 text-center">
                            <p class="text-primary font-medium mb-4">
                                <i class="fas fa-rocket mr-2"></i>
                                Launching in <span id="redirect-countdown">5</span> seconds...
                            </p>
                            <button onclick="redirectToDashboard()" class="btn-cosmic text-white px-8 py-4 rounded-xl font-bold">
                                Go to Mission Control
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Features Section -->
    <section id="features" class="relative py-32">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-20">
                <span class="text-secondary font-semibold text-sm tracking-wider uppercase mb-4 block">Superpowers</span>
                <h2 class="font-display text-4xl sm:text-5xl font-bold text-white mb-6">
                    Your <span class="text-gradient-cosmic">Cosmic Toolkit</span>
                </h2>
                <p class="text-xl text-gray-400 max-w-2xl mx-auto">
                    Everything you need to navigate the startup universe
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="card-cosmic rounded-2xl p-8 group">
                    <div class="w-14 h-14 mb-6 rounded-2xl bg-primary/20 flex items-center justify-center group-hover:bg-primary/30 transition">
                        <i class="fas fa-brain text-primary text-2xl"></i>
                    </div>
                    <h3 class="font-display text-xl font-bold text-white mb-3">AI Analysis Engine</h3>
                    <p class="text-gray-400 leading-relaxed">Advanced AI that analyzes market trends, competitors, and opportunities in real-time</p>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 group">
                    <div class="w-14 h-14 mb-6 rounded-2xl bg-secondary/20 flex items-center justify-center group-hover:bg-secondary/30 transition">
                        <i class="fas fa-users text-secondary text-2xl"></i>
                    </div>
                    <h3 class="font-display text-xl font-bold text-white mb-3">Expert Validators</h3>
                    <p class="text-gray-400 leading-relaxed">Connect with 500+ industry experts who provide actionable feedback</p>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 group">
                    <div class="w-14 h-14 mb-6 rounded-2xl bg-accent/20 flex items-center justify-center group-hover:bg-accent/30 transition">
                        <i class="fas fa-chart-line text-accent text-2xl"></i>
                    </div>
                    <h3 class="font-display text-xl font-bold text-white mb-3">Growth Dashboard</h3>
                    <p class="text-gray-400 leading-relaxed">Track your metrics, goals, and progress with beautiful visualizations</p>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 group">
                    <div class="w-14 h-14 mb-6 rounded-2xl bg-green-500/20 flex items-center justify-center group-hover:bg-green-500/30 transition">
                        <i class="fas fa-comments text-green-400 text-2xl"></i>
                    </div>
                    <h3 class="font-display text-xl font-bold text-white mb-3">Direct Messaging</h3>
                    <p class="text-gray-400 leading-relaxed">Communicate directly with validators and mentors in real-time</p>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 group">
                    <div class="w-14 h-14 mb-6 rounded-2xl bg-pink-500/20 flex items-center justify-center group-hover:bg-pink-500/30 transition">
                        <i class="fas fa-robot text-pink-400 text-2xl"></i>
                    </div>
                    <h3 class="font-display text-xl font-bold text-white mb-3">ASTAR Agent</h3>
                    <p class="text-gray-400 leading-relaxed">Get personalized marketing strategies powered by AI</p>
                </div>
                
                <div class="card-cosmic rounded-2xl p-8 group">
                    <div class="w-14 h-14 mb-6 rounded-2xl bg-blue-500/20 flex items-center justify-center group-hover:bg-blue-500/30 transition">
                        <i class="fas fa-trophy text-blue-400 text-2xl"></i>
                    </div>
                    <h3 class="font-display text-xl font-bold text-white mb-3">Leaderboard</h3>
                    <p class="text-gray-400 leading-relaxed">Compete with other startups and climb the rankings</p>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="relative py-32">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <div class="card-cosmic rounded-3xl p-12 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-primary/10 via-transparent to-secondary/10"></div>
                <div class="relative z-10">
                    <h2 class="font-display text-4xl sm:text-5xl font-bold text-white mb-6">
                        Ready to Launch?
                    </h2>
                    <p class="text-xl text-gray-400 mb-10 max-w-xl mx-auto">
                        Join thousands of founders who are already building the future with ASTAR* Labs
                    </p>
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="showValidationForm()" class="btn-cosmic text-white px-10 py-5 rounded-2xl font-bold text-lg inline-flex items-center justify-center">
                            <i class="fas fa-rocket mr-3"></i>
                            Start Your Journey
                        </button>
                        <a href="/marketplace" class="btn-outline-cosmic text-white px-10 py-5 rounded-2xl font-bold text-lg inline-flex items-center justify-center">
                            <i class="fas fa-compass mr-3"></i>
                            Explore Hub
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Auth Modal - Cosmic Theme -->
    <div id="auth-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" style="background: rgba(5, 5, 16, 0.95); backdrop-filter: blur(10px);">
        <div class="card-cosmic rounded-3xl max-w-5xl w-full max-h-[90vh] overflow-y-auto relative">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div id="auth-modal-content" class="p-8">
                <!-- Auth form will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Footer - Cosmic Theme -->
    <footer class="relative border-t border-white/5 py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-16">
                <div class="md:col-span-1">
                    <div class="flex items-center space-x-3 mb-6">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
                            <span class="text-white font-bold text-xl">✦</span>
                        </div>
                        <span class="text-xl font-display font-bold text-gradient-cosmic">ASTAR* Labs</span>
                    </div>
                    <p class="text-gray-400 leading-relaxed">Launching startups to the stars with AI-powered validation and expert networks.</p>
                </div>
                <div>
                    <h4 class="font-display font-bold mb-6 text-white">Product</h4>
                    <ul class="space-y-4 text-gray-400">
                        <li><a href="#journey" class="hover:text-primary transition">Journey</a></li>
                        <li><a href="#features" class="hover:text-primary transition">Features</a></li>
                        <li><a href="/marketplace" class="hover:text-primary transition">ASTAR Hub</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-display font-bold mb-6 text-white">Resources</h4>
                    <ul class="space-y-4 text-gray-400">
                        <li><a href="#" class="hover:text-primary transition">Blog</a></li>
                        <li><a href="#" class="hover:text-primary transition">Success Stories</a></li>
                        <li><a href="#" class="hover:text-primary transition">Documentation</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-display font-bold mb-6 text-white">Company</h4>
                    <ul class="space-y-4 text-gray-400">
                        <li><a href="#" class="hover:text-primary transition">About</a></li>
                        <li><a href="#" class="hover:text-primary transition">Careers</a></li>
                        <li><a href="#" class="hover:text-primary transition">Contact</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-white/10 pt-8 flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-500 text-sm">&copy; 2025 ASTAR* Labs. All rights reserved.</p>
                <div class="flex gap-6 mt-4 md:mt-0">
                    <a href="#" class="text-gray-400 hover:text-primary transition">
                        <i class="fab fa-twitter text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-primary transition">
                        <i class="fab fa-linkedin text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-primary transition">
                        <i class="fab fa-github text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"><\/script>
    <script src="/static/app.js"><\/script>
    <script src="/static/astar-notifications.js"><\/script>
    <script>
      // Mobile menu functions
      function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        const button = document.getElementById('mobile-menu-button');
        const icon = button ? button.querySelector('i') : null;

        if (!menu) {
          console.error('Mobile menu not found');
          return;
        }

        const isOpen = !menu.classList.contains('hidden');

        if (isOpen) {
          // Close menu
          menu.classList.add('hidden');
          if (icon) {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        } else {
          // Open menu
          menu.classList.remove('hidden');
          if (icon) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          }
        }
      }

      function closeMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        const button = document.getElementById('mobile-menu-button');
        const icon = button ? button.querySelector('i') : null;

        if (menu) {
          menu.classList.add('hidden');
        }
        if (icon) {
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        }
      }

      // Initialize mobile menu when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        const mobileButton = document.getElementById('mobile-menu-button');
        if (mobileButton) {
          mobileButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleMobileMenu();
          });
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
          const menu = document.getElementById('mobile-menu');
          const button = document.getElementById('mobile-menu-button');

          if (menu && button &&
              !menu.contains(event.target) &&
              !button.contains(event.target) &&
              !menu.classList.contains('hidden')) {
            closeMobileMenu();
          }
        });

        // Close menu on escape key
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape') {
            closeMobileMenu();
          }
        });
      });

      // Show validation form - Cosmic Modal
      function showValidationForm() {
        const section = document.getElementById('validation-form-section');
        if (section) {
          section.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      }
      
      // Hide validation form
      function hideValidationForm() {
        const section = document.getElementById('validation-form-section');
        if (section) {
          section.classList.add('hidden');
          document.body.style.overflow = '';
          // Reset form
          document.getElementById('quick-pitch-step-1')?.classList.remove('hidden');
          document.getElementById('quick-pitch-step-2')?.classList.add('hidden');
          document.getElementById('quick-pitch-step-3')?.classList.add('hidden');
          updateStepIndicator(1);
        }
      }

      // Scroll to section
      function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      // Show role selection for Google login
      // Login with Google as founder
      function loginAsFounder() {
        loginWithGoogle('founder');
      }

      // Login with Google as validator
      function loginAsValidator() {
        loginWithGoogle('validator');
      }

      function showRoleSelection(action) {
        const modal = document.getElementById('auth-modal');
        const modalContent = document.getElementById('auth-modal-content');

        if (!modal || !modalContent) return;

        modal.classList.remove('hidden');

        const title = action === 'login' ? 'Sign In with Google' : 'Sign Up with Google';
        const description = action === 'login' ? 'Choose your role to continue' : 'Choose your role to register';
        const backAction = action === 'login' ? 'login' : 'register';

        modalContent.innerHTML = '<div class="text-center">' +
          '<i class="fab fa-google text-5xl mb-4" style="background: linear-gradient(45deg, #FF6154, #FB651E); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>' +
          '<h2 class="text-3xl font-black text-gray-900 mb-2">' + title + '</h2>' +
          '<p class="text-gray-600 mb-8 font-medium">' + description + '</p>' +
          '<div class="space-y-4">' +
          '<button onclick="loginAsFounder()" class="w-full bg-gradient-to-r from-primary to-secondary hover:shadow-xl text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center space-x-3">' +
          '<i class="fas fa-lightbulb text-2xl"></i>' +
          '<span class="text-lg">Founder - Create & Validate Projects</span>' +
          '</button>' +
          '<button onclick="loginAsValidator()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:shadow-xl text-white font-bold py-4 px-6 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center space-x-3">' +
          '<i class="fas fa-star text-2xl"></i>' +
          '<span class="text-lg">Validator - Vote & Rate Projects</span>' +
          '</button>' +
          '</div>' +
          '<button onclick="closeAuthModal()" class="mt-6 text-gray-600 hover:text-primary font-semibold">' +
          '← Back' +
          '</button>' +
          '</div>';
      }

      // Show auth modal - Cosmic Theme with User Type Selection
      function showAuthModal(mode) {
        const modal = document.getElementById('auth-modal');
        const modalContent = document.getElementById('auth-modal-content');

        if (!modal || !modalContent) return;

        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        if (mode === 'login') {
          const loginHtml = '<div class="text-center max-w-2xl mx-auto">' +
            '<div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center pulse-glow">' +
              '<span class="text-white text-3xl">✦</span>' +
            '</div>' +
            '<h2 class="font-display text-3xl font-bold text-white mb-2">Welcome to the ASTAR* ecosystem!</h2>' +
            '<h3 class="font-display text-2xl font-bold text-white mb-4">Choose your trajectory 🚀</h3>' +
            '<p class="text-gray-400 mb-8 text-sm">We make thoughtful introductions between startup founders, customers, investors, partners and talent. Which role defines your mission in the ASTAR* ecosystem?</p>' +
            '<div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">' +
              '<!-- FOUNDER -->' +
              '<button onclick="loginWithGoogle(\\'founder\\')" class="group relative overflow-hidden rounded-2xl p-6 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #B8C6DB 0%, #A8B8D0 100%);">' +
                '<div class="relative z-10 flex flex-col items-center">' +
                  '<div class="w-20 h-20 rounded-full bg-white/30 flex items-center justify-center mb-4 transition-transform group-hover:scale-110">' +
                    '<span class="text-4xl">⚪</span>' +
                  '</div>' +
                  '<div class="w-16 h-6 bg-gray-700 rounded-full flex items-center justify-center mb-3">' +
                    '<span class="text-white text-xs font-bold uppercase tracking-wide">Founder</span>' +
                  '</div>' +
                  '<h3 class="font-bold text-gray-900 text-sm mb-1">FOUNDER</h3>' +
                  '<p class="text-gray-700 text-xs">Building the next big thing in the universe</p>' +
                '</div>' +
              '</button>' +
              '<!-- INVESTOR -->' +
              '<button onclick="loginWithGoogle(\\'investor\\')" class="group relative overflow-hidden rounded-2xl p-6 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #5DE0E6 0%, #4DD4DA 100%);">' +
                '<div class="relative z-10 flex flex-col items-center">' +
                  '<div class="w-20 h-20 rounded-full bg-white/30 flex items-center justify-center mb-4 transition-transform group-hover:scale-110">' +
                    '<span class="text-4xl">🌐</span>' +
                  '</div>' +
                  '<div class="w-16 h-6 bg-gray-700 rounded-full flex items-center justify-center mb-3">' +
                    '<span class="text-white text-xs font-bold uppercase tracking-wide">Investor</span>' +
                  '</div>' +
                  '<h3 class="font-bold text-gray-900 text-sm mb-1">INVESTOR</h3>' +
                  '<p class="text-gray-700 text-xs">Fueling stellar growth with capital</p>' +
                '</div>' +
              '</button>' +
              '<!-- SCOUT -->' +
              '<button onclick="loginWithGoogle(\\'scout\\')" class="group relative overflow-hidden rounded-2xl p-6 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #A78BFA 0%, #9B7DF5 100%);">' +
                '<div class="relative z-10 flex flex-col items-center">' +
                  '<div class="w-20 h-20 rounded-full bg-white/30 flex items-center justify-center mb-4 transition-transform group-hover:scale-110">' +
                    '<span class="text-4xl">🟣</span>' +
                  '</div>' +
                  '<div class="w-16 h-6 bg-gray-700 rounded-full flex items-center justify-center mb-3">' +
                    '<span class="text-white text-xs font-bold uppercase tracking-wide">Scout</span>' +
                  '</div>' +
                  '<h3 class="font-bold text-gray-900 text-sm mb-1">SCOUT</h3>' +
                  '<p class="text-gray-700 text-xs">Finding hidden gems and opportunities</p>' +
                '</div>' +
              '</button>' +
              '<!-- PARTNER -->' +
              '<button onclick="loginWithGoogle(\\'partner\\')" class="group relative overflow-hidden rounded-2xl p-6 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #FF6B9D 0%, #FF5A8F 100%);">' +
                '<div class="relative z-10 flex flex-col items-center">' +
                  '<div class="w-20 h-20 rounded-full bg-white/30 flex items-center justify-center mb-4 transition-transform group-hover:scale-110">' +
                    '<span class="text-4xl">🔴</span>' +
                  '</div>' +
                  '<div class="w-16 h-6 bg-gray-700 rounded-full flex items-center justify-center mb-3">' +
                    '<span class="text-white text-xs font-bold uppercase tracking-wide">Partner</span>' +
                  '</div>' +
                  '<h3 class="font-bold text-gray-900 text-sm mb-1">PARTNER</h3>' +
                  '<p class="text-gray-700 text-xs">I want to partner/sponsor/collab with ASTAR*</p>' +
                '</div>' +
              '</button>' +
              '<!-- JOB SEEKER -->' +
              '<button onclick="loginWithGoogle(\\'job_seeker\\')" class="group relative overflow-hidden rounded-2xl p-6 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #FFB84F 0%, #FFA940 100%);">' +
                '<div class="relative z-10 flex flex-col items-center">' +
                  '<div class="w-20 h-20 rounded-full bg-white/30 flex items-center justify-center mb-4 transition-transform group-hover:scale-110">' +
                    '<span class="text-4xl">🟠</span>' +
                  '</div>' +
                  '<div class="w-16 h-6 bg-gray-700 rounded-full flex items-center justify-center mb-3">' +
                    '<span class="text-white text-xs font-bold uppercase tracking-wide">Job Seeker</span>' +
                  '</div>' +
                  '<h3 class="font-bold text-gray-900 text-sm mb-1">JOB SEEKER</h3>' +
                  '<p class="text-gray-700 text-xs">Looking for a job at a promising startup</p>' +
                '</div>' +
              '</button>' +
              '<!-- OTHER -->' +
              '<button onclick="loginWithGoogle(\\'other\\')" class="group relative overflow-hidden rounded-2xl p-6 transition-all hover:scale-105 cursor-pointer" style="background: linear-gradient(135deg, #4A5568 0%, #3A4558 100%);">' +
                '<div class="relative z-10 flex flex-col items-center">' +
                  '<div class="w-20 h-20 rounded-full bg-white/30 flex items-center justify-center mb-4 transition-transform group-hover:scale-110">' +
                    '<span class="text-4xl">🔵</span>' +
                  '</div>' +
                  '<div class="w-16 h-6 bg-gray-700 rounded-full flex items-center justify-center mb-3">' +
                    '<span class="text-white text-xs font-bold uppercase tracking-wide">Other</span>' +
                  '</div>' +
                  '<h3 class="font-bold text-gray-100 text-sm mb-1">OTHER</h3>' +
                  '<p class="text-gray-300 text-xs">I am curious about the ASTAR* ecosystem</p>' +
                '</div>' +
              '</button>' +
            '</div>' +
          '</div>';
          modalContent.innerHTML = loginHtml;
        } else if (mode === 'register') {
          // Same as login for now
          showAuthModal('login');
        }
      }

      // Close auth modal
      function closeAuthModal() {
        const modal = document.getElementById('auth-modal');
        if (modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      // Login with Google
      function loginWithGoogle(role) {
        window.location.href = '/api/auth/google?role=' + role;
      }

      // Handle traditional login
      async function handleTraditionalLogin(event) {
        event.preventDefault();

        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem('authToken', data.token);
            closeAuthModal();
            updateAuthUI();
            alert('¡Inicio de sesión exitoso!');
            // Redirect to dashboard
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 500);
          } else {
            alert('Error: ' + (data.error || 'No se pudo iniciar sesión'));
          }
        } catch (error) {
          console.error('Login error:', error);
          alert('Error al iniciar sesión. Inténtalo de nuevo.');
        }
      }

      // Handle traditional registration
      async function handleTraditionalRegistration(event) {
        event.preventDefault();

        const name = document.getElementById('reg-name').value;
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const role = document.getElementById('reg-role').value;

        try {
          const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name, email, password, role }),
          });

          const data = await response.json();

          if (response.ok) {
            localStorage.setItem('authToken', data.token);
            closeAuthModal();
            updateAuthUI();
            alert('¡Cuenta creada exitosamente!');
            // Redirect to dashboard
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 500);
          } else {
            alert('Error: ' + (data.error || 'No se pudo crear la cuenta'));
          }
        } catch (error) {
          console.error('Registration error:', error);
          alert('Error al crear la cuenta. Inténtalo de nuevo.');
        }
      }

      // Update authentication UI - Cosmic Theme
      function updateAuthUI() {
        const authToken = localStorage.getItem('authToken');
        const navButtons = document.querySelectorAll('.nav-auth-buttons');

        if (authToken) {
          // User is logged in - show hub and logout options
          const logoutHtml = '<a href="/marketplace" class="text-gray-300 hover:text-white transition font-medium mr-4">' +
            '<i class="fas fa-rocket mr-2 text-primary"></i>Hub' +
            '</a>' +
            '<button onclick="logout()" class="text-gray-300 hover:text-white transition font-medium">' +
            '<i class="fas fa-sign-out-alt mr-2"></i>Sign Out' +
            '</button>';
          navButtons.forEach(btn => {
            btn.innerHTML = logoutHtml;
          });
        } else {
          // User is not logged in - show login/register options
          const loginHtml = '<button onclick="showAuthModal(\\'login\\')" class="text-gray-300 hover:text-white transition font-medium px-4 py-2">' +
            'Sign In' +
            '</button>' +
            '<button onclick="showAuthModal(\\'register\\')" class="btn-cosmic text-white px-6 py-2.5 rounded-xl font-semibold">' +
            'Launch Now' +
            '</button>';
          navButtons.forEach(btn => {
            btn.innerHTML = loginHtml;
          });
        }
      }

      // Logout function
      function logout() {
        localStorage.removeItem('authToken');
        updateAuthUI();
        alert('Sesión cerrada exitosamente');
      }



      // Check for product parameter and redirect to directory, and handle OAuth callback
      document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Handle product parameter redirect FIRST
        const productId = urlParams.get('product');
        if (productId && /^d+$/.test(productId)) {
          window.location.href = '/marketplace?product=' + productId;
          return; // Don't process other parameters
        }
        
        // Handle OAuth callback token
        const token = urlParams.get('token');
        const role = urlParams.get('role');
        const newUser = urlParams.get('new_user');
        
        if (token) {
          // Store the token
          localStorage.setItem('authToken', token);
          
          // Clean URL by removing the token parameters
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
          
          // Show success message for new users
          if (newUser === 'true') {
            setTimeout(() => {
              alert('¡Bienvenido! Tu cuenta ha sido creada exitosamente.');
            }, 500);
          }
          
          // Update UI to show logged in state
          updateAuthUI();
          
          return; // Don't process other parameters if we just logged in
        }
        
        // Handle show_auth parameter to automatically show auth modal
        const showAuth = urlParams.get('show_auth');
        if (showAuth === 'login') {
          showAuthModal('login');
        } else if (showAuth === 'register') {
          showAuthModal('register');
        }
      });

      // Initialize auth UI
      updateAuthUI();

      // ========== QUICK PITCH FUNCTIONS ==========
      let quickPitchSubmitting = false;
      let createdProjectId = null;

      async function submitQuickPitchForm() {
        if (quickPitchSubmitting) return;

        const idea = document.getElementById('pitch-idea').value.trim();
        const problem = document.getElementById('pitch-problem').value.trim();
        const market = document.getElementById('pitch-market').value.trim();
        const pricingModel = document.getElementById('pitch-pricing-model').value;

        if (!idea || !problem || !market || !pricingModel) {
          alert('Please fill in all fields');
          return;
        }

        quickPitchSubmitting = true;

        // Show Step 2: AI Analysis
        updateStepIndicator(2);
        document.getElementById('quick-pitch-step-1').classList.add('hidden');
        document.getElementById('quick-pitch-step-2').classList.remove('hidden');

        try {
          // Get user info if logged in
          let userId = null;
          let userEmail = null;
          const token = localStorage.getItem('authToken');
          
          if (token) {
            try {
              const userResponse = await axios.get('/api/auth/me', {
                headers: { Authorization: 'Bearer ' + token }
              });
              console.log('User response:', userResponse.data);
              if (userResponse.data.user) {
                userId = userResponse.data.user.id;
                userEmail = userResponse.data.user.email;
                console.log('User authenticated:', { userId, userEmail });
              }
            } catch (authError) {
              console.log('Not authenticated:', authError);
            }
          } else {
            console.log('No auth token found');
          }

          console.log('Submitting pitch with userId:', userId);

          const response = await axios.post('/api/quick-pitch/submit', {
            idea: idea,
            problemSolving: problem,
            targetMarket: market,
            pricingModel: pricingModel,
            userId: userId,
            email: userEmail
          });

          if (response.data.success) {
            createdProjectId = response.data.projectId;
            displayQuickPitchResults(response.data.analysis);
            
            // Show Step 3: Results & Marketplace
            updateStepIndicator(3);
            document.getElementById('quick-pitch-step-2').classList.add('hidden');
            document.getElementById('quick-pitch-step-3').classList.remove('hidden');

            // Start countdown for auto-redirect
            startRedirectCountdown();
          } else {
            throw new Error(response.data.error || 'Failed to submit pitch');
          }
        } catch (error) {
          console.error('Error submitting pitch:', error);
          
          // Check if authentication is required
          if (error.response && error.response.status === 401 && error.response.data.requiresAuth) {
            alert('Please sign up or log in to validate your idea. You will be redirected to the registration page.');
            window.location.href = '/marketplace#signup';
            return;
          }
          
          alert('Error analyzing your idea. Please try again.');
          
          // Go back to step 1
          updateStepIndicator(1);
          document.getElementById('quick-pitch-step-2').classList.add('hidden');
          document.getElementById('quick-pitch-step-1').classList.remove('hidden');
        } finally {
          quickPitchSubmitting = false;
        }
      }

      // Upload Product - Redirect to Hub
      function showUploadProductForm() {
        window.location.href = '/marketplace';
      }

      // Update step indicator - Cosmic Theme
      function updateStepIndicator(activeStep) {
        for (let i = 1; i <= 4; i++) {
          const indicator = document.getElementById('step-indicator-' + i);
          if (!indicator) continue;

          if (i < activeStep) {
            indicator.className = 'w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-sm';
            indicator.innerHTML = '<i class="fas fa-check"></i>';
          } else if (i === activeStep) {
            indicator.className = 'w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm';
            indicator.textContent = i;
          } else {
            indicator.className = 'w-10 h-10 rounded-full bg-white/10 text-gray-400 flex items-center justify-center font-bold text-sm';
            indicator.textContent = i;
          }
        }
      }

      function displayQuickPitchResults(analysis) {
        const container = document.getElementById('analysis-results-container');
        if (!container || !analysis) return;

        const scoreColor = analysis.ai_score >= 80 ? 'text-green-600' : 
                           analysis.ai_score >= 60 ? 'text-blue-600' : 'text-orange-600';

        container.innerHTML = 
          '<div class="space-y-6">' +
            '<div class="text-center p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">' +
              '<div class="text-7xl font-black ' + scoreColor + ' mb-2">' + analysis.ai_score + '/100</div>' +
              '<p class="text-gray-600 font-bold text-lg">AI Viability Score</p>' +
            '</div>' +
            '<div>' +
              '<h3 class="text-2xl font-black text-gray-900 mb-2">' + escapeHtml(analysis.title) + '</h3>' +
              '<p class="text-gray-600 leading-relaxed">' + escapeHtml(analysis.description) + '</p>' +
            '</div>' +
            '<div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">' +
              '<p class="font-bold text-purple-900 mb-1">💎 Value Proposition</p>' +
              '<p class="text-purple-700">' + escapeHtml(analysis.value_proposition) + '</p>' +
            '</div>' +
            (analysis.strengths && analysis.strengths.length > 0 ? 
              '<div>' +
                '<p class="font-bold text-gray-900 mb-2 flex items-center">' +
                  '<i class="fas fa-check-circle text-green-500 mr-2"></i>Strengths' +
                '</p>' +
                '<ul class="space-y-2">' +
                  analysis.strengths.map(s => 
                    '<li class="flex items-start">' +
                      '<i class="fas fa-star text-yellow-500 mr-2 mt-1"></i>' +
                      '<span class="text-gray-700">' + escapeHtml(s) + '</span>' +
                    '</li>'
                  ).join('') +
                '</ul>' +
              '</div>' : '') +
            (analysis.opportunities && analysis.opportunities.length > 0 ? 
              '<div>' +
                '<p class="font-bold text-gray-900 mb-2 flex items-center">' +
                  '<i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Opportunities' +
                '</p>' +
                '<ul class="space-y-2">' +
                  analysis.opportunities.map(o => 
                    '<li class="flex items-start">' +
                      '<i class="fas fa-arrow-right text-blue-500 mr-2 mt-1"></i>' +
                      '<span class="text-gray-700">' + escapeHtml(o) + '</span>' +
                    '</li>'
                  ).join('') +
                '</ul>' +
              '</div>' : '') +
            '<div class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 rounded-full text-sm font-bold">' +
              '<i class="fas fa-tag mr-2"></i>' + (analysis.category || 'General') +
            '</div>' +
          '</div>';
      }

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function startRedirectCountdown() {
        let countdown = 5;
        const countdownEl = document.getElementById('redirect-countdown');
        
        const interval = setInterval(() => {
          countdown--;
          if (countdownEl) {
            countdownEl.textContent = countdown;
          }
          
          if (countdown <= 0) {
            clearInterval(interval);
            redirectToDashboard();
          }
        }, 1000);
      }



      function redirectToDashboard() {
        // Redirect to marketplace personal dashboard with goals
        window.location.href = '/marketplace#my-dashboard';
      }
    <\/script>
</body>
</html>
  `)));G.get("/project/:id",async e=>{const t=e.req.param("id");return e.html(`
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto - ValidAI Studio</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#6366f1',
              secondary: '#8b5cf6',
            }
          }
        }
      }
    <\/script>
    <style>
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .hero-pattern {
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }
      .gradient-border {
        border-image: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) 1;
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(99, 102, 241, 0.2);
      }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                        ⚡ ValidAI Studio
                    </a>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-4">
                    <a href="/" class="text-gray-700 hover:text-primary transition">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
                
                <!-- Mobile menu button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" onclick="toggleMobileMenu()" class="p-2 rounded-lg bg-gradient-to-r from-primary/10 to-secondary/10 hover:from-primary hover:to-secondary hover:text-white transition-all duration-200 text-primary font-bold">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Mobile Navigation Menu -->
            <div id="mobile-menu" class="hidden md:hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 bg-white border-t">
                    <a href="/" class="flex items-center px-3 py-2 text-gray-700 hover:text-primary transition">
                        <i class="fas fa-home mr-3 text-lg"></i>
                        <span class="font-medium">Inicio</span>
                    </a>
                    <a href="/marketplace" class="flex items-center px-3 py-2 text-gray-700 hover:text-primary transition">
                        <i class="fas fa-star mr-3 text-yellow-500 text-lg"></i>
                        <span>Marketplace</span>
                    </a>
                    <a href="/leaderboard" class="flex items-center px-3 py-2 text-gray-700 hover:text-primary transition">
                        <i class="fas fa-trophy mr-3 text-yellow-500 text-lg"></i>
                        <span>Leaderboard</span>
                    </a>
                    <a href="/pricing" class="flex items-center px-3 py-2 text-gray-700 hover:text-primary transition">
                        <i class="fas fa-tag mr-3 text-green-500 text-lg"></i>
                        <span>Planes</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div id="project-details">
            <!-- Loading state -->
            <div class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-primary mb-4"></i>
                <p class="text-gray-600">Cargando proyecto...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"><\/script>
    <script>
      const projectId = '${t}';
      
      function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        const button = document.getElementById('mobile-menu-button');
        const icon = button.querySelector('i');
        
        if (menu.classList.contains('hidden')) {
          menu.classList.remove('hidden');
          icon.classList.remove('fa-bars');
          icon.classList.add('fa-times');
        } else {
          menu.classList.add('hidden');
          icon.classList.remove('fa-times');
          icon.classList.add('fa-bars');
        }
      }
    <\/script>
    <script src="/static/mvp-generator.js"><\/script>
    <script src="/static/project-detail.js"><\/script>
</body>
</html>
  `)});G.get("/marketplace",async e=>{var r,a;const t=(a=(r=e.req.header("cookie"))==null?void 0:r.match(/authToken=([^;]+)/))==null?void 0:a[1];if(!t)return e.redirect("/api/auth/google");try{const s=await te(t,e.env.JWT_SECRET),o=s.userName||s.email||"Usuario",n=s.avatar_url,i=s.role||"founder",l=nd(o,n,i);return e.html(l)}catch{return e.redirect("/api/auth/google")}});G.get("/leaderboard",async e=>{var t,r;try{const a=(r=(t=e.req.header("cookie"))==null?void 0:t.split("; ").find(l=>l.startsWith("auth=")))==null?void 0:r.split("=")[1];let s="Guest",o,n="guest";if(a)try{const l=await te(a,e.env.JWT_SECRET);if(l&&l.email){const c=await e.env.DB.prepare("SELECT name, avatar, role FROM users WHERE email = ?").bind(l.email).first();c&&(s=c.name||l.email,o=c.avatar,n=c.role||"guest")}}catch(l){console.error("Error verifying token:",l)}const i=Du({userName:s,userAvatar:o,userRole:n});return e.html(i)}catch(a){return console.error("Error loading leaderboard:",a),e.html('<div class="flex items-center justify-center min-h-screen"><div class="text-center"><h1 class="text-2xl font-bold text-gray-800 mb-4">Error loading leaderboard</h1><p class="text-gray-600">Please try again later.</p></div></div>')}});const bl=new ee,mv=Object.assign({"/src/index.tsx":G});let $d=!1;for(const[,e]of Object.entries(mv))e&&(bl.all("*",t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),bl.notFound(t=>{let r;try{r=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,r)}),$d=!0);if(!$d)throw new Error("Can't import modules from ['/src/index.ts','/src/index.tsx','/app/server.ts']");function gv(e){return br({content:`
    <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-6">
      <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-3xl font-bold text-gray-900">Team Management</h1>
              <p class="text-gray-600 mt-1">Manage co-founders and share your goals dashboard</p>
            </div>
            <a href="/dashboard" class="text-primary hover:text-secondary font-semibold flex items-center">
              <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
            </a>
          </div>
        </div>

        <!-- Pending Invitations -->
        <div id="pending-invitations-container"></div>

        <!-- Team Info Card -->
        <div id="team-info" class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900">Your Startup Team</h2>
            <button onclick="window.editTeamName()" class="text-primary hover:text-secondary text-sm font-semibold">
              <i class="fas fa-edit mr-1"></i> Edit Name
            </button>
          </div>
          <div id="team-name-display" class="text-2xl font-bold text-primary mb-2">Loading...</div>
          <div id="team-member-count" class="text-sm text-gray-600">Loading members...</div>
        </div>

        <!-- Add Founder Section -->
        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl shadow-lg p-6 mb-6 text-white">
          <h2 class="text-xl font-bold mb-4">
            <i class="fas fa-user-plus mr-2"></i> Add Co-founder
          </h2>
          <p class="text-white/90 mb-4 text-sm">
            Invite team members by email to share the goals dashboard. They'll be able to see and track all team goals.
          </p>
          <div class="flex gap-3">
            <input 
              type="email" 
              id="founder-email" 
              placeholder="founder@example.com" 
              class="flex-1 px-4 py-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-white"
            />
            <input 
              type="text" 
              id="founder-role" 
              placeholder="Role (e.g., CTO)" 
              class="w-40 px-4 py-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-white"
            />
            <button 
              onclick="window.addFounder()" 
              class="bg-white text-purple-600 px-6 py-3 rounded-lg font-bold hover:bg-gray-100 transition flex items-center whitespace-nowrap"
            >
              <i class="fas fa-plus mr-2"></i> Add
            </button>
          </div>
          <div id="add-founder-message" class="mt-3 text-sm"></div>
        </div>

        <!-- Team Members List -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-4">
            <i class="fas fa-users mr-2"></i> Team Members
          </h2>
          <div id="team-members-list" class="space-y-3">
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
              <p>Loading team members...</p>
            </div>
          </div>
        </div>

        <!-- Shared Goals Info -->
        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6 mt-6">
          <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 text-xl mr-3 mt-1"></i>
            <div>
              <h3 class="font-bold text-blue-900 mb-1">About Shared Goals</h3>
              <p class="text-blue-800 text-sm">
                All team members can view the same goals dashboard. Each goal shows who created it, 
                making it easy to track progress across the entire startup team. Goals remain editable 
                only by their creator.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentTeam = null;

      async function loadTeamData() {
        try {
          const response = await axios.get('/api/team/my-team');
          if (response.data.success) {
            currentTeam = response.data.team;
            displayTeamInfo();
            displayTeamMembers();
          }
        } catch (error) {
          console.error('Error loading team:', error);
          document.getElementById('team-info').innerHTML = 
            '<div class="text-red-500">Error loading team data. Please refresh the page.</div>';
        }
        
        // Load pending invitations
        await loadPendingInvitations();
      }

      async function loadPendingInvitations() {
        try {
          const response = await axios.get('/api/team/my-invitations');
          if (response.data.success && response.data.invitations.length > 0) {
            displayPendingInvitations(response.data.invitations);
          }
        } catch (error) {
          console.error('Error loading invitations:', error);
        }
      }

      function displayPendingInvitations(invitations) {
        const container = document.getElementById('pending-invitations-container');
        container.innerHTML = invitations.map(inv => \`
          <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-xl shadow-lg p-6 mb-6 text-white">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center mb-2">
                  <i class="fas fa-envelope text-2xl mr-3"></i>
                  <h3 class="text-xl font-bold">Team Invitation</h3>
                </div>
                <p class="text-white/90 mb-2">
                  <strong>\${inv.invited_by_name || inv.invited_by_email}</strong> invited you to join 
                  <strong>"\${inv.team_name}"</strong> as <strong>\${inv.role}</strong>
                </p>
                \${inv.invitation_type === 'transfer' ? \`
                  <div class="bg-white/20 rounded-lg p-3 mb-3">
                    <p class="text-sm flex items-start">
                      <i class="fas fa-exclamation-triangle mr-2 mt-0.5"></i>
                      <span>You will be moved from your current team "<strong>\${inv.current_team_name}</strong>" to this new team. All your goals will be transferred.</span>
                    </p>
                  </div>
                \` : ''}
                <p class="text-xs text-white/70">
                  Invited on \${new Date(inv.invited_at).toLocaleDateString()}
                </p>
              </div>
            </div>
            <div class="flex gap-3 mt-4">
              <button 
                onclick="window.respondToInvitation(\${inv.id}, 'accept')" 
                class="flex-1 bg-white text-green-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-100 transition"
              >
                <i class="fas fa-check mr-2"></i> Accept
              </button>
              <button 
                onclick="window.respondToInvitation(\${inv.id}, 'reject')" 
                class="flex-1 bg-white/20 text-white px-4 py-2 rounded-lg font-bold hover:bg-white/30 transition"
              >
                <i class="fas fa-times mr-2"></i> Decline
              </button>
            </div>
          </div>
        \`).join('');
      }

      window.respondToInvitation = async function(invitationId, action) {
        try {
          const response = await axios.post(\`/api/team/invitations/\${invitationId}/\${action}\`);
          if (response.data.success) {
            alert(response.data.message);
            location.reload(); // Refresh to show updated team
          } else {
            alert('Error: ' + response.data.error);
          }
        } catch (error) {
          console.error('Error responding to invitation:', error);
          alert('Failed to process invitation');
        }
      }

      function displayTeamInfo() {
        document.getElementById('team-name-display').textContent = currentTeam.name;
        document.getElementById('team-member-count').textContent = 
          \`\${currentTeam.member_count} \${currentTeam.member_count === 1 ? 'member' : 'members'}\`;
      }

      function displayTeamMembers() {
        const container = document.getElementById('team-members-list');
        if (!currentTeam.members || currentTeam.members.length === 0) {
          container.innerHTML = '<div class="text-gray-500 text-center py-4">No team members yet</div>';
          return;
        }

        container.innerHTML = currentTeam.members.map(member => \`
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg">
                \${member.avatar_url ? 
                  \`<img src="\${member.avatar_url}" class="w-12 h-12 rounded-full" />\` :
                  member.name?.charAt(0).toUpperCase() || '?'
                }
              </div>
              <div>
                <div class="font-semibold text-gray-900">
                  \${member.name || 'Unknown'}
                  \${member.is_creator ? '<span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full font-bold">Creator</span>' : ''}
                </div>
                <div class="text-sm text-gray-600">\${member.email || 'No email'}</div>
                <div class="text-xs text-gray-500 mt-1">\${member.role || 'Team Member'}</div>
              </div>
            </div>
            <div>
              \${!member.is_creator ? \`
                <button 
                  onclick="window.removeFounder(\${member.id}, '\${member.name}')" 
                  class="text-red-500 hover:text-red-700 font-semibold text-sm"
                >
                  <i class="fas fa-trash-alt mr-1"></i> Remove
                </button>
              \` : \`
                <span class="text-gray-400 text-sm">
                  <i class="fas fa-crown mr-1"></i> Owner
                </span>
              \`}
            </div>
          </div>
        \`).join('');
      }

      window.addFounder = async function() {
        const email = document.getElementById('founder-email').value.trim();
        const role = document.getElementById('founder-role').value.trim();
        const messageEl = document.getElementById('add-founder-message');

        if (!email) {
          messageEl.innerHTML = '<span class="text-yellow-200"><i class="fas fa-exclamation-triangle mr-1"></i> Please enter an email</span>';
          return;
        }

        try {
          messageEl.innerHTML = '<span class="text-white"><i class="fas fa-spinner fa-spin mr-1"></i> Adding founder...</span>';
          
          const response = await axios.post('/api/team/add-founder', { email, role: role || 'Co-founder' });
          
          if (response.data.success) {
            messageEl.innerHTML = '<span class="text-green-200"><i class="fas fa-check-circle mr-1"></i> Founder added successfully!</span>';
            document.getElementById('founder-email').value = '';
            document.getElementById('founder-role').value = '';
            
            setTimeout(() => {
              messageEl.innerHTML = '';
              loadTeamData(); // Reload team data
            }, 2000);
          }
        } catch (error) {
          const errorMsg = error.response?.data?.error || 'Failed to add founder';
          messageEl.innerHTML = \`<span class="text-red-200"><i class="fas fa-times-circle mr-1"></i> \${errorMsg}</span>\`;
        }
      }

      window.removeFounder = async function(memberId, memberName) {
        if (!confirm(\`Are you sure you want to remove \${memberName} from the team?\`)) {
          return;
        }

        try {
          const response = await axios.delete(\`/api/team/remove-founder/\${memberId}\`);
          
          if (response.data.success) {
            loadTeamData(); // Reload team data
          }
        } catch (error) {
          alert('Error removing founder: ' + (error.response?.data?.error || 'Unknown error'));
        }
      }

      window.editTeamName = async function() {
        const newName = prompt('Enter new team name:', currentTeam.name);
        if (!newName || newName.trim() === '' || newName === currentTeam.name) {
          return;
        }

        try {
          const response = await axios.put('/api/team/update-name', { name: newName.trim() });
          
          if (response.data.success) {
            currentTeam.name = newName.trim();
            displayTeamInfo();
          }
        } catch (error) {
          alert('Error updating team name: ' + (error.response?.data?.error || 'Unknown error'));
        }
      }

      // Load team data on page load
      loadTeamData();
    <\/script>
  `,currentPage:"team",userName:e.name||e.email||"User",userAvatar:e.avatar_url,pageTitle:"Team Management",userRole:e.role||"founder"})}const hv=Object.freeze(Object.defineProperty({__proto__:null,renderTeamManagementPage:gv},Symbol.toStringTag,{value:"Module"}));export{bl as default};
